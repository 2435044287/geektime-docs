你好，我是邵亚方。今天这节课，我想跟你聊一聊怎么处理在生产环境中，因为Page Cache管理不当引起的系统load飙高的问题。

相信你在平时的工作中，应该会或多或少遇到过这些情形：系统很卡顿，敲命令响应非常慢；应用程序的RT变得很高，或者抖动得很厉害。在发生这些问题时，很有可能也伴随着系统load飙得很高。

那这是什么原因导致的呢？据我观察，大多是有三种情况：

- 直接内存回收引起的load飙高；
- 系统中脏页积压过多引起的load飙高；
- 系统NUMA策略配置不当引起的load飙高。

这是应用开发者和运维人员向我咨询最多的几种情况。问题看似很简单，但如果对问题产生的原因理解得不深，解决起来就会很棘手，甚至配置得不好，还会带来负面的影响。

所以这节课，我们一起来分析下这三种情况，可以说，搞清楚了这几种情况，你差不多就能解决掉绝大部分Page Cache引起的load飙高问题了。如果你对问题的原因排查感兴趣，也不要着急，在第5讲，我会带你学习load飙高问题的分析方法。

接下来，我们就来逐一分析下这几类情况。

## 直接内存回收引起load飙高或者业务时延抖动

直接内存回收是指在进程上下文同步进行内存回收，那么它具体是怎么引起load飙高的呢？
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/43/79/18073134.jpg" width="30px"><span>test</span> 👍（28） 💬（1）<div>系统load飙高：
1.直接内存回收：
观察：sar -B中pgscank&#47;s、pgscand&#47;s表示扫描的页面数量，前者表示kswapd扫描结果，后者表示直接扫描。需要让直接扫描越小越好。
解决：设置vm.min_free_kbytes，尽早开始后台回收。
2.脏页积压：
观察：sar -r中kbdirty即是脏页大小。
解决：设置vm&#47;dirtyxxx控制脏页个数在合理范围内。
3.NUMA设置不合理：
观察：numactl --hardware查看是否还有一半内存空闲，但是还是频频发生direct reclaim。
解决：vm.zone_reclaim_mode = 0</div>2020-08-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/87/75/03aa0ab6.jpg" width="30px"><span>lookzy</span> 👍（15） 💬（2）<div>老师您好！我们都说剩余内存达到low水位时，就会进行内存回收。但每个zone都有水位，剩余内存是指某个zone里的剩余内存，还是node，还是整个系统的剩余内存？还有内存回收只针对当前zone，还是node，还是整个系统？谢谢！</div>2020-08-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/83/14/099742ae.jpg" width="30px"><span>xzy</span> 👍（11） 💬（1）<div>你好请教个问题：我们线上出现 kswapd0 占用 cpu 较高，free -h 看了available 的内存不到 1g，应该是可用内存太少触发了 kswapd0 回收内存。我们关闭了 swap，vmstat  -s 没发现 page 换入换出，但是用 
 iotop 却发现大量进程 io 很高（这些业务进程并没有 io 的逻辑），请问这种情况如何定位，是否是 kswapd0 导致的</div>2020-08-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg" width="30px"><span>piboye</span> 👍（9） 💬（4）<div>老师有个dirty page的问题想请教一下。 1创建文件；2写入日志数据，3 移除文件；4 关闭文件。我想知道这种情况情况下dirty page还会去刷盘不？</div>2020-09-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/64/9b/d1ab239e.jpg" width="30px"><span>J.Smile</span> 👍（9） 💬（2）<div>老师可以再解释下为什么调大min_free_kbytes会减少回收频率而降低延迟吗?而调小该值就会减少内存浪费呢？我的理解是增加min_free_kbytes之后，free剩余内存更大的时候就触发了回收，这不是增加回收频率了吗？</div>2020-08-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ed/a2/905e32fc.jpg" width="30px"><span>咸鱼</span> 👍（4） 💬（1）<div>老师,请教下改变内存水位为什么会影响内存可使用量</div>2020-08-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a6/3f/5cd75d31.jpg" width="30px"><span>蛋卷儿</span> 👍（3） 💬（1）<div>请教老师,kswapd和direct reclaim如果都是把内存回收到zone里high的水位,那么如果某一次内存申请数量大于zone的high值,是否就会导致os kill？我们线上机器的zone normal high是46M,那某次申请内存超过46Mb是不是就挂了？</div>2020-11-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/20/bd/2a/e86058d3.jpg" width="30px"><span>Cooper</span> 👍（3） 💬（1）<div>您好，请教一下，我以前单位部署多个小场景服务器， node写的，每个服务有最大服务（内存）上限，当时服务部署是将进程绑定指定cpu，1个内核2进程，请问这个设计是否是为了muna 策略，把zone_reclaim_mode设置1，如果是，这样对性能提升有帮助吗？</div>2020-10-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/a5/5b/e1ffd5e4.jpg" width="30px"><span>纸君</span> 👍（2） 💬（1）<div>请问一下 发生 直接内存回收时，是占用内核态还是用户态的cpu?</div>2021-08-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/18/ac/4d68ba46.jpg" width="30px"><span>金时</span> 👍（2） 💬（1）<div>老师您好，文中说的第一种情况“直接内存回收引起 load 飙高或者业务时延抖动“， 和第二种情况“系统中脏页过多引起 load 飙高“， 不太理解这两种情况的区别。  第一种情况回收的“内存“，这里的“内存”不是指第二种情况的“脏页”吗</div>2021-06-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0c/bf/863d440a.jpg" width="30px"><span>jaxzhai</span> 👍（2） 💬（1）<div>kernel: INFO: task kswapd0:224 blocked for more than 120 seconds.  这段时间大数据系统，进程出现这种情况，之后kswapd0进程变成僵尸进程了</div>2021-02-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/9a/83/0802f4e7.jpg" width="30px"><span>Geek_lucky_brian</span> 👍（2） 💬（1）<div>老师好，老师文中的几个问题和MySQL数据库的性能和稳定性都有很大联系，让我收益颇多。
（1）之前定位到当内存不足时，产生pgscand，数据库的io会产生问题，包括服务质量会下降，且会导致与客户端断链。之前是通过按照固定间隔去drop_cache解决，现在已经引入了vm.min_free_bytes的方式。
（2）关于numa，我们发现在x86上并不是很敏感，但是在arm平台上，一旦CPU为高核（150以上），就发现MySQL数据库性能压测上不去，这时候通过numa绑核就可以解决掉性能问题。这种场景，老师是否建议开启zone_reclaim_mode？</div>2020-09-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/5a/56/115c6433.jpg" width="30px"><span>jssfy</span> 👍（1） 💬（1）<div>请问在虚机或者容器场景，vm.min_free_kbytes这一部分的空间建议预留还是也作为可分配空间呢?</div>2020-08-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/c4/35/2cc10d43.jpg" width="30px"><span>Wade_阿伟</span> 👍（0） 💬（1）<div>系统中还有一半左右的 free 内存，但还是频频触发 direct reclaim，导致业务抖动得比较厉害。后来经过排查发现是由于设置了 zone_reclaim_mode，这是 NUMA 策略的一种。请问老师能分享下这个问题的排查思路吗 ？</div>2021-07-11</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJpJXWFP3dNle88WnTkRTsEQkPJmOhepibiaTfhEtMRrbdg5EAWm4EzurA61oKxvCK2ZjMmy1QvmChw/132" width="30px"><span>唐江</span> 👍（0） 💬（1）<div>文件被程序读取到内存，pagecache缓存的是部分吧，如果这时候把文件删除了，程序还可以读到部分缓存的数据吧？</div>2021-05-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/5b/0a/e02b6a0f.jpg" width="30px"><span>褚超</span> 👍（0） 💬（2）<div>您好，最近正好碰到一个相关问题，线上环境的jvm 进程被频繁 stall, 1s ~ 13s, 看上去是和pgscand&#47;s 直接相关，出现stall时pgscand&#47;s 直接从0跳到400k - 500k, 在一个64GB RAM 的机器上只跑了两个heap size 24GB 的 java进程，发生问题是phyical RAM 还是很充足的，但又不是NUMA，系统只有一个node... 

现在有点怀疑 THP，thp_fault_fallback 74780 &amp; thp_collapse_alloc_failed 11808 比较高，但是这方面经验欠缺，请问有什么方法进行确认或者排除？多谢！</div>2020-09-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7a/8b/2c81a375.jpg" width="30px"><span>好说</span> 👍（0） 💬（1）<div>本文主要都是从写的角度来讲的，老师是否可以出一篇从读的角度讲的</div>2020-08-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/f5/95/a362f01b.jpg" width="30px"><span>Geek1560</span> 👍（0） 💬（1）<div>老师，课程里可以拓展一下内存申请实现吗，比如内存不足，导致回收和swap等逻辑。或者有交流群吗？</div>2020-08-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/b8/f7/55e1560b.jpg" width="30px"><span>yuwenvss</span> 👍（0） 💬（1）<div>docker容器里面的内存回收也会参考 vm.min_free_kbytes 等几个参数么？ </div>2020-08-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ce/5d/5297717a.jpg" width="30px"><span>初见</span> 👍（0） 💬（0）<div>线上碰到了【直接内存回收引起load飙高】问题，机器总内存16G，min_free_kbytes 调整为 2G 之后，确实好了很多，但是并没有完全杜绝，还是隔几天偶发一下，老师还有别的办法嘛？</div>2024-12-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/b4/fd/791d0f5e.jpg" width="30px"><span>sN0wpeak</span> 👍（0） 💬（0）<div>pagecache卡顿，涉及到内存碎片和连续内存申请. 这个怎么观测</div>2024-09-02</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIDj4jSAykTpH1kNtoFgsygeyr01A7mxhxQqzdiapXNgUyBykCz6zJBtLAO7wLAtf4y4pHxWvvoTmg/132" width="30px"><span>focus</span> 👍（0） 💬（0）<div>作者你好,我有2个问题请教.
1.“系统中的可配置项”具体在哪?是一个特殊的文件吗?我目前所知道的是&#47;etc&#47;sysctl.conf
2.如果异常发生的场景在linux host的k8s pod中,该如何分析呢?因为我们都知道k8s的容器进程工作在用户空间,但是它们都共用一个host的内核空间.</div>2024-07-19</li><br/><li><img src="" width="30px"><span>Geek_d9d5dd</span> 👍（0） 💬（0）<div>请问邵大大，在cgroup管理上，对于cgroup的cache管理有什么不同点？或者说cgroup是怎么处理cache的呢？
当前docker或k8s服务应用越来越广，会否出一本k8s应用下，linux内核和内存管理应该如何调优或注意点？</div>2024-05-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5c/0a/1bd98d4b.jpg" width="30px"><span>vearne</span> 👍（0） 💬（0）<div>stress --vm 10  --vm-hang 30 --vm-bytes 1024000000</div>2023-03-22</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/tKvmZ3Vs4t6RZ3X7cAliaW4OobyW6v7GwmIyg77VVKYGAY7iaf0VibF5TkibTSPY03PX9qyYUjOoXXxdTdVSNmW9Yw/132" width="30px"><span>Geek_Q</span> 👍（0） 💬（0）<div>老师好，请教一下，最近生产服务器遇到page cache吃满内存后rtt大的问题。应用程序是多线程，线程A写所有收到的数据到ssd磁盘,线程B网络收发，线程C是业务，所有内存都是启动就开好，运行时百毫秒用json库申请少量堆内存用于心跳，应用程序约占内存200GB。page cache把内存占满后，有时线程A卡死三秒pgscand 10000多，看sar当时有500MB pageout；有时线程B卡死一秒，pgsand为0，线程C也卡但不影响RTT。服务器32核，1TB内存，四个node，不绑核。目前知道跟内存满有关，但为什么这么好性能机器，线程卡住3秒不动，还是解释不了，请求帮忙分析下。</div>2022-04-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/3e/3c/fc3ad983.jpg" width="30px"><span>佳伦</span> 👍（0） 💬（0）<div>脏页积压和水位线不是一回事吗？不是因为水位线太高导致了积压吗？</div>2022-01-20</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKSGEOl6BlJOLpBSrct7ibvic616p7SXbwCDl9IzftYdMsibKPYUZpkKJbP0Lu7JcFEb2ajEqu7M2TMw/132" width="30px"><span>amos</span> 👍（0） 💬（0）<div>老师你好，文中说直接内存回收过程中遇到了正在往慢速 I&#47;O 设备回写的 page，就可能导致非常大的延迟，这句话不太理解，这个应该是异步写的，为什么还会有较大延迟？</div>2021-09-27</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKSGEOl6BlJOLpBSrct7ibvic616p7SXbwCDl9IzftYdMsibKPYUZpkKJbP0Lu7JcFEb2ajEqu7M2TMw/132" width="30px"><span>amos</span> 👍（0） 💬（0）<div>老师好，慢速 I&#47;O 设备回写的 page,可能会有很大延迟 这个怎么排查，我看05里面没有呢？</div>2021-09-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a4/f0/3d92f51b.jpg" width="30px"><span>Racyan</span> 👍（0） 💬（0）<div>老师请问，我线上有个数据库服务器，平时可用内存在20G左右，但是最近非常不稳定，经常突发的load飙升，后来发现是page cache的问题。我写了脚本，定时释放page cache，之后稳定了半年，最近又发现相同的问题，手动释放page cache也不管用，释放之后立刻就内存占满触发换页，请问能帮我指导下，我有什么方式能够定位到底是那个进程突发占用的内存吗？</div>2021-01-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/9c/aa/6f780187.jpg" width="30px"><span>言希</span> 👍（0） 💬（1）<div>老师，咨询个问题。
现象：在压测Kafka写文件性能的时候，在挂载盘数相同的情况下，随机写越多，磁盘使用率越小。
应用程序通过内存映射的方式来写文件，无法将挂载的多块HDD盘使用率压上去，平均的utils只能到60%左右。会是什么因素导致的呢 ？ 

</div>2021-01-09</li><br/>
</ul>