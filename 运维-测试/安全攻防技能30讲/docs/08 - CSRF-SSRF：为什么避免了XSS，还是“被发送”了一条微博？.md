你好，我是何为舟。

前面我们讲了2种常见的Web攻击：XSS和SQL注入。它们分别篡改了原始的HTML和SQL逻辑，从而使得黑客能够执行自定义的功能。那么除了对代码逻辑进行篡改，黑客还能通过什么方式发起Web攻击呢？

我们还是先来看一个例子。在平常使用浏览器访问各种网页的时候，是否遇到过，自己的银行应用突然发起了一笔转账，又或者，你的微博突然发送了一条内容？

在我们学习XSS之后，你可能会联想到，这是银行或者微博中出现了某个XSS漏洞。但问题是，你今天并没有访问过银行或者微博的页面，所以并没有“被XSS”的机会。这时，你想到，会不会是你今天访问的其他网页里存在一些恶意的攻击，实现了你不知道的转账和发博行为呢？好了，你肯定很想知道黑客究竟是怎么做到的，那你不妨先自己思考一下，写出几个可能的答案，然后跟着我开始学习今天的内容！

## CSRF攻击是如何产生的？

我们几乎每天都要用到浏览器，我们的信息也会被浏览器“保存”。那我们首先来看一下，浏览器是如何保存你的身份信息的。

当我们在访问一个Web页面的时候，并不是我们自己去获取页面信息，而是浏览器去获取了这些信息，并将它们进行了展示。这就说明，你允许浏览器代表你去和Web的服务端进行交互。为了能够准确地代表你的身份，浏览器通常会在Cookie中存储一些必要的身份信息。所以，在我们使用一个网页的时候，只需要在首次访问的时候登录就可以了。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/16/bc/25/1c92a90c.jpg" width="30px"><span>tt</span> 👍（12） 💬（5）<div>首先向老师请教一个问题: 从hacker.com向bank.com发起HTTP请求不会遇到同源策略的限制么？

其次谈谈自己对CSRF的理解。

CSRF攻击的两个基本条件:使用cookie进行身份认证，接口调用参数不包含任何隐私信息。我的理解是一旦身份（即cookie）被窃取，因为接口参数不包含任何隐私信息和一次性信息（如nounce），本质上黑客执行的是一次重放攻击。

一次性或随机性信息包括CSRF Token，也包括不在浏览器控制范围之内的信息，如独立的支付密码。

回到用户认证的三个层次，除了Cookie这个能证明你是谁的东西之外，还要问用户你拥有什么？（比如支付密码或电子口令牌的口令）

此外，一次性或随机信息是针对攻击者而言的。只要攻击者无法猜测到的信息，都应该被使用，就像SSRF防护中，内网的接口服务也需要对请求进行验证。

通过这一课，对于接口设计的认知更全面了。</div>2019-12-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ef/a2/6ea5bb9e.jpg" width="30px"><span>LEON</span> 👍（9） 💬（5）<div>请教老师一个问题，通过CSRF token 来进行防护的话，有没有可能黑客通过自己转账确认CSRF token的位置或者标识，然后进行CSRF模拟表单进行提交的时候，通过JS脚本把CSRF token取出来，加在黑客模拟的表单中发送给server。从而造成CSRF token 防护失效？
谢谢老师 </div>2019-12-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f6/0d/e16dff4e.jpg" width="30px"><span>瑞泉</span> 👍（7） 💬（1）<div>老师，csrf xss sql注入这些Web安全有没有比较好的测试工具推荐？后续课程中会有工具介绍吗？</div>2019-12-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/eb/19/0d990b03.jpg" width="30px"><span>ZeroIce</span> 👍（6） 💬（3）<div>老师我有个问题不太懂：现在很多接口安全机制，不可能仅仅是直接访问一个接口而不带header验证（例如：cookie）就可以成功。不需要验证，还不如直接通过postman直接请求呢。这样子的话黑客怎样实施csrf？用户身份（cookie或token）黑客怎样添加到表单里面？</div>2019-12-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/24/17/073c5c14.jpg" width="30px"><span>叮当 </span> 👍（5） 💬（1）<div>老师，对于CSRF和XSS攻击的区别，我还是不太清楚，两者都是窃取信息来仿冒用户操作，看评论说一个发生在当前域名，一个是其他域名，对这一点能否讲的详细一点，比如为什么XSS只能发生在当前域名呢。除了这个不同，还有其他不同点吗？谢谢老师！</div>2020-07-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/29/42/43d4b1a8.jpg" width="30px"><span>烫烫烫</span> 👍（4） 💬（1）<div>老师，关于XSS和CSRF，我是这么理解的：
1、如果黑客发现用户把验证信息放在session里，且没有其它校验的话，就可以发起CSRF攻击，即，构造一个恶意URL，诱导用户点击，然后跳转到目标网页发起请求；
2、更进一步，如果黑客发现XSS漏洞，可在目标网页上构造恶意参数，诱导用户点击，从而修改HTML页面，相当于一定程度上控制了用户的网页。此时，黑客不仅可以拿到session，还可以拿到localStorage等数据，任意发起请求；

以上，不知是否正确，望老师答复，谢谢</div>2020-12-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/51/50/f5f2a121.jpg" width="30px"><span>律飛</span> 👍（3） 💬（1）<div>对于CSRF攻击，主要是使用CSRF-token进行防护的，这个很多web框架都提供了现成的模块可供使用；对于支付、修改用户密码等关键操作采用手机验证码等二次验证。
对于SSRF主要是用白名单和接口认证的方式，还可以采用协议限制。
请教老师，作为运维人员，除了用工具扫描漏洞外，在日常运维监控方面可以做些什么来发现是否有入侵事件呢？</div>2020-01-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/9a/12/06863960.jpg" width="30px"><span>稳</span> 👍（3） 💬（1）<div>想请假老师个问题，前后端分离项目中，怎样做csrf？如果通过接口返回，是不是黑客也可以额外做一次接口请求呢？</div>2019-12-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/eb/19/0d990b03.jpg" width="30px"><span>ZeroIce</span> 👍（3） 💬（2）<div>上一条留言：
老师我有个问题不太懂：现在很多接口安全机制，不可能仅仅是直接访问一个接口而不带header验证（例如：cookie）就可以成功。不需要验证，还不如直接通过postman直接请求呢。这样子的话黑客怎样实施csrf？用户身份（cookie或token）黑客怎样添加到表单里面

另外一个问题：假如我的是Authorization。 header头部验证？而不是cookie（浏览器每个请求都带上cookie）</div>2019-12-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/87/62/f99b5b05.jpg" width="30px"><span>曙光</span> 👍（2） 💬（1）<div>问题：1 CSRF Token，服务器发送和客户端发送的CSRF Token是一样的么？如果一样，黑客如果截获了CSRF Token,再发给服务器岂不是转账成功了？二次密码输入也是同理，只要知道二次密码是什么，这个方案也形同虚设了。
问题2：SSRF的服务端验证，是不是通过对称密钥或非对称密钥实现？即请求其他服务接口时，需要拼接一个唯一标识的内部密码字段，类似CSRF Token。</div>2020-03-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/47/31/f35367c8.jpg" width="30px"><span>小晏子</span> 👍（2） 💬（1）<div>目前还没遇到过CSRF和SSRF的攻击，首先对于CSRF攻击，主要是使用CSRF-token进行防护的，这个很多web框架都提供了现成的模块可供使用。对于SSRF主要是用了白名单和接口认证的方式，文中提到的一个方案：全部使用POST，也考虑过，可是很多人认为这种方式可奇怪，不好理解，所以就没用。
这里也请教下老师，接口全部使用POST请求的这种方式在业界是否用的普遍？</div>2019-12-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5b/8f/4b0ab5db.jpg" width="30px"><span>Middleware</span> 👍（2） 💬（1）<div>尽量使用 POST 请求方式，似乎不太好吧？有违 RESTFul</div>2019-12-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/34/df/64e3d533.jpg" width="30px"><span>leslie</span> 👍（1） 💬（1）<div>CSRF的防御方式算是提前学习到了：正准备做相关的事情，之前不理解为何现在许多现金支付为何越来越多的使用手机验证；其实目的就是避免该环节用户的密码和支付密码被保存从而被利用。</div>2019-12-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0b/9f/788b964e.jpg" width="30px"><span>仰望星空</span> 👍（1） 💬（4）<div>如果csrf toke也存储在cookie里是不是就不安全了，但奇怪的是spring security 框架就是把card token存储在cookie里返回给浏览器的，似乎也没人说不安全。</div>2019-12-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ef/a2/6ea5bb9e.jpg" width="30px"><span>LEON</span> 👍（1） 💬（2）<div>感觉XSS攻击和CSRF攻击很像，这两种攻击比较起来具体有什么关系和区别吗？</div>2019-12-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/2f/f4/2dede51a.jpg" width="30px"><span>小老鼠</span> 👍（0） 💬（3）<div>csrf经常遇到，ssrf第一次听到。我用过django的csrfmiddware控件，利用的就是csrftoken，由于我作自动化测试的，在作接口测试的时候，发现只要把csrftoken的值与form中的csrfmiddlertoken的hidden类型值保持一致就可以通过了。我发现cdrftoken是不安全的。</div>2019-12-31</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/7WkTI1IicbKvsPJng5vQh5qlrf1smbfl2zb7icHZfzcAk1k4lr8w8IDEAdrqq1NHW5XZMPXiaa1h7Jn1LGOWOCkIA/132" width="30px"><span>早起不吃虫</span> 👍（0） 💬（1）<div>老师总结的很好，不过由于篇幅所限，讲的稍显不够详细，所以看到评论区有很多相关的疑问，建议增加篇幅，哈哈😄</div>2019-12-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/47/fd/895f0c27.jpg" width="30px"><span>Cy23</span> 👍（0） 💬（1）<div>CSRF了解了，SSRF攻击原理理解了，SSRF发起攻击的细节还有很多不了解的，需要扩展学习下</div>2019-12-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/23/6c/785d9cd3.jpg" width="30px"><span>Snooker</span> 👍（0） 💬（0）<div>CSRF像是在你前进道路上提前布上陷阱，它不能左右你的方向，但是对你踏入陷阱后的结果有预期，攻击方式比较被动；
对比CSRF，XSS攻击，攻击成功后是可以拿到认证信息，是可以控制你的行为，号被盗了
SSRF的前提是黑客已经攻击拿下了一台内部服务器，才有老师讲到的后续的攻击手段；</div>2024-06-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/39/d0/82/791d0f5e.jpg" width="30px"><span>大将</span> 👍（0） 💬（0）<div>1、数字签名+token是否能够更好的防护CSRF这类的场景
2、服务端如果应用是在受限的用户下运行的，是否能够减少SSRF带来的影响。
3、黑客是如何快速的找到能够运用攻击的参数的。</div>2023-11-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/29/44/2f/67d8a9ee.jpg" width="30px"><span>阿白</span> 👍（0） 💬（0）<div>对于csrf浏览器为什么不直接应用同源策略阻止跨域发送post请求呢？感觉跨域post的应用场景在我的经验里还没出现，老师可以分享一下这个的应用场景吗？</div>2021-08-09</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLia4qBUs5bFs5tU3yVCcBapIcnVftM60nrJ73eu30YDMbDNvjhvnibct3pMYlj62G1c7nH8jSBaiaLw/132" width="30px"><span>李文彬</span> 👍（0） 💬（0）<div>如果是服务（都是内网IP）之间的接口调用，一般会做什么校验？因为接口之间调用很多，目前没有做校验，感觉不是很安全～</div>2021-02-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/cb/d1/6aceeb79.jpg" width="30px"><span>吕志勇</span> 👍（0） 💬（0）<div>好熟悉的名词，但是今天才知道是怎么回事，谢谢</div>2020-05-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/09/87/60d3f68c.jpg" width="30px"><span>Hello World</span> 👍（0） 💬（0）<div>开启浏览器samesite属性对于csrf来说也是很好的防护</div>2020-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/d0/78/a11a999d.jpg" width="30px"><span>COOK</span> 👍（0） 💬（0）<div>ssrf通过服务端代理攻击，加白名单，限制协议或方法</div>2020-03-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/d0/78/a11a999d.jpg" width="30px"><span>COOK</span> 👍（0） 💬（0）<div>通过诱导性的网页发起，增加csrf token来防止</div>2020-03-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/cc/d3/bcb7a3fd.jpg" width="30px"><span>半兽人</span> 👍（0） 💬（0）<div>CSRF、SSRF是WEB安全的难点，老师能把这个讲透很了不起。</div>2020-03-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/d0/78/a11a999d.jpg" width="30px"><span>COOK</span> 👍（0） 💬（0）<div>转账一般都要使用双因素验证，也是为了防止CSRF</div>2020-03-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/f7/21/fbfc06c5.jpg" width="30px"><span>大鹏展翅</span> 👍（0） 💬（0）<div>安全攻防，认真学习</div>2020-03-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/e3/d7/d7b3505f.jpg" width="30px"><span>官</span> 👍（0） 💬（0）<div>自己公司更多地是做一些偏向内网使用的ERP系统，感觉更多的是SSRF的防护要更加重要一些，我认为黑客会通过伪造公司内网的请求，获取公司组织和资源的数据。不过感觉可能内网规模毕竟不大，虽然数据不少但是可配备的人员资源不多，个人觉得通过白名单来进行限制，让代理服务只能从内网的服务器发出，虽然考虑到业务增长规模，可能后面还要不断的维护这个白名单池子，但是现阶段考虑到人员配置感觉应该是比较合适的办法。</div>2020-03-18</li><br/>
</ul>