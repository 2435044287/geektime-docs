你好，我是何为舟。

如果你细心观察的话，应该会发现，随着Web应用越来越多，黑客的攻击目标也逐渐转向了针对Web安全的攻击。传统的防火墙主要专注于网络层的攻击防御，对Web安全的防御能力相对欠缺。因此，WAF（Web Application Firewall，Web应用防护系统）的概念也就被提了出来。WAF说白了就是应用网关防火墙的一种，它只专注于Web安全的防御，近几年来逐渐被当成一个相对独立的产品方向来研究。

那么，WAF和防火墙到底有哪些区别呢？针对我们之前讲过的各种Web攻击手段，WAF是如何提供保护的呢？今天，我们就一起来看！

## WAF的工作模式

前面我说过，WAF的本质是“专注于Web安全的防火墙”，Web安全关注于应用层的HTTP请求。因此，WAF的分析和策略都工作于应用层。

在Web安全这个方向上，WAF对比防火墙又做出了哪些改进呢？我们可以从WAF的三种工作模式入手，探讨这两者的区别。这三种工作模式分别是：透明代理、反向代理和插件模式。

**透明代理和大部分防火墙的工作模式相同**：在客户端和服务端通信不需要作出任何改变的情况下，对HTTP流量进行请求和转发。在这个过程中，为了解密HTTPS流量，WAF必须和服务端同步HTTPS对称密钥。  
![](https://static001.geekbang.org/resource/image/5a/28/5a545133d2e1eee0455a232df595c528.jpg?wh=1920%2A761)  
透明代理的优点就是容易部署，它不需要客户端和服务端进行任何改动。但是，透明代理的缺点也有很多。透明代理本身不是一个Web服务，所以它无法修改或者响应HTTP的请求，只能够控制请求的通过或者拒绝。正因为如此，它也无法实现Web服务所提供的认证、内容过滤等功能。
<div><strong>精选留言（15）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/13/38/69/864569a4.jpg" width="30px"><span>devil</span> 👍（19） 💬（1）<div>老师有没有推荐的开源waf？</div>2020-02-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/76/f5/e3f5bd8d.jpg" width="30px"><span>宝仔</span> 👍（8） 💬（1）<div>现代基于k8s微服务的架构下,用哪种模式的WAF会更好呢？微服务下一般会有一层网关，网关可能是基于java的spring gateway，也可能是基于openresty(nginx+Lua)的Kong，想问下这种模式下怎么设计WAF更加友好点？望老师能做回复</div>2020-02-01</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/22aLiabkzOiaibmszqJlRVMcOdbnNicnaicDfAcOPoINWLibicYflZjMib6uibYqKOeibRHvuzgTSoAs8rzZvAiayA7E6jctQ/132" width="30px"><span>Geek_</span> 👍（7） 💬（1）<div>老师，请问0day漏洞和1day漏洞有什么区别和联系？</div>2020-06-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/2f/f4/2dede51a.jpg" width="30px"><span>小老鼠</span> 👍（5） 💬（1）<div>1，现在有许多技术可以挠过WAF，绕过WAF的难度有多大？2，是不是有了好的WAF，程序就可以不用作对sql注入，XSS注入，CSRF的工作？3，WAF可防止DDoS，钓鱼，旁注攻击吗？</div>2020-02-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5d/11/40b47496.jpg" width="30px"><span>李海涛</span> 👍（3） 💬（1）<div>市面上都有哪些主要WAF产品等，各有什么优缺点，就更好了。</div>2020-01-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/3a/6e/e39e90ca.jpg" width="30px"><span>大坏狐狸</span> 👍（2） 💬（4）<div>在客户端和服务端通信不需要作出任何改变的情况下，对 HTTP 流量进行请求和转发。在这个过程中，为了解密 HTTPS 流量，WAF 必须和服务端同步 HTTPS 对称密钥。

后面讲  “如果 WAF 宕机了，只是无法提供 Web 防护而已，客户端和服务端的通信不会受到任何影响“
这里老师 它不转发了 C和S为什么不受影响呢？</div>2020-03-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/76/f5/e3f5bd8d.jpg" width="30px"><span>宝仔</span> 👍（2） 💬（1）<div>现在的WAF一般都是nginx+lua来实现的把？</div>2020-01-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/47/31/f35367c8.jpg" width="30px"><span>小晏子</span> 👍（2） 💬（1）<div>可以从安全防护的地方入手，如WAF通过正则匹配进行行为检测，那么可以考虑能不能绕过正则匹配或者让其匹配失效，比如通过提交非常大的数据，使其数据量超过WAF的能够正则匹配字符，那就可以不经过WAF的正则匹配了。</div>2020-01-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/bc/25/1c92a90c.jpg" width="30px"><span>tt</span> 👍（1） 💬（1）<div>绕过WAF也是用双拼和闭合么？</div>2020-01-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/72/15/a8b97a39.jpg" width="30px"><span>LubinLew</span> 👍（2） 💬（0）<div>关于WAF的透明代理模式无法更改请求和响应的说法是错误的,我从事WAF开发多年,硬件WAF的透明代理模式都是可以根据功能修改流量的。其原理是从内核将TCP包截获到用户态的TCP协议栈,再还原成HTTP协议,修改后在发送到用户态的TCP协议栈,封包后再发送出去。</div>2022-06-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/34/df/64e3d533.jpg" width="30px"><span>leslie</span> 👍（1） 💬（0）<div>这个东西其实早就被广泛使用了：具体原理用途都大致知道，记忆中这东西应当有和nginx一起使用，真实的作用还是第一次如此学习；受教了。</div>2020-01-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/fb/b7/6ecb191f.jpg" width="30px"><span>yong</span> 👍（0） 💬（0）<div>我司没钱有人，用了naxsi. </div>2021-07-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8c/5c/3f164f66.jpg" width="30px"><span>亚林</span> 👍（0） 💬（1）<div>可不可以直接把WAF直接干死，不绕过了？</div>2021-07-07</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/8OPzdpDraQMvCNWAicicDt54sDaIYJZicBLfMyibXVs4V0ZibEdkZlbzxxL7aGpRoeyvibag5LaAaaGKSdwYQMY2hUrQ/132" width="30px"><span>code2</span> 👍（0） 💬（0）<div>而且，目前 AOP 技术十分流行，各类编程语言都支持。——
aop是一种软件工程技术，又译为面向方面编程，与编程语言支持没有关系。</div>2021-02-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/45/33/59a7be1e.jpg" width="30px"><span>蔡波</span> 👍（0） 💬（0）<div>请教下老师，在留言中回答的，当WAF出现故障，网络中间件自动降级熔断是如何实现，可以展开讲下吗？我能想到的就是在网络设备上配置浮动静态路由来实现这个思路。</div>2020-04-23</li><br/>
</ul>