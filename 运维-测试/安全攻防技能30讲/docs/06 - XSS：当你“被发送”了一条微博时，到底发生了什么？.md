你好，我是何为舟。

在前面的课程中，我们重点讲解了安全的一些基础知识，更多地是从宏观的层面上来谈论安全。但**安全不是一个靠宏观指导就能够落地的东西**。因此，接下来我会结合真实案例中的各种安全问题，来介绍具体的安全防护手段和工具。今天，我们就先从最基础的Web安全开始。

在Web安全这个模块中，我们所谈论的Web，是指所有基于HTTP或者其他超文本传输协议（RPC等）开发的应用，包括：网页、App、API接口等等。这类应用的共同点是：通过HTTP等文本协议，在客户端和服务端之间进行数据交换。客户端需要将服务端传出的数据展示渲染出来，服务端需要将客户端传入的数据进行对应的处理。而Web安全所涉及的正是这些应用中存在的各类安全问题。

背景介绍完了，下面我们进入今天的正题。

基于前面安全基础知识的学习，你现在通过了面试官的考核，成功进入了这家公司。某一天，公司的网页应用中发生了一件事。

有很多用户发送了同样类型的内容，而且这些内容都是一个带有诱惑性的问题和一个可以点击的链接。这些用户全部反馈说，这不是他们自己发的。前端开发表示，用户内容都是后端产生的，他不负责。后端开发表示，这些内容都是用户自己提交上来的，他也不负责。正当大家议论纷纷的时候，你作为学习过安全专栏的人，敏锐地发现了问题的原因：这是黑客发起了XSS攻击。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/16/8a/e7/a6c603cf.jpg" width="30px"><span>GitHubGanKai</span> 👍（12） 💬（1）<div>老师  使用csp 如果前端使用了cdn 或者通过script标签加载其他的第三方库，如果这些域没有在白名单下，对于加载这些不同域的资源是不是也会限制呢 ？</div>2020-02-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/b7/d1/94a0220b.jpg" width="30px"><span>1.1</span> 👍（10） 💬（1）<div>老师，像 XSS 盗 cookie 这种情况，我们只要在单点登录的应用认证成功后 Set-Cookie 时加上 HttpOnly 字段，避免 JS 用 document.cookie 读取(前端一般也不需要操作 cookie吧)，是不是很大程度降低用户凭证被盗取的危害？
</div>2020-07-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/8a/e7/a6c603cf.jpg" width="30px"><span>GitHubGanKai</span> 👍（9） 💬（1）<div>老师，前端请求中，出于安全问题，为什么浏览器会对ajax 请求有跨域安全限制，但是像&lt;script src=&#39;xxx&#39;&gt;&lt;img src=&#39;xxx&#39;&gt;这样的标签请求过来的数据，却没有跨域安全限制呢？</div>2020-02-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/c4/d4/5c8fb1cb.jpg" width="30px"><span>肖大妞</span> 👍（6） 💬（2）<div>您这个讲解需要一定基础的人才能看吗
我研究了半天，各种xss攻击除了存储位置的不同，并没有看到实质的区别
能不能具体的讲讲黑客从开始攻击到获取服务器端cookie的一整个过程，我并没有看的太懂。。。</div>2020-01-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/65/c1/afcd981b.jpg" width="30px"><span>程序员二师兄</span> 👍（4） 💬（2）<div>
有点不太明白，黑客怎么修改 DOM 伪造登录窗口呢？ 而且是正常的域名
</div>2020-03-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/68/aa/6d5f2115.jpg" width="30px"><span>PyGeek</span> 👍（4） 💬（3）<div>请问您觉得csrf和xss应该是一种包含关系，还是各有各的区别？</div>2020-03-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/3a/6e/e39e90ca.jpg" width="30px"><span>大坏狐狸</span> 👍（3） 💬（2）<div>JWT 那个 岂不是 有人拿了客户端的东西 就能借用被人的名义干啥事了。</div>2020-03-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ef/a2/6ea5bb9e.jpg" width="30px"><span>LEON</span> 👍（3） 💬（3）<div>老师请教下，存储型XSS也能修改DOM进行XSS攻击吧？这种方法和传统的DOM XSS有什么区别？感谢</div>2019-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/47/31/f35367c8.jpg" width="30px"><span>小晏子</span> 👍（3） 💬（1）<div>是这分析一下这次攻击，用户点击了链接就自动发送微博了，那么整个链路就是前端—后端—前端，而要达到这样的目的，一定是有javascript脚本被执行了，伪装的js脚本获取本地cookie后直接调用后端接口来发送微博，正好符合反射XSS的定义。对于这个问题，感觉开发运维安全都有责任，开发为什么没做安全字符检验，运维安全为什么没有对这种突然爆发的转发信息没有意识到安全问题</div>2019-12-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/76/f5/e3f5bd8d.jpg" width="30px"><span>宝仔</span> 👍（3） 💬（2）<div>我觉得不应该去讨论背锅这个问题，问题核心在于怎么解决，以及各端明确未来的防范措施，下次再犯，再来定位锅的问题</div>2019-12-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/63/89/f7d841c1.jpg" width="30px"><span>tardc</span> 👍（2） 💬（1）<div>如果是用户浏览了那条微博就”被发微博“应该算持久性XSS；如果是用户点击了那条微博的链接才”被发微博“应该算CSRF。
发生这种事情应该大家一起处理才好，也没锅可甩：对于开发人员来说，没有安全知识不算是一个合格的开发者；对于安全人员来说，未对开发人员做好安全知识培训或业务安全负责没做足。大家都有责任，一起处理问题才对。</div>2020-03-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/cb/9d/2bc85843.jpg" width="30px"><span>　　　　　　　鸟人</span> 👍（2） 💬（1）<div>现在很多浏览器都开始大量过滤xss  那么xss会不会死亡呢</div>2020-03-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg" width="30px"><span>我来也</span> 👍（2） 💬（1）<div>字符串替换的那个，如果不是替换为空字符串，而是替换成一个空格，那是不是就安全了呢？</div>2019-12-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/bc/25/1c92a90c.jpg" width="30px"><span>tt</span> 👍（2） 💬（1）<div>不要相信用户的输入。那么前端要处理自用户的输入么？要。后端要处理用户的输入么？也要。没有正确处理，就有责任。

微博的例子是不是存储行XSS攻击呢？A用户发送的微博中被嵌入了恶意脚本，另外一个用户B浏览此内容的时候，因为已经登陆了，可以直接用自己的身份（Token或cookes）直接发布到服务器上</div>2019-12-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/34/df/64e3d533.jpg" width="30px"><span>leslie</span> 👍（1） 💬（1）<div>  问题中应当是通过持久型 XSS&#47;存储型XSS进行攻击，解决方式应当是CSP进行防御。
  指出文章中老师同一个概念用了不一致不同名称的小问题，对于老手没影响，可能对于新手却会造成理解上的误区。在开始部分老师用了“三种 XSS 攻击，它们分别是：反射型 XSS、基于 DOM 的 XSS 以及持久型 XSS。”，总结部分却用了&quot;根据攻击方式的不同，可以分为：反射型 XSS、基于 DOM 的 XSS 和存储型 XSS。&quot;，名称不一致。
     感谢老师的分享：学习中还是扫除了不少误区，提升了自己对于安全方面的理解；谢谢。</div>2019-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/eb/19/0d990b03.jpg" width="30px"><span>ZeroIce</span> 👍（1） 💬（1）<div>现在很多请求会带token 头部去请求（jwt）？单单点击一条链接，应该不可以发一条微博吧</div>2019-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/eb/19/0d990b03.jpg" width="30px"><span>ZeroIce</span> 👍（1） 💬（1）<div>还有个问题：黑客怎样去控制用户的输入？   控制不了的话，当然也注入不了脚本代码呀。</div>2019-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/eb/19/0d990b03.jpg" width="30px"><span>ZeroIce</span> 👍（1） 💬（1）<div>由于sop的影响，window.location不是也不可以跳转？怎么这个也会影响cookie泄漏了？</div>2019-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/47/fd/895f0c27.jpg" width="30px"><span>Cy23</span> 👍（1） 💬（2）<div>我好像学到点怎么攻击别人，你们呢</div>2019-12-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/23/6c/785d9cd3.jpg" width="30px"><span>Snooker</span> 👍（0） 💬（2）<div>老师好，针对系统内已存在的存储型xss漏洞要如何修复？是需要前端修改页面解析漏洞？后端修改数据存储逻辑吗？</div>2021-01-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/45/6e/11cf22de.jpg" width="30px"><span>普罗米修斯</span> 👍（0） 💬（1）<div>老师，您这个窃取cookie的xss攻击属于永久存储型的xss攻击吗，有没有一些在nginx防护的措施？现在还是有很多公司用这个nginx的，我们公司就是，还遇到了各种xss攻击，脑阔疼</div>2020-11-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c4/03/f753fda7.jpg" width="30px"><span>JianXu</span> 👍（0） 💬（1）<div>老师，对于反射型XSS 攻击，是不是只能去通过诱使客户点击我们准备的链接来实现，而且该链接所在的domain 必须和原来的系统UX 同源？

也就是说假设原来是http:&#47;&#47;www.abc.com , 那么诱导用户点击的链接也必须是 http:&#47;&#47;www.abc.com ?</div>2020-10-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/9b/6e/edd2da0c.jpg" width="30px"><span>蓝魔丶</span> 👍（0） 💬（1）<div>老师，xss的前两种攻击方式黑客是如何在用户的当前网页植入带有恶意脚本的链接的？</div>2020-07-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/30/67/a1e9aaba.jpg" width="30px"><span>Roway</span> 👍（0） 💬（3）<div>请问老师，白名单的规则不太明白，数字框好理解，比如一个输入框怎么去使用白名单?</div>2020-06-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/23/6c/785d9cd3.jpg" width="30px"><span>Snooker</span> 👍（0） 💬（1）<div>针对输入框的，有什么技术可以使得用户输入什么就展示什么吗？
这样是不是就可以避免一部分的xss攻击？</div>2020-05-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/9c/49/e5c18d86.jpg" width="30px"><span>丁东</span> 👍（0） 💬（1）<div>老师，听说最近微博用户信息泄露，能作为个案例给讲讲有什么教训和经验？</div>2020-03-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/e3/d7/d7b3505f.jpg" width="30px"><span>官</span> 👍（0） 💬（1）<div>反射型XSS，这个自己中招过，当时太忙了没有思考随手点击链接解锁了丢了的苹果手机的验证码，而之前苹果客服打来电话反复提醒不要打开陌生短信，但是忙到不可开交的时候如果正巧黑客抓住机会发来短信，那么确实可能会中招。后来反思了很久，首先从用户角度来讲因为用户的情况五花八门，就算平常有安全意识也会出现疏忽的时候，所以我觉得只从用户角度加强安全意识是不够的，还是需要从服务端预防。
至于说开头的问题，我认为安全负责人首先没有意识到漏洞的存在，如果安全负责人认识到这个问题，那么他会联系前后端开发人员，让他们采取必要的措施，比如引入CSP来防护XSS，这样能够一定程度上从源头上避免XSS攻击。</div>2020-03-17</li><br/><li><img src="" width="30px"><span>Geek_2c2d0e_saga</span> 👍（0） 💬（1）<div>我的微博账号就遇到过被大批量发广告</div>2020-02-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/2f/f4/2dede51a.jpg" width="30px"><span>小老鼠</span> 👍（0） 💬（1）<div>反射XSS也可以不点击触发，比如：&lt;img src=# onerror=...&gt;。ESAPI对防御XSS作用大吗？</div>2019-12-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/51/50/f5f2a121.jpg" width="30px"><span>律飛</span> 👍（0） 💬（1）<div>问题1：哪种类型的XSS攻击，怎么预防？
文中有一段话：这个事情的原型，其实是 2011 年微博真实出现的一次安全事件。整个事件的核心问题，其实出在这个可以点击的链接上。在这个事件中，黑客并不需要入侵到微博服务器中，只要用户点击了这个链接，就会“被发送”这样的博文。
没有入侵到服务器，因此判断是反射型XSS或者基于DOM的XSS。
预防 XSS优先采用编码的方式，通过对用户内容的验证来完成。如果编码影响到了业务的正常功能，可以采用白名单的检测和过滤方式来进行验证。除此之外，还可以根据业务需要，配置合适的 CSP 规则。
问题2：出现问题由谁背锅？
如果有安全负责人，首先由他背锅。他应在软件需求分析、设计、测试各阶段关注安全问题以及解决落实情况。
没有安全负责人，开发人员背锅。开发人员应具备基本的安全意识，掌握基本的安全技术。
运维人员也要承担一定的责任，不能发现问题提出问题，也不是一名合格的运维人员。
当然如果黑客太厉害，吾等已尽力而为时，只能由公司背锅。通过交学费也能促使提升安全防护能力嘛！
另外请教老师：1、编码是不是常说的参数化？就是尽量将用户输入参数化？2、苹果手机经常无缘无故地提示，SIM卡发送一条文本信息。这个是被黑客攻击了吗？出现这种情况时，肯定没有点击任何链接。</div>2019-12-31</li><br/>
</ul>