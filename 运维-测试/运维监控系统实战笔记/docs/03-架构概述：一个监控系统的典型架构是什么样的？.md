你好，我是秦晓辉。

这一讲，我们来聊聊监控系统的典型架构，看看监控系统由哪些模块组成，各个模块是如何相互协同的。业界监控系统数量较多，如果我们一上来就陷入某个具体的系统中，容易一叶障目，不见泰山。这里我把众多监控系统的架构做了一个统一的抽象和概括，后面你再看到任何一个监控系统，都能快速理解了。

## 典型架构

![图片](https://static001.geekbang.org/resource/image/9e/f5/9edcfef623ea9583134533c3b4c477f5.png?wh=1920x781)

我们先来看监控系统的典型架构图，从左往右看，采集器是负责采集监控数据的，采集到数据之后传输给服务端，通常是直接写入时序库。然后就是对时序库的数据进行分析和可视化，分析部分最典型的就是告警规则判断（复杂一些的会引入统计算法和机器学习的能力做预判），即图上的告警引擎，告警引擎产生告警事件之后交给告警发送模块做不同媒介的通知。可视化比较简单，就是图上的数据展示，通过各种图表来合理地渲染各类监控数据，便于用户查看比较、日常巡检。

下面我们就来逐一分析一下每个模块的职能和设计。

## 采集器

采集器负责采集监控数据，有两种典型的部署方式，一种是跟随监控对象部署，比如所有的机器上都部署一个采集器，采集机器的 CPU、内存、硬盘、IO、网络相关的指标；另一种是远程探针式，比如选取一个中心机器做探针，同时探测很多个机器的PING连通性，或者连到很多MySQL实例上去，执行命令采集数据。
<div><strong>精选留言（27）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/5d/11/e1f36640.jpg" width="30px"><span>怀朔</span> 👍（13） 💬（1）<div>作者已经罗列非常全的，就不怎么想说之前的开源监控产品，目前主流还是向promethues 或者说向云原生靠近。近期质量比较高的课程了👍查看大家的留言，想回答小公司运维人员不多情况 又想达到好的效果，考虑到投入产出比，建议报警收敛和告警升级 聚合管理推荐商业化产品好了。
优点：大而全可以直接用，很多功能都已经完善开箱即用。
缺点：数据隐私问题 、还要钱。</div>2023-01-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/32/49/d5/9b4a2e04.jpg" width="30px"><span>李慢慢</span> 👍（4） 💬（1）<div>极度想听告警引擎跟告警收敛这块，告警引擎这块有没有开源的，自己开发头大，没思路</div>2023-01-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/b7/00/12149f4e.jpg" width="30px"><span>郭刚</span> 👍（3） 💬（3）<div>请问老师，Elasticsearch可以当时序库吗？</div>2023-01-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/c8/5d/edfa625d.jpg" width="30px"><span>Mori</span> 👍（2） 💬（1）<div>老师请教下，其实现在很多产品都是基于云上的，想机器类的我们可以通过安装agent采集指标，但是如果像中间件、数据库等云产品，通过接口获取指标又存在1：拉取时延  2：无法跟应用关联  的这种情况，这种有什么其他的思路想法呢？</div>2023-01-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/32/2b/b9424077.jpg" width="30px"><span>aaaaa</span> 👍（2） 💬（1）<div>介绍的还是比较全面的，各个工具都能简要了解</div>2023-01-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/52/34/f40b3b12.jpg" width="30px"><span>玫友人</span> 👍（1） 💬（1）<div>课程非常受用，容易理解，深度也够，希望课程可以更新多些。</div>2023-01-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/f3/00/384c398b.jpg" width="30px"><span>良才</span> 👍（1） 💬（1）<div>我想问下，文中提到的由于时序数据库的原因，大多数采集器是收集的数值型数据么。那对于这些产品我需要采集字符型数据时又是如何处理呢</div>2023-01-13</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eobiabkoCXUvOFYlqliciaRMNQwCqPwY8NH4ohSicLZSgz31rjHR6j8NNEplIWcu5bN7ptlw4KD4DBCWQ/132" width="30px"><span>Geek_ad609d</span> 👍（0） 💬（1）<div>老师，关于时序库的介绍中没有介绍prometheus</div>2024-11-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/8b/2a/289f04c3.jpg" width="30px"><span>周文杰</span> 👍（0） 💬（1）<div>你好，关于日志的处理有两个疑问
1.日志从非结构化转化到结构化一般是用什么工具
2.日志的告警又是怎么实现的</div>2023-10-29</li><br/><li><img src="" width="30px"><span>mover</span> 👍（0） 💬（1）<div>你好，我有一个关于vm作为大规模时序数据库的疑惑，辛苦解答一下。vm集群是没有副本概念的，也没有wal机制，如果vm节点故障了，是不是故障期间路由到故障vm节点的数据，以及节点故障前缓存在系统中，还没有刷到磁盘上的数据都丢失了？如果一个节点的磁盘损坏了，是不是这个节点上的所有数据都可能丢失了？生产环境中，我们该如何考虑时序数据的高可用呢？</div>2023-04-06</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/TKywGoQEbNyWzKHV5xsc1bPvCwlA1NWgHtabsd4xGSibvyWdUjF3Qo8CMhgOjJ6Q83ribh5BxKO8X8xaER2w3Axw/132" width="30px"><span>frekoala</span> 👍（0） 💬（1）<div>请问老师，这4种采集器对信创机器支持怎么样呢？</div>2023-02-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c3/d1/bdf895bf.jpg" width="30px"><span>penng</span> 👍（0） 💬（1）<div>有没有用es来存储监控数据的</div>2023-02-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/ae/cf/6186d936.jpg" width="30px"><span>辉度</span> 👍（0） 💬（1）<div>如何评价banyandb呢？</div>2023-02-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/10/c5/9446c905.jpg" width="30px"><span>行路人</span> 👍（0） 💬（1）<div>老师我想问下grafana如何内嵌进自己的项目上啊？是在grafana基础上进行二次开发吗？</div>2023-02-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ca/07/22dd76bf.jpg" width="30px"><span>kobe</span> 👍（0） 💬（3）<div>国内有类似PagerDuty的开源产品么</div>2023-01-29</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqjbPAydn9KY6LQox6v4zhMW0JSiaqB3uEMl3yJbcFkqO7IwVVFyww2waHypJn8xqibhvowz0ibf71tA/132" width="30px"><span>晨光</span> 👍（0） 💬（1）<div>&quot;周期轮询式，架构简单，通常是一个规则一个协程，按照用户配置的执行频率，周期性查询判断即可，因为是主动查询的，做指标关联计算就会很容易。像 Prometheus、Nightingale、Grafana 等，都是这样的架构。&quot;

这里想问下是否有必要引入分布式任务调度框架来实现告警规则的执行，如果基于协程的在性能上可能存在瓶颈</div>2023-01-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg" width="30px"><span>peter</span> 👍（0） 💬（2）<div>Q1：Grafana-agent支持事件采集吗？
Q2：remote-write是基于http吗？</div>2023-01-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2e/09/d0/8609bddc.jpg" width="30px"><span>戒贪嗔痴</span> 👍（0） 💬（5）<div>老师，你好。最近在用zabbix-java-gateway，来获取tomcat的指标数据，web端配置了jmx的ip和端口，绿灯可以点亮。也配置了企微告警，但是有一个问题，就是总是报jvm is not reachable 多少秒，过一会就自动恢复了，还有故障和恢复同一时间的这种情况，怀疑是网络问题，但是我telnet开放的端口都是通的。报警的时候其实应用是正常的，不知道哪里出了问题，希望老师可以指点一二，在此谢过！</div>2023-01-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/4f/b0/ab179368.jpg" width="30px"><span>hshopeful</span> 👍（0） 💬（1）<div>有个问题想请教下老师：telegraf 中 tail 插件需要配置基于 grok 类型的正则表达式，categraf 中集成 google 开源的 mtail 插件的配置是基于 perl 的正则表达式，我自己实践下来感觉 mtail 里面的配置起来比较方便，grok 类型的配置很麻烦，老师能讲下这两种类型的区别吗？有点怀疑我自己对于 telegraf 中 tail 插件的使用姿势不对</div>2023-01-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ea/c1/3a0eb385.jpg" width="30px"><span>Andrew DP</span> 👍（0） 💬（3）<div>老师咨询下，prometheus+vm的架构，有简单的方法直接让prometheus的技术数据都来源vm吗，而不是使用prometheus临时存储的数据做计算，我们发现prometheus的内置数据很容易打满，打满之后容易造成prometheus和vm数据不一致</div>2023-01-13</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/gyBCdrcVIIky4na9aRuz8AXsrEPYGZ4wdrBWOdo4ib8eFxgyh7q2Ob310Z96AgjpSYGPKxFwgfWRIMXbSWh5icfg/132" width="30px"><span>feixiang622</span> 👍（0） 💬（1）<div>老师问您好，对于开源的伴随类的agent，如果部署的数量很庞大，进行升级或是批量修改配置，有何好的解决方案吗？</div>2023-01-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/59/af/d2107a67.jpg" width="30px"><span>二九幂加八</span> 👍（0） 💬（2）<div>如何知道组件内置支持了 Prometheus？直接通过自身的  &#47;metrics 接口提供监控数据，不用再单独伴生 Exporter，直接提供的JMX数据的组件内置Prometheus吗</div>2023-01-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/27/ff/e4/927547a9.jpg" width="30px"><span>无名无姓</span> 👍（0） 💬（1）<div>那到底拉的模式好，还是推的模式好呢</div>2023-01-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/5d/52/21275675.jpg" width="30px"><span>隆哥</span> 👍（0） 💬（1）<div>明天实践一下Categraf</div>2023-01-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a5/88/072f079a.jpg" width="30px"><span>Poiuy</span> 👍（0） 💬（2）<div>看了看第三讲和目录，感觉没有当年你讲open falcon那系列视频那么透彻，读书的时候看的一晃已经6年了，时间过得可真快</div>2023-01-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0e/2a/e6b443f0.jpg" width="30px"><span>孙荣辛.py</span> 👍（7） 💬（0）<div>23年的Qcon大会上，我旁听了可观测主题的讨论，目前看，引入流式计算，进行指标预计算和聚合，对于提高计算速度，减轻Prometheus压力，提高计算准确性上都有帮助，已经是一种大厂的标配方案了有兴趣的同学可以在这列找到ppt https:&#47;&#47;ppt.infoq.cn&#47;list&#47;106</div>2023-03-17</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/gyBCdrcVIIky4na9aRuz8AXsrEPYGZ4wdrBWOdo4ib8eFxgyh7q2Ob310Z96AgjpSYGPKxFwgfWRIMXbSWh5icfg/132" width="30px"><span>feixiang622</span> 👍（3） 💬（2）<div>老师您好，对应开源类的agent，如果部署的数量比较庞大了，如何进行在线的批量在线升级或修改配置，有好的解决方案吗？</div>2023-01-13</li><br/>
</ul>