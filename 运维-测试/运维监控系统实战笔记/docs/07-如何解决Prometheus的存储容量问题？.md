你好，我是秦晓辉。

前几讲我们介绍了Prometheus的关键设计，这些设计都非常优秀。在云原生监控领域，有不可撼动的江湖地位，那这样说来 Prometheus 是不是就没有缺点了呢？是否可以满足所有使用场景呢？显然也不是。

一个软件如果什么问题都想解决，就会导致什么问题都解决不好。所以Prometheus 也存在一些不足之处，其中一个广受诟病的问题就是**单机存储不好扩展**。所以这一讲我们就针对这个问题来聊聊如何扩展 Prometheus 的存储。

## 所有场景都需要扩展容量吗？

虽然我们聊的是 Prometheus 容量扩展问题，不过我必须先说明一点，大部分场景其实不需要扩展，因为一般的数据量压根达不到 Prometheus 的容量上限。很多中小型公司使用单机版本的 Prometheus 就足够了，这个时候不要想着去扩展，容易过度设计，引入架构上的复杂度问题。

Prometheus 单机容量上限是多少？根据我的经验，每秒接收 80 万个数据点，算是一个比较健康的上限，一开始也无需用一台配置特别高的机器，随着数据量的增长，可以再升级硬件的配置。当然，如果想要硬件方便升配，就需要借助虚拟机或容器，同时需要使用分布式块存储。

每秒接收 80 万个数据点是个什么概念呢？每台机器每个周期大概采集 200 个系统级指标，比如CPU、内存、磁盘等相关的指标。假设采集频率是 10 秒，平均每秒上报 20 个数据点，可以支持同时监控的机器量是 4 万台。
<div><strong>精选留言（21）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/1c/4e/88/791d0f5e.jpg" width="30px"><span>lei</span> 👍（3） 💬（3）<div>80w的数据点是在怎么样的机器上测出来的，内存和核数能告知下嘛？另外正式版搭建时，推荐的配置是什么样子的，官网也没找到合适的建议！</div>2023-02-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/38/e1/db/8a30424d.jpg" width="30px"><span>北方的猫</span> 👍（2） 💬（1）<div>老师，您好，用influxdb作为prometheus的远程存储方案怎么样，然后influxdb直接对接到grafana做查询展示，我看influxdb热度很高啊</div>2023-10-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/4e/88/791d0f5e.jpg" width="30px"><span>lei</span> 👍（2） 💬（1）<div>VictoriaMetrics的数据保留时长可以针对不同的业务单独去配置吗，如果是全局的就不太友好</div>2023-02-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/4f/b0/ab179368.jpg" width="30px"><span>hshopeful</span> 👍（2） 💬（2）<div>几年前在的公司是参考opentsdb，底层使用hbase 自研的</div>2023-01-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/1d/d1/f427b83e.jpg" width="30px"><span>javaworker</span> 👍（1） 💬（1）<div>老师，我的prometheus server 运行sql，运行几次就内存溢出了，sql查询结果也就4万多条，哪里可以配置server的堆内存呐？</div>2023-08-13</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJkGGBK46EQppJydxheC43vBzLqC0t0bpn08cNWW6XsLoRZsLvsR0zBgXAYcAcWDZyicHXOy4ffHsw/132" width="30px"><span>Geek_51809f</span> 👍（1） 💬（1）<div>老师 有了解远端存储使用es的方案吗  我现在了解到使用es只能写， 不支持读，这种是什么原因不支持读呢</div>2023-03-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/9a/0a/6c74e932.jpg" width="30px"><span>光</span> 👍（1） 💬（1）<div>grafana 公司出品的mimir是否可以评价下设计优势和场景。</div>2023-02-01</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJkGGBK46EQppJydxheC43vBzLqC0t0bpn08cNWW6XsLoRZsLvsR0zBgXAYcAcWDZyicHXOy4ffHsw/132" width="30px"><span>Geek_51809f</span> 👍（0） 💬（1）<div>老师 如果使用2台prometheus（采集一样的数据），同时去写到一个共享目录data, 这样可以解决数据一致性的问题。这种方案同时写到一个目录可以实现吗</div>2023-05-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/1f/08/bc66fc56.jpg" width="30px"><span>追风少年</span> 👍（0） 💬（1）<div>老师，VictoriaMetrics 开源版本缺少降采样功能对存储容量、查询性能有整体影响吗。</div>2023-03-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ec/e8/79293a29.jpg" width="30px"><span>莫问天机</span> 👍（0） 💬（1）<div>请教个问题，prometheus windows 版本，默认存储时间15天，这个如何改呢</div>2023-02-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/4e/88/791d0f5e.jpg" width="30px"><span>lei</span> 👍（0） 💬（1）<div>大佬咨询下，Prometheus的远程存储方案是不是只利用了Prometheus的pull功能，存储完全放在VM上。n9e在write的时候也是直接对接VM？</div>2023-02-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e3/12/fd02db2e.jpg" width="30px"><span>April</span> 👍（0） 💬（2）<div>Prometheus🈶️推荐的高可用方案吗？</div>2023-02-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/13/67/910fb1dc.jpg" width="30px"><span>leeeo</span> 👍（0） 💬（3）<div>VM作后端，当扩展存储节点的时候，是否会导致原有节点的数据重新分布呢？</div>2023-01-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/30/ff/ed/791d0f5e.jpg" width="30px"><span>胡飞</span> 👍（0） 💬（1）<div>老师你好，如果是单机方案，也可以使用云存储吧，不一定非要使用第三方时许数据库搭配云存储吧？</div>2023-01-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg" width="30px"><span>peter</span> 👍（0） 💬（1）<div>请教老师几个问题：
Q1：vmselect的负载均衡，一般用什么？
Q2：thanos的对象存储，是云存储吗？比如阿里云一类的。如果是的话，相当于thanos需要借助于第三方了。
Q3：大公司是怎么使用prometheus的？
对于中小公司，一个prometheus单机就够了，但是，对于大厂，比如阿里、京东一类的公司，会怎么使用prometheus？
Q4：单机prometheus的本地硬盘一般多大？10T吗？</div>2023-01-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/73/08/dd9a4a38.jpg" width="30px"><span>小狼</span> 👍（1） 💬（0）<div>使用了influxdb作为远程存储</div>2023-02-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/c0/bb/3b48ea2c.jpg" width="30px"><span>ATony</span> 👍（1） 💬（0）<div>测试了VictoriaMetrics和thanos 的数据查询，VictoriaMetrics是快点，同一条promql 在VictoriaMetrics和thanos上查询，某一个时间点数据结果不一样，对比了prometheus的监控数据，thanos反而更为准确，不知道为什么?
</div>2023-01-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5a/9b/215cd2e0.jpg" width="30px"><span>Rebby</span> 👍（0） 💬（0）<div>我们是用druid</div>2024-03-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/f3/2f/fe5f0daf.jpg" width="30px"><span>流星泪</span> 👍（0） 💬（0）<div>想问下 这个采集 多pro server 数据是怎么merge的.  这种两份数据 是怎么处理的</div>2023-12-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/1d/ec/62fb1270.jpg" width="30px"><span>IvanYu</span> 👍（0） 💬（0）<div>灭霸会打响指</div>2023-08-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/27/ff/e4/927547a9.jpg" width="30px"><span>无名无姓</span> 👍（0） 💬（0）<div>看来可以集群模式</div>2023-01-23</li><br/>
</ul>