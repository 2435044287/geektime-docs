你好，我是高楼。

上节课，我们讲解了稳定性场景的两个要点：运行时长和压力量级，并通过课程的示例系统，带你具体操作了稳定性场景。

在定向分析的第一个阶段中，我们分析了虚拟机内存超分导致的操作系统OOM的问题，发现是配置的超分过大导致的。在我们降低了虚拟机的内存之后，稳定性场景的运行时间超过了12个小时，累积业务量达到7200多万，这样的结果已经达到了我们的目标。

可是，由于贪心，我并没有停止场景，就在它继续运行的时候，又出现了新问题……因此，我们今天就进入到定向分析的第二阶段，看看还有什么问题在等着我们。

## 定向监控分析

### 定向分析第二阶段

当场景继续运行的时候，我看到了这样的数据：

![](https://static001.geekbang.org/resource/image/eb/8f/eb84fbb4e1105ce58dd9e45f849b768f.png?wh=1813%2A652)

从图中我们可以很明显地看到，在场景持续运行的过程中，TPS掉下来了，响应时间则是蹭蹭往上涨。

我们看一下这时候的总业务累积量：

![](https://static001.geekbang.org/resource/image/c9/92/c9855e4f7cdb3b0d18d222f44bf50692.png?wh=269%2A126)

也就是说，多了20多万的业务累积量。

见到问题，不分析总是觉得不那么舒服，那我们就来分析一下。

还是按照性能分析决策树，我们把计数器一个一个查过去。在我查看MySQL的Pod日志时，发现它一直在被删掉重建：

![](https://static001.geekbang.org/resource/image/75/43/75aa8e663d3a3a8959d4443de60ba043.png?wh=1920%2A914)

请注意，我们这是一个示例系统，为了方便重建，我把MySQL放到Pod中了。如果是在真实的环境中，我建议你最好根据生产的实际配置来做数据库的配置。
<div><strong>精选留言（5）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/26/bd/c2/7ae92f28.jpg" width="30px"><span>小孔丞相</span> 👍（4） 💬（1）<div>1.你在稳定性场景中遇到过什么由于业务不断累积导致的问题？
  之前在稳定性测试过程中，遇到多redis的内存一直持续增长，导致内存OOM。后来排查是因为key的过期时间设置的太长了，改正后redis内存基本稳定了。
2.在稳定性场景中，如何保证磁盘使用量不会随场景持续增加，而是保持在一个使用量级？
  数据类型的目录，一般会有个保留机制，保留3个月；日志类型的会做日志轮询</div>2021-06-21</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83er9ay1I6KWdnn0MX1JSfic0xdmWLcD1Jh1Fx2AP67d6Kicr71HH5jOKHrUZbTmfsLTQDNTTroCbcTzA/132" width="30px"><span>sky_you</span> 👍（4） 💬（1）<div>1.你在稳定性场景中遇到过什么由于业务不断累积导致的问题？
   通常是内存不足。另外就是在混合场景中不曾出现的Full  GC 会在稳定性测试中出现，然后通过GC的发生频率，和发生时间适当的调整堆栈的大小。


2.在稳定性场景中，如何保证磁盘使用量不会随场景持续增加，而是保持在一个使用量级？
   通过日志文件归档，日志旋转，保持一定时间内的日志的方式，控制磁盘的无限扩增。</div>2021-06-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/23/be/81bd6a7b.jpg" width="30px"><span>knife</span> 👍（3） 💬（3）<div>分享个老运维的小技巧，在磁盘放20G的空文件，关键时刻能救命</div>2022-05-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/06/ac/55fba20b.jpg" width="30px"><span>qtracer</span> 👍（1） 💬（1）<div>保持数据量级这个思路不是很对，既然运维周期内，要支持这么多的业务量，不证明运维周期内的数据量也一直会增长吗？而这，有可能会改变到数据量级。除非生产本身就有数据归档和日志轮询的做法，将数据的增量维持在原有量级的范围内。</div>2024-03-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/63/85/1dc41622.jpg" width="30px"><span>姑射仙人</span> 👍（1） 💬（2）<div>1. 你在稳定性场景中遇到过什么由于业务不断累积导致的问题？
1). pod未设置memory limit，长时间运行导致k8s随机删除pod。劣币驱逐良币。
2). 数据库一些明细类、日志类表增长较快，有一些骚的join操作会挂掉。

2. 在稳定性场景中，如何保证磁盘使用量不会随场景持续增加，而是保持在一个使用量级？
1) Docker的日志输出也要设置大小去轮转，长时间运行日志太大。
2) 业务上debug日志，或者info日志输出的太多了。不要打印结果集明细数据到日志中。</div>2022-01-21</li><br/>
</ul>