你好，我是高楼。

在性能领域中，我们经常用“并发用户数”来判断一个系统是否达到性能需求，比如说用“系统支持1000用户”这样的描述来说明性能需求。但是并发是怎么个并发法？它和TPS之间是什么关系？并发用户数和在线用户数又是什么关系呢？

这样的问题长期以来困扰着性能工程师们。不管是网上看到的文章或者是各个群里的讨论，我们都能听到不同的声音。所以，我即便是冒着引起争论的危险，也要写一下这个问题。

## 典型的争论

有一天，有个小伙跟我说，他和同事们看到我上一个专栏[《性能测试实战30讲》](https://time.geekbang.org/column/intro/100042501)中的文章后，在公司会议室吵翻了天，有一个同事还把微积分都搬出来了。我很高兴听到这样的争论，就像战国时期的稷下学宫一样，不争论，哪有那么辉煌的文明高峰呢。

他们的争论点是这样的：有一个项目，性能目标是对一个底层是Kubernetes、上层是微服务架构的系统进行容量评估（系统性能验证）。而他们的争论点就在于这个容量评估的方法。

对于评估方法，他们分成了两个流派。第一种是根据DAU（Daily Active User，日活跃用户数量）和用户业务模型，推导出并发用户数（工具中未来的线程数）。而第二种反对第一种，认为第一种估算不合理，要站在服务端层面，去推导 服务端要承载的 并发请求数（TPS）。
<div><strong>精选留言（26）</strong></div><ul>
<li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83er9ay1I6KWdnn0MX1JSfic0xdmWLcD1Jh1Fx2AP67d6Kicr71HH5jOKHrUZbTmfsLTQDNTTroCbcTzA/132" width="30px"><span>sky_you</span> 👍（14） 💬（1）<div>其实我很想问一下，假如没有日志，就是一个新系统，什么参照数据都没有。客户也无法给出性能目标。最多给你个单个功能，比如一个按钮不能超过三秒。然后我一天要处理多少个订单。

在这种情况下，性能测试是不是没有必要做了？
老板会在做之前问，评估一下，我们能做出来多少并发的东西？我这个搞性能的是不是可以递交辞职报告了？？？</div>2021-06-03</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83er9ay1I6KWdnn0MX1JSfic0xdmWLcD1Jh1Fx2AP67d6Kicr71HH5jOKHrUZbTmfsLTQDNTTroCbcTzA/132" width="30px"><span>sky_you</span> 👍（3） 💬（1）<div>在线用户数。这个值可以从日志中取到；
在线用户数统计的时间段。这个值也可以从日志中取到；
用户级操作的完整业务流时间（记得多采样一些数据，计算平均时间）。这个值也是从日志中取到；
无停顿时间的完整业务流时间。这个值从压力工具中可以取到；
单用户完整业务流的请求数。这个值可以从日志中取到。

老师 全新的系统怎么办？</div>2021-06-03</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/B7mcB2ZFuTbB4OgjR9nXQsL6nlZFLq6Y1XDicdp8KhoNmzLCRsvEJxD584SampUsialBgYuxN3ibfXJHqdx0RMWmA/132" width="30px"><span>大白</span> 👍（3） 💬（1）<div>用户级操作的完整业务流时间（记得多采样一些数据，计算平均时间）。这个值也是从日志中取到；

1、这个平均业务流时间，才是最重要的核心机制，日志统计是大工程，难度较大

2、样本要尽量多，而且比例要到位，样本起码尽量要制定走完整个流程的用户比例和未走完流程的用例比例保持接近。这样才能满足真实用户的操作分布，因为每一个事务流程中的用户的思考时间由于业务的特殊性必然不一致。

3、按照这样理解，每个T的事务并发度其实都是不一样的，我感觉还是要做更细致的拆分。但是感觉这样就回到业务模型了啦。

4、 所以我思前想后在有日志的情况下，并发度的计算最大用处应该是最完容量测试后，最容量评估用的

5、如果是这样我是不是也可以业务模型的来反射出容量评估呢？ 例如我业务模型的通过日志采集完，1分钟内的 7个业务的比例和总的业务量&#47;60s，就是平均TPS1，那么我照业务模型实际跑出来的TPS2，那么容量评估就是 TPS1时的在线用户*(TPS2&#47;TPS1)
6、此时TPS2&#47;TPS1其实也是并发度的一种计算，而不在是文中一个用户连续走完所有的业务时间，其中的6秒，按照文中的思路想好像是那么回事，但是仔细想好像过于极端了！因为用户真实场景是通过大量样本的统计的平均时间，而这个6S确实一个且单用户的样本数据  。
7、5中的问题点，就是TPS1的在线用户数的统计问题了，那么就统计出1分钟内的在线用户即可</div>2021-04-08</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/B7mcB2ZFuTbB4OgjR9nXQsL6nlZFLq6Y1XDicdp8KhoNmzLCRsvEJxD584SampUsialBgYuxN3ibfXJHqdx0RMWmA/132" width="30px"><span>大白</span> 👍（2） 💬（2）<div>1、如何获取有效的在线用户的 TPS（不管是哪个层级的 TPS）？
通过分析日志，我现在用的是ELK，获取时间段内的TPS和在线用户数

2、性能场景中不包括静态资源的隐患是什么？
不能真实模型用户行为，比如用nginx做静态资源代理服务器，不做的话就会减少nginx的压力
但是静态资源这块更多的设计是前端性能了吧，比如压缩、缓存这些</div>2021-04-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/b4/35/3c5335d3.jpg" width="30px"><span>X_man</span> 👍（1） 💬（1）<div>老师您好。看了你的文章产生几个疑问
1、线程数是不是就是虚拟用户数？
2、并发用户数这个是等于线程数还是等于TPS数？我以前一直以为线程数是并发用户数相等，后面直到我看到高楼老师的这篇文章，
因为TPS来衡量服务器性能指标这个我是清楚的，但是平时测试的时候客户还有老板他们更关心的是并发用户，经常会问系统支持多少并发用户？我只能告诉他们支持多少TPS，因为他们的理解并发数就是线程数，虽然我不这么理解但是跟他们解释清楚很难
希望老师能帮我解惑</div>2021-09-17</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJJ6G2xZvNRmhyXBjmGbI5G8icGCCMPupr6yxZ1IcURwp7GTRHcpWGWpg9A0fLlyicmVdDwzqZqwiaOQ/132" width="30px"><span>jy</span> 👍（1） 💬（1）<div>【抛砖引玉】
本文计算有个前提，就是在线用户也走了完整流程，
而实际场景中，
1、在线用户，不一定做了操作，
2、哪怕做了操作，也不一定是一个完整业务流程，可能只做了其中部分操作，比如查询商品。
所以，只计算在线用户的tps这样来获取并发度是不严谨的，而且要这种方式，考虑不同情况，感觉复杂度很高。

所以，我觉得更合理的办法还是统计时间段的在线用户（定时统计在线用户，比如在redis里面的token，根据采样数据在excel做透视图，根据趋势看平均大概是多少&lt;性能实战里面老师说的tps约么是多少的方式&gt;），并发度=无停顿时间tps&#47;在线用户。</div>2021-09-07</li><br/><li><img src="" width="30px"><span>byyy</span> 👍（1） 💬（2）<div>多在线用户的 TPS 计算
1.请求级的 TPS：
(100000(用户)×100(请求数))÷3600(秒)≈2,777.78(TPS)
2.单业务操作级 TPS：
(100000(用户)×7(业务操作)))÷3600(秒)≈194.44(TPS)
3.用户级 TPS：
(100000(用户)×1(用户级)÷3600(秒)≈27.78(TPS)

老师，关于上面这个计算，如果把业务模型加进去考虑，我下面这样的计算过程对不对，如果不对，帮我指点一下。
假设系统架构是jmeter-gateway-系统A-系统B-系统C-系统D，压力从gateway进来后，到系统A，系统A调用系统B通过feign调用，后面调用都一样，不走gateway。
实际上，每个用户不可能都会完成文中的7个业务操作，所以才会出现业务模型中各个业务之间的比例不是1:1的情况。
如果把业务模型考虑进去，我觉得多在线用户的TPS计算应该是这样。
1.请求级的 TPS：
(从系统A,B,C,D的日志中统计出3600秒这个时间窗口内请求的总数量)÷3600(秒)≈请求级别的TPS
2.单业务操作级 TPS：
(从gateway的日志中统计出3600秒这个时间窗口内各个业务操作的总数量)÷3600(秒)≈单业务操作级 TPS
3.用户级 TPS：
首先，从gateway日志中得到3600秒这个时间窗口的业务模型，假设业务模型为：登录20%,查询40%,添加购物20%,订单10%,支付10%，
其次，从业务模型还可以得到100个T（这个T指的是业务操作级别的事务）对应40个T（这个T指的是用户级别的事务），因为我们从第2步(单业务操作级的TPS计算)中已经得到3600秒时间窗口内业务操作的总数量，假设这个数量为a，所以a对应的用户级别的事务就是(40&#47;100)*a，
所以用户级别的TPS应该这样计算：
用户级 TPS≈((40&#47;100)*a)÷3600(秒)

</div>2021-08-27</li><br/><li><img src="" width="30px"><span>byyy</span> 👍（1） 💬（1）<div>老师，我有2个问题，帮我解答下
1.&quot;在线用户数。这个值可以从日志中取到；&quot;
在线用户数的计算原理是怎样的，怎么通过日志来得到在线用户数？
2.&quot;请你注意，在这个逻辑中，我没有把业务模型加进来一起讨论，因为加了业务模型，反而会让问题变得更复杂。&quot;
如果把业务模型加进去的话，是怎么样的逻辑？</div>2021-07-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/df/90/35eb6526.jpg" width="30px"><span>A0桑荫不徙</span> 👍（1） 💬（1）<div>我们可以对应算一下，一个没有停顿的用户（并发用户）相当于多少个有停顿的用户（在线用户）呢？在这个转换的过程中，我们暂时不考虑请求的区别。
这个在线用户数不是统计出来的吗，咋还能计算呢，实在没明白，越想越想不明白，这个计算也没明白</div>2021-06-24</li><br/><li><img src="" width="30px"><span>sierlu</span> 👍（1） 💬（1）<div>老是我不是把压力线程当成用户了，我换一个问法，文中说的是10万用户再一个小时内操作一次业务流程，操作时长250s,通过计算并发用户是2400，并发度是2.4%，那10万个用户再一个小时内有停顿的操作，但是结束又循环操作业务流程（相当于每一个用户一小时应该操作了3600&#47;250=14次），每次业务操作时长250 的并发度又该怎么算呢？在线用户数×无停顿时间的单线程TPS&#47;有停顿时间的单线程TPS，按照老师的算法并发度还是2.4%。所以我感觉这个算法需要有个前提，就是这个一小时内用户应该是有停顿的操作完一次后，又循环去操作，求老师解答疑惑~谢谢老师～</div>2021-06-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/40/13/3e77a4a0.jpg" width="30px"><span>言希</span> 👍（1） 💬（1）<div>首先在线用户数和并发度怎么算的？其实再第一个专栏中已经提出，而这个专栏是从1个用户的视角分析了在线用户数，大概意思是找出用户真实操作场景下的TPS，然后找出并发下的TPS，因为单一用户真实操作场景下用户再一个用户T中只执行了一次；那么反推真实操作场景下的TPS&#47;1个用户下并发下执行的TPS数就是在线用户数；但是真实中肯定不会只有一个用户所以这个计算过程只是参考供大家思考即可；</div>2021-06-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a6/15/0246a2f4.jpg" width="30px"><span>有梦想的tester</span> 👍（0） 💬（1）<div>这里多个两个星号:     我先说明一下，因为我要做的操作是 ** 从用户角度出发的。所以，在这里我搭建了一个有用户界面的系统来做这个示例，这主要是为了给你讲清楚在线用户、并发用户和 TPS 之间的关系。</div>2024-01-19</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKqiavB6eFcicmEfubibTI6IVMdNg9aOZn5K4ELjfKwsN9WCy3AJ4tQdIxGRrBLCUDRaXyp8V8cvOswg/132" width="30px"><span>wchao190</span> 👍（0） 💬（1）<div>计算压力线程的时候，不是应该 2400并发用户数&#47;16.67 = 144个线程吗？</div>2023-05-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d7/a5/6e047fbc.jpg" width="30px"><span>Olivia</span> 👍（0） 💬（1）<div>高老师，重看这一章节又疑惑了，在线用户数应该是有个业务上的目标值，并发度也应该是和业务有关的，比如一个普通的信息发布系统，只有一些一般的查询请求，并发度应该是比较低的，而一个请求比较频繁的游戏系统，并发度应该是比较高的，但是文章中计算并发度的公式，用到了有停顿时的TPS和无停顿时的TPS，其中有停顿的TPS是基于业务确定的，假设两个都是一般信息查询的业务，完成一次查询业务的有停顿TPS假设是一致的，无停顿的TPS实际上是当前两个系统分别有多快的体现，那怎么这个反过来成了倒推并发度的因素呢？</div>2022-10-06</li><br/><li><img src="" width="30px"><span>Geek_e8c95e</span> 👍（0） 💬（2）<div>文章计算10万在线用户，需要167压力线程，而根据专栏1计算逻辑  100000(在线用户)×2.4%(并发度)÷16.67(每个线程tps)=144(压力线程)，到底哪一个是正确的呢</div>2022-10-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/29/27/63/4abc36ad.jpg" width="30px"><span>Yolo甲第</span> 👍（0） 💬（1）<div>1、现在的kibana应该可以采集到高峰期的uv和业务的总请求数，去看单个的用户在通过在线用户数乘的话，应该没有直接去采集总请求数和在线用户准确吧？
2、假定业务模型不变，tps随用户成线性增长，那么在线10w用户，tps=1666，那么我要满足20w用户，是不是tps直接是二倍，保险期间应该更多一点，是不是有个参考倍数？</div>2022-03-10</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIGad4UtSm2JrcqoRooSnHJQyoic3uCW6UjsGdudahgQ1xria0ic9iaSqF2iaEkwJj4C9MH6dRub9hukTg/132" width="30px"><span>Geek_704e0c</span> 👍（0） 💬（2）<div>上面计算出来的并发用户数有什么意义</div>2021-10-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2a/d6/19/dafc61a8.jpg" width="30px"><span>啸龙</span> 👍（0） 💬（1）<div>文中描述 “并发是在单位时间内完成的事务（T）的个数。如果这个事务（T）是用户的操作，那就是并发的用户了。“
这句话是否可理解为不用再关注最大并发用户数，因为最大并发用户数就是用户级别的TPS，那为什么好多性能需求还强调最大并发用户数，是概念的问题？</div>2021-10-13</li><br/><li><img src="" width="30px"><span>嗷呜</span> 👍（0） 💬（1）<div>你好，老师，在一个项目压测中，有两个项目指标：1、tps为10000  2 、6万并发6秒内处理完
第一个：压出的结果是10000tps（已经符合业务需求），使用的是1000 jmeter线程数。但是我用5000线程数的时候，报错数增加10%，这个时候我的系统要不要优化呢。
第二个：这边的业务要求使用10000的并发再次压测，大量报错，要求需要优化。
我的理解6万6秒内就是10000tps，1000 的线程足够符合要求了。现在已经混乱了，需要请教两个问题：
1、如果tps达到了业务需求，这个时候需不需要往上压测，为啥往上压测，往上报错率增加，这个到底要不要修复。
2、您压测的经验中，压测10000 jmeter 线程是经常会遇到的吗？我查了一些网上资料，说是很多性能专家，jmeter 5000的并发数压测都是很少。
3、您写两个专题文档文章我都看了，但是并没有说明白，为啥jmeter 并发数没必要向上设置。jmeter 到底是怎么产生压力的。</div>2021-09-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/83/98/fab9bd2a.jpg" width="30px"><span>Mingyan</span> 👍（0） 💬（1）<div>lr里面有个pacing，例如1s发送一个请求；那么1个vuser 每1s发10个请求，pacing设置0.1s；跟10个vusers 每个vuser发1个请求，pacing设置1s。这样对服务器压力是一样的吗？ 感觉具体某一个时间点一个发的是1个请求和10个vuser同时发的10个请求对服务器压力不一样呀</div>2021-07-15</li><br/><li><img src="" width="30px"><span>sierlu</span> 👍（0） 💬（3）<div>高老师，回头再看这个文章，感觉文章中的并发用户和并发线程有些混淆，“一个没有停顿的用户（并发用户）相当于多少个有停顿的用户（在线用户）呢”，这里的并发用户明明就是一个压力线程呀。后面又算出来并发用户和压力线程数不一样。因为文章中提到的一个小时内10万用户在使用250s完成业务，那并发用户应该指的是多少个用户循环操作多少次就可以在1小时内完成10万用户的调用量才对呀。应该是（3600&#47;250）*并发用户数=10万在线用户数。希望指点下？感谢</div>2021-06-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/40/13/3e77a4a0.jpg" width="30px"><span>言希</span> 👍（0） 💬（1）<div>关于本章算在线用户数的地方，还是有些不太理解；hh，明天再来看看；</div>2021-06-12</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIgJnia6D3YcRFGgW4cObUhYWSBbaPibnH1gtvc7g5Ul9J2c6gXBZNHIY4cMnJaJz28MUAEMhnfmhuw/132" width="30px"><span>mushan79</span> 👍（0） 💬（1）<div>老师，看完这篇有点疑惑
1、我记得在第一个专栏里，在线用户数、并发用户数都是通过日志统计出来，从而得到并发度，是以真实的生产数据为背景的
2、这篇文章里的并发用户数是通过公式推导出来，其中无停顿时间的TPS也是用工具去发请求时统计出来的，这样计算出来的并发用户数应该和真实的存在偏离吧？有点疑惑这样推算是否接近真实情况
希望老师看到能帮忙解答下，谢谢~</div>2021-05-06</li><br/><li><img src="" width="30px"><span>wfw123</span> 👍（0） 💬（3）<div>jmeter工具中的tps 应该属于请求级的tps吧</div>2021-04-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/af/2d/3dd65e6b.jpg" width="30px"><span>xhkk</span> 👍（0） 💬（1）<div>没有停顿和有停顿之间换算的时候
16.67÷0.4，这里的0.4表示什么？怎么来的？</div>2021-04-07</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKHzrvlV4HLmR5IWUiad4sqich3QZXxWRxFicvqxPtRaWITLibic16eibRaJia1FxRjq81Pcs2NsB5Hg1WoQ/132" width="30px"><span>枫林听雪落</span> 👍（0） 💬（0）<div>老师我想请问下，查询并发量大于等于200次&#47;秒，这个需求怎么理解呢？ jmeter工具200个线程在1s内发出，就表示1s内200次并发吗？(同事认为该操作已满足查询并发量等于200次&#47;秒)
 还是说t是查询业务，jmeter测试结果为200 tps才算满足需求？</div>2024-11-06</li><br/>
</ul>