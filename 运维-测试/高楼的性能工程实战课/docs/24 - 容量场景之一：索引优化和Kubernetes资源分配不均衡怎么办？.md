你好，我是高楼。

我们知道，做容量场景的目的是要回答“线上容量最大能达到多少”的问题，这就要求我们在设计和执行容量场景的时候要非常严谨。当然，这也意味着容量场景将是一个艰辛的过程。通过这节课，你就能深切地体会到。

今天，我们重点来解决索引优化和Kubernetes调度不均衡的问题。关于索引优化，你可能会奇怪，基准场景都捊过一遍了，为啥还有要看索引的问题？是呀，确实让人疑惑。从这里就可以看出，容量场景和基准场景真的不太一样，因为这其中有业务相互影响的问题。

而Kubernetes调度不均衡的问题将导致多个Pod运行在了同一个worker上，像这样的问题，我们不在容量场景中是看不到的，希望能对你处理类似问题有一个借鉴。

此外，我们还将一起看看在压力稳定的情况下，响应时间不断攀升该怎么办。这种问题很常见，但是每次出现问题点都不太相同，这次你将看到一个具体的案例。

好，我们开始吧！

## 场景运行数据

### 第一次运行

不得不承认，第一次来到容量场景，还真是心惊胆颤的。

首先，我们小心翼翼地设置起容量场景的比例，也就是我们在[第5讲](https://time.geekbang.org/column/article/357539)中提到的业务比例，再设置好相应的参数和关联。然后，我们把容量场景跑起来，得到了这样的信息：

![](https://static001.geekbang.org/resource/image/76/57/76cd8b3983fdcbee733dbd0a378da457.png?wh=1811%2A841)

顿时就有一种满头包的感觉，有没有？！不过，“见招拆招，遇魔降魔”不就是我们的宗旨吗？既然有错，那咱们就先解决错误吧。
<div><strong>精选留言（2）</strong></div><ul>
<li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJJ6G2xZvNRmhyXBjmGbI5G8icGCCMPupr6yxZ1IcURwp7GTRHcpWGWpg9A0fLlyicmVdDwzqZqwiaOQ/132" width="30px"><span>jy</span> 👍（3） 💬（1）<div>问题：
1、用相同的member_id登录，之前登录获取的token不会失效？为什么会存在一个用户的多个不同token呢？

2、文中：&quot;在查看了全局监控数据之后，数据库的资源如下所示&quot;，这里为什么是数据库的资源？应该就是全局监控的结果吧


3、文中：”我们在前面提到，在拆分响应时间的过程中，发现是 Order 服务消耗的时间多。而 Order 服务又是当前这个场景中最需要资源的应用，那我们就先把 Auth、Portal 之类的服务移走。“移到其它worker？这些是不是物理机资源不足造成的？为什么不能一个服务就在一个worker上？

谢谢老师</div>2021-07-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2a/38/e0/445ffe06.jpg" width="30px"><span>桦</span> 👍（0） 💬（1）<div>1.为什么在压力线程不变的情况下，TPS 曲线下降、响应时间上升是不合理的？
答:因为压力线程不变时,如果出现曲线下降,响应时间上升,说明系统出现了无法及时处理请求的问题,对应会表现在一些服务CPU上升,或者消息堵塞等地方.
2.当资源使用过于集中的时候，如何定位 Pod 相互之间的影响？你有没有和这节课讲的不一样的招？
答:a.将服务分别移出 b.分别针对不同的服务进行压测 c.调整不同服务的cpu(就像之前调整ES的过程一样) 这些都类似与之前单服务压测时,快速排查时,针对某些节点扩容的思想
是不是也能通过查看一些日志来定位呢.但是对服务器这块的基础不太了解,稍后学会了再补上</div>2022-01-14</li><br/>
</ul>