你好，我是高楼。

在上节课中，我们针对生成订单信息这个接口做了三个阶段的分析定位和优化动作，让TPS变得正常了一些。不过，系统资源并没有完全用起来，这个接口显然还有优化的空间。因为高老师说过很多遍，**在性能优化的过程中，我们要把资源都用起来。**

关于“把资源用起来”这一理论，我希望你能明白的是，**我们在性能环境中做优化，把资源用起来是为了看系统的最大容量在哪里。这并不意味着，你可以在生产环境中让硬件使用到这种程度**。

对于一个不可控的系统容量来说，资源使用率高，极有可能导致各种问题出现。所以，安全稳妥起见，很多生产环境的资源利用率都是非常低的，倘若用得超过了20%，运维都得半夜惊出一身冷汗。

而我们在性能环境中的测试结果，要想给生产环境配置一个比较明确并且可以借鉴的结论，就必须先去分析生产的业务容量，然后再来确定当生产业务容量达到峰值的时候，相应的硬件资源用到多少比较合理。

不过，在我们的优化环境中，我们可以通过把一个系统用起来，来判断软件的容量能力。所以，我们接着上节课的内容，再进入到第四阶段。你将看到在业务逻辑复杂的情况下，我们该怎么做优化。

闲言少叙，直接开整。

## 第四阶段

在解决了前面三个不正经的问题之后，我们现在可以正常分析时间消耗到哪去了，只要解决了快慢的问题，我们才能进而解决资源没有用起来的问题。所以，我们先来拆分响应时间，同样，我们也不做全局监控分析，因为…哥嫌累。
<div><strong>精选留言（6）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/7f/6c/18bf99bf.jpg" width="30px"><span>徐峥</span> 👍（0） 💬（1）<div>高老师，您好。在您看来扩容除了需要前期的优化之外，还需要遵循哪些原则？</div>2022-06-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/d4/c3/d41e8c79.jpg" width="30px"><span>不将就</span> 👍（0） 💬（1）<div>老师，您在第五步写的最后的大招是扩容，但是当前的资源没用上呢，为什么要扩容呢？没理解这里</div>2021-10-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/db/67/24d4bce6.jpg" width="30px"><span>Alisa</span> 👍（0） 💬（1）<div>老师，我的思路是这样：
1.使用jmap可以查看消耗内存占比，对消耗内存占比较大的方法进行分析。
   比如数据库查询结果太大，存入内存会消耗大量内存；或者循环调用；
2.TPS上不去，资源也用不上的时候，分析响应时间。找出响应时间长的节点，时间消耗在哪里，在干什么从而根据情况继续分析</div>2021-06-07</li><br/><li><img src="" width="30px"><span>Geek_xbye50</span> 👍（0） 💬（2）<div>高老师问下时序图的插件是啥？</div>2021-05-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/3b/01/7a0bfa9a.jpg" width="30px"><span>alley</span> 👍（0） 💬（1）<div>我们性能测试，资源使用率不超过80%都算正常，这样是不是大有危险。</div>2021-05-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/dd/0f/ee37a7fe.jpg" width="30px"><span>zuozewei</span> 👍（2） 💬（0）<div>日志响应时间配置可以参考本文：https:&#47;&#47;mp.weixin.qq.com&#47;s&#47;JeKdirFrM5LGAqZrrdKoXA</div>2021-05-08</li><br/>
</ul>