你好，我是倪朋飞。

在上一讲中，我带你详细梳理了 eBPF 开发环境的配置方法，特别是 eBPF 相关开发软件包的安装和升级方法，以及内核的配置和编译方法。熟悉了 eBPF 的开发环境和内核编译之后，在留言区和微信群中我还看到很多同学依然在使用较旧版本的内核。而为了学习 eBPF，很多同学已经配置了一个非常新的内核版本作为开发环境，但却发现在新内核中开发的 eBPF 程序有时却没法直接在旧版本的内核中运行。

今天，我就带你一起来看看如何让 eBPF 程序兼容新旧版本的内核，以便在新版本内核中使用诸如 CO-RE 等新特性的同时，还可以在旧版本内核中正常运行。

## 为什么需要考虑 eBPF 程序的内核兼容性？

在开始正式的内容之前，我想你肯定有一个问题，那就是什么时候需要考虑新旧内核版本的兼容性，以及为什么会出现新旧内核版本兼容性的问题。

在理想情况下，开发测试环境和生产环境应该都是一致的，包括使用相同的内核版本。如果你已经满足了这个条件，那么自然也就不需要考虑内核兼容的问题。但注意这只是理想情况，实际情况下内核版本不一致的问题是不可避免的，比如：

- 为了获取更好的稳定性和社区支持，内核版本（甚至是 Linux 发行版版本）需要持续跟随上游社区进行升级；
- 为了采纳新技术，新的产品架构可能一开始就会采纳较新的内核，而使用旧内核的遗留系统还需要很长时间的迭代过程；
- 为了获得更广的用户，很多商业或开源项目不仅要支持最新的内核版本，还需要兼容各种各样的用户环境，而这些用户所使用的内核版本也是千差万别的。
<div><strong>精选留言（7）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/18/b7/24/17f6c240.jpg" width="30px"><span>janey</span> 👍（0） 💬（1）<div>这里的一次编译，跟JIT即时编译是一个意思吗？如果不是，那有什么区别？</div>2022-12-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/17/18/e4382a8e.jpg" width="30px"><span>有识之士</span> 👍（3） 💬（0）<div>微信群在哪里？</div>2022-07-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/64/19/156e7dee.jpg" width="30px"><span>鴻🍋</span> 👍（0） 💬（0）<div>”第一种，采用条件编译的方式，根据是否支持 CO-RE，生成两个不同的 eBPF 字节码文件。而到程序运行时，再根据内核是否支持 CO-RE 选择对应的字节码文件加载运行。“ 这个是如何实现</div>2024-10-10</li><br/><li><img src="" width="30px"><span>Geek_5ada4a</span> 👍（0） 💬（2）<div>第二，通过对 BPF 代码中的访问偏移量进行重写，解决了不同内核版本中数据结构偏移量不同的问题。第三，在 libbpf 中预定义不同内核版本中数据结构的修改，解决了不同内核中数据结构不兼容的问题。

老师，我不太理解第二点和第三点的区别。
“预定义不同内核版本中数据结构的修改”，就是为了实现对“访问偏移量进行重写”吧？这两点落到实处，应该就是一点？
ps vmlinux 已经提供了内核数据结构，为什么libbpf中还要“预定义不同内核版本中数据结构的修改”？</div>2022-11-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/0c/30/d4737cd5.jpg" width="30px"><span>lyonger</span> 👍（0） 💬（0）<div>总结下来，好像对于4.9的内核支持，还是不是特别友好，线上要使用还是很麻烦。</div>2022-08-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/24/97/be102fb1.jpg" width="30px"><span>James</span> 👍（0） 💬（0）<div>Ubuntu 20.04，内核5.4.0，但是CONFIG_DEBUG_INFO_BTF没打开，怎么打开呢？</div>2022-08-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/13/bd/3e86e791.jpg" width="30px"><span>十七</span> 👍（0） 💬（0）<div>兼容性让人头疼</div>2022-07-27</li><br/>
</ul>