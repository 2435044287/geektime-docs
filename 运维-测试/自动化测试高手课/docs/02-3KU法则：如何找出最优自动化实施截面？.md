你好，我是柳胜。

上一讲我们提出了自动化测试ROI模型，在回归测试中的应用。回归测试是一个笼统的概念，单元测试、接口测试以及UI测试里都有回归测试，甚至性能测试也已经成为回归测试的一部分。

今天我们要关注一个具体场景，给你一个软件系统，作为自动化测试人员，你怎么找出测试截面，制定自动化测试方案？这些事可能你都做过，觉得并不稀奇，但既然我们已经学习了ROI思维，今天要再加上一个小目标，**制定策略，能够让这个自动化测试设计获得尽可能大的ROI**。换句话说，能干还不够，还要干得好，既要马儿跑，又要马儿少吃草。

有挑战不？那就跟我进入这一讲的学习，一起找到最佳策略吧。

## 测试ROI金字塔

在测试设计领域，经常提到的方法是分层。具体就是给定一个系统，结构上划分三个层级，单元在最小圈；服务包含多个单元，在中圈；而系统又包含多个服务，是外部的最大圈。结构图如下：

![图片](https://static001.geekbang.org/resource/image/77/c3/7713a7081ac2723a2cfc35d3277b21c3.jpg?wh=1920x1050 "软件结构圈图")

相应地，我们的测试结构是在代码层做单元测试，服务层做接口测试，系统层做UI功能测试。

在实践中，这三种测试该怎么组合安排呢？迈克·科恩在2009年他的新书《敏捷成功之道》中首次提出了测试金字塔模型。单元测试自动化在金字塔底部，接口测试自动化在中部，而UI测试自动化在金字塔顶部。
<div><strong>精选留言（22）</strong></div><ul>
<li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLw3jpao45frZibQIAicWBfc7ofgrm5gJLiaFQSj5u2DDvkjy3ia5goicJLJlgVtZ0HryiaXb2VqpTSQT5Q/132" width="30px"><span>lisa</span> 👍（17） 💬（1）<div>微服务本身基于RPC调用，服务拆分的力度比较小，所有从ROI的模型来讲，微服务的代码每次commit以及merge&#47;pull request会进行API测试，这样API测试的运行次数n会加大，分子变大。而相对于单元测试来讲，API测试的建设成本d和维护成本m相对于单元测试会变小很多，导致分母变小。所以在微服务架构下，投资API测试的ROI明显更高，所以就会出现棱形更由于金字塔的情况出现。

但是说实话，我觉得说到底还是模块拆分力度变小带来的变化，拆分的越小，单元测试和API测试的界限就会变得模糊。实际上API测试的运行的成本还是比较高的，他需要初始化数据以及初始化泳道环境，并且稳定性远远低于单元测试，带来的维护成本其实还挺高的。所以我个人还是比较赞成金字塔模型，即便是在微服务的架构下。</div>2022-03-26</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLw3jpao45frZibQIAicWBfc7ofgrm5gJLiaFQSj5u2DDvkjy3ia5goicJLJlgVtZ0HryiaXb2VqpTSQT5Q/132" width="30px"><span>lisa</span> 👍（7） 💬（2）<div>最近重新思考了一下这个问题，其实我们没有必要去选择是采用金字塔模型还是菱形，而是更多的是基于测试需求去进行ROI分析，放在哪一层ROI最高就选择在哪一层（可能不同的产品形态会不一样）,不用太关注最后会形成什么模型。考虑到目前越往底层的运行成本最低，运行次数最多且最稳定，也就是D和M的时间比较少，大量的测试点会下沉，但是我们同时也要考虑到自动化测试是面向风险，而不是面向代码覆盖率。所以基于风险来看，哪些测试点应该要被设计也存在一个设计评估的过程。最后测试基础设施的完善性以及团队的实际情况也是其中一个重要的考虑因素。总之，最终是一个什么模型是测试点落地的结果，而不是前期的决策依据。</div>2022-05-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/2a/bf/14c3ac8a.jpg" width="30px"><span>D_w</span> 👍（6） 💬（1）<div>一点浅见：
问题1：在微服务架构下，测试层级会扩充，新增契约测试，组件测试，端到端的测试等等，并且在实际测试任务中一般开发负责的单元测试占比不高，最终成纺锤形。
问题2：如果团队成员能力都比较强，我偏向全栈，如果能力不均衡还是得考虑精细分工。我觉得全栈的测试效果能更好</div>2022-03-23</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLw3jpao45frZibQIAicWBfc7ofgrm5gJLiaFQSj5u2DDvkjy3ia5goicJLJlgVtZ0HryiaXb2VqpTSQT5Q/132" width="30px"><span>lisa</span> 👍（5） 💬（2）<div>我希望是最重视全栈的模式，因为对技术的理解成本远远小于对业务的理解成本，也就是一个人把它培训成全栈可能花上一个月就行，但是让这个人充分理解业务以及业务的架构是一件比较长期的事情</div>2022-03-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/d8/8b/d81769bf.jpg" width="30px"><span>chin</span> 👍（5） 💬（1）<div>我们很多人都喜欢引用金字塔模型，但是似乎没有多少人认真思考过金字塔的模型是怎么来的，有无理论依据。这点得向老师学习，拒绝拿来主义</div>2022-03-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/ee/6d/1e715544.jpg" width="30px"><span>萧瑟</span> 👍（2） 💬（1）<div>我是这么理解的：在微服务架构的系统中，一个请求进入系统，可能会经过多个服务获取数据，最后整合输出。也就是说一个 UI 测试 会对应多个接口测试，而一个接口测试可能会对应多个不同服务之间的接口调用，单元测试更注重的是单个服务的逻辑、算法。因此接口测试因为运行次数 N 而变得比单元测试的 ROI 更高，测试金字塔也就变成了中间凸出两头小的棒槌形状。</div>2022-05-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/c2/c6/88d0c7b2.jpg" width="30px"><span>一默</span> 👍（1） 💬（1）<div>老师请教一下，单元测试无法手动测试，但是因为单元测试应该会到方法级别，所以是不是应该测试用例数也会最多，开发时间和维护时间应该也是比较多的吧。相应的ROI成本也会变低吧。
谢谢老师指教。
</div>2022-05-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/44/a4/7a45d979.jpg" width="30px"><span>IT蜗壳-Tango</span> 👍（1） 💬（1）<div>思考题：
我选择全栈，因为对于特定模块来说，我可以从单元测试，API，UI三个层面去验证这个模块的性能以及可用性。
问题：
目前的自动化测试感觉很少会接触到单元测试层面，尤其是黑合测试的场景。是不是主要将UI, API的ROI考虑的全面一些就可以了啊。</div>2022-03-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/20/a3/8c/23b2464c.jpg" width="30px"><span>随片</span> 👍（0） 💬（1）<div>answer：
1、微服务时代，每个系统都是单独的应用，整体性相对是减弱的，独立性提高后，也许该应用在UI层是不体现测试点的。所以金字塔是不符合微服务时代的。
2、要考虑团队规模和项目复杂程度。规模小，那么一人单挑吧，反之，多人负责。项目负责程度与规模类似。一人：优势--编程、维护代码，个人思路更清晰；劣势--时间成本，交接成本，代码模块粘性。多人：时间短，分工明确；劣势--人工成本，测试功能点重叠？</div>2022-06-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/28/20/f60dc417.jpg" width="30px"><span>志杰</span> 👍（0） 💬（1）<div>我目前所参与的微服务，偏向于接口方面，从ROI的模型来讲，接口运行的次数会增加，相对于开发而言，成本会变得小很多；目前项目中没有单元测试，投资接口测试的ROI明显会变高，纺锤型更贴近目前的测试方向。微服务框架下的接口测试，我个人感觉：基于数据，性能，可靠性的要求更贴近目前一个主流趋势。把握当下主流，并剖析测试未来方向，眼界还是不能缺少，学以致用为主，老师所讲的内容让我少走了一些弯路，再此十分感谢；最后，做好一件事情，精力是有限的，对一个事物的理解和打磨需要持续化的时间。</div>2022-05-26</li><br/><li><img src="" width="30px"><span>Geek_d00d65</span> 👍（0） 💬（1）<div>是选择全栈还是精细分工，我觉得要依赖于团队成员的能力，如果团队成员一个模块的所有层面测试，效率和时间都比精细分工要好，那我会选择全栈，反之，则会选择精细分工</div>2022-04-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/63/0e/2885d9bd.jpg" width="30px"><span>大饼夹一切啊</span> 👍（0） 💬（1）<div>1. 由于微服务是按照轻量级的API进行通信的，应在保持UI测试占比不变的情况下，提升接口测试占比，减少单元测试占比，虽然微服务架构降低了单体架构的复杂度，同时也提升了多个服务的维护成本，若将重点放在单元测试，则会大幅增加开发成本、维护成本。

2. 首先表达观点，个人更倾向于精细分工。
优势：（1）对人员技术栈要求相对于全栈低，降低学习成本。 （2）专人专责，避免了个个模块负责人之间的“甩锅”现象。
劣势：（1）由于单人负责所有模块一个层面测试，需要及时对测试代码进行review，并且初期要做好相关的书写规范。（2）单人负责所有模块单层的测试，增加了项目风险，若相关负责人离职，则会对项目交付产生影响。
当然，如果产品、项目生命周期够长的情况下，还是需要进行人员的功能轮换，取长补短，提升测试团队整体能力，以保证产品质量。</div>2022-04-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/84/2c/1b0926b4.jpg" width="30px"><span>Even</span> 👍（0） 💬（1）<div>测试测试金字塔，每一层做自己最擅长的事情，roi综合起来才会最高</div>2022-03-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4d/e4/94b543c3.jpg" width="30px"><span>swordman</span> 👍（0） 💬（2）<div>说说我这几年的项目经历：
1. Android移动端：全部使用ROI最高的UI自动化测试，开发和维护成本较高，虽然和CI流水线进行了集成，但由于测试用例数量的缺乏，及稳定性不足，并未达到预期的结果；
2. 微信小程序：由于业务的实时性需求，小程序前端承担了大部分的业务和算法处理。因此采用ROI最高的单元测试 + 基本场景的手工UI测试，再加上和代码提交流水线结合，取得了很好的效果；
3. C++多组件项目：正准备着手进行的项目。由于涉及多组件协同工作，拟采用接口测试 + 基本功能UI自动化测试。正愁着如何验证测试策略的正确性呢，老师的课程就来了，给了我一个清晰的指导思路，谢谢！</div>2022-03-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/b4/94/2796de72.jpg" width="30px"><span>追风筝的人</span> 👍（0） 💬（1）<div>UI 测试关注功能场景测试，易用性测试和可执行性测试；而接口测试关注不同数据的循环，接口的性能和错误恢复能力；单元测试关注算法的正确性和性能。</div>2022-03-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/d8/8b/d81769bf.jpg" width="30px"><span>chin</span> 👍（0） 💬（2）<div>问题2，我仍偏向于精细分工，一人负责所有会出现效率问题，同时个人有其局限性</div>2022-03-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/65/9f/217346ce.jpg" width="30px"><span>清风明月</span> 👍（0） 💬（2）<div>1，我所经历的几个项目，在微服务架构，主要还是接口自动化测试，基本上不做UI自动化测试了（只做少量的app自动化测试），单元测试基本上形同虚设，主要还是做大量的接口测试！
2，全栈的测试人员很难招到，而且现在微服务测试人员最好是熟悉所有模块，只测试局部模块意义不大，之前带团队的时候，手下有10多人，基本上大家都负责有自己的项目，所以必须熟悉整个项目，必须会做接口自动化测试！所以我还是比较倾向于：一个人负责一个模块的所有层面测试。</div>2022-03-23</li><br/><li><img src="" width="30px"><span>Geek_43013d</span> 👍（0） 💬（0）<div>UI 自动化测试在用户验收测试，回归频率低
为什么UI自动化测试只在用户验收阶段执行呢？，既然是自动化，是不是可以天天执行呢？</div>2024-02-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg" width="30px"><span>ifelse</span> 👍（0） 💬（0）<div>学习打卡</div>2024-02-07</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKubuofHB43wdIwvnWSIdL6YzfGZhic7abWu06ia8BwnMBDCbCFDIF1RQB4nN46Ldv6ALQf025E2mRA/132" width="30px"><span>Geek_palmlan</span> 👍（0） 💬（0）<div>UI 测试关注功能场景测试，易用性测试和可执行性测试；——这里可执行性是不是笔误？可支持性？</div>2023-09-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/c1/9d/d75736be.jpg" width="30px"><span>王小卡</span> 👍（0） 💬（0）<div>老师请问可支持性是什么意思？</div>2023-06-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/b4/94/2796de72.jpg" width="30px"><span>追风筝的人</span> 👍（0） 💬（0）<div>2. 精细分工</div>2022-03-23</li><br/>
</ul>