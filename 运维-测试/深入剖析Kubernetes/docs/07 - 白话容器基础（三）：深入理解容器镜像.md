你好，我是张磊。我在今天这篇文章的最后，放置了一张Kubernetes的技能图谱，希望对你有帮助。

在前两次的分享中，我讲解了Linux容器最基础的两种技术：Namespace和Cgroups。希望此时，你已经彻底理解了“容器的本质是一种特殊的进程”这个最重要的概念。

而正如我前面所说的，Namespace的作用是“隔离”，它让应用进程只能看到该Namespace内的“世界”；而Cgroups的作用是“限制”，它给这个“世界”围上了一圈看不见的墙。这么一折腾，进程就真的被“装”在了一个与世隔绝的房间里，而这些房间就是PaaS项目赖以生存的应用“沙盒”。

可是，还有一个问题不知道你有没有仔细思考过：这个房间四周虽然有了墙，但是如果容器进程低头一看地面，又是怎样一副景象呢？

换句话说，**容器里的进程看到的文件系统又是什么样子的呢？**

可能你立刻就能想到，这一定是一个关于Mount Namespace的问题：容器里的应用进程，理应看到一份完全独立的文件系统。这样，它就可以在自己的容器目录（比如/tmp）下进行操作，而完全不会受宿主机以及其他容器的影响。

那么，真实情况是这样吗？

“左耳朵耗子”叔在多年前写的一篇[关于Docker基础知识的博客](https://coolshell.cn/articles/17010.html)里，曾经介绍过一段小程序。这段小程序的作用是，在创建子进程时开启指定的Namespace。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg" width="30px"><span>张磊 Kubernetes</span> 👍（238） 💬（5）<div>有读者反映，咱们重新挂载&#47;tmp目录的实验执行完成后，在宿主机上居然可以看到这个挂载信息。。这是怎么回事呢？实际上，大家自己装的虚拟机，或者云上的虚拟机的根目录，很多都是以share方式的挂载的。这时候，你在容器里做mount也会继承share方式。这样就会把容器内挂载传播到宿主机上。解决这个问题，你可以在重新挂载&#47;tmp之前，在容器内先执行一句：mount(“”, “&#47;“, NULL, MS_PRIVATE, “”) 这样，容器内的根目录就是private挂载的了。</div>2018-09-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ff/ce/73ee54bf.jpg" width="30px"><span>Linux云计算网络</span> 👍（553） 💬（8）<div>1. 上面的读写层通常也称为容器层，下面的只读层称为镜像层，所有的增删查改操作都只会作用在容器层，相同的文件上层会覆盖掉下层。知道这一点，就不难理解镜像文件的修改，比如修改一个文件的时候，首先会从上到下查找有没有这个文件，找到，就复制到容器层中，修改，修改的结果就会作用到下层的文件，这种方式也被称为copy-on-write。

2. 查了一下，包括但不限于以下这几种：aufs, device mapper, btrfs, overlayfs, vfs, zfs。aufs是ubuntu 常用的，device mapper 是 centos，btrfs 是 SUSE，overlayfs ubuntu 和 centos 都会使用，现在最新的 docker 版本中默认两个系统都是使用的 overlayfs，vfs 和 zfs 常用在 solaris 系统。

欢迎补充和指正。</div>2018-09-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/66/c4/038f9325.jpg" width="30px"><span>Jeff.W</span> 👍（379） 💬（15）<div>继Namespace构建了四周的围墙（进程隔离），Cgroups构建了受控的天空优先使用阳光雨露（资源限制），Mount namespace与rootfs构建了脚下的大地，这片土地是你熟悉和喜欢的，不管你走到哪里，都可以带着它，就好像你从未离开过家乡，没有丝毫的陌生感（容器的一致性）～</div>2018-09-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ed/1a/269eb3d6.jpg" width="30px"><span>cfanbo</span> 👍（125） 💬（10）<div>目录联合挂载时，如果A和B目录里的x文件内容不一样，这时如何处理？</div>2018-09-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d4/c2/910d231e.jpg" width="30px"><span>oddrock</span> 👍（110） 💬（5）<div>请问老师，听了您今天的课，认识到容器使用的内核是和宿主机内核一致的，但如果容器需要不同的内核怎么办？</div>2018-09-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cc/c4/5ac16f31.jpg" width="30px"><span>汤尼房</span> 👍（95） 💬（8）<div>老师你好，很好奇dockerhub上关于系统镜像的制作过程，比如对于centos7.4的镜像，首先能想到的是应该依据centos官方发布的centos7.4的系统镜像，然后将此镜像中的内核给去掉，仅保留剩下的文件、配置和目录或者是保留必要的文件、配置和目录；但通过查看centos7.4的Dockerfile之后发现其依赖的base image是scratch，然后在scratch的基础上添加centos-7.4.1708-docker.tar.xz，后来查看ubuntu镜像发现其base image也是scratch，老师能简单说下scratch基础镜像吗（镜像文件的制作过程等），猜想scratch应该是包含了多个系统之间共同的东西，否则为啥多个版本的系统镜像以及不同版本的系统镜像的基础镜像都用的是scratch，所以对scratch基础镜像很好奇，望老师指点一下</div>2018-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/3a/e1/b6b311cb.jpg" width="30px"><span>╯梦深处゛</span> 👍（83） 💬（2）<div>喜欢这种从出现到发展、由浅入深、由一小段代码讲述某种实现的讲述，既容易理解，也深入了解了原理。娓娓道来，很有条理，就像身临当时docker的实现场景！</div>2018-09-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/98/37/7f575aec.jpg" width="30px"><span>vx:jiancheng_goon</span> 👍（57） 💬（6）<div>女朋友1 3 5追电视剧，我1 3 5追k8s。</div>2018-09-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/bb/f6/af833125.jpg" width="30px"><span>Vinsec</span> 👍（43） 💬（13）<div>docker run -ti ubuntu &#47;bin&#47;bash
此时会有一个隐式的chroot过程
请问这个chroot的过程是将&#47;bin&#47;bash进程的Home目录切换成了&#47;var&#47;lib&#47;docker&#47;aufs&#47;mnt&#47;[id]了么？

</div>2018-10-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7a/0a/0ce5c232.jpg" width="30px"><span>吕</span> 👍（35） 💬（5）<div>请教一个低级的问题，我现在用docker部署，在多次部署以后，会导致磁盘占用空间急剧的增大，老是需要扩容，虽然对不使用的镜像定时做了删除，但还是会出现这样的问题，产生的文件也不敢在生产环境随便进行删除，只能清理镜像和容器。
</div>2018-09-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/42/61/78d5d09a.jpg" width="30px"><span>long904</span> 👍（34） 💬（5）<div>请教老师，以我理解容器镜像依赖宿主机内核。那么如果镜像是基于Linux的系统制作而成（线上运行环境就是Linux），那么如果在Windows系统上它是不能运行这个镜像了，对吗？甚至目标机器如果内核跟镜像制作不同（比如centos5和centos7）如果是，请问该怎么理解容器跨平台部署一说？谢谢。</div>2018-09-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/7d/69/21b4b5cb.jpg" width="30px"><span>王由华</span> 👍（20） 💬（1）<div>被whiteout遮挡的文件会被清除吗？用什么命令清除的？否则镜像不是就膨胀了。</div>2018-09-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/fd/d6/71e1cc29.jpg" width="30px"><span>Kaer</span> 👍（20） 💬（1）<div>老师你好，如果依赖了内核运行的应用，必须得重新在跟宿主机相同内核下重新打包镜像才行吗？有没有完美解决方案：比如在镜像打包的时候，打一个兼容内核的补丁。</div>2018-09-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/63/5d/b523af2d.jpg" width="30px"><span>Hunsbiously</span> 👍（16） 💬（7）<div>你好，这个视频是我看到的一个很好的视频，希望老师能够找机会，详细分析下.
https:&#47;&#47;m.youtube.com&#47;watch?v=90kZRyPcRZw#fauxfullscreen</div>2018-09-09</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKtS26SJpSF7JLu9pusGsy1Qln0NdQg1eV2YKOJxpX2QXaBuuyXMqZY3fm0rhzKwsqN5aa6CVNOQQ/132" width="30px"><span>陈华</span> 👍（13） 💬（1）<div>老师说没有内核所以rootfs会比较小，请问一般安装的linux系统内核文件在哪里存放呢？，</div>2018-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d2/79/0a432fde.jpg" width="30px"><span>凯文1985</span> 👍（12） 💬（3）<div>如果对docker原始镜像进行修改 比如在ubuntu镜像上安装Java 那么增加的层是在最下面的只读层上吗
</div>2018-10-07</li><br/><li><img src="" width="30px"><span>shupian418</span> 👍（11） 💬（7）<div>ns.c 启动失败 
Parent - start a container
Parent - container stopped
</div>2018-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/e9/91/4219d305.jpg" width="30px"><span>初学者</span> 👍（11） 💬（2）<div>对镜像中的init层不是很理解，这一层中的文件的修改到底由谁以及什么时候触发的，如果是在容器启动阶段，修改的结果不是应该放到容器读写层吗？</div>2018-09-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/99/ed/ba309aad.jpg" width="30px"><span>droid</span> 👍（11） 💬（1）<div>代码中的&quot;container_stack+STACK_SIZE&quot;一开始没看明白，后来发现是栈，要传栈底指针。大家见笑。</div>2018-09-07</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIKkIlG1QR7odsuy5Qzu4pf7ptHPsthtFTyjMygzWibVLDLSjehJkXLFh2ZSamYsibwWLHLbv2dI64A/132" width="30px"><span>Geek_dbdb0d</span> 👍（10） 💬（3）<div>你好，既然镜像只包含了一个操作系统的文件和目录，同一个镜像怎么保证在不同内核的宿主机中都能正确的工作？</div>2018-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/6c/47/8da914be.jpg" width="30px"><span>Geek_1264yp</span> 👍（9） 💬（1）<div>老师好，请问，如果我在ubuntu:16.04的基础镜像上加了自己的东西，然后build新的镜像，这时候其他人用我这个新镜像的时候，是不是只读层就包含了我添加的东东？</div>2018-10-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0f/70/cdef7a3d.jpg" width="30px"><span>Joe Black</span> 👍（9） 💬（1）<div>请问所谓的“应用依赖内核”是指程序直接进行内核调用，而不是仅仅使用c运行库，可以这样理解吗？</div>2018-09-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/dd/11/04ebee55.jpg" width="30px"><span>lizhaochao</span> 👍（8） 💬（1）<div>应用程序的代码 是打包到镜像里的 还是挂载到docker里的 持续集成是打包镜像 还是cp文件到目录 持续发布涉及打包镜像吗</div>2019-05-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f1/c6/6f39a982.jpg" width="30px"><span>Yuhui</span> 👍（8） 💬（1）<div>请教一下老师，aufs等支持联合挂载的文件系统对层数有限制吗？谢谢！</div>2018-12-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ae/e0/3e636955.jpg" width="30px"><span>李博越</span> 👍（8） 💬（3）<div>既然容器里的rootfs 只是一个操作系统所包含的文件、配置和目录，那为啥我在dockerfile中配置keepalive参数‘&#47;proc&#47;sys&#47;net&#47;ipv4&#47;tcp_keepalive_time’不生效呢？为啥在容器宿主机上配置才生效？
查询了下官方文档，是因为这个配置是kernel层面的所以必须修改宿主机吗？但是这个配置是在&#47;proc下的呀？
参考文档：http:&#47;&#47;tldp.org&#47;HOWTO&#47;TCP-Keepalive-HOWTO&#47;usingkeepalive.html</div>2018-10-04</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/pftx8PrTibZqu39dxkicUdrXbaMe6v4rcoTzOoF9Z04OibIIDgbpRIrDS9lYBYc97QAscGp77vU6nN5uxRiceRER3Q/132" width="30px"><span>Leon廖</span> 👍（7） 💬（1）<div>image展开后是一系列目录，但push&#47;pull在网络上传送的image是tar格式的？
就好像Java的jar其实是zip格式的</div>2018-09-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6c/24/f2dfbbec.jpg" width="30px"><span>liuy1226</span> 👍（7） 💬（2）<div>老师您好，我们知道docker镜像采用了镜像共享技术减少了镜像存储空间的大小，现在的问题是docker镜像这种实现的数据结构模型是什么，比如多个镜像共享了一个基础镜像。</div>2018-09-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/47/08/985632a6.jpg" width="30px"><span>旭</span> 👍（5） 💬（2）<div>老师，问题是这样的，只要我这个镜像没有运行的容器，这个镜像过段时间就会自动被删掉，我用docker images 看不到那个镜像了 。磁盘还有100多G，已占用96%。老师怎么继续再评论再评论</div>2018-10-19</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eppE3Zu7Gspiar34LSAg5R3qGukw9qJnmGU54FokyUGmwCtEcUnrwEIYXDPrhAJMvtjZvgaYjC3bNA/132" width="30px"><span>大麦08</span> 👍（5） 💬（2）<div>请问老师，在centos里aufs存放在哪里啊</div>2018-09-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/61/61/677e8f92.jpg" width="30px"><span>xianhai</span> 👍（5） 💬（1）<div>docker占用的port和宿主机的port互不干扰，docker是怎么实现port space独立的？</div>2018-09-07</li><br/>
</ul>