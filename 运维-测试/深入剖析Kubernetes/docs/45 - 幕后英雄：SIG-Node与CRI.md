你好，我是张磊。今天我和你分享的主题是：幕后英雄之SIG-Node与CRI。

在前面的文章中，我为你详细讲解了关于 Kubernetes 调度和资源管理相关的内容。实际上，在调度这一步完成后，Kubernetes 就需要负责将这个调度成功的 Pod，在宿主机上创建出来，并把它所定义的各个容器启动起来。这些，都是 kubelet 这个核心组件的主要功能。

在接下来三篇文章中，我就深入到 kubelet 里面，为你详细剖析一下 Kubernetes 对容器运行时的管理能力。

在 Kubernetes 社区里，与 kubelet 以及容器运行时管理相关的内容，都属于 SIG-Node 的范畴。如果你经常参与社区的话，你可能会觉得，相比于其他每天都热闹非凡的 SIG小组，SIG-Node 是 Kubernetes 里相对沉寂也不太发声的一个小组，小组里的成员也很少在外面公开宣讲。

不过，正如我前面所介绍的，SIG-Node以及 kubelet，其实是 Kubernetes整套体系里非常核心的一个部分。 毕竟，它们才是 Kubernetes 这样一个容器编排与管理系统，跟容器打交道的主要“场所”。

而 kubelet 这个组件本身，也是 Kubernetes 里面第二个不可被替代的组件（第一个不可被替代的组件当然是 kube-apiserver）。也就是说，**无论如何，我都不太建议你对 kubelet 的代码进行大量的改动。保持 kubelet 跟上游基本一致的重要性，就跟保持 kube-apiserver 跟上游一致是一个道理。**
<div><strong>精选留言（25）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/ac/c8/4b1c0d40.jpg" width="30px"><span>勤劳的小胖子-libo</span> 👍（9） 💬（1）<div>&quot;当 Kubernetes 通过编排能力创建了一个 Pod 之后，调 度器会为这个Pod选择一个具体的节点来运行。这时候，kubelet会。。。。创建一个Pod&quot;
请教，这个kubelet以及随后的CRI grpc-&gt;dockershim&#47;CRIshim 是在具体的node上面运行的吗？还是通过master来远程调用的？
另外，为什么与dockershim并列的叫remote(no-op)，难道都是不在同一个node的远程创建？</div>2018-12-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/81/1e/d266733a.jpg" width="30px"><span>wutz</span> 👍（4） 💬（2）<div>kubernetes 1.13 最近刚发布，kubeadm 也 GA 了，为何其 HA 支持被移除了？</div>2018-12-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f8/ba/d28174a9.jpg" width="30px"><span>Geek_zbvt62</span> 👍（93） 💬（13）<div>整整2年前的内容了，这两天最大的新闻就是k8s将弃用docker，移除dockershim，所以特意跑来留言</div>2020-12-05</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/ibYCL2nbctJDpBLwZXlKIX7Z4XUicBm1ibIbLd0dWMYibxtshnEzOWAl5LC7JgMcjSet5B30s2HUpiabhYyyFWiaWd1Q/132" width="30px"><span>hjydxy</span> 👍（15） 💬（2）<div>请教老师一个问题，现在有一个linux的k8s集群，一个windows的k8s集群，可不可以把这两个集群统一组建成一个新的联邦集群，统一调度？</div>2018-12-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/e1/91/195f6f4c.jpg" width="30px"><span>Slide</span> 👍（12） 💬（1）<div>这专栏从19年年底开始看，回头来回看完了好几遍，每一次都有新的理解。。</div>2022-03-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/57/c4/8a799b4e.jpg" width="30px"><span>zhenLEE@Saddam</span> 👍（8） 💬（2）<div>dockershim由docker开源维护了，现在看来，有必要看看contained了 </div>2020-12-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/73/90/9118f46d.jpg" width="30px"><span>chenhz</span> 👍（4） 💬（0）<div>使用 ansible-playbook 部署到 Node 。</div>2020-02-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/3f/0d/1e8dbb2c.jpg" width="30px"><span>怀揣梦想的学渣</span> 👍（3） 💬（1）<div>正如作者讲的，Dockershim确实要删除。今天在官方文档看到“Dockershim removed from Kubernetes
As of Kubernetes 1.24, Dockershim is no longer included in Kubernetes. ”</div>2022-05-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/37/3b/495e2ce6.jpg" width="30px"><span>陈斯佳</span> 👍（3） 💬（0）<div>第四十三课:幕后英雄:SIG-Node和CRI
kube-apiserver和kubelet是k8s中最核心的两个组建。其中kubelet是属于SIG-Node的范畴。

kubelet的工作核心是一个叫做SyncLoop的控制循环。驱动这个控制循环运行的事件包括四种:
1. Pod更新事件
2. Pod生命周期变化
3. kubelet本身设置的执行周期
4. 定时的清理事件

kubelet启动时要做的第一件事就是设置Listers，注册它所关心的的Informer.这些Informer就是SyncLoop需要处理的数据的来源。kubelet还负责很多子控制循环，比如Volume Manager, Image Manager, Node status Manager.kubelet还会通过Watch机制来监听关心的Pod对象的变化。

CRI是负责kubeblet和底层容器打交道的统一接口
</div>2021-11-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/55/f3/4e8fecaa.jpg" width="30px"><span>普罗@庞铮</span> 👍（3） 💬（2）<div>原生部署或者容器部署，不过这里的容器不能和k8s使用的容器重叠。😁</div>2018-12-22</li><br/><li><img src="" width="30px"><span>Geek_9ca34e</span> 👍（3） 💬（0）<div>老师，我用kubeadm 搭建了一个k8s集群，又搭建了一个Ceph rbd，两个集群不在相同的机器上，我现在手动创建PV，PVC，CS，并绑定pod没有问题，但是我想实现PVC动态绑定CS却不行，我看网上说需要安装rbd-privi插件，但是插件配好后，还是不能动态创建pv，to；通过log日志查看，好像是访问不到coredns，请问老师有好的解决方法麽？</div>2018-12-06</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLyfjHfjulibFGPTewSZZHm2M8yfI7BZmO9vLUFoagveCw3DWYDss7y1CecKia7lT5yb9KoAmsya2zg/132" width="30px"><span>Goteswille</span> 👍（3） 💬（0）<div>打卡</div>2018-12-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/bb/f6/af833125.jpg" width="30px"><span>Vinsec</span> 👍（1） 💬（0）<div>跟不上了，我要快点看！！！</div>2018-12-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/0c/7b/8176c0dd.jpg" width="30px"><span>Jing Li</span> 👍（0） 💬（0）<div>思考题：
  思路是先在每台node上安装好需要的container runtime，然后再安装部署kubelet。
  原因是猜测在安装kubelet时，kubelet会自动检测当前node上已经安装的container runtime并同时安装相应的CRI shim。</div>2023-11-17</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/uqaRIfRCAhJ6t1z92XYEzTHlzk8IVNVXIS13zP2m2qlPZSAauSz81Ru1H0jUnnspAwfVjvlUtMXd9XA7LnKic3PDcIFH8xEQp/132" width="30px"><span>Geek_842c94</span> 👍（0） 💬（0）<div>实际上，kubelet 也是通过 Watch 机制，监听了与自己相关的 Pod 对象的变化。当然，这个 Watch 的过滤条件是该 Pod 的 nodeName 字段与自己相同。kubelet 会把这些 Pod 的信息缓存在自己的内存里。

kubelet不是运行在Node上的吗，他监听的是所有的Pod？还是说只监听本节点的Pod信息</div>2022-05-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/22/69/09f7a8a2.jpg" width="30px"><span>Don Wang</span> 👍（0） 💬（0）<div>第三遍，第四遍都是哪里有需求，看哪里了...</div>2022-04-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/dd/eb/80f9d212.jpg" width="30px"><span>lttzzlll</span> 👍（0） 💬（0）<div>本文收获：所有的异步任务，都需要队列这种逻辑结构。</div>2021-09-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8f/5b/2f16ca95.jpg" width="30px"><span>WuKongCoder</span> 👍（0） 💬（0）<div>各位朋友看到这里 相信大家都对k8s有所收获，这也是我第二遍学习，每一遍都有不同的收获，我建了一个k8s的学习群，日常分享学习心得和答疑解惑 帮助大家一起成长，欢迎大家加入进来一起进步，个人微信 coder_wukong 欢迎加好友</div>2021-08-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d4/f3/129d6dfe.jpg" width="30px"><span>李二木</span> 👍（0） 💬（0）<div>SyncLoop 感觉跟netty的eventloop 有点像。</div>2021-07-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/0d/c2/37662333.jpg" width="30px"><span>啊琼คิดถึง</span> 👍（0） 💬（0）<div>打卡，老师讲的真好！</div>2021-04-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/20/fe/54/51976e52.jpg" width="30px"><span>ଘ琳̌琳̌ଓ</span> 👍（0） 💬（0）<div>张老师，我们这边遇到一个问题。就是在实际应用时，频繁在服务器上启动和销毁POD，会出现POD创建和销毁的速度变慢，甚至出现POD一直为ContainerCreating状态。通过查看是由于systemctl list-units --all | wc -l过多导致的问题，其中，一个月积累的dhcp-interface@veth00665a8.service                                                                             loaded    failed   failed  DHCP interface veth00665a8  个数超过10万个，请问有没有什么解决方法。谢谢</div>2021-02-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/d9/ff/b23018a6.jpg" width="30px"><span>Heaven</span> 👍（0） 💬（0）<div>使用原生部署或者容器部署吧</div>2020-10-16</li><br/><li><img src="" width="30px"><span>Geek_9ca34e</span> 👍（0） 💬（0）<div>老师刚刚插件名字打错了，是rbd-provisioner插件</div>2018-12-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/b1/4d/10c75b34.jpg" width="30px"><span>Johnson</span> 👍（0） 💬（0）<div>单独部署并维护kubelet</div>2018-12-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ba/ec/9ee8b869.jpg" width="30px"><span>黄满</span> 👍（0） 💬（0）<div>打卡</div>2018-12-05</li><br/>
</ul>