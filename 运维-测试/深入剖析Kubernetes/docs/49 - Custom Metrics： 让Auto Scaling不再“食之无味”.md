你好，我是张磊。今天我和你分享的主题是：Custom Metrics，让Auto Scaling不再“食之无味”。

在上一篇文章中，我为你详细讲述了 Kubernetes 里的核心监控体系的架构。不难看到，Prometheus 项目在其中占据了最为核心的位置。

实际上，借助上述监控体系，Kubernetes 就可以为你提供一种非常有用的能力，那就是 Custom Metrics，自定义监控指标。

在过去的很多 PaaS 项目中，其实都有一种叫作 Auto Scaling，即自动水平扩展的功能。只不过，这个功能往往只能依据某种指定的资源类型执行水平扩展，比如 CPU 或者 Memory 的使用值。

而在真实的场景中，用户需要进行Auto Scaling 的依据往往是自定义的监控指标。比如，某个应用的等待队列的长度，或者某种应用相关资源的使用情况。这些复杂多变的需求，在传统 PaaS项目和其他容器编排项目里，几乎是不可能轻松支持的。

而凭借强大的 API 扩展机制，Custom Metrics已经成为了 Kubernetes 的一项标准能力。并且，Kubernetes 的自动扩展器组件 Horizontal Pod Autoscaler （HPA）， 也可以直接使用Custom Metrics来执行用户指定的扩展策略，这里的整个过程都是非常灵活和可定制的。
<div><strong>精选留言（18）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/94/47/75875257.jpg" width="30px"><span>虎虎❤️</span> 👍（20） 💬（0）<div>HPA 通过 HorizontalPodAutoscaler 配置要访问的 Custom Metrics, 来决定如何scale。
Custom Metric APIServer 的实现其实是一个Prometheus 的Adaptor，会去Prometheus中读取某个Pod&#47;Servicce的具体指标值。比如，http request的请求率。
Prometheus 通过 ServiceMonitor object 配置需要监控的pod和endpoints，来确定监控哪些pod的metrics。
应用需要实现&#47;metrics， 来响应Prometheus的数据采集请求。

留给自己的思考，Pod 的 metrics endpoint 如何对应到http_requests 这个指标的？
</div>2018-12-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/6b/56/37a4cea7.jpg" width="30px"><span>单朋荣</span> 👍（13） 💬（1）<div>张老师，伸缩是不是写的简单了点，毕竟伸缩也是核心功能之一。主要想了解下，hpa伸缩的判定算法的替换方法，vpa预测算法的常见类型及优缺点，ca在大规模场景下实现的原理，ar的应用场景等；还有就是自定义伸缩（prometheus)时间戳优化原理、方法，及最后微服务下伸缩的结合方法等。可不可以从伸缩的数据分类、获取手段、处理算法、伸缩流程、调度算法、故障处理反馈机制等方面，再列几章讲一下，谢谢张老师！！</div>2020-05-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/f1/15/8fcf8038.jpg" width="30px"><span>William</span> 👍（7） 💬（2）<div>请问能否实现跨node的水平扩展?</div>2018-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/2d/24/28acca15.jpg" width="30px"><span>DJH</span> 👍（7） 💬（2）<div>请教一个问题：对于多POD的应用（如多副本的deployment），假设配置了根据CPU使用率进行自动水平伸缩（HPA），那么HPA执行水平伸缩的依据是各个POD中CPU使用率平均值还是最高值？另外HPA探测到多少次CPU高于设置值才会开始伸缩？CPU使用率探测的频率又是多久一次呢？</div>2018-12-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/b5/f3/8efcc2dd.jpg" width="30px"><span>剑走偏锋</span> 👍（3） 💬（0）<div>就为了做自定义业务指标的监控，我们也做了水晶桥(Crystal Bridge)项目开源在github上了。思路是自采通过annotations公开的promethus指标，然后推往prometheus GW，最后再由上层prometheus来采集。

今天这种让HPA通过自定义指标来完成扩容&#47;缩容操作的技术设计的确很棒，学习了，感谢。</div>2019-01-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/9c/48/44965714.jpg" width="30px"><span>Mars</span> 👍（1） 💬（0）<div>请教下老师 为什么knative要自己弄一个autoscaler。既然k8s已经有了autoscaler了，感觉没啥必要再造一个轮子。</div>2020-06-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/e2/d8/f0562ede.jpg" width="30px"><span>manatee</span> 👍（1） 💬（4）<div>请问下老师，扩容好理解就是加容器，那缩容的话如何实现呢，怎么保证在删除容器的时候容器上的请求不受影响呢</div>2019-12-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/35/7a/abb7bfe3.jpg" width="30px"><span>stan</span> 👍（1） 💬（1）<div>请张老师帮忙解惑，对于多实例应用，采集 service暴露的指标才是正确的做法，这句怎么理解？采集每个pod对应的指标不好吗，service后面对应的api无法确认来自哪个pod吧？数据可能忽大忽小，如果采集到一个刚刚hpa的pod指标，数据可能更小，这样应该没有采集每个pod，然后平均值来的更精确吧？类似对于cpu 的hpa，就是采集的每个pod的指标然后做平均值</div>2018-12-20</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIpF5euTNx3GJRv2UprQHohnD9DStzjwgdFUA3x2w9o0OXldQZC1VWYuLPnVqM54XBib1G3c0AEpJA/132" width="30px"><span>源子陌</span> 👍（0） 💬（2）<div>“所以说，我们在对前面的 Custom Metircs URL 进行访问时，会看到值是 501484m，这里的格式，其实就是 milli-requests，相当于是在过去两分钟内，每秒有 501 个请求。”——这个 501484m 是怎么折算成 501 QPS的，老师能再解释下嘛？</div>2022-05-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/37/3b/495e2ce6.jpg" width="30px"><span>陈斯佳</span> 👍（0） 💬（0）<div>第四十七课:Custom Metrics: 让Auto Scaling不再“食之无味”

很多 PaaS 项目中的Auto Scaling，即自动水平扩展的功能，只能依据某种指定的资源类型执行水平扩展，比如 CPU 或者 Memory 的使用值。凭借强大的 API 扩展机制，Custom Metrics 已经成为了 Kubernetes 的一项标准能力。并且，Kubernetes 的自动扩展器组件 Horizontal Pod Autoscaler （HPA）， 也可以直接使用 Custom Metrics 来执行用户指定的扩展策略，这里的整个过程都是非常灵活和可定制的。Kubernetes 里的 Custom Metrics 机制，也是借助 Aggregator APIServer 扩展机制来实现的。这里的具体原理是，当你把 Custom Metrics APIServer 启动之后，Kubernetes 里就会出现一个叫作custom.metrics.k8s.io的 API。而当你访问这个 URL 时，Aggregator 就会把你的请求转发给 Custom Metrics APIServer 。而 Custom Metrics APIServer 的实现，其实就是一个 Prometheus 项目的 Adaptor。</div>2021-11-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/97/c5/84491beb.jpg" width="30px"><span>罗峰</span> 👍（0） 💬（0）<div>Hpa里面配置了对哪些deploy等进行水平伸缩、伸缩的范围，对应的指标的阈值。
指标是普罗主动拉取的，需要个servicemonitor告诉普罗哪个指标拉取哪个pod。
这样指标有了，需扩展的k8资源确定了，ha功能也就可以了。</div>2021-06-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/1b/71/791d0f5e.jpg" width="30px"><span>饮水</span> 👍（0） 💬（0）<div>你好，老师，KubeBuilder还能用来做api么，那这个api和operator有啥区别？</div>2021-04-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/4f/61/00083e41.jpg" width="30px"><span>小白</span> 👍（0） 💬（1）<div>HPA 定义时并没看到是访问custom.metrics.k8s.io接口的，Aggregator 怎么知道应该调用custom metrics API server?</div>2020-08-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/6b/56/37a4cea7.jpg" width="30px"><span>单朋荣</span> 👍（0） 💬（0）<div>Warning  FailedGetObjectMetric         1m (x13 over 7m)  horizontal-pod-autoscaler  unable to get metric http_requests: Service on default sample-metrics-app&#47;unable to fetch metrics from custom metrics API: the server could not find the metric http_requests for services
  Warning  FailedComputeMetricsReplicas  1m (x13 over 7m)  horizontal-pod-autoscaler  failed to get object metric value: unable to get metric http_requests: Service on default sample-metrics-app&#47;unable to fetch metrics from custom metrics API: the server could not find the metric http_requests for services
遇到一个问题，求解决思路。。
</div>2019-10-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/bd/aa/fa3ebfe9.jpg" width="30px"><span>yzw</span> 👍（0） 💬（0）<div>老师，对于没有证书的kubernetes集群，修改prometheus的什么参数可以保证访问采用的是不安全方式呢？我的kubernetes集群是v1.11.2，prometheus是kube-prometheus:v0.1.0，谢谢解答</div>2019-08-06</li><br/><li><img src="" width="30px"><span>suke</span> 👍（0） 💬（0）<div>老师 我在自己的集群上实验了一下http_requests的监控，servicemonitor和相关的hpa，以及相关的权限绑定都部署了，pod里也实现了 &#47;meteics 接口 ，但是hpa的在线配置里提示service on xx xxxx&#47;object metrics are not yet supported，请问您大概知道我因为什么才导致的这个问题么，网上也没查到相关的解释</div>2019-06-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/2d/24/28acca15.jpg" width="30px"><span>DJH</span> 👍（0） 💬（1）<div>还有个问题请教一下，PVC属性里的读写属性ReadWriteMany指的是多个pod之间可以同时读写？同一个pod的多个容器之间算同时读写吗？</div>2018-12-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/98/37/7f575aec.jpg" width="30px"><span>vx:jiancheng_goon</span> 👍（0） 💬（2）<div>请教一个问题，如何才能保证pod原地重启。不论是升级还是断电。</div>2018-12-14</li><br/>
</ul>