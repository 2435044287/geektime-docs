你好，我是张磊。我今天和你分享的主题是：白话容器基础之隔离与限制。

在上一篇文章中，我详细介绍了Linux容器中用来实现“隔离”的技术手段：Namespace。而通过这些讲解，你应该能够明白，**Namespace技术实际上修改了应用进程看待整个计算机“视图”，即它的“视线”被操作系统做了限制，只能“看到”某些指定的内容**。但对于宿主机来说，这些被“隔离”了的进程跟其他进程并没有太大区别。

说到这一点，相信你也能够知道我在上一篇文章最后给你留下的第一个思考题的答案了：在之前虚拟机与容器技术的对比图里，不应该把Docker Engine或者任何容器管理工具放在跟Hypervisor相同的位置，因为它们并不像Hypervisor那样对应用进程的隔离环境负责，也不会创建任何实体的“容器”，真正对隔离环境负责的是宿主机操作系统本身：

![](https://static001.geekbang.org/resource/image/d1/96/d1bb34cda8744514ba4c233435bf4e96.jpg?wh=2242%2A1163)

所以，在这个对比图里，我们应该把Docker画在跟应用同级别并且靠边的位置。这意味着，用户运行在容器里的应用进程，跟宿主机上的其他进程一样，都由宿主机操作系统统一管理，只不过这些被隔离的进程拥有额外设置过的Namespace参数。而Docker项目在这里扮演的角色，更多的是旁路式的辅助和管理工作。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/c2/e0/7188aa0a.jpg" width="30px"><span>blackpiglet</span> 👍（677） 💬（13）<div>1 之前遇到过，但是没有考虑如何解决，临时抱佛脚，查了 lxcfs，尝试回答一下。top 是从 &#47;prof&#47;stats 目录下获取数据，所以道理上来讲，容器不挂载宿主机的该目录就可以了。lxcfs就是来实现这个功能的，做法是把宿主机的 &#47;var&#47;lib&#47;lxcfs&#47;proc&#47;memoinfo 文件挂载到Docker容器的&#47;proc&#47;meminfo位置后。容器中进程读取相应文件内容时，LXCFS的FUSE实现会从容器对应的Cgroup中读取正确的内存限制。从而使得应用获得正确的资源约束设定。kubernetes环境下，也能用，以ds 方式运行 lxcfs ，自动给容器注入争取的 proc 信息。
2 用的是vanilla kubernetes，遇到的主要挑战就是性能损失和多租户隔离问题，性能损失目前没想到好办法，可能的方案是用ipvs 替换iptables ，以及用 RPC 替换 rest。多租户隔离也没有很好的方法，现在是让不同的namespace调度到不同的物理机上。也许 rancher和openshift已经多租户隔离。</div>2018-09-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/28/4c/dc20161e.jpg" width="30px"><span>三七</span> 👍（102） 💬（10）<div>&#47;proc文件系统的问题我好像遇到过这个坑..当时在容器上运行的java应用，由于当时jvm参数没正确配置上，就用默认的，而容器设置的内存为4g，最后oom了，当时用命令查看容器的内存占用情况，竟然发现内存竟然有60多g。 那应该显示的是宿主机的内存了，jvm按照宿主机内存大小分配的默认内存应该大于4g 所以还没full gc 就oom了</div>2018-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/50/57/abb7bfe3.jpg" width="30px"><span>Geek_k6ry2n</span> 👍（73） 💬（7）<div>是不是可以理解：一个docker里面跑的进程都是docker这个进程的子进程？</div>2018-09-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/aa/09/b28091ac.jpg" width="30px"><span>monkey</span> 👍（68） 💬（31）<div>对cgroup有了更深的了解，作者能帮所有订阅的同学建个微信群方便大家交流心得吗？买的其他课程很多老师都建了交流群氛围挺好的哈。</div>2018-09-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5d/9d/4ee1faf4.jpg" width="30px"><span>Bob</span> 👍（56） 💬（3）<div>请教个问题，cgroups除了限制资源上限，能否锁定下限？如果不能，那不是很容易被抢资源？</div>2018-09-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6b/f8/b4da7936.jpg" width="30px"><span>大魔王汪汪</span> 👍（55） 💬（7）<div>感觉理解了namespace和cgroup，自己也可以搞一个进程容器了</div>2018-09-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/9f/26/89eda2c8.jpg" width="30px"><span>V V</span> 👍（37） 💬（9）<div>为什么说容器中无法同时运行两个不同的应用？实际上可以的。设置CMD参数为一个脚本，脚本中启动多个不同的进程。或者通过exec执行bash进入容器后，手动启动多个在后台运行的进程。</div>2018-09-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/96/83/747d4431.jpg" width="30px"><span>明珠</span> 👍（23） 💬（4）<div>老师，讲的太好了，言简易懂，每天都在期待新的一节课。 请教一个问题我们通常dockerpull下来的基础镜像比如:centos 7，这个镜像里面没有内核信息是吧?但是封装了systemd等进程管理工具，使得产生的新的进程都是一号进程的子进程，执行ping netstat命令，也会是这个容器一号进程的子进程?  老师这样理解对吗?</div>2018-09-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0f/70/cdef7a3d.jpg" width="30px"><span>Joe Black</span> 👍（20） 💬（5）<div>既然容器都运行在同一个内核，我在两个容器里挂载了同一个本地目录 ，然后在一个容器里的该目录下建立一个子目录，用mount命令成功挂载远程的nfs到这个子目录上，但是在另一个容器里看还是空子目录，没有nfs服务里的内容。这该怎么解决？是不是我的方法就不对？</div>2018-09-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/fd/d6/71e1cc29.jpg" width="30px"><span>Kaer</span> 👍（20） 💬（5）<div>docker的实现原理也仅仅是调用了底层的namespace和cgroup吗，然后加上一些其他的优化和特性。</div>2018-09-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/f3/6a/6d82e7a3.jpg" width="30px"><span>暮雨</span> 👍（19） 💬（5）<div>容器内部还能再做namespace和cgroup么？也就是容器中再做docker</div>2018-09-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/ce/e8/12cb8e99.jpg" width="30px"><span>小松松</span> 👍（18） 💬（1）<div>内存分为虚拟内存和物理内存，请问Cgroup限制的是哪个呢？ 如果限制虚拟内存，是限制堆内存还是所有呢？ </div>2019-04-19</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ercmNryEicqDS73icpUu7W0BnZ7ZIia6jR7kdVMIzH0q1d7L8EKAYWeTJcribibGcHnJzpsjRFxAe26egQ/132" width="30px"><span>pytimer</span> 👍（17） 💬（2）<div>为什么容器不添加磁盘限制？</div>2018-09-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d2/79/0a432fde.jpg" width="30px"><span>凯文1985</span> 👍（16） 💬（4）<div>一个容器本质上只是一个进程，那么不能同时启动两个应用？这个能解释一下吗？ 如果我打包一个docker镜像 里面安装了redis和tomcat 那就不能跑在容器里了？</div>2018-10-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/98/37/7f575aec.jpg" width="30px"><span>vx:jiancheng_goon</span> 👍（16） 💬（2）<div>这篇文章写的真不错，终于明白cgroup是干嘛的了。再有，我能在这里打招聘广告吗？</div>2018-09-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a0/90/095db0c5.jpg" width="30px"><span>Django</span> 👍（13） 💬（1）<div>想问下，windows10中的linux子系统是如何实现的？</div>2018-09-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/22/42/79604ce6.jpg" width="30px"><span>公众号：云原生Serverless</span> 👍（12） 💬（1）<div>请问宿主机的&#47;etc&#47;hosts文件也和&#47;proc类似么，最近遇到个问题，在init-container里修改了hosts文件的权限，在同一个pod中的container中hosts权限也发生了改变，但是在init-container中修改hosts文件内容的话，同一个pod中的container中的hosts文件内容却没有发生改变，这怎么解释？
2018-09-26
 作者回复
不通同容器的文件系统是隔离的啊。至于权限，你想想它该归哪个namespace 管呢？

2018-09-27

还有有点不太明白，我理解同一个pod中的container只有网络命名空间是共享的啊，难道容器镜像init层的文件也位于同一个volume命名空间吗</div>2018-09-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4e/c7/8c2d0a3d.jpg" width="30px"><span>余泽锋</span> 👍（11） 💬（4）<div>老师您好，“这意味着，如果你要在 Windows 宿主机上运行 Linux 容器，或者在低版本的 Linux 宿主机上运行高版本的 Linux 容器，都是行不通的。”这段话有些不解，我的macbook pro可以运行最新版本的linux的docker，感觉是不是跟您这句话有冲突</div>2018-09-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ed/1a/269eb3d6.jpg" width="30px"><span>cfanbo</span> 👍（11） 💬（1）<div>由于一个容器的本质就是一个进程，用户的应用进程实际上就是容器里 PID=1 的进程，也是其他后续创建的所有进程的父进程。这就意味着，在一个容器中，你没办法同时运行两个不同的应用，除非你能事先找到一个公共的 PID=1 的程序来充当两个不同应用的父进程，这也是为什么很多人都会用 systemd 或者 supervisord 这样的软件来代替应用本身作为容器的启动进程。

这里的应用指的是容器里的apache redis mysql这类的应用吗？</div>2018-09-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/89/c8/e7357aa3.jpg" width="30px"><span>故事的小黄花</span> 👍（9） 💬（4）<div>其实，虚拟机对于宿主机来说也是进程，限制虚拟机的资源使用也可以用cgroup.</div>2018-10-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/dc/3e/abb7bfe3.jpg" width="30px"><span>小崔</span> 👍（9） 💬（1）<div>systemd 或者 supervisord 这样的软件来代替应用本身作为容器的启动进程
这样启动的容器，Cgroup限制的只是supervisord的资源呢？还是容器内所有进程的总资源？</div>2018-09-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/b3/c5/7fc124e2.jpg" width="30px"><span>Liam</span> 👍（9） 💬（2）<div>如果docker run时没有指定cpu quota,默认是不限制的吧 （-1）</div>2018-09-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/97/2c/28f11cd9.jpg" width="30px"><span>岁月～静好</span> 👍（9） 💬（1）<div>相对于虚拟机来说，容器没有专门的cpu内存等，没有虚拟的操作系统，只是通过namespace重命名的进程运行买物理机上，没有实质性的隔离，会发生容器内的应用越狱等情况。但可以通过cgroup来限制容器的cpu内存等的使用，现有问题是top，&#47;pro下查看到的还是物理界机的相关信息。不知道理解的是否正确？</div>2018-09-05</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLEYbNElGIxYx8WCwo8RW6AJZibdGbETckBQER1ktTE1bFcRp4GNpmzXTIGm9DSiaU305tCkwONOW3Q/132" width="30px"><span>yyarrow</span> 👍（7） 💬（1）<div>&quot;用户的应用进程实际上就是容器里 PID=1 的进程，也是其他后续创建的所有进程的父进程。这就意味着，在一个容器中，你没办法同时运行两个不同的应用，除非你能事先找到一个公共的 PID=1 的程序来充当两个不同应用的父进程&quot;，这里不是很懂，为啥找到一个公共的pid=1的夫进程就行了呢？即使找到了，两个子进程也不能作为同一个容器管理吧？还有这个公共的pid=1中所谓的“公共”指的是在容器中还是在宿主机中的公共呀？求指导~</div>2018-10-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/bb/c5/ffae4021.jpg" width="30px"><span>小豪</span> 👍（6） 💬（1）<div>张老师，请问利用cgroup做内存限制，如果容器内的进程消耗的内存比较高，会导致容器进程假死吗？有什么更好的解决方法呢？谢谢</div>2018-09-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ee/a9/971234c5.jpg" width="30px"><span>silencedoctor</span> 👍（6） 💬（2）<div>我看到docker可以Windows上运行linux容器，在linux上运行Windows容器的情况，如果本质上都是使用宿主机的内核请问它是怎样做到的呢</div>2018-09-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/42/af/8c37ca95.jpg" width="30px"><span>haiker</span> 👍（5） 💬（1）<div>我创建container目录实验之后直接使用rm -rf无法删除container目录，我想知道如果是在docker run的时候限制了cpu使用，当删除这个容器，它对应的cpu限制的文件也会删掉吗？不删除的话会不会这个目录下的文件会越来越多</div>2019-04-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/6c/47/8da914be.jpg" width="30px"><span>Geek_1264yp</span> 👍（5） 💬（1）<div>老师好，关于docke容器磁盘使用大小的限制，存储驱动是devicemapper，可以通过设置启动参数改变容器对磁盘的占用控制，然而overlay2却没有这样的限制了，对吗？</div>2018-12-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/22/42/79604ce6.jpg" width="30px"><span>公众号：云原生Serverless</span> 👍（5） 💬（1）<div>也就是对于&#47;etc&#47;hosts这个文件而言，同一个pod中不同container修改权限时是修改的宿主机的文件权限，而修改hosts文件内容时，修改的是各自的文件么？

2018-09-27

 作者回复

不是……hosts跟volume是一样的，所有容器共同mount了同一份。但是这个文件的内容，是kubelet维护的，在每个容器创建的时候，kubelet会重写它里面的内容。这就是为啥我说不让你手动改hosts……

经磊哥一讲解，比之前豁然开朗了许多，但是同一个pod中不同container  hosts权限问题呢，一个容器中改了权限，不是生效在该容器的读写层么，宿主机上对应的文件权限不会变化吧？如果不变化，那么同pod中下一个容器mount的时候不是应该权限和宿主机最初的hosts权限一致么</div>2018-09-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/b1/4a/7279221f.jpg" width="30px"><span>Cloudcat</span> 👍（5） 💬（1）<div>不好意思，前面的留言有些错误，我的意思是Dockerfile中一条CMD运行一个脚本，脚本里有两条运行进程的指令，前一条后台运行，第二条前台运行，这样应该可以实现容器在建立的时候运行两个进程了吧？还是说脚本执行的时候其实是一个父进程fork出了两个子进程？正好符合了你说的第二句话“除非你能事先找到一个公共的PID=1的程序来充当两个不同应用的父进程”</div>2018-09-13</li><br/>
</ul>