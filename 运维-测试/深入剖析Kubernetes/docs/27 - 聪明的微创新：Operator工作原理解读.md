你好，我是张磊。今天我和你分享的主题是：聪明的微创新之Operator工作原理解读。

在前面的几篇文章中，我已经和你分享了Kubernetes项目中的大部分编排对象（比如Deployment、StatefulSet、DaemonSet，以及Job），也介绍了“有状态应用”的管理方法，还阐述了为Kubernetes添加自定义API对象和编写自定义控制器的原理和流程。

可能你已经感觉到，在Kubernetes中，管理“有状态应用”是一个比较复杂的过程，尤其是编写Pod模板的时候，总有一种“在YAML文件里编程序”的感觉，让人很不舒服。

而在Kubernetes生态中，还有一个相对更加灵活和编程友好的管理“有状态应用”的解决方案，它就是：Operator。

接下来，我就以Etcd Operator为例，来为你讲解一下Operator的工作原理和编写方法。

Etcd Operator的使用方法非常简单，只需要两步即可完成：

**第一步，将这个Operator的代码Clone到本地：**

```
$ git clone https://github.com/coreos/etcd-operator
```

**第二步，将这个Etcd Operator部署在Kubernetes集群里。**

不过，在部署Etcd Operator的Pod之前，你需要先执行这样一个脚本：
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/96/89/9312b3a2.jpg" width="30px"><span>Vincen</span> 👍（42） 💬（5）<div>是否可以将operator和自定义控制器划等号</div>2018-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/c8/8f/759b7761.jpg" width="30px"><span>ethfoo</span> 👍（17） 💬（14）<div>etcd operator现在使用empty dir存储etcd数据，万一真的出现大部分节点挂掉，但是数据备份又不是实时的，会存在部分数据丢失的情况吧？那为什么etcd operator不使用pv呢？</div>2018-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/18/3c/b5a00c1a.jpg" width="30px"><span>johnson.skiii</span> 👍（13） 💬（3）<div>张大，请教个问题。

如果ETCD每个pod不绑定pv的话，那么当其中一个挂掉的话，etcd operator会再启动一个pod，但是启动到那一台worker未知；那么，由于raft机制，leader会同步数据给这个新的pod，这个过程可能会很耗时；

与其这样，能否限定运行etcd的pod使用特定的pv，这样当出现pod挂掉的情况，leader同步数据也会更快。</div>2018-12-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/04/0d/3dc5683a.jpg" width="30px"><span>柯察金</span> 👍（9） 💬（1）<div>我问一个问题，平时开发人员需要用到的 CRD 的地方多吗，如果要自定义的话还是挺麻烦的呢</div>2019-01-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/2d/24/28acca15.jpg" width="30px"><span>DJH</span> 👍（8） 💬（1）<div>请教老师，EtcdBackup和EtcdRestore资源创建（并运行）后会自动删除吗？是否需要手工删除？</div>2018-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/2e/72/145c10db.jpg" width="30px"><span>每日都想上班</span> 👍（3） 💬（1）<div>我有4台master，其中一台master我给它系统重装，然后再加入master，是不是可以平滑操作？</div>2018-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/bc/08/c43f85d9.jpg" width="30px"><span>IOVE.-Minn</span> 👍（2） 💬（2）<div>老师，在测试官方的prometheus-operator。因为我的集群是二进制部署的，我想监控到我的组件，kube-contorller-manager和kube-scheduler组件，我做了一些修改（把这些组件的bind address设定为了0.0.0.0，自己单独创建了他们的ep）。当时是能在prometheus的targets看到，并且也能监控到。但是过了一段时间后，这些svc和ep会自动失效。这个问题怎么来查看呢？
</div>2018-10-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/97/8b/bd318156.jpg" width="30px"><span>qingbo</span> 👍（1） 💬（2）<div>我看到这种非StatefulSet的pod有DNS记录的时候好奇了一下，发现是指定了subdomain和service名字一样才可以。不知道是后来加进k8s的还是一开始就有，以前觉得除了StatefulSet的pod都没有DNS的……</div>2019-04-18</li><br/><li><img src="" width="30px"><span>hochuenw</span> 👍（1） 💬（1）<div>老师请问怎么看metacontroller这个项目</div>2018-10-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/b1/4d/10c75b34.jpg" width="30px"><span>Johnson</span> 👍（0） 💬（3）<div>使用这个operator创建的etcd的每个节点–initial-cluster参数并不是都一样的啊，存在拓扑关系，而且最后添加的节点才有所有的列表。那问题来了，前面创建的节点是如何知道所有的节点呢？删除节点的时候是只删除最后添加的节点吗？我感觉要是任意删除的话，会影响其他的节点，老师帮忙解答一下 谢谢</div>2018-11-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/96/ec/5c53f9e5.jpg" width="30px"><span>小熹</span> 👍（75） 💬（2）<div>CRD在ETCD里面是以JSON格式来存储的，而K8S的API对象是以protobuf格式存储，在资源对象数量多的时候JSON的序列化和反序列化性能会成为瓶颈。</div>2018-11-18</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqZIqY4cs6YKI5w8pJmCge3G4YUV4hNW018A63iauwtLHgxnC9Mh4AZPI0QkYuq1dKVFDsw5BMRh4w/132" width="30px"><span>程序修行</span> 👍（72） 💬（9）<div> 已经到了看不懂的时候了～。丧心</div>2018-12-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/df/e2/823a04b4.jpg" width="30px"><span>小小笑儿</span> 👍（20） 💬（0）<div>感觉operator就是一个自定义的controller，需要有一定的开发能力来实现。</div>2018-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/fd/4d/41875340.jpg" width="30px"><span>Simon Wu</span> 👍（13） 💬（0）<div>Etcd operator已经支持pvc了，依靠备份机制还是有一段时间的数据丢失，就看你的业务允不允许。</div>2019-10-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/f9/d3/2cb7516e.jpg" width="30px"><span>？</span> 👍（9） 💬（0）<div>我觉得这一章应该算扩展，需要有一定基础，并且编写过crd的朋友来学习的，普通的使用还用不上crd，毕竟很多开源项目都自定义了crd，我们只需要查看他们的文档配置即可。</div>2021-02-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/83/af/1cb42cd3.jpg" width="30px"><span>马以</span> 👍（4） 💬（1）<div>该文章中的例子其实是创建不成功的，因为我的k8s版本是1.23.0，最新的api已经从原来的extensions&#47;v1beta1变为了apps&#47;v1,所以这里在创建example&#47;deployment.yaml时虽然能够成功，但是创建CRD的时候是失败的，我们通过log也可以看出来：
Could not construct reference to: &#39;&amp;v1.Endpoints{TypeMeta:v1.TypeMeta{Kind:&quot;&quot;, APIVersion:&quot;&quot;}, ObjectMeta:v1.ObjectMeta{Name:&quot;etcd-operator&quot;, GenerateName:&quot;&quot;, Namespace:&quot;default.......

time=&quot;2022-03-12T06:46:45Z&quot; level=error msg=&quot;initialization failed: fail to init CRD: failed to create CRD: the server could not find the requested resource&quot; pkg=controller

我想解决办法只能是修改源码吧，但是我不会go，很难受😣</div>2022-03-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/9b/5d/f99d0ce6.jpg" width="30px"><span>化石</span> 👍（4） 💬（1）<div>最前面的例子 etcd 创建 infra0-infra2 3 个节点的时候，--initial-cluster-state 都是 new，是否和后面的内容不一致?</div>2020-02-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/96/89/9312b3a2.jpg" width="30px"><span>Vincen</span> 👍（4） 💬（0）<div>厉害了，全是干货！</div>2018-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/13/9d/0ff43179.jpg" width="30px"><span>Andy</span> 👍（3） 💬（0）<div>有点难了，得多看几遍，留个爪</div>2020-06-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/b4/94/2796de72.jpg" width="30px"><span>追风筝的人</span> 👍（2） 💬（1）<div>已经到了看不懂的时候了   这是个悲伤的故事</div>2021-12-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/11/74/72ffa6d6.jpg" width="30px"><span>StayLet</span> 👍（2） 💬（0）<div>以前认为能把 Kubernetes 跑起来，能把应用部署进去并维护整个生命周期就是会了。现在发现前面的玩溜了只是开始，会 CRD、Operator 才是真的会。</div>2021-06-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/20/41/7b/cda2e622.jpg" width="30px"><span>致良知</span> 👍（2） 💬（0）<div>学到了 真心不错</div>2020-11-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/19/ac/32da70c9.jpg" width="30px"><span>Spring.Fred</span> 👍（2） 💬（0）<div>之前用StatefulSet实现的mysql主从读写分离的例子， 能给个Operator的示例代码吗？</div>2020-06-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/a5/98/a65ff31a.jpg" width="30px"><span>djfhchdh</span> 👍（2） 💬（0）<div>应该是client端与apiserver交互存在性能瓶颈</div>2019-11-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/9f/a1/d75219ee.jpg" width="30px"><span>po</span> 👍（2） 💬（0）<div>请教一个问题，etcd operator 使用empty dir存储etcd数据，那么在集群突然断电或者关机的情况下，再启动集群，那么所有etcd的pod数据都是为空，那raft算法在这个时候也没法工作了吧？这个问题要怎么解决呢？我看现在openshift集群的etcd就是用operator部署的，请老师解答下，谢谢。</div>2019-05-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/94/47/75875257.jpg" width="30px"><span>虎虎❤️</span> 👍（2） 💬（0）<div>不错，可以试着添加 workqueue 来练练手。可以多布置些作业，有的时候还真是不擅长给自己找活干。。</div>2018-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/dd/a9/fa4cb455.jpg" width="30px"><span>松三爷</span> 👍（1） 💬（1）<div>老师问个问题, etcd-operator为什么会自动创建CRD呢?  在项目里没有看到etcd-cluster的yaml文件啊, 还是说这个CRD是这个container自带创建的 ? </div>2022-04-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/f6/94/e244696a.jpg" width="30px"><span>yingjie</span> 👍（1） 💬（0）<div>老师，这里operator执行的命令是在哪个镜像容器里面启动etcd的命令的？</div>2021-11-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/53/71/a4e9f20e.jpg" width="30px"><span>言午木杉</span> 👍（1） 💬（1）<div>我觉得这里的复杂度真的指数级，意思是在k8s上运行一个分布式集群应用，需要向下层的k8s接口进行编程，然后搞一套自适应的控制器来满足k8s的调度。这个太噩梦了对于新手来说</div>2021-09-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/bd/01/733150df.jpg" width="30px"><span>切慕溪水Mia</span> 👍（1） 💬（0）<div>CRD是个筐，什么都能往里装</div>2021-04-22</li><br/>
</ul>