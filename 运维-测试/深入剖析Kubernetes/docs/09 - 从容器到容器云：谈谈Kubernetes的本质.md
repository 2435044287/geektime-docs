你好，我是张磊。今天我和你分享的主题是：从容器到容器云，谈谈Kubernetes的本质。

在前面的四篇文章中，我以Docker项目为例，一步步剖析了Linux容器的具体实现方式。通过这些讲解你应该能够明白：一个“容器”，实际上是一个由Linux Namespace、Linux Cgroups和rootfs三种技术构建出来的进程的隔离环境。

从这个结构中我们不难看出，一个正在运行的Linux容器，其实可以被“一分为二”地看待：

1. 一组联合挂载在/var/lib/docker/aufs/mnt上的rootfs，这一部分我们称为“容器镜像”（Container Image），是容器的静态视图；
2. 一个由Namespace+Cgroups构成的隔离环境，这一部分我们称为“容器运行时”（Container Runtime），是容器的动态视图。

更进一步地说，作为一名开发者，我并不关心容器运行时的差异。因为，在整个“开发-测试-发布”的流程中，真正承载着容器信息进行传递的，是容器镜像，而不是容器运行时。

这个重要假设，正是容器技术圈在Docker项目成功后不久，就迅速走向了“容器编排”这个“上层建筑”的主要原因：作为一家云服务商或者基础设施提供商，我只要能够将用户提交的Docker镜像以容器的方式运行起来，就能成为这个非常热闹的容器生态图上的一个承载点，从而将整个容器技术栈上的价值，沉淀在我的这个节点上。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/66/c4/038f9325.jpg" width="30px"><span>Jeff.W</span> 👍（514） 💬（9）<div>从微服务架构来讲，多个独立功能内聚的服务带来了整体的灵活性，但是同时也带来了部署运维的复杂度提升，这时Docker配合Devops带来了不少的便利(轻量、隔离、一致性、CI、CD等)解决了不少问题，再配合compose，看起来一切都很美了，为什么还需要K8s？可以试着这样理解么？把微服务理解为人，那么服务治理其实就是人之间的沟通而已，人太多了就需要生存空间和沟通方式的优化，这就需要集群和编排了。Docker Compose，swarm，可以解决少数人之间的关系，比如把手机号给你，你就可以方便的找到我，但是如果手机号变更的时候就会麻烦，人多了也会麻烦。而k8s是站在上帝视角俯视芸芸众生后的高度抽象，他看到了大概有哪些类人(组织）以及不同组织有什么样的特点（Job、CornJob、Autoscaler、StatefulSet、DaemonSet...），不同组织之间交流可能需要什么（ConfigMap,Secret...）,这样比价紧密的人们在相同pod中，通过Service-不会变更的手机号，来和不同的组织进行沟通，Deployment、RC则可以帮组人们快速构建组织。Dokcer 后出的swarm mode，有类似的视角抽象（比如Service），不过相对来说并不完善。以上，是否可以这样理解？</div>2018-09-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a4/95/474d5eaf.jpg" width="30px"><span>Tigerfive</span> 👍（118） 💬（4）<div>感觉不能迁移“有状态”的容器，是因为迁移的是容器的rootfs，但是一些动态视图是没有办法伴随迁移一同进行迁移的。</div>2018-09-12</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIGzSM6be2xCNS00kQYHDgXO3icOoOSsvnz3FiaCov5Kgs6oaXkBicLbicuEerJjiaNPWxB0FTVmdur3kg/132" width="30px"><span>Xiye</span> 👍（73） 💬（2）<div>对于第二个问题，是不是像存储在文件或者数据库里的数据还是比较好迁移，但是对于缓存，临时存储的数据是不是就不太好迁移。</div>2018-09-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/97/cf/bd257cfb.jpg" width="30px"><span>盆盆</span> 👍（24） 💬（3）<div>赞，这几天一直在追更，欲罢不能😃😃
Kubelet这个词，词根let是小的意思，小猪piglet，微软PowerShell也有cmdlet，班门弄斧了，不知道对不</div>2018-11-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0d/42/22eae851.jpg" width="30px"><span>Rod</span> 👍（18） 💬（1）<div>@老师。我记得service的ip也是可变的。不变的是service name。通过kube dns解析。当然service可以绑定主机名。但是那样就不能高可用。不知道我说的对不对？</div>2018-09-13</li><br/><li><img src="" width="30px"><span>Scott</span> 👍（13） 💬（2）<div>为什么一个node上，kubelet与Device plugin要走gRPC，这个没有CSI这样的专门中间层吗？</div>2018-09-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/05/92/b609f7e3.jpg" width="30px"><span>骨汤鸡蛋面</span> 👍（13） 💬（1）<div>一直对CNI、CSI 有点困惑，为什么不将其纳入到container runtime&#47;oci 的范畴？</div>2018-09-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/c3/c9/a8e03342.jpg" width="30px"><span>x</span> 👍（8） 💬（1）<div>现在docker 的Storage Driver基本都是overlay2 了，aufs快被淘汰了了吧</div>2018-11-02</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ercmNryEicqDS73icpUu7W0BnZ7ZIia6jR7kdVMIzH0q1d7L8EKAYWeTJcribibGcHnJzpsjRFxAe26egQ/132" width="30px"><span>pytimer</span> 👍（8） 💬（2）<div>第二个问题: 我觉得应该是很多容器数据都是挂载在本地路径，所以没办法直接进行迁移。

如果容器的数据挂载在共享存储上，那是不是没有kubernetes也是可以迁移有状态的容器？</div>2018-09-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/d2/2f/04882ff8.jpg" width="30px"><span>龙坤</span> 👍（7） 💬（1）<div>容器OCI规范推出，那么统一规范的容器镜像都可以在不同厂商自主研发的容器运行时上运行。随着时间的推进，在容器编排上的需求，虽然有swarm和mesos的方案，但是对于一些有能力做基于容器PaaS平台的大公司，并且还有一些具有自主研发能力、野心大和具有一定PaaS平台资源的，并想借用容器赚钱的大公司，就不太乐意用这些方案（所以为什么大公司前期都迫切需要一个容器规范出现的原因吧）。这时也迫切需要一个可以对接自主研发的“运行时”的工具出来，并该工具能弥补容器编排不完美这个缺陷。个人觉得，Kubernetes的出现确实伟大，伟大到击垮Docker公司原先建立的都围着他转的容器社区体系，也伟大到可以又让大公司赚钱。 --- 纯属个人理解</div>2018-09-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/d4/36/328d2a5a.jpg" width="30px"><span>Myth</span> 👍（6） 💬（1）<div>使用 keepalived 算容灾备份，不算负载均衡吧？</div>2019-04-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/56/a3/649d861c.jpg" width="30px"><span>淸曉</span> 👍（5） 💬（1）<div>老师你好！
server VIP是虚拟出来的，外界怎么来通过VIP访问到后端呢？是在路由器上做什么吗，还是别的？</div>2018-12-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8b/19/a15d060d.jpg" width="30px"><span>silverhawk</span> 👍（4） 💬（2）<div>写的很好，谢谢。如果我现在有一个service已经被打包成pod用k8s管理，这个service对每个request需要查询外部一个k,v store，那么现在想把这个k,v store比如redis也做成pod，是做到一个pod里面，还是service这样比较合适，听起来好像做成service，两者之间还是继续用GRPC？</div>2018-09-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f7/b1/982ea185.jpg" width="30px"><span>美妙的代码</span> 👍（4） 💬（2）<div>老师，问下pod和job  到底是关系？ 我没有懂呢</div>2018-09-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7a/62/9b248708.jpg" width="30px"><span>阿硕</span> 👍（4） 💬（1）<div>整个集群的持久化数据，则由 kube-apiserver 处理后保存在 Ectd 中。是不是Etcd呢？</div>2018-09-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/86/ad/dd7bfa58.jpg" width="30px"><span>一生一世一双人</span> 👍（2） 💬（2）<div>老师，k8s能在大数据运维里有什么好的解决方案嘛？</div>2018-11-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/23/ee/9a45407e.jpg" width="30px"><span>kid1412z</span> 👍（2） 💬（1）<div>老师请问，master节点是单点部署上面有三个模块 还是可以多点部署，每个节点担任不同的角色？</div>2018-10-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg" width="30px"><span>马若飞</span> 👍（2） 💬（1）<div>k8s的架构分master和node和现在的Istio很像，也是分了控制面板和数据面板，估计Istio的设计借鉴了k8s</div>2018-09-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0f/70/cdef7a3d.jpg" width="30px"><span>Joe Black</span> 👍（1） 💬（1）<div>之前用过HTCondor这样的老牌调度系统，专注任务调度和依赖关系处理，咋一看和k8s有很多功能重叠（也能调度容器）。但感觉k8s结合容器更好地处理了打包、编排和扩展性等问题，是开发运维一体化的利器，上层的应用不用太关注底层基础设施的变化，和这类传统调度系统的关注点不在一个层次。</div>2018-09-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/1b/b4/a6db1c1e.jpg" width="30px"><span>silver</span> 👍（1） 💬（1）<div>为什么说mesos是老迈和旧瓶装新酒呢？Mesos本身所做的事情是有限的，很大一部分取决于它的scheduler,谈论mesos不是很大一方面取决于scheduler么</div>2018-09-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/fd/cc/b13b71f9.jpg" width="30px"><span>他说风雨中</span> 👍（1） 💬（1）<div>老师您好，很喜欢看您的文章，文采也很好，想问您一个问题，kubernetes1.10beta介绍的时候，在说到对cpu的支持的时候，只是一笔带过，想问一下您 kubernetes1.10对cpu到底支持到什么程度呢</div>2018-09-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/48/64/e0b94df2.jpg" width="30px"><span>草莓/mg</span> 👍（0） 💬（1）<div>张老师问一下，kubectl 和 kubeadm分别装的什么版本？</div>2018-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/6c/47/8da914be.jpg" width="30px"><span>Geek_1264yp</span> 👍（0） 💬（1）<div>老师你好，咱们这章节提到的用k8s部署的负载均衡的nginx跟nginx本身的upstream 效果一样么？期待老师的回复！非常感谢！
</div>2018-10-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/c2/91/fba79b87.jpg" width="30px"><span>小伟</span> 👍（0） 💬（1）<div>老师，你觉得作为一个运维在学习k8s时重点关注哪些技术点将来在能发挥更大作业呢？我们公司正准备上架k8s项目，我都不知道该重点学习哪里？</div>2018-09-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5e/02/b50560ac.jpg" width="30px"><span>Tank</span> 👍（0） 💬（1）<div>Server Version: 18.06.0-ce
Storage Driver: devicemapper
Backing Filesystem: xfs

我本地的并非 aufs 我本地没有设置过。
这里面的原理是否可以讲一下。</div>2018-09-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4e/60/0d5aa340.jpg" width="30px"><span>gogo</span> 👍（0） 💬（1）<div>尝试第二个问题：例如mysql这种有状态服务，当容器被调度到其他节点时，ip和存储的数据都无法同步了</div>2018-09-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/93/c7/1640226d.jpg" width="30px"><span>刘欣洲</span> 👍（0） 💬（1）<div>Kubernetes 的成功是不是意味着Docker Swarm 的失败？ Docker Swarm还有存在的必要性吗？</div>2018-09-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/40/ba/2c8af305.jpg" width="30px"><span>Geek_zz</span> 👍（502） 💬（0）<div>对这个专栏看的越多，越觉得作者讲得有条理又有深度，物超超超所值</div>2018-09-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/78/65/fc80bc6d.jpg" width="30px"><span>大豪。</span> 👍（165） 💬（0）<div>这价格讲到这种程度，跟捡到便宜似的，感谢作者</div>2018-09-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/e9/88/941e488a.jpg" width="30px"><span>hugeo</span> 👍（84） 💬（0）<div>学费太值得了，老师太会教课了说得很清楚</div>2018-09-12</li><br/>
</ul>