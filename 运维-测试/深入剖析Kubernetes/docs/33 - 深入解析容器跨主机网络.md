你好，我是张磊。今天我和你分享的主题是：深入解析容器跨主机网络。

在上一篇文章中，我为你详细讲解了在单机环境下，Linux容器网络的实现原理（网桥模式）。并且提到了，在Docker的默认配置下，不同宿主机上的容器通过IP地址进行互相访问是根本做不到的。

而正是为了解决这个容器“跨主通信”的问题，社区里才出现了那么多的容器网络方案。而且，相信你一直以来都有这样的疑问：这些网络方案的工作原理到底是什么？

要理解容器“跨主通信”的原理，就一定要先从Flannel这个项目说起。

Flannel项目是CoreOS公司主推的容器网络方案。事实上，Flannel项目本身只是一个框架，真正为我们提供容器网络功能的，是Flannel的后端实现。目前，Flannel支持三种后端实现，分别是：

1. VXLAN；
2. host-gw；
3. UDP。

这三种不同的后端实现，正代表了三种容器跨主网络的主流实现方法。其中，host-gw模式，我会在下一篇文章中再做详细介绍。

而UDP模式，是Flannel项目最早支持的一种方式，却也是性能最差的一种方式。所以，这个模式目前已经被弃用。不过，Flannel之所以最先选择UDP模式，就是因为这种模式是最直接、也是最容易理解的容器跨主网络实现。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/fc/06/6cc5d4d5.jpg" width="30px"><span>何先生</span> 👍（15） 💬（16）<div>为什么要使用UDP呢，UDP不是不可靠的吗</div>2018-11-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ac/c8/4b1c0d40.jpg" width="30px"><span>勤劳的小胖子-libo</span> 👍（13） 💬（2）<div>Flannel中的UDP需要Etcd来维护相关的子网与宿主机的对应关系，在VxLan中也需要Etcd吗？老师，什么时候可以讲下Etcd在k8s中的原理与应用？</div>2018-11-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/5a/56/115c6433.jpg" width="30px"><span>jssfy</span> 👍（4） 💬（1）<div>请问bridge fdb看到的其它节点vtep的对应关系vtep是各节点主动注册的？</div>2018-11-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/28/5a/dc141082.jpg" width="30px"><span>月亮上看星星</span> 👍（3） 💬（1）<div>磊哥，问你个docker的问题，镜像load到主机上，镜像里的文件是不是存储在主机的某个目录上，起来的容器访问这个文件，实际上就是访问主机上的这个文件？如果是这样的话，创建个数据卷放这个文件，让容器去访问这个数据卷里的这个文件，其实也是访问主机某个目录里的文件，不知道这两种方式有什么区别呢？请磊哥指导下呢</div>2018-11-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e6/2a/2ac18fb8.jpg" width="30px"><span>艾斯Z艾穆</span> 👍（2） 💬（1）<div>您好，我遇到一个问题
我在一个被service选中的app里访问不了这个service的port可以ping通，用pod的ip可以访问到端口
别的pod可以访问到service的port
这个pod也可以访问别的service的port
kube-proxy用的模式是ipvs</div>2018-11-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/b6/97/93e82345.jpg" width="30px"><span>陆培尔</span> 👍（1） 💬（1）<div>老师能说一下最近很火的cilium吗，BPF的内部机制</div>2018-11-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ef/a2/6ea5bb9e.jpg" width="30px"><span>LEON</span> 👍（1） 💬（1）<div>老师，请问内核态和用户态具体指的是什么呢？该如何理解？</div>2018-11-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/9a/80/2bf8d7fc.jpg" width="30px"><span>宝爷</span> 👍（206） 💬（6）<div>这里使用UDP，不需要可靠，因为可靠性不是这一层需要考虑的事情，这一层需要考虑的事情就是把这个包发送到目标地址。如果出现了UDP丢包的情况，也完全没有关系，这里UDP包裹的是我们真正的数据包，如果我们上层使用的是TCP协议，而Flannel使用UDP包裹了我们的数据包，当出现丢包了，TCP的确认机制会发现这个丢包而重传，从而保证可靠。</div>2019-02-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5e/90/5f79859b.jpg" width="30px"><span>Maiza</span> 👍（55） 💬（2）<div>分分钟变成了计算机网络课程 😄</div>2018-11-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/94/47/75875257.jpg" width="30px"><span>虎虎❤️</span> 👍（44） 💬（1）<div>我又思考了一下，二层网络可能无法连通。因为flannel网络中，node上的fdb是靠配置而非学习得到。当node1上的容器1想要通过mac地址直连node2上的容器2时，由于node1中的fdb中没有配置容器2的mac地址相关记录，所以flannel.1无法找到VTEP出口的ip。故而二层网络没有连通性。

如果想要有连通性，需要配置VTEP为学习模式，并且把所有的VTEP加入一个分组中。这样在fdb表中查询不到mac地址时，vxlan在VTEP组中发起广播(或者组播？这个概念我有点混淆)。VTEP也可作为一个网桥设备，继续向docker0，进而目的node上的所有容器广播。正确的目的地址会响应请求，而且刚才途经的设备fdb都学习到了源容器的mac 地址映射，所以响应数据可以顺利返回源容器。这样就完成了二层网络的连通。</div>2018-11-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f6/8e/c9c94420.jpg" width="30px"><span>俊釆</span> 👍（42） 💬（0）<div>读了至少6遍了，每次都有新的收获，感谢磊哥给力的分享。</div>2019-09-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/19/f4/34fdd4be.jpg" width="30px"><span>大杏仁儿</span> 👍（17） 💬（1）<div>这个和一般的网络传输不同，一般的网络传输会直接请求ip地址，根据ip地址，发送ARP请求来获取下一跳设备的mac地址，获取mac地址之后会缓存下来，这是一般路由器或者网桥做的事情。但在容器网络里我们只知道目标容器的ip地址，并不知道宿主机的ip地址，需要将容器的ip地址和宿主机的ip地址关联起来。这个关系由路由规则, fdb存储的数据和ARP记录下来，这些都是在创建node节点的时候，由各个节点的flanneld创建出来。通过路由规则知道了该将数据包发送到flannel.1这个vtep设备处理并且知道了目地vtep的ip地址，通过vtep IP地址ip neigh show dev flannel.1 找到了对端的vtep mac地址，通过对端vtep mac地址查询 bridge fdb list 查到了这个mac地址对应的宿主机地址。 这样封装出包之后按照vxlan逻辑进行正常发送。</div>2021-03-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/6e/6b/9c3f3abb.jpg" width="30px"><span>阿鹏</span> 👍（17） 💬（1）<div>我看很多文章都推荐calico，老师觉得呢</div>2018-11-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/32/0b/81ae214b.jpg" width="30px"><span>凌</span> 👍（12） 💬（5）<div>flannel进程负责子网-&gt;VTEP mac，VTEP mac-&gt;节点ip(fdb)的维护，为什么不直接维护子网-&gt;节点ip表更直接，中间的二层网络感觉多此一举的</div>2019-01-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6c/ea/ce9854a5.jpg" width="30px"><span>坤</span> 👍（11） 💬（0）<div>好深的功底</div>2019-06-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/df/5f/dabab90b.jpg" width="30px"><span>程燕华</span> 👍（11） 💬（0）<div>各个node会将自己的vtep信息上报给apiserver，apiserver将信息同步给各个节点的flanneld，flanneld通过netlink下发，完成信息的同步</div>2018-11-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/13/eb/150bf071.jpg" width="30px"><span>whatever</span> 👍（8） 💬（1）<div>老师您将的关于linux网络方面的能介绍一本书吗？我想体系化的学习一下相关知识。比如flannel.1是怎么介入到操作系统内核那里的，是linux本身提供了扩展吗，这些问题我觉得还是需要体系化的学习一下，要不感觉知其然不知其所以然</div>2019-03-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/43/7b/0c7f8fbe.jpg" width="30px"><span>divfor</span> 👍（8） 💬（0）<div>讲隧道模式不提mtu处理，是不是缺了什么</div>2019-01-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ef/21/69c181b8.jpg" width="30px"><span>Rain</span> 👍（7） 💬（10）<div>抓包分析了下，确实如老师所描述，外部数据帧的源和目的MAC地址分别为宿主机网卡的MAC地址，外部IP头的源和目的地址分别为宿主机的IP地址，内部数据帧中的源和目的MAC地址分别为VTEP设备的MAC地址，内部IP头的源和目的地址分别为容器的IP地址。但是有个问题，做了个测试，在容器里面arping另一个宿主机上的容器地址，却得不到回应，这是为什么？广播地址不会被封装出去吗？</div>2019-02-23</li><br/><li><img src="" width="30px"><span>海柔儿稀罕</span> 👍（5） 💬（1）<div>搞开发的说网络，很简单的网络道理讲的啰里啰嗦，让搞网络的看的费劲。两件事数据平面和控制平面以及数据包在每个转发阶段是如何封装解封装的需要查什么表。
还有K8S属于PAAS就不应该有多租户说法，多租户是IAAS层面的。K8S从底层网络层面就做不到IAAS层面的租户地址空间的隔离和解决地址重叠。</div>2020-07-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/45/83/93d389ba.jpg" width="30px"><span>我是谁</span> 👍（4） 💬（4）<div>老师请教2个问题哈，
1. vxlan协议中，内层mac头应该是源虚拟机和目标虚拟机的mac地址，外层ip头是源和目的端vtep设备的ip，外层mac头是源和目的端vtep设备的mac地址。为什么flannel的vxlan方案中不是这个样子，是flanneld对flannel.1设备封包解包进行了调整吗？这个地方有很大疑虑
2. flannel.1这个vtep设备封包是会封装到外层的mac头才算封装完毕吗？还是只是封装到添加vxlan头，其他的交由内核完成的？因为我看文章介绍，flannel.1解包时从内层数据包开始解析的。所以这一块也很迷惑。</div>2021-03-18</li><br/><li><img src="" width="30px"><span>ch_ort</span> 👍（4） 💬（0）<div>容器“跨主通信”的三种主流实现方法：UDP、host-gw、VXLAN，其中：
（1）UDP：最直接、最容易理解、性能最差的实现方式 。 比如Flannel的实现中，flanneld将不同宿主机划分成不同的子网，不同的容器所在的宿主机不同则子网也不同，这些&lt;宿主机,子网&gt;信息存储在etcd中。当容器需要“跨主通信”时， flanneld进程会将发出端的IP包进行UDP封装，然后发送到目的端的宿主机上，目的端的宿主机的flanneld再进行解封装发送给对应的容器来使用。

（2）VXLAN：  Virtual Extensible LAN（虚拟可扩展局域网），通过VXLAN技术在内核态上实现了UDP方式的封装和解封装，提高了性能，即用VTEP实现了flanneld进程的功能
</div>2020-11-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/a5/98/a65ff31a.jpg" width="30px"><span>djfhchdh</span> 👍（4） 💬（0）<div>关键是那个fdb，如果fdb能够记录容器mac和宿主机ip的对应关系，那就可以保证二层连通性</div>2019-11-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/94/47/75875257.jpg" width="30px"><span>虎虎❤️</span> 👍（4） 💬（0）<div>基于udp backend的flannel不能实现2层连通，flannel0是tun设备，工作在三层网络。

基于vxlan backend的flannel我认为可以实现2层连通。vxlan封装转发的是二层数据帧，整个flannel网络里只有交换设备，设备都在一个广播域里。所以即使arp表里没有记录也可以通过广播实现2层连通。flannel.1可以通过手动维护fdb表（记录目的容器的mac地址和其所在主机的映射），或者在vtep分组中进行广播，来找到目的VTEP，进而转发到目的容器。</div>2018-11-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/9e/d6/4b07f8b5.jpg" width="30px"><span>我来烤烤你</span> 👍（3） 💬（2）<div>VXLAN的实现过程为什么一定要套一个UDP在中间？？？非常费解</div>2021-12-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/61/61/677e8f92.jpg" width="30px"><span>xianhai</span> 👍（3） 💬（0）<div>etcdctl ls 这个命令不存在啊。
我是用这个命令安装etcdctl的：go get github.com&#47;coreos&#47;etcd&#47;cmd&#47;etcdctl

极客时间版权所有: https:&#47;&#47;time.geekbang.org&#47;column&#47;article&#47;65287</div>2018-11-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/97/c5/84491beb.jpg" width="30px"><span>罗峰</span> 👍（2） 💬（0）<div>确实图多术语少，基础差的人也能明白个大概</div>2021-05-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/2a/b8/edbafb82.jpg" width="30px"><span>彦</span> 👍（2） 💬（0）<div>请问，某个节点上flannel进程启动后，会发送相关状态到其他节点---那么，这个共享的配置信息是不是经过Etcd处理的？FDB这个转发数据库是不是也是在这个时机形成的？ 这样 在打上外层标签时就这直接从内核态进行操作，从而效率比较高。</div>2019-03-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/32/0b/81ae214b.jpg" width="30px"><span>凌</span> 👍（2） 💬（0）<div>flannel的基础是不同node分子网这是三层的概念，二层显然无法满足</div>2019-01-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c1/60/f5439f04.jpg" width="30px"><span>Geek_dn82ci</span> 👍（2） 💬（0）<div>请问为什么vxlan一定要使用udp建立连接呢？</div>2018-11-21</li><br/>
</ul>