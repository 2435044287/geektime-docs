你好，我是张磊。今天我和你分享的主题是：从0到1搭建一个完整的Kubernetes集群。

不过，首先需要指出的是，本篇搭建指南是完全的手工操作，细节比较多，并且有些外部链接可能还会遇到特殊的“网络问题”。所以，对于只关心学习 Kubernetes 本身知识点、不太关注如何手工部署 Kubernetes 集群的同学，可以略过本节，直接使用 [MiniKube](https://github.com/kubernetes/minikube) 或者 [Kind](https://github.com/kubernetes-sigs/kind)，来在本地启动简单的 Kubernetes 集群进行后面的学习即可。如果是使用 MiniKube 的话，阿里云还维护了一个[国内版的 MiniKube](https://github.com/AliyunContainerService/minikube)，这对于在国内的同学来说会比较友好。

在上一篇文章中，我介绍了kubeadm这个Kubernetes半官方管理工具的工作原理。既然kubeadm的初衷是让Kubernetes集群的部署不再让人头疼，那么这篇文章，我们就来使用它部署一个完整的Kubernetes集群吧。

> 备注：这里所说的“完整”，指的是这个集群具备Kubernetes项目在GitHub上已经发布的所有功能，并能够模拟生产环境的所有使用需求。但并不代表这个集群是生产级别可用的：类似于高可用、授权、多租户、灾难备份等生产级别集群的功能暂时不在本篇文章的讨论范围。  
> 目前，kubeadm的高可用部署[已经有了第一个发布](https://kubernetes.io/docs/setup/independent/high-availability/)。但是，这个特性还没有GA（生产可用），所以包括了大量的手动工作，跟我们所预期的一键部署还有一定距离。GA的日期预计是2018年底到2019年初。届时，如果有机会我会再和你分享这部分内容。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/c4/92/338b5609.jpg" width="30px"><span>Roy Liang</span> 👍（65） 💬（7）<div>kubeadm最新版本已经为1.12，看到上面很多人遇到提示版本不对，重新安装低版本就好了
apt remove kubelet kubectl kubeadm
apt install kubelet=1.11.3-00
apt install kubectl=1.11.3-00
apt install kubeadm=1.11.3-00</div>2018-09-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/e6/d8/8939848a.jpg" width="30px"><span>Andy</span> 👍（29） 💬（6）<div>最新的部署ceph cluster需要多一条部署命令才可以部署成功：
1. kubectl apply -f https:&#47;&#47;raw.githubusercontent.com&#47;rook&#47;rook&#47;master&#47;cluster&#47;examples&#47;kubernetes&#47;ceph&#47;common.yaml
2. kubectl apply -f https:&#47;&#47;raw.githubusercontent.com&#47;rook&#47;rook&#47;master&#47;cluster&#47;examples&#47;kubernetes&#47;ceph&#47;operator.yaml
3. kubectl apply -f https:&#47;&#47;raw.githubusercontent.com&#47;rook&#47;rook&#47;master&#47;cluster&#47;examples&#47;kubernetes&#47;ceph&#47;cluster.yaml</div>2019-04-17</li><br/><li><img src="" width="30px"><span>包治结巴</span> 👍（12） 💬（1）<div>张老师，请教一个问题，master部署完成后生成指令，比如“ kubeadm join 172.19.0.7:6443 --token xw4d6t.1dmpctojkcg9yqlf --discovery-token-ca-cert-hash sha256:45168e55ad19ac6126728e86c0a4c46e98c7df5d0312aec3fdd8d437dc24a3b9”，假如当时没有记下来，有什么命令可以再次让master生成这个指令吗？</div>2018-09-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/96/7c/b1e6ea51.jpg" width="30px"><span>心情不错</span> 👍（11） 💬（1）<div>以后是不是开发负责部署单个docker， 运维负责宏观kubernetes?</div>2018-09-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/db/7d/1fbad49b.jpg" width="30px"><span>John</span> 👍（10） 💬（2）<div>非常强的挫败感。第一，打败墙，花了几天。然后，应用了网络插件，但是仍然是 not ready，提示还是 network plugin  is not ready cni config uninitiated。请问怎么看日志呢？</div>2018-09-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/93/61/3e4607c7.jpg" width="30px"><span>hpfish</span> 👍（10） 💬（1）<div>为什么不解释一些常见的问题呢？第一次部哪有那么顺啊</div>2018-09-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ff/e7/7eda8d7e.jpg" width="30px"><span>选择</span> 👍（8） 💬（1）<div>你好，照着你的教程，我在执行kubeadm init --config kubeadm.yaml， 提示：your configuration file uses an old API spec: &quot;kubeadm.k8s.io&#47;v1alpha1&quot;. Please use kubeadm v1.11 instead and run &#39;kubeadm config migrate --old-config old.yaml --new-config new.yaml&#39;, which will write the new, similar spec using a newer API version.用全新的虚拟机安装的 该怎么解决呢？ 谢谢了</div>2018-09-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/66/c4/038f9325.jpg" width="30px"><span>Jeff.W</span> 👍（7） 💬（1）<div>网络受限的话觉得可以参考一下这个，使用Ansible脚本安装K8S集群，介绍组件交互原理，方便直接，不受国内网络环境影响 https:&#47;&#47;github.com&#47;gjmzj&#47;kubeasz。机器资源有限就弄个AllInOne？或者单主多从？老师怎么看？</div>2018-09-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/72/3e/534db55d.jpg" width="30px"><span>huan</span> 👍（7） 💬（1）<div>分享一下这篇实践的小插曲，我是使用DigitalOcean的机器做的，没有墙的问题。
在使用weave-net的时候，怎么都通不过，报错是 weave-net的状态是 CrashLoopBackOff，看了container的log，也不懂啥意思，找了下k8s的troubleshoot页面的说明 （https:&#47;&#47;kubernetes.io&#47;docs&#47;setup&#47;independent&#47;troubleshooting-kubeadm&#47;#pods-in-runcontainererror-crashloopbackoff-or-error-state），说是版本问题，不知道怎么解决。
然后随便找了另一个实现 Romana，替换weavenet
`kubectl apply -f https:&#47;&#47;raw.githubusercontent.com&#47;romana&#47;romana&#47;master&#47;containerize&#47;specs&#47;romana-kubeadm.yml` 终于成功了，然后体验到了以前想都不敢想的Ceph，超赞</div>2018-09-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/98/b1/f89a84d0.jpg" width="30px"><span>wu526</span> 👍（5） 💬（1）<div>在执行kubeadm init config kubeadm.yaml时报如下错误：
your configuration file uses an old API spec: &quot;kubeadm.k8s.io&#47;v1alpha1&quot;. Please use kubeadm v1.11 instead and run &#39;kubeadm config migrate --old-config old.yaml --new-config new.yaml&#39;, which will write the new, similar spec using a newer API version.

kubedadm的版本信息是:
kubeadm version: &amp;version.Info{Major:&quot;1&quot;, Minor:&quot;12&quot;, GitVersion:&quot;v1.12.0&quot;, GitCommit:&quot;0ed33881dc4355495f623c6f22e7dd0b7632b7c0&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2018-09-27T17:02:38Z&quot;, GoVersion:&quot;go1.10.4&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux&#47;amd64&quot;}
系统环境是：ubuntu server 16.04

在google也搜索了，没有找到解决方法。麻烦老师解答一下解决方法。
今后在遇到类似的问题时，应该如何解决呢，希望张老师能提供一个解决问题的思路。或者是如何才能查看不同版本的kubernetes的参数的差异变化。
谢谢张老师~</div>2018-09-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/0e/17/0aa98ae7.jpg" width="30px"><span>同心结</span> 👍（5） 💬（1）<div>你好，我搭好了节点重启之后服务没起来，我怎么让服务跑起来呀</div>2018-09-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/db/7d/1fbad49b.jpg" width="30px"><span>John</span> 👍（5） 💬（1）<div>不翻墙 有办法装 kubeadm 吗？</div>2018-09-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/13/34/abb7bfe3.jpg" width="30px"><span>小鱼儿</span> 👍（5） 💬（2）<div>老师，请问你的“-”是怎么读的？</div>2018-09-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/09/42/1f762b72.jpg" width="30px"><span>Hurt</span> 👍（4） 💬（1）<div>老师 我一直想问 这个集群 是在一台服务器上吗 还是多台啊</div>2018-09-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/93/c7/1640226d.jpg" width="30px"><span>刘欣洲</span> 👍（4） 💬（1）<div>Rook 能够直接支持Google 的 GCP的persistent disk 吗？该如何实现呢？</div>2018-09-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a9/2e/01b2839e.jpg" width="30px"><span>巩夫建</span> 👍（4） 💬（1）<div>二进制部署，目前是1.11.3版本。测试环境大约50台。遇到问题是calico与ipvs知识点不足。
部署趟了不少坑都过来了，感觉kubernetes不管理网络开放cni这种，提升不少门槛。此外由于文件系统的问题，之前说work节点不能用pod部署，不知道现在解决了吗？</div>2018-09-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4e/60/0d5aa340.jpg" width="30px"><span>gogo</span> 👍（4） 💬（1）<div>还有个问题，现在rook ceph版本还是beta，不能用于生产环境吧？</div>2018-09-17</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ercmNryEicqDS73icpUu7W0BnZ7ZIia6jR7kdVMIzH0q1d7L8EKAYWeTJcribibGcHnJzpsjRFxAe26egQ/132" width="30px"><span>pytimer</span> 👍（4） 💬（1）<div>使用过ansible和纯二进制文件部署集群，证书之类的比较麻烦，而且添加节点我不方便。
现在Kubernetes集群官方最大节点是5000吧，我自己的环境的话就6个节点。

老师，想要问下，我现在使用kubeadm来部署生产环境的高可用可以吗？有什么风险吗？
另外，在使用kubeadm join添加节点的时候，token过期怎么处理？我现在都是设置ttl=0，但是感觉这种不太好</div>2018-09-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/9f/26/89eda2c8.jpg" width="30px"><span>V V</span> 👍（3） 💬（1）<div>请问ip地址改变后如何快速恢复cluster。我组了一个子网，使用kubeadm部署了cluster，之后运行了一些应用。之后路由器坏了，这些节点换到了更高一级的路由器下面，ip地址变了。kubectl get nodes的时候提示Unable to connect to the server: dial tcp 192.168.2.3:6443: i&#47;o timeout。请问如何快速恢复这个cluster?
</div>2018-10-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/5a/56/115c6433.jpg" width="30px"><span>jssfy</span> 👍（3） 💬（1）<div>请问多个租户可以考虑用同一套k8s来管理不？生产环境上</div>2018-10-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/10/bb/f1061601.jpg" width="30px"><span>Demon.Lee</span> 👍（3） 💬（1）<div>部署完master节点，再部署一个worker节点，可以在一个pc上吗，还是需要多个pc</div>2018-10-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/98/b1/f89a84d0.jpg" width="30px"><span>wu526</span> 👍（3） 💬（1）<div>root@kubernetes01:~# kubectl get pods -n rook-ceph-system
NAME                                  READY     STATUS    RESTARTS   AGE
rook-ceph-operator-78d498c68c-t2b7w   0&#47;1       Pending   0          21m

如何查看这个容器为什么一直是pending状态</div>2018-09-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/b1/cd/30b8a0f8.jpg" width="30px"><span>王旭</span> 👍（3） 💬（1）<div>你好 我问下这整个环境的安装是不是只能翻墙了 才行.谢谢</div>2018-09-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/72/4c/4d636a23.jpg" width="30px"><span>在路上</span> 👍（3） 💬（1）<div>老师，部署worker节点，和master是不在同一台机器吗？同一台不行吗？用自己的笔记本，集群master是部署在virtualbox的ubuntu上的，那这些worker要怎么弄呢？</div>2018-09-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f7/b1/982ea185.jpg" width="30px"><span>美妙的代码</span> 👍（3） 💬（1）<div>老师 生产环境的部署方法。能讲一讲吗？或者推荐一下相关文档啊。</div>2018-09-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4f/78/c3d8ecb0.jpg" width="30px"><span>undifined</span> 👍（3） 💬（1）<div>老师 像阿里云 AWS GCP 这些平台的一键部署是用什么实现的呢</div>2018-09-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/aa/40/abb7bfe3.jpg" width="30px"><span>德古拉</span> 👍（2） 💬（1）<div>为什么Kubernetes可以管理的节点有瓶颈呢？问题出在什么地方呢？求指点</div>2019-01-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/57/b7/a37f1bc5.jpg" width="30px"><span>Mr.Yang</span> 👍（2） 💬（1）<div>张老师，您好，您在上一节介绍kubeadm的结尾说kubeadm还不适合用在生产环境，而在这一节说下面将以kubeadm部署的环境为基础展开，请问为啥不使用能在生产环境使用的部署方式展开，把kubeadm部署的方式作为了解呢？(个人只是好奇，请各位大佬勿喷，谢谢！)</div>2018-10-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/38/f9/2b4755b5.jpg" width="30px"><span>看不穿</span> 👍（2） 💬（1）<div>我看马哥教育的视频里面用的是flannel提供网络连接，用calico提供网络策略。
不过，本文说用weave插件提供网络策略，请问这两种方案孰优孰劣</div>2018-10-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/d2/2f/04882ff8.jpg" width="30px"><span>龙坤</span> 👍（2） 💬（1）<div>root@master:~# kubectl get node
NAME      STATUS     ROLES     AGE       VERSION
master    Ready         master    1h        v1.11.3
worker1   Ready       &lt;none&gt;    37m       v1.11.3
worker2   Ready       &lt;none&gt;    31m       v1.11.3

所有pod都成功启动了。但是worker节点的ROLES为&lt;none&gt;，正常吗？</div>2018-09-25</li><br/>
</ul>