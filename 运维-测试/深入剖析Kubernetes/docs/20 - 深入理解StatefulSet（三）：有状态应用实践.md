你好，我是张磊。今天我和你分享的主题是：深入理解StatefulSet之有状态应用实践。

在前面的两篇文章中，我详细讲解了StatefulSet的工作原理，以及处理拓扑状态和存储状态的方法。而在今天这篇文章中，我将通过一个实际的例子，再次为你深入解读一下部署一个StatefulSet的完整流程。

今天我选择的实例是部署一个MySQL集群，这也是Kubernetes官方文档里的一个经典案例。但是，很多工程师都曾向我吐槽说这个例子“完全看不懂”。

其实，这样的吐槽也可以理解：相比于Etcd、Cassandra等“原生”就考虑了分布式需求的项目，MySQL以及很多其他的数据库项目，在分布式集群的搭建上并不友好，甚至有点“原始”。

所以，这次我就直接选择了这个具有挑战性的例子，和你分享如何使用StatefulSet将它的集群搭建过程“容器化”。

> 备注：在开始实践之前，请确保我们之前一起部署的那个Kubernetes集群还是可用的，并且网络插件和存储插件都能正常运行。具体的做法，请参考第11篇文章[《从0到1：搭建一个完整的Kubernetes集群》](https://time.geekbang.org/column/article/39724)的内容。

首先，用自然语言来描述一下我们想要部署的“有状态应用”。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/96/89/9312b3a2.jpg" width="30px"><span>Vincen</span> 👍（127） 💬（13）<div>因为是通过一个statefulset来实现的 感觉太复杂了，master和slave做成两个statefulset就非常简单了</div>2018-10-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/2d/24/28acca15.jpg" width="30px"><span>DJH</span> 👍（46） 💬（5）<div>有一点我还是没想通，为啥数据复制操作要用sidecar容器来处理，而不用mysql主容器来一并解决。如果把数据复制操作和启动mysql服务一并写到同一个sh -c后面，这样算不算一个单一进程呢？</div>2018-10-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/50/4d/db91e218.jpg" width="30px"><span>sam700000</span> 👍（39） 💬（1）<div>通过这节我才更清晰理解了，kubernetes最小的管理单位是pod的概念，把思维从容器这层抽出来。然后也更清楚的理解了statefulset实现有状态，就是把特定的状态配置绑定在某个对象名称上面，然后通过之前说的控制循环不断的维护这个对象的特性，只要这写特定对象和它们各自绑定的状态配置不变就实现了有状态的应用部署和维护。果然实践出真知👍</div>2019-08-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/00/15/6e399ec7.jpg" width="30px"><span>彭锐</span> 👍（36） 💬（3）<div>这样的有状态应用有个约束，pod标识一旦确定，角色就确定了。但实际应用中，不能有这样的约束，主挂了，要有一个从升主。这就要求至少有选主机制，所有的配置文件也不能依赖id确定角色。
这怎么玩呢？operater吗？operater可以看成一个特定应用的sre保姆吗？</div>2018-10-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0c/3a/d2161d37.jpg" width="30px"><span>侯操宇</span> 👍（16） 💬（3）<div>老师，我发现在initContainers 的ini-mysql容器中，执行的只是简单的文件拷贝工作，但镜像却用的是mysql的镜像，可以用其他镜像取代吗？镜像的选择有什么讲究吗？</div>2018-10-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/18/34/c082419c.jpg" width="30px"><span>风轨</span> 👍（15） 💬（1）<div>集群中的master&#47;slave节点关系不对等。Service是通过label来绑定pod的，一个statefulSet中所有pod的label都是一样的，无法区分，因此service也是无法区别绑定slave pod的。所以答案应该是老师在文中多次提及的Operator，一次编排多个角色不同甚至镜像不同的服务。</div>2018-10-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/69/d8/112f69f8.jpg" width="30px"><span>wtcctw</span> 👍（14） 💬（8）<div>张大大你好，
我之前自己玩过docker，在看这个专栏之前，特意简单过了一下《Docker容器与容器云 第二版》，之前一些章节看得非常过瘾，讲解得非常透彻。
但是看到StateFulSet的时候感觉有点晕。。。特别是里面的Pod YAML定义，感觉要记的东西非常多，学习曲线也比较陡峭，一段时间不用肯定就忘了。
所以想问一下，作为非专业的运维人员，对于k8s的掌握大致要到何种程度，多谢多谢。</div>2018-10-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4c/49/125f5adc.jpg" width="30px"><span>mazhen</span> 👍（8） 💬（4）<div>总结里给的&#39;mysql-statefulset.yaml&#39;好像有点问题，在声明&#39;volumeClaimTemplates&#39;时，是不是应该通过&#39;storageClassName&#39;属性引用前面定义的&#39;StorageClass&#39;:

storageClassName: rook-ceph-block

我开始一直遇到&quot;pod has unbound immediate PersistentVolumeClaims&quot; 错误，增加了这个属性就好了。</div>2018-10-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/11/4b/fa64f061.jpg" width="30px"><span>xfan</span> 👍（7） 💬（1）<div>感觉实现起来很复杂，不优美</div>2018-12-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a0/30/5a7247eb.jpg" width="30px"><span>eden</span> 👍（5） 💬（1）<div>老师，请问mysql persistent volume需要扩容怎么做？通过kubectl scale不能修改volume大小。</div>2018-12-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0c/3a/d2161d37.jpg" width="30px"><span>侯操宇</span> 👍（5） 💬（3）<div>如果master和slave用两个StatefulSet的话，怎么来保证master和slave的启动顺序呢？</div>2018-10-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/1f/64/54458855.jpg" width="30px"><span>Caesar</span> 👍（5） 💬（2）<div>前面看大神说在搞kata-container，我有一个疑问，kata-container其实也是虚拟机加容器的方式，那它和docker加虚拟机的优势相比在哪呢</div>2018-10-08</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/IyrKOr1vBfpdjgKEqRTOMpiciaMZtlVv6WLFt4lENZRtibt0O9EaOuI1DGIyfeiazD8x8Z1hgicVHZhOxIhez6pkQIw/132" width="30px"><span>彰玉</span> 👍（3） 💬（1）<div>集群建好了  数据也插入成功了  集群也正常后  主从节点的任何节点重启 是重新按yamL启动 还是直接挂数据盘启幼</div>2019-06-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/e5/e3/06aa87b5.jpg" width="30px"><span>强者之风</span> 👍（3） 💬（3）<div>看不出来用MySQL-read  service</div>2019-04-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0f/70/cdef7a3d.jpg" width="30px"><span>Joe Black</span> 👍（3） 💬（3）<div>其实给slave节点增加一个新的标签，创建读Service的时候选择这个标签的容器就行了吧？</div>2018-10-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/a5/cd/3aff5d57.jpg" width="30px"><span>Alery</span> 👍（2） 💬（1）<div>前辈你好，这里有个mysql数据库的疑问，既然xtrabackup与mysql这两个容器的启动顺序不一致会不会对mysql的数据产生影响？如果mysql先起来了，再恢复备份数据，mysql需要重启生效吗？</div>2018-10-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/27/4b/170654bb.jpg" width="30px"><span>千寻</span> 👍（2） 💬（1）<div>集群只有一个节点，ceph storageclass哪里replica设置为3，启动时一直处于pending，enent提示pod has unbound persistentvolumeclaims，将replica设置为1就没有问题，问一下这个大概是什么回事？
谢谢老师</div>2018-10-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/59/7f/1c505317.jpg" width="30px"><span>killua</span> 👍（1） 💬（1）<div>“k8s 内部应用访问数据库 要通过 mysql-id的方式 这种对于应用代码是不是不太好 k8s里可以屏蔽id吗？”
意思是应用写地址的时候要写成 mysql-0 mysql-1 mysql-2 这种 入口没有统一，其次应用可能并不知道 mysql个数？</div>2018-10-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ae/e0/3e636955.jpg" width="30px"><span>李博越</span> 👍（1） 💬（2）<div>Mac上用minikube是不是玩不起来啊？感觉搭建环境好多的坑</div>2018-10-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c1/93/e8bfb26e.jpg" width="30px"><span>Dem</span> 👍（0） 💬（1）<div>&quot;Master 节点和 Salve 节点需要能够传输备份信息文件；&quot;
&quot;接下来，我们再一起解决“第二座大山：Master 节点和 Salve 节点需要能够传输备份文件”的问题。&quot;
两个拼写错误：Salve-&gt;Slave
</div>2019-05-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/59/7f/1c505317.jpg" width="30px"><span>killua</span> 👍（0） 💬（1）<div>k8s 内部应用访问数据库 要通过 mysql-id的方式 这种对于应用代码是不是不太好 k8s里可以屏蔽id吗？</div>2018-10-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/bc/08/c43f85d9.jpg" width="30px"><span>IOVE.-Minn</span> 👍（0） 💬（1）<div>老师能分享下完整的yaml文件么？感觉自己来拼接的话很费时间，而且错误好多哦。感谢</div>2018-10-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/1f/64/54458855.jpg" width="30px"><span>Caesar</span> 👍（0） 💬（1）<div>能不能把kata-container的优势简单讲一下，毕竟kata-container也是跑在虚拟机里的。想不出来和docker跑在虚拟机里有啥本质区别。</div>2018-10-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/96/50/bde525b1.jpg" width="30px"><span>北卡</span> 👍（0） 💬（1）<div>张老师牛逼！看这套教程简直太爽了。
我记得有一章，老师贴了一些k8s内部实现的伪码。希望老师后面在讲使用的时候，也可以多讲讲k8s的设计思路，贴一点代码或者写点伪码这样子。除了能更好的使用k8s外，还对k8s的设计和代码思路特别感兴趣。</div>2018-10-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7c/16/4d1e5cc1.jpg" width="30px"><span>mgxian</span> 👍（0） 💬（1）<div>在不使用读定分离中间件的情况下，使用k8s的service的话，由于service又是依赖label选择pod，所以看样子只能给pod添加相应的label来区分节点了，这个工作可以放在init-container里来做，不知思路是否正确，还请老师指点一下。</div>2018-10-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/13/8c/c86340ca.jpg" width="30px"><span>巴西</span> 👍（90） 💬（5）<div>信息量太大,容我冷静一下</div>2020-01-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/b8/07/ef28a5f7.jpg" width="30px"><span>黄俊</span> 👍（28） 💬（1）<div>error: unable to recognize &quot;rook-storage.yaml&quot;: no matches for kind &quot;Pool&quot; in version &quot;ceph.rook.io&#47;v1&quot;

应该是rook新版本的问题，rook-storage.yaml 文件中有两个位置需要修改。

apiVersion: ceph.rook.io&#47;v1
kind: CephBlockPool
</div>2018-12-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/df/3e/718d6f1b.jpg" width="30px"><span>wenxuan</span> 👍（18） 💬（5）<div>关于思考提的解决方案，有回答提到可以通过创建mysql-read和mysql-write两个service，用不同的label来分别筛选主从。我觉得这里面忽略了一点，即使是StatefulSet，各个副本的metadata也是完全一致的，不可能做到给主从节点打上不同的标签。主从分两个StatefulSet部署可以解决这个问题，但又引入了需要人为控制两个StagefulSet启动顺序的问题。
其实我觉得应该可以修改mysql的启动参数，让master容器和slave容器监听在不同的端口，然后分别创建read和write两个svc，绑定不同的端口。由于svc会把readiness探针失败的pod剔出去，所以就达到read svc只有slave节点，而write svc只有master节点的目的。</div>2020-06-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/da/48/0d3cd6fa.jpg" width="30px"><span>小水</span> 👍（10） 💬（0）<div>用了很大功夫，调通了老师的示例，代码都是照着老师代码敲的，也是不可以避免的有拼写的错误，通过不断的调试，在那成功的一瞬间，喜悦不可言语，老师的示例中使用国外的镜像，我是更换为国内的源，yaml如下链接，希望对后来的同学有所帮助
https:&#47;&#47;github.com&#47;Alexwalt&#47;kubernetes-yamls&#47;blob&#47;master&#47;mysql.yaml
调试工具
kubectl describe pod pod名
kubectl logs -p pod名 -c docker名</div>2021-12-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/63/47/e8164679.jpg" width="30px"><span>正z</span> 👍（8） 💬（0）<div>mysql感觉有点复杂，自己试了下mongoDB，复杂度感觉低一点更容易成功，也同样能深刻理解上面的内容，伙计们也可以试试</div>2020-08-13</li><br/>
</ul>