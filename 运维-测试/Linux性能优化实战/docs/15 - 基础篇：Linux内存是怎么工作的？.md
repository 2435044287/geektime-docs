你好，我是倪朋飞。

前几节我们一起学习了 CPU 的性能原理和优化方法，接下来，我们将进入另一个板块——内存。

同 CPU 管理一样，内存管理也是操作系统最核心的功能之一。内存主要用来存储系统和应用程序的指令、数据、缓存等。

那么，Linux 到底是怎么管理内存的呢？今天，我就来带你一起来看看这个问题。

## 内存映射

说到内存，你能说出你现在用的这台计算机内存有多大吗？我估计你记得很清楚，因为这是我们购买时，首先考虑的一个重要参数，比方说，我的笔记本电脑内存就是 8GB 的 。

我们通常所说的内存容量，就像我刚刚提到的8GB，其实指的是物理内存。物理内存也称为主存，大多数计算机用的主存都是动态随机访问内存（DRAM）。只有内核才可以直接访问物理内存。那么，进程要访问内存时，该怎么办呢？

Linux 内核给每个进程都提供了一个独立的虚拟地址空间，并且这个地址空间是连续的。这样，进程就可以很方便地访问内存，更确切地说是访问虚拟内存。

虚拟地址空间的内部又被分为**内核空间和用户空间**两部分，不同字长（也就是单个CPU指令可以处理数据的最大长度）的处理器，地址空间的范围也不同。比如最常见的 32 位和 64 位系统，我画了两张图来分别表示它们的虚拟地址空间，如下所示：
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLdWHFCr66TzHS2CpCkiaRaDIk3tU5sKPry16Q7ic0mZZdy8LOCYc38wOmyv5RZico7icBVeaPX8X2jcw/132" width="30px"><span>JohnT3e</span> 👍（191） 💬（3）<div>目前我配合使用《Operating System Concepts》这本书学习此专栏，也是一个不错的选择。此书中的第四部分“Memory Management”对今天这部分内容有较为详细的描述，感兴趣的同学可以去看一下。另外对于TOP命令中输出的内存情况解释，可以认真看一下man手册的内容。如果你动手能力比较强，可以看https:&#47;&#47;blog.holbertonschool.com&#47;hack-the-virtual-memory-malloc-the-heap-the-program-break&#47;这篇博客，手把手教你使用程序（C语言）来实际地去搞清楚虚拟内存分布。</div>2018-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/2a/6d/0e436c1c.jpg" width="30px"><span>梦回汉唐</span> 👍（82） 💬（6）<div>1、调用c标准库的都是用户空间的调用，用户空间的内存分配都是基于buddy算法（伙伴算法），并不涉及slab
2、brk()方式之所以会产生内存碎片，是由于brk分配的内存是推_edata指针，从堆的低地址向高地址推进。这种情况下，如果高地址的内存不释放，低地址的内存是得不到释放的
3、mmap()方式分配的内存，是在堆与栈之间的空闲区域分配虚拟内存，直接拿到的是内存地址，可以直接操作内存的释放

上述的都是在用户空间发生的行为，只有在内核空间，内核调用kmalloc去分配内存的时候，才会涉及到slab</div>2019-03-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg" width="30px"><span>我来也</span> 👍（61） 💬（7）<div>[D15打卡]
linux的内存跟windows的很不一样。类linux的系统会尽量使用内存缓存东西，提供运行效率。所以linux&#47;mac显示的free剩余内存通常很小，但实际上被缓存的cache可能很大，并不代表系统内存紧张！
曾经就闹过笑话，看见系统free值很低，怕程序因为oom被系统杀掉，还特意写个c程序去挤内存。程序不停的申请1MB内存然后memset，随机挑几个位置写，保证申请的都被加载到物理内存中。（跟文中描述的一致，只申请不使用不会加载到物理内存）然后挤的差不多了就把测试程序关掉。看上去free变大了很多很开心。现在想想，就是掩耳盗铃罢了。
以前物理机上还有swap交换分区，现在都是云服务器，基本没有了该分区。也不会遇到因为频繁使用交换分区导致性能下降的问题了。
我内存方面的问题遇到的都比较简单，基本上就是top&#47;free看看系统和各程序的，找到有问题的程序，看看是否有内存泄露。平常不泄漏都是够用的。
redis对内存比较敏感，曾经就因为配置项是默认值，在内存用完后，所有的set操作都直接返回错误，导致线上系统故障。（redis在备份时会新开一个进程，实际使用内存量会翻番。）后来会定期检查redis 的info memory 看内存使用情况。
——————————
期待的内存篇开始了，好开心！又可以跟着老师学新知识啦！</div>2018-12-24</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/2o1Izf2YyJSnnI0ErZ51pYRlnrmibqUTaia3tCU1PjMxuwyXSKOLUYiac2TQ5pd5gNGvS81fVqKWGvDsZLTM8zhWg/132" width="30px"><span>划时代</span> 👍（36） 💬（1）<div>我的分析步骤：使用top和ps查询系统中大量占用内存的进程，使用cat &#47;proc&#47;[pid]&#47;status和pmap -x pid查看某个进程使用内存的情况和动态变化。</div>2018-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4d/fe/882eaf0f.jpg" width="30px"><span>威</span> 👍（34） 💬（2）<div>老师您好，请问如果发生了OOM，系统会记录下是哪个（些）进程被杀掉吗？</div>2018-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/b3/46/ec914238.jpg" width="30px"><span>espzest</span> 👍（33） 💬（3）<div>用户空间malloc不会使用slab机制吧，slab是内核空间的，对不？</div>2018-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/61/bc/88a905a5.jpg" width="30px"><span>亮点</span> 👍（21） 💬（3）<div>倪老师，“Operating Systems Design and Implementation”里面说，大部分页式存储管理，页表是存储到内存里面的，为降低频繁访问内存计算物理地址，引入TLB用于缓存常用映射以提升性能。以现在流行的linux为例，本节课说页表存储在MMU是否还正确呢？</div>2018-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/09/5c/b5d79d20.jpg" width="30px"><span>李亮亮</span> 👍（12） 💬（3）<div>我的理解就是，Linux里面所有的概念皆结构（C语言的结构体），页表也是一种结构体，也就是数据，所以保存还是在内存里面。mmu其实就是一个硬件，它的作用就是找到某个虚拟地址到物理地址的映射，也就是找到正确的页表项。然后再交给CPU，当然也可以把找到的结果缓存在TBL中，这样CPU下次使用同一个虚拟地址就省了转换这步了，老师，不知道我理解的有错吗？</div>2019-02-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/61/bc/88a905a5.jpg" width="30px"><span>亮点</span> 👍（12） 💬（1）<div>倪老师，如果进程间的虚拟内存空间独立，每个进程又有自己的页表，那么进程怎么获知其他进程占用的物理内存情况，怎么防止覆盖其他进程的物理内存块呢？</div>2018-12-24</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEKQMM4m7NHuicr55aRiblTSEWIYe0QqbpyHweaoAbG7j2v7UUElqqeP3Ihrm3UfDPDRb1Hv8LvPwXqA/132" width="30px"><span>ninuxer</span> 👍（11） 💬（1）<div>打卡day16
工作中，发生oom基本都是程序跑的，都甩给研发了～😂</div>2018-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/ac/db/51399da1.jpg" width="30px"><span>大甜菜</span> 👍（5） 💬（2）<div>malloc本身不会使用slab
只有内核中使用kmalloc才回通过slab分配内存</div>2018-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/dd/a6/adb3b1d9.jpg" width="30px"><span>圣域烈焰</span> 👍（4） 💬（1）<div>请教一个问题，使用free命令的时候，看到的buffer、cache和shared有什么区别？</div>2018-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/9b/c8/665100a3.jpg" width="30px"><span>周曙光爱学习</span> 👍（3） 💬（1）<div>虚拟内存中只有内核空间能访问物理内存吗？也就是说只有内核空间才会有页表与物理内存关联吗？那用户空间的虚拟内存怎么玩？</div>2019-03-21</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJe0esddRVdG689MicU5zMibMtkyLpYkX4MtiamKP8eFf7KUoMlfU7ficrciakyVS06jHVdskYT67JKtdg/132" width="30px"><span>湖海散人</span> 👍（2） 💬（1）<div>分配虚拟内存使用的是brk 和 mmap，在真正使用内存的时候引起缺页中断再分配真正的物理内存

请问，那这里的分配物理内存的方式是怎样的啊，是按照什么机制来进行分配物理内存，虚拟内存有内存的分段等一系列机制在管理，那物理内存呢？  在使用brk分配小内存和使用mmap分配大内存的时候，对应的物理内存的分配策略是怎样的啊</div>2019-02-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/97/61/34a0da09.jpg" width="30px"><span>Griffin</span> 👍（2） 💬（1）<div>hmmm，我要提问。老师，我的开发机是macbook。内存是16G。但是经常出现已12G，swap用了3-4G。我平时没用ide就tmux+vim，内存大户就一个dorker和chrome。卡的我不得了，每次都只能重启来缓解。发现有个windowserver占用很多。感觉16G内存开发应该完全够用才对啊，有没有mac下可以禁用swap？让内存不够的时候优先回收缓存和不常用的内存，而不是滥用swap？</div>2018-12-27</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLx1Jz78aibuoJEWdLTsDhucnVDTvkkeRX2w6ZJWXp0h7Zfe7GM6vKAx3jNhFhJJaElDCicyHpf1e9Q/132" width="30px"><span>13001236383</span> 👍（2） 💬（2）<div>老师请教两个问题第1.每个用户进程在运行时都会在用户空间的各段空间内申请自己的空间，比如说每个进程都会在栈空间申请自己的栈，在堆空间申请自己的堆空间？各进程是怎么实现访问隔离的？
2.用户态内存和内核态内存是不是只从用户进程角度来看？内核使用内存是直接分配了，还是也是需要进行映射？多谢老师。</div>2018-12-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/2f/f4/2dede51a.jpg" width="30px"><span>小老鼠</span> 👍（2） 💬（1）<div>JAVA的GC是不是也是分配内存的？</div>2018-12-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/54/98/52ca7053.jpg" width="30px"><span>Vicky🐣🐣🐣</span> 👍（2） 💬（1）<div>老师，文中说
一个进程运行占用的CPU越多，oom_score就越小
这里不应该是 一个进程消耗的内存越少，oom_score就越小吗？
麻烦老师解答一下</div>2018-12-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/34/bb/0b971fca.jpg" width="30px"><span>walker</span> 👍（2） 💬（1）<div>怎样去区分一个应用的用户态和内核态。他们在使用内存方面有什么异同。内核的内存空间不像用户内存空间一样分布吗</div>2018-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/9d/2c/6248ffbd.jpg" width="30px"><span>柏森森</span> 👍（1） 💬（1）<div>请教下buffer和cache的区别？有以下几个疑问：1）都是内存吗？2）是因为作用不同，划分的不同大小的区域吗？3）&#47;tmp目录默认是在内存中吗？</div>2019-10-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/9c/f6/30dfdc9f.jpg" width="30px"><span>Mark</span> 👍（1） 💬（1）<div>请教，内核空间其实关联的都是相同的物理内存 怎么理解？</div>2019-10-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/19/95ff4cbd.jpg" width="30px"><span>格非</span> 👍（1） 💬（1）<div>倪老师，在《深入理解计算机系统》第三版 Chapter9 虚拟内存章节，提到“CPU芯片上叫做内存管理单元（Memory Management Unit, MMU)的专用硬件，利用存放在主存中的查询表来动态翻译虚拟地址，该表的内容由操作系统管理”，&quot;同任何缓存一样，虚拟内存系统必须有某种方法来判定一个虚拟页是否缓存在DRAM中的某个地方；
这些功能是由软硬件联合提供的，包括操作系统软件、MMU(内存管理单元）中的地址翻译硬件和一个存放在物理内存中叫做页表（page table)的数据结构，页表将虚拟页映射到物理页。每次地址翻译硬件将一个虚拟地址转换为物理地址时，都会读取页表。操作系统负责维护页表的内容，以及在磁盘与DRAM之间来回传送页“，这里说的页表是存放在内存中，是不是书中的知识点过时了？</div>2019-07-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e1/21/5f0bf9a0.jpg" width="30px"><span>阿文</span> 👍（1） 💬（1）<div>RES和RSS有什么区分吗？</div>2019-07-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg" width="30px"><span>安排</span> 👍（1） 💬（1）<div>老师请教一个问题，Linux的各个进程之间的用户态是隔离的，有各自的页表。32位系统下，内核占用最高1G的内存，也就是说各个进程的这最高1G是共享的，那么在内核态的时候，最高这1G的部分访问的时候还需要页表吗？也就是内核态访存时还经过mmu吗？如果需要页表的话，那是不是内核态只需要存在一份页表就可以了，所有的进程共享这一份最高1G地址的页表？还是说内核态的页表，也是每个进程各自保存一份？</div>2019-02-25</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/wjK0unDiaUMZYGsl43dovmLWZS6WvDzpespydKfOQHDU55QPZQZvfKKYk4ZaITibGc3wwC3vqTTudWficcPhEia0Xw/132" width="30px"><span>Geek_41dcba</span> 👍（1） 💬（1）<div>刚在将内存性能几篇做一个总体的整理，在整理到对于内存页表管理感觉很像是它像是一个B+树的演变，空间占用小（如果是4级，每级表的大小是10就可以表示到一百多万），并且查询效率在O(logN)，log的底是页表的级数。如果页是大页分配时有一个说法是TLB中的命中率就提高，也就提高访问速度。那页的大小设置怎样设置才适合我们自己的应用场景，性能上除了TLB命中率以为还有那些影响了？同时在内存使用时才映射到物理内存页上，文中提到的缺页异常是不是一个中断？（我看了一遍&#47;proc下的两个中断文件内容感觉没一个有关系）</div>2019-01-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/3c/5e/6a26a8c4.jpg" width="30px"><span>licht</span> 👍（1） 💬（1）<div>多级页表可以节省内存，实际上是以时间换空间。
而大页内存是以空间换时间。</div>2019-01-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cb/0a/6a9e6602.jpg" width="30px"><span>React</span> 👍（1） 💬（2）<div>老师好，phpfpm可以分配多个子进程，假设主机中只运行phpfpm.我在计算phpfpm能够分配最大进程数时需要知道单个phpfpm进程占用的内存大小，这个占用的内存大小，我只需要计算实际占用的物理内存，即top中的res即可吗？另外通过这篇文章，我知道了为什么系统中进程占用的virt会比res和shr的总和还要大了。</div>2018-12-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/81/c2/314460b8.jpg" width="30px"><span>业祥</span> 👍（1） 💬（1）<div>nmap为什么会缺页异常?</div>2018-12-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/70/23/972dcd30.jpg" width="30px"><span>allan</span> 👍（1） 💬（1）<div>老师，free 列出的这几个数据之间的关系是怎么样的？可不可以讲一下，比如 used 是其他哪几个指标之和？</div>2018-12-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f4/b8/43a4c2c0.jpg" width="30px"><span>子轩Zixuan</span> 👍（1） 💬（1）<div>cpu和内存应该是出问题频率最高的两块内容了，期待内存篇实战</div>2018-12-24</li><br/>
</ul>