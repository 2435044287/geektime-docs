你好，我是白园。接下来我们进入变更的第三个场景——程序和数据类型的变更。今天我就来给你分享一种非常有意思的故障，这种故障连续绊倒了两个云厂商。

## 故障回顾

2024年4月8日，某云团队收到告警信息，云API服务处于异常状态。随即在某云工单、售后服务群以及微博等渠道开始大量出现某云控制台登录不上的客户反馈。经过故障定位发现，客户登录不上控制台是由于云API异常导致的。云API是云上统一的开放接口集合，客户可以通过API以编程方式管理和操控云端资源。

故障发生后，依赖云API提供产品能力的部分公有云服务，也因为云API的异常出现了无法使用的情况，比如云函数、文字识别、微服务平台、音频内容安全、验证码等。此次故障一共持续了近87分钟，期间共有1957个客户报障。

![图片](https://static001.geekbang.org/resource/image/38/13/38d987cb5f9a4acbab160b1e4a2b7313.png?wh=1654x356)

同样的事情也发生在另一家云上，不过是在2023年，云产品控制台访问及管控 API 调用出现异常。原因代码的逻辑缺陷，生成了一份不完整的白名单，进而影响了整个云API服务。

## 案例解析

![图片](https://static001.geekbang.org/resource/image/9b/32/9b3c4b7a54d3060b6196d310446ec032.png?wh=2164x1532)

### 原因解析

故障的原因是云API服务新版本向前兼容性考虑不够，以及配置数据灰度机制不足的问题。本次API升级过程中，由于新版本的接口协议发生了变化，在后台发布新版本之后对于旧版本前端传来的数据处理逻辑异常，导致生成了一条错误的配置数据，由于灰度机制不足导致异常数据快速扩散到了全网地域，造成整体API使用异常。
<div><strong>精选留言（3）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/c6/20/124ae6d4.jpg" width="30px"><span>若水清菡</span> 👍（2） 💬（1）<div>回答如你需要进行配置变更、代码发布、数据更新，那么你的执行顺序是什么?这个问题，从工作经验上来说：
首先要确认依赖关系，一般情况下数据更新不会去改变数据原始的结构，更新难度最低，可以放到最后更新。配置变更和代码发布依赖较多，经常需要对配置数据进行热更新，加一些参数或者减少一些参数都需要代码层面去支持。这样考虑下来最好的更新顺序就是：先代码更新(提供对新老配置和数据的兼容)，然后是配置更新，数据更新；后期的数据patch更新，会先更新数据，后更新配置。
</div>2024-08-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/69/7d/59143808.jpg" width="30px"><span>书豪</span> 👍（0） 💬（1）<div>先发代码，再发配置。代码必须兼容新老配置，才能可回滚</div>2024-10-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/3b/ec/a9/aae4d418.jpg" width="30px"><span>Emma</span> 👍（0） 💬（0）<div>有没有好的技术方案梳理依赖关系呢，比如说有循环依赖，不同团队的监控，组件，信息上报颗粒度，渠道都不一样</div>2024-09-14</li><br/>
</ul>