你好，我是白园，今天我们来聊聊可靠性的第四个部分—预案。

在《隋唐演义》中，程咬金以其独特的三招绝技——三板斧，战胜了众多强敌。尽管他掌握的招数不多，但每一招都运用得炉火纯青。预案也是这样，它的价值不在于数量的多寡，而在于其精准性和熟练度。

历史上，超过90%的系统故障都通过一些基础而通用的应急预案得到了有效解决。这些预案的高效和熟练运用是提高故障恢复速度的关键因素。例如，2021年B站遭遇的重大故障，就是通过执行服务回滚和系统重启的策略成功恢复的。

这节课我会给你介绍六个最常用的应急预案，并详细解释它们的执行顺序。我们将探讨如何确保这些预案能够被有效且迅速地执行，以便在面临系统故障时，能够最大限度地减少业务损失。

## 六大通用预案

六大预案就是**回滚、扩容、重启、切流、限流、降级**。这六种预案可以分为三类，第一类是几乎无损的预案，包括切流、扩容；第二类是短时间内有损的预案，包括重启和回滚；第三类是持续有损的预案，包括限流和降级。我们在选择的时候，需要看一下选择哪种或者哪几种，还有操作顺序是怎样的。

![图片](https://static001.geekbang.org/resource/image/46/40/4630f7f22f5f408d37c9b8a483c64940.png?wh=2034x790)

### **切流**

切流是一种常见的技术手段，用于在发生单机房故障时保持服务的连续性和可用性。由于流量切换是一种无损操作，它成为处理此类问题的首要选择。在服务部署时，应实施多机房冗余部署策略，至少确保两个机房的冗余，以便在一个机房发生故障时，能够迅速将流量切换到其他正常运行的机房。这里我来介绍几种常见的切流场景。
<div><strong>精选留言（4）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/13/34/b3/cf70e0f5.jpg" width="30px"><span>枕畔雪</span> 👍（3） 💬（1）<div>拆开来看：
1.变更操作故障的通用解法：回滚。
2.容量过载故障的通用解法：限流、扩容、降级非核心。

综合场景来：
一、快速止损：
1.先判断影响范围，如果故障集中在单可用区，且容量足够的话，第一时间切流到其他正常可用区，并迅速回滚。
2.如果故障集中在多可用区或者其他可用区容量不足，无法通过切部署中心快速恢复，处置效率就会直线降低。按照先止损再定位的思路做处置，止损思路如下：1.）优先回滚 2.）入口侧按照容量上限做限流，保障可承担请求的服务质量 3.）并行做扩容、降级处置。 PS：整体过程要考虑到流量、实例规模变化带来的连接数突增、缓存压力增大等链路影响。
二、快速定位：
思路：一般情况下变更和容量过载关联性不大，也就是说很可能容量过载是由其他因素导致，这里分两种场景。
1.容量过载是当前变更导致：大概率是代码 bug 引起流量放大。比如 并发数设置异常引发大量请求、各级缓存策略异常导致穿透、限流策略异常、风控策略异常等等。
2.容量过载不是当前变更导致：可能是突发热点事件导致用户请求变多，可能是上游应用调整导致主调并发数变多，可能是外部攻击等等。

最后，无论属于哪种情况，优先止损是第一原则，除非特殊情况，故障发生点的一切引起系统熵增的变更都应该迅速回滚。</div>2024-07-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/3f/0d/1e8dbb2c.jpg" width="30px"><span>怀揣梦想的学渣</span> 👍（0） 💬（1）<div>咨询一下，文中提到故障处理后，预案操作可回滚。我没能理解这部分，回滚预案操作不会导致已处理的故障复现吗。</div>2024-09-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/69/7d/59143808.jpg" width="30px"><span>书豪</span> 👍（0） 💬（2）<div>限流的漏斗模型应该是反的，如果上游限10000，下游限8000，那么在流量9000时，上游放行下游拦截且是强依赖，则上游的请求处理白费了系统资源</div>2024-08-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/52/d2/a0a800e9.jpg" width="30px"><span>奔跑的阿飞</span> 👍（0） 💬（2）<div>尝试回答一下：上线过程中出现故障，应该是上线导致的故障，这时候应该快速回滚。同时出现容量过载，可能是出现故障导致的雪崩效应，可以通过自动扩容或降级不分非核心业务措施处理。</div>2024-07-22</li><br/>
</ul>