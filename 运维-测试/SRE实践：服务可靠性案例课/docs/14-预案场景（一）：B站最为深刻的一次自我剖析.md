你好，我是白园。

今天我们开始进入预案场景故障的分析。这节课我们就来分析一下 [B 站 2021 年 7 月 13 日的故障](https://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg%3D%3D&mid=2247487272&idx=1&sn=038a30ce61706c97e3397eee982b1486&scene=21#wechat_redirect)这也是我见过的公司对自身故障剖析得最详细的一次，我们来看看能从中学习到什么内容。

## 故障回顾

7月13日23时许，B站客户端和网页端均出现访问故障，无法打开，页面提示“正在玩命加载数据”。不久后，“B站崩了”话题也迅速登上微博热搜。14日凌晨B站网页端和App才恢复正常。

22:52是故障开始的时间，SRE团队接到了关于服务和域名接入层不可用的多起警报。与此同时，客服部门接到了大量用户反映B站无法访问的反馈，公司内部员工也报告了相同的问题，包括App首页加载失败。根据报警信息，SRE团队迅速把注意力集中在可能的基础设施故障上，包括数据中心、网络连接、四层负载均衡器（L4 LB）和七层负载均衡器（L7 SLB）。为了迅速应对，SRE团队立即启动了紧急语音会议，并召集了所有相关团队的成员进行紧急处理。

![图片](https://static001.geekbang.org/resource/image/1b/7a/1b311d9c67cab2eebfbf5cbc94728f7a.jpg?wh=2790x2598)

**故障原因：7 层接入 SLB 代码 Bug**

B站在2019年9月份，迁移到了OpenResty，通过服务在注册中心的权重变更，来实现SLB的动态调权，从而实现更精细的灰度能力。在某种发布模式中，应用的实例权重会短暂地调整为0，这个时候注册中心返回给SLB的权重是字符串类型的0。这个时候由于lua语言的特性并不会强制转化字符串的0为数字0，程序就会陷入到死循环进而把worker打死。
<div><strong>精选留言（1）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/52/d2/a0a800e9.jpg" width="30px"><span>奔跑的阿飞</span> 👍（2） 💬（2）<div>大规模的故障演练，肯定得来自老板的支持，否则给自己挖坑。
说服老板主要有以下方面
1.故障演练可以发现生产环境的架构缺陷，可以有针对性的制定应对措施和应急手册。
2.后续万一真发生故障，可以参考应急响应手册，进行快速排查定位，将故障中断时间缩短。
关于不影响线上业务做演练
1.选择业务的低峰时间及有冗余的服务进行演练。
2.演练前，制定演练计划及措施，以防发生异常情况进行处置。
3.演练后，进行总结覆盖，形成改善计划。</div>2024-08-14</li><br/>
</ul>