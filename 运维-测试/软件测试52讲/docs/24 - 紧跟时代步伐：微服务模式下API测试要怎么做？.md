你好，我是茹炳晟，今天我分享的主题是“紧跟时代步伐：微服务模式下API测试要怎么做？”。

通过一个的Restful API实例，我介绍了cURL和Postman工具的基本用法，这样我们对API测试有了一个感性认识；在此基础上，我介绍了API自动化测试框架发展的来龙去脉，借此我们对API测试框架的理解又更深入了一层。

今天，我将更进一步，带你去了解当下最热门的技术领域的API测试，即微服务模式下的API测试。微服务架构下，API测试的最大挑战来自于庞大的测试用例数量，以及微服务之间的相互耦合。所以，我今天分享这个主题的目的就是，帮你理解这两个问题的本质，以及如何基于消费者契约的方法来应对这两个难题。

而为了掌握微服务模式下的API测试，你需要先了解微服务架构（Microservice Architecture）的特点、测试挑战；而要了解微服务架构，你又需要先了解一些单体架构（Monolithic Architecture）的知识。所以，今天的话题我将逐层展开，目的就是希望你可以真正理解，并快速掌握微服务模式下的API测试。

## 单体架构（Monolithic Architecture）

单体架构是早期的架构模式，并且存在了很长时间。单体架构是将所有的业务场景的表示层、业务逻辑层和数据访问层放在同一个工程中，最终经过编译、打包，并部署在服务器上。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/f4/5e/8416375a.jpg" width="30px"><span>小明同学</span> 👍（12） 💬（2）<div>你好，我想问下接口测试下这个代码覆盖率是怎么统计的？</div>2018-08-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4c/b0/f22017b0.jpg" width="30px"><span>楚耳</span> 👍（11） 💬（1）<div>api gateway 并不是每个服务间都存在的，只有面向客户端的服务才会有这一层。内部服务间是不存在在这一层的。所以这种方式去过滤不是很全面</div>2018-12-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/af/3d/28b61e6b.jpg" width="30px"><span>假装乐</span> 👍（5） 💬（1）<div>期待文末问题的答案</div>2018-08-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/55/26/154f9578.jpg" width="30px"><span>口水窝</span> 👍（1） 💬（1）<div>现在待得的公司还是传统的单体架构，没有接触到微服务架构，这篇文章给我打开了一个全新的视角，思路上也有很多。</div>2019-04-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/c3/fd/f4663263.jpg" width="30px"><span>emilymeng</span> 👍（1） 💬（1）<div>老师，能详细讲解一下代码覆盖率的测试方法和使用到的工具?</div>2018-08-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/77/72/8f77ddb0.jpg" width="30px"><span>johnny</span> 👍（0） 💬（1）<div>这篇文章也有助于理解文中提到的的实例代码。
http:&#47;&#47;www.bubuko.com&#47;infodetail-2317705.html</div>2019-01-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/11/5a/9d808df4.jpg" width="30px"><span>yinyin</span> 👍（0） 💬（1）<div>如果依赖的服务是中间件，能用mock代替吗？</div>2018-09-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/63/cb/7c004188.jpg" width="30px"><span>和你一起搬砖的胡大爷</span> 👍（24） 💬（0）<div>api gateway一般是作为整个微服务的入口，做一些权限校验，路由功能，服务间的内部调用不走api gateway。spring cloud的例子 zuul作为api gateway，load balancer是ribbon。要去抓取调用记录在被测服务记录访问日志。这个作为audit  log本来就是要记录的。我们的契约测试是调用放手写在被调用服务，拥有者是调用方。以此来确保api的兼容。</div>2018-08-22</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK6xc7vGca4Kv6ShoXVr2skyGDfic0jxRicU6rLzXAyj6iaJZldLMvuXuiahsghZR8CTLdHBtqoIuibhmA/132" width="30px"><span>ghost</span> 👍（9） 💬（0）<div>这个问题有点尴尬的是，如果开发的代码进行了变动，以前测试的契约文件（mock）就错了。茹老师我想知道，这块怎么能把开发的代码变动和mock文件关联起来。</div>2020-03-17</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83eppQqDE6TNibvr3DNdxG323AruicIgWo5DpVr6U7yZVNkbF2rKluyDfhdpgAEcYEOZTAnbrMdTzFkUw/0" width="30px"><span>图·美克尔</span> 👍（8） 💬（0）<div>感觉基于消费者契约这种方式也没有显著降低case的数量啊</div>2018-08-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8c/95/4544d905.jpg" width="30px"><span>sylan215</span> 👍（7） 💬（1）<div>1.微服务架构、单体架构、消费者契约，学到几个新的概念，涨姿势了；

2.对微服务架构，之前确实没有深入了解，我知道的是现在的 App 多采用插件的方式进行功能更新和维护，我们这边的客户端也是类似的，这种插件模式感觉是介入微服务和单体架构之间的，就是整体上还是一个整体，但是可以在整体的各个位置进行功能的插入并独立维护，既达到了整体的一致性，同时也满足了可扩展性、可维护下、少依赖性，不知道和这个微服务架构是不是一回事；

3.基于消费者契约的测试，我有一个疑问，消费者契约基于的是用户的常规操作，这部分的用例是 P1 级别必须覆盖的，但是对于某些环境异常导致的问题，可以就不会覆盖到，因为属于非用户操作，比如我们 windows 系统的某个 API 的入参是一个指针，而这个指针是上一个函数的返回值，理论上，这个返回的指针肯定有效，所以开发在接收入参后也没有校验参数的合法性，但是因为环境异常，导致就是出现了空指针，那么从消费者契约角度看，用例没问题，从代码覆盖率角度看，也没问题，但实际上确实出现了问题，所以，在有限的时间内我们当然会按优先级执行用例，但是不是还是需要从功能测试角度保证用例的覆盖率？如果我有理解不正确的地方，请批评指正。

以上，欢迎沟通交流，公众号「sylan215」</div>2018-08-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/c8/b7/2ef830e4.jpg" width="30px"><span>三生三世</span> 👍（3） 💬（0）<div>很有深度，理解不透</div>2018-08-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/da/88/09ccab4a.jpg" width="30px"><span>颜瑞</span> 👍（2） 💬（0）<div>在大部分微服务的接口维护中，推荐使用swagger工具维护接口，贵司有维护接口文档么？是用什么工具呢？
另外一个关键点mock service，接口json文档的来源是开发维护的还是从API Gateway抽取的？mock service是用什么工具启动的呢？</div>2018-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/d4/c3/d41e8c79.jpg" width="30px"><span>不将就</span> 👍（1） 💬（1）<div>老师，您说的“如何获取Service的契约”，是采用了搜集的方式，只有有了用户调用以后才可以搜集到，那么如果实际场景中，更多的是我们新开发了一个接口，在上线前需要测试，这时候其实还没有用户调用，那怎么搜集这些契约呢？是不是没有办法？</div>2020-07-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/dc/33/a68c6b26.jpg" width="30px"><span>捷后愚生</span> 👍（1） 💬（0）<div>学习文章后，接触到的新概念：微服务、基于消费者契约的 API 测试、API Gateway。
自己现在没有接触微服务API测试，看完老师的文章，觉得老师把知识点讲的相当清楚在，赞。听了音频没完全理解，再细看文字，理解了整体的思路。
觉得老师这句话讲得很好：讲清楚某一技术的来龙去脉及其应用场景，但是很多具体操作级别、代码实现级别的内容，还是需要你在实践中不断积累。
以后工作如果有机会，一定得多实操才行。</div>2020-07-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/8c/df/4d77c1ca.jpg" width="30px"><span>陈九思</span> 👍（1） 💬（0）<div>实际项目中，消费者契约测试，是否可以通过openapi的规范接口定义自动生成测试用例？这样可以省去录制的时间，也可以将测试的设计提前。</div>2020-02-05</li><br/><li><img src="" width="30px"><span>脊椎疼</span> 👍（1） 💬（1）<div>期待的测试框架访问数据库，消息队列的部分没有展开说一下。我现在只能写代码来实现。有没有比较成熟的解决方案？或者比较好的实践。</div>2019-12-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/d0/7c/868ccb4a.jpg" width="30px"><span>倔强的潇洒小姐</span> 👍（1） 💬（0）<div>之前经常听Mock，但不是很明白原理，这次算是听明白了，谢谢茹老师的讲解</div>2019-08-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4c/b0/f22017b0.jpg" width="30px"><span>楚耳</span> 👍（1） 💬（1）<div>老师能讲讲api测试中，用例设计这块吗，到底是只做单接口测试还是也要做用单接口串联起来做场景测试，这两块用例分别要怎么设计？</div>2019-06-01</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLnYfSUc8hJ3oLfa39qkNiaXNibs3VyAbgT7ZXasZXp89fRL7YBakIZdNNEE7kClOjN2KpBUuGpacfQ/132" width="30px"><span>wanj</span> 👍（1） 💬（0）<div>怎么才能打印出所有的日志，需要先进行手工测试所有功能吗？</div>2018-10-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/19/7d/e329ae18.jpg" width="30px"><span>白色枫叶</span> 👍（0） 💬（0）<div>感谢茹前辈的分享，让我对微服务架构下的API测试有了进一步理解：
1. 单体架构和微服务架构各自的优缺点。2.通过消费者契约，使用工具记录&#47;分析出线上（或预置了足够测试数据的demo环境）所有RQ和RS的组合场景，从而解耦（即mock掉）ServiceX和ServiceY，实现对ServiceT功能级覆盖。3.启用代码覆盖率统计来分析漏测场景。
个人探讨：
此处ServiceT可以是链条式的微服务集合体（该集合体进出的RQ和RS关系既定），而ServiceX和ServiceY是 该集合体（ServiceT) 的外部依赖。我想表达前辈此处教的是拆解耦合的方法，但不是每个微服务都需要拆解开测试。从消费者契约角度出发，有时候把他们连起来测更省时省力（只Mock该链条的头和尾）。</div>2023-01-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8c/5c/3f164f66.jpg" width="30px"><span>亚林</span> 👍（0） 💬（0）<div>抓包</div>2023-01-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c3/33/ab8bafa0.jpg" width="30px"><span>小强</span> 👍（0） 💬（1）<div>mock数据的方式仅仅是在服务上线后才能拿到？。。那怎么在服务上线前保证质量呢？</div>2022-07-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/63/b1/6b9b9d8e.jpg" width="30px"><span>熊猫宝宝</span> 👍（0） 💬（0）<div>代码覆盖率的那个图是怎么出来的？，用什么工具啊</div>2022-06-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/3f/39/a4c2154b.jpg" width="30px"><span>小昭</span> 👍（0） 💬（0）<div>只做过单体架构的接口测试，以后接触微服务架构的接口测试再来复习一下~</div>2021-12-05</li><br/><li><img src="" width="30px"><span>纪泽和</span> 👍（0） 💬（0）<div>这一节和上上节的一些链接都没用了</div>2021-11-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5d/31/2ccc4675.jpg" width="30px"><span>金子般的心</span> 👍（0） 💬（0）<div>Spring Cloud 的Sleuth可以完成调用关系记录吧?</div>2021-08-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/c7/1c/e59a699b.jpg" width="30px"><span>海朋森</span> 👍（0） 💬（0）<div>这篇总结太超值了，我作为测试，分别开发过单体架构以及微服务架构的测试项目，从demo角度出发，了解到了这两者带给测试的便利性和挑战性</div>2021-06-07</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK6oBCs8X9XzHVlaIRUpnoaBd9AvMVwOcr0pVFvScNzhezrCa6xLyTLtFibYStPrjkV73UKUxbAIFA/132" width="30px"><span>Geek_xiaoxi</span> 👍（0） 💬（0）<div>只测试调用的API，没调用的API不管，那没被调用的API存在的意义是什么？他们没有被用，为什么还要写呢？还是说现在他们没有被用，后边可能会被用到，用到的时候再去测？</div>2021-01-06</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q12j0kibBQKXxqwZQmNFHRozpbgaIjnfX6XzBu5OZYvHlvOfB2ibKRU73XvyEuuShBTINDhEKULPxdm6WRwnVRWA/132" width="30px"><span>Five-Tool</span> 👍（0） 💬（0）<div>茹老师好，请问国外有什么做接口自动化比较好的工具或者平台吗，收费的也可以，无论是否免费开源的，我对国外的工具或者平台真的是了解的太少了，先感谢。</div>2020-12-17</li><br/>
</ul>