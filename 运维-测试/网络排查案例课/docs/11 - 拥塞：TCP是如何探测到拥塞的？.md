你好，我是胜辉。

前面两节课，我们通过真实的案例，一起学习了TCP传输方面的知识，比如其中的核心概念：往返时间、接收窗口和发送窗口、在途字节数，还有推导出来的核心公式。

当然，在实际场景里，我们可以直接利用Wireshark的I/O Graph查看速度趋势图，这样最方便，并且有不同时段的速度，方便我们对整体状况做全面的评估。

不过，不知道你有没有发现，TCP传输的起始阶段，速度都是从低到高升上来的，很少有一上来就直接以最终速度运行的情形。其实，这个行为跟 **TCP拥塞控制**有着密切的关系。所以这节课，我会带你了解什么是拥塞窗口、TCP是如何检测和避开拥塞的。这样呢，以后你处理TCP拥塞相关的问题时候，就能有的放矢，做到有针对性的分析了。

好，让我们来看一个具体的案例吧。

## 案例

在公有云服务的时候，我们有个银行的客户，他们有一次需要跨机房拷贝一个大文件，也就是用SCP命令，把文件从公有云机房拷贝到他们的自建机房。但是客户发现速度比较慢，让我们看一下原因。

![](https://static001.geekbang.org/resource/image/c8/5b/c88359c7b0889fe31436bd1424b0015b.jpg?wh=1686x539)

架构上说，客户自己的机房在上海，公有云上的资源则在北京。地理位置相差很远，而且机房所属的性质也完全不同，那两者如何通信呢？走公网的话不太安全，而且速度和质量没有保障。
<div><strong>精选留言（11）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/eb/09/ba5f0135.jpg" width="30px"><span>Chao</span> 👍（10） 💬（2）<div>慢启动阈值 （ssthresh）的初始值是如何确定的，当慢启动过程中没有进入重传状态，如何进入拥堵避免？</div>2022-02-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg" width="30px"><span>那时刻</span> 👍（5） 💬（3）<div>请问老师两个问题
1. 拥塞避免，直到探测到拥塞，然后拥塞窗口就要往下降。请问如何探测拥塞呢？依据接收方的接收窗口与in flight数据大小吗？是不是还有其它方法？
2. 快速恢复，如果遇到超时，也一样要回到慢启动阶段，重新开始。请问这个超时时间是多少呢？可改配置吗？</div>2022-02-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/18/81/83b6ade2.jpg" width="30px"><span>好吃不贵</span> 👍（4） 💬（2）<div>请教老师一个问题哈，可以服务端，客户端用不同算法吗？比如server用BBR，client用CUBIC? 多谢哈</div>2022-03-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/21/b8/aca814dd.jpg" width="30px"><span>江山如画</span> 👍（4） 💬（11）<div>老师，有个小问题，在慢启动的时候，每收到一个 ack 报文，拥塞窗口就加 1 个mss，不太清楚为什么拥塞窗口这个阶段是翻倍增长。 图上看慢启动阶段，第一次发送了1个报文，第二次发送了2个报文，第三次发送了4个报文，是因为慢启动阶段，每次都发出上一轮的2倍的报文数目，达到翻倍增长的目的么？</div>2022-02-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f9/e6/47742988.jpg" width="30px"><span>webmin</span> 👍（3） 💬（1）<div>流量图上观察到“平顶山”就一个最明显的流量达限的情况，一但出口流量达到上限就容易引发相互踩踏的情况，传不出去，使用的人就更着急，就会点击更多次，或者多窗多设备重试，引发更多的拥塞。</div>2022-02-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/c1/0e/2b987d54.jpg" width="30px"><span>蜉蝣</span> 👍（1） 💬（1）<div>老师，对于 io graphs 而言，我还是不明白什么时候需要选择 SAM period 的值，选择多少更合适</div>2022-08-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d4/f3/129d6dfe.jpg" width="30px"><span>李二木</span> 👍（1） 💬（1）<div>TCP 拥塞控制主要有四个重要阶段：
- 慢启动
        慢启动是指 TCP 传输的开始阶段是从一个相对低的速度开始的。在这个阶段，每次 TCP 收到一个确认了数据的 ACK，拥塞窗口就增加一个 MSS。如果到达慢启动阈值塞窗口的增长速度立刻就放缓了，变成了每过一个 RTT，拥塞窗口就只增长一个 MS
- 拥塞避免
    传输过了慢启动阈值（ssthresh）之后，进入拥塞避免阶段。这个阶段的特征是“和性增长乘性降低”（ Addictive increase&#47;mutiplicative decrease），简单理解就是增长很慢。
    每一个 RTT里，拥塞窗口只增长一个 MSS，这个阶段的拥塞窗口的增长是线性的。如果探测到拥塞，拥塞窗口就要往下降。这个下降是直接减半的，所以叫乘性降低
- 快速重传
        TCP 每发送一个报文，就启动一个超时计时器。如果在限定时间内没收到这个报文的确认，那么发送方就会认为，这个报文已经在网络上丢失了，于是需要重传这个报文，这种形式叫做超时重传，而快速重传是一旦发送方收到 3 次重复确认（加上第一次确认就一共是 4 次），就不用等超时计时器了，直接重传这个报文
- 快速恢复
        跟之前的“慢启动 -&gt; 拥塞避免 -&gt; 慢启动 -&gt; 拥塞避免”这种做法不同，在遇到拥塞点之后，通过快速重传，就不再进入慢启动，而是从这个减半的拥塞窗口开始，保持跟拥塞避免一样的线性增长，直到遇到下一个拥塞点。</div>2022-02-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/37/a0/032d0828.jpg" width="30px"><span>上杉夏香</span> 👍（6） 💬（0）<div>三刷笔记：
* 为什么TCP要有拥塞机制？
是让每条TCP连接拥有敬畏之心。展开来说，每条TCP连接都需要拥塞控制，如果每条TCP连接都放飞自我、敞开了的发送数据，网络带宽肯定经受不住，最后的结局就是谁都无法发送数据。

那好，我们约定好，TCP建立一套探测网络线路是否快要达到上限的机制。若探测到，那我们就自动减缓速度。如此一来，不仅让网络整体可用，也能确保自己的传输速度和稳定性。这就是TCP的拥塞控制。

* 拥塞机制是什么样的？
每条TCP连接设立发送数据速度的红线，探测到红线，就立马减缓速度。

探测到红线的标志是发生丢包。

* 是什么让拥塞机制变得复杂的呢？
一句话回答：网络是动态变化的。
之前达到红线的发送速度此时已经不怎么丢包之类的，所以拥塞机制中的红线是不断变化的，而每条TCP连接都是需要不断探测的。

* 一脉相承之更好的利用现代网络
什么叫做更好的利用现代网络呢？其实没什么可玄乎的，就是现代的网络传播速度比以前好太多了。所以TCP也进化了，具体表现在哪里？

我们可以这么来理解和记忆，决定发送端发送速度的因素有两个：1、对方的接收窗口；2、自己的拥塞窗口

1、接受窗口
TCP协议本身有一个2字节的Window字段，表示能够接收的数据大小，最大为2^32-1=65535字节。为了更好的利用现代网络，有了TCP Option的Window Scale，得了，一下子就把接受窗口的上限拉高了太多

2、拥塞窗口
一般来说，发送阶段分为慢启动、拥塞避免、快速重传、快速恢复等阶段。其中慢启动阶段，由Linux最初的版本决定，初始拥塞窗口2-4MSS。那么为了更好的利用现代网络，初始拥塞窗口一下子调整为10MSS。

发送能力的提高一目了然，也就有了更快的慢启动！

* 什么是拥塞点，或者说什么叫做碰到了拥塞点？
其实就是丢包。丢包就代表碰到了拥塞点！


* 什么是快速重传？
为了优化超时重传机制中每次都得等特定时间才能确定某个包丢失。快速重传的本质是接收方告知发送方，某个包应该是丢失了，你不用等倒计时了，直接发给我吧~

* 快速恢复

一句话总结：
普通的拥塞策略：慢启动-&gt;拥塞避免-&gt;碰到拥塞点-&gt;慢启动-&gt;拥塞避免-&gt;碰到拥塞点，碰到拥塞点之后，从头开始。

如果拥塞点之后，是通过快速重传发送丢失的包，那就不必重新从慢启动开始。而是直接将拥塞窗口设置为拥塞点的一半，直接进入拥塞避免阶段。</div>2022-11-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2a/82/90/086de45a.jpg" width="30px"><span>萝卜橙子西红柿</span> 👍（0） 💬（0）<div>老师，现在使用wireshark 3.6及以后的版本，查看这课的抓包文件不会显示duplicate ack，因为这课抓包文件是限制到74字节了，这样接收端ack的数据包里的TCP opinion的SACK缺少right edge，wireshark不显示为dup ack了，除了使用低版本还有何解呢。。？</div>2024-07-05</li><br/><li><img src="" width="30px"><span>Geek_dbfde6</span> 👍（0） 💬（0）<div>会不会是接收窗口太小了呢？接收窗口最大也才 1975字节
从数据接收方的角度来看，从99147-99198 总计19个报文，确认了45804个字节（78559569-78513765），总计耗时0.2s，因此速度为：45804&#47;0.2=229KB。</div>2024-05-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/36/8b/7a/ec36ff82.jpg" width="30px"><span>原则</span> 👍（0） 💬（0）<div>老师，有几个问题：
1. 这里到了慢启动阈值应该不是增长一个 MSS 吧，而是当前 MSS +1，和慢启动过程有点混淆了。
2. 间隔确认不是 RFC 中定义的吧
3. 快速恢复怎么感觉不太快，如果使用慢启动的方式翻倍增长是不是更快。</div>2023-06-05</li><br/>
</ul>