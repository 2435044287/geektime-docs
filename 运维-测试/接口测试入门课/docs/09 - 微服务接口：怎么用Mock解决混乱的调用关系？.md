你好，我是陈磊。

欢迎你继续和我一起学习接口测试，到目前为止，我们已经学习了接口测试的逻辑模拟，也就是测试辅助工具和测试脚本代码，也学习了如何选取和通过代码调用测试参数，掌握了这些内容，你就算是一个接口测试的老手了。无论你的被测接口是一个你熟悉的协议，还是一个陌生的协议，它们都不会耽误你的工作进度了。

这节课是我们专栏的最后一节课，我想给你讲一讲关于微服务的接口测试。

现如今在我的工作中，我主要面对的就是微服务测试，每个服务都是RESTful接口。在最开始的微服务改造过程中，我的测试其实比之前的业务测试更容易，每一个接口通过测试框架来编写测试脚本就可以完成执行了，而且一次写完后再通过平台调用，也显得很轻松。但是这种美好的场景并没有持续多久。为什么呢？ 你先听听我的故事。

## 微服务下混乱的调用关系

开发团队开始采用微服务架构开发系统的时候，我的测试团队也开始同步学习对应的测试技术，我也像从前一样，逐步封装自己的测试框架，并且采用Postman和Python代码，完成接口测试脚本的快速积累，同时引入了参数类，完成了Excel参数的封装调用。

在开始的一些项目中，只要开发工程师提交了代码仓库主干的合并请求后，除去代码的静态扫描外，持续集成平台会自动调取一个开源的智能化单元测试框架，来完成单元测试，通过后它会自动部署被测系统，然后再执行测试脚本，这整个流程全部是流水线自动驱动完成的。
<div><strong>精选留言（24）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg" width="30px"><span>aoe</span> 👍（24） 💬（3）<div>看到这篇，测试同学已经和程序员不相上下了。作为一名Java程序员，收获很多，十分感谢！也有几个问题请教您：

1. 测试的微服务混用通信方式（HTTP同步、消息中间件异步），这时除了使用mock服务器测试，是否也需要搭建“消息中间件”才能完成测试？还是可以用HTTP代替？

2. 老师在工作中是否遇到过对底层工具、核心类代码做“微基准测试”？如果有，一般哪部分代码需要进行此类测试？

3. 能否分享一下接口测试时常用的异常数据？例如：类型不一致、空字符串、超出长度、必传参数为空，SQL注入语句、传多个无效参数占用带宽、POST提交时包含10M+甚至更大容量的信息等。</div>2020-02-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（9） 💬（2）<div>OK，最后一节小结一下：
1：测试的痛点？
1-1：测试环境的搭建，微痛，一般都易解决
1-2：测试工具的搭建，稍痛，有现场工具也可以自己弄，关键是对接口的入参、出参、自动化的认识和积累，这是本专栏重点阐述和解决的问题
1-3：测试业务的积累，这个是一个针对简单业务不存在的问题，对于复杂业务需要不断积累的问题，对于接口测试比较难克服的问题，输入A返回B怎么判断这是一个OK的用例？复杂的接口，不敢说千变万化，不过一个接口可以有十几二十几中的输入又有十几二十几重的响应是很正常的，不了解业务基本判断不出来是否OK。这个每个企业的业务不同复杂度不同，不能一概而论，除了自己多和产品、研发以及其他了解的人多沟通，自己多思考多总结多积累，好像没有什么好法子，当然，如果项目文档比较完善也在持续跟进到是一种捷径
1-4：测试依赖问题，包括专栏里提到的外部服务依赖，另外就是测试数据依赖，目前我的经验是为了提高响应速度，微服务是依赖缓存数据进行计算的，不过缓存数据并不是从数据库直接放进去的需要经过复杂的计算，这种情况会到是测试链条拉长，需要配置数据刷新缓存，然后才能开始接口测试，有于业务本身的复杂性，不理解业务其实就是没法开展的。这个专栏里并未提到，我们目前的做法是隔离研发和厕所环境，测试环境的数据保持纯洁性，然后再进行定时任务的刷新，使依赖数据可以一直维持。
1-5：性能测试，接口测试功能OK，仅是其一，性能也很重要。也是接口测试内容，这个具体也有一些具体的方法和工具。并且有些问题仅通过功能测试是难以发现的，比如：线程安全问题，代码逻辑导致的性能差的问题。
2：专栏讲的核心内容？
2-1：利用工具提高效率，有现成用现成，没有就自己造
2-2：工具怎么造，封装、抽象、迭代，提高编码能力
3：有些收获，了解测试或者说接口测试思路，主要是时刻保持工具可复用化的观点。这个需要，工作生活中，养成这样的习惯。</div>2020-02-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg" width="30px"><span>每天晒白牙</span> 👍（6） 💬（1）<div>看到&quot;挡板&quot;这两个字，一下子勾起了我16和17年在一家第三方支付公司的经历，那时候也是需要依赖第三方，然后测试的时候需要让下游服务加个&quot;挡板&quot;，那个时候听着觉得好玩儿，后面才慢慢知道就是返回假数据，也就是mock</div>2020-02-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/4b/75/71845744.jpg" width="30px"><span>VeryYoung</span> 👍（3） 💬（2）<div>文中有提到一款智能化单元测试框架，能请问下该框架是哪个吗？</div>2020-02-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ae/f5/a17bbcc9.jpg" width="30px"><span>蜡笔小新爱看书</span> 👍（2） 💬（2）<div>Mock服务，可以理解为Charles的Map Local功能么？</div>2021-01-01</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIykVsmj7PDjEeaUYyNVCA9SialFic98Swh6uF0hoqoEIrwU6D6cfNqeJibk9s8jGHtiatDeeoCEVW4OQ/132" width="30px"><span>sincoolvip</span> 👍（2） 💬（1）<div>快看完了再由衷的评价，此课程作为一个指引 ，是非常好的，可以看得出作者的测试开发功底，对于有基础的同学来讲，一个指引就够了。所以还是挺好的一个课程。</div>2020-05-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/eb/19/0d990b03.jpg" width="30px"><span>ZeroIce</span> 👍（2） 💬（1）<div>似乎问题很多都已经不属于接口测试的问题了😖</div>2020-02-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/58/49/985d98c8.jpg" width="30px"><span>smallfish</span> 👍（1） 💬（1）<div>一个很有趣的观点，json、python和java的学习成本对比，其实我想表达一个观点，对于测试人员，java优势比python大，我的观点如下：1.java市场占有率太高，开发使用的大概率是java，而测试是和开发使用的同一门语言，就会有共同话语，这样开发就会更好沟通，提高测试效率；2.所谓【人生苦短，我用python】，但其实现在IDE工具很强大，只需要负责关系逻辑代码就OK，一个玩笑话：写ython的都是使用游标卡尺量间距；3.大量的测试工具，都是使用java进行开发的，对于后期的扩展，java拥有很大的优势；4.java的学习成本并没有老师你说的那么夸张，那是对于开发人员来说的，对于测试人员，学基础就够用了，和python我的感觉是差不了太多。
老师讲的mock使用这种场景，我的实际工作中并没有遇到过，我们提测都是一次所有微服务同时提测，不会存在依赖性的服务，一个提测一个没有提测。但实际工作中mock服务还是很有用途的，我是这么使用的，是在开发开完接口设计评审和输出设计文档后，mock出接口，编写测试用例时，可以进行模拟调用，测试一下自己的用例是否OK。但老师讲的这个也是一个思路，可能有些公司会遇到这样的问题吧。</div>2020-03-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/c4/c5/909a7e44.jpg" width="30px"><span>random0</span> 👍（0） 💬（1）<div>请问老师，如果已经通过mock服务测试完成，此时其他服务也已经正常，这时仍需要按正常流程回归一遍吧？</div>2021-03-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/dc/33/a68c6b26.jpg" width="30px"><span>捷后愚生</span> 👍（0） 💬（1）<div>本文总结


为什么需要mock？
a服务--b服务--c服务，需要测试a服务，但是b服务或者c服务有问题，不能返回报文或者不能返回正确的报文
a系统--b系统--c系统，需要测试a系统，但是b系统或者c系统有问题，不能返回报文或者不能返回正确的报文
所以需要一个工具模拟返回的报文，这可以保证a能顺利的测试，这就是mock服务或者挡板工具。

怎么选取mock工具？
1.学习成本低、上手快并且完全适合你自己技术栈的 Mock 框架
2.Mock 服务容易修改和维护
3.处理速度快
4.Mock 服务要能轻量化启动，并且容易销毁

除了老师提到的mock工具，其实fiddler也是可以做mock测试的，老师怎么看？</div>2020-11-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/d6/09/e9bfe86f.jpg" width="30px"><span>夜歌</span> 👍（0） 💬（2）<div>老师您好，没做过微服务，所以有个想问的问题：微服务接口是怎么测试的？我想测试接口b，但接口b依赖接口a，但这是接口b在服务端调用的接口a，我该怎么mock接口a？难道说测微服务都是把被测接口的代码部署到自己本地运行，然后mock、改调用，再测试的？没做过，所以猜想是不是这样，要不感觉够不到让接口b改为走mock接口。</div>2020-04-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/c8/03/ae1d1057.jpg" width="30px"><span>西</span> 👍（0） 💬（1）<div>Mock服务，阻隔关联性，可做一个通用“替身”，自定义返回值。</div>2020-03-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/d1/da/ee19903b.jpg" width="30px"><span>明</span> 👍（0） 💬（1）<div>实现分成自动化测试就要靠mock服务框架了，是吗</div>2020-03-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/75/9b/611e74ab.jpg" width="30px"><span>技术修行者</span> 👍（0） 💬（1）<div>在有mock的情况下，一般会有一个特殊的环境或者特别的部署来执行测试。在微服务架构下，可能会有很多的微服务，微服务之间的调用链会很长，在创建mock的时候需要注意：1. 哪些服务需要做mock处理，2. 服务调用时，需要哪些服务调用会调用mock服务。这两部分，都需要开发团队介入，和测试团队一起完成。在这种情况下，基于不同的测试场景，一个微服务可能会部署多个版本，对于服务网关的配置也会是一个挑战。</div>2020-02-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/d7/45/0ae73cb6.jpg" width="30px"><span>Tomorrow</span> 👍（0） 💬（1）<div>老师您好，看见有同仁也在请教mock服务器定向访问的问题，关于这块我也想多请教一下～之前做过一个跟三方合作项目的自动化，在自动化的时候将三方接口都给mock掉了，在运维的帮助下，搭建了一个mock服务器，当时运维就给了我几个根路由，我只用在接口调用的时候带上相应的根路由+path，发出的请求就会自动发送到mock服务器上，而不去调用三方的接口。请问为啥在未改动相应开发代码的前提下，可以实现请求的转移的呢？或者有无相应的资料可以推荐我自行去查阅，感谢🙏</div>2020-02-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/c3/6c/d24a23a7.jpg" width="30px"><span>彦鋆</span> 👍（0） 💬（1）<div>我在工作中也遇到过使用Mock服务测试的情况；我们的软件是为生产产线服务的，代码分业务层代码和物理层代码，物理层的代码主要需要和机器仪器交互，由于生产环境紧张，所以我们需要验充分验证业务层的代码逻辑，就需要模拟物理层的接口返回。我们先在生产环境用Fiddler抓取接口返回数据，然后使用自己的MOckf服务完全模拟物理层的返回数据充分验证业务层的代码。  还有个问题想问问老师，mock服务和打桩测试有什么区别？</div>2020-02-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7d/41/3c5b770b.jpg" width="30px"><span>喵喵喵</span> 👍（0） 💬（1）<div>打卡～</div>2020-02-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/08/12/9c7ea83a.jpg" width="30px"><span>徐锦</span> 👍（0） 💬（1）<div>老师你好，微服务中mock服务搭建好后，怎么路由到“替身”服务呢？面对微服务的主控，服务注册这些都不是很懂。</div>2020-02-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/6a/be/58b520d9.jpg" width="30px"><span>Vengy</span> 👍（0） 💬（1）<div>有个很头疼的问题想请假老师。 push推送 能mock吗？ 公司的推送平台经常出问题，而且最近在家办公，测试环境push更是难通。如果不能mock，有什么解决的方案或方向吗？求指明，谢谢！</div>2020-02-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/da/11/bdffffa6.jpg" width="30px"><span>派森</span> 👍（0） 💬（1）<div>老师好，没用过mock，这块空白，所以几个小问题请教下，
1.我怎么样主动发现被测接口是有外部系统依赖的呢，有时候我并不知道存在这样的依赖关系
2.如果我依赖的不是一个另一个系统，而是一个数据库，这个也可以mock掉？
3.对于那些有外部依赖的被测接口，不同的接口依赖的返回结构也是不同的，怎么去描述这种结构呢？而且我在测试A接口的时候，并不清楚它依赖的B接口的接口信息啊
4.总感觉，这样会带来零一份开销，工作量也很大
5.有些依赖环境是OK的，有些不OK，那么我们是统一采用mock，还是部分采用mock
6.后续所有系统开发完毕后，还需要对当初使用mock的接口重新测试一下吗？（只是担心）</div>2020-02-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/36/41/62/cf9e3aaa.jpg" width="30px"><span>cheems</span> 👍（0） 💬（0）<div>微服务之间接口的相互调用使用dubbo，这种该怎么测试呢，有什么工具可以发起请求，还是得通过代码发起请求呀</div>2023-08-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/2f/f4/2dede51a.jpg" width="30px"><span>小老鼠</span> 👍（0） 💬（0）<div>基于mock的测试与契约测试有什么关系与联系？</div>2020-04-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/c2/b2/d20fe97a.jpg" width="30px"><span>希涛</span> 👍（0） 💬（0）<div>看完了，学习了</div>2020-03-28</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/9P7mlmEwl2E1m4b42bdUlaGVGunibesicCRJ9CLvkJB6Ljcgfk42BwJjiatv8mIHCWF3nNCT8o05hmC9k1nQvUQqg/132" width="30px"><span>mia</span> 👍（0） 💬（0）<div>看到最后一节课了，最后一节课的内容我现在还达不到那个水平，也没有接触这样大型的项目团队，不过关于接口测试思维还有测试工具和框架的组合使用还是学习蛮多的！先从自己搭建一个合适趁手的框架开始~</div>2020-03-12</li><br/>
</ul>