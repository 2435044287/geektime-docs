在上一期文章里，我们介绍了多环境下的应用配置管理问题，从这期开始，我们会分两期文章详细聊聊多环境建设的问题：就是我们到底需要哪些环境？这些环境都有什么作用？环境建设的思路和方式是怎样的？

今天我就结合自己的经验和理解与你聊一聊持续交付中的线下多环境建设。

## 环境分类

通常，我们主要按照环境所起到的作用，将环境分为两大类：

- 线下环境：测试验收用。
- 线上环境：为用户提供服务。

从建设角度来说，线下环境和线上环境，在网段上是要严格隔离的。这一点在做环境建设时就要确定网络规划，同时在网络设备或者虚拟网络的访问策略上要严格限定两个环境的互通，如果限制不严格，就极易引起线上故障，甚至是信息安全问题。

如果你维护过这样两套环境，我想你一定在这方面有过深刻的感受，甚至是痛苦的经历。

所以，从规划上，线上环境和线下环境是两套独立的区域，所有的应用、基础服务都是全套独立部署的。但是线下环境所需的资源往往是要少于线上环境，毕竟只有负责开发测试的少数人使用，不会有线上流量进来。如下图所示：

![](https://static001.geekbang.org/resource/image/57/8d/5787cdca12eab7956c5b71fdac0be28d.jpg?wh=495%2A282)

但是，在实际情况中，这两个环境远远满足不了我们日常开发、测试和运维方面的需求。从保障软件质量和系统稳定的角度出发，我们在实际操作中还需要在这两个大的环境区域中，建立细分的小环境，来满足不同阶段和不同角色的工作需求。

## 线下环境分类建设

线下环境最初建设的时候，主要是提供给测试使用，帮助其建立一个模拟环境，在软件发布上线前进行需求功能验证，保障业务流程顺畅，以确保应用在上线前达到最低质量要求。

所以，我们**在线下环境区域内，建设的第一个环境就是集成测试环境**。甚至在一开始，线下环境=集成测试环境，这个环境下的应用和各类基础服务必须跟线上保持一致，但是集群规模不用这么大（如我们上图所示）。

所以，集成测试环境极其重要，这个环境中的应用有严格的发布标准，并且要求环境稳定，不能随意发生变更，否则将会大大影响测试的效率。

不过，随着集成测试环境建设起来，业务需求迭代越来越快，应用和开发人员数量也越来越多，软件发布和变更也会更加频繁，这个时候就会出现开发和测试人员争抢集成测试环境的问题。

比较典型的场景就是，测试人员正在验证一个功能，突然发现应用停止运行了，原来开发为了验证和尽快发布新功能，更新了代码，这样就阻塞了测试的正常工作，但是不更新代码，开发的工作又会停滞下来。

后来这个矛盾越来越严重。这时，我们就需要考虑多建设一套给开发用的环境来解决这个问题。

于是，我们就开始建设**线下的第二套环境：开发测试环境。**这个环境主要是让开发同学能够尽快发布自己开发完的代码，并在一个具备完整业务应用和基础服务的环境下，验证自己的代码功能。

但是，是否需要跟集成测试环境一样，再建设一套独立完整的线下环境出来呢？答案是否定的。因为这时的应用变化范围相对独立，变化也较小，周边依赖需要同时变化的应用也不会太多，就像上面说的，只要能把它们放到一个完整的环境中进行验证即可。

所以，这个环境只要按照最小化原则建设即可，如果有依赖，可以直接访问到集成测试环境。在这里，我们以简单的模型展示开发测试环境跟集成测试环境的关系：

![](https://static001.geekbang.org/resource/image/db/a0/dbf8baa543f0643ae25dd66379ac44a0.jpg?wh=414%2A199)

再往后，开发测试环境上，又会出现开发和测试的冲突和争抢，因为从场景上，业务开发团队可能要同时承担多个并行项目的研发，而且可能会有多个业务开发团队一起参与进来。

比如对于电商来说，到了年底，就集中会有“双11”、“双12”、“双旦节”以及“年货节”等等这样的大型营销项目，因为时间非常紧凑，所以就必须多项目并行。

这个时候，分解下来，对于我们的应用软件来说，有可能是存在多个开发分支的。到了项目联调和验证环节，就必然会存在同一个应用有多个版本需要同时发布和测试的情况，但是开发测试环境却只有一个，这就必然导致双方激烈的争抢。

所以这个时候，就必须建立解决冲突的方案，开始建设线下的第**三套环境：项目环境**。

项目环境可能有多套，一个项目对应一套环境，但是无论从资源成本还是维护成本方面考虑，项目环境仍然不会像集成测试环境那样形成一套完整的开发测试体系。

所以项目环境同开发测试环境一样，仍然是以最小化为原则来建设，也就是说，在这个环境里面，只部署同一项目中涉及变更的应用，而对于基础服务和不涉及项目需求变更的应用不做重复建设。如果对项目环境中不存在的应用有依赖，那么访问集成测试环境中对应的应用就可以了。
<div><strong>精选留言（15）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/1d/03/4dc6706c.jpg" width="30px"><span>符亮</span> 👍（1） 💬（1）<div>启发很大，特别是项目环境那块。我们目前是开发，测试完整两套环境，利用k8s的命名空间隔离开，内部的configmap作为应用配置载体注入容器内的环境变量。我也在头疼一个服务好几个开发，测试增强环境的问题，原来还有项目环境这一说，我们体量不大，基于k8s去实现项目环境应该可行，非常感谢。</div>2020-07-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/36/dd/99917b1a.jpg" width="30px"><span>持续交付实践指南</span> 👍（1） 💬（1）<div>请问老师，你们用什么自动化工具？</div>2018-03-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/59/ed/88608728.jpg" width="30px"><span>黄无由</span> 👍（1） 💬（1）<div>有docker是不是可以解决多环境的问题</div>2018-02-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/e2/d8/f0562ede.jpg" width="30px"><span>manatee</span> 👍（1） 💬（1）<div>老师这个线下多项目环境按最小化部署我不太理解啊，比如一个a应用部署了两个开发环境，但是如果依赖的dubbo都是一套的话这个调用如何分离呢</div>2018-01-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/fd/46/7431e82e.jpg" width="30px"><span>約等于零</span> 👍（0） 💬（1）<div>想问下 各个环境应该由谁负责维护</div>2020-06-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8f/07/abb7bfe3.jpg" width="30px"><span>刘平</span> 👍（0） 💬（1）<div>我们一开始也是绑定hosts，后来发现人越来越多，测试成本有点高，就开始实行一套DNS，多个域名，比如对外正式域名是www.mogujie.com，预发是www.pre.mogujie.com，预发统一二级域名pre.mogujie.com，这个可以泛解析，只要解析一次就行，测试环境同理</div>2020-04-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg" width="30px"><span>每天晒白牙</span> 👍（0） 💬（1）<div>我们现在就有环境问题，并行开发部署环境老争环境</div>2020-03-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/e2/d8/f0562ede.jpg" width="30px"><span>manatee</span> 👍（5） 💬（0）<div>详情问一下项目环境中的消息与数据如何隔离呢</div>2019-10-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/03/8d/38a98dc6.jpg" width="30px"><span>牧野静风</span> 👍（2） 💬（0）<div>我们一般存在一个项目多个分支开发的情况，而且还依赖其他项目，联调是个痛苦的事情；其次，想问下老师，各环境的数据库如何配置较好，用生产覆盖还是制造测试数据的方式，很多数据不允许放到测试</div>2019-07-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/fc/fc/9c0bc4a3.jpg" width="30px"><span>ArnoYe</span> 👍（2） 💬（0）<div>在进行多环境维护时，往往需要跟线上一致的数据，有些时候对线上数据进行完全克隆这样会比较麻烦，也不能做到持续克隆，所以因为数据问题，导致集成测试环境，开发环境，不能很好的利用，出现直接上预发环境的情况，针对测试环境的数据问题，老师有什么好的建议吗？</div>2019-02-15</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Ug0tqzEkGlUopeZqF3icbATJFbsNVYwSG0gTK2PEJbYqg3LBMooE6hUkaZ4w3PMOGwmWAYyJeyu79sjzSJCKu7Q/132" width="30px"><span>老衲只吃肉</span> 👍（1） 💬（0）<div>我认为最小化开发测试环境部署会遇到很多问题，下面留言就很多人反馈了，我们实际使用也遇到很多问题，因为环境的依赖等原因，代码上做很多调整，尤其数据层有变更，例如项目A对order库的order_base表做了变更，但项目B是不需要变更的（兼容问题），如果最小化部署包含独立的关联的库，又会因为项目库和集成测试库的数据一致关联问题。为了降低开发围绕着环境去做的一些调整，就干脆每次部署环境就是完整的一套。虽然在资源成本上升了，但运维自动化如果做的好，耗时在5分钟内就可以完整克隆一套环境出来了。[我们一套环境超150个应用和80个库]。 个人感觉最小化部署只适合业务上拆的很细，逻辑划分清晰，耦合非常小的项目。</div>2019-07-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/c0/2c/b45cc122.jpg" width="30px"><span>极客达人</span> 👍（1） 💬（1）<div>老师，问个问题。比如两个项目环境依赖集成环境的支付服务，如果支付完成会触发支付完成回调，请问这个时候支付服务怎么来判断是回调通知项目1环境，还是项目2环境呢？</div>2018-10-08</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/oJiao7ZSm1eicvM61PaIYqTF3qz0b00Wiciag5iaP2JD1AUx8Xg0ABavbbOPbxXeL2Veep8Tr6AoAXSqLnZybeicjILQ/132" width="30px"><span>我在线</span> 👍（0） 💬（0）<div>项目环境是不是就是泳道环境</div>2024-02-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/4c/a7/a379c1e3.jpg" width="30px"><span>saiyin</span> 👍（0） 💬（0）<div>请求头增加tag 根据 tag 网关层判断调用那个环境的机器，这样的方案有那些弊端呢？</div>2023-08-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/1b/ab/a5f88914.jpg" width="30px"><span>kubxy</span> 👍（0） 💬（0）<div>&quot;每个环境分别配置一个不同的域名...但是如果这样，下层的二级域名和二级目录等等都要跟着变动&quot;。这句话理解起来有点抽象，能否举一个具体的例子？</div>2021-01-20</li><br/>
</ul>