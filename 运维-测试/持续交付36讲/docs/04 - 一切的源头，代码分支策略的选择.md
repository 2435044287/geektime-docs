记得大概是一年前吧，我与好友老吴喝茶聊天时，讨论到：高效的持续交付体系，必定需要一个合适的代码分支策略。

我告诉老吴：“采用不同的代码分支策略，意味着实施不同的代码集成与上线流程，这会影响整个研发团队每日的协作方式，因此研发团队通常会很认真地选择自己的策略。”

老吴是一名有多年开发经验的资深架构师，当时正好要接手一个框架团队，从个人贡献者向团队管理者转型。他个人对代码管理工具可谓熟之又熟，甚至连“老古董”的CVS都可以跟你聊半天。但他在为团队制定代码分支管理策略时，还是慎之又慎，足见其重要性。

最后我们发现，要确定选用哪种代码分支管理策略，需要先假设几个问题，这几个问题有了答案，也就代表你找到了适合的方向。

你需要思考的几个问题如下：

1. Google和Facebook这两个互联网大咖都在用主干开发（Trunk Based Development，简称TBD），我们是不是也参照它俩，采用主干开发分支策略？
2. 用Google搜索一下，会发现有个排名很靠前的分支策略，叫“A successful Git branching model”（简称 Git Flow），它真的好用吗？团队可以直接套用吗？
3. GitHub 和 GitLab 这两个当下最流行的代码管理平台，各自推出了 GitHub Flow 和 GitLab Flow，它们有什么区别？适合我使用吗？
4. 像阿里、携程和美团点评这样国内知名的互联网公司，都在用什么样的分支策略？
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/c6/f1/c10797f9.jpg" width="30px"><span>康美之心 淇水之情</span> 👍（30） 💬（2）<div>微服务架构下，比较适合主干开发，一个微服务(含1-4个API)根据复杂性和规模通常由1-3的开发进行开发(含单元测试的开发)，1位测试进行API自动化测试开发，单元测试和API测试都集成到Pipeline上，一旦变动代码提交到master上后，就自动启动Pipeline上的build，在build这里会自动完成覆盖率100%的单元测试，单元测试通过，自动触发FVT deployment，部署成功后，自动触发FVT API自动化测试，FVT测试通过后；自动打出上线的tag号，并把这个tag号的部署到UAT，UAT部署成功后，自动触发UAT的API自动化测试，测试通过后，这个UAT的tag的就可以部署上线了。</div>2018-07-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/ff/380eaec1.jpg" width="30px"><span>禾子先生</span> 👍（8） 💬（1）<div>对于第二个问题，我的思考是使用github flow，虽然追求效率，但必须保证线上版本是一个稳定。大家都在开发分支中进行开发，快速测试和迭代，合并到master时冲突也少。也考虑过使用主干开发，不过但从稳定角度来说，还是选择了前者</div>2018-07-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/55/a2/e237925d.jpg" width="30px"><span>bullboying</span> 👍（4） 💬（2）<div>在自动化测试还没怎么做到位的情况下，为了控制合并到master的都是经过测试的代码，我们增加了一个SIT分支。每次有新特性需要开发时，从master分支check out一个特性分支进行开发，可能涉及到多人协同开发。自测完成后先发起merge request到SIT分支，如果有冲突则不允许merge，以实现不同特性分支间的隔离。如果没冲突且有集成测试人员空闲，则完成merge并安排测试，测试通过后由masters再发起merge request将特性分支合并到master。因为之前控制了冲突，所以第二次合并理论上是没有冲突的。现在纠结的几个问题，一是想要限制不能从SIT分支pull，否则就达不到多个特性分支隔离的效果，全靠开发人员自觉；二是因为隔离冲突是为了限制在制品，但导致master和SIT分支上的代码其实是不同的，是否需要测试两次？</div>2018-07-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/94/f6/fc60bf8a.jpg" width="30px"><span>徐卫</span> 👍（3） 💬（1）<div>你好，问下。老师帮我看下理解对不对。主干开发是否只有一个分支，开发的代码提交到这个分支，发布也是用此分支。文中讲到的特性切换怎么做的？ 我个人理解是在那个发布的版本上打标签，特性切换是从tag上拉出一份代码部署？</div>2018-07-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/d6/fb/837af7bf.jpg" width="30px"><span>董永刚</span> 👍（2） 💬（2）<div>分支类型中，带生产分支，带发布分支，带产品分支的分别是什么样的场景呢？</div>2018-07-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/da/53/f3238883.jpg" width="30px"><span>纳米</span> 👍（2） 💬（2）<div>您好 我是一个非开发的人员。弱弱问下，最后表里总结的生产分支 环境分支中，开发人员自身是check out哪个分支代码出来开发 又是往哪个分支集成呢。能否在这两个分支上帮细化下。非常感谢。

思考题2 我理解 既然人很少 迭代周期也较为宽松 可能这一周大部分人都工作在一个功能或者版本上 是不主干开发反而也可以。github flow应该肯定是ok的。</div>2018-07-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/1d/a9/afeabc52.jpg" width="30px"><span>白天不懂爷的黑</span> 👍（2） 💬（1）<div>老师，您好，最近公司想用gitlab做配置中心，请问贵公司gitlab的高可用是怎么做的呢？谢谢</div>2018-07-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/37/d3/9febe49d.jpg" width="30px"><span>smartzs</span> 👍（1） 💬（1）<div>老师，主干开发 和 带发布分支模型 很像啊，带发布分支约等于主干开发了吧？</div>2018-12-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/94/4f/2396cce5.jpg" width="30px"><span>小胖胖</span> 👍（1） 💬（1）<div>gogs被gitlab 应该选择哪个？有什么区别吗</div>2018-07-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/bf/a8/fef1a437.jpg" width="30px"><span>初七之月亮</span> 👍（1） 💬（1）<div>带环境发布分支方法的多数适用场景是啥呢？是不是有多少套环境就多少套分支啊？</div>2018-07-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/89/46/ff27e90f.jpg" width="30px"><span>Geek_gthxw2</span> 👍（1） 💬（1）<div>我们团队主干和开发两个分支并过来并过去，我该怎么解释这是种什么不好的方式呢。。。</div>2018-07-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/36/08/e3ed94b8.jpg" width="30px"><span>周小桥</span> 👍（0） 💬（1）<div>老师好，现在我们的一个系统是以产品的方式编写，但是是以项目的方式买给不同的客户，这中间涉及到不同客户的不同需求 ，没办法都满足，会有差异，有的是同一模块 ，有的是定制需求！现在代码都是一套， 维护代码特别麻烦，满足了这里满足不了哪里，特别是那种几个月前部署的项目出了问题，有改动或者新功能升级 很容易出现问题，功能冲突等等…现在没有找到一种特别好的管理代码的方式，希望老师指导！</div>2018-07-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/db/ed/106a8ec9.jpg" width="30px"><span>王浩槟</span> 👍（0） 💬（1）<div>我司用的还是SVN，没用过git。想问:
SVN是不是很落后了？转换到git上有价值吗？如果转该怎么处理更平滑更低代价？</div>2018-07-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/68/ed/b5a41e95.jpg" width="30px"><span>张明云</span> 👍（0） 💬（1）<div>我们公司是平板方案商，APP开发是敏捷模式，平板大项目是IPD模式，并且平板发布时会预置这些APP，但APP在某个版本上只要满足了平板要求的特性，就可以继续迭代新版本了，但虽然APP预置到平板的版本已经发布了，只要平板还在测试，出现比较严重的问题还是要继续改动。并且有时还会配合平板的硬件特性开发预研版本，相当于APP需要同时维护几个版本。请问老师这种情况用哪种分支模式好呢？</div>2018-07-14</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83eppQqDE6TNibvr3DNdxG323AruicIgWo5DpVr6U7yZVNkbF2rKluyDfhdpgAEcYEOZTAnbrMdTzFkUw/0" width="30px"><span>图·美克尔</span> 👍（0） 💬（1）<div>我们每个环境都要持续集成和持续发布…保证每个环境都是稳定和可用。最近有个问题是，子项目上提交后会触发到总项目的然后所有子项目的服务器都会重新部署…</div>2018-07-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/ff/380eaec1.jpg" width="30px"><span>禾子先生</span> 👍（8） 💬（0）<div>对于开源项目不适合用主干开发。我的理解是更应该采用gitlab flow，为了保证功能稳定性，在贡献者的能力参差不齐和对整体架构和功能不一定完全了解情况下，修改的代码可能会引起其他问题。通过带版本分支的方式发布，稳定的推进和测试新代码的影响。</div>2018-07-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/80/cd/de3e76af.jpg" width="30px"><span>Jack xia</span> 👍（2） 💬（0）<div>项目背景是这样，我们作为整车厂集成各个供应商提供的代码，目前由于编译工具特殊性，所以需要两套系统，windows和linux, 目前代码都是c++, 我的问题是，对于代码分支策略你建议选择什么？还是可以刚开始选择1， 后面可以变更？</div>2021-03-07</li><br/><li><img src="" width="30px"><span>有道测试组</span> 👍（2） 💬（0）<div>选用什么样的开发方式，也有一定是基于历史遗留原因或者大家的编程习惯~
开源软件不适合主干开发是说，我们会假设有若干贡献者，并且贡献者的水平参差不齐，会带来一粒老鼠屎，坏了一锅粥的问题。 但如果我们的pr 提交到master分支，会经过完善的自动化测试（包括各种配置，各种机型，我们将要做的所有测试）， 测试通过才让合入。这样其实主干开发流程简洁，能加快开发效率。  
如果测试没那么自动化，可能需要先合入其他分支， 再通过线下完整的各方面校验通过，方能合入。
目前像tf ，paddlepaddle等深度学习框架大多基于主干开发，分支发布。
不管是主干开发分支发布，还是分支开发主干分布，主要是期望能全面保证质量后再发布， 并且发布后的代码能较方便的集成到版本库。中间建立多少层分支，一般决定于代码库贡献者的规模。
</div>2018-12-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ac/a1/43d83698.jpg" width="30px"><span>云学</span> 👍（2） 💬（0）<div>到底用哪种分支策略和团队的业务分工有关，如果修改的代码交织严重，肯定是主干，如果不严重，可以主干可以分支</div>2018-07-12</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/jAsPmqra89uLYer998tsdAmHIxy9iaVfLIkzkTB3ITfUZg21Yiadf73TqmcFZXTEv2wuQicDA2uvqXvicHJ9HckBWg/132" width="30px"><span>Geek_c991f2</span> 👍（1） 💬（0）<div>很早就知道你有这个文章,但是当时没太能看懂,今天回头来看.但是还是想评论下,感觉文章中说到的git flow和有点像另外3中gitlab flow的三种综合,希望老师回复下</div>2019-08-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/1e/d7/7d28a531.jpg" width="30px"><span>飞机翅膀上</span> 👍（1） 💬（0）<div>老师好，我们现在一个项目具有很多功能，还没有做微服务，甚至soa还没有做，产品在迅速迭代，目前一个master分支，一个test，和十几个特性分支，特性分支需要合并到test测试通过才可以将特性分支合到master发布
由于特性分支太多导致合到test分支经常有冲突，甚至编译不通过。所以每天都要拉取master分支到特性分支做合并，尽管如此，还是会有冲突
看了老师的课程，觉得有必要给每一个特性分支做测试环境，然而没有那么多的服务器，这点使用docker可以解决，至少做测试不需要合代码了，但这会导致最后特性分支测试通过合master时也会产生大量冲突
在这样的一个场景下，该给哪些分支做持续集成呢？从而提高项目整体交付效率？
我想过引入一个预发布分支，首先从master checkout下来，特性分支测试通过合到预发布分支，给预发布分支做持续集成，及时反馈预发布分支的健康状况
非常希望老师能够给点建议，感激不尽！</div>2019-05-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/80/bb/c0ed9d76.jpg" width="30px"><span>kursk.ye</span> 👍（1） 💬（0）<div>特性切换（feature toggle）翻译得不准确，叫 功能开关更合适</div>2019-01-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/b3/c1/beca97d7.jpg" width="30px"><span>大M</span> 👍（1） 💬（0）<div>如果有不同环境呢，比如灰度环境，这样情况下我觉得是gitflow 比较合适。</div>2018-07-17</li><br/><li><img src="" width="30px"><span>IT亚健康</span> 👍（0） 💬（0）<div>我们目前采用的   特性分支策略， 我们特性是指 每个大小项目 都是规划版本号， 特性分支 用版本号切分支，用于开发</div>2024-09-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/76/97/23446114.jpg" width="30px"><span>火云邪神霸绝天下</span> 👍（0） 💬（0）<div>我们是master 结合develop和feature开发，偶尔需要拉bug分支。再加一个release分支保存不同版本。master维持经过测试后的最新稳定代码。</div>2024-08-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/ee/98/a5d33c9b.jpg" width="30px"><span>雅各布</span> 👍（0） 💬（0）<div>大家的团队都是先测试还是先code review？</div>2023-12-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/c4/87/f2db4b1b.jpg" width="30px"><span>愉快</span> 👍（0） 💬（0）<div>我们的策略就是主干开发，由于项目性质一般是1-2个人负责一个项目，目前还没有产品，有了产品后应该会考虑其他分支策略。</div>2022-09-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/84/2c/1b0926b4.jpg" width="30px"><span>Even</span> 👍（0） 💬（0）<div>分享下我们的，算是基于主干开发的分支模型，mastet代码是随时可发布态，平时我们功能开发，从主干拉出feature分支，开发完提mr合入，提mr触达流水线，跑代码检查，自动化测试，跑过+cr确认才算合入主干，发布的话，定时从主干拉出release分支，中途可以cp到发布分支(前提需要先合入主干）。 </div>2022-03-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/8d/f2/e1f6164a.jpg" width="30px"><span>卿卿</span> 👍（0） 💬（0）<div>现在公司核心项目由于需求多，每次上线的不确定性较大，分支模式使用的功能开发分支、带环境分支和带发布窗口分支的模式，有点崩溃，讨论几次也找不到更好的解决方案。我们现在用的是gitlab，但是没有使用gitlab的merge request功能。</div>2020-05-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/14/99/5b1ed92b.jpg" width="30px"><span>戴斌</span> 👍（0） 💬（0）<div>特性分支开发适用于按时交付，但是，合并代码的过程很是痛苦</div>2020-03-20</li><br/>
</ul>