如果你平时用的是Windows电脑，你会发现，用了SSD的系统盘，就不能用磁盘碎片整理功能。这是因为，一旦主动去运行磁盘碎片整理功能，就会发生一次块的擦除，对应块的寿命就少了一点点。这个SSD的擦除寿命的问题，不仅会影响像磁盘碎片整理这样的功能，其实也很影响我们的日常使用。

我们的操作系统上，并没有SSD硬盘上各个块目前已经擦写的情况和寿命，所以它对待SSD硬盘和普通的机械硬盘没有什么区别。

我们日常使用PC进行软件开发的时候，会先在硬盘上装上操作系统和常用软件，比如Office，或者工程师们会装上VS Code、WebStorm这样的集成开发环境。这些软件所在的块，写入一次之后，就不太会擦除了，所以就只有读的需求。

一旦开始开发，我们就会不断添加新的代码文件，还会不断修改已经有的代码文件。因为SSD硬盘没有覆写（Override）的功能，所以，这个过程中，其实我们是在反复地写入新的文件，然后再把原来的文件标记成逻辑上删除的状态。等SSD里面空的块少了，我们会用“垃圾回收”的方式，进行擦除。这样，我们的擦除会反复发生在这些用来存放数据的地方。

![](https://static001.geekbang.org/resource/image/09/6e/09a9566eae60610b0f49d7e24ce4ee6e.jpeg?wh=1726%2A658)

有一天，这些块的擦除次数到了，变成了坏块。但是，我们安装操作系统和软件的地方还没有坏，而这块硬盘的可以用的容量却变小了。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJOBwR7MCVqwZbPA5RQ2mjUjd571jUXUcBCE7lY5vSMibWn8D5S4PzDZMaAhRPdnRBqYbVOBTJibhJg/132" width="30px"><span>ヾ(◍°∇°◍)ﾉﾞ</span> 👍（42） 💬（1）<div>类似Kafka hbase leveldb 这些都是先写log，标记然后异步整理的系统都是lfs吧。适合ssd的原因，这些系统顺序写，可以设置不删数据，或者异步删除数据，减少了磁盘被频繁擦除问题</div>2019-08-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4d/fd/0aa0e39f.jpg" width="30px"><span>许童童</span> 👍（28） 💬（1）<div>LFS文件系统的设计木主要是为了解决以前文件系统所存在的两个问题：随机输入输出的性能和序列输入输出的性能相差很大；还有就是磁盘搜索和旋转延迟比较大。

LFS文件系统的主要算法就是首先把所有的更新（包括元数据）缓存在内存中的成为segment的单位中。当segment填满之后，里面的数据就写入到磁盘中未使用的地方。 特别要注意的是：LFS并不会覆写已有的数据，而是把segment中的数据写入到磁盘中新的位置。</div>2019-08-14</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/3XbCueYYVWTiclv8T5tFpwiblOxLphvSZxL4ujMdqVMibZnOiaFK2C5nKRGv407iaAsrI0CDICYVQJtiaITzkjfjbvrQ/132" width="30px"><span>有铭</span> 👍（18） 💬（1）<div>AeroSpike为什么现在的受欢迎程度不如Redis？</div>2019-08-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/78/ac/e5e6e7f3.jpg" width="30px"><span>古夜</span> 👍（12） 💬（1）<div>所以FTL到底是系统层面的还是SSD层面的？如果是后者和文章就说不通了</div>2019-09-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4d/49/28e73b9c.jpg" width="30px"><span>明翼</span> 👍（9） 💬（3）<div>看了这个文档都想把我 的ssd换回HDD硬盘哈哈，我上面装的一些软件比如qq，整天都再写磁盘。</div>2019-08-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/55/a3/88cbb981.jpg" width="30px"><span>　</span> 👍（6） 💬（1）<div>请问:对于ssd硬盘上面文件内容的修改是一个什么样的过程？既然不能覆写，那是不是只能重新分配一个页写入修改后的数据？但这样又要修改inode。。。</div>2019-08-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/47/b0/affce3fd.jpg" width="30px"><span>allen</span> 👍（5） 💬（1）<div>怪不得我的Mac越用越慢，想要电脑用的久，还是要买大容量SSD</div>2019-08-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/fa/fd/ec24cba7.jpg" width="30px"><span>fcb的鱼</span> 👍（4） 💬（2）<div>问下，其实我们日常的文件删除，都只是一个操作系统层面的逻辑删除。对于HDD来说，是不是没有物理删除一说，只需要用新的数据覆盖已经删除数据的这块地方而已；但是对于SSD，就必须先把删除数据的这块地方进行擦除才能写入新的数据吧？</div>2020-02-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/9b/ba/333b59e5.jpg" width="30px"><span>Linuxer</span> 👍（4） 💬（2）<div>请问怎么启用， FTL、TRIM</div>2019-08-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/f9/90/5cd5d680.jpg" width="30px"><span>成</span> 👍（2） 💬（1）<div>关于存储器我有一个疑问，我们这些硬盘，内存的存储器最终都是存了电子或者磁符号形式的0和1吗？比如拍的一张照片。</div>2019-09-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4d/fe/abb7bfe3.jpg" width="30px"><span>bd7xzz</span> 👍（1） 💬（1）<div>如果利用trim指令了，是不是意味着ssd再做物理删除后很难做数据恢复了？</div>2023-03-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/c9/fe/874b172b.jpg" width="30px"><span>benxiong</span> 👍（5） 💬（12）<div>我真傻，几乎每周都会手动去整理硬盘，包括C盘系统盘。我PC是 128G固态+1T机械。这样估计一下，用不了几年我电脑就要换固态了。</div>2020-08-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/db/d8/e090658c.jpg" width="30px"><span>JRTx</span> 👍（2） 💬（0）<div>LFS的思路是先缓存起来，然后再整段写入磁盘。这样就可以充分利用顺序写的优势。</div>2020-11-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0b/6f/68cd0614.jpg" width="30px"><span>brian</span> 👍（2） 💬（1）<div>AeroSpike 为什么可以绕过操作系统直接操作硬盘？
操作系统不是管理所有I&#47;O资源吗？</div>2020-05-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2b/89/50/aee9fdab.jpg" width="30px"><span>小杰</span> 👍（1） 💬（0）<div>看了下LFS，已segment为单位管理，包括写、读和垃圾回收。写操作是当内存中的数据超过段的大小之后，将会一次性的写入到空闲的段中，读操作是每一个segment最后会存储一个imap来保存inode索引，而inode保存了data block的索引。垃圾回收会将各种旧的block整理成新的段，然后将其删除。此过程与上一讲的ssd特性不谋而合。</div>2022-06-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/9b/90/de3d8f08.jpg" width="30px"><span>蓝熊船长</span> 👍（1） 💬（1）<div>以ext3为例，一个inode本身占256个字节，我删除一个文件，对应的inode项会变化。那么，是不是inode对应的整个页都要进行一次新开空间并重新写入，且原来的页作废？</div>2021-02-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/70/5c/ebb274eb.jpg" width="30px"><span>板栗饼</span> 👍（1） 💬（2）<div>类似AeroSpike这样，某个物理块超过50%就搬运擦除，应该会增加SSD搬运和擦除次数，减少使用寿命吧</div>2020-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e7/2e/1522a7d6.jpg" width="30px"><span>活的潇洒</span> 👍（1） 💬（0）<div>2018年入手一个笔记本、硬盘是PCI Express接口128GB的SSD,速度一下子提升上来了，但是对于SSD为什么快的底层原理还是不知道
day 47天笔记：https:&#47;&#47;www.cnblogs.com&#47;luoahong&#47;p&#47;11395273.html</div>2019-08-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0b/0a/fa152399.jpg" width="30px"><span>wahaha</span> 👍（1） 💬（0）<div>Dear teacher, how to get the erase block size of a ssd disk?</div>2019-08-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/81/e9/d131dd81.jpg" width="30px"><span>Mamba</span> 👍（0） 💬（0）<div>什么是LFS？
LFS的设计理念是将所有的文件系统修改（包括文件的创建、修改和删除）作为连续的日志条目写入磁盘。这样做的优点包括：

顺序写入：所有的写入操作都是顺序的，这避免了随机写入导致的性能瓶颈。
写入优化：由于写入是顺序的，LFS可以优化磁盘头的移动，减少寻道时间。
崩溃恢复：在系统崩溃后，LFS可以通过重放日志来快速恢复文件系统状态。
为什么LFS特别适合SSD硬盘？
顺序写入优势：SSD硬盘对于顺序写入有很高的性能，而LFS正是基于顺序写入的文件系统。这意味着LFS可以充分利用SSD的写入性能，提高整体系统效率。
减少写入放大：SSD硬盘在执行写入操作时存在写入放大的问题，即实际写入的数据量可能远大于原始数据量。LFS的顺序写入模式可以减少写入放大，延长SSD的使用寿命。
无需频繁的垃圾回收：SSD硬盘需要定期执行垃圾回收来清理已删除的数据块。由于LFS的写入模式，垃圾回收的压力相对较小，因为数据是顺序写入的，垃圾回收过程可以更高效。
更好的耐久性管理：LFS的设计允许更精细地控制数据的写入位置，这有助于SSD硬盘的耐久性管理，因为可以避免对同一块的频繁写入。</div>2024-09-13</li><br/><li><img src="" width="30px"><span>Geek_88604f</span> 👍（0） 💬（0）<div>从架构设计的角度来讲，分层架构具有结构清晰、简洁、易维护、可演进的优点，但是性能却不一定最优。就像AeroSpike 键值对数据库，在操作底层SSD硬盘的时候绕过了文件系统层。这是架构设计必须要同业务需求相结合所做的权衡</div>2024-01-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d4/0c/4decd1aa.jpg" width="30px"><span>氢原子</span> 👍（0） 💬（0）<div>手机越用越慢和SSD相关吗？</div>2023-10-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/0e/47/889efbd1.jpg" width="30px"><span>badandboy</span> 👍（0） 💬（0）<div>老师，我们公司目前就是在做个人私有云，其中就用到了ssd, 最开始用了sqlite最为数据库，但是因为写放大的原因，后面一些数据库就改用了leveldb, 听了老师的课，感觉收货很多</div>2022-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e9/29/629d9bb0.jpg" width="30px"><span>天王</span> 👍（0） 💬（0）<div>总结:ssd擦除次数多了，磁盘用不了，磨损均衡，为了让擦除次数均匀，增加了一层FTL闪存转换层，读取和写入磁盘，都经过FTL，FTL里面记录了逻辑块地址和物理块地址的映射关系，有记录次数，保证分配写入次数均匀。trim指令，机械硬盘的删除和ssd的删除都是逻辑删除，是操作系统里面没了inode信息，只有等到物理地址有新数据写入才会硬盘才知道要删除，ssd要进行删除文件的移动，增加了trim指令，让操作系统告诉ssd文件已经删除。ssd随着使用，空闲空间越来越少，为了写入一块数据，可能要整理多个块，这个可以放在空闲的时候去做。AeroSpike为了充分利用ssd，有几个优化，直接读写磁盘块，往大的磁盘块写数据，频繁回收整理，保证ssd磁盘空间率大于50%</div>2022-08-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/a4/27/15e75982.jpg" width="30px"><span>小袁</span> 👍（0） 💬（0）<div>不是说FTL层负责均衡磨损，上层只能看到逻辑块地址么？AeroSpike是怎么知道物理块有碎片？</div>2022-02-09</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKb6PpibJLwmeLzsnHQbXYwUNNlqEibnzogB4iaaJe8nBQ6SEppEyf4QmZcXnMzJqia9FCPUpH0O5o7Ig/132" width="30px"><span>风铃草</span> 👍（0） 💬（0）<div>文章中关于aerospike的ppt如何打开？</div>2021-12-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/ea/18/80c24d33.jpg" width="30px"><span>Geek_f2f3c7</span> 👍（0） 💬（0）<div>老师我有一个地方没想明白“FTL 就可以将这个物理块，挪到一个擦写次数少的物理块上”，首先我觉得这里不是“挪”应该是交换把，其次如果是“挪”或者是“交换”这个物理块应该是一个硬件把那怎么挪动&#47;交换啊？？</div>2021-08-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d4/f3/129d6dfe.jpg" width="30px"><span>李二木</span> 👍（0） 💬（0）<div>AeroSpike 直接写硬盘，这是怎么做到的？</div>2021-04-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/e0/6b/f61d7466.jpg" width="30px"><span>prader26</span> 👍（0） 💬（0）<div>ssd硬盘的寿命和擦除次数有关，因此ssd硬盘引入了FTL这个映射层。引入FTL之后ssd中的数据只是逻辑删除，为了减少数据搬运的次数，引入了TRIM指令，数据在ssd上可以直接物理删除。
AeroSpirke是专门为ssd设计的key-value数据库，在采用了超水位算法，和半存储方式，可以更快的查询。
</div>2019-10-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/21/20/1299e137.jpg" width="30px"><span>秋天</span> 👍（0） 💬（0）<div>对于 mac 这样的 使用 ssd 能更换硬盘吗？</div>2019-10-14</li><br/>
</ul>