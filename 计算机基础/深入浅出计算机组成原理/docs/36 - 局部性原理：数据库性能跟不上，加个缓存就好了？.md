平时进行服务端软件开发的时候，我们通常会把数据存储在数据库里。而服务端系统遇到的第一个性能瓶颈，往往就发生在访问数据库的时候。这个时候，大部分工程师和架构师会拿出一种叫作“缓存”的武器，通过使用Redis或者Memcache这样的开源软件，在数据库前面提供一层缓存的数据，来缓解数据库面临的压力，提升服务端的程序性能。

![](https://static001.geekbang.org/resource/image/67/89/675341b47057e483713395b55eef7089.png?wh=1142%2A529)

在数据库前添加数据缓存是常见的性能优化方式

那么，不知道你有没有想过，这种添加缓存的策略一定是有效的吗？或者说，这种策略在什么情况下是有效的呢？如果从理论角度去分析，添加缓存一定是我们的最佳策略么？进一步地，如果我们对于访问性能的要求非常高，希望数据在1毫秒，乃至100微秒内完成处理，我们还能用这个添加缓存的策略么？

## 理解局部性原理

我们先来回顾一下，上一讲的这张不同存储器的性能和价目表。可以看到，不同的存储器设备之间，访问速度、价格和容量都有几十乃至上千倍的差异。

![](https://static001.geekbang.org/resource/image/d3/a6/d39b0f2b3962d646133d450541fb75a6.png?wh=1142%2A588)

以上一讲的Intel 8265U的CPU为例，它的L1 Cache只有256K，L2 Cache有个1MB，L3 Cache有12MB。一共13MB的存储空间，如果按照7美元/1MB的价格计算，就要91美元。

我们的内存有8GB，容量是CPU Cache的600多倍，按照表上的价格差不多就是120美元。如果按照今天京东上的价格，恐怕不到40美元。128G的SSD和1T的HDD，现在的价格加起来也不会超过100美元。虽然容量是内存的16倍乃至128倍，但是它们的访问速度却不到内存的1/1000。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/a0/a4/b060c723.jpg" width="30px"><span>阿斯蒂芬</span> 👍（32） 💬（1）<div>老师举的这个亚马逊商品缓存的例子，我理解就是利用了时间局部性的特征，一个商品如果被访问了，那么猜测很快会被第二次访问。我再尝试理解空间局部性，也拿老师说的《哈利波特》全集的例子，如果《哈1》被访问了，那么《哈2-7》被访问的可能性也很高，因此这也可以作为缓存预热的一种策略，类似地我还想到了电商经常用的“看相似”和“看过这个的同时也喜欢...”这一类推荐，细想一下背后也是一种“空间局部性”的应用，在后台基于大数据做离线分析，生成内容相关推荐，可以在适当时候优先加载到更快速的存储上以达到更快的响应。当然，可能实际上是否会优先加载不一定，但是透过老师的讲解，把这块联系上了计算机组成原理的理论，还是觉得嗨森，哈哈哈。</div>2020-01-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/dc/e6/ea4b2c10.jpg" width="30px"><span>........</span> 👍（8） 💬（1）<div>老师, 感觉硬盘应该还是需要能够完全支撑用户访问, 因为一开始数据应该都是存放在硬盘中, 然后通过用户的不断点击来更新缓存? 不知道是不是这样</div>2019-09-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/34/df/64e3d533.jpg" width="30px"><span>leslie</span> 👍（5） 💬（1）<div>       其实这还是一个负载均衡的问题：如何合理的使用内存库；就如同现在某些行业的数据库其实是定时入数据库的，效率的平衡性确实；物理设备代价的平衡性，程序、数据库、中间件的使用平衡性，需要整体考虑。</div>2019-08-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/44/0e/ce14b7d3.jpg" width="30px"><span>-_-|||</span> 👍（2） 💬（1）<div>文中“一块 HDD 硬盘只能支撑每秒 100 次的随机访问，2400TB 的数据，以 4TB 一块磁盘来计算，有 600 块磁盘，也就是能支撑每秒 6 万次（ = 2400TB&#47;4TB × 1s&#47;10ms ）的随机访问”，600 块磁盘构成了一个集群吗</div>2020-01-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/4f/60/049a20e9.jpg" width="30px"><span>吴宇晨</span> 👍（2） 💬（1）<div>感觉还能加一层ssd缓存，内存和ssd差价太大速度也差很多，可以内存存千分一，ssd存百分一</div>2019-08-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/19/22/2355a0dd.jpg" width="30px"><span>Jag</span> 👍（0） 💬（1）<div>现在通常加一个redis ，在加一个本地缓存，来帮数据库分担压力</div>2019-08-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cf/96/251c0cee.jpg" width="30px"><span>xindoo</span> 👍（121） 💬（4）<div>局部性原理真是计算机各类优化的基石，小到cpu cache，大到cdn。而且不仅仅是存储，java的jit也是利于局部性优化性能。任何东西只要不是均匀分布的，就有优化空间。</div>2019-07-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4d/fd/0aa0e39f.jpg" width="30px"><span>许童童</span> 👍（31） 💬（2）<div>假设淘宝网有12亿商品数量，每件商品需要 4MB 的存储空间，那么一共需要 4800TB（ = 12 亿 × 4MB）的数据存储
如果1%的热点数据做为缓存则需要48TB的内存 72 万美元（ = 48TB&#47;1MB × 0.015 美元 = 72 万美元）
另外还需要99%的硬盘 19 万美元（ = 4752TB&#47;1MB × 0.00004 美元 = 19 万美元）</div>2019-07-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c0/6c/29be1864.jpg" width="30px"><span>随心而至</span> 👍（10） 💬（0）<div>我记得编程珠玑有一章中，专门考察了估算能力，老师关于亚马逊的估算真的是很赞。</div>2019-10-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/7b/18/6e44e6e0.jpg" width="30px"><span>恺撒之剑</span> 👍（9） 💬（0）<div>亚马逊的例子估算问题
现在普通硬盘的吞吐量在100MB&#47;s左右，按4MB每个商品计算，硬盘每秒的访问次数为100 &#47; 4 = 25次 ,而不是按照IOPS的角度 1s&#47;10ms = 100次
硬盘不但受IOPS的限制，也受吞吐量的限制，文中的估算没有考虑吞吐量，只考虑的IOPS
</div>2020-05-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/7a/d2/4ba67c0c.jpg" width="30px"><span>Sch0ng</span> 👍（8） 💬（6）<div>非计科的程序员看到局部性原理这个词有中热泪盈眶的感觉。</div>2019-07-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/95/af/b7f8dc43.jpg" width="30px"><span>拓山</span> 👍（7） 💬（3）<div>局部性原理放之四海而皆准
现实生活中的人际关系也是如此啊</div>2019-10-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/2f/43/e24212bb.jpg" width="30px"><span>o_O</span> 👍（4） 💬（0）<div>mysql查询的时候也会用到空间局性原理</div>2020-03-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/ea/a9/0a917f2c.jpg" width="30px"><span>Sunny</span> 👍（3） 💬（2）<div>个人认为，时间局部性的解释和例子很糟糕！</div>2021-05-04</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/pTD8nS0SsORKiaRD3wB0NK9Bpd0wFnPWtYLPfBRBhvZ68iaJErMlM2NNSeEibwQfY7GReILSIYZXfT9o8iaicibcyw3g/132" width="30px"><span>雷刚</span> 👍（2） 💬（0）<div>赞一个，以前从来没有跳出开发的角度想如何选择IO设备</div>2020-03-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/7d/a6/15798bf2.jpg" width="30px"><span>温雅小公子</span> 👍（1） 💬（0）<div>这个Cache和TLB有什么区别？</div>2022-10-29</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/q2HwchogzNiavKhIB4GfAxH6B88NhSoC7B7keVEUqiaP6JPokDUNJLYehocOyqYqrhA3iaxywyRXLYkYJjDUQESZw/132" width="30px"><span>残天噬魂</span> 👍（1） 💬（0）<div>老师好，请问磁盘预读会触发io吗？比如mysql一个内存页是16k.而一个磁盘页大小是4k，如果根据预读原理，mysql一次读取了16k的数据，所以是一次io，但如果在预读的时候也出发了io，那应该还是触发了4次io吧？</div>2020-10-21</li><br/><li><img src="" width="30px"><span>Paul Shan</span> 👍（1） 💬（0）<div>请问老师，存储的访问延时，例如(内存100 ns)是不是指1M的访问延时，在亚马逊这个例子的时候换成商品数据是不是还要再换算一次（商品数据是4M，内存的延时是否为400ns）。</div>2020-08-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/4f/17/2185685f.jpg" width="30px"><span>Zhangxuesong</span> 👍（1） 💬（2）<div>请问  估算每天的活跃用户为 1 亿，这 1 亿用户每人平均会访问 100 个商品，那么平均每秒访问的商品数量，就是 12 万次  这 12万次是如何计算出来的？</div>2019-10-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e7/2e/1522a7d6.jpg" width="30px"><span>活的潇洒</span> 👍（1） 💬（0）<div>我工作经常和缓存打交道、也知道缓存的应用场景、知道怎么用，但是就是不知道底层的实现原理

day36 笔记：https:&#47;&#47;www.cnblogs.com&#47;luoahong&#47;p&#47;11328360.html
</div>2019-08-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/db/26/54f2c164.jpg" width="30px"><span>靠人品去赢</span> 👍（1） 💬（3）<div>时间局部性，从时间维度上将东西关联起来，一部电视剧电视剧第一集第二集这种，有时间轴的那种。
空间复杂度，从类似于空间的概念关联起来，比如说同类商品，竞品或者同一品牌的不同系列。
实际中，感觉还是把访问次数最多的放进去，或者干脆就是交给Redis来管设个时间就完了。那实际中我们怎么更好贯彻这两个局部性？</div>2019-07-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/81/e9/d131dd81.jpg" width="30px"><span>Mamba</span> 👍（0） 💬（0）<div>利用局部性原理（时间局部和空间局部），通过组合不同的存储设备，充分利用缓存的快速和硬盘的廉价，从而实现效率最大化</div>2024-09-03</li><br/><li><img src="" width="30px"><span>Geek_88604f</span> 👍（0） 💬（0）<div>1.分层存储可以在效率和成本之间取得平衡，核心原理是二八定律。百分之八十的业务量经常访问的是那百分之二十的信息。
    2.时间局部性和空间局部性以及LRU是实践经验的总结
    3.将1（基础架构）和2（运作机制）结合起来就构成了大型存储架构</div>2023-12-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/50/2b/2344cdaa.jpg" width="30px"><span>第一装甲集群司令克莱斯特</span> 👍（0） 💬（0）<div>局部性原理，太重要了！</div>2022-12-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/35/fc/6d3e0035.jpg" width="30px"><span>saber</span> 👍（0） 💬（0）<div>估算的时候，可以把4TB磁盘缩小成2TB 这样硬盘就满足12万次&#47;s的访问了，当然硬盘多了，机房机柜空间就会变大</div>2022-05-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/40/e9/29dfa621.jpg" width="30px"><span>小灰</span> 👍（0） 💬（0）<div>说明延时时间好像不对吧！</div>2022-04-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/50/01/5bc28ed8.jpg" width="30px"><span>black</span> 👍（0） 💬（1）<div>实际工程中，QPS预估又是一个头疼的问题。</div>2021-02-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/d2/0f/8f14c85b.jpg" width="30px"><span>红薯板栗</span> 👍（0） 💬（0）<div>提升性能：优化大概率事件，流水线，预测</div>2021-02-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/86/e3/a31f6869.jpg" width="30px"><span> 尿布</span> 👍（0） 💬（0）<div>想要仔细了解各种存储器和局部性原理，你还是可以去读一读教科书。《计算机组成与设计：硬件 &#47; 软件接口》的 5.1～5.2 小节，是一个很好的阅读材料。</div>2020-09-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/d6/9f/0213e8a0.jpg" width="30px"><span>🤪HappyJoo</span> 👍（0） 💬（0）<div>是不是和 RISC 差不多的道理呢？把最常用的拿出来，不常用的放在一边，总的来说还是会快很多。</div>2020-06-16</li><br/>
</ul>