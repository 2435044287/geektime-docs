过去几年里，整个计算机产业界，都在尝试不停地提升I/O设备的速度。把HDD硬盘换成SSD硬盘，我们仍然觉得不够快；用PCI Express接口的SSD硬盘替代SATA接口的SSD硬盘，我们还是觉得不够快，所以，现在就有了傲腾（Optane）这样的技术。

但是，无论I/O速度如何提升，比起CPU，总还是太慢。SSD硬盘的IOPS可以到2万、4万，但是我们CPU的主频有2GHz以上，也就意味着每秒会有20亿次的操作。

如果我们对于I/O的操作，都是由CPU发出对应的指令，然后等待I/O设备完成操作之后返回，那CPU有大量的时间其实都是在等待I/O设备完成操作。

但是，这个CPU的等待，在很多时候，其实并没有太多的实际意义。我们对于I/O设备的大量操作，其实都只是把内存里面的数据，传输到I/O设备而已。在这种情况下，其实CPU只是在傻等而已。特别是当传输的数据量比较大的时候，比如进行大文件复制，如果所有数据都要经过CPU，实在是有点儿太浪费时间了。

因此，计算机工程师们，就发明了DMA技术，也就是**直接内存访问**（Direct Memory Access）技术，来减少CPU等待的时间。

## 理解DMA，一个协处理器
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/bf/aa/abb7bfe3.jpg" width="30px"><span>免费的人</span> 👍（36） 💬（1）<div>从kafka论文里摘的：
In addition we optimize the network access for consumers. Kafka
is a multi-subscriber system and a single message may be
consumed multiple times by different consumer applications. A
typical approach to sending bytes from a local file to a remote
socket involves the following steps: (1) read data from the storage
media to the page cache in an OS, (2) copy data in the page cache
to an application buffer, (3) copy application buffer to another
kernel buffer, (4) send the kernel buffer to the socket. This
includes 4 data copying and 2 system calls. On Linux and other
Unix operating systems, there exists a sendfile API [5] that can
directly transfer bytes from a file channel to a socket channel.
This typically avoids 2 of the copies and 1 system call introduced
in steps (2) and (3). Kafka exploits the sendfile API to efficiently
deliver bytes in a log segment file from a broker to a consumer.</div>2019-08-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/dc/ce/a144dea1.jpg" width="30px"><span>yhh</span> 👍（23） 💬（5）<div>如果我们的应用程序需要对数据做进一步的加工，那还能使用零拷贝吗</div>2019-08-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6e/c8/ed2926b5.jpg" width="30px"><span>soimage</span> 👍（20） 💬（3）<div>看到最后，也没看出kafka快跟dma有关系，倒是跟zero-copy关系大一些，通过砍掉两次内核空间和用户空间的数据拷贝，以及内核态和用户态的切换成本来优化</div>2019-09-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/0d/40/f70e5653.jpg" width="30px"><span>前端西瓜哥</span> 👍（5） 💬（1）<div>我记得 Nginx 的静态服务器貌似也是零拷贝。市面上常见的web服务器的静态服务器应该都实现了零拷贝吧？</div>2019-10-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/5b/79/d55044ac.jpg" width="30px"><span>coder</span> 👍（5） 💬（1）<div> 超算里面核与核之间的数据拷贝，一般会通过基于IB总线的RDMA来完成，可以避免过cpu内核的开销，希望徐老师能讲一下rDMA</div>2019-08-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/97/5e/3a9928eb.jpg" width="30px"><span>纵横四海1949</span> 👍（3） 💬（2）<div>从C盘复制数据到D盘是怎么个过程呢？</div>2019-09-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg" width="30px"><span>安排</span> 👍（3） 💬（3）<div>C语言可以直接调Linux系统api实现零拷贝吗？有哪些api？</div>2019-08-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/fa/fd/ec24cba7.jpg" width="30px"><span>fcb的鱼</span> 👍（2） 💬（3）<div>cpu处理的是用户内存中的数据,访问不到操作系统中的数据。DMA处理的是操作系统内核中的数据，访问不到用户内存。可以这也理解吧？要不然为啥不让DMAC直接将数据从硬盘读到用户的内存呢？</div>2020-02-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/71/45/126cd913.jpg" width="30px"><span>袭</span> 👍（1） 💬（2）<div>如果不是由硬盘而是要从程序到网卡，可以省略socket buffer这一步吗？</div>2019-08-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/3a/4c/b6200773.jpg" width="30px"><span>一步</span> 👍（0） 💬（1）<div>&gt;第一次，是通过 DMA，从硬盘直接读到操作系统内核的读缓冲区里面。第二次，则是根据 Socket 的描述符信息，直接从读缓冲区里面，写入到网卡的缓冲区里面。

这个实现过程是硬盘向DMAC发出控制信号，由DMAC拉取数据，然后又因为目标地址是网卡，地址固定？所以不用经过寻址的过程吗？</div>2021-09-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/fd/be/079c78c7.jpg" width="30px"><span>焰火</span> 👍（75） 💬（2）<div>DMAC：我们不加工数据，只是数据的搬运工</div>2019-10-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/0e/3a/a84da865.jpg" width="30px"><span>Hellboy1989</span> 👍（28） 💬（2）<div>kafkad那么快，零拷贝是其中一面，他的硬盘顺序读写也是一个重要的原因。</div>2020-07-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/83/fb/621adceb.jpg" width="30px"><span>linker</span> 👍（18） 💬（0）<div>其实底层还是调用了linux的系统调用sendfile这个函数</div>2020-03-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/16/5b/83a35681.jpg" width="30px"><span>Monday</span> 👍（14） 💬（1）<div>面试被问到为什么kafka这么快，这篇文章至少可以作为原因之一。可惜今天才看到</div>2020-06-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg" width="30px"><span>QQ怪</span> 👍（9） 💬（0）<div>以前只知道kafka通过零拷贝技术提高了吞吐量，但不知道为什么？这下老师通过硬件知识体系理解了相关技术原理，简直太棒了</div>2019-12-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/e0/6b/f61d7466.jpg" width="30px"><span>prader26</span> 👍（9） 💬（1）<div>  因为cpu比较快，而io比较慢，所以在处理数据的时候，主板或者外部设备上添加了DMA这个io读取操作的协处理器。
 kafaka 是利用dma的硬件条件，减少，cpu对于数据的搬运次数，因为kafuka在处理实时消息方面比较快。</div>2019-10-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/56/c6/0b449bc6.jpg" width="30px"><span>斐波那契</span> 👍（9） 💬（3）<div>老师 我想问一下 对于传统的四步读取文件然后网络发送里 操作系统的内核缓冲区是不是也在内存的某一个地方（只是用户访问不到）然后第二步 复制到应用程序内存中 事实上就是从内存的某一个地方复制到内存另一个地方 然后应用程序就可以操作了</div>2019-08-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5a/34/4cbadca6.jpg" width="30px"><span>吃饭睡觉打酱油</span> 👍（6） 💬（1）<div>老师，看完后对DMAC进行数据传输流程有疑问：1、为什么需要刚开始的第3步  2、第4的发起为什么是硬盘发起的，而不是DMAC ？</div>2021-01-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/09/d6/5f366427.jpg" width="30px"><span>码农Kevin亮</span> 👍（6） 💬（0）<div>请问老师，我是不是可以这样理解，java的fileChannel的api都是基于DMAC的实现？</div>2019-10-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e7/2e/1522a7d6.jpg" width="30px"><span>活的潇洒</span> 👍（3） 💬（0）<div>从去年一直在在用elk+kafka 作为日志系统，之所以选择kafka是因为知道他快，但是具体怎么快？为什么快只有学完这篇你会觉得一下通透了
day 48天笔记：https:&#47;&#47;www.cnblogs.com&#47;luoahong&#47;p&#47;11412797.html</div>2019-08-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ff/1e/2a40a5ca.jpg" width="30px"><span>大明</span> 👍（3） 💬（0）<div>哈哈哈哈</div>2019-08-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e2/b1/f2ac07ab.jpg" width="30px"><span>红泥小火炉</span> 👍（3） 💬（2）<div>对DMAC的长度配置时机有个疑问，一个DMAC下面可以挂多个设备吧，如果可以的话，不同设备的buffer长度是不同的，DMAC的长度配置做不到通用啊，难道是在每次传输前都需要配置一次？</div>2019-08-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4d/fd/0aa0e39f.jpg" width="30px"><span>许童童</span> 👍（2） 💬（1）<div>老师讲得好啊，之前一直不是很理解DMA是什么原理，到底是怎么工作的，这篇文章，深入浅出，感谢老师。</div>2019-08-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/f8/49/0c3a380d.jpg" width="30px"><span>Geek_aeeb45</span> 👍（1） 💬（0）<div>“DMAC 最有价值的地方体现在，当我们要传输的数据特别大、速度特别快，或者传输的数据特别小、速度特别慢的时候。”老师好，这句话中的“数据特别大、速度特别快，或者传输的数据特别小、速度特别慢”没太理解，可以详细解释一下吗？</div>2023-04-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/42/9d/c36b7ef7.jpg" width="30px"><span>顾骨</span> 👍（1） 💬（0）<div>传统的 sendfile 经历的过程：硬盘 -》kernel buffer -》socket buffer -》 NIC

只有网卡支持 scatter-gather 才是文中所描述的过程：硬盘 -》kernel buffer -》NIC

而且 Linux kernel 2.6.33 版本之后引入了新的系统调用 splice，一种软件实现的零拷贝技术</div>2021-10-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/18/4c/e12f3b41.jpg" width="30px"><span>姜姜</span> 👍（1） 💬（1）<div>如果用mmap内存映射到文件，也可以实现领拷贝，这种方式会使用到DMAC吗？</div>2020-11-06</li><br/><li><img src="" width="30px"><span>Geek_88604f</span> 👍（0） 💬（0）<div>提升 I&#47;O 设备速度的方法:把 HDD 硬盘换成 SSD 硬盘；用 PCI Express 接口的 SSD 硬盘替代 SATA 接口的 SSD 硬盘；DMA技术</div>2024-01-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/fa/64/457325e6.jpg" width="30px"><span>Sam Fu</span> 👍（0） 💬（0）<div>老师，这么说我理解凡是非阻塞 IO  都是由CPU 控制如，然后教给 DMA 实现的。 比如NIO，netty？</div>2023-07-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/7b/03/03583011.jpg" width="30px"><span>天天有吃的</span> 👍（0） 💬（0）<div>老师请问下，为什么说dmac适合数据量大，速度快的，或者数据量小，速度慢的，数据量大，速度慢的也可以不。或者说只有数据量小，速度快的不适合dmac？</div>2023-02-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/35/85/2f/547661e4.jpg" width="30px"><span>Retro0</span> 👍（0） 💬（0）<div>零拷贝是省略了在内存中， 从一个地址中把数据拷贝到另一个地址中吗？</div>2023-02-05</li><br/>
</ul>