上一讲里，根据DMP系统的各个应用场景，我们从抽象的原理层面，选择了AeroSpike作为KV数据库，Kafka作为数据管道，Hadoop/Hive来作为数据仓库。

不过呢，肯定有不信邪的工程师会问，为什么MongoDB，甚至是MySQL这样的文档数据库或者传统的关系型数据库不适用呢？为什么不能通过优化SQL、添加缓存这样的调优手段，解决这个问题呢？

今天DMP的下半场，我们就从数据库实现的原理，一起来看一看，这背后的原因。如果你能弄明白今天的这些更深入、更细节的原理，对于什么场景使用什么数据库，就会更加胸有成竹，而不是只有跑了大量的性能测试才知道。下次做数据库选型的时候，你就可以“以理服人”了。

## 关系型数据库：不得不做的随机读写

我们先来想一想，如果现在让你自己写一个最简单的关系型数据库，你的数据要怎么存放在硬盘上？

最简单最直观的想法是，用一个CSV文件格式。一个文件就是一个数据表。文件里面的每一行就是这个表里面的一条记录。如果要修改数据库里面的某一条记录，那么我们要先找到这一行，然后直接去修改这一行的数据。读取数据也是一样的。

要找到这样数据，最笨的办法自然是一行一行读，也就是遍历整个CSV文件。不过这样的话，相当于随便读取任何一条数据都要扫描全表，太浪费硬盘的吞吐量了。那怎么办呢？我们可以试试给这个CSV文件加一个索引。比如，给数据的行号加一个索引。如果你学过数据库原理或者算法和数据结构，那你应该知道，通过B+树多半是可以来建立这样一个索引的。
<div><strong>精选留言（22）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/cf/96/251c0cee.jpg" width="30px"><span>xindoo</span> 👍（41） 💬（3）<div>我想起来一个段子，某大厂对外宣称把mysql的性能提升了十几倍，其实是改用了SSD。</div>2019-09-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/bf/aa/abb7bfe3.jpg" width="30px"><span>免费的人</span> 👍（34） 💬（2）<div>用户态程序 怎么控制顺序写还是随机写？</div>2019-09-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/34/df/64e3d533.jpg" width="30px"><span>leslie</span> 👍（7） 💬（2）<div>      提出一点质疑希望老师不要介意啊，毕竟学习的过程以及和老师交互还是比较愉快：老师用CSV格式去说MYSQL好像不太合适吧，mysql其实很少会导出成CSV格式-oracle的特性，至少5.5和5.6都会导成sql格式，sql server都很少会用这种格式去导成CSV文件-导入不太方便，Oracle倒是这种形式最方便且速度方面最稳定。
       老师说马上就要完课了：这门课还有多久啊？真正沉浸学习中发现课程结束的都超快，两门课结合着学习-发现时光如梭，前天刘老师的课刚收尾，老师的课就要结束了；真快。</div>2019-09-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg" width="30px"><span>安排</span> 👍（7） 💬（6）<div>b+ 树索引中会存储每行数据在硬盘中的物理地址吗？这个物理地址是不是由好几部分组成，比如柱面，磁道，扇区的组合。
那B+ 树索引本身又是怎么存放的呢？b+树要存到硬盘上的话需要做特殊的序列化吗？怎么才能保证从硬盘读入索引数据后快速的在内存生成一棵B+树呢？</div>2019-09-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/e1/d4/1b5ac51e.jpg" width="30px"><span>山间竹</span> 👍（4） 💬（4）<div>我想问一下，Cassandra在hdd上删除重写是个怎么样的机制呢？会不会出现碎片，然后直接影响到顺序大块写？</div>2020-01-06</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqLcWH3mSPmhjrs1aGL4b3TqI7xDqWWibM4nYFrRlp0z7FNSWaJz0mqovrgIA7ibmrPt8zRScSfRaqQ/132" width="30px"><span>易儿易</span> 👍（4） 💬（1）<div>透过现象看本质，跟着老师的讲解一层层剥离原理，知其然，并知所以然~希望以后自己也能深度分析技术原理进行技术选型，而不是盲从大流以及试试看不行就换……</div>2019-09-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/fa/fd/ec24cba7.jpg" width="30px"><span>fcb的鱼</span> 👍（1） 💬（1）<div>你好，问下
1.Cassandr 数据库在数据读取层面，通过内存缓存+ BloomFilte+硬盘的机制来保证随机读的问题。想问下这个随机读的过程中，请求只查询内存的数据占多大比例呢？在Cassandr数据库的架构里边，这个内存占用率是多少(比如是不是硬盘是10G,内存是1G).这种架构。
2.如果mysql在不考虑随机写的场景下，使用这种内存+硬盘的方案是不是也可以的？</div>2020-02-08</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKugZjntLzMGvDicZaX7pAuwNw3aneI2zZlicKh0fqsmmlJ9VRrSjBBJc1m8K6CPuV6WQuHic4zNZT8Q/132" width="30px"><span>Geek_vqdpe4</span> 👍（1） 💬（1）<div>中途一度落后了20多节课，然后每天都看一两篇再度追上了进度，课程越后面越精彩</div>2019-09-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/4f/60/049a20e9.jpg" width="30px"><span>吴宇晨</span> 👍（1） 💬（1）<div>列式存储是按同一列数据cun</div>2019-09-05</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJLgibqHsl97Oq3nvnEVz7V3kaGKLmia0Ja8c4yXO7QeLKiakganRJomNGgYToW4RnFs60zibDTHicjE5w/132" width="30px"><span>学而不思则惘</span> 👍（12） 💬（0）<div>之前一直没有研究过Cassandra，看了这篇文章才知道，原来和hbase等系列的日志型nosql基本一致，同样的lms树的随机读取效率低，同样的内置布隆过滤器，内置的查询缓存，还有同样的compact，甚至大文件拆分，Google的BigTable还真是影响深远啊</div>2020-08-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/70/0d/f4c7a01f.jpg" width="30px"><span>Ki</span> 👍（1） 💬（0）<div>请问下、怎么快速找到一个软件对应的论文呢、比如我想找kafka的论文、或者是找flink的论文、该怎么找呢</div>2020-09-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e7/2e/1522a7d6.jpg" width="30px"><span>活的潇洒</span> 👍（1） 💬（0）<div>坚持到最后、你会收获不一样的自己、加油

day53 笔记：https:&#47;&#47;www.cnblogs.com&#47;luoahong&#47;p&#47;11514616.html</div>2019-09-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/81/e9/d131dd81.jpg" width="30px"><span>Mamba</span> 👍（0） 💬（0）<div>在ClickHouse中，数据是按列存储的，这意味着每一列的数据是连续存储在硬盘上的，而不是像传统的关系型数据库那样按行存储。</div>2024-09-26</li><br/><li><img src="" width="30px"><span>Geek_88604f</span> 👍（0） 💬（0）<div>WAL+LSM+SSD是大数据绝配</div>2024-02-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/42/7c/8ef14715.jpg" width="30px"><span>NIXUS</span> 👍（0） 💬（0）<div>1、BloomFilter过滤掉不存在的数据的读取后，在读存在的数据的时候，还是要去硬盘读，“按照从新到旧的读取方式”，应该如何理解“从新到旧读取”呢？“从新到旧读”，是读一次还是读多次？
2、在进行合并compaction的时候，怎么知道合并后的数据地址？是用像前面讲内存的时候，讲到的页映射吗？还是说，合并compaction执行的就是类似MySQL的update操作？如果是这样的话，还是会有insert后，数据地址变动的问题在；</div>2020-05-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0b/6f/68cd0614.jpg" width="30px"><span>brian</span> 👍（0） 💬（1）<div>老师，上一讲设计DMP kv数据库是选择 AeroSpike 
这一讲用Cassandra，两者有什么区别吗？</div>2020-05-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e3/78/3321053c.jpg" width="30px"><span>hshayq</span> 👍（0） 💬（0）<div>今天刚看 ddia 中说明 Cassandra 的存储原理，没想到这里也看到了(oﾟvﾟ)ノ</div>2020-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4f/3f/6f62f982.jpg" width="30px"><span>wangkx</span> 👍（0） 💬（1）<div>&gt; SSD 硬盘本身的擦除后才能写入的机制，正好非常适合 Cassandra 的数据读写模式

各位，有谁帮忙解释下，我怎么get不到这一点呀?</div>2020-04-16</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/gmP4Yh00MZPwNvr4UQdLeXaX3TVyZEEp195S3vD3Sfl1xz5jBr1474Mt6w5OPr0KsrnQObfLRy5PkKNFjSBiasA/132" width="30px"><span>大头爸爸</span> 👍（0） 💬（1）<div>Cassandra和BigTable是什么区别啊？看了一下基本原理好像是一样的？</div>2020-03-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/fc/d4/743d3f02.jpg" width="30px"><span>Anthony</span> 👍（0） 💬（0）<div>Cassandra的列族让我想到了es的存储方式，建一个个index来区分不同类型的数据，方便查询和存储</div>2020-03-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c0/6c/29be1864.jpg" width="30px"><span>随心而至</span> 👍（0） 💬（0）<div>只有明白1+1，才可以推到公式，读这篇文章有种酣畅淋漓的感觉，赞赞赞</div>2019-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/e0/6b/f61d7466.jpg" width="30px"><span>prader26</span> 👍（0） 💬（0）<div>cassendra (通过优化随机读取) 和ssd  硬盘可以更好的支持并发。</div>2019-10-18</li><br/>
</ul>