过去两讲，我为你讲解了流水线设计CPU所需要的基本概念。接下来，我们一起来看看，要想通过流水线设计来提升CPU的吞吐率，我们需要冒哪些风险。

任何一本讲解CPU的流水线设计的教科书，都会提到流水线设计需要解决的三大冒险，分别是**结构冒险**（Structural Hazard）、**数据冒险**（Data Hazard）以及**控制冒险**（Control Hazard）。

这三大冒险的名字很有意思，它们都叫作**hazard**（冒险）。喜欢玩游戏的话，你应该知道一个著名的游戏，生化危机，英文名就叫Biohazard。的确，hazard还有一个意思就是“危机”。那为什么在流水线设计里，hazard没有翻译成“危机”，而是要叫“冒险”呢？

在CPU的流水线设计里，固然我们会遇到各种“危险”情况，使得流水线里的下一条指令不能正常运行。但是，我们其实还是通过“抢跑”的方式，“冒险”拿到了一个提升指令吞吐率的机会。流水线架构的CPU，是我们主动进行的冒险选择。我们期望能够通过冒险带来更高的回报，所以，这不是无奈之下的应对之举，自然也算不上什么危机了。

事实上，对于各种冒险可能造成的问题，我们其实都准备好了应对的方案。这一讲里，我们先从结构冒险和数据冒险说起，一起来看看这些冒险及其对应的应对方案。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/8c/19/4e1989bf.jpg" width="30px"><span>记忆犹存</span> 👍（23） 💬（3）<div>计算机硬件和软件最常用的思想：增加一个中间层。</div>2019-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/1c/4b/2e5df06f.jpg" width="30px"><span>三件事</span> 👍（6） 💬（2）<div>请问下老师，MIPS 的 delay slot 和流水线冒泡是一样的吗？老师可以讲解下 delay slot 吗？</div>2020-02-16</li><br/><li><img src="" width="30px"><span>Geek_32100d</span> 👍（1） 💬（2）<div>hazard这个词很有意思，我自己生物专业，第一次接触hazard这个词是生物专业文献里的harzardous和biohazard，感觉“危害”这个义项用的更加频繁一点，“危机”这个义项少一点，“机会”“机遇”“冒险”这个义项更加少见；查了一下它的词源，原来开始是赌博相关的，进而引申出机会机遇的意思，再引申出危机危害的意思，词汇义项演变挺有意思。先面试查到的词源，供大家参考理解：

hazard (n.)
c. 1300, name of a game at dice, from Old French hasard, hasart &quot;game of chance played with dice,&quot; also &quot;a throw of six in dice&quot; (12c.), of uncertain origin. Possibly from Spanish azar &quot;an unfortunate card or throw at dice,&quot; which is said to be from Arabic az-zahr (for al-zahr) &quot;the die.&quot; But this is doubtful because of the absence of zahr in classical Arabic dictionaries. Klein suggests Arabic yasara &quot;he played at dice;&quot; Arabic -s- regularly becomes Spanish -z-. The -d was added in French through confusion with the native suffix -ard. Sense evolved in French to &quot;chances in gambling,&quot; then &quot;chances in life.&quot; In English, sense of &quot;chance of loss or harm, risk&quot; first recorded 1540s.</div>2023-05-02</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqyicZYyW7ahaXgXUD8ZAS8x0t8jx5rYLhwbUCJiawRepKIZfsLdkxdQ9XQMo99c1UDibmNVfFnAqwPg/132" width="30px"><span>程序水果宝</span> 👍（1） 💬（1）<div>为啥把内存拆成程序内存和数据内存这两部分以后就不能根据实际情况动态分配内存了？</div>2020-02-10</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqLcWH3mSPmhjrs1aGL4b3TqI7xDqWWibM4nYFrRlp0z7FNSWaJz0mqovrgIA7ibmrPt8zRScSfRaqQ/132" width="30px"><span>易儿易</span> 👍（158） 💬（7）<div>一路纵队，前边有人停下系鞋带，后边所有人都得原地踏步踏，不然就得踩着脑袋过去了……</div>2019-06-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a1/cd/2c513481.jpg" width="30px"><span>瀚海星尘</span> 👍（33） 💬（0）<div>因为如果前一个指令插入nop后一个指令不插，那么当前指令被延迟执行的阶段就会和下一个指令的统一阶段在同一个周期内一起执行，而这是电路结构不允许的，统一阶段同一周期只能有单一输入。</div>2019-07-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/79/4b/740f91ca.jpg" width="30px"><span>-W.LI-</span> 👍（18） 💬（0）<div>先写后读:数据依赖，读依赖于之前的写正常的依赖关系所以叫数据依赖。
先读后写:反依赖，要保证读到写之前的数据，与正常的相反叫反依赖。
写完再写:输出依赖。两次写操作顺序反了的话输出就错了。所以叫输出依赖。
记不住不晓得这么理解可以么</div>2019-06-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/5b/79/d55044ac.jpg" width="30px"><span>coder</span> 👍（6） 💬（3）<div>用了这么久的HHKB都不知道普通键盘还有锁键的问题🌚🌚🌚</div>2019-06-14</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erpYAcOqrNNxmMuKsd6Dh69BzxiaXjJRh6IMnQlxOqBFiae1EMic32Wv6aFESWytliaL7uniaZ4DgNUwxg/132" width="30px"><span>黄序</span> 👍（4） 💬（0）<div>如果拆分为数据内存和程序内存，那么我们的程序指令就不能放到数据内存里面去了，那么程序内存中就需要增加指向数据内存的指针，用来程序运行时从数据内存中获取数据；这样一来，一是增加了内存的占用，二是增加了程序运行的复杂度，如果我们在一个程序中用到了几千个数据，我们就要取几千次数据，这种延时对于内存和CPU而言，是无法忍受的。同时，如果多核CPU之间需要访问相同的内存地址，就可能出现竞争的问题；但是如果在中间增加一层缓存，那么就可以提升访问的速度，达到CPU的容忍程度，并且多核CPU之间也不需要因为要访问相同的内存地址而出现竞争的问题。但是缓存的存在就导致了数据原子性和一致性的问题，所以才需要进行加锁或者volatile等关键字(java)</div>2021-09-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/9b/2e/7c749c3f.jpg" width="30px"><span>Jason</span> 👍（4） 💬（0）<div>为了解决内存的结构冒险，将高速缓存分为数据缓存和指令缓存，但是在访问内存时问题仍然是存在的，能不能在内存中添加两个地址译码器？</div>2020-03-04</li><br/><li><img src="" width="30px"><span>Geek_96685a</span> 👍（3） 💬（0）<div>太牛逼了，我看完这个专栏，一下子解答了我很多疑惑</div>2022-07-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/9a/89/babe8b52.jpg" width="30px"><span>A君</span> 👍（3） 💬（0）<div>流水线的引入，导致同一个时钟周期内，取指令和写内存会存在冲突，无法并行完成，因此，引入数据缓存和指令缓存，让两操作互不干扰。
数据冒险又分为数据依赖，反依赖和输出依赖三类。解决方法是在指令译码完成后，根据要访问的寄存器和内存地址来决定是不是要插入以及要插入几个停顿，即nop指令。</div>2020-06-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/a5/98/a65ff31a.jpg" width="30px"><span>djfhchdh</span> 👍（3） 💬（0）<div>在当前指令插入nop可能会对后续指令造成新的依赖，干脆后面的指令也加上nop操作，要等就一起等</div>2019-06-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/15/69/187b9968.jpg" width="30px"><span>南山</span> 👍（3） 💬（6）<div>如果内存地址 b 的指令在内存地址 4 的指令之后写入。
    老师这个是b在4之前才是先写在写有问题吧？对后续程序来说 a＝2应该才是正确的吧</div>2019-06-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/78/7b/09defb8d.jpg" width="30px"><span>Yongtao</span> 👍（1） 💬（0）<div>当前指令插入了NOP，后续指令如果不插入NOP，就会发生结构冒险。</div>2021-07-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/3a/6d/8b417c84.jpg" width="30px"><span>Wheat Liu</span> 👍（1） 💬（0）<div>老师，关于结构冒险有两个问题。
第一个问题是，在一个指令周期中，结构冒险的冲突是否只有“取指令”和“内存访问”两个操作所对应的地址译码器是冲突的，会不会还别的操作或者别的元件冲突
第二个问题是，虽然将CPU Cache分为了两部分，但是实际上在第一次进行“取指令”和“内存访问”的时候还是需要走硬件，是不是依然有冲突的问题</div>2021-01-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/81/e9/d131dd81.jpg" width="30px"><span>Mamba</span> 👍（0） 💬（0）<div>因为一旦插入NOP，后续的操作也会产生响应的数据依赖，整个流水线也要做相应调整，即所有后续指令也要插入对应的 NOP 操作
</div>2024-08-23</li><br/><li><img src="" width="30px"><span>Geek_88604f</span> 👍（0） 💬（0）<div>1.结构冒险:不同的工作阶段同时使用相同的硬件资源导致冲突，解决方案是增加资源
    2.数据冒险:多个指令之间存在数据依赖，解决方案是等一等（译码器可以通过译码后的操作码、操作数、所使用的寄存器等判断是否存在数据冒险）</div>2023-11-02</li><br/><li><img src="" width="30px"><span>Geek_88604f</span> 👍（0） 💬（0）<div>1.结构冒险:不同的工作阶段同时使用相同的硬件资源导致冲突，解决方案是增加资源
    2.数据冒险:多个指令之间存在数据依赖，解决方案是等一等（译码器可以通过译码后的操作码、操作数、所使用的寄存器等判断是否存在数据冒险）</div>2023-11-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/64/82/d1423f4c.jpg" width="30px"><span>三刀</span> 👍（0） 💬（0）<div>“如果内存地址 b 的指令在内存地址 4 的指令之后写入” ---后 -&gt; 前</div>2022-11-14</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJW0UHU6icF3VWsicrqJeyMbhbRDuj6lrRSuTt4V8l7Tk9gnxgCxzed5YjiaowyRQaCria6PjI6ba3ia4g/132" width="30px"><span>InfoQ_5b50c2ad07cd</span> 👍（0） 💬（0）<div>CPU 在同一个时钟周期，同时在运行两条计算机指令的不同阶段。
是不是说在同一个时钟周期内，CPU是类似多线程的在执行不同阶段的指令？
如果是，那是不是意味着有几级流水线，就需要有几个线程？
如果不是，请问这句话怎么理解？</div>2022-09-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/94/84/04119eab.jpg" width="30px"><span>Hulu warrior</span> 👍（0） 💬（0）<div>看来有些架构会有branch delay（比如MIPS R3000）是这个因为pipeline stall的原因</div>2022-08-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/29/b9/24/0351fe33.jpg" width="30px"><span>oxygen_酱</span> 👍（0） 💬（0）<div>很多单片机，因为不是定位为通用计算机，所以仍然使用哈佛架构</div>2021-12-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/27/df/70/8d2c1e38.jpg" width="30px"><span>可以</span> 👍（0） 💬（0）<div>请问 指令周期 有处理 总线冲突 的阶段吗？如果总线冲突了CPU是处于停机状态吗？</div>2021-09-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/42/3e/edb93e8c.jpg" width="30px"><span>青山</span> 👍（0） 💬（0）<div>老师我想问一下 &quot;如果内存地址 b 的指令在内存地址 4 的指令之后写入。&quot;和 &quot;我们也需要保障内存地址 4 的指令的写入，在内存地址 b 的指令的写入之前完成。&quot;他们的意思不都是4先写入b后写入吗?</div>2021-06-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d4/f3/129d6dfe.jpg" width="30px"><span>李二木</span> 👍（0） 💬（0）<div>“同一个时钟周期，两个不同指令访问同一个资源”这张图中 同时出现了 两个第3条指令。最后一个是第4条指令。</div>2021-03-29</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/VqgchrJWswwSLmxf1ict6icDDlZG5wChBEiaiblnJAQEdu1nYtB4EZq07mibUurOSDFr16dho6DhGyOpIW4eib57lK8Q/132" width="30px"><span>箭指流云</span> 👍（0） 💬（1）<div>如果出现两个指令同时取数据，数据缓存不是还是会有冲突吗</div>2021-02-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/5f/aa/63e641c1.jpg" width="30px"><span>H</span> 👍（0） 💬（1）<div>取指令-译码-执行指令-访存-写回
“访存”是访问数据内存，这个怎么理解哈，执行完命令后，再去访问内存数据吗，然后再写回寄存器？这个访存究竟怎么理解哈？</div>2020-12-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5a/34/4cbadca6.jpg" width="30px"><span>吃饭睡觉打酱油</span> 👍（0） 💬（0）<div>插入 NOP 操作，所有后续指令也要插入对应的 NOP 操作，这是为什么呢？
是因为后续指令可能和当前指令的执行形成依赖关系么？</div>2020-12-29</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/j24oyxHcpB5AMR9pMO6fITqnOFVOncnk2T1vdu1rYLfq1cN6Sj7xVrBVbCvHXUad2MpfyBcE4neBguxmjIxyiaQ/132" width="30px"><span>vcjmhg</span> 👍（0） 💬（0）<div>其实解决依赖的方式除了插入nop指令外还有其他方法：
1.硬件自动冻结流水线周期。
2.指令重调度。（调整指令执行顺序）</div>2020-09-10</li><br/>
</ul>