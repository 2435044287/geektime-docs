坚持到底就是胜利，终于我们一起来到了专栏的最后一个主题。让我一起带你来看一看，CPU到底能有多快。在接下来的两讲里，我会带你一起来看一个开源项目Disruptor。看看我们怎么利用CPU和高速缓存的硬件特性，来设计一个对于性能有极限追求的系统。

不知道你还记不记得，在[第37讲](https://time.geekbang.org/column/article/107477)里，为了优化4毫秒专门铺设光纤的故事。实际上，最在意极限性能的并不是互联网公司，而是高频交易公司。我们今天讲解的Disruptor就是由一家专门做高频交易的公司LMAX开源出来的。

有意思的是，Disruptor的开发语言，并不是很多人心目中最容易做到性能极限的C/C++，而是性能受限于JVM的Java。这到底是怎么一回事呢？那通过这一讲，你就能体会到，其实只要通晓硬件层面的原理，即使是像Java这样的高级语言，也能够把CPU的性能发挥到极限。

## Padding Cache Line，体验高速缓存的威力

我们先来看看Disruptor里面一段神奇的代码。这段代码里，Disruptor在RingBufferPad这个类里面定义了p1，p2一直到p7 这样7个long类型的变量。

```
abstract class RingBufferPad
{
    protected long p1, p2, p3, p4, p5, p6, p7;
}
```

我在看到这段代码的第一反应是，变量名取得不规范，p1-p7这样的变量名没有明确的意义啊。不过，当我深入了解了Disruptor的设计和源代码，才发现这些变量名取得恰如其分。因为这些变量就是没有实际意义，只是帮助我们进行**缓存行填充**（Padding Cache Line），使得我们能够尽可能地用上CPU高速缓存（CPU Cache）。那么缓存行填充这个黑科技到底是什么样的呢？我们接着往下看。
<div><strong>精选留言（22）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/ab/98/6f29f4f2.jpg" width="30px"><span>小海海</span> 👍（48） 💬（4）<div>老师，有个疑惑的地方：文中讲了RingBuffer类利用缓存行填充来解决INITIAL_CURSOR_VALUE伪共享的问题，但是我记得Java对象内存布局是：实例变量放在堆区，静态变量属于类，放在方法区，而堆区和方法区在内存里肯定是隔离开的，但是RingBuffer的前后填充字段都是实例字段，而INITIAL_CURSOR_VALUE是静态常量，所以实际运行中他们肯定不是紧密排列在一起的，那么就解决不了伪共享的问题了，况且RingBuffer的子类RingBufferFields还有其他实例字段，如：indexMask、entries、bufferSize、sequencer，这些字段都是final修饰的，即对象构建后不会再修改，所以我理解前后的缓存行填充守护的应该是这几个字段，而且从子类RingBufferFields的命名也可以看出前面那几个字段才是想要缓存的字段。希望得到老师的回复，另外课程快结束了，一路跟下来收获很大，我准备这段时间二刷来巩固下^_^</div>2019-09-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/e1/d4/1b5ac51e.jpg" width="30px"><span>山间竹</span> 👍（39） 💬（1）<div>在java8中，jvm团队搞出了@Contended注解来进行支持，在你需要避免“false sharing”的字段上标记注解，这可以暗示虚拟机“这个字段可以分离到不同的cache line中”，这是JEP 142的目标。</div>2020-01-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ae/0c/f39f847a.jpg" width="30px"><span>D</span> 👍（24） 💬（2）<div>这个是不是和前面讲的msei有一定关系啊，请徐老师点拨</div>2019-09-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/44/0e/ce14b7d3.jpg" width="30px"><span>-_-|||</span> 👍（20） 💬（5）<div>“而 Disruptor 很取巧地在需要频繁高速访问的变量，也就是 RingBufferFields 里面的 indexMask 这些字段前后，各定义了 7 个没有任何作用和读写请求的 long 类型的变量。”为什么前后各7个，cache line 就没有写的请求，就是因为8个long正好64byte吗，为什么没有写的呢？</div>2020-01-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/34/df/64e3d533.jpg" width="30px"><span>leslie</span> 👍（18） 💬（2）<div>    老师今天说的这个东西其实就是MQ：只不过现在的MQ基本上是在充分利用内存&#47;缓存，而disruptor其实是在利用CPU cache。刘超老师有一点确实没有说错“计算机组成原理和操作系统相辅相成”：学到今天去相互结合确实发现这种收益远比单独学习好。
      扩展的问老师一个问题：现在所谓的智能芯片或者说前端时间提出的智能芯片，会对后续产生革命性影响么？毕竟硬件的i5到现在差不多十多年了其实进步不大，这十余年最大的变化莫过于内存容量的暴涨造就了nosql、MQ的兴起，如果说将来cache的变化是吧同样可能早就类似于老师今天所说的Disruptor这种基于CPU Cache技术的兴起。
        今年华为的AI CPU、老美那边的云计算CPU似乎实验室测试已经通过了：毕竟从奔腾4之后到现在近20年了，老师今天所说的又刚好符合现在关键硬件CPU的革新时期？老师对此是如何看待？希望老师能提点。</div>2019-09-06</li><br/><li><img src="" width="30px"><span>Scott</span> 👍（14） 💬（1）<div>最好说明一下，这种填充cache line的手法是为了防止False Sharing</div>2019-09-06</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqLcWH3mSPmhjrs1aGL4b3TqI7xDqWWibM4nYFrRlp0z7FNSWaJz0mqovrgIA7ibmrPt8zRScSfRaqQ/132" width="30px"><span>易儿易</span> 👍（7） 💬（1）<div>经典的东西总是容易被频繁引用，disruptor记得没错应该是在java并发实战专栏里被王宝令老师讲过，今天又一次学习，加深了印象……拍个双响马屁：两位老师都有很高的水准，深入浅出！</div>2019-09-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/44/0e/ce14b7d3.jpg" width="30px"><span>-_-|||</span> 👍（2） 💬（1）<div>“我们现在的 64 位 Intel CPU 的计算机，缓存行通常是 64 个字节（Bytes）”，64位为什么不是64bit而是设计成64Byte的缓存行，感觉应该叫64比特intel CPU的计算机。</div>2020-01-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4d/fd/0aa0e39f.jpg" width="30px"><span>许童童</span> 👍（2） 💬（1）<div>老师讲得实在是太好了。</div>2019-09-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/9c/15/719f1f44.jpg" width="30px"><span>等风来</span> 👍（3） 💬（3）<div>老师， 我对于前后7个long有点疑惑， 我大概知道是为了防止被换出， 但就是不知道为什么可以😂， 可以举例说明一下吗</div>2019-10-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/5a/56/115c6433.jpg" width="30px"><span>jssfy</span> 👍（2） 💬（0）<div>这一系列文章太赞了，这几天一有空就看，完全停不下来！真实场景代码配合原理，特别是各个文末推荐的阅读，真所谓授之以渔。</div>2021-10-28</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI0eGJygV4lh6PJuotKrz1jsZcOdNiaHnUC3y5A2O3yudUQLkzOE8758icDoXlvgpytQ50ibSIc9nJmg/132" width="30px"><span>余巍</span> 👍（2） 💬（0）<div>注意一下类是abstract。父子类属性原理。pad父类填充属性在前，field父类的属性被保护在中间，ringbuffer子类填充属性在最后。这样就杜绝被其他cache line影响。</div>2020-11-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/e8/52/931888d7.jpg" width="30px"><span>InvisibleDes</span> 👍（2） 💬（0）<div>对分支预测的执行很有利，这一点没有看懂</div>2020-10-17</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/zUZMSvia9ByR2YbkeB9T4oymlzDCEsxUb4xPUNo39xgehdF0uqtWBRz5avLI3U5vS0XWVEKNWDpFtFib6s9v5kNA/132" width="30px"><span>Geek_e9a05e</span> 👍（1） 💬（1）<div>请教一下大家，老师文中说了数组形式的数据进行遍历访问时，会增加分支预测的准确性，我不太理解，为什么呢？</div>2022-07-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ec/2a/b11d5ad8.jpg" width="30px"><span>曾经瘦过</span> 👍（1） 💬（0）<div>赞，之前还以 计算机组成原理主要是架构师 选择技术 硬件 的时候使用的，原来在代码层面也可以这样使用。不过虽然能看懂他代码的意思，但是还不不太理解他是如何实现的，怎么写可以做到这样的，需要进一步的研究一下</div>2019-11-01</li><br/><li><img src="" width="30px"><span>Geek_88604f</span> 👍（0） 💬（0）<div>Disruptor 在 RingBufferFields 里面定义的变量的前后，分别定义了 7 个 long 类型的变量。这 14 个变量没有任何实际的用途。我们既不会去读他们，也不会去写他们--这样RingBufferFields前后如果有变量需要更新而被迫退出缓存，都不会导致RingBufferFields本身退出缓存。这样RingBufferFields就永远在缓存中</div>2024-02-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/3d/00/7daa7403.jpg" width="30px"><span>Eden Ma</span> 👍（0） 💬（0）<div>有意思 </div>2022-01-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/65/52/a662d972.jpg" width="30px"><span>Honer</span> 👍（0） 💬（0）<div>这个缓冲行填充让我想起了内存对齐</div>2021-10-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/8d/9a/61db513f.jpg" width="30px"><span>赵源😈</span> 👍（0） 💬（1）<div>一直有个问题想问老师：老师的表格中L1 cache 和L2 cache价格一样，但是L2更慢，那为什么不去掉L2 cache呢？</div>2021-03-04</li><br/><li><img src="" width="30px"><span>Paul Shan</span> 👍（0） 💬（1）<div>老师，现在只读变量使用地越来越多，为什么CPU没有提供特定的指令来优化只读变量的高速缓存（至少给开发人员一个选择，让这些变量尽量存在高速缓存而不调出）。不然也不会逼得Disruptor采用非常令人费解的填充方法，让字段常驻在缓存中。</div>2020-09-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/95/af/b7f8dc43.jpg" width="30px"><span>拓山</span> 👍（0） 💬（0）<div>这个填充思路 闻所未闻。
实在脑洞大开，赞！</div>2019-10-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e7/2e/1522a7d6.jpg" width="30px"><span>活的潇洒</span> 👍（0） 💬（3）<div>从该专栏的每一讲的每一个主题开始、夯实基础：我们未来生活的可能性就是靠这些点点滴滴串联起来的

day54 笔记 ：https:&#47;&#47;www.cnblogs.com&#47;luoahong&#47;p&#47;11518304.html</div>2019-09-15</li><br/>
</ul>