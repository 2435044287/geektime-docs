上一讲，我提到词法分析的工作是将一个长长的字符串识别出一个个的单词，这一个个单词就是Token。而且词法分析的工作是一边读取一边识别字符串的，不是把字符串都读到内存再识别。你在听一位朋友讲话的时候，其实也是同样的过程，一边听，一边提取信息。

那么问题来了，字符串是一连串的字符形成的，怎么把它断开成一个个的Token呢？分割的依据是什么呢？本节课，我会通过讲解正则表达式（Regular Expression）和有限自动机的知识带你解决这个问题。

其实，我们手工打造词法分析器的过程，就是写出正则表达式，画出有限自动机的图形，然后根据图形直观地写出解析代码的过程。而我今天带你写的词法分析器，能够分析以下3个程序语句：

- age &gt;= 45
- int age = 40
- 2+3\*5

它们分别是关系表达式、变量声明和初始化语句，以及算术表达式。

接下来，我们先来解析一下“age &gt;= 45”这个关系表达式，这样你就能理解有限自动机的概念，知道它是做词法解析的核心机制了。

## 解析 age &gt;= 45

在“[01 | 理解代码：编译器的前端技术](https://time.geekbang.org/column/article/118132)”里，我举了一个词法分析的例子，并且提出词法分析要用到有限自动机。当时，我画了这样一个示意图：

![](https://static001.geekbang.org/resource/image/6d/7e/6d78396e6426d0ad5c5230203d17da7e.jpg?wh=1142%2A325)

我们来描述一下标识符、比较操作符和数字字面量这三种Token的词法规则。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="" width="30px"><span>KnowNothing</span> 👍（65） 💬（14）<div>老师，在关键字和保留字的识别上，我认为有不需要加入中间状态的更简单的方式：
完成词法分析后，遍历所有ID token，如果其text在关键字和保留字集合内，将该token类型改成对应的关键字&#47;保留字类型。
或者，
每当识别出一个ID token，都检查其text，如果是在关键字和保留字集合内，纠正type。</div>2019-08-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/cb/a2/5e7c557e.jpg" width="30px"><span>傲娇的小宝</span> 👍（63） 💬（2）<div>感觉有限状态机有点类似图灵机的工作方式。我一般只用正则匹配一下文件名或者某个字符串是否符合我的预期。</div>2019-08-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/04/ec/0539c89d.jpg" width="30px"><span>易林林</span> 👍（52） 💬（1）<div>宫老师，例子里面的词法分析大多是靠条件判断来实现，如果对一门完整的语言来进行分析的话，工作量会不会很大。我在想，是否有其他方式可以实现？</div>2019-08-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/04/60/64d166b6.jpg" width="30px"><span>Fan</span> 👍（32） 💬（2）<div>宫老师，有没有一些词法分析的demo可以推荐看看呢？</div>2019-08-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/f8/ac/3a8a0b69.jpg" width="30px"><span>诺亚</span> 👍（23） 💬（2）<div>isAlpha 的 alpha 好像没有字母的意思吧？用 alphabet 会不会比较合适点？</div>2019-08-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/88/07/7804f4cc.jpg" width="30px"><span>逗逼师父</span> 👍（22） 💬（5）<div>老师您好，我的疑问是，age&gt;=45的有限状态机图中，为什么比较操作符不像标识符那样停留在同一个状态？我觉得&gt;和&gt;=都是属于比较操作符呀</div>2019-08-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/94/0a/7f7c9b25.jpg" width="30px"><span>宋健</span> 👍（20） 💬（1）<div>老师，我写完这一节激动的浑身发抖，自己果然实现了一个简单的词法分析器！老师讲得太棒了！</div>2020-03-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/2c/45/e8bcf142.jpg" width="30px"><span>(╯‵□′)╯︵┻━┻</span> 👍（16） 💬（1）<div>有回随手发现Google搜索可以使用正则表达式……然后感觉星星都亮了</div>2019-10-03</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEKvFRQRW4JSXBF6eeM2S6KyTR7dDNJbxXjbicOSvJqxYIDayjCEZcQOibAp6O6UluYuYF1tEKlW1jDg/132" width="30px"><span>请叫我赓哥</span> 👍（16） 💬（2）<div>您好，老师，初步接触编译原理，您讲的手工打造词法分析，是用已知的java或c或其他语言实现，我想问一下，c语言的编译器是用什么实现的呢，或者其他语言的编译器？另外其他的词法分析器又是用什么语言编写的呢，谢谢</div>2019-08-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ae/bd/d12f8907.jpg" width="30px"><span>梓航(﹏)</span> 👍（15） 💬（1）<div>我是来提意见的，麻烦老师在讲示例的时候，把对应的github链接贴上，而不是在最后贴一个总的地址，我点进去一脸懵，哪个文件对应哪个例子啊？</div>2019-08-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7a/88/b787338a.jpg" width="30px"><span>devna</span> 👍（15） 💬（2）<div>之前做的一个项目中有大量的历史遗留脚本是用Perl写的，于是主动去学了下Perl，不得不说，Perl是我见过所有语言里对正则表达式支持最强的，效率也是最高的(我想可能是因为Perl在语言核心内置了正则表达式引擎，不像其他语言，是通过各种模块支持的)。
后来从Perl了解到《精通正则表达式》这本书，买来看了下，确实是很好的一本书。虽然读完很久很多东西都忘了，但是对正则表达式的理解深刻了很多。</div>2019-08-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cf/96/251c0cee.jpg" width="30px"><span>xindoo</span> 👍（10） 💬（1）<div>正则表达式匹配3的任意倍数 https:&#47;&#47;www.zhihu.com&#47;question&#47;24824487</div>2019-08-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/d6/2c/9aa0ae40.jpg" width="30px"><span>阿尔伯特</span> 👍（8） 💬（2）<div>Mark.
https:&#47;&#47;github.com&#47;albertabc&#47;compiler&#47;blob&#47;master&#47;main.cpp</div>2019-08-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/56/c6/0b449bc6.jpg" width="30px"><span>斐波那契</span> 👍（8） 💬（1）<div>老师 这个有限自动机的状态确认是不是以空格为分界点？比如 int age = 45 在读i时进入int1状态 然后读n进入int2状态然后读t进入int3状态然后读到一个空格结束此时是在关键字状态 所以说int是一个关键字 然后在重新初始化状态开始读取age直到读到；为止？</div>2019-08-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/e4/b3/4dc5c168.jpg" width="30px"><span>哆啦B梦จุ๊บ</span> 👍（5） 💬（1）<div>听了老师的讲解，感觉没有想象的那么难，不管好坏，先敲一版出来总是没错的：
https:&#47;&#47;github.com&#47;zyfandtmx&#47;compile&#47;blob&#47;master&#47;src&#47;main&#47;java&#47;mycompiler&#47;lexical&#47;LexicalAnalysis.java</div>2019-11-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/73/56/9cfb1e43.jpg" width="30px"><span>sheeeeep</span> 👍（4） 💬（4）<div>ts的实现，请老师和同学指正。https:&#47;&#47;github.com&#47;sheeeeep&#47;fundamentals-of-compiling&#47;blob&#47;Ch02&#47;src&#47;lexical-analyser.ts</div>2019-08-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/9d/ef/93729443.jpg" width="30px"><span>冬瓜</span> 👍（4） 💬（4）<div>int 后面的 id 的正则是不是 [a-zA-Z_][0-9a-zA-Z_]*这样就行，为啥要将数字通过|连接呢？是不是有什么用意😳</div>2019-08-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/fd/83/b432b125.jpg" width="30px"><span>鱼_XueTr</span> 👍（4） 💬（1）<div>正则表达式在做爬虫和文本处理中用过比较多。</div>2019-08-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4d/fd/0aa0e39f.jpg" width="30px"><span>许童童</span> 👍（3） 💬（1）<div>正则表达式在实现中一般有两种：NFA和DFA，一般语言用DFA，但会有回溯的性能问题，用的时候一定要注意。</div>2019-08-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/07/fa/62186c97.jpg" width="30px"><span>恩佐</span> 👍（2） 💬（2）<div>https:&#47;&#47;github.com&#47;shaojintian&#47;learn_compiler
老师能看看我的lexer么？用golang写的
请老师和同学们指正，感谢</div>2019-11-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/01/38/5daf2cfb.jpg" width="30px"><span>吴军旗^_^</span> 👍（2） 💬（1）<div>用PHP实现的一个简单的词法分析器：https:&#47;&#47;github.com&#47;wujunqi&#47;compile&#47;blob&#47;master&#47;SimpleLexer.php</div>2019-09-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/9e/e5/6d03a341.jpg" width="30px"><span>姜大牙</span> 👍（2） 💬（1）<div>老师，是否有计划讲一下方舟编译器？</div>2019-09-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/91/d4/3785c799.jpg" width="30px"><span>乐毅</span> 👍（2） 💬（1）<div>老师，是否可以将关键字和保留字预先存储起来？ 如果可以，那和文中描述的方式有什么区别吗？</div>2019-08-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/55/b5/39affaad.jpg" width="30px"><span>Hkesd</span> 👍（2） 💬（1）<div>这里的有限自动机就是DFA吗？</div>2019-08-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ec/2a/b11d5ad8.jpg" width="30px"><span>曾经瘦过</span> 👍（2） 💬（1）<div>想问一下  一般的 高级语言中的context (上下文) 和编译有什么关联吗？ 在状态机模式中也有一个context 代表环境 包含了各种状态  </div>2019-08-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/b7/24/17f6c240.jpg" width="30px"><span>janey</span> 👍（2） 💬（1）<div>Golang 语言看上去简单搞清楚底层实现不容易，老师可否从编译原理的角度指点迷津？</div>2019-08-17</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/mWicFKgbjL299CQPEhoFdSLGvibCiaXeZo2EjV1hDLicPxicyRTWCODxeYwq8eBgxU6zUuU6rrIw3d7hGwFmRflicibHA/132" width="30px"><span>benben</span> 👍（2） 💬（1）<div>每当看到状态机图后就感觉明白怎么做了！老师的图真厉害😄</div>2019-08-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/c9/0b/1f95abb4.jpg" width="30px"><span>(口-口)🌟</span> 👍（2） 💬（1）<div>一般都是用来批量的处理数据的，比如把csv格式转换为json格式，方便程序操作，或者从日志冲筛选出指定的字段。</div>2019-08-16</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTImmLJCKerl9CI4sTpPDNCUgswp04ybsJ4J6mpJmMlHh43Iibp1RPOLam5PpOv2ZDGcjvGrY94lNRw/132" width="30px"><span>Varphp</span> 👍（2） 💬（2）<div>学习了  有点惧怕语法解析 词法还能看下去  </div>2019-08-16</li><br/><li><img src="" width="30px"><span>大鱼</span> 👍（1） 💬（1）<div>我相信搞数据清洗的同学或多或少的都会用到正则表达式：比如提取纯数字，纯字母，日期，http URL等“规则”的数据</div>2021-05-14</li><br/>
</ul>