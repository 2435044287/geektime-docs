你好，我是 LMOS。

上节课我们对一次请求到响应的过程积累了一些宏观认识，相信你已经对整个网络架构有了一个整体蓝图。这节课，让我们来仔细研究一下网络数据是如何在内核中流转的，让你开阔视野，真正理解底层工程的实现思路。

凡事先问目的，在网络数据在内核中的流转，最终要服务于网络收发功能。所以，我会先带你了解一次具体的网络发收过程，然后带你了解lwIP的网络数据收发。有了这些基础，我还会示范一下如何实现协议栈移植，你可以在课后自行动手拓展。

好，让我们正式开始今天的学习吧。课程配套代码，你可以点击[这里](https://gitee.com/lmos/cosmos/tree/master/lesson37/Cosmos)获取。

## 先看看一次具体的网络发收过程

理解软件的设计思想，最重要的是先要理解需求。而内核中的数据流转也只是为了满足网络收发的需求而进行的设计。

### 发送过程总览

下面我们一起来看看应用程序通过网络发送数据的全过程。

应用程序首先会准备好数据，调用用户态下的库函数。接着调用系统API接口函数，进入到内核态。

内核态对应的系统服务函数会复制应用程序的数据到内核的内存空间中，然后将数据移交给网络协议栈，在网络协议栈中将数据层层打包。

最后，包装好的数据会交给网卡驱动，网卡驱动程序负责将打包好的数据写入网卡并让其发送出去。

我为你准备了一张流程图供你参考，如下所示。
<div><strong>精选留言（8）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/2f/7a/ab6c811c.jpg" width="30px"><span>相逢是缘</span> 👍（4） 💬（1）<div>我们的 Cosmos 操作系统已经实现了xTaskCreateStatic、osSemaphoreCreate 等这些函数了吗？
一路跟着课程过来，没有发现呢，37课代码里面也没有呢</div>2021-08-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg" width="30px"><span>pedro</span> 👍（13） 💬（2）<div>由于历史的原因，主流的操作系统都是在内核实现网络协议栈，但是由于网络环境的日益复杂，用户对服务稳定性的要求越来越高。
内核网络协议栈的封闭性是一个很大的桎梏点，因此非内核网络协议栈早就被很多人实现了，例如 DPDK，号称能解决 c10m 问题。虽然现在内核协议栈仍然是主流，但可以预见的是非内核协议栈会越来被人接受，解决更多的实际需求。</div>2021-08-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/27/f8/2c/92969c48.jpg" width="30px"><span>青玉白露</span> 👍（6） 💬（2）<div>网络协议栈也可以放在用户态来执行。
需要注意的是，如今网速加快、网络环境复杂，多核的CPU在处理高速的网络请求时也会有很大的性能局限性。
而将网络协议栈放在用户态，就可以实现高度自定义，有关这方面的知识可以参考这个博客：https:&#47;&#47;www.cnblogs.com&#47;jmilkfan-fanguiju&#47;p&#47;12789805.html</div>2021-08-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/04/60/64d166b6.jpg" width="30px"><span>Fan</span> 👍（2） 💬（3）<div>找到个 lwIP的教程。
https:&#47;&#47;www.kancloud.cn&#47;jiejietop&#47;tcpip&#47;988547</div>2021-08-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/23/66/413c0bb5.jpg" width="30px"><span>LDxy</span> 👍（2） 💬（1）<div>协议栈应该也可以放在用户态实现，这时候就需要绕过内核的协议栈，直接和网卡驱动程序通信</div>2021-08-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/29/a6/ad/e65aec4c.jpg" width="30px"><span>苏流郁宓</span> 👍（1） 💬（1）<div>放在用户态是不是也有一个好处？由于网络数据包过来，假如原来给它分配的内存空间不够用（关键是还不能一直排队等）操作系统还要重新忙下手中的活，重新为它分配新的内存空间。再干别的，放在用户态的话。需求跟着用户态程序走（分配内存资源）翻译等任务跟着用户态程序走。操作系统不用在此之外重新去操心网络数据包的文件情况（例如，视频，照片等。），只需配合用户态程序工作就行（用户态需要调节用到的内核态指令）。这样大大利于网络的流畅稳定。
就像原来是参谋本部，管这管哪，中间存在很多需要通信功能问题（需要与用户态程序反复沟通，浪费时间和资源）现在是管大放小，实时任务由下面的将军（用户态程序）操心，操作系统管好后勤配合工作就行。</div>2021-11-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/27/ef/18/6a620733.jpg" width="30px"><span>kocgockohgoh王裒</span> 👍（0） 💬（1）<div>请问cosmos到底用的是nosys模式+ 模拟层实现的函数    还是带操作系统模式啊 有点晕</div>2022-01-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/66/11/f7408e3e.jpg" width="30px"><span>云师兄</span> 👍（0） 💬（1）<div>理解软件的设计思想，最重要的是先要理解需求。而内核中的数据流转也只是为了满足网络收发的需求而进行的设计。</div>2021-08-02</li><br/>
</ul>