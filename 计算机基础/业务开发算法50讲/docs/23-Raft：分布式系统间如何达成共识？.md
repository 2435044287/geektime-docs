你好，我是微扰君。

今天我们要来谈一谈分布式系统中一个非常重要的问题：分布式共识问题，也就是一致性问题。

我们知道，分布式系统的诞生，主要是为了提供单机无法进行的计算和存储、提高吞吐量、增加容错性等。而在现在的互联网架构下，分布式系统由于大量使用廉价的商用机器，节点故障是不可避免的。

在这种情况下，多个机器如何像一个整体一样工作，是件很困难的事情，这里一致性算法就起到了至关重要的作用。

以分布式KV存储系统为例，我们来先搞清楚分布式一致性到底解决的是什么问题。

## 复制状态机

之前在操作系统章节中讲过，数据库常用 redo-log 来实现事务等能力，那当这样的存储系统不再是单机节点，我们通常也需要采用多台机器来存储日志，把同样的日志在不同的节点都存储一份。这样如果有一台节点挂了，整个系统还可以用备份节点来提供日志的能力。

让多台服务器存储相同顺序的多条相同指令，也就是“日志”，可以帮助我们实现复制状态机。

![图片](https://static001.geekbang.org/resource/image/8f/58/8f0efe4c136272909a8a7376f0558758.jpg?wh=1920x1145)

**每一个状态的变更记录都会先在日志中存储并commit，之后才apply到状态机中修改对应的状态**，这个设计能在分布式系统中解决许多和容错性相关的问题。

既然涉及多个节点存储同样的一份东西，怎样才能保证多个独立的节点所存储的内容是一致的呢？这就是我们常说的“一致性问题”了。
<div><strong>精选留言（4）</strong></div><ul>
<li><img src="" width="30px"><span>松鼠鱼</span> 👍（2） 💬（1）<div>老师对于最后一张图的解释太粗略了，我贴一个网上看到的比较细致的给大家参考：
情况 a: 服务器 S1 在任期为 2 的时刻仅将日志 &lt;index: 2, term: 2&gt; 发送到了服务器 S2 便崩溃掉。
情况 b: 服务器 S5 在任期为 3 的时刻当选 Leader (S5 的计时器率先超时，递增任期号为 3 因此高于服务器 S3, S4，可以当选 Leader)，但没来得及发送日志便崩溃掉。
情况 c: 服务器 S1 在任期为 4 的时刻再次当选 Leader (S1 重启时，任期仍然为 2，收到新的 Leader S5 发送的心跳信息后更新任期为 3，而在 Leader S5 崩溃后，服务器 S1 为第一个计时器超时的，因此发起投票，任期更新为 4，大于网络中其他服务器任期，成功当选 Leader)，同时将日志 &lt;index: 2, term: 2&gt; 发送到了服务器 S2, S3，但还没有通知服务器对日志进行提交便崩溃掉。
情况 d: 情况 (a -&gt; d) 如果在任期为 2 时服务器 S1 作为 Leader 崩溃掉，S5 在任期为 3 的时刻当选 Leader，由于日志 &lt;index: 2, term: 2&gt; 还没有被复制到大部分服务器上，并没有被提交，所以 S5 可以通过自己的日志 &lt;index: 2, term: 3&gt; 覆盖掉日志 &lt;index: 2, term: 2&gt;。
情况 e: 情况 (a -&gt; e) 而如果在任期为 2 时服务器 S1 作为 Leader，并将 &lt;index: 2, term:2&gt; 发送到S2, S3，成功复制到大多数成员服务器上，并且成功提交了该日志。那么即便 S1 崩溃掉，S5 也无法成功当选 Leader，因为 S5 不具备网络中最新的已被提交的日志条目。</div>2022-03-13</li><br/><li><img src="" width="30px"><span>Geek_526cdc</span> 👍（0） 💬（0）<div>redolog实现事务么？不是undolog么？</div>2024-08-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/6b/e9/7620ae7e.jpg" width="30px"><span>雨落～紫竹</span> 👍（0） 💬（0）<div>这篇干货满满</div>2022-07-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg" width="30px"><span>peter</span> 👍（0） 💬（2）<div>请教老师三个问题：
Q1：分布式一致性具体分为哪几种一致性问题？ 比如分布式存储一致性等。
Q2：分布式事务算一致性问题吗？
Q3：Raft在哪些框架中被使用？</div>2022-02-13</li><br/>
</ul>