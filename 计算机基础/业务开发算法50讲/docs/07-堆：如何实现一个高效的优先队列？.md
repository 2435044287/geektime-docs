你好，我是微扰君。

上一讲学习了基于红黑树的ordered\_map的实现，今天我们来介绍另外一种有趣的树，heap，也就是堆。堆的应用非常广泛，我们常说的堆排序的堆就是指这种树状数据结构，除此之外还可以用来解决诸如TopK，或者合并多个有序小文件之类的问题。

堆也是我们最后一个基础数据结构容器-优先队列的常见底层实现方式。

### 优先队列

你一定还记得之前讲过的线性数据结构queue吧，也就是队列，一种先进先出的数据结构，生活中这种先进先出的场景也很常见，我们当时举了一个在餐厅排队取号的例子，先来的人一定会先取到号，也先被叫到号，这完美地符合队列的语义。

![图片](https://static001.geekbang.org/resource/image/03/75/031f3908df1315910fab5543a50e9575.jpg?wh=1920x736)

那如果我们现在希望允许一部分人插队呢？比如在医院中，大部分病人都有序的挂号排队，但这时候如果来了一个重症病患，我们就很可能需要破坏先进先出的规则，让医生优先诊断治疗这位病患。这种场景中的队列，我们就可以定义为“优先队列”。

优先队列中的每个元素，我们会赋予它一个优先级，优先级相同的元素我们还是遵循先进先出的原则，**但一定会保证队列中优先级更高的元素先出队，即使它进队时间更晚**。比如例子中的重症病患来的并不早，但依旧得到了医生的优先治疗。

对于这种优先队列，我们应该如何高效地实现呢？
<div><strong>精选留言（7）</strong></div><ul>
<li><img src="" width="30px"><span>Paul Shan</span> 👍（18） 💬（5）<div>堆排序并不是稳定排序，所以相同序号没法做到先进后出，如果要保证先进先出，一种方法是再加一层，每个节点用一个队列而不是简单的节点表示，这样所有权值相同的节点就进入了一个队列，然后用这个队列保证先进先出。还有一种方法是修改对键值的定义，也就是把时间因素考虑近来，让时间作为排序的次要因子，这样就可以保证键值唯一。</div>2021-12-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/25/78/dc/bcdb3287.jpg" width="30px"><span>丶</span> 👍（2） 💬（1）<div>昊哥，能不能讲解一下每篇文章后问题的答案呀？感觉自己心里有了答案，但是没有一个参考，总感觉不大对</div>2021-12-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/7e/50/63749d73.jpg" width="30px"><span>muyinliu</span> 👍（0） 💬（1）<div>这也说明 PQ 默认情况下实现的是小顶堆。
---
是否可以考虑把图都换成小顶堆的图，我第一次看本章的时候很疑惑，总觉得图和代码对不上号</div>2022-03-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/eb/19/0d990b03.jpg" width="30px"><span>ZeroIce</span> 👍（3） 💬（1）<div>上面那个满二叉树是不是和完全二叉树混淆？</div>2022-02-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ff/e9/276b9753.jpg" width="30px"><span>SevenHe</span> 👍（2） 💬（0）<div>一点收获，在遇到满二叉树或稠密二叉树的场景时，可以考虑用数组来存放，有如下优势：
1. 空间利用率高，比起指针的方式，也更满足内存局部性原理
2. 无需后继节点指针，内存占用也更小
3. 寻址效率高，结合位运算即可快速寻址</div>2022-03-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/09/2e/4badf056.jpg" width="30px"><span>余先声</span> 👍（1） 💬（0）<div>要保证相同优先级的元素也需要保证FIFO的特性，那么可以新引入一个自增id的概念。比较器当判断优先级相等的时候，就按id的大小进行排序，id小的在前，大的在后</div>2022-05-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/f4/15/0542b1e6.jpg" width="30px"><span>蒋某人尚需顿悟</span> 👍（0） 💬（2）<div>java堆内存和这个堆结构有什么联系吗</div>2023-04-19</li><br/>
</ul>