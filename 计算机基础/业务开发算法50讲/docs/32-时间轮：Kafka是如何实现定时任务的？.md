你好，我是微扰君。

今天我们来聊一聊日常开发中非常常见的技术需求：延时队列。

之前在学Kafka二分搜索的时候，我们已经学过了消息队列，它是一个用于传递消息的组件，大部分场景下，我们都希望消息尽快送达，并且消息之间要严格遵循先进先出的约束。但在有一些时候，我们也会希望消息不要立刻送达，而是在一段时间之后才会被接收方收到，也就是延后消息被处理的时间，像这样的场景就是“延时队列”。

### 常见业务场景

延时队列的应用非常多。我们回想一下有哪些业务场景，比如一个网上售卖电影票的平台，用户在买票的时候肯定要先选好位置，也就是说用户下单一张电影票有两个动作：选位置、付费。

我们不希望用户在付费的时候发现，自己选好的位置被别人买了，所以往往会在用户选定座位之后，就把这个位置锁定；但这个时候用户还没有付费，我们肯定不能让锁定一直持续下去，所以也会想要有一种定时机制，在用户超过一定时间没有付费时，在系统中自动取消这个订单，将对应的座位释放。

类似的场景还有许多，对应需要的定时周期跨度也很大。比如在云平台上如果用户资源过期，一般不会立刻清理所有数据，而会在超过一段时间之后再进行资源回收；再比如外卖平台上订单，如果快超过送餐时限了，就需要提醒外卖小哥加紧配送等等。
<div><strong>精选留言（4）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/fe/a2/5252a278.jpg" width="30px"><span>对方正在输入。。。</span> 👍（2） 💬（1）<div>感觉优先队列也可以实现延时队列，只要优先队列按照调度时间优先就可以了吧</div>2022-04-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg" width="30px"><span>peter</span> 👍（2） 💬（0）<div>请教老师几个问题：
Q1：延时队列和定时任务的区别是什么？
    延时队列可以看作是一种特殊的定时任务吗？
Q2：时间轮算法：
    A JDK是否实现了时间轮？
    B SpringBoot应用是否可以直接利用时间轮？比如引入一个包就可以用。
Q3：时间轮的图中，槽位“3”的队列是双向箭头，槽位“4”对应的队列用了单向箭头，为什么？
Q4：ZSET部分，redis是&lt;K:V&gt;对，是两个值，怎么处理id:value:score三个值的情况呢？
Q5：ZSET只存储任务ID，不存储具体任务，即redis中并没有具体任务信息。消费端需要维护 “任务id --- 具体任务”映射关系，根据ID找到具体任务执行，是这样吗？</div>2022-03-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/dc/08/64f5ab52.jpg" width="30px"><span>陈斌</span> 👍（1） 💬（0）<div>第三种实现方式，时间轮，是一个巧妙又高效的设计。牺牲了一定精度，但通过在内存中以循环队列的方式维护任务，降低了任务并行插入的锁竞争，也减少了取出任务的时间复杂度，特别适用于大量定时任务存在的场景，也因此成为 Kafka 实现延时队列的一种常用方式。

1、  特别适用于大量定时任务存在的场景 这个怎么理解，时间轮的设计不也是把元素放在内存中的吗，怎么就特别适合大量定时任务存在的场景，OOM了怎么办？

2、老师能简单的介绍一下 怎么基于时间轮的设计实现 一个基于Kafka的延时队列？消费Kafka的数据放入时间轮中，延时触发任务？






</div>2022-11-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/dc/08/64f5ab52.jpg" width="30px"><span>陈斌</span> 👍（0） 💬（0）<div>JDK 中的 DelayedQueue 可以更好地利用系统内置的定时机制，避免轮询的成本，不过因为单机本身的限制，不能很好的扩展来支持海量的数据场景。

1、JDK的DelayedQueue 不支持海量的数据场景：是因为 DelayedQueue 是无界队列，数据量太多会造成OOM吗？

2、为了提高效率，DelayedQueue 底层还采用了一种 leader-follower 的线程模型，也非常常用，你可以理解成任务的执行会有多个线程进行。 这句话中的任务执行 指的是队列中的元素出队列 的这个操作 吗，leader-follower线程模型 就是 一个线程去读取队列的队首元素是否到期，如果到期这个线程不负责将该元素出队，而是提交任务让其他线程去负责元素的出队操作？

3、 DelayedQueue 是线程安全队列，那么在频繁写入的场景，队列中的元素是获取不到读锁的，也会导致 take 方法阻塞，导致任务被延迟执行。例如极端场景：延迟队列一直在增加数据（队列元素的写锁一直被占有），尽管队列已经有满足条件的元素可以出队了，但是take方法一直会被阻塞，这么理解对吗？

</div>2022-11-17</li><br/>
</ul>