你好，我是宫文学。

到目前为止，我们已经用TypeScript实现了一个小而全的虚拟机，也在这个过程中稍微体会了一下虚拟机设计的一些要点，比如字节码的设计、指令的生成和栈机的运行机理等等，而且我们还通过性能测试，也看到了栈机确实比AST解释器的性能更高。

虽然，上面这些工作我们都是用TypeScript实现的，但既然我们已经生成了字节码，我不由地产生了一个想法：我们能不能用C语言这样的更基础的语言来实现一个虚拟机，同样来运行这些字节码呢？

我这样的想法可不是凭空产生的。你看，字节码最大的好处，就是和平台无关的能力。不管什么平台，只要有个虚拟机，就可以运行字节码，这也是安卓平台一开始选择字节码作为运行机制的原因。你甚至也可以来试一试，假设现在时间回到智能手机刚出现的时代，你是否也能够快速设计一个虚拟机，来运行手机上的应用呢？

那么进一步，在这种移动设备上运行的应用，很重要的功能就是去调用底层操作系统的API。用C和C++实现的虚拟机，显然在这方面有优势，能够尽量降低由于ABI转换所带来的性能损失。

所以，**这一节课，我就带你用C语言重新实现一遍虚拟机**。在这个过程中，你会对字节码文件的设计有更细致的体会，对于符号表的作用的理解也会加深，也会掌握如何用C语言设计栈桢的知识点。
<div><strong>精选留言（4）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/21/7e/fb725950.jpg" width="30px"><span>罗 乾 林</span> 👍（2） 💬（1）<div>程序运行过程中栈帧频繁生成释放，直接通过malloc&#47;free 创建释放造成性能问题。可以通过自定义内存分配器来解决</div>2021-08-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/70/67/0c1359c2.jpg" width="30px"><span>qinsi</span> 👍（1） 💬（1）<div>之前实现一个玩具jvm的时候做过profile，性能瓶颈在内存分配上。这个vm也要做下profile分析下</div>2021-08-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg" width="30px"><span>ifelse</span> 👍（0） 💬（0）<div>学习打卡</div>2022-09-14</li><br/><li><img src="" width="30px"><span>Geek_b52974</span> 👍（0） 💬（0）<div>看了一下 createStake function 每次都会做 melloc ，造成瓶颈，相较之下用 node.js 的stack 是用 slice 储存一开始就有一个预设的cap，扩容策略也是一次增加不只一个虽然可能浪费一些空间但是效率高很多</div>2022-03-27</li><br/>
</ul>