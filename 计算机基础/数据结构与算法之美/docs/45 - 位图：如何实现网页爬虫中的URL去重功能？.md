网页爬虫是搜索引擎中的非常重要的系统，负责爬取几十亿、上百亿的网页。爬虫的工作原理是，通过解析已经爬取页面中的网页链接，然后再爬取这些链接对应的网页。而**同一个网页链接有可能被包含在多个页面中，这就会导致爬虫在爬取的过程中，重复爬取相同的网页。如果你是一名负责爬虫的工程师，你会如何避免这些重复的爬取呢？**

最容易想到的方法就是，我们记录已经爬取的网页链接（也就是URL），在爬取一个新的网页之前，我们拿它的链接，在已经爬取的网页链接列表中搜索。如果存在，那就说明这个网页已经被爬取过了；如果不存在，那就说明这个网页还没有被爬取过，可以继续去爬取。等爬取到这个网页之后，我们将这个网页的链接添加到已经爬取的网页链接列表了。

思路非常简单，我想你应该很容易就能想到。不过，我们该如何记录已经爬取的网页链接呢？需要用什么样的数据结构呢？

## 算法解析

关于这个问题，我们可以先回想下，是否可以用我们之前学过的数据结构来解决呢？

这个问题要处理的对象是网页链接，也就是URL，需要支持的操作有两个，添加一个URL和查询一个URL。除了这两个功能性的要求之外，在非功能性方面，我们还要求这两个操作的执行效率要尽可能高。除此之外，因为我们处理的是上亿的网页链接，内存消耗会非常大，所以在存储效率上，我们要尽可能地高效。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/72/19/84b7c212.jpg" width="30px"><span>越过山丘</span> 👍（76） 💬（8）<div>第一题，数字重复了，有什么好方法处理吗</div>2019-01-10</li><br/><li><img src="" width="30px"><span>Costar</span> 👍（20） 💬（6）<div>有个问题怎么解决的？Bloom filter删除数据时，不能把bit位置0</div>2019-07-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/eb/e9/f94ee55c.jpg" width="30px"><span>gogo-heidi</span> 👍（9） 💬（1）<div>王争哥，您好。你画这个图，用的啥软件画的啊？  比普通的黑白图更容易理解。望求解！感激不尽！</div>2019-01-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/66/71/8a5d02ab.jpg" width="30px"><span>蓝色~冰*羽</span> 👍（4） 💬（3）<div>请问争哥，new char[nbits&#47;16+1]这里面为什么要做这个计算，看不懂啊</div>2019-03-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/db/ff/7043a067.jpg" width="30px"><span>公众号：编程指北</span> 👍（4） 💬（1）<div>老师，按照你的讲解我写了一个简单的布隆过滤器， 使用了3个简单的哈希函数，判错率在0.9左右
不知道是否是属于偏高了，这是代码，可以的话帮忙看看是否正确https:&#47;&#47;github.com&#47;MarvinLe&#47;tools&#47;tree&#47;master&#47;BloomFilter</div>2019-01-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/00/ea/6ad346c1.jpg" width="30px"><span>煦暖</span> 👍（3） 💬（1）<div>争哥，位图的代码理解了好久还没懂(；′⌒`)，能加几行注释吗？？</div>2019-01-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/6f/cf/accb66e5.jpg" width="30px"><span>张凯宇</span> 👍（1） 💬（1）<div>第二题用散列表和哈希函数的方法时，存了图片的地址，先哈希值比再全量比，如果允许错判，那当前的方案是不是也可以不存储地址了，只比哈希值</div>2019-10-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/79/c3/abb7bfe3.jpg" width="30px"><span>一修💤</span> 👍（1） 💬（1）<div>老师 对于这段话我的理解不是这样。比如我们今天要解决的爬虫判重这个问题，即便一个没有被爬取过的网页，被误判为已经被爬取，对于搜索引擎来说，也并不是什么大事情，是可以容忍的，毕竟网页太多了，搜索引擎也不可能 100% 都爬取到。 实际上布隆过滤器的特点是不存在位图中的一定不会判错。所以结果是对于已经看爬过的网页可能判断为没爬过，这样多爬一次不过是浪费点带宽 而漏爬似乎有点不太好？不知道理解对不对</div>2019-01-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/1c/46/a141c7e6.jpg" width="30px"><span>子嘉</span> 👍（1） 💬（1）<div>用位图去存一亿个数 是否存在的下标 但是有个问题 如果是有重复的数值 那就没法存了？ 每一位只能0-1 除非用多位来存储？</div>2019-01-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/4f/52/791d0f5e.jpg" width="30px"><span>Qualifor</span> 👍（0） 💬（2）<div>老师我想请问下，在说如果数字范围是1-10亿的时候，需要10亿个二进制位，占用120M内存，”占用的内存不降反增“，这个不降反增是跟谁作比较呢？如果还是存储整数类型，肯定还是位比较省空间呀，而如果跟1亿做比较，肯定是10亿占用空间大啊，因为基数不一样嘛，所以不是很理解在这里突出”不降反增“是什么意思</div>2019-09-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/49/3c/5d54c510.jpg" width="30px"><span>skull</span> 👍（0） 💬（2）<div>bytes[byteIndex] |= (1 &lt;&lt; bitIndex);
老师，这段比较的时候，直接与bitIndex进行疑惑不就可以了么，为何要向左移一位呢？</div>2019-09-27</li><br/><li><img src="" width="30px"><span>Paul Shan</span> 👍（0） 💬（1）<div>请问老师，布隆过滤器如何修改才能支持高效删除操作。</div>2019-08-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4d/54/9c214885.jpg" width="30px"><span>kylexy_0817</span> 👍（0） 💬（1）<div>王老师，看了您定义的BitMap数据结构，该结构的类有两个私有成员变量，其中一个变量的类型是int，int在java中是用4个字节的内存空间来存储吧？所以每个位图对象应该至少占了2个字节+4个字节的内存空间吧？</div>2019-04-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/dc/c3/e4ba51d5.jpg" width="30px"><span>Flash</span> 👍（0） 💬（1）<div>争哥，int类型数据存bitmap可以这么位运算，那String类型的是怎么位运算的呢？Java里面也只有&quot;123&quot;这样的字符串可以转成int呀。布隆过滤器对url这种字符串是怎么位运算的，或者说怎么转成int类型呢？</div>2019-03-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/69/d2/78775848.jpg" width="30px"><span>我的名字叫胡子</span> 👍（0） 💬（2）<div>如果k%16取模等于15，二进制表示就是0b0000 0000 0000 1111，左移1位然后按位或也不能改变第16位的呀。如果要改变第16位，不应该是和十进制2^15按位或吗？</div>2019-03-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/10/8b/7e84507c.jpg" width="30px"><span>东宇</span> 👍（0） 💬（1）<div>10亿网页判重那个例子，老师我怎么算的是12GB呢
1024*1024*1024 约等于 1亿
1024*1024*1024*100 约等于 100亿
1024*1024*1024*100&#47;8&#47;1024&#47;1024&#47;1024 = 12GB 哪里有问题？ 求教！！！</div>2019-02-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/69/3d/abb7bfe3.jpg" width="30px"><span>Geek_8ra72c</span> 👍（0） 💬（1）<div>为什么代码用char不用byte呢？</div>2019-01-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/08/cd/ff5d4d46.jpg" width="30px"><span>东东</span> 👍（0） 💬（1）<div>有位sprak同学说：原来char类型存储数字的时候，只占1个字节，也就是8位。表示不能理解，Character中 public static final char MAX_VALUE = &#39;\uFFFF&#39;; 应该是16个bit啊，百度一下基本都是说char是2个字节，好困惑啊，希望老师帮忙解答一下，</div>2019-01-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/6b/27/8c964e52.jpg" width="30px"><span>不惑ing</span> 👍（0） 💬（1）<div>位图大小和数据大小的比例有推荐设置么？一般都是10倍么？</div>2019-01-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ba/a0/f03d20cd.jpg" width="30px"><span>likun</span> 👍（0） 💬（1）<div>char类型是两个字节 应该除以16吧？</div>2019-01-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e0/26/4942a09e.jpg" width="30px"><span>猫头鹰爱拿铁</span> 👍（0） 💬（1）<div>没太明白爬虫网页链接这个例子去重为什么要用10倍大小的位图，按照同样的思路，图片size：1亿张，布隆算法算法的内存空间为10亿bit=1.16gb，假设一个机器内存空间为2gb，那么只需要2&#47;1.16约等于1台机器。刚才算错了，少除了8。。。</div>2019-01-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/da/ec/779c1a78.jpg" width="30px"><span>往事随风，顺其自然</span> 👍（0） 💬（2）<div>1亿二进制位是12M是怎么算出来的，按照算法不是1000M？</div>2019-01-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/09/33/57757a23.jpg" width="30px"><span>小苏饼</span> 👍（0） 💬（4）<div>这些url要不要持久化到数据库呀
是要先从数据库里读取在用布隆过滤器吗？？</div>2019-01-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/69/97/2044815d.jpg" width="30px"><span>DreamYe</span> 👍（281） 💬（4）<div>bloom filter: False is always false. True is maybe true.</div>2019-01-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/08/eb/594e9e6c.jpg" width="30px"><span>五岳寻仙</span> 👍（164） 💬（13）<div>课后思考题1

传统的做法：1亿个整数，存储需要400M空间，排序时间复杂度最优 N×log(N)

使用位图算法：数字范围是1到10亿，用位图存储125M就够了，然后将1亿个数字依次添加到位图中，然后再将位图按下标从小到大输出值为1的下标，排序就完成了，时间复杂度为 N</div>2019-01-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/0a/dd/88fa7b52.jpg" width="30px"><span>Geek_41d472</span> 👍（76） 💬（3）<div>位图代码的实现一开始没看懂，请教了下身边一位大神同事才搞懂，原来char类型存储数字的时候，只占1个字节，也就是8位。所以计算的时候都是除8或者模8。希望我的回答可以帮助其他跟我一样基础薄弱的同学，共同进步</div>2019-01-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c7/dc/9408c8c2.jpg" width="30px"><span>ban</span> 👍（46） 💬（10）<div>这个char代码最好还是用图解比较好理解，纯代码看不懂。
我这里有另外一个位的图解计算过程，再去看代码，你就会秒懂
https:&#47;&#47;mp.weixin.qq.com&#47;s&#47;xxauNrJY9HlVNvLrL5j2hg</div>2019-01-11</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eq0mnVeia1dnic00tkicbawOrIQpiaOxGjh7r0Tuh7th82NibLrJKnv9LLuDmPNzXXTqdb36tsEVIFlYiaw/132" width="30px"><span>司霖</span> 👍（38） 💬（1）<div>将数字 A 的第 k 位设置为1：A = A | (1 &lt;&lt; (k - 1))
将数字 A 的第 k 位设置为0：A = A &amp; ~(1 &lt;&lt; (k - 1))
检测数字 A 的第 k 位：A &amp; (1 &lt;&lt; (k - 1)) != 0
用于理解bitmap中代码</div>2019-03-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5f/09/80484e2e.jpg" width="30px"><span>李斌</span> 👍（15） 💬（0）<div>我们在信息流推荐系统中用 bloom filter 过滤推荐历史，在工程上使用 RedisLibs 的 ReBloom</div>2019-06-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d2/94/8bd217f1.jpg" width="30px"><span>Kudo</span> 👍（15） 💬（2）<div>直观上感觉位图有点像学排序时桶的概念，所以使用位图也可以实现类似于桶排序的效率。</div>2019-01-09</li><br/>
</ul>