上一节我们讲到，如何用位图、布隆过滤器，来过滤重复的数据。今天，我们再讲一个跟过滤相关的问题，如何过滤垃圾短信？

垃圾短信和骚扰电话，我想每个人都收到过吧？买房、贷款、投资理财、开发票，各种垃圾短信和骚扰电话，不胜其扰。**如果你是一名手机应用开发工程师，让你实现一个简单的垃圾短信过滤功能以及骚扰电话拦截功能，该用什么样的数据结构和算法实现呢？**

## 算法解析

实际上，解决这个问题并不会涉及很高深的算法。今天，我就带你一块看下，如何利用简单的数据结构和算法，解决这种看似非常复杂的问题。

### 1.基于黑名单的过滤器

我们可以维护一个骚扰电话号码和垃圾短信发送号码的黑名单。这个黑名单的收集，有很多途径，比如，我们可以从一些公开的网站上下载，也可以通过类似“360骚扰电话拦截”的功能，通过用户自主标记骚扰电话来收集。对于被多个用户标记，并且标记个数超过一定阈值的号码，我们就可以定义为骚扰电话，并将它加入到我们的黑名单中。

如果黑名单中的电话号码不多的话，我们可以使用散列表、二叉树等动态数据结构来存储，对内存的消耗并不会很大。如果我们把每个号码看作一个字符串，并且假设平均长度是16个字节，那存储50万个电话号码，大约需要10MB的内存空间。即便是对于手机这样的内存有限的设备来说，这点内存的消耗也是可以接受的。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/ec/9d/4d705f03.jpg" width="30px"><span>C_love</span> 👍（18） 💬（8）<div>为啥P(W1W2...Wn|垃圾短信)是独立事件，能够拆成乘积，而P(W1W2...Wn)不是独立事件？</div>2019-01-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/3a/38/1e8a1760.jpg" width="30px"><span>Clement</span> 👍（6） 💬（1）<div>图片上的数据和公式使用什么软件画出来的？</div>2019-01-21</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJGOSxM1GIHX9Y2JIe7vGQ87rK8xpo5F03KmiaGyXeKnozZsicHeSZrbSlzUVhTOdDlXCkTrcYNIVJg/132" width="30px"><span>ferry</span> 👍（3） 💬（1）<div>将短信内容中的分词假设为完全独立是不是不太符合实际情况呢？是否应该使用多元文法，假设为分词与前若干个分词相关呢？</div>2019-06-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/6f/5d/f0a19f09.jpg" width="30px"><span>ldd</span> 👍（3） 💬（1）<div>请问，基于黑名单的过滤方式，用布隆过滤器只能存储Bool值，即是否存储，但是还要实现“标记次数来判断是否达到阈值”，就需要额外的散列表了，需要的内存空间依然很大，方案上还不如直接用散列表来的更好吧？</div>2019-04-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/dd/eb/80f9d212.jpg" width="30px"><span>lttzzlll</span> 👍（2） 💬（2）<div>上一节我们讲了，布隆过滤器最大的特点就是比较省存储空间，所以，用它来解决这个问题再合适不过了。如果我们要存储 500 万个手机号码，我们把位图大小设置为 10 倍数据大小，也就是 5000 万，那也只需要使用 5000 万个二进制位（5000 万 bits），换算成字节，也就是不到 7MB 的存储空间。比起散列表的解决方案，内存的消耗减少了很多。

这段话中：对于需要使用的内存空间有疑问，按照上一节的处理方式，把手机号码转换为整数，使用的内存空间应该是整数的范围 * 10 bits, 而不是手机号的数量 * 10 bits? 或者，这里不把手机号码转化为整数，用其他的哈希方法，把这500w个手机号映射到[0, 500W)这个区间内？</div>2019-02-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/47/39/0ce1aa62.jpg" width="30px"><span>罗洲</span> 👍（83） 💬（5）<div>我觉得这种分类过滤，最好的可能是机器学习，通过大量的垃圾短信样本来训练特征，最后可以达到过滤短信和邮件的目的，而且这种方法应该效果更好，至于电话拦截，实际上就是电话号码黑名单的问题，我觉得用布隆过滤器可以满足通用场景，一般实际场景中，对于这种电话是提示谨慎接听，但是我们可以本地和云端结合处理，解决部分的误报问题，当判断是黑名单的时候再去云端查，确认是否是真的黑名单。这样用布隆过滤器+云端也是一种方式
</div>2019-01-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8c/54/deb19880.jpg" width="30px"><span>slvher</span> 👍（26） 💬（1）<div>对于短信文本，机器学习尤其是 NLP 方向的很多算法可用于 anti-spam。文本分类任务，特征工程做得稍用心的话，判别式模型（典型如 logistic regression）的效果通常好于生成式模型（典型如 naive-bayes）。

对于电话号码数字，感觉用正则或定时拉取黑名单比 ml 模型简单可靠。</div>2019-01-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/40/10/b6bf3c3c.jpg" width="30px"><span>纯洁的憎恶</span> 👍（18） 💬（0）<div>黑名单过滤法基于经验判断，难以确保及时性。基于内容规则的过滤法容易被针对，而且动态调整规则的成本较高。基于朴素贝叶斯算法的内容概率过滤法，既可以确保及时性，又能够较好的基于实际情况的变化而变化，具备初步智能特性。因为贝叶斯方法是基于先验判断，然后根据现实反馈动态调整判断的算法。

当绝对值不好计算时，可以结合场景需要，合理使用相对值代替绝对值，以简化计算难度、消除无法计算的因子。</div>2019-01-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/8b/e0/9a79ddac.jpg" width="30px"><span>🐱您的好友William🐱</span> 👍（13） 💬（1）<div>1.为啥叫naive：因为假设了条件分布中各个feature是独立出现的，feature之间啥关系没有！所以很naive，很朴素，很“傻”，但是效果真的不一定差，而且在没开发出更好的模型之前直接进行统计计算就能得出结果，且可以做成online的，怎么看都不亏啊（反正你也得用统计数据做其他的事，顺道做了呗老弟）！

2.如果概率为0了怎么办！可以使用laplacian smoothing，简单的来说就是在分子分母上面加数来保证不会有0的出现。直接使用很小的数是可以的（遵循频率学派频率为大），但更精确的在分母分子上加什么，这个其实是与贝叶斯学派所认为的先验分布有关，就是在不看sample时，我们的先验知识对这种情况的估计是多少（比如我在不统计工科学校男女比例的时候就有了一定的先验知识：7:1，之后我再统计其实是对我的先验估计的一种调整）。</div>2019-01-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/14/05/5f46ffa6.jpg" width="30px"><span>小新村小学扛霸子</span> 👍（10） 💬（4）<div>P（W1,W2...Wn同时出现在一条短信中） = P（W1出现在短信中） *   P（W2出现在短信中） *....*  P（Wn出现在短信中）这样计算应该就可以吧</div>2019-04-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/eb/57/3032e1a7.jpg" width="30px"><span>loda</span> 👍（10） 💬（0）<div>朴素贝叶斯讲的很好</div>2019-04-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/fc/4f/0a452c94.jpg" width="30px"><span>大毛</span> 👍（8） 💬（2）<div>从高级篇开始经常会感到似曾相识的感觉，到了这一章，发现解题思路和《数学之美》中翻译统计的思路如出一辙。
《数学之美》的作者是吴军老师，Google翻译中的大牛，争哥也在Google的翻译部门，且《数据结构与算法之美》很可能是向《数学之美》致敬。
根据朴素贝叶斯算法，我判断争哥认识吴军老师，置信度为 95%。（这一条是我瞎编的，哈哈）</div>2020-04-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/98/12/a169bdcd.jpg" width="30px"><span>Geek_477c02</span> 👍（6） 💬（3）<div>P（ Wi出现在短信中 | 短信是垃圾短信）表示垃圾短信中包含 Wi这个单词的概率有多大。

如果wi出现的概率是0怎么办，连乘导致结果是0了？</div>2019-01-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/c0/12/1afb4b75.jpg" width="30px"><span>郑家庄赶大车的老郑</span> 👍（5） 💬（1）<div>所以小明因为下雨而不上学的概率是 P(B|A)=2&#47;3。
这说法虽然没错，但似乎有点歧义，把“而”改成“才”会不会更好？</div>2019-12-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/fd/fd/326be9bb.jpg" width="30px"><span>注定非凡</span> 👍（4） 💬（0）<div>算法解析1. 基于黑名单的过滤器1，维护一个骚扰电话号码和垃圾短信发送号码的黑名单。①：如果黑名单中的电话号码不多，可以使用散列表、二叉树等动态数据结构来存储，对内存的消耗并不会很大    每个号码看作一个字符串，并且假设平均长度是 16 个字节，那存储 50 万个电话号码，大约需要 10MB 的内存空间，但当号码超过500万个时，使用散列表就需要100MB空间，这个对用户的手机而言是不可接受的。②：布隆过滤器最大的特点就是比较省存储空间，所以，用它来解决这个问题很合适    存储 500 万个手机号码，把位图大小设置为 10 倍数据大小，也只需要5000 万 bits，换算成字节不到 7MB 的存储空间③：还有一种时间换空间的方法，可以将内存的消耗优化到极致    把黑名单存储在服务器端上，服务器端来做过滤和拦截的核心工作。手机端只将要检查的号码发送给服务器端，服务器端将判断结果返回给手机端，但网络通信通常比较慢2. 基于规则的过滤器


1，基于规则的过滤方式
    ①：预先设定一些规则，如果某条短信符合这些规则，我们就可以判定它是垃圾短信
    ②：但如果短信只是满足其中一条规则，如果就判定为垃圾短信，会存在比较大的误判的情况。所以可以综合多条规则进行判断
    ③：或每条规则对应一个不同的得分，满足哪条规则，就累加对应的分数，某短信的总得分超过阈值，才会被判定为垃圾短信

2，难点问题
    过滤规则要实到执行层面，其实还有很大的距离，还有很多细节需要处理，如第一条规则中，我们该如何定义特殊单词；第二条规则中，我们该如何定义什么样的号码是群发号码等等
3，具体细节
    我们该如何定义特殊单词
    虽然可以基于概率统计的方法，借助计算机强大的计算能力，找出哪些单词最常出现在垃圾短信中，将这些最常出现的单词，作为特殊单词，用来过滤短信。
    不过这种方法的前提是，要有大量的样本数据，并且每条短信都做好了标记，它是垃圾短信还是非垃圾短信。
    如对 1000 万条短信，
    ①，进行分词处理（借助中文或者英文分词算法），去掉“的、和、是”等没有意义的停用词（Stop words），得到 n 个不同的单词
    ②，针对每个单词，统计有多少个垃圾短信出现了这个单词，有多少个非垃圾短信会出现这个单词，进而求出每个单词分别出现在垃圾短信，非垃圾短信中的概率。
    ③，如果某个单词出现在垃圾短信中的概率，远大于出现在非垃圾短信中的概率，则可这个单词作为特殊单词，用来过滤垃圾短信
4，缺点问题
        一方面，这些规则受人的思维方式局限，规则未免太过简单；
        另一方面，垃圾短信发送者可能会针对规则，精心设计短信，绕过这些规则的拦截
3. 基于概率统计的过滤器


1，理论基础
    ①：这种基于概率统计的过滤方式，基础理论是基于朴素贝叶斯算法
2，实践方法
    ①：基于概率统计的过滤器，是基于短信内容来判定是否是垃圾短信
    ②：需要把短信抽象成一组计算机可以理解并且方便计算的特征项，用这一组特征项代替短信本身，来做垃圾短信过滤
    ③：可以通过分词算法，把一个短信分割成 n 个单词。这 n 个单词就是一组特征项，全权代表这个短信。
    ④：因此，判定一个短信是否是垃圾短信的问题，就变成了，判定同时包含这几个单词的短信是否是垃圾短信
3，

使用概率，来表征一个短信是垃圾短信的可信程度。如果用公式将这个概率表示出来，就是下面这个样子：


尽管我们有大量的短信样本，但是我们没法通过样本数据统计得到这个概率。没有样本，也就无法计算概率。所以这样的推理方式虽然正确，但是实践中并不好用。所以我们需要通过朴素贝叶斯公式，将这个概率的求解，分解为其他三个概率的求解。


基于下面这条著名的概率规则来计算。

独立事件发生的概率计算公式：P(A*B) = P(A)*P(B)

如果事件 A 和事件 B 是独立事件，两者的发生没有相关性，事件 A 发生的概率 P(A) 等于 p1，事件 B 发生的概率 P(B) 等于 p2，那两个同时发生的概率 P(A*B) 就等于 P(A)*P(B)。
基于这条独立事件发生概率的计算公式，我们可以把 P（W1，W2，W3，…，Wn 同时出现在一条短信中 | 短信是垃圾短信）分解为下面这个公式：



在求解 p1 和 p2 倍数（p1&#47;p2）的时候，我们也就不需要这个值。
</div>2020-02-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/9c/3a/bfd73920.jpg" width="30px"><span>junjun</span> 👍（3） 💬（0）<div>以前把算法一直和程序联系起来，现在突然发现，算法存在我们生活的各个方面，任何地方都是算法，比如你今天准备吃啥，其实也是一个算法。</div>2019-09-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5f/0a/7f9c476b.jpg" width="30px"><span>余晓飞</span> 👍（2） 💬（1）<div>题图的 statics 其实是静力学的意思，不如直接用statistics</div>2020-01-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c7/dc/9408c8c2.jpg" width="30px"><span>ban</span> 👍（2） 💬（0）<div>https:&#47;&#47;www.jianshu.com&#47;p&#47;5cf3a155b2f0
找到另外一个相亲的例子</div>2019-01-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/90/4e/efaea936.jpg" width="30px"><span>墨禾</span> 👍（2） 💬（0）<div>其实这个问题就是个分类预测问题，传统的机器学习方法中的分类预测算法都可以用</div>2019-01-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg" width="30px"><span>escray</span> 👍（1） 💬（0）<div>看完整篇文章，都没有看到代码（虽然有公式），不开心。

其实我觉得黑名单过滤应该挺好用的，主要是考虑到每个人的黑名单并不会特别多，除了骚扰电话，估计还有前男友什么的也需要屏蔽。

把黑名单放在服务器上，应该不是什么好主意，主要是在打电话的时候，移动网络的信号似乎是没法使用的，不是特别清楚后续的移动技术有没有解决这个问题。

可以把所有的来电都放到服务器上去，进行分析比对，然后再返回一些判断条件，在手机上存储一些离线黑名单或者是条件。比如，如果我在北京，那么来自云南偏远小城市的电话号码，就有可能是骚扰电话。

黑名单可以对已经标记为骚扰的电话或者短信进行处理，而基于规则的过滤器可以处理没有在黑名单之内的。

基于概率或者说是朴素贝叶斯公式的过滤，其实应该也算是规则的一种。

如果让我来头脑风暴的话，我觉的对于来电或者短信，

* 首先应该从白名单开始，如果短信或电话的来源是在通讯录里面有的，那么就不用判断了，白名单不会太多；
* 然后再考虑指定的离线黑名单，这个应该也不会太多；
* 过了这两关，应该就是规则过滤了，有一些权重比较高的关键词应该很好用，“见光死”；
* 最后才是概率过滤，如果整个算法的速度不够快的话，这个时候用户应该已经接起电话来了。</div>2020-05-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/dc/6f/5d86dbe9.jpg" width="30px"><span>短迪大魔王</span> 👍（1） 💬（0）<div>f分母没那么简单，P（w）=P（A）P（W｜A）+P（B）P（W｜B），A是正常邮件，B是垃圾邮件。所以贝叶斯公式分母要展开，每一项都是独立计算</div>2020-02-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/a2/66/b709a000.jpg" width="30px"><span>持续性创造</span> 👍（1） 💬（3）<div>小明不上学的概率：0.3。
下雨的概率：0.4。
同时发生的概率：0.3*0.4=0.12。
但是从样本里看是0.2啊。
这块想不明白哇老师。

是垃圾短信情况下，同时包含某些词的概率可以拆成分别的乘积。类比小明不上学下雨的问题，真的可以这么拆么？
</div>2020-01-04</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eo435IStLENgI45dWOow9gPDh8RcqvuCOLp30XqLJK3wqmwO7QKRLx8sMg9eucMKnJdjwickrAQMBw/132" width="30px"><span>ppingfann</span> 👍（1） 💬（0）<div>有一问题：

短信中出现的单词w1、w2、…、wn应该不是独立事件吧。很多输入法也是依据用户前面输入的单词来推荐后面用户可能会想输入的单词的。这个应该就能说明单词输入之间不应该是独立事件的。

就算为了解决问题方便，假设事件为独立事件，那么

P(w1、w2、…、wn同时出现在短信中)，这个概率是可以拆分成P(w1)、P(w2)、…、P(wn)相乘计算出来的。也就没有后面那些步骤了。

（btw后面这个思想确实很智慧）</div>2019-04-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f8/99/8e760987.jpg" width="30px"><span>許敲敲</span> 👍（1） 💬（0）<div>打算入行NLP的学员，听了这个比较亲切，想多了解一些NLP领域的算法</div>2019-01-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d2/94/8bd217f1.jpg" width="30px"><span>Kudo</span> 👍（1） 💬（0）<div>朴素贝叶斯模型的一个基本假设是条件独立性，即假定w1, w2, ..., wn之间相互独立。这是一个较强的假设，正是这一假设，使朴素贝叶斯的学习与预测大为简化，且易于实现，其缺点是分类的准确率不一定高。</div>2019-01-11</li><br/><li><img src="" width="30px"><span>Geek_2e286a</span> 👍（0） 💬（1）<div>王争老师您好，我有一个问题咨询，就是我想做一个基于主机告警的告警降噪功能，主要是吧相同类型的告警归并成一条，降低告警数量，请问这个有什么好的算法可以推荐，基于规则的告警降噪不太完美，那有没有基于算法的告警降噪方式，当然如果有基于AI机器学习算法也可以</div>2023-07-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/4b/88/272b4562.jpg" width="30px"><span>毛启圣</span> 👍（0） 💬（0）<div>trie 树存储是否要节省空间？</div>2020-12-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/60/81/eaf6d0ac.jpg" width="30px"><span>拉布拉多</span> 👍（0） 💬（0）<div>王老师这课程真是值，能把一些算法，简单的篇幅讲清楚。能达到自己传授别人知识，算法这块是完全融会贯通了。至少这些篇节是。</div>2020-11-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/a2/5e/3871ff79.jpg" width="30px"><span>迷途书童</span> 👍（0） 💬（0）<div>朴素贝叶斯原理听起来简单，实际上有很多落地工作要做</div>2020-09-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/5c/3d/372c93d6.jpg" width="30px"><span>对白</span> 👍（0） 💬（0）<div>朴素贝叶斯算法如果没有特征之间相互独立这个假设，那么是无法求出结果的</div>2020-08-22</li><br/>
</ul>