短网址服务你用过吗？如果我们在微博里发布一条带网址的信息，微博会把里面的网址转化成一个更短的网址。我们只要访问这个短网址，就相当于访问原始的网址。比如下面这两个网址，尽管长度不同，但是都可以跳转到我的一个GitHub开源项目里。其中，第二个网址就是通过新浪提供的短网址服务生成的。

```
原始网址：https://github.com/wangzheng0822/ratelimiter4j
短网址：http://t.cn/EtR9QEG
```

从功能上讲，短网址服务其实非常简单，就是把一个长的网址转化成一个短的网址。作为一名软件工程师，你是否思考过，这样一个简单的功能，是如何实现的呢？底层都依赖了哪些数据结构和算法呢？

## 短网址服务整体介绍

刚刚我们讲了，短网址服务的一个核心功能，就是把原始的长网址转化成短网址。除了这个功能之外，短网址服务还有另外一个必不可少的功能。那就是，当用户点击短网址的时候，短网址服务会将浏览器重定向为原始网址。这个过程是如何实现的呢？

为了方便你理解，我画了一张对比图，你可以看下。

![](https://static001.geekbang.org/resource/image/1c/43/1cedb2511ec220d90d9caf71ef6c7643.jpg?wh=1142%2A749)

从图中我们可以看出，浏览器会先访问短网址服务，通过短网址获取到原始网址，再通过原始网址访问到页面。不过这部分功能并不是我们今天要讲的重点。我们重点来看，如何将长网址转化成短网址？

## 如何通过哈希算法生成短网址？

我们前面学过哈希算法。哈希算法可以将一个不管多长的字符串，转化成一个长度固定的哈希值。我们可以利用哈希算法，来生成短网址。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/07/8c/0d886dcc.jpg" width="30px"><span>蚂蚁内推+v</span> 👍（22） 💬（11）<div>王老师短网址有什么作用吗？ 我上网查了下理由不能说服我？
可能网上说得比较浅显，王老师方便指导下吗？</div>2019-02-09</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJETibDh9wrP19gj9VdlLRmppuG1FibI7nyUGldEXCnoqKibKIB18UMxyEHBkZNlf5vibLNeofiaN5U6Hw/132" width="30px"><span>steve</span> 👍（11） 💬（3）<div>思考题2想了很久没想到好的办法，还请老师解答。
看大家的方法貌似是把老的url批量删掉，那如果需求不允许失效老url是不是就没有办法了呢？</div>2019-10-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/49/09/58c0a054.jpg" width="30px"><span>实验室清洁工</span> 👍（7） 💬（3）<div>应该是16进制吧，62进制？？？</div>2019-02-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/5a/33/9a66d0b8.jpg" width="30px"><span>Csquare</span> 👍（2） 💬（1）<div>如果选用Murmurhash的32bit版本，用户量&#47;数据量上去以后，哈希冲突是不是就会比较频繁？</div>2019-10-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/1e/04/a7d57e9f.jpg" width="30px"><span>于林杰</span> 👍（2） 💬（1）<div>为什么是62</div>2019-10-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/cd/5c/e09eac13.jpg" width="30px"><span>刘強</span> 👍（2） 💬（1）<div>哈哈  2019年4月12日晚上2点  终于把专栏刷完了。开始跟着学发现不到一半，就跟不上节奏了，又从头开始看。开始时间这么长了，估计留言都没人看了，但还是留个言。看到有个兄弟昨天也留言了，还好没有放弃，虽然慢，但是跟上来了。

虽然学完了，但我感觉学算法和懂算法之间的鸿沟还是相当难跨越的。我们可能学完后遇到相应的问题可以用相应的算法解决，但是我们还是没法明白为什么这样做就可以。我们为什么想不到？这些算法只是科学家，天才灵光一现才能发明出来?有没有更本质的东西在后面？学的越来，发现自己越渺小，什么也不懂了。</div>2019-04-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5b/30/9dcf35ff.jpg" width="30px"><span>森林</span> 👍（1） 💬（1）<div>课程终于输完了，问问小争哥画图软件是？</div>2019-04-25</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJETibDh9wrP19gj9VdlLRmppuG1FibI7nyUGldEXCnoqKibKIB18UMxyEHBkZNlf5vibLNeofiaN5U6Hw/132" width="30px"><span>steve</span> 👍（0） 💬（1）<div>用布隆过滤器 插入新的短网址 布隆过滤器返回true   也不一定存在 那还是得查数据库？</div>2019-09-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/78/51/4790e13e.jpg" width="30px"><span>Smallfly</span> 👍（178） 💬（5）<div>随着新年的到来，我们的算法专栏也到了尾声。有点怀念那段时间工作不忙，一天能有好几个小时，阅读和思考算法专栏。

专栏给我带来的收获不仅仅是数据结构和算法的知识。在这之前虽然也每天学习，但总是东一块西一块，没有系统和脉络，一段时间之后，看似学了很多，但并没有什么效果。

在学习算法课程的过程中，基本都在学习和思考专栏的内容。一般第一天过一遍概念，一边阅读一边手敲。第二天会把重点放在思考上，为什么需要这种数据结构和算法，它的利弊是什么，以及解答思考题。

真正有收获的是思考和实践而不是阅读，阅读只是表象；如果只是阅读，也没有生字，会很轻松，但效果甚微。

这让我切身体会到系统和专注的重要性。

这种经历帮助我在实际工作中解决不少问题，不是说用到了哪种算法，而是在遇到问题时善于花时间去思考解决方案，而不是一味地寻找替代方案，把问题绕过去。

紧跟着老师的脚步学下来了，不能说都掌握了，但有几点学习的心得想跟大家分享。

1、迈出第一步。很多事情不是我们不会做，而是不想开始。一想到前面可能会有重重困难，思想上就先败下阵来了。只要开始一点点的弄懂，重在培养兴趣。

2、慢一点，不贪多。可能有同学落下很多课，看看还有这么多没学，干脆就放弃了。其实并不需要掌握所有的，可以挑选自己感兴趣的内容，细嚼慢咽，先掌握一部分。再从已知探索未知，其实文章之间很多是有关联的，学习过程中可能自个儿就串起来了。

3、多动手。阅读和思考还是远远不够的，带着文章的思路，用自己熟悉的语言实现一遍，跑起来测一测，会更有成就感，也是自己学习的痕迹。

虽然专栏学完了，然而有些内容很快就会忘记，后面我还会偶尔拿出来读一读，回顾一下思路。我现在已经欣然接受，学习的东西很快会遗忘，但回顾的时候会迅速地想起来，印象也更深刻了。

最后，祝王争老师和编辑小姐姐新年快乐，辛苦了。(´▽`ʃ♡ƪ)
</div>2019-02-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/14/50/c23cf47d.jpg" width="30px"><span>李</span> 👍（42） 💬（3）<div>以前觉得数据结构和算法很难，学了之后，确实也难，但通过系统学习，心中有了一张完整的地图，以后只要不断反复看，反复学习，反复练习，一定能真正融合贯通。
另外，最大的感受是学了数据结构和算法后，看其它中间件和框架的源代码，发现大部分底层就是数据结构和算法。感觉练了九阳神功一样，学习其它功夫快了很多</div>2019-02-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e8/fd/035f4c94.jpg" width="30px"><span>欢乐小熊</span> 👍（35） 💬（2）<div>问题一:
- 尝试将用户 自定义后的短网址 和 原网址的映射关系 存入数据库
  - 插入成功, 则提示用户短网址生成成功
  - 若插入失败, 说明存在冲突, 则进行判重处理
     - 若数据库中短网址对应的原网址与当前正在处理的相同, 提示该短网址有效 
     - 若数据库中短网址对应的原网址与当前正在处理的不相同, 提示该短网址已被占用 

问题二:
可以使用布隆过滤器进行判重验证, 通过之后再插入</div>2019-02-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/0f/ab/9748f40b.jpg" width="30px"><span>微秒</span> 👍（25） 💬（2）<div>坚持到了最后，虽然只看不写，但也加深了对数据结构的认识，接下来刷第二遍的时候再加深代码实践。最后祝大家新年快乐！顺便说句，老师的这个专栏真的很良心，谢谢了！</div>2019-02-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/fd/fd/326be9bb.jpg" width="30px"><span>注定非凡</span> 👍（18） 💬（1）<div>短网址服务整体介绍

浏览器会先访问短网址服务，通过短网址获取到原始网址，再通过原始网址访问到页面

如何通过哈希算法生成短网址？
	* 哈希算法可以将一个不管多长的字符串，转化成一个长度固定的哈希值。可以利用哈希算法，来生成短网址
	* 在生成短网址不需要MD5、SHA等复杂的哈希算法，不需要考虑反向解密的难度，所以只需要关心哈希算法的计算速度和冲突概率
	* 比较著名并且应用广泛的一个哈希算法是MurmurHash 算法。被广泛应用到 Redis、MemCache、Cassandra、HBase、Lucene 等众多著名的软件中
	* MurmurHash 算法提供了两种长度的哈希值：（1）32bits，（2） 128bits。为了让最终生成的短网址尽可能短可选择 32bits 的哈希值

1. 如何让短网址更短？
	* 可以将 10 进制的哈希值，转化成更高进制的哈希值，这样哈希值就变短了
	* 为了让哈希值表示起来尽可能短，将 10 进制的哈希值转化成 62 进制

2. 如何解决哈希冲突问题？
	* 保存短网址跟原始网址之间的对应关系，以便根据对应关系，查找到原始网址
	* 存储这种对应关系的方式有很多，如我们自己设计存储系统或者利用现成的数据库
	* 先利用 MurmurHash 算法生成短网址，然后拿这个新生成的短网址，在 MySQL 数据库中查找
	* 如果没有找到相同的短网址，即没有冲突。就将这个短网址返回给用户，并将对应关系存储到 MySQL 数据库中。
	* 如果找到了相同的短网址，那从数据库中将这个短网址对应的原始网址也取出来。
		* 如果数据库中的原始网址，跟在正在处理的原始网址是一样的，则直接使用
		* 如果跟正在处理的原始网址不一样，就说明哈希算法发生了冲突。


不同的原始网址得到的短网址重复了，该怎么办？
	* 可以给原始网址拼接一串特殊字符，再重新计算哈希值，两次哈希计算都冲突的概率是非常低的
	* 假设出现非常极端的情况，又发生冲突了，我们可以再换一个拼接字符串，再计算哈希值
	* 当用户访问短网址的时候，短网址服务先通过短网址，在数据库中查找到对应的原始网址。先将特殊字符去掉，然后再返回给浏览器

3. 如何优化哈希算法生成短网址的性能？
如果数据库中存储的数据非常多，查找起来就会非常慢
	* 可以给短网址字段添加 B+ 树索引，这样通过短网址查询原始网址的速度就提高了很多
	* 在短网址生成的过程中，会执行两条 SQL 语句。第一个是通过短网址查询短网址与原始网址的对应关系，第二个是将新生成的短网址和原始网址之间的对应关系存储到数据库。
	* 这种 IO 通信耗时以及 SQL 语句的执行，才是整个短网址服务的性能瓶颈所在。为了提高性能，需要尽量减少 SQL 语句

如何减少 SQL 语句呢？
	* 可以给数据库中的短网址字段添加一个唯一索引（不止是索引，还要求表中不能有重复的数据）
	* 直接尝试将生成的短网址与对应的原始网址存储到数据库中
	* 如果数据库能够将数据正常写入，那说明并没有违反唯一索引，没有冲突
	* 如果数据库反馈违反唯一性索引异常，重新执行刚刚讲过的“查询、写入”过程

另外方法借助布隆过滤器
	* 当有新的短网址生成时，先拿新生成的短网址在布隆过滤器中查找
	* 如果查找的结果不存在，就说明没有冲突，直接写入

如何通过 ID 生成器生成短网址？
	* 维护一个 ID 自增生成器，可以生成 1、2、3…这样自增的整数 ID。
	* 当接收请求后，先从 ID 生成器中取一个号码并将其转化成 62 进制表示法，拼接到短网址服务的域名后面，就形成了最终的短网址

1. 相同的原始网址可能会对应不同的短网址
有两种处理思路：
（1）不做处理，大部分场景里，用户根本就不关心短网址长什么样子
（2）借助哈希算法生成短网址的处理思想，要先拿原始网址在数据库中查找，如果存在，直接返回给用户
	* 这种处理思路的问题：需要给数据库中的短网址和原始网址这两个字段，都添加索引
	* 这种解决思路是的代价：一：两个索引会占用更多的存储空间，二：索引还会导致插入、删除等操作性能的下降。

2. 如何实现高性能的 ID 生成器？
	* （1）给 ID 生成器装多个前置发号器，批量地给每个前置发号器发送 ID 号码
	* 当接受请求时，就选择一个前置发号器来取号码。通过多个前置发号器，提高并发发号的能力

	* （2）直接实现多个 ID 生成器同时服务
	* 为了保证每个 ID 生成器生成的 ID 不重复，每个 ID 生成器按照一定的规则来生成 ID 号码
	* 这样通过多个 ID 生成器同时工作，也提高了 ID 生成的效率

</div>2020-02-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ae/00/791d0f5e.jpg" width="30px"><span>忍者无敌1995</span> 👍（15） 💬（5）<div>追到这里，终于有底气在简历上写上一行熟悉各种数据结构与算了^_^.
感谢王争老师，下一步就是利用leetcode进一步提升自己的算法功底，
将熟悉变成精通</div>2019-04-11</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI4akcIyIOXB2OqibTe7FF90hwsBicxkjdicUNTMorGeIictdr3OoMxhc20yznmZWwAvQVThKPFWgOyMw/132" width="30px"><span>Chuan</span> 👍（12） 💬（0）<div>终于把老师的算法专栏看完了，断断续续花了几个月时间，有听懂的做了笔记并实现了一遍的，也有没听懂的跳过的（红黑树。。。）。最重要的收获应该是对算法和数据结构有个一个整体的认识，并且加深了自己的理解。虽然很快就会忘，但是再看一遍，也能够很快回忆起来。

在一个专栏这么多篇文章面前，很多时候由于惰性、畏惧感等因素，导致我们荒废。但真的是看了就赚了，和自己斗争才是最有意思的。非常感谢老师，接下来准备继续学习老师的设计模式了，期待老师带来更多的惊喜。（PS：有几篇课老师好像说要补充的，这都快一年了哦^_^）</div>2020-02-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/f2/aa/32fc0d54.jpg" width="30px"><span>失火的夏天</span> 👍（9） 💬（0）<div>本来想针对思考题二说一点的，结果评论翻到了(*^▽^)&#47;★*☆，数据量大，如果用的传统关系型数据库，就可以采用水平分表，这里好像用不到垂直分表，因为没什么别的无关字段。同时可以考虑分库的情况，通过中间件路由到不同的数据库中。

不过关系型数据库设计之初对数据预估不完全的话，就算分库分表了，依然会造成单表数据巨大，这个时候再来做数据迁移成本极高，所有数据又要全部重新分库分表。这个时候就轮到NoSQL出场了，因为它天生就支持分库分表，而且扩展性也优秀。</div>2020-01-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/73/68/ae13bd32.jpg" width="30px"><span>一涛</span> 👍（9） 💬（0）<div>1. 首先查询“用户自定义部分”是否与已经生成的短网址冲突，如果冲突，只能提示用户进行修改。如果不冲突，将“用户自定义部分”和对应的原始网址写入数据库即可。

2. 给原始网址加唯一索引。如果写入异常，说明原始网址已经存在，再根据原始网址查询一次，取出短网址返回给用户。

不知道回答对不对，请老师指正</div>2019-02-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/cf/f4/26b95f0b.jpg" width="30px"><span>TryTs</span> 👍（9） 💬（1）<div>兴趣是最好的老师，这话没有错。如果没有兴趣那就去找。就我个人看法，很多时候一开始不一定非要搞那么枯燥的东西，做一些有趣的东西，慢慢培养自己的兴趣，自己就会有好奇心去往深处学习，如果以来就弄那些很“艰深”的东西，可能不能坚持多久，“从入门到放弃”。学习老师这个专栏，我最大的收获就在于老师把平时课上那些算法讲活了，应用到具体场景之中，相较于一些为了练习而联系的习题，这让我更能体会到算法之美。也在不断激发我的好奇心。我希望自己能够一直抱持这份好奇心。继续努力学习。</div>2019-02-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/dc/ac/905fbf6b.jpg" width="30px"><span>bens</span> 👍（8） 💬（0）<div>id生成器用snowflake算法解决</div>2019-02-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/3c/83/93e7af9e.jpg" width="30px"><span>兰柯</span> 👍（5） 💬（0）<div>11天粗刷完一遍专栏，大四学生，想做推荐，自从大二上完数据结构就再也没碰过红黑树b树这样的算法了，每天面对的是马尔可夫贝叶斯蒙特卡洛吉布斯这些大佬，每天和各种数学纠缠，可能自己对这个领域还不够深入，但是我学机器学习的时候的的确确没有碰到过数据结构的问题，倒是日常的数学问题，所以对数据结构这种基础课放松了，现在打算给数据结构时间了，毕竟大厂面试也得刷题。</div>2020-02-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e3/72/754314c2.jpg" width="30px"><span>Jackson</span> 👍（5） 💬（0）<div>之前没有坚持下来，拖了很久，觉得不应该辜负了自己花的钱还有就是老师的辛苦，所以咬咬牙重新开始从第一讲开始学习，终于学完了，但是我觉得我还会继续看第二遍第三遍的，因为每次学习都会有不一样的知识，都能想到不一样的问题和思路，最后说一句，谢谢老师。</div>2020-01-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/42/9d/c36b7ef7.jpg" width="30px"><span>顾骨</span> 👍（4） 💬（0）<div>打卡，从2020.3月到现在，每天坚持学一点，现在终于学完了，课程中的大部分算法都用GO实现了，为自己点个赞</div>2021-03-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/f1/9c/cd12361d.jpg" width="30px"><span>黑客时间</span> 👍（4） 💬（0）<div>hash值出现负数怎么处理，直接去绝对值吗</div>2020-07-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8e/c4/8d1150f3.jpg" width="30px"><span>Richie</span> 👍（3） 💬（0）<div>关于如何实现高性能的ID生成器，文中介绍了两种思路，一种是事先把ID批量生成好，放到多个前置发号器中；第二种是直接使用多个ID生成器，生成尾号不同的ID。
在我看来这都是分治的思想，都是按照一定的规则，将原来的一条队列分成N条队列来处理，这样就提高了并发的能力。
两者最大的区别在于，前者是事先把ID生成好的，有请求时直接来取号就行了；而后者是有请求来的时候再去生成ID。
当ID生成算法很简单的时候，以上两种实现思路的效率是一样高的。当ID生成算法比较耗时的时候，那前者就会更快。
 </div>2020-02-02</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/N0NACGUr8dNAbN6BdiagPHBaB0EnyDsI9zWpwJteqTY38apOEnTOA7JkBAQnzYKJBgxu3Q8YMUILwLAB6camn4w/132" width="30px"><span>Swing</span> 👍（3） 💬（0）<div>em，第一遍 2019.11.27-2009.12.23，买了一年多才来看
年底辞职准备跳槽，所以工作日看，周末出去玩，断断续续的，也算是过完了，mark下。

总结下：

1、感谢 王争 老师，绝大多数的知识点 讲的都很好，剩下一部分感觉没讲清楚，略微遗憾（虽然知道已完结，不太可能了，但还是希望 能有后续的优化）；
但 这是我买了一堆课程和资料后，第一个认真看完的专栏了！！！

2、整个课程 虽然 本人基本都是在看和思考，没怎么敲代码来落实成果；红黑树、动态规划最后一节 也没搞懂（有点挫败）
但是 各种字符串匹配算法、AC自动机 也能自己啃下来，也算 增强了不少自信心吧，起码让我这个之前非科班、对算法一无所知、半路入门直接入行的android开发者，
对算法有了一个系统、整体的认识，也认识到了 原来看来高大上的算法 没有那么遥不可及（嘿嘿，起码普通的算法是）；
至于那些只用零散时间、就能迅速看完并理解的初学者。。。厉害啊！！！

3、每篇文章后 大家的留言 挺有意思，也有一些启发。。。
美中不足的是，一些错误的观点 也被放进来了（可能需要 对口专业的人来审核吧）
</div>2019-12-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/0e/3b/42288ae6.jpg" width="30px"><span>./+-@YOU</span> 👍（3） 💬（0）<div>第二题:id生成器，不处理，会导致相同的长域名重复。有个解决方案，长域名设置唯一的限制，在重复的情况下，插入表失败后，查询已经存在的长域名，对应的短域名。返回该短域名</div>2019-03-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/7d/25/f59a0d5c.jpg" width="30px"><span>李雷</span> 👍（3） 💬（0）<div>坚持到了最后，给自己个赞</div>2019-02-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/40/10/b6bf3c3c.jpg" width="30px"><span>纯洁的憎恶</span> 👍（3） 💬（0）<div>1.短网址的自定义部分是要展示给用户的。是否可以把自定义部分作为第三个字段存入数据库。如果不同用户对相同原网址申请短网址自定义部分不同。要么不允许这种行为，否则就得把自定义部分与原网址拼接输入哈希函数，以实现区分。</div>2019-02-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ea/27/a3737d61.jpg" width="30px"><span>Shanks-王冲</span> 👍（2） 💬（0）<div>专栏一出就拿下它，第一次刷到第10篇就放弃了；这次疫情，让我有足够的时间来重新开始刷，到今天，相当于刷完了这份《数据结构与算法之美》，感谢争哥、小编、讲述修阳和背后的强大的团队！这此过程中，了解了自己遇到困难的反应，如何坚持、应对、逃避、直面等等心路历程，也重新认识和理解了ds &amp; al的美。正所谓，师傅领进门，修行在个人 —— 下山闯荡江湖(适度刷LeetCode)，从春节7天练习开始，也谢谢Smallfly的收集。各位，我们后会有期！</div>2020-09-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/0d/40/f70e5653.jpg" width="30px"><span>前端西瓜哥</span> 👍（2） 💬（0）<div>哦豁，终于看到这里了（太慢悠悠了）。数据结构大部分都用 js 实现了，还有一些比较复杂的近期打算都实现了。这里给个github地址给大家参考参考：https:&#47;&#47;github.com&#47;F-star&#47;js-Data-Structures-and-Algorithms</div>2019-06-27</li><br/>
</ul>