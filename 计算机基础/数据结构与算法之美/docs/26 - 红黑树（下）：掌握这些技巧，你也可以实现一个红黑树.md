红黑树是一个让我又爱又恨的数据结构，“爱”是因为它稳定、高效的性能，“恨”是因为实现起来实在太难了。我今天讲的红黑树的实现，对于基础不太好的同学，理解起来可能会有些困难。但是，我觉得没必要去死磕它。

我为什么这么说呢？因为，即便你将左右旋背得滚瓜烂熟，我保证你过不几天就忘光了。因为，学习红黑树的代码实现，对于你平时做项目开发没有太大帮助。对于绝大部分开发工程师来说，这辈子你可能都用不着亲手写一个红黑树。除此之外，它对于算法面试也几乎没什么用，一般情况下，靠谱的面试官也不会让你手写红黑树的。

如果你对数据结构和算法很感兴趣，想要开拓眼界、训练思维，我还是很推荐你看一看这节的内容。但是如果学完今天的内容你还觉得懵懵懂懂的话，也不要纠结。我们要有的放矢去学习。你先把平时要用的、基础的东西都搞会了，如果有余力了，再来深入地研究这节内容。

好，我们现在就进入正式的内容。**上一节，我们讲到红黑树定义的时候，提到红黑树的叶子节点都是黑色的空节点。当时我只是粗略地解释了，这是为了代码实现方便，那更加确切的原因是什么呢？** 我们这节就来说一说。

## 实现红黑树的基本思想

不知道你有没有玩过魔方？其实魔方的复原解法是有固定算法的：遇到哪几面是什么样子，对应就怎么转几下。你只要跟着这个复原步骤，就肯定能将魔方复原。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/f2/aa/32fc0d54.jpg" width="30px"><span>失火的夏天</span> 👍（305） 💬（11）<div>我看到老师说道要我举个例子，我不太清楚是我说的那个问题还是关于红黑树的理解，这里也分个区
一：我说的case3的情况是表示老师的画的那个图，case3图的例子根节点到左边叶子节点只经过2个黑色节点，到右边叶子节点却经过了3个黑色节点。

二：我这里就大概说下吧（一家之言，自己的一点经验，也希望别的同学来一起讨论）：
1.左旋右旋这个，个人还是认为要画图，不画图我自己也写不出那个代码……哈哈。

2.说到插入删除的算法，我说用到了递推，就比如插入的CASE1的情况，CASE1的处理之后，关注节点从本身变成了他的祖父节点（红色节点），这就是往根节点递推。不过我认为CASE1处理过一次之后，不一定会进入case2或者case3，是有可能还在case1的。

换句话说，就是可以在case1的情况下，一直往根节点走，因为当前节点永远是红色，所以在最后要把根节点涂黑。同时，只要进入到case2,case3的情况，就是变成平衡二叉树的单旋和双旋的情况，双旋的处理逻辑就是把双旋变成单旋（比如先右后左旋就是把树变成“左撇子”）。这个就变成了单左旋能一步到位处理的平衡了，这个就是归纳。把未知情况转化为已知，如果我没有记错的话，数学归纳法的核心思想就是递推和归纳。

3.其实我们只要记住，除了关注的节点所在的子树，其他的子树本身都是一颗红黑树，他们是满足红黑树的所有特征的。当关注节点往根节点递推时，这个时候关注节点的子树也已经满足了红黑树的定义，我们就不用再去特别关注子树的特征。只要注意关注节点往上的部分。这样就能把问题简化，思考的时候思路会清晰一些。

4.再说到删除算法，我看到很多同学没理解为什么要红-黑，黑-黑节点的出现。这里我的看法是，红黑树最不好控制的其实是最后一个的性质4（每个节点，从该节点到达其可达叶子节点的所有路径，都包含相同数目的黑色节点），因为你永远不知道别的子树到底有多少个黑色节点。这里加入红-黑，黑-黑节点就可以控制红黑树满足性质4，到时候要恢复颜色，只要去掉多余的黑色即可。

接下来的处理思路就是要满足：1.每个节点不是红的就是黑的，2.相邻节点不能是红的。这个思路计时变复杂为简单。

删除的case1情况，并没有真正处理，而且为了进入接下来的case2,case3,case4，这里又是之前说到的归纳思想。case2的情况又是一个递推思路，关注节点往根节点递推，让其左右子树都满足红黑树的定义。因为往上推，右子树多了一个黑色节点，就把关注节点的兄弟节点变红，使其满足性质4.

删除的case3是为了进入case4，提前变色的原因和case2是一样的，都是为了满足性质4。同样是归纳推理的思路。都要记住一点，各种case下的其他子树节点都满足红黑树的定义，需要分类讨论的，都在这几种case情况中了。

4.最后的建议，其实说了这么多，很多的表达都不太清楚，但是个人感觉，数学基础好的同学，理解红黑树会好一些，学习的时候多画画图，人对图形的敏感肯定比文字高，另外的就是大家可以去看看源码，本人是做java开发的，jdk1.8的treemap就是用红黑树实现的，跟着源码多看看，跟着老师的说明或者百度上的教程思考，动笔画画图，都能理解的。我自己看jdk源码的也是看了将近两个月才大概明白（因为也在上班，只有晚上有一些时间来看看代码）。学习的过程中要耐心，学习红黑树本身也不是为了“默写”，而是去学习思想，锻炼思维，复杂问题简单化，新问题转化为已解决过的问题等等。其实说到最后，都是用到了数学的思维，这些思维都会在潜移默化中影响到自己。

ps:本人并不是什么大牛，不会的东西也是很多很多，上面只是自己的一点感想。老师的建议很多，不要太去扣细节，我们要在一个整体的角度上去看红黑树是怎么处理的，知道他的应用场景，什么时候要用他，什么时候该用他，为什么要用他。这几个地方弄清楚，大部分就够了，我们要有的放矢，抓准学习的核心内容。</div>2018-11-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d0/4a/7e3d158d.jpg" width="30px"><span>沉睡的木木夕</span> 👍（59） 💬（5）<div>回到家我又翻看了《算法导论》中红黑树章节，又似乎加了点理解。
虽然里面时间复杂度依旧是用数学推导出来的，我看不懂，不过里面讲的红黑树5个性质：
1.每个节点不是红色就是黑色
2.根节点是黑色
3.每个叶子结点（NIL）是黑色的
4.如果一个节点是红色的，则他的两个子节点都是黑色的
5.对每个子结点，从该结点到其所有后代叶子结点的简单路劲上，均包含相同数目的黑色结点
后面讲到的3种情况都是为了满足这5点特性而做出的相应的变化
老师在讲解左右旋的时候一张图就概括了，说实话我第一时间真没看懂，花了大量时间这方面的理解，后来在《算法导论》中居然找到了浅显易懂的中文描述左右旋的过程，我概述为3点
1.左右旋操作中，只有指针的改变，其他所有属性都保持不变
2.左旋的过程与右旋的过程是对称的（伪代码也是对称的）
3.左旋为例，以x结点左旋，那么y成为该子树的跟结点，x成为y的左子结点，y的左子结点成为x的右子结点（所以右旋就是反过来的）
那么当多层级的呢，也就是文中case3中的右旋过程，因为是a的曾祖父结点来进行右旋，所以文中的“c”就是x，“a和b”就是y，那么右旋用文字描述就是“y（a,b）成为跟结点，x（c）成为y的右结点，y的右结点成为x的左结点，其他指针不变”
得到的子树结构然后根据前面说的5个特性（同老师说的4点特征）再做出响应的颜色变化
～～～～
唉，真是智商捉急</div>2018-11-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/1a/ad/faf1bf19.jpg" width="30px"><span>windcaller</span> 👍（28） 💬（7）<div>老师你好，本次实现代码有在git上存吗？</div>2019-06-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/f2/aa/32fc0d54.jpg" width="30px"><span>失火的夏天</span> 👍（11） 💬（4）<div>先提一个问题：老师，插入的case3情况是不是不满足红黑树的第四个条件？根节点到左边的叶子节点只经过两个黑色节点，但是根节点到右边的却经过三个黑色节点。

学习红黑树在于理解他的思想，比如为什么要旋转，是因为高度不平衡。为什么有双旋，因为单旋没法一步到位，所以把一个新问题转化为已经解决过的问题。旋转的学习其实自己画一下图，一步步走，数形结合的思想用上就好。插入的核心思想就是，把红色节点往根节点递推，然后把根节点涂黑。删除同样是往根节点递推，转化成处理过的情况因为越靠近根节点，节点关系也就越清晰。其实红黑树的处理也有动态规划的思想，只有处理的这个节点子树是可能破坏的，而其他节点子树都是红黑树，都满足红黑树的定义。用数学归纳法的思路来想这些问题，感觉就不会被复杂的情况搞得头晕。</div>2018-11-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/64/9b/3d62d420.jpg" width="30px"><span>望人艰不拆</span> 👍（5） 💬（1）<div>关于红黑树的插入看完这篇文章回头再看老师写的插入的三种case就会明白很多
https:&#47;&#47;blog.csdn.net&#47;wan198809&#47;article&#47;details&#47;48602921</div>2019-05-28</li><br/><li><img src="" width="30px"><span>sonia</span> 👍（5） 💬（2）<div>这部分感觉只是简单罗列，知其然不知其所以然，个人认为没讲好</div>2019-01-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/9e/64/df8f1d4e.jpg" width="30px"><span>陈明智</span> 👍（1） 💬（1）<div>添加的case2中一开始就不满足红黑球的定义了，根节点到右子节点经历过的黑色节点数比经过左边可到答节点数要多1</div>2018-11-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a3/ee/636415d8.jpg" width="30px"><span>永昌</span> 👍（1） 💬（1）<div>到这里终于蒙圈了</div>2018-11-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/f8/f0/0285e98a.jpg" width="30px"><span>杨小凡</span> 👍（0） 💬（1）<div>老师，准备写一篇博客，讲解红黑树的，是否可以引用您讲解的部分观点，会注明观点出处</div>2019-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/df/9f/18810a24.jpg" width="30px"><span>雪影绮缘</span> 👍（0） 💬（1）<div>git上红黑谁的代码没见到， 王老师发下链接</div>2019-10-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c4/07/dcfde0f8.jpg" width="30px"><span>Yunhe</span> 👍（0） 💬（1）<div>请教下老师: 内容里面的这些图用什么软件工具画出来的呀？效果很好</div>2018-12-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/18/0e/39307052.jpg" width="30px"><span>Laughing_Lz</span> 👍（0） 💬（1）<div>看到这里彻底看不懂了，我看过很多次数据结构与算法，每次都是学到这里就放弃了。再次走到这个路口，纠结要不要放弃，想问下老师，如果红黑树这些不能彻底掌握，那后面的图，深度广度优先遍历什么的 能否理解？我觉得要理解老师这一节的知识，我得花好几天去学学关于红黑树的基础，专栏能讲解的还是太少了。</div>2018-12-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/0f/c0/e6151cce.jpg" width="30px"><span>花仙子</span> 👍（0） 💬（1）<div>看了三两天时间才把插入调整看明白，基本上是以三种情况为基础递归操作，但是担心的是转来转去，会不会一直无法满足递归退出条件（满足红黑树），从而形成死循环了？</div>2018-11-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ce/cf/27ca5e72.jpg" width="30px"><span>_</span> 👍（0） 💬（1）<div>看的好懵逼，能否在讲策略的时候，如何通过旋转达到“平衡”的目的。这样或许更好。</div>2018-11-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/92/e3/1be13204.jpg" width="30px"><span>ichiro</span> 👍（0） 💬（1）<div>老师，删除的操作的图是不是有问题，为什么原图也会存在红黑的节点</div>2018-11-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/d3/34/5dee4f70.jpg" width="30px"><span>P@tricK</span> 👍（0） 💬（1）<div>红黑树实现这块看得有点晕，先不逼着自己码…
我去看了234树，感觉比较好理解，先把插入和分裂的码了，看看能不能帮助理解红黑树…</div>2018-11-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ff/73/8c64ed7f.jpg" width="30px"><span>辰陌</span> 👍（0） 💬（1）<div>忽然这一节没办法看进去了，如果是像魔方一样，先背公式，在练习熟练，那就看一遍行了。我其实比较好奇是这些规则是有理论推导，还是一切都只是在一系列操作后，找到往平衡上调整的最短路径？</div>2018-11-20</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/h0KAdRFKjCOhmWMYL56PUEYiabvpkopiciaOHjF7bFSaMRV2uKhXrNoXNpJ4HiaG3pwcUUdNK54jUgT2KVbyCCwba4wIfwibib0lyd/132" width="30px"><span>Conner</span> 👍（0） 💬（1）<div>左旋右旋一张图，看不懂。</div>2018-11-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/30/1c/e160955d.jpg" width="30px"><span>sky</span> 👍（0） 💬（1）<div>之前看cs61b，他是从B tree来引入红黑树的，感觉更容易理解</div>2018-11-19</li><br/><li><img src="" width="30px"><span>Terry</span> 👍（0） 💬（1）<div>左旋右旋是种神奇的操作：保证操作完还是有序的</div>2018-11-19</li><br/><li><img src="" width="30px"><span>pplegend</span> 👍（958） 💬（71）<div>我决定了 放弃研究红黑树了，如果面试遇到算我倒霉，人生要学会放弃一些东西</div>2019-03-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d0/4a/7e3d158d.jpg" width="30px"><span>沉睡的木木夕</span> 👍（168） 💬（14）<div>感觉看不下去了，多层级的左旋右旋过程能不能再详细说一下？还有新增，删除那里的case几种情况，是不是就是说红黑树操作只有这几种情况？这里面的左右旋真的没搞懂</div>2018-11-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/e5/d6/37a1be71.jpg" width="30px"><span>凡</span> 👍（112） 💬（11）<div>文章还没看完，前面的就忘了</div>2018-11-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/55/94/cefb8a05.jpg" width="30px"><span>。。。</span> 👍（90） 💬（11）<div>红黑树是由2-3树演变过来的，父节点指向的节点是红节点，那么就认为这两个节点其实是2-3树里面的3节点。如果有一个黑节点链接了两个红节点，那么就认为这是一个4-节点，因为2-3树不允许4-节点所以要将其提取出来。所谓的旋转。对于2-3树来说节点并没有变化。因为 红节点和指向他的节点本来就被认为是一个节点。建议看《算法》。里面讲了红黑树的精髓。看完以后怎么旋转怎么写红黑树就都知道了</div>2018-11-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/43/24/3f9f7c70.jpg" width="30px"><span>zixuan</span> 👍（63） 💬（0）<div>这个不是设计而是推导出来的，源自2-3树 https:&#47;&#47;blog.csdn.net&#47;fei33423&#47;article&#47;details&#47;79132930</div>2018-11-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/e8/fd/abb7bfe3.jpg" width="30px"><span>Langzi233</span> 👍（48） 💬（5）<div>自己画图也可以，耗子叔推荐的各种算法图解工具，转给有缘人：https:&#47;&#47;www.cs.usfca.edu&#47;~galles&#47;visualization&#47;Algorithms.html</div>2020-03-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/42/67/b96b843f.jpg" width="30px"><span>凉粉</span> 👍（44） 💬（0）<div>一脸懵</div>2018-11-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c7/dc/9408c8c2.jpg" width="30px"><span>ban</span> 👍（35） 💬（2）<div>1、没看懂哪个节点跟哪个节点左旋或者右旋
2、为什么要有红&#47;黑节点，为什么要有红-黑 黑-黑，作用是什么</div>2018-11-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/dd/cb/23b114a7.jpg" width="30px"><span>xiao皮孩。。</span> 👍（26） 💬（1）<div>说实话，前几章都看懂了，这个真没懂</div>2019-02-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/d8/425e1b0a.jpg" width="30px"><span>小虾米</span> 👍（23） 💬（2）<div>看到删除的部分突然懵了，什么时候多了一个红黑，黑黑，一个节点两个颜色的概念了……</div>2018-11-19</li><br/>
</ul>