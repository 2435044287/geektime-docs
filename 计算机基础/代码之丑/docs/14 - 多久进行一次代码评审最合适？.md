你好，我是郑晔。

前面我们讲了很多代码的坏味道，我们的关注点都在代码本身上。知道了什么样的代码是坏味道，有了具体的评判标准。那么，该如何去运用坏味道这把“尺子”呢？

有一个发现坏味道的实践，就是代码评审，也就是很多人熟悉的 Code Review，Wikipedia上定义是这样的：

> 代码评审，是指对计算机源代码系统化地审查，常用软件同行评审的方式进行，其目的是在找出及修正在软件开发初期未发现的错误，提升软件质量及开发者的技术。

大多数程序员都经历过代码评审，也都能够初步理解代码评审本身存在的价值，这也是差不多全行业都认为有价值的一个实践。只不过，每个团队在代码评审的实践差别还挺大的，有的团队是在一个完整的开发周期结束之后，做一次代码评审；有的是安排每周的代码评审；有的则是每天都要做代码评审。之所以会有这样的差异，主要就是团队对于代码评审本身的理解有差异。

所以，这一讲我们就来谈谈，到底应该如何理解代码评审。

## 代码评审是一个沟通反馈的过程

关于代码评审，第一个问题就是，为什么要做代码评审？

这个问题其实比较简单，没有人能够保证自己写出来的代码是没有问题的，而规避个体问题的主要方式就是使用集体智慧，也就是团队的力量。
<div><strong>精选留言（18）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/24/89/a2/07fccf62.jpg" width="30px"><span>赵智慧</span> 👍（10） 💬（2）<div>老师，您说的太对了。因为一个敏捷教练，小波带领我们做了很多。
例如：工程实践、每天code review、结对编程。团队也已经这样运作了奖金一年。
好处多多，老师您都说了。
但是最近碰到一些问题：因为我们技术们，尽管没有的Leader，但大家都执行的不错。结对编程、code review、暴徒式编程。但是最近code review上大家的分享越来越少了。
我猜测几种可能：
1、是不是随着大家技术的水涨船高，问题越来约少呢？
2、因为我最近分享老师的代码之丑，大家觉得code review变了一个调调，换成分享坏味道了？（其实分享代码之丑的时候，我分享初衷是想让大家都可以学习到，但是我本身自己做的就不太好，代码里面还有好多坏味道，直接去讲 担心大家会不会觉得太空呢？有句话说：道理都懂，可就是过不好这一生！实践真的太难了）
3、会不会我们的code review没有回顾会？没有去总结如何把code review做的更好？
4、是不是我们没有明确code review都需要做哪些事儿？列出来 1 2 3
5、会不会是每天都code review，频率太高了呢？每天工作量毕竟也是有限的？
6、会不会是太经常了，心态上已经没有最开始那么重视？我们每天5点code review，我有的时候心里面会想，到5点就算这一天的工作做完了，开个会就下班了！

我期望老师给个意见，如何能让我们的code review更上一个台阶，做的更好、更有效率呢？</div>2021-02-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/61/b6/ba31d93e.jpg" width="30px"><span>点</span> 👍（5） 💬（1）<div>做几年码农了，一直没人给我review.  当第一次有人给我review时，被说像刚毕业的，羞愧难当。  如果在没有review氛围的公司，怎么提高自己的代码质量？</div>2021-02-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/3c/52/5951ffb4.jpg" width="30px"><span>Sinvi</span> 👍（4） 💬（1）<div>代码评审本身就是对团队成员代码质量提升的有效方法，之前我每次commit都会要求我自己先检查一下有没有更好的方式，然后老大再去看一下，每次找出问题来自己也会很难受，然后慢慢自己也都会注意起来。</div>2021-01-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/87/4e/98173974.jpg" width="30px"><span>明</span> 👍（3） 💬（1）<div>我从来没经经历过代码评审😂😂 所以我感觉从老师这里真的学到了好多好多</div>2021-01-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/73/a0/7dcc9212.jpg" width="30px"><span>adang</span> 👍（3） 💬（3）<div>还是菜鸟的时候，所在的团队有 Code Review，Leader 对每个人提交的代码都会亲自 Review 并指出问题, Leader 做评审的时候都会带上小本本记下问题，那段时间自己成长的特别快。后来因为某些原因团队解散，经历过的其他的一些团队再也没有那么好的 Review 氛围了。</div>2021-01-30</li><br/><li><img src="" width="30px"><span>Geek2808</span> 👍（2） 💬（1）<div>自己团队其实也一直在做代码review，老大也比较重视。读完作者这篇文章感觉自己的收获就是review的方向有了：实现方案的正确性，算法的正确性和代码的坏味道。这点我觉得的可以在review的时候刻意注意的地方。
特别认同作者说的刻意练习，不好的习惯，只能通过刻意的练习将其纠正过来。这个也是我最近自我感觉提高的一点，刻意的去做正确的事，慢慢的自己提高是很明显的。</div>2021-01-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f9/e6/47742988.jpg" width="30px"><span>webmin</span> 👍（2） 💬（3）<div>来个新鲜的案例，昨天代码评审时发现的问题：
```java
List&lt;String&gt; a = new ArrayList&lt;&gt;();
&#47;&#47;筛选数据，符合条件的添加到a中

List&lt;String&gt; b = new ArrayList&lt;&gt;();
a.addAll(b);

&#47;&#47;筛选数据，符合条件的添加到b中

&#47;&#47;结束返回a
return a;
```
对引用的认识不清楚，集合的addAll方法是把参数集合中的每一个Element添加到自己这个集合中，不是把集合做为一个Elements添加到集合中，形成多维关系。
事后追问了一个问题，同一个对象添加到两个不同的集合中，然后再从其中一个集合中取出对象对其进行修改，问此时另一个集合中的那个对象的受影响吗？</div>2021-01-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ad/24/c6b763b4.jpg" width="30px"><span>桃子-夏勇杰</span> 👍（2） 💬（1）<div>郑老师，有没有用系统思考的方式评估过代码评审在软件开发中的位置或者作用？</div>2021-01-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/fd/ce/5d9f67e0.jpg" width="30px"><span>Dawson</span> 👍（0） 💬（1）<div>有种相见恨晚的感觉，CodeReview我也在做团队内部断断续续的做，之前都是凭感觉，现在有了郑老师总结的方法论指引，让我如虎添翼。</div>2022-01-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg" width="30px"><span>Jxin</span> 👍（19） 💬（6）<div>原文： 把循环里对于一个元素的处理拆了出去。还没等我来赞美这段代码写得好，我就看到了单个元素处理的代码，每次都要查询一次数据库，找出相应的元素，做修改之后再存回去。

结论，我认为这个每次查一次数据库没问题。

决策依据:
1.这样的单行操作更易理解。
2.批查询可能伴随大事物(毕竟你是更新动作，可能要锁（悲观或乐观）所有数据行)
3.如果更新操作不需要锁数据行，也就是数据行的变更对更新操作的正确性无影响。那么通过加缓存会是更好的解决方案。

综上所述，保证业务逻辑简单是第一原则。</div>2021-02-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/34/cf/0a316b48.jpg" width="30px"><span>蝴蝶</span> 👍（2） 💬（0）<div>我们一直在做需求，没有时间做评审，就算有，也是中午边吃饭边评审，太卷了</div>2022-01-16</li><br/><li><img src="" width="30px"><span>Geek2808</span> 👍（1） 💬（0）<div>自己团队其实也一直在做代码review，老大也比较重视。读完作者这篇文章感觉自己的收获就是review的方向有了：实现方案的正确性，算法的正确性和代码的坏味道。这点我觉得的可以在review的时候刻意注意的地方。
特别认同作者说的刻意练习，不好的习惯，只能通过刻意的练习将其纠正过来。这个也是我最近自我感觉提高的一点，刻意的去做正确的事，慢慢的自己提高是很明显的。</div>2021-01-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/f5/95/a362f01b.jpg" width="30px"><span>Geek1560</span> 👍（0） 💬（0）<div>我们是每个pr都需要一定人āp之后才能merge</div>2024-08-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/fd/58/1af629c7.jpg" width="30px"><span>6点无痛早起学习的和尚</span> 👍（0） 💬（0）<div>对文中的一些点做个留言吧：
一、结对编程
但是现实往往，团队会在频繁的需求里淹没，占据时间

二、团队 cr 发现不了坏味道
哈哈哈，这句话太真实了，的确是这样的，我看了郑大的课去公司 cr 提出一些代码坏味道，有时候还被同事质疑，就不改，每次都需要我去找一些最佳实践材料给他们，他们才认可</div>2023-11-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg" width="30px"><span>ifelse</span> 👍（0） 💬（0）<div>代码评审暴露的问题越多越好，频率越高越好--记下来</div>2022-06-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/8b/a7/b6471f02.jpg" width="30px"><span>远逝的栀子花</span> 👍（0） 💬（0）<div>我们团队提交代码就要把提交链接发的群里大家进行检视，每周都会对大颗粒需求代码进行业务逻辑与编程规范的检视。</div>2022-05-02</li><br/><li><img src="" width="30px"><span>linfei</span> 👍（0） 💬（0）<div>业务实体的批量查询是很常见的场景，但涉及权限后就很纠结了。在DDD设计中，权限和业务一般都是不同的域，或至少是不同聚合，当批量查询时容易想到的就是批量查出来，然后逐个调用权限服务进行权限判断，最后返回。但这样对于数据库来说就把原本可以批量进行的一次操作变成了n次操作，类似这一讲中提到的问题。但要把权限和业务合并在一起查询吗？那样的话就要将权限和业务合到一个聚合中？这似乎也不合适啊。</div>2022-04-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c0/99/259a412f.jpg" width="30px"><span>Geeker</span> 👍（0） 💬（0）<div>关于批量操作这点，发表下个人看法，在实际开发中，我是根据场景两种方式都有用到。
1. 非系统高频使用时间段，比如凌晨，定时任务这种，有在循环内访问数据库。
2. 系统高频使用的时间段内，还要看这个数据量的大小，如果也就几十条数据，那一次性查询出来，循环内处理，和循环内每次都查询，这样做还是区别挺大的。
所以具体问题具体分析。</div>2022-03-23</li><br/>
</ul>