前面讲完了TCP和UDP协议，还没有上手过，这一节咱们讲讲基于TCP和UDP协议的Socket编程。

在讲TCP和UDP协议的时候，我们分客户端和服务端，在写程序的时候，我们也同样这样分。

Socket这个名字很有意思，可以作插口或者插槽讲。虽然我们是写软件程序，但是你可以想象为弄一根网线，一头插在客户端，一头插在服务端，然后进行通信。所以在通信之前，双方都要建立一个Socket。

在建立Socket的时候，应该设置什么参数呢？Socket编程进行的是端到端的通信，往往意识不到中间经过多少局域网，多少路由器，因而能够设置的参数，也只能是端到端协议之上网络层和传输层的。

在网络层，Socket函数需要指定到底是IPv4还是IPv6，分别对应设置为AF\_INET和AF\_INET6。另外，还要指定到底是TCP还是UDP。还记得咱们前面讲过的，TCP协议是基于数据流的，所以设置为SOCK\_STREAM，而UDP是基于数据报的，因而设置为SOCK\_DGRAM。

## 基于TCP协议的Socket程序函数调用过程

两端创建了Socket之后，接下来的过程中，TCP和UDP稍有不同，我们先来看TCP。

TCP的服务端要先监听一个端口，一般是先调用bind函数，给这个Socket赋予一个IP地址和端口。为什么需要端口呢？要知道，你写的是一个应用程序，当一个网络包来的时候，内核要通过TCP头里面的这个端口，来找到你这个应用程序，把包给你。为什么要IP地址呢？有时候，一台机器会有多个网卡，也就会有多个IP地址，你可以选择监听所有的网卡，也可以选择监听一个网卡，这样，只有发给这个网卡的包，才会给你。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/81/0f/fce9d8ea.jpg" width="30px"><span>明子</span> 👍（43） 💬（6）<div>这章看的很吃力，可能限于篇幅原因，很多细节都没讲清楚。比如，说需要两个socket（监听socket和已连接socket），但没有说为什么需要两个socket，我去查了《Unix 网络编程》才了解原因；而且需要说明的是，只有服务端需要两个socket。</div>2019-01-09</li><br/><li><img src="" width="30px"><span>起风了001</span> 👍（30） 💬（6）<div>之前有专门学过epoll, 然后就特地看了一下socket和tcp连接的关系, 所以这一章看得比较清晰明白.哈哈, 技术真的是多学就能融会贯通的, 不过本章老师说的主要是linux C编程上的, 现在我用的golang写的话, 很多细节都被隐藏了, 不需要使用epoll, 直接Listen(), 然后Accept() , 有新的连接过来的话就会返回一个Conn, 然后使用golang的goroutine就可以开启一个协程处理这个连接, 一个程序可以开100万个都没压力, 所以也就没有epoll这样的概念了.</div>2019-05-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f9/61/0f2e4328.jpg" width="30px"><span>灵魂胖子</span> 👍（17） 💬（2）<div>老师，那个UDP 协议的 Socket 程序函数调用过程中的客户端可以不用调用bind（）吧?</div>2018-06-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/07/8c/0d886dcc.jpg" width="30px"><span>蚂蚁内推+v</span> 👍（12） 💬（3）<div>你好，服务端监听socket和连接socket并不是同一个socket,那是同一个端口么，如果是的话，怎么区分收到的数据是哪个socket的</div>2019-07-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/62/5e/ef349e39.jpg" width="30px"><span>Observer</span> 👍（12） 💬（1）<div>还的继续啃 Unix 网络编程</div>2019-02-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/20/5d/69170b96.jpg" width="30px"><span>灰灰</span> 👍（11） 💬（1）<div>老师，对socket这块一直理解比较抽象，什么情况下需要socket编程，我印象中从来没写过。盼复</div>2018-06-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/71/ee/31b19304.jpg" width="30px"><span>小可爱</span> 👍（8） 💬（3）<div>我有个问题就是，数据来了之后服务端怎么知道这个数据是属于哪个socket呢？</div>2019-08-10</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK9RytLsauRVYGjupDIaibibAK5iaicEicONrMFc0O3icAGf5mD1buxoQ2ePPn9YurFhRbuf3AR1qJDy0GQ/132" width="30px"><span>星文友</span> 👍（8） 💬（1）<div>select由文件描述fd_set限制
epoll 由文件描述符数量限制 
两个差异很大吗</div>2018-06-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/09/9d/8af6cb1e.jpg" width="30px"><span>臭猫</span> 👍（5） 💬（1）<div>Udp编程中，服务端只用一个socket收发所有客户端信息好，还是为每个客户端都分配一个socket好呢？</div>2019-01-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/6f/63/abb7bfe3.jpg" width="30px"><span>扬～</span> 👍（5） 💬（2）<div>UDP的socket的调用过程中，为什么没有listen呢，要不应用程序怎么监听此端口？要不怎么把UDP的包发往监听此端口的应用程序呢？基于UDP的方式会不会因为连接数过多，造成服务器处理压力增大从而延迟增高呢？因为他们共用一个端口，而不是像TCP那样会复制一个套接字随机分配一个端口用于数据接受和发送。我不知道我说的对不对，希望老师能够解答一下困惑。</div>2018-11-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/12/f9/7e6e3ac6.jpg" width="30px"><span>Geek_04e22a</span> 👍（4） 💬（1）<div>学习nginx和Apache区别有一点是Apache使用select，nginx使用epoll，所以nginx性能比Apache好一些，一直认为select比较low，学了之后才发现在socket发展过程中，select机制也是一种优秀的机制。</div>2019-06-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/61/bc/88a905a5.jpg" width="30px"><span>亮点</span> 👍（4） 💬（1）<div>老师，sk_buffer里面的数据应该是剔除掉链路层和网络层头部信息的吧?</div>2018-06-15</li><br/><li><img src="" width="30px"><span>13738095165</span> 👍（3） 💬（2）<div>老师，socket事件变化后，通知epool-entry后，调用callback，引起了红黑树节点什么变动？</div>2019-05-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ad/d6/06610564.jpg" width="30px"><span>dfx</span> 👍（3） 💬（1）<div>&quot;这个数组中的内容是一个指针，指向内核中所有打开的文件的列表.&quot; 这段没看懂 数组的内容怎么可能是一个指针的？ 是不是数组的内容是指针，每个指针指向一个打开的文件</div>2019-04-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e9/52/f07e9001.jpg" width="30px"><span>想当上帝的司机</span> 👍（3） 💬（1）<div>Epoll里的红黑树是为了快速查找监听的socket吗  我看下面有一个监听链表了</div>2019-01-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（3） 💬（1）<div>老师我有个问题，socket通信需要确定是基于UDP还是TCP，而且还得知道IP，那么socket是在网络模型中，那一层发起的呢？</div>2018-07-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/d8/86/34af6df9.jpg" width="30px"><span>泰霖</span> 👍（2） 💬（1）<div>刘老师你好，请教你一个问题，socket编程可以是IO，也可以是NIO的么？</div>2019-05-23</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epMgsF4cibo74JnDZHibTiaYdOUpIJI5VyT7uNywWPwY14C45bBsBgZX3SlAsNybgYSpLkGB0Aphb2Yw/132" width="30px"><span>shulin</span> 👍（2） 💬（2）<div>一旦握手成功，服务端的 accept 就会返回另一个 Socket。这句话不理解。请问老师，我用tcp调试工具，1个server接收到2个client，服务器端公用的是同一个端口（就是监听端口）啊。老师解答下，谢谢</div>2018-11-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/98/ef/bf392cc0.jpg" width="30px"><span>shanshan</span> 👍（1） 💬（1）<div>epoll 从本质上来说，它还是一种事件通知的机制。我理解的是，它充当了一种代理的角色，它管着所有已连接的socket，这些socket 的某些事件发生的时候，它会把这种变化通过call back 通知到epoll，然后epoll 会得到是哪个socket 发生了哪些事件变化的信息，然后把这些信息再给到线程，线程便知道了要对哪些socket 做哪些操作，类比来说，类似于饭店里点了餐，然后只是不需要你在上菜窗口等着，不停的查看是否菜备好了，你只是拿了一个号，然后当饭好了以后会叫号，这个时候你再去取餐，就是说取餐的这个过程还是需要你自己来做，所以这还是没有实现异步的过程，应该还算是同步，异步应该是说是有服务员给你把餐送了过来。epoll这个过程不知道理解的对不对，希望老师指点。另外有个问题就是，是一个“项目组”对应一个epoll 吗 还是一个epoll 可以对应多个‘项目组’，他两之间又是通过什么来进行通信的呢？</div>2020-05-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/a0/57/3a729755.jpg" width="30px"><span>灯盖</span> 👍（1） 💬（1）<div>感谢感谢，基础知识扎实是技术提升能力提升的基石，跟着老师努力学习💪</div>2019-05-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/59/25/0efc8b38.jpg" width="30px"><span>Dream</span> 👍（1） 💬（1）<div>socket建立还没搞懂，如何建立socket能不能举个例子，纯理论的灌输确实太累了，能不能距离贴近实际编程而不是直接距离贴近生活</div>2019-02-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/14/b3/b6e1817a.jpg" width="30px"><span>趁你还年轻233</span> 👍（1） 💬（1）<div>nodejs的事件驱动模型可以解决C10K问题</div>2018-11-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7e/57/8c1051b6.jpg" width="30px"><span>3.0的A7</span> 👍（1） 💬（1）<div>在内核中，为每个 Socket 维护两个队列。为什么是两个？</div>2018-10-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/dc/68/006ba72c.jpg" width="30px"><span>Untitled</span> 👍（1） 💬（1）<div>老师很形象地描述了线程和进程的区别，这个与操作系统上的cup工作机制的概念是一致的吗？</div>2018-09-16</li><br/><li><img src="" width="30px"><span>你是小孩</span> 👍（0） 💬（1）<div>后面讲解的Socket4种方式，其实是Linux系统中的几种IO模型：
方式1、2其实用的是阻塞式IO模型 &#47; 非阻塞IO模型，区别是前者是进程级、后者是线程级
方式3用的是Linux的多路复用select()接口
方式4其实用的是Linux的异步IO模型</div>2020-01-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/64/86/f5a9403a.jpg" width="30px"><span>yang</span> 👍（0） 💬（1）<div>tcp这几讲知识点真的好多 要好好消化

终于明白了 select 与 epoll原来是这样的:

select通过轮询所监听的文件描述符集合 确认是否发生io
epoll基于事件回调机制 发生io

是这样的吗？超哥

另外，大家都常说的poll又是怎么回事啊？</div>2019-09-04</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/aTnlMgdUuSFnBjQD7IlqaDibXg8UlZ8kxhj1AWwo0oWiaHRK2VkRhufmYvkt0ruHo2xP1CRPsed2h4IpNpAibn4uw/132" width="30px"><span>小学生六年级</span> 👍（0） 💬（1）<div>socket 维护两个队列！！！  sync_flood</div>2019-07-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/03/57/31595f22.jpg" width="30px"><span>Lrwin</span> 👍（0） 💬（1）<div>这篇文章太牛了</div>2019-07-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/d0/c7/62de0458.jpg" width="30px"><span>谭小谭</span> 👍（0） 💬（1）<div>这一章讲的是不是就是http服务器干的事情，比如nginx</div>2019-02-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/68/5d/1ccee378.jpg" width="30px"><span>茫农</span> 👍（0） 💬（1）<div>epoll创建的是文件描述符，socket也是文件描述符，那上限应该是系统上限&#47;2?</div>2018-10-24</li><br/>
</ul>