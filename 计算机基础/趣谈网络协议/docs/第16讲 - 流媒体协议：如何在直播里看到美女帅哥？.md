最近直播比较火，很多人都喜欢看直播，那一个直播系统里面都有哪些组成部分，都使用了什么协议呢？

无论是直播还是点播，其实都是对于视频数据的传输。一提到视频，大家都爱看，但是一提到视频技术，大家都头疼，因为名词实在是太多了。

## 三个名词系列

我这里列三个名词系列，你先大致有个印象。

- **名词系列一**：AVI、MPEG、RMVB、MP4、MOV、FLV、WebM、WMV、ASF、MKV。例如RMVB和MP4，看着是不是很熟悉？
- **名词系列二**：H.261、 H.262、H.263、H.264、H.265。这个是不是就没怎么听过了？别着急，你先记住，要重点关注H.264。
- **名词系列**三：MPEG-1、MPEG-2、MPEG-4、MPEG-7。MPEG好像听说过，但是后面的数字是怎么回事？是不是又熟悉又陌生？

这里，我想问你个问题，视频是什么？我说，其实就是快速播放一连串连续的图片。

每一张图片，我们称为一**帧**。只要每秒钟帧的数据足够多，也即播放得足够快。比如每秒30帧，以人的眼睛的敏感程度，是看不出这是一张张独立的图片的，这就是我们常说的**帧率**（**FPS**）。

每一张图片，都是由**像素**组成的，假设为1024\*768（这个像素数不算多）。每个像素由RGB组成，每个8位，共24位。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/12/ce/a8c8b5e8.jpg" width="30px"><span>Jason</span> 👍（98） 💬（4）<div>写的特别清楚明白，超哥绝对适合当老师。问题1，rtmp的问题是基于tcp连接的，不适合做实时流传输？改进方法，那就是把UDP引进？</div>2018-06-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d1/15/7d47de48.jpg" width="30px"><span>咖啡猫口里的咖啡猫🐱</span> 👍（27） 💬（1）<div>直播用TCP延迟太高了吧，，，他的保证有序，拥塞机制，，导致current等待之前的包</div>2018-06-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0b/0a/fa152399.jpg" width="30px"><span>wahaha</span> 👍（15） 💬（1）<div>一般说的看视频其实包含了音频，不然成了哑巴剧了，请老师讲下音频。</div>2018-06-23</li><br/><li><img src="" width="30px"><span>zKerry</span> 👍（8） 💬（1）<div>写的很好，看了之后，不敢说对流媒体入门，但至少有点方向</div>2019-09-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/48/3da605c6.jpg" width="30px"><span>July</span> 👍（5） 💬（1）<div>RTMP 沟通的版本号是指什么的版本号呢？</div>2018-08-22</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erPjrJ8ziawrXyCA202LLDWR8eBsrvSwM921VQgLXyR4nnuAXcBkhMP3thq016KFAcqZ6CUZ78Kb4w/132" width="30px"><span>jztong</span> 👍（4） 💬（1）<div>老师，每个NALU是一片吗？不应该是几个宏块或者子块吗？</div>2019-05-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/95/96/0020bd67.jpg" width="30px"><span>夏洛克的救赎</span> 👍（4） 💬（1）<div>老师   是不是忘记说视频混流了🙃</div>2018-06-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/14/ee/d72a8222.jpg" width="30px"><span>攻城拔寨</span> 👍（3） 💬（1）<div>视频是一帧一帧的图片，那么音频呢？它又是怎么压缩的？</div>2018-06-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7f/27/03007a5e.jpg" width="30px"><span>月饼</span> 👍（3） 💬（1）<div>老师可以讲讲为什么大家都用rtmp而不一开始就用hls吗</div>2018-06-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/fd/f3/77223a8c.jpg" width="30px"><span>清新灬小柠檬</span> 👍（0） 💬（1）<div>老师讲的内容很翔实，就是没有一开始看这个系列的那种趣味感了，少了类比，抽象，很多概念难以入门</div>2019-08-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/ca/e3/447aff89.jpg" width="30px"><span>记事本</span> 👍（0） 💬（1）<div>请问老师  视频流传输协议一般都有哪些   常用的又有哪些？谢谢</div>2019-02-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/23/25/fe87906a.jpg" width="30px"><span>anzaikk</span> 👍（25） 💬（0）<div>一开始看不懂，看了五六遍感觉很清晰，赞👍</div>2018-09-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a6/6b/12d87713.jpg" width="30px"><span>Jealone</span> 👍（25） 💬（1）<div>优化方式就是QUIC协议</div>2018-06-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/44/75/f4a202ac.jpg" width="30px"><span>fang</span> 👍（20） 💬（1）<div>RTMP握手的图是不是有点问题？服务器收到客户端c0发来的版本号才回s0，图上服务器啥也没收到就发s0，它怎么知道给谁发？</div>2018-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e9/29/629d9bb0.jpg" width="30px"><span>天王</span> 👍（13） 💬（0）<div>流媒体协议：1视频是一张张图片连续播放组成的图片，如果按照图片保存，占用空间很大，传输和存储都会占用大量空间，所以需要对图片进行处理，去空间化，去冗余化，编码处理2 直播，首先主播端把视频推流到服务器，服务器进行视频分发，客户端拉流，将视频拉取到本地用播放器进行播放。3 编码 将组成视频的图片进行编码，编码就是压缩过程。每张图片都是一帧，都是由像素组成的，每个像素由RGB组成，共24位，大小比如：1024×768×24约等于70M，视频和图片编码基于以下的特点，像素间的空间冗余，可以计算出来，视频序列播放间的时间冗余，视觉冗余，视觉不敏感，可以丢失一些数据，编码冗余，出现概率高的像素用的字节码少，低的用的字节码多，霍夫曼编码。4 视频如何压缩成图片的 视频序列将帧分为3种 I帧又叫关键帧，B帧又叫双向预测内插压缩帧，P帧单向预测内插编码帧，P帧要依赖前一个I帧，存的是和前一个I帧的差异，B帧依赖前后帧，压缩率更高，解码需要缓存之前的画面，还需要之后的画面，叠加得到最终画面。帧分成多个片，片分成多个宏块，宏块分成多个子块，传输，要转成二进制，网络提取层单元，NALU，网络提取层单元，传输的时候拆成一个个的单元，一个NALU由起始标识符，标识NALU的间隔，NALU header，主要包含NALU type，包括SPS，PPS或者帧类型，NALU payload，如果是SPS，则是图片尺寸，视频格式，如果是PPS，图像分片的信息，如图像类型，序列号，如果是帧，payload包含真正的图像数据。5如何将视频打包传输到对端 推流基于RTMP协议，是基于TCP协议，tcp建立以后要创建一个RTMP连接，建立这个连接是为了处理单独的事情，版本号和时间戳，如果客户端和服务端版本号不一致，直接断开连接。客户端发送C0，c1，c2，服务端发送s0，s1，s2，连接上以后，需要传输ckunk块大小和窗口大小，正式传输数据之前还需要创建流stream，通过这个流来推流。NALU需要放在message进行发送，message称为RTMP package包，message由message type，时间戳，stream id，payload和message body组成，message传输的时候拆成一个个的trunk，每个trunk有message id，接收到以后组装成message 6客户端先接收到解码参数，对NALU进行解码，交给播放器播放。</div>2019-06-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/12/ce/a8c8b5e8.jpg" width="30px"><span>Jason</span> 👍（10） 💬（0）<div>再度一遍，还是很牛，以rtmp为例很系统的讲述了流媒体服务的原理，其实rtsp、hls也是类似的原理，只是交互形式的不同。每个视频从业者都应该拿去读读。</div>2018-07-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/fc/d7/b102034a.jpg" width="30px"><span>do it</span> 👍（9） 💬（0）<div>思考题
2.在线看视频之前，大家都是把电影下载下来看的，电影这么大，你知道如何快速下载吗？
  采用p2p的方式，</div>2019-05-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4d/36/7c35e241.jpg" width="30px"><span>吃鳄鱼的猫</span> 👍（8） 💬（0）<div>现在好像都是http-flv, rtmp和hls延迟太高</div>2018-06-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ba/f4/0dda3069.jpg" width="30px"><span>小白</span> 👍（4） 💬（0）<div>前面看得很顺，这篇开始就开始懵了，主要是没有做过相互的业务，老师，有什么方法来理解谢谢吗</div>2018-07-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ca/61/b3f00e6f.jpg" width="30px"><span>byte</span> 👍（4） 💬（0）<div>希望补充在线视频网站的使用协议以及音频的协议。</div>2018-07-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8b/50/bd1136e3.jpg" width="30px"><span>新征程</span> 👍（3） 💬（1）<div>rtmp与dash hls. dash与mp4这些是啥关系</div>2018-10-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a2/a0/0aaa34e4.jpg" width="30px"><span>Malcolm</span> 👍（3） 💬（1）<div>感谢老师！讲的很透彻！</div>2018-09-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/53/99/3873b659.jpg" width="30px"><span>Hulk</span> 👍（3） 💬（0）<div>讲解清晰，大赞</div>2018-07-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/84/0d/4e289b94.jpg" width="30px"><span>三生</span> 👍（2） 💬（0）<div>老师，看视频的时候，有时候会突然音画不同步，是网络延迟还是硬件处理不正确</div>2021-11-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/1e/c5/4e640126.jpg" width="30px"><span>momo</span> 👍（2） 💬（1）<div>快速下载电影：加钱，提高网速。分段下载，我记得当年快播播放视频不是按顺序缓存的，而是从多个位置开始缓存，应该是分段缓存的，但是这个实际也是依赖网速的，也不能真的保证快速下载。</div>2020-08-24</li><br/><li><img src="" width="30px"><span>涤生</span> 👍（2） 💬（0）<div>这个在握手的时候定义了chunk块大小，窗口大小等，只有在握手的时候定义吗？如果在握手的时候网络好，块大小就比较大，后续如果网络差的时候，再按照这个块大小来发送，不就容易卡顿吗？</div>2020-02-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6a/92/413f4633.jpg" width="30px"><span>orangleliu</span> 👍（2） 💬（0）<div>1 tcp拥塞控制 优化的话 quic kcp这种基于udp的协议

2 p2p 网络 bt或者电驴这种</div>2018-07-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/d6/46/5eb5261b.jpg" width="30px"><span>Sudouble</span> 👍（1） 💬（0）<div>RTMP协议基于TCP，但在频繁切换基站的高铁环境下，需要经常进行三次握手，体验一般。</div>2022-03-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/dd/a0/a94a9c7d.jpg" width="30px"><span>～😄 ～</span> 👍（1） 💬（0）<div>图片的大小算法对吗？</div>2020-12-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/1e/c5/4e640126.jpg" width="30px"><span>momo</span> 👍（1） 💬（1）<div>直播嘛，我肯定要看最新的内容，超时丢包那就不要了，不需要TCP保证可靠性，应用层面保证就行了，当个高ping玩家也不太好</div>2020-08-24</li><br/>
</ul>