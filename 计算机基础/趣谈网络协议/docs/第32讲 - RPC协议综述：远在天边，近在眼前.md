前面我们讲了容器网络如何实现跨主机互通，以及微服务之间的相互调用。

![](https://static001.geekbang.org/resource/image/a0/0d/a0763d50fc4e8dcec37ae25a2f6cc60d.jpeg?wh=1582%2A1080)

网络是打通了，那服务之间的互相调用，该怎么实现呢？你可能说，咱不是学过Socket吗。服务之间分调用方和被调用方，我们就建立一个TCP或者UDP的连接，不就可以通信了？

![](https://static001.geekbang.org/resource/image/87/ea/87c8ae36ae1b42653565008fc47aceea.jpg?wh=1626%2A2172)

你仔细想一下，这事儿没这么简单。我们就拿最简单的场景，客户端调用一个加法函数，将两个整数加起来，返回它们的和。

如果放在本地调用，那是简单的不能再简单了，只要稍微学过一种编程语言，三下五除二就搞定了。但是一旦变成了远程调用，门槛一下子就上去了。

首先你要会Socket编程，至少先要把咱们这门网络协议课学一下，然后再看N本砖头厚的Socket程序设计的书，学会咱们学过的几种Socket程序设计的模型。这就使得本来大学毕业就能干的一项工作，变成了一件五年工作经验都不一定干好的工作，而且，搞定了Socket程序设计，才是万里长征的第一步。后面还有很多问题呢！

## 如何解决这五个问题？

### 问题一：如何规定远程调用的语法？

客户端如何告诉服务端，我是一个加法，而另一个是乘法。我是用字符串“add”传给你，还是传给你一个整数，比如1表示加法，2表示乘法？服务端该如何告诉客户端，我的这个加法，目前只能加整数，不能加小数，不能加字符串；而另一个加法“add1”，它能实现小数和整数的混合加法。那返回值是什么？正确的时候返回什么，错误的时候又返回什么？
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/17/01/38/5daf2cfb.jpg" width="30px"><span>吴军旗^_^</span> 👍（25） 💬（2）<div>越往后人的留言越少， 看来成为大牛的路上会越来越孤单</div>2019-07-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/82/3d/356fc3d6.jpg" width="30px"><span>忆水寒</span> 👍（5） 💬（1）<div>刘老师，我们目前的分布式系统采用以下方式。我们实现了一种中间件，每个进程（客户端）要与其他进程通信，就要到中间件注册（注册了自己进程的一个ID，任务名称，还有一个消息队列），然后将消息用google的protobuf封装进行传输（因为这种序列化的效率高）。在其他进程中接收到消息，会解析消息id，然后根据定义好的格式去取内容。这样也算RPC调用吧？</div>2018-07-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c1/60/f5439f04.jpg" width="30px"><span>Geek_dn82ci</span> 👍（4） 💬（2）<div>作为一名不会coding的从业者，想问刘老师几个基础问题，首先是文中提到的onc rpc框架，就是包含了stub（编解码）+传输（类库）+服务发现的一套东西？那么目前主流的rpc框架，比如dubbo也是实现了这些功能的集大成者？另外一个问题就是，thrift 和protobuf 我理解只是实现了rpc编解码环节的工作，也就是所说的序列化与反序列化，对么？</div>2018-07-31</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLvdWoCic6ItzibF8ia8vrUTRuyj6AT3tg5f4QicIK0jTIFheJ6274ZkibuRLFP1NXG3jibv5TiaSKNoJpLw/132" width="30px"><span>Geek_37984c</span> 👍（1） 💬（1）<div>老师GABAGE_ARGS 是写错了吗
GARBAGE_ARGS?</div>2019-08-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/85/0a/e564e572.jpg" width="30px"><span>N_H</span> 👍（1） 💬（1）<div>老师，您好，文章里面，“RPC程序是用户自己写的，会监听在一个随机端口上”。我们公司用的grpc服务，都会自己指明一个端口号</div>2019-08-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/49/3b/d214038f.jpg" width="30px"><span>java_zhao</span> 👍（1） 💬（1）<div>想问一下 我们平时的程序不都是指定端口的吗 为什么还会随机端口 用portmapper呢？</div>2019-07-10</li><br/><li><img src="" width="30px"><span>zKerry</span> 👍（0） 💬（1）<div>哦...原来是有示范性标准的啊</div>2019-09-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/d9/02/c4e2d7e8.jpg" width="30px"><span>Geek_Huahui</span> 👍（0） 💬（1）<div>刘老师，能讲解一下现在用的比较多的JSON-RPC吗</div>2019-06-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/10/d5/b527fdcb.jpg" width="30px"><span>迭代升级</span> 👍（0） 💬（3）<div>看了这个大端小端有一些疑惑，百度百科https:&#47;&#47;m.baidu.com&#47;sf_bk&#47;item&#47;%E5%A4%A7%E5%B0%8F%E7%AB%AF%E6%A8%A1%E5%BC%8F&#47;6750542?fr=aladdin&amp;ms=1&amp;rid=8203658230675846926 上说:大端模式，是指数据的高字节保存在内存的低地址中，而数据的低字节保存在内存的高地址中，这样的存储模式有点儿类似于把数据当作字符串顺序处理：地址由小向大增加，而数据从高位往低位放；这和我们的阅读习惯一致。
小端模式，是指数据的高字节保存在内存的高地址中，而数据的低字节保存在内存的低地址中，这种存储模式将地址的高低和数据位权有效地结合起来，高地址部分权值高，低地址部分权值低。
而文章上说:最低位放在最后一个位置，叫做小端
最低位放在第一个位置，叫做大端
感觉有点矛盾呀，是我的理解出错了吗？</div>2019-06-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c9/20/e4f1b17c.jpg" width="30px"><span>zj</span> 👍（0） 💬（1）<div>插问一下，http协议中有类似XID这样的标识别唯一请求id吗</div>2019-06-03</li><br/><li><img src="" width="30px"><span>起风了001</span> 👍（0） 💬（1）<div>我在使用以太坊的geth客户端的时候, 里面和geth通讯用的也叫rpc协议, 但是他其实是一个json格式的数据传输过程, 感觉和本文讲的rpc协议有很大区别.</div>2019-05-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/a8/1b/ced1d171.jpg" width="30px"><span>空档滑行</span> 👍（39） 💬（1）<div>1.rpc调用是在进行读写操作时，调用的操作系统的读写接口，nfs对接口做了实现，实现的代码里封装了rpc
2.需要调用双方有接口描述文件，有文件就需要双方要做信息交换，所以客户端和服务端不是完全透明的</div>2018-07-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/43/62/cd7d8b3b.jpg" width="30px"><span>叹息无门</span> 👍（21） 💬（0）<div>1.应用在读写文件时，会创建文件描述符，NFS Client会将文件描述符的操作代理成RPC请求。
2.XDR有严格的格式限制，两端必须完全匹配，无法支持灵活数据格式的传递。</div>2018-07-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7c/16/4d1e5cc1.jpg" width="30px"><span>mgxian</span> 👍（7） 💬（0）<div>1.nfs挂载的时候指定了文件系统类型 当应用对文件进行read write等操作时 会调用系统底层的vfs文件系统相关函数， nfs 实现了 vfs规定的 接口函数，调用vfs相关函数时 vfs其实会调用nfs的实现 实现访问远程文件系统

2.不支持多语言 </div>2018-07-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/a2/12/c429f550.jpg" width="30px"><span>何重阳</span> 👍（5） 💬（1）<div>能不能收我为徒😂</div>2018-08-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/5b/bc/1b6e3848.jpg" width="30px"><span>朽木自雕</span> 👍（4） 💬（0）<div>刘老师，我都认真的看了就是有的看不太懂，但是我真的好期待您的那个知识图谱，我觉得这个有助于对知识的加深理解，因为我认为这种图谱被我所喜欢的原因是它属于空间的结构，我自己这么认为的。</div>2018-07-30</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/pTD8nS0SsORKiaRD3wB0NK9Bpd0wFnPWtYLPfBRBhvZ68iaJErMlM2NNSeEibwQfY7GReILSIYZXfT9o8iaicibcyw3g/132" width="30px"><span>雷刚</span> 👍（3） 💬（0）<div>1. nfs 和 hdfs 一样都是分布式文件系统。当往往 nfs 目录中读写时，就会和这个目录对应的远程服务器建立 RPC 通道，我们看这是像往本地文件读写，实际是通过 RPC 往远程服务器读写。
2. 现代的 RPC 框架越来越像一个生态（如 Dubbo），不仅仅是一个 RPC 框架，更是一整套微服务的解决方案。如分布式配置（Nacos）、服务注册与发现（Nacos）、服务调用、负载均衡、限流与熔断、网关、分布式消息中间件等。</div>2020-04-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f6/32/358f9411.jpg" width="30px"><span>梦想启动的蜗牛</span> 👍（3） 💬（1）<div>最低位放在最后不是大端模式嘛？</div>2018-08-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/a5/98/a65ff31a.jpg" width="30px"><span>djfhchdh</span> 👍（2） 💬（0）<div>问题2：如果约定的协议内容发生变化，比如，增加参数、增加方法等，都需要重新生成stub程序，并重启rpc的客户端和服务端，比较麻烦</div>2020-08-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/72/85/c337e9a1.jpg" width="30px"><span>老兵</span> 👍（2） 💬（0）<div>1. mounted NFS会创建RPC的client端调用的映射，当NFS有写入时，就根据这个映射将结果发给client的stub。
2. 每次添加新的RPC方法，会需要重新部署（启动）client和server。</div>2020-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/12/ce/a8c8b5e8.jpg" width="30px"><span>Jason</span> 👍（2） 💬（0）<div>这篇我看懂了哈哈。工作中一涉及到rpc，我简直是thrift的铁杆粉丝，Google的protobuf也不错，但其中的原理的我并没深究。通过这篇，我学到了rpc的架构原理，赞。至于nfs，其实工作中也有用过，但仅仅是用而已，没有深究其中的奥妙，期待超哥下篇的解答。</div>2018-07-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/dc/b8/31c7e110.jpg" width="30px"><span>LVM_23</span> 👍（1） 💬（0）<div>终于来了些看得懂和日常已经使用的知识了，手动狗头</div>2020-11-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/78/ac/e5e6e7f3.jpg" width="30px"><span>古夜</span> 👍（1） 💬（1）<div>看完知道一点zookeeper这个注册中心为啥要注册了，懵懵懂懂的也算是知道一点了😂</div>2019-04-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/1a/e5/6899701e.jpg" width="30px"><span>favorlm</span> 👍（1） 💬（0）<div>rpc，现在用框架已经简单了很多</div>2018-07-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/fd/c9/9453237e.jpg" width="30px"><span>T</span> 👍（0） 💬（0）<div>ONC RPC 是早期的 RPC 框架，你觉得它有哪些问题呢？
---- 1.现在的rpc好像不需要端口注册了，约定俗成了吧，服务端告诉你我是哪个端口，你用就好了。
         2. 我好像没看到线程模型，就是socket accept只需要一个线程，然后处理的可以用其他线程这种模型，更不用说epoll这些了。

不知道我说的对不对，哈哈</div>2023-03-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/6f/70/db94799a.jpg" width="30px"><span>Wienbc</span> 👍（0） 💬（0）<div>原来这就是RPC，终于get了。</div>2023-02-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7c/59/dc9bbb21.jpg" width="30px"><span>Join</span> 👍（0） 💬（0）<div>RPC看得比较爽了，学习了</div>2021-10-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/b2/91/cf0de36e.jpg" width="30px"><span>saltedfish</span> 👍（0） 💬（0）<div>问题二：如果传递参数？应该是如何传递参数吧？</div>2021-04-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/3d/c5/f43fa619.jpg" width="30px"><span>🍀柠檬鱼也是鱼</span> 👍（0） 💬（0）<div>RPC runtime是指什么呢，网上没有查到诶</div>2020-11-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/a5/98/a65ff31a.jpg" width="30px"><span>djfhchdh</span> 👍（0） 💬（0）<div>问题1：NFS是一个文件系统，在mount成功之后，对于这个文件系统的读写，都由内核中NFS的读写操作接口实现，在这些接口中封装了对nfsd的rpc调用。</div>2020-08-25</li><br/>
</ul>