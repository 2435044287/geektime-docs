前面我们讲了，数据中心里面堆着一大片一大片的机器，用网络连接起来，机器数目一旦非常多，人们就发现，维护这么一大片机器还挺麻烦的，有好多不灵活的地方。

- 采购不灵活：如果客户需要一台电脑，那就需要自己采购、上架、插网线、安装操作系统，周期非常长。一旦采购了，一用就N年，不能退货，哪怕业务不做了，机器还在数据中心里留着。
- 运维不灵活：一旦需要扩容CPU、内存、硬盘，都需要去机房手动弄，非常麻烦。
- 规格不灵活：采购的机器往往动不动几百G的内存，而每个应用往往可能只需要4核8G，所以很多应用混合部署在上面，端口各种冲突，容易相互影响。
- 复用不灵活：一台机器，一旦一个用户不用了，给另外一个用户，那就需要重装操作系统。因为原来的操作系统可能遗留很多数据，非常麻烦。

## 从物理机到虚拟机

为了解决这些问题，人们发明了一种叫虚拟机的东西，并基于它产生了云计算技术。

其实在你的个人电脑上，就可以使用虚拟机。如果你对虚拟机没有什么概念，你可以下载一个桌面虚拟化的软件，自己动手尝试一下。它可以让你灵活地指定CPU的数目、内存的大小、硬盘的大小，可以有多个网卡，然后在一台笔记本电脑里面创建一台或者多台虚拟电脑。不用的时候，一点删除就没有了。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/1d/8e/0a546871.jpg" width="30px"><span>凡凡</span> 👍（87） 💬（1）<div>1.openstack网络模式有三种，flat，flat dhcp，vlan，实际上对应到kvm的两种模式，nat和桥接。openstack的vlan模式等=kvm的桥接模式+vlan。2.另外一种方式应该是虚拟机实例增加访问控制，可以是用iptables，看了阿里云的ecs实例iptables没有运行，猜测是阿里云自己实现的访问控制，支持ip和端口的访问权限配置。</div>2018-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/dd/65/3b4a2930.jpg" width="30px"><span>lpf32</span> 👍（14） 💬（6）<div>老师，有个问题想不太明白。NAT模式下，一个物理机A上的虚拟机a访问，另一个物理机B的虚拟机b。a访问b的时候，a怎么知道b是在B上呢。</div>2019-07-23</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLTPmSgD6QSgicqsbzibiau9xWSYgdsvYlnVWBg91ibHQBYg39MT4O3AV5CHlJlVUvw9Ks9TZEmRvicfTw/132" width="30px"><span>InfoQ_0ef441e6756e</span> 👍（7） 💬（1）<div>请问老师，第一张图虚机发出来的包进去协议栈，都做了什么，经过了几层转给了tap的。</div>2019-08-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/b1/6d/651e2f4d.jpg" width="30px"><span>小肥牛</span> 👍（7） 💬（1）<div>老师您好，有个地方没明白。您在虚拟机nat方式这部分提到“将虚拟机所在网络的网关的地址直接配置到 br0 上”，br0不是一个交换机或网桥吗？也可以配IP地址吗？</div>2018-07-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/80/ac/37afe559.jpg" width="30px"><span>小毅(Eric)</span> 👍（6） 💬（1）<div>对于Java开发来说这wn些网络知识确实很枯燥,而且因为没有实战经验 所以今天看了然后明天可能就忘记了</div>2019-08-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/d3/ad/7e8ab09b.jpg" width="30px"><span>平衡</span> 👍（1） 💬（1）<div>请问下，在外网能使用teamviewer类似的远程软件直接访问到物理机上的虚拟机吗？</div>2019-06-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/df/ca/7c223fce.jpg" width="30px"><span>天使也有爱</span> 👍（1） 💬（2）<div>刘老师，相应的比较配套这个教程的书籍推荐吗 我是个嵌入式软件工程师，对这些网络知识比较模糊，没有相应的知识体系</div>2019-03-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/61/bc/88a905a5.jpg" width="30px"><span>亮点</span> 👍（1） 💬（1）<div>刘老师您好，在讲解NAT方式的时候，没有提跨物理机的虚拟机之间的通信。记得老以前实验过openstack，它好像是把物理网卡配置成混合模式，把同一物理机的不同虚拟机的IP地址NAT成不同的外部IP地址（和物理网卡相同的网段），是这样吗？还有其他互通方式吗？</div>2018-07-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c7/40/66a203cd.jpg" width="30px"><span>忙碌了一天的周师傅</span> 👍（0） 💬（1）<div>想请问一下br0 是通过brctl命令创建，那是qemu-kvm创建的还是linux操作系统创建的呢？</div>2019-03-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/1d/39/7e32ba6a.jpg" width="30px"><span>01mcgrady01</span> 👍（0） 💬（1）<div>讲桥接时候，图里一台交换机连两台物理机，后来把虚拟机画到物理机外面方便理解的那张图，图里交换机连着br0是为了方便理解吧，实际还是连着物理网卡，但是物理网卡会把所有数据转到虚拟网桥上，然后转给虚拟机。</div>2018-08-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/44/75/f4a202ac.jpg" width="30px"><span>fang</span> 👍（0） 💬（1）<div>nat那张图中router和虚拟机虚拟网卡都是tap0，接到br0上。在同一台物理机上能创建同名虚拟网卡吗？</div>2018-07-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/45/be/494010aa.jpg" width="30px"><span>zcpromising</span> 👍（27） 💬（0）<div>讲的真好，作为学生，在学校接触的网络是真的单纯，学的网络知识也都非常片面，听了老师您的课，受益匪浅，视野都变发了</div>2018-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/1f/c2/1b412e75.jpg" width="30px"><span>终于找回了</span> 👍（25） 💬（0）<div>你的课程值一个亿，珍藏</div>2018-07-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/58/97/8e14e7d0.jpg" width="30px"><span>楚人</span> 👍（8） 💬（0）<div>谢谢老师，作为一个实施工程师要求知识面比较广，好多都是一知半解，好多以前的疑问在老师这里得到了解答，非常感谢!</div>2018-08-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/51/0d/fc1652fe.jpg" width="30px"><span>James</span> 👍（7） 💬（0）<div>不错，了解了nat不通的原理…</div>2018-08-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e9/29/629d9bb0.jpg" width="30px"><span>天王</span> 👍（4） 💬（1）<div>云中网络，1 核心使用是虚拟机技术，物理机，有几个缺点一采买成本比较高，有些小型应用不需要一台服务器的配置二部署比较麻烦，三 不用了，处理比较麻烦，物理机相当于自己盖房子，虚拟机相当于买公寓，可租可卖，比较灵活，一点就能创建，一点就能销毁，qemu-kvm，虚拟机技术使用的是软件模拟硬件的技术，虚拟化软件让虚拟机感觉使用独立的cpu，内存使用虚拟内存映射技术，硬盘是将硬盘分配一个N个G的文件，供虚拟机使用。2虚拟机上网 2.1 虚拟网卡原理 虚拟机会虚拟出一张网卡，使用的是TUN&#47;TAP技术，打开一个TUN&#47;TAP的char dev 字符设备文件，就会虚拟出一张TAP网卡，让虚拟机的应用认为可以把网络包往这个网卡上发，网络包发送过来，会转换成文件流，写到字符设备，内核中TUN&#47;TAP字符设备会收到这个写入的文件流，交给TUN&#47;TAP的虚拟网卡驱动，这个驱动将文件流转换成网络包，交给TCP&#47;IP协议栈，最终从虚拟的TAP网卡发出来，成为标准的网络包。2.2 虚拟网卡连接到云中 有几个关键点一是共享，共享是说，多个虚拟机共用一个物理机的网口，网络包从同一个网口发出去，二是隔离，分安全隔离和流量隔离，一个虚拟机用户不能访问另一个虚拟机用户的信息，一个下载片不影响另一个上网，三是互通，虚拟机之间怎么通讯，同一个虚拟机的不同用户，不同物理机的不同用户，四是灵活 虚拟机经常创建，删除，虚拟机比较灵活。2.3 共享和互通 共享有2种方式，一是桥接模式，有个虚拟交换机，虚拟网卡和物理机网卡连接到这个交换机上，将同一个物理机的不同虚拟机通过brtcl 创建bro，虚拟机连接到同一个网桥上，网络打平分的ip在同一个网段，就能实现互通了，不同的物理机也通过连接同一个网桥实现互通，但是有广播严重的缺点。二是NAT DHCP服务器随机分配ip，桥接模式不需要是因为虚拟机和物理机在同一个网段，统一由物理机的DHCP统一分配，虚拟机想访问外网，需要连接到网桥上，网桥连接到路由器，路由器NAT物理机的网络地址才能访问外网。2.4 网桥支持VLAN功能，通过vconfig命令建立不同的虚拟网卡，所有从这个虚拟网卡发出去的包，都带这个VLAN，不同的用户带的VLAN id一样，能实现通讯，即使同一个物理机，虚拟机的VLAN id不一样，也不能实现互通。</div>2019-07-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/6c/a8/1922a0f5.jpg" width="30px"><span>郑祖煌</span> 👍（3） 💬（0）<div>想问下网桥和交换机的区别。 为什么前面讲虚拟网卡和物理机网卡是连接虚拟交换机 后面又说道虚拟网卡和物理网卡连接网桥了？？？？</div>2020-05-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/c1/8f/06db18d6.jpg" width="30px"><span>钟文娟</span> 👍（2） 💬（0）<div>谢谢老师，对nat更深入了解了！上面同学的问题，NAT模式下，一个物理机A上的虚拟机a访问，另一个物理机B的虚拟机b。a访问b的时候，a怎么知道b是在B上呢？
我觉得正常情况下，两个不同的局域网，是无法访问的。但是如果两个物理机A和B都能连网的话，也是可以的，但是要实现内网穿透，两个局域网的机器相互访问的。比如市面的花生壳。原理大概就是，虚拟机a无法直接访问虚拟机b，但是可以建立一个访问的通道，在公网上再找一个物理机C，虚拟机a，b都访问C，通过来C进行桥接，把a发往b的包发到C，再由C转发b，即实现ab访问，还有一种方式，也是都访问C，C记录了nat-a，nat-b的公网地址，然后把地址相互告诉a,b，让他们自行访问。a可以访问到nat-b，在B的nat网关上再把包发给b。所以上面两种方式都可以实现。a访问b，前提是物理机A、B能连网</div>2021-03-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/39/f9/b2fe7b63.jpg" width="30px"><span>King-ZJ</span> 👍（2） 💬（1）<div>在一台物理机上创建虚拟机，充分利用物理机的资源，为了虚拟机之间的互通和隔离，可以创建虚拟交换机将各个虚拟机连接起来，而为了达到隔离，也可以创建带VLAN的网卡。从虚拟机到云计算，慢慢扩展出openstack，越来越有趣了。</div>2020-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/57/04/07eb8cbb.jpg" width="30px"><span>hhq</span> 👍（2） 💬（0）<div>出流量的隔离主要可以通过tc来控制</div>2018-08-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/22/69/09f7a8a2.jpg" width="30px"><span>Don Wang</span> 👍（1） 💬（1）<div>想问一下， 虚拟机中的网卡 和  虚拟网卡tap0 有什么关系？？？</div>2019-09-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/09/42/1f762b72.jpg" width="30px"><span>Hurt</span> 👍（1） 💬（0）<div>在一点一点的慢慢的啃 真的受益匪浅啊</div>2018-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d2/cf/0d32abbc.jpg" width="30px"><span>陶水元</span> 👍（1） 💬（0）<div>第一个问题，是neutron</div>2018-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/57/04/07eb8cbb.jpg" width="30px"><span>hhq</span> 👍（1） 💬（0）<div>问题2：采用SDN方式，来源解决方案主要是ovs，通过实现openflow协议来进行网络定义</div>2018-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7c/28/cb6d8768.jpg" width="30px"><span>Jobs</span> 👍（1） 💬（0）<div>刚好开始研究云计算的虚拟化技术，及时</div>2018-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg" width="30px"><span>ifelse</span> 👍（0） 💬（0）<div>学习打卡</div>2025-02-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/01/09/bdd17944.jpg" width="30px"><span>会馏馍</span> 👍（0） 💬（0）<div>那如果一个虚拟机里面有三个虚拟网口，分别对三个vlan，物理机的网络配置是不是也要配置三个vlan，分别桥接到对应的虚拟网口？</div>2022-08-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2a/f9/73/01eafd3c.jpg" width="30px"><span>singularity of space time</span> 👍（0） 💬（0）<div>在tun&#47;tap虚拟网卡那里没有太理解清楚，当qemu-kvm往&#47;dev&#47;tap设备文件写入数据之后，对应的驱动不应该直接把数据转成网络包，然后发送给tap虚拟网卡，然后再进入网络栈的嘛？为什么文中说会先进入网络栈再进入虚拟网卡？</div>2022-02-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/b2/24/0bd90ba1.jpg" width="30px"><span>大雨点</span> 👍（0） 💬（0）<div>【当然，网络包会到虚拟化软件这里。它会将网络包转换成为文件流，写入字符设备，就像写一个文件一样。内核中 TUN&#47;TAP 字符设备驱动会收到这个写入的文件流，交给 TUN&#47;TAP 的虚拟网卡驱动。这个驱动将文件流再次转成网络包，交给 TCP&#47;IP 协议栈，最终从虚拟 TAP 网卡发出来，成为标准的网络包。】---------------刘老师，我理解虚机发出的数据包不应该穿过主机的协议栈上层吧，主机仅仅起了类似二层交换机的二层转发功能，为什么这里你说虚机发出去的数据包会交给主机的TCP&#47;IP协议栈呢？请教下</div>2020-03-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f7/b1/982ea185.jpg" width="30px"><span>美妙的代码</span> 👍（0） 💬（0）<div>网桥，brctl .  bridge-utils
vlan, vconfig  .   vconfig</div>2020-03-12</li><br/>
</ul>