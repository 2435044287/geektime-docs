如果说虚拟机是买公寓，容器则相当于合租，有一定的隔离，但是隔离性没有那么好。云计算解决了基础资源层的弹性伸缩，却没有解决PaaS层应用随基础资源层弹性伸缩而带来的批量、快速部署问题。于是，容器应运而生。

容器就是Container，而Container的另一个意思是集装箱。其实**容器的思想就是要变成软件交付的集装箱**。集装箱的特点，一是打包，二是标准。

![](https://static001.geekbang.org/resource/image/79/d0/797ca1b09e4ayy527862e050dbd70cd0.jpg?wh=1947%2A384)

在没有集装箱的时代，假设要将货物从A运到B，中间要经过三个码头、换三次船。每次都要将货物卸下船来，弄得乱七八糟，然后还要再搬上船重新整齐摆好。因此在没有集装箱的时候，每次换船，船员们都要在岸上待几天才能干完活。

有了尺寸全部都一样的集装箱以后，可以把所有的货物都打包在一起，所以每次换船的时候，一个箱子整体搬过去就行了，小时级别就能完成，船员再也不用耗费很长时间了。这是集装箱的“打包”“标准”两大特点在生活中的应用。

![](https://static001.geekbang.org/resource/image/34/ae/3417576013de1c8b2078a312ec75b7ae.jpg?wh=1975%2A427)

那么容器如何对应用打包呢？

学习集装箱，首先要有个封闭的环境，将货物封装起来，让货物之间互不干扰，互相隔离，这样装货卸货才方便。

封闭的环境主要使用了两种技术，一种是**看起来是隔离的技术**，称为**namespace**，也即每个 namespace中的应用看到的是不同的 IP地址、用户空间、程号等。另一种是**用起来是隔离的技术**，称为**cgroup**，也即明明整台机器有很多的 CPU、内存，而一个应用只能用其中的一部分。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg" width="30px"><span>aoe</span> 👍（8） 💬（1）<div>学到了集装箱为解决什么问题而出现</div>2020-05-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7a/5e/9431165a.jpg" width="30px"><span>spdia</span> 👍（7） 💬（1）<div>这章比较难，主要是我对ip netns 不熟悉，还要多看几遍，再上虚拟机上操作几遍才行。</div>2018-09-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/c1/0e/2b987d54.jpg" width="30px"><span>蜉蝣</span> 👍（4） 💬（2）<div>老师，您这句“路由表中的默认路由是去物理外网的，去 192.168.1.0&#47;24 也即虚拟机私网，走下面的网卡，去 16.158.1.0&#47;24 也即物理外网，走上面的网卡。” 我不太懂哪个是上面网卡，哪个是下面网卡。</div>2019-08-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/94/a8/84c78013.jpg" width="30px"><span>王芳</span> 👍（3） 💬（1）<div>没操作，感觉看懂了--
等课程看完一遍，看是否实践操作 --</div>2019-04-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/0e/e9/98b6ea61.jpg" width="30px"><span>程序员大天地</span> 👍（2） 💬（1）<div>发现虚拟网络和容器这块看不懂，好多不理解</div>2019-08-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/e9/4e/22c73926.jpg" width="30px"><span>天然</span> 👍（2） 💬（1）<div>安全设备，例如waf,能拿到各容器的私有IP吗？还是只能拿到物理机ip?怎么判断一个攻击是针对哪个容器业务的？</div>2019-07-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/85/ed/905b052f.jpg" width="30px"><span>超超</span> 👍（0） 💬（1）<div>同一物理机上的多台虚拟机没有IP分配管理机制吗？是否存在容器之间IP冲突的问题？</div>2019-04-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/9b/a8/6a391c66.jpg" width="30px"><span>geraltlaush</span> 👍（0） 💬（1）<div>[root@master SOURCES]# brctl show
bridge name	bridge id		STP enabled	interfaces
br0		8000.000000000000	no
docker0		8000.02422c960d0f	no
virbr0		8000.525400ad2143	yes		virbr0-nic
[root@master SOURCES]# ovs-vsctl -- add-port br0 taprouter -- set Interface taprouter type=internal -- set Interface taprouter external-ids:iface-status=active -- set Interface taprouter external-ids:attached-mac=fa:16:3e:84:6e:cc
ovs-vsctl: no bridge named br0
老师，这是什么情况，我不是已经创建了网桥了吗</div>2019-02-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/f7/c4/bd7dd30a.jpg" width="30px"><span>小文</span> 👍（43） 💬（5）<div>我怎么感觉干运维的才能理解这么深</div>2018-08-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ab/2a/f3207127.jpg" width="30px"><span>贾鹏</span> 👍（25） 💬（0）<div>问题1，由于nat导致网络性能有损耗，而且物理机端口被占用，当容器多的时候对于物理机端口的占用更加明显
问题2，跨物理机间的容器通信，主要的思路是构造扁平化网络模型，主要有cnm和cni模型，支持很多网络插件实现集群内的容器只有唯一的IP。这些插件很多，比如flannel macvlan
另外求网络梳理图
不分享还不能留言吗？</div>2018-07-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7c/16/4d1e5cc1.jpg" width="30px"><span>mgxian</span> 👍（16） 💬（0）<div>突然想起来一个问题 nat网络 虽然能通信 但是别人看到的ip是你被nat之后的ip 例如服务注册这样的功能 会导致 服务注册获取的ip 是你nat之后的ip 而不是你真实的ip</div>2018-07-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e9/29/629d9bb0.jpg" width="30px"><span>天王</span> 👍（10） 💬（0）<div>1 容器的定义和特性 云计算虚拟机解决的是基础医院层的弹性伸缩，容器解决的是基础资源层弹性伸缩带来的批量，快速部署问题。容器，英文是container，有另外一个意思是集装箱，可以交付的集装箱两大特性，一是打包，二是标准。2 容器如何对应用打包 2.1 首先要有个封闭环境 把东西封装起来，能互不干扰，封闭技术主要用了2种，一种是namespace，命名空间技术，看起来隔离的技术，每个namespace下面看到的是不同的ip，用户空间，一种是cgroup技术，用起来隔离的技术，一台机器有很多cpu和内存，只能用其中的一部分，集装箱的标准就是镜像，将打包那一刻的状态保存下来， 将那一刻的状态保存成文件，无论何时，都能还原成那个状态。3 namespace 网络命名空间 linux进程可以配置自己的路由规则，多个进程可能会有冲突，为了防止冲突，可以把不同的进程放到不同的命名空间下，可以独立配置网络，可以用namespace技术实现类似路由器的功能，先构建一个独立的网络空间，创建一个网卡，连接到网桥br0上，给网卡配置一个ip地址，这个地址是虚拟机网络的网关地址，为了访问外网，还需要另一个网卡连接到网桥br-ex上，这个网卡配置的ip要和物理外网网络在一个网段，可以在namespace下建立路由表，基于namespace的路由器实现完毕。4 cgroup controll group，是linux提供的一种可以限制，隔离进程使用的资源机制。cgroup能控制的资源，包括多个子系统4.1 CPU子系统使用调度程序为进程控制CPU的访问，4.2 CPU set 如果是多核CPU，可以分配单独的CPU和内存 4.3 memory 子系统设置进程内存的限制以及产生内存资源报告 4.4 blkio子系统 设置限制每个块设备的输入输出限制 4.5net_cls 这个子系统使用等级标识符来标记网络数据包，可允许流量控制程序tc识别从具体cgroup生成的数据包 cgroup提供了虚拟文件系统，作为进程分组管理和各子系统设置的用户接口，使用cgroup，一般挂载在sys&#47;fs&#47;cgroup目录下， 配置TC，先根据cgroup配置路由规则，比如有2个用户，建立2个net_cls，有2个进程，进程id放在各自的net_cls文件，还有flowid，这样a进程发的包和b进程发的包，有各自的flowid，根据flowid做不同的处理。5 容器网络如何融入物理网络 5.1 docker run运行容器，容器内有张网卡，容器外有张网卡连到网桥上，通过网桥实现互相访问，容器下可以创建veth pair的网卡，一边发包，另一边就能收到 5.2 docker网络如何访问外网 访问外网使用NAT模式，NAT模式分为SNAT模式和DNAT模式。容器内访问外部，需要SNAT模式。多个容器共享一个物理ip，
发送包的时候，会将私ip转换成物理ip，并记录到conntrack表，将连接记下来，服务端返回，会根据conntrack表，将不同的连接，找到不同的私ip,对应到不同的容器
。如果容器内的应用，跟外部交互，用不同的端口，映射到容器的80端口，访问。Docker有2种方式，做端口的映射转换，一种是通过单独的进程docker-proxy的方式，
将进程10080转换成80端口，另一种是通过DNAT的方式，在-A PREROUTING阶段，添加一条规则。这样就实现容器和物理网络之间的互通</div>2019-07-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2a/10/83/0facd0eb.jpg" width="30px"><span>利威尔兵长</span> 👍（7） 💬（2）<div>说实话，有点失望，可能是我在刚开始的时候就对这个专栏抱有的期望过高了（看到了专栏摘要，加上专栏作者的简历），很多比喻有点刻意而为之的样子，比喻本是为了让读者能够比较容易get到某些复杂难懂的概念，但是本专栏为了“趣味性”而充斥着大量比喻，有点过犹不及了。</div>2021-10-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ab/2a/f3207127.jpg" width="30px"><span>贾鹏</span> 👍（5） 💬（0）<div>问题1，nat会导致性能损耗
问题2，主要是通过构造扁平网络，k8s主要是cni和cnm网络模型，支持很多网络插件来实现，比如flannel，macvlan等，从而让不同物理机上的容器有不同的IP</div>2018-07-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8b/64/d8bf2f6f.jpg" width="30px"><span>旻言</span> 👍（2） 💬（2）<div>刘超老师，我有个疑问，为什么docker可以用veth pair来管理网络，而虚拟机却采用tun&#47;tap设备来实现呢？是出于性能的原因吗？</div>2021-01-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a0/c5/9259d5ca.jpg" width="30px"><span>daydaygo</span> 👍（1） 💬（0）<div>namespace 是「看起来的隔离」, cgroup 是「用起来的隔离」, 非常生动形象!</div>2023-01-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/7a/03/c9b43b21.jpg" width="30px"><span>BewhY</span> 👍（1） 💬（0）<div>我看很多人都在评论看不懂啥的，你看不懂很正常啊，我一个工科专业+7年Java开发都难搞懂后面这些模块的知识，非工科的或者没有相关运维经验的就当了解了解就行了</div>2022-12-29</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/o60fbNDEphdEwdxID9CzuB0DB9VsthNMHLq3Em8yJiaiaeXAALqoCj4sibNymT6YVzT65VO82aElD6eHgBezUTiaIQ/132" width="30px"><span>Geek_db6a04</span> 👍（1） 💬（0）<div>老师好，想向您请教下 `
-A POSTROUTING -s 172.17.0.0&#47;16 ! -o docker0 -j MASQUERADE` 这条规则中的 `! -o docker0` 有什么作用呢？
我自己使用 ip 命令创建 bridge、namespace、veth 设备模拟后发现，就算不加 `! -o docker0` 这部分，而仅仅使用 `-A POSTROUTING -s 172.17.0.0&#47;16 -j MASQUERADE` 来配置 SNAT，新 namespace 中的进程也可以访问外网</div>2022-05-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/93/cc/dfe92ee1.jpg" width="30px"><span>宋桓公</span> 👍（1） 💬（1）<div>超哥，和订阅专栏的大神们，我在工作中遇到一个奇怪的问题：
我在一个服务器上部署了一个docker  监听了一个端口，通过桥接的方式，把端口映射到宿主机的80端口。
然后在我办公室的机器去telnet这个端口，不通。
但是如果docker以host的模式启动，就能访问通。十分不解，求解惑。
</div>2020-12-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/b6/11/e8506a04.jpg" width="30px"><span>小宇宙</span> 👍（1） 💬（0）<div>部署应用要考虑服务发现问题，就是外部的client怎么找到这个应用并访问，还有就是一般应用都是集群化部署，还涉及到负载的均衡问题，通过NAT的方式，要暴露宿主机的ip和端口，进行端口映射和ip地址转换，一方面消耗很多宝贵的主机的网络资源，另一方面服务注册和服务发现也会变复杂。</div>2018-08-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7c/16/4d1e5cc1.jpg" width="30px"><span>mgxian</span> 👍（1） 💬（0）<div>1.使用nat部署服务 可能会有网络性能问题
2.容器跨节点通信 可以使用 bgp 主机路由 vxlan 等方式</div>2018-07-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg" width="30px"><span>ifelse</span> 👍（0） 💬（0）<div>学习打卡</div>2025-02-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/2d/dc/834d8ae8.jpg" width="30px"><span>ming.z</span> 👍（0） 💬（0）<div>容器bridge网络模式，设置net_cls.classid，tc在容器内可以匹配上，但在宿主机环境匹配不上，请问是什么原因？</div>2024-09-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/2c/99/2a5b782f.jpg" width="30px"><span>风云一度</span> 👍（0） 💬（0）<div>容器是在云计算虚拟机上面搭建的吗</div>2024-07-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/c5/c9/91251758.jpg" width="30px"><span>混淡君</span> 👍（0） 💬（0）<div>为什么有时候使用ovs-vsctl add bridge会导致ssh断开链接呀</div>2023-11-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8c/f8/d378c121.jpg" width="30px"><span>无争就是yk</span> 👍（0） 💬（1）<div>能不能把相应实验的环境说明下，这么多操作命令没有相应的环境搭建，除非是本身就比较了解这块的人才能看得懂吧。</div>2022-05-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2c/41/8a/3cec4cbf.jpg" width="30px"><span>昊</span> 👍（0） 💬（2）<div>看的是一头雾水</div>2022-05-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/99/c3/e4f408d4.jpg" width="30px"><span>陌兮</span> 👍（0） 💬（0）<div>果真知识点都是共通的，还好之前看了点容器的知识，不然只能发呆了</div>2022-04-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/20/ec/81/4863e9ed.jpg" width="30px"><span>文刂文化十</span> 👍（0） 💬（0）<div>但是，当一台 Linux 上跑多个进程的时候，如果我们觉得使用不同的路由策略，这些进程可能会冲突，


这个冲突是什么，能举个例子吗？</div>2021-03-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/3a/6d/8b417c84.jpg" width="30px"><span>Wheat Liu</span> 👍（0） 💬（0）<div>cgroup要用进程id，那进程id每次也不固定，怎么搞啊，难道要每重启一次就创建一个相同进程id的文件吗</div>2021-02-24</li><br/>
</ul>