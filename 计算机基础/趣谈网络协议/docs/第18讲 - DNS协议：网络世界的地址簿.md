前面我们讲了平时常见的看新闻、支付、直播、下载等场景，现在网站的数目非常多，常用的网站就有二三十个，如果全部用IP地址进行访问，恐怕很难记住。于是，就需要一个地址簿，根据名称，就可以查看具体的地址。

例如，我要去西湖边的“外婆家”，这就是名称，然后通过地址簿，查看到底是哪条路多少号。

## DNS服务器

在网络世界，也是这样的。你肯定记得住网站的名称，但是很难记住网站的IP地址，因而也需要一个地址簿，就是**DNS服务器**。

由此可见，DNS在日常生活中多么重要。每个人上网，都需要访问它，但是同时，这对它来讲也是非常大的挑战。一旦它出了故障，整个互联网都将瘫痪。另外，上网的人分布在全世界各地，如果大家都去同一个地方访问某一台服务器，时延将会非常大。因而，**DNS服务器，一定要设置成高可用、高并发和分布式的**。

于是，就有了这样**树状的层次结构**。

![](https://static001.geekbang.org/resource/image/89/4d/890ff98fde625c6a60fb71yy22d8184d.jpg?wh=1512%2A984)- 根DNS服务器 ：返回顶级域DNS服务器的IP地址

- 顶级域DNS服务器：返回权威DNS服务器的IP地址
- 权威DNS服务器 ：返回相应主机的IP地址

## DNS解析流程

为了提高DNS的解析性能，很多网络都会就近部署DNS缓存服务器。于是，就有了以下的DNS解析流程。

1. 电脑客户端会发出一个DNS请求，问www.163.com的IP是啥啊，并发给本地域名服务器 (本地DNS)。那本地域名服务器 (本地DNS) 是什么呢？如果是通过DHCP配置，本地DNS由你的网络服务商（ISP），如电信、移动等自动分配，它通常就在你网络服务商的某个机房。
2. 本地DNS收到来自客户端的请求。你可以想象这台服务器上缓存了一张域名与之对应IP地址的大表格。如果能找到 www.163.com，它就直接返回IP地址。如果没有，本地DNS会去问它的根域名服务器：“老大，能告诉我www.163.com的IP地址吗？”根域名服务器是最高层次的，全球共有13套。它不直接用于域名解析，但能指明一条道路。
3. 根DNS收到来自本地DNS的请求，发现后缀是 .com，说：“哦，www.163.com啊，这个域名是由.com区域管理，我给你它的顶级域名服务器的地址，你去问问它吧。”
4. 本地DNS转向问顶级域名服务器：“老二，你能告诉我www.163.com的IP地址吗？”顶级域名服务器就是大名鼎鼎的比如 .com、.net、 .org这些一级域名，它负责管理二级域名，比如 163.com，所以它能提供一条更清晰的方向。
5. 顶级域名服务器说：“我给你负责 www.163.com 区域的权威DNS服务器的地址，你去问它应该能问到。”
6. 本地DNS转向问权威DNS服务器：“您好，www.163.com 对应的IP是啥呀？”163.com的权威DNS服务器，它是域名解析结果的原出处。为啥叫权威呢？就是我的域名我做主。
7. 权威DNS服务器查询后将对应的IP地址X.X.X.X告诉本地DNS。
8. 本地DNS再将IP地址返回客户端，客户端和目标建立连接。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/6a/a8/ee414a25.jpg" width="30px"><span>公告-SRE运维实践</span> 👍（113） 💬（6）<div>分地址和运营商主要是为了返回最优的ip，也就是离用户最近的ip，提高用户访问的速度，分运营商也是返回最快的一条路径。gslb失灵一般是因为一个ns请求gslb的时候，看不到用户真实的ip，从而不一定是最优的，而且这个返回的结果可能给一个用户或者一万个用户，可以通过流量监测来缓解。</div>2018-08-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f2/46/09c457eb.jpg" width="30px"><span>Garwen</span> 👍（36） 💬（3）<div>刘超老师，根域名服务器的访问不还是无法逃离高并发访问的场景吗，虽说本地的DNS已经可以解决80%请求的地址解析，但还是会有极其庞大数量的访问需要去找根域名服务器的吧，这里的根域名服务器的高并发场景不比12306小吧，是如何解决的呢？</div>2019-05-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/78/ac/e5e6e7f3.jpg" width="30px"><span>古夜</span> 👍（14） 💬（1）<div>这一课看懂了，还联想到了ping百度域名有时候返回ip不一样的问题，感谢</div>2019-04-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/67/61/ea54229a.jpg" width="30px"><span>jim</span> 👍（14） 💬（3）<div>浏览器，路由器也有缓存吧？</div>2018-11-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/88/18/a88cdaf5.jpg" width="30px"><span>alexgzh</span> 👍（13） 💬（1）<div>以前只知道DNS是方便記憶。今天學到了DNS其實是解耦應用和被訪問應用的IP地址，還有局部負載均衡和全局負載均衡的功能, 學到了！！</div>2019-07-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/e2/58/8c8897c8.jpg" width="30px"><span>杨春鹏</span> 👍（11） 💬（3）<div>当访问网站的时候，是先去访问host文件还是，本地DNS缓存？</div>2018-09-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/51/d2/dddffa12.jpg" width="30px"><span>胸怀宇宙瓜皮李</span> 👍（8） 💬（1）<div>确实不是很理解为什么需要两次的全局负载均衡？为什么不在第一次的负载均衡中，直接获取DNS服务器所在地址和DNS服务提供商？</div>2019-07-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/42/52/19553613.jpg" width="30px"><span>刘培培</span> 👍（6） 💬（1）<div>1. 不同地区和运营商之间延迟不同，所以优先选择同运营商、同地区服务

2. GLSB 挂掉了，客户端地址、运营商变更了，缓存未及时更新。</div>2019-08-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7f/0c/2ebdc487.jpg" width="30px"><span>魔兽rpg足球</span> 👍（6） 💬（7）<div>引用原文中的话：
“在 yourcompany.com 的 DNS 服务器中，一般是通过配置 CNAME 的方式，给
object.yourcompany.com 起一个别名，例如 object.vip.yourcomany.com，然后告诉本地 DNS
服务器，让它请求 GSLB 解析这个域名，GSLB 就可以在解析这个域名的过程中，通过自己的策略实
现负载均衡”
这里有一句没明白，告诉本地服务器，让object.vip.yourcomany.com域名去GSLB解析，这个应该如何告诉呢</div>2019-06-17</li><br/><li><img src="" width="30px"><span>起风了001</span> 👍（4） 💬（2）<div>好像设置GSLB是通过添加NS记录实现的, 不是CNAME呀.</div>2019-05-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ec/2a/b11d5ad8.jpg" width="30px"><span>曾经瘦过</span> 👍（4） 💬（3）<div>报名太晚了 不知道是否还可以获得独家网络知识图谱和学习奖励券</div>2018-10-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d6/53/f5b4d2f0.jpg" width="30px"><span>或燃</span> 👍（2） 💬（2）<div>“在 yourcompany.com 的 DNS 服务器中，一般是通过配置 CNAME 的方式，给 object.yourcompany.com 起一个别”    请问一下老师这里说的DNS服务器是指域名解析里的配置吗？像阿里云买的域名里的：云解析DNS&#47;域名解析&#47;解析设置，记录类型选择CNAME，记录值是：object.vip.yourcomany.com，另外这个域名是第一层 GSLB的域名吗？</div>2019-08-07</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/wYPdGBibR1FJWWMzFzYBy4tNTd22rMgtlYTgR7wuicFLQjiaozuRWM2VSMFxPYjVdkLJLGvMav2icH3icgz07hmDsDw/132" width="30px"><span>dayspring</span> 👍（2） 💬（2）<div>老师，有一个问题请教一下本地dns，是怎么知道本地dns server的ip地址的？同理本地dns server是怎么知道根dns server的ip地址的？他们之间的访问有负载均衡吗？</div>2019-05-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/5f/e8/94365887.jpg" width="30px"><span>ieo</span> 👍（2） 💬（1）<div>刘老师，dns服务器请求权威dns后，怎么请求到全局负载均衡服务器的，这块没怎么看懂，是权威dns告诉本地dns的难道是全局负载均衡的ip吗？</div>2019-05-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d3/b4/bb883fc8.jpg" width="30px"><span>pana@</span> 👍（2） 💬（1）<div>本地DNS服务器在请求object.vip.yourcompany.com这个域名时，是不是也要走一遍dns解析流程才能到gslb?gslb还能解析域名？应该只能根据域名通过某些策略返回IP吧?</div>2019-01-17</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/6LaITPQ4Lk5fZn8ib1tfsPW8vI9icTuSwAddiajVfibPDiaDvMU2br6ZT7K0LWCKibSQuicT7sIEVmY4K7ibXY0T7UQEiag/132" width="30px"><span>尔东橙</span> 👍（1） 💬（2）<div>为什么本地dns不直接访问顶级dns</div>2019-08-12</li><br/><li><img src="" width="30px"><span>陈耀</span> 👍（1） 💬（1）<div>关于客户端的dns的查询有部分是错误的，浏览器到本地dns（甚至运营商dns）使用的是递归查询，而向根域服务器、顶级域服务器、权威域服务器 使用的是迭代查询。</div>2019-04-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/1f/3f/c9f7e73c.jpg" width="30px"><span>风中拾遗</span> 👍（1） 💬（1）<div>老师，这个域名绑定的ip应该是公网的ip吧？不然会发生冲突，但如果是公网的ip，那个数就那么多，总有一天会不够用的。</div>2019-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/75/00/618b20da.jpg" width="30px"><span>徐海浪</span> 👍（0） 💬（1）<div>1 首先是就近访问，其次是避免跨运营商。
2 DNS解析有时效问题。</div>2020-06-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/4a/34/1faac99b.jpg" width="30px"><span>夕林语</span> 👍（0） 💬（1）<div>思考题：
1.分地址和运营商是为了让用户有更快的访问速度和更好的体验
2.浏览器的缓存或者本地dns的缓存</div>2020-06-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/be/05/55b72986.jpg" width="30px"><span>shaukin</span> 👍（0） 💬（1）<div>从权威域名服务器返回给本地DNS服务器不是返回IP地址了吗，那怎么还要去返回GLSB实现负载均衡呢</div>2020-06-03</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIjUDIRQ0gRiciax3Wo78c5rVjuWDiaw4ibcCiby8xiaMXJh5ibjU5242vfCGOK4ehibe1IKyxex2A4IX4XSA/132" width="30px"><span>追风者</span> 👍（0） 💬（1）<div>当一个权限域名服务器还不能直接给出最后的查询结果时，就会告诉发出查询的DNS客户，下一步应当找哪一个权限域名服务器。
老师，应该如何理解这句话？一次DNS解析中，本地服务器会向权限域名服务器发送多次请求？我在书上看到说查询www.abc.xyz.com本地DNS会发送4次查询请求。困扰已久！</div>2019-08-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d0/f1/432e0476.jpg" width="30px"><span>X</span> 👍（0） 💬（2）<div>xxxx could not be resolved (110: Operation timed out)
我在一个项目中要使用http协议去请求其他N个域名，每次请求都会有DNS解析这一步。刚开始时，DNS解析正常，没有超时，但是过一会，DNS解析超时越来越多。单独拿出服务中解析超时的域名，使用linux命令dig，全部正常，ping，也全部正常。我的nginx.conf配置中，resolver_timeout 60s（默认30s）,resolver 8.8.8.8。请问是哪里的问题？我需要怎么去排查？</div>2019-03-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/6d/1c/10d5c280.jpg" width="30px"><span>哈哈</span> 👍（0） 💬（1）<div>有个问题想问下，如果权威域名服务器没有分多个运营商的话，从权威域名服务器dns解析到gslb过程的不是会很慢么？ 还是说从根开始每个都是gslb这种模式，或者还是权威域名服务器都部署在主干网所以很快</div>2019-02-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/f9/90/f90903e5.jpg" width="30px"><span>菜菜</span> 👍（0） 💬（2）<div>老师，通过负载均衡，客户端拿到假如说6和ip，通过轮询的话，如果是tcp连接的话，每次都要新建一个tcp连接吗？这样会不会又增加负担……</div>2019-02-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e0/99/5d603697.jpg" width="30px"><span>MJ</span> 👍（0） 💬（1）<div>本地DNS服务器访问GLSB的时候，如何做到把原域名改为别名来访问呢？</div>2018-11-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/6f/63/abb7bfe3.jpg" width="30px"><span>扬～</span> 👍（0） 💬（1）<div>疑问，为什么要把6个proxy的IP都发给客户端呢?这样不会侵入代码吗，这不应该是服务端的责任吗，不需要对客户端透明吗?</div>2018-11-05</li><br/><li><img src="" width="30px"><span>Tom</span> 👍（0） 💬（1）<div>本地DNS不是本地局域网的吧？本机io配置中的DNS就是本地局域网吧？</div>2018-10-19</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJJJdibLfaPjOqvgdRSn11JhwdqaI2KiaUdkeA9cwQ5btpnFX00V0rpFXlksKfBtaArprs7DN2ybFug/132" width="30px"><span>逍遥夏末</span> 👍（0） 💬（1）<div>刘老师，dns服务器是由运营商维护吗，也就是服务器所有者维护，GSLB是由我们需要访问的网址服务器维护吗，比如访问163.com，是不是网易给运营商一个规则，说来访问我的服务器都给我指定到我的GSLB服务器上来，我自己做全局负载均衡，我来返回用户最优访问的ip。请刘老师指正。</div>2018-09-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/45/be/494010aa.jpg" width="30px"><span>zcpromising</span> 👍（0） 💬（1）<div>老师，dns解析为啥没讲迭代解析呢</div>2018-07-03</li><br/>
</ul>