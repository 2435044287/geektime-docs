无论是在宿舍，还是在办公室，或者运维一个数据中心，我们常常会遇到网络不通的问题。那台机器明明就在那里，你甚至都可以通过机器的终端连上去看。它看着好好的，可是就是连不上去，究竟是哪里出了问题呢？

## ICMP协议的格式

一般情况下，你会想到ping一下。那你知道ping是如何工作的吗？

ping是基于ICMP协议工作的。**ICMP**全称**Internet Control Message Protocol**，就是**互联网控制报文协议**。这里面的关键词是“控制”，那具体是怎么控制的呢？

网络包在异常复杂的网络环境中传输时，常常会遇到各种各样的问题。当遇到问题的时候，总不能“死个不明不白”，要传出消息来，报告情况，这样才可以调整传输策略。这就相当于我们经常看到的电视剧里，古代行军的时候，为将为帅者需要通过侦察兵、哨探或传令兵等人肉的方式来掌握情况，控制整个战局。

ICMP报文是封装在IP包里面的。因为传输指令的时候，肯定需要源地址和目标地址。它本身非常简单。因为作为侦查兵，要轻装上阵，不能携带大量的包袱。

![](https://static001.geekbang.org/resource/image/20/e2/201589bb205c5b00ad42e0081aa46fe2.jpg?wh=3043%2A1243)

ICMP报文有很多的类型，不同的类型有不同的代码。**最常用的类型是主动请求为8，主动请求的应答为0**。

## 查询报文类型

我们经常在电视剧里听到这样的话：主帅说，来人哪！前方战事如何，快去派人打探，一有情况，立即通报！
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/ec/1c/d323b066.jpg" width="30px"><span>knull</span> 👍（166） 💬（7）<div>许多人问：tracerouter发udp，为啥出错回icmp？
正常情况下，协议栈能正常走到udp，当然正常返回udp。
但是，你主机不可达，是ip层的（还没到udp）。ip层，当然只知道回icmp。报文分片错误也是同理。
</div>2018-09-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d6/42/bafec9b7.jpg" width="30px"><span>盖</span> 👍（119） 💬（6）<div>好像不发ICMP差错报文的一种情况就是ICMP 的差错报文出错，其它还有目的地址为广播时或者源地址不唯一时也不发差错报文。

前面评论问udp为什么返回ICMP报文的，ICMP一般认为属于网络层的，和IP同一层，是管理和控制IP的一种协议，而UDP和TCP是传输层，所以UDP出错可以返回ICMP差错报文</div>2018-06-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/52/0e/abb7bfe3.jpg" width="30px"><span>手撕油条</span> 👍（61） 💬（1）<div>越听越想听，一周三更听不爽</div>2018-06-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/04/8d/005c2ff3.jpg" width="30px"><span>weineel</span> 👍（21） 💬（2）<div>老师您好，以我的经验使用tcp&#47;udp协议可以用scoket api编程，但是文中提到ping程序使用了ip协议，那ping程序的实现是不是用到了其他网络编程接口？

换句话说，每一层的协议都有相应的api可以调用吗？有的话又是什么呢？

但又感觉我们写的程序一般是应用层用socket就行了…</div>2018-06-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/11/4b/fa64f061.jpg" width="30px"><span>xfan</span> 👍（19） 💬（2）<div>如果网络不可达，是谁回复的差错报文呢，是网关吗</div>2019-04-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/06/7e/735968e2.jpg" width="30px"><span>西门吹牛</span> 👍（15） 💬（2）<div>ICMP是第三层网络层的协议
计算几网络教材是这么描述的：为了更有效转发ip数据报和提高转发的机会，ICMP允许主机或者路由器报告差错情况和提供有关异常情况的报告，用于传输出错报告控制信息；
简单的道理放到教材中就晦涩难懂了。
其实可以理解为，ICMP报文可以在主机和路由器之间传输，但传输的不是用户数据，而是网络通不通、主机是否可达、路由是否可用等网络本身的消息，所以可以比作侦察兵，用来侦察在ip层报文传输过程中遇到的异常情况，并能汇报信息，有了异常信息，就可以控制异常，达到更有效的传输效率；控制这种报文，用的是差错报文类型；
另外一种是查询报文类行，可以理解为用来测试俩个主机间的连接是否有效，报文多久能到达；
总之，通过ICMP协议，可以对ip层报文的传输做到把控</div>2020-06-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/fb/51/870a6fcb.jpg" width="30px"><span>Trust me ҉҉҉҉҉҉҉❀</span> 👍（12） 💬（1）<div>tracerouter发送的包是什么程序给的响应？  是目标主机的traceroute程序？还是ICMP</div>2018-06-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f8/ba/d28174a9.jpg" width="30px"><span>Geek_zbvt62</span> 👍（9） 💬（1）<div>差错包也出问题是不是就拉到了，看上层是不是定时重发的协议了？
</div>2018-06-01</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erWTj858HXwXsTOiaxEaYJIRoJMibK14lhspfATACO5G6VrjdBianAnT6hZjqBweo3CPk4O1XlUQ5I8g/132" width="30px"><span>anthann</span> 👍（8） 💬（1）<div>Traceroute发送的是udp包，为什么也能收到icmp响应呢？</div>2018-06-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/64/86/f5a9403a.jpg" width="30px"><span>yang</span> 👍（7） 💬（4）<div>[小白评论] 看评论说 icmp也属于网络层啊？ 我还以为icmp属于应用层呢</div>2019-08-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/47/99/aefe1b12.jpg" width="30px"><span>n0thing</span> 👍（6） 💬（1）<div>买了很久，最近才静下心来学习，有个疑问:在客户端ping直观上是一个应用程序，理解应该位于应用层，使用icmp协议属于网络层，那ping的过程经过传输层时干了些啥？还是说ping的过程就没传输层啥事？</div>2019-04-25</li><br/><li><img src="" width="30px"><span>啊路</span> 👍（6） 💬（1）<div>ICMP报文图片最后一个字段是相应还是响应，相应怎么理解</div>2018-06-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/79/1d/375d28c0.jpg" width="30px"><span>正直D令狐勇</span> 👍（5） 💬（1）<div>icmp的差错报文，最终会反馈在socket的api返回的错误代码中吧</div>2018-10-03</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erWTj858HXwXsTOiaxEaYJIRoJMibK14lhspfATACO5G6VrjdBianAnT6hZjqBweo3CPk4O1XlUQ5I8g/132" width="30px"><span>anthann</span> 👍（5） 💬（1）<div>ptraceroute用了udp包，为什么也能收到返回的icmp包呢？</div>2018-06-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d8/71/d6f79534.jpg" width="30px"><span>一个工匠</span> 👍（4） 💬（3）<div>ping属于应用层协议，封包后直接传递到ICMP网络层，在这个过程中，是没有传输层事情的。那么端口号是如何确定的呢？没有端口号这个数据包能够发出去吗？</div>2019-08-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/3f/c5/58787480.jpg" width="30px"><span>大唐江山</span> 👍（3） 💬（1）<div>穿插一个话题:我在虚拟机上配置桥接，系统是ubuntu，同一网段设置好了，完成后ubuntu能上网，但是ping宿主机不能通ping通。360也卸载了还是不成功。望大佬在后面稍微点拨一下小生，不胜感激，若是之后再添加这么一个内容那就再好不过了。</div>2018-06-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/78/51/4790e13e.jpg" width="30px"><span>Smallfly</span> 👍（2） 💬（1）<div>老师你好，从 IP 地址到获得 Mac 地址是通过 APR 协议广播，那知道 Mac 地址后发送数据包到目的地也是通过广播的形式发出去，Mac 匹配的设备给予回应吗？如果这样那岂不是只要发数据设备都要广播，设备很多不会造成干扰吗？</div>2018-06-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/86/e3/28d1330a.jpg" width="30px"><span>fsj</span> 👍（2） 💬（1）<div>抢个沙发</div>2018-06-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/6a/cc/4b599797.jpg" width="30px"><span>侯清风</span> 👍（1） 💬（1）<div>看的很过瘾</div>2019-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/11/3e/925aa996.jpg" width="30px"><span>HelloBug</span> 👍（1） 💬（1）<div>老师，你好~如果是ping同一个子网内的一台主机，是哪个主机应答不可达呢？如果是跨网段呢？最后一跳的路由器来应答网络不可达吗？那其他的不可达呢？</div>2018-12-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/3a/da/4c4cc7f8.jpg" width="30px"><span>9527</span> 👍（1） 💬（1）<div>刘老师，想问一下，这些协议的格式需要掌握吗</div>2018-06-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/66/92/f1f83d8b.jpg" width="30px"><span>Siri</span> 👍（0） 💬（1）<div>有一个疑问，既然到达目标地址后是先检查mac地址再检查ip地址
但是mac地址不已经是唯一的了么，mac地址一致的情况下为什么还要检查IP地址
</div>2020-06-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/51/9f/1840385e.jpg" width="30px"><span>胡永</span> 👍（0） 💬（1）<div>老师的比喻挺好的，如果配合上终端的操作图示就更好了</div>2019-09-04</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/RVgoywqdiaoTDV66lVJwED3jtAf1OuAal6K1QeWLoeqNbbQPicRz6XhJU1vShUJ50eHLGvXc22ZVX9hnG5ZNKARw/132" width="30px"><span>叶叶</span> 👍（0） 💬（1）<div>比较适合对计算机网络有所了解的人食用。</div>2019-07-15</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/6LaITPQ4Lk5fZn8ib1tfsPW8vI9icTuSwAddiajVfibPDiaDvMU2br6ZT7K0LWCKibSQuicT7sIEVmY4K7ibXY0T7UQEiag/132" width="30px"><span>尔东橙</span> 👍（0） 💬（1）<div>老师，ping那个图右半部分不是从下往上？按理不应该先经过MAC层再到IP层再ICMP响应回来？</div>2019-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/e9/4e/22c73926.jpg" width="30px"><span>天然</span> 👍（0） 💬（1）<div>老师讲的蛮好，以前觉得网络太枯燥，听您的越听越想听</div>2019-07-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/61/c1/93031a2a.jpg" width="30px"><span>Aaaaaaaaaaayou</span> 👍（0） 💬（1）<div>Traceroute 的参数指向某个目的 IP 地址，它会发送一个 UDP 的数据包。  这里为什么要发一个udp的包？不应该是icmp的包吗？</div>2019-05-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/db/60/17c224f6.jpg" width="30px"><span>Leedom</span> 👍（0） 💬（1）<div>觉得老师讲的挺好的，在校上这门课就一直期末背书，背知识点，而现在貌似更清晰的来理解，希望秋招也能拿网易offer，offer++</div>2019-05-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/74/68/3725546b.jpg" width="30px"><span>Carlos</span> 👍（0） 💬（1）<div>老师，这篇文章读了好几遍，总算基本搞清楚ping和traceroute的原理了，但是我还是不知道这俩命令的具体应用场景是什么？我现在理解ping就是看目标主机是否可达，并且了解下延时是多少。traceroute是看下从客户端到达目标主机经过了哪些路由，以及所用的时间。还是没搞清楚什么情况下要使用它。</div>2019-05-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/a0/57/3a729755.jpg" width="30px"><span>灯盖</span> 👍（0） 💬（1）<div>一半一半，一半懂一半不懂，还得再来一遍</div>2019-04-12</li><br/>
</ul>