上一节我们讲了Flannel如何解决容器跨主机互通的问题，这个解决方式其实和虚拟机的网络互通模式是差不多的，都是通过隧道。但是Flannel有一个非常好的模式，就是给不同的物理机设置不同网段，这一点和虚拟机的Overlay的模式完全不一样。

在虚拟机的场景下，整个网段在所有的物理机之间都是可以“飘来飘去”的。网段不同，就给了我们做路由策略的可能。

## Calico网络模型的设计思路

我们看图中的两台物理机。它们的物理网卡是同一个二层网络里面的。由于两台物理机的容器网段不同，我们完全可以将两台物理机配置成为路由器，并按照容器的网段配置路由表。

![](https://static001.geekbang.org/resource/image/19/37/1957b75dd689127c4621b5460c356137.jpg?wh=2250%2A1165)

例如，在物理机A中，我们可以这样配置：要想访问网段172.17.9.0/24，下一跳是192.168.100.101，也即到物理机B上去。

这样在容器A中访问容器B，当包到达物理机A的时候，就能够匹配到这条路由规则，并将包发给下一跳的路由器，也即发给物理机B。在物理机B上也有路由规则，要访问172.17.9.0/24，从docker0的网卡进去即可。

当容器B返回结果的时候，在物理机B上，可以做类似的配置：要想访问网段172.17.8.0/24，下一跳是192.168.100.100，也即到物理机A上去。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/c1/60/f5439f04.jpg" width="30px"><span>Geek_dn82ci</span> 👍（28） 💬（4）<div>请问老师，在IPIP模式下，原本的性能优势是否又回退到了overlay类似呢？</div>2019-01-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/65/25/c6de04bc.jpg" width="30px"><span>斜月浮云</span> 👍（8） 💬（2）<div>现在提问还来得及吗？问下ipip模式中，隧道是点到点的？那么如果服务部署到两个或多个局域网，每个局域网有n台机器，那么为了保证互相跨网互通，是否需求全部点对点打隧道？是否资源损毁太大了？怎么优化？</div>2018-10-14</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKzqiaZnBw2myRWY802u48Rw3W2zDtKoFQ6vN63m4FdyjibM21FfaOYe8MbMpemUdxXJeQH6fRdVbZA/132" width="30px"><span>kissingers</span> 👍（6） 💬（5）<div>我们能想到的第一种方式是，让中间所有的路由器都来适配 Calico。本来它们互相告知路由，只互相告知物理机的，现在还要告知容器的网段。

这种情况为什么不行?  BGP也能交换容器网段和路由信息吧</div>2019-04-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/b4/00/bfc101ee.jpg" width="30px"><span>Tendrun</span> 👍（3） 💬（2）<div>老师您好，不太明白为什么当物理机A、B跨网断中间有多个路由器时不可用。如果路由器都支持BGP的话，且A、B之间可通。那么把A、B配置成bgp对端，应该就可以分发容器的路由，然后跨节点的容器就可以通信了吧</div>2019-04-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/5b/52/fea5ec99.jpg" width="30px"><span>俊飞</span> 👍（1） 💬（3）<div>听了老师讲解明白多了，我们的k8s1.13.0集群里面用到的就是擦calico网络，当时还在纳闷k8s怎么不用flannel网络了，现在明白了，calico网络性能要比flannel高很多，采用ip-in-ip的方式进行隧道通信，安全性也提高不少。</div>2019-01-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/0e/e9/98b6ea61.jpg" width="30px"><span>程序员大天地</span> 👍（0） 💬（2）<div>没接触过，看来只有等后面用到才能看懂</div>2019-08-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/87/64/3882d90d.jpg" width="30px"><span>yandongxiao</span> 👍（0） 💬（1）<div>超哥给的信息量真的是太大了，越品越精彩。</div>2019-08-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/6e/8b/60095195.jpg" width="30px"><span>功夫</span> 👍（0） 💬（1）<div>容器 网络越来越抽象类</div>2019-06-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c7/40/66a203cd.jpg" width="30px"><span>忙碌了一天的周师傅</span> 👍（0） 💬（2）<div>服务之间的通信我们自己http RESTful 风格的比较多 </div>2019-03-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/32/3f/fa4ac035.jpg" width="30px"><span>sunlight001</span> 👍（238） 💬（5）<div>工作中接触不到，现在完全看不明白的举个手！</div>2018-07-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/44/f2/e7158fa0.jpg" width="30px"><span>张稀虹</span> 👍（16） 💬（0）<div>提个建议 老师能不能在下一期文章出来的时候在前一期文章中更新问题的答案，感觉比较深的话题讨论区的讨论就比较少了</div>2018-07-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7c/16/4d1e5cc1.jpg" width="30px"><span>mgxian</span> 👍（12） 💬（0）<div>1.因为公有云中的虚拟机之间 不直接通过交换机互通 中间有路由 使用VPC有可能可以实现
2.微服务数据交换现在有两种主流方式 http 和 rpc</div>2018-07-27</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJcwXucibksEYRSYg6icjibzGa7efcMrCsGec2UwibjTd57icqDz0zzkEEOM2pXVju60dibzcnQKPfRkN9g/132" width="30px"><span>Geek_93970d</span> 👍（4） 💬（0）<div>和 vxlan 有何区别？vxlan 用 udp，IPIP 呢？
vxlan 的乘客协议是 二层协议，承载协议是 UDP，通常用于解决具有相同网段但是分布在不同物理机上的 docker 之间的通信（当然如果docker网段不同也是可以的，比如 Flannel）。
IPIP 的乘客协议和承载协议都是 IP，即用 IP 封装 IP，用于解决不同物理机上不同网段的 docker 之间的通信，因为是不同网段，所以必然需要通过路由转发，通过两种方式可以实现：要么用物理机当路由器使，要么通过 IPIP 隧道，前一种方式需要限制物理机必须同网段，所以才产生后一种方式。</div>2022-08-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/55/0e/7c64101d.jpg" width="30px"><span>$(CF_HB)</span> 👍（4） 💬（0）<div>不是很明白，回去公司打开个wireshark分析一下网络。分析一下路由协议。</div>2018-10-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7c/13/58bcac86.jpg" width="30px"><span>silenceper</span> 👍（3） 💬（0）<div>不支持bgp协议，是不是就用不了calico?</div>2018-09-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c2/e0/7188aa0a.jpg" width="30px"><span>blackpiglet</span> 👍（2） 💬（0）<div>1. 公有云上跨网段的现象很常见，而且如果涉及到跨数据中心，中间会经过很多路由设备，只能通过隧道方式打通连接。
2. 微服务间的信息交互主要是 RPC 和 RESTful。</div>2018-08-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/7b/9e/37d69ff0.jpg" width="30px"><span>balancer</span> 👍（2） 💬（1）<div>老师，网络数据包到达网卡的时候，内核怎么定位这个数据包属于哪个进程的那个socketfd？</div>2018-07-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/23/e8/9f445339.jpg" width="30px"><span>章潘</span> 👍（1） 💬（0）<div>虚拟机网络场景与容器场景其中一个比较大的区别是虚拟机采用了绝对的网络隔离技术，如vlan，vxlan等，所以虚拟机网段重叠很普遍。</div>2022-06-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8b/64/d8bf2f6f.jpg" width="30px"><span>旻言</span> 👍（1） 💬（0）<div>
如果能在路由器上自动配置去各个容器网络的路由规则，是不是垮网段访问的问题就不成立，就不会有IPIP这种overlay带来的开销呢？</div>2021-01-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/ef/66/dc3f4555.jpg" width="30px"><span>赛飞</span> 👍（1） 💬（1）<div>作为一名前端工程师，表示听的有点懵了😂</div>2020-11-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/5d/ff/b58dd422.jpg" width="30px"><span>星星⭐</span> 👍（1） 💬（2）<div>刘老师，是tun0还是tunl0?</div>2020-09-21</li><br/><li><img src="" width="30px"><span>Geek_042531</span> 👍（1） 💬（0）<div>公有云使用ipip这样的overlay 技术：1.实现大二层网络，构建突破vlan 4K的限制，2.容器跨3层迁移</div>2019-09-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/83/fb/621adceb.jpg" width="30px"><span>linker</span> 👍（0） 💬（0）<div>思考题1  有的公有云使用ARP代答，所以获取到的对端虚拟机的Mac地址不是真实的Mac，不能把虚拟机作为一个路由器使用，使用要连接隧道</div>2021-11-23</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erCibehm9W3tbhKic1RnbTvPVCgWDmludx9YQ97BneVRhyegkr13R6vrFPYol4IYEF98s07MicgOtS0g/132" width="30px"><span>hao</span> 👍（0） 💬（0）<div>刘老师，如果用阿里云，需要考虑这些吗？</div>2021-09-27</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/6cyOoRd2dROgiblAJkW6RLhUyH1wwU0NNibIIuV930eQ9TiaNT41K61kBSVkvYoDYg7mJtuEoCQY1awBmV0WW6BFg/132" width="30px"><span>大方方</span> 👍（0） 💬（0）<div>非网络专业从业者，实话实说从第三模块的第五讲开始就已经完全out了，现在都是硬着头皮去尝试理解大概的思路，力争刷过第一遍以后二刷细嚼。</div>2021-08-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/3a/6d/8b417c84.jpg" width="30px"><span>Wheat Liu</span> 👍（0） 💬（0）<div>想问下，Calico的IPIP模式，如果每两个物理机都要建立隧道的话，会导致隧道过多成网状结构吗</div>2021-02-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/15/86/cd97bf7e.jpg" width="30px"><span>戴宇</span> 👍（0） 💬（0）<div>我觉得第二个图是不是画得不太准确，和后面那个全连接的图也对不上，从物理机A经过路由规则到172.17.9.0&#47;24不能直接连到物理机B上面吧。这样看起来这个网络包发出去都没有经过物理机A自己的网卡。这里是性能损耗是不是指从docker0到eth0出去做SNAT的性能损耗？</div>2020-10-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/15/86/cd97bf7e.jpg" width="30px"><span>戴宇</span> 👍（0） 💬（0）<div>有疑问，这个calico还是不是overlay 网络， 我查了https:&#47;&#47;docs.projectcalico.org&#47;networking&#47;vxlan-ipip，上面还是说这个calico ipip是一个overlay网络，我也觉得是，因为跨网段要建立隧道，这个隧道就很像GRE。</div>2020-10-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/3c/84/608f679b.jpg" width="30px"><span>连边</span> 👍（0） 💬（0）<div>我觉得，要去部署一下微服务环境，然后回过头来看这些文章，才会有感触。</div>2020-08-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/db/0b/6aa6f653.jpg" width="30px"><span>侯聪</span> 👍（0） 💬（0）<div>IPIP模式下的包封装是直接把容器A发出来的payload作为应用层内容吗？ 
这样的话在物理路由器上不需要支持VXLAN或者Geneve等overlay封装协议了</div>2020-07-22</li><br/>
</ul>