如果你想下载一个电影，一般会通过什么方式呢？

当然，最简单的方式就是通过**HTTP**进行下载。但是相信你有过这样的体验，通过浏览器下载的时候，只要文件稍微大点，下载的速度就奇慢无比。

还有种下载文件的方式，就是通过**FTP**，也即**文件传输协议**。FTP采用两个TCP连接来传输一个文件。

- **控制连接**：服务器以被动的方式，打开众所周知用于FTP的端口21，客户端则主动发起连接。该连接将命令从客户端传给服务器，并传回服务器的应答。常用的命令有：list——获取文件目录；reter——取一个文件；store——存一个文件。
- **数据连接**：每当一个文件在客户端与服务器之间传输时，就创建一个数据连接。

## FTP的两种工作模式

每传输一个文件，都要建立一个全新的数据连接。FTP有两种工作模式，分别是**主动模式**（**PORT**）和**被动模式**（**PASV**），这些都是站在FTP服务器的角度来说的。

主动模式下，客户端随机打开一个大于1024的端口N，向服务器的命令端口21发起连接，同时开放N+1端口监听，并向服务器发出 “port N+1” 命令，由服务器从自己的数据端口20，主动连接到客户端指定的数据端口N+1。

被动模式下，当开启一个FTP连接时，客户端打开两个任意的本地端口N（大于1024）和N+1。第一个端口连接服务器的21端口，提交PASV命令。然后，服务器会开启一个任意的端口P（大于1024），返回“227 entering passive mode”消息，里面有FTP服务器开放的用来进行数据传输的端口。客户端收到消息取得端口号之后，会通过N+1号端口连接服务器的端口P，然后在两个端口之间进行数据传输。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/60/16/d1dd4972.jpg" width="30px"><span>ismind</span> 👍（24） 💬（1）<div>刘老师，您好，我们都付费买了课程，肯定是想学好的，为什么不发不出来呢？那样的话，真的非常感谢您了。</div>2018-06-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/93/5d/91f1d849.jpg" width="30px"><span>darren</span> 👍（9） 💬（1）<div>这就是种子过久了失效的原因吗？</div>2019-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/2f/25/d2162fce.jpg" width="30px"><span>龚极客</span> 👍（8） 💬（1）<div>思考题1，调用域名解析库解析出ip,或者本地hosts文件
思考题2，区块链数字货币

疑问，标题为啥老是卡在99%没说啊喂，不会那么巧每次node下线吧，我看还是显示有流量在下载就是没完成啊。</div>2018-06-25</li><br/><li><img src="" width="30px"><span>起风了001</span> 👍（4） 💬（1）<div>这章跳过去了. 算法用文字描述太难看懂, 而且这个协议专业性比较强, 如果不是专门做p2p的感觉可以先跳过, 以后有时间再回头看</div>2019-05-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0f/71/9273e8a4.jpg" width="30px"><span>时间是最真的答案</span> 👍（4） 💬（1）<div>迅雷下载是不是使用的P2P协议？</div>2019-04-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/58/39/1af79bd5.jpg" width="30px"><span>soga</span> 👍（4） 💬（1）<div>新加入dht网络的节点最开始没有任何其他节点的信息吧？要怎么启动？是会默认给一两个节点做初始的已知网络节点吗？如果是的话，这些初始节点怎么得到？</div>2018-07-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/c2/2e/e25b62e7.jpg" width="30px"><span>风车车</span> 👍（2） 💬（1）<div>思考题老师也没讲解，看评论只有赞，没有对评论内容进行对错 纠正。</div>2018-07-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/38/c8/972a5024.jpg" width="30px"><span>凉凉</span> 👍（1） 💬（3）<div>Node new 从哪获取文件1的种子文件的？</div>2019-02-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ae/36/680dad56.jpg" width="30px"><span>赵梅</span> 👍（1） 💬（1）<div>同问，Node new想下载文件1，但它本身并没有文件1，那是通过什么计算出文件1的哈希值的？</div>2018-09-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/d6/39/6b45878d.jpg" width="30px"><span>意无尽</span> 👍（0） 💬（1）<div>不晓得为啥，看了这个后，觉得用种子下载很不安全啊，P2P 的下载方式，虽然是快了，但是别人也可以从你这里下载😳。</div>2020-06-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/94/cb/b9254fd7.jpg" width="30px"><span>celia</span> 👍（0） 💬（1）<div>感觉老师讲的freestyle</div>2019-07-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/27/40/ae886719.jpg" width="30px"><span>geekYang</span> 👍（0） 💬（1）<div>.torrent 文件从哪里获取呢？</div>2019-03-06</li><br/><li><img src="" width="30px"><span>小田</span> 👍（0） 💬（1）<div>图谱还是发出来吧 大家都能用上，用礼券奖励也足够了吧</div>2018-06-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/70/01/0315f9ff.jpg" width="30px"><span>风太息</span> 👍（150） 💬（6）<div>99%卡住的原因是什么呢，似乎没讲</div>2018-06-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/eb/82/4b56fa5f.jpg" width="30px"><span>rtoday</span> 👍（105） 💬（2）<div>试着解析为什么99.99%
如果有误还望高手指正与指导
不论是依赖tracker，还是分布式哈希算法，p2p开宗明义就是要减轻server压力，把压力转嫁给client。
99.99%的定义，是最后校验出了错误，漏失某个文件。
而为什么会漏失呢？还是p2p开宗明义说的，把压力转嫁给client，当client流量压力过大而下线了，其他人就无法找到这个文件了，顶多DHT网络告诉每个client，漏失的文件在某个下线的人手上。你们就乖乖等他上线，并且把手上的99.99%分享给其他新来的new node吧。
为了解决这个问题，最早应该是迅雷，提供了p2sp，长效种子，让server也有义务承担一些压力。
至于迅雷为什么也会99.99%，应该是更进阶的技术问题了。比如下载网站专门防止迅雷盗链。你有张良计，我有过墙梯。</div>2018-07-17</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIWSTcia43udFKpGW0YT4zDJpO7LqkCicmTIgiaFcfszibGDkjfSSwqQ7pIMQl1Mhxc8PsdLS1UrnsrRA/132" width="30px"><span>方圆佰李</span> 👍（28） 💬（5）<div>Node new想下载文件1，但它本身并没有文件1，那是通过什么计算出文件1的哈希值的？</div>2018-06-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7f/27/03007a5e.jpg" width="30px"><span>月饼</span> 👍（25） 💬（0）<div>P2P网络是怎么解决局域网穿透的？upnp吗？</div>2018-06-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/9e/80/b87f8b49.jpg" width="30px"><span>LongXiaJun</span> 👍（17） 💬（0）<div>哈哈哈，想要网络协议知识图谱~</div>2018-06-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/22/f4/9fd6f8f0.jpg" width="30px"><span>核桃</span> 👍（9） 💬（0）<div>关于DHT算法还有一个著名的应用glusterfs，作为几大分布式文件系统之一，目前生产环境正在使用，dht算法对于并发写入非常不友好的，同时因为考虑文件安全性使用冗余码，例如8+2，那么如果是20个节点的集群，当数据规模上来以后，每个节点几乎都会保存很多元信息，通信量就太大了</div>2020-12-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/09/42/1f762b72.jpg" width="30px"><span>Hurt</span> 👍（9） 💬（0）<div>看一两遍是不够了 得看三四遍</div>2018-06-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5e/2b/df3983e2.jpg" width="30px"><span>朱显杰</span> 👍（6） 💬（0）<div>还是没有回答99%的问题呢</div>2018-06-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/2a/15/1708b35c.jpg" width="30px"><span>不想学习</span> 👍（5） 💬（4）<div>每个都是客户端，没有固定公网ip，怎么互相连接上？这块貌似没讲清楚啊</div>2018-08-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e4/29/07400492.jpg" width="30px"><span>bochs</span> 👍（5） 💬（0）<div>这一节好多算法！己经迷路了我！</div>2018-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/b7/34/e38f5ff5.jpg" width="30px"><span>winlans</span> 👍（4） 💬（0）<div>第二是DNS吧，每次域名请求都会先查找本地hosts文件，如果没有匹配的就会去请求dns服务换取ip。这也是有时候dns配置错误，会导致QQ正常，网页却打不开的奇怪现象。</div>2018-06-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/41/bc/13de31c5.jpg" width="30px"><span>羽毛</span> 👍（2） 💬（0）<div>求图谱
新 node怎样加入网络？</div>2018-06-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/01/05/9b9503cb.jpg" width="30px"><span>太多的借口</span> 👍（2） 💬（0）<div>本地host文件与dns查询</div>2018-06-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/4f/08/d3421893.jpg" width="30px"><span>海昌</span> 👍（2） 💬（0）<div>思考题二：默认应该先到本地的hosts文件找下，再到dns吧</div>2018-06-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/09/42/1f762b72.jpg" width="30px"><span>Hurt</span> 👍（2） 💬（0）<div>快播 以前的方式 是不是这样的啊</div>2018-06-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0c/0f/93d1c8eb.jpg" width="30px"><span>mickey</span> 👍（1） 💬（0）<div>DHT有点像OSPF、RIP。</div>2021-11-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/28/8f/d3fe98f4.jpg" width="30px"><span>达</span> 👍（1） 💬（1）<div>一致性哈希的另一种描述，老师讲解得很生动</div>2018-10-29</li><br/>
</ul>