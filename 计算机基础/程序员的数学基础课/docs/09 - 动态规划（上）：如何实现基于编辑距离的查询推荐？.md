你好，我是黄申。

上一篇讲组合的时候，我最后提到了有关文本的关键字查询。今天我接着文本搜索的话题，来聊聊查询推荐（Query Suggestion）的实现过程，以及它所使用的数学思想，**动态规划**（Dynamic Programming）。

那什么是动态规划呢？在递归那一节，我说过，我们可以通过不断分解问题，将复杂的任务简化为最基本的小问题，比如基于递归实现的归并排序、排列和组合等。不过有时候，我们并不用处理所有可能的情况，只要找到满足条件的最优解就行了。在这种情况下，我们需要在各种可能的局部解中，找出那些可能达到最优的局部解，而放弃其他的局部解。这个寻找最优解的过程其实就是动态规划。

动态规划需要通过子问题的最优解，推导出最终问题的最优解，因此这种方法特别注重子问题之间的转移关系。我们通常把这些子问题之间的转移称为**状态转移**，并把用于刻画这些状态转移的表达式称为**状态转移方程**。很显然，找到合适的状态转移方程，是动态规划的关键。

因此，这两节我会通过实际的案例，给你详细解释如何使用动态规划法寻找最优解，包括如何分解问题、发现状态转移的规律，以及定义状态转移方程。

## 编辑距离

当你在搜索引擎的搜索框中输入单词的时候，有没有发现，搜索引擎会返回一系列相关的关键词，方便你直接点击。甚至，当你某个单词输入有误的时候，搜索引擎依旧会返回正确的搜索结果。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/d8/d6/47da34bf.jpg" width="30px"><span>任鹏斌</span> 👍（53） 💬（3）<div>关于编辑距离的计算看了好多遍还是不太理解
1、A、B都为空A转化为B或者B转化为A不需要做任何操作编辑距离为0（可以理解）
2、A增加一个字符a1，B保持不动，编辑距离为1。或者B增加一个字符b1，A保持不动，编辑距离为1.（初始为空的情况，可以理解）
3、如何A和B有一个字符那么情况就有点复杂了，具体如下：
（1）插入字符的情况，A字符串为a1的时候，B空串增加一个字符变为b1，或者B字符串为b1的时候，A空串增加一个字符变为a1。很明显这种情况下编辑距离都要增加1
问题：这时候如果b1和a1是一样的字符A或者B再插入后已经是一样的了也不需要再做转化了，这时候编辑距离是否应该就是1？下面的表格中A、B串的m与m处的插入情况与这里一样插入的编辑距离为什么是2？
（2）替换字符的情况，可以理解为不相等的情况下才替换所以此时编辑距离加1，如果相等不需要替换则编辑距离为0？
麻烦老师解答一下，谢谢！</div>2019-01-07</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erdpKbFgRLnicjsr6qkrPVKZcFrG3aS2V51HhjFP6Mh2CYcjWric9ud1Qiclo8A49ia3eZ1NhibDib0AOCg/132" width="30px"><span>西北偏北</span> 👍（15） 💬（2）<div>搜索引擎中的自动纠错和提示功能，是对用户输入字符串，计算其相似字符串。
比如mouse就是用户输入mouuse的相似字符串。
一个字符串有哪些相似字符串，无非是把该字符串进行一系列可能的变形编辑。比如把某个字母删掉，或增加一个字母，或替换该字母
最后看变形后的单词，是否是一个合法单词。如果是，则给用户提示。

原始单词或字符变形到一个合法字符串的步数，称为这两个单词之间的编辑距离。

但一个单词随着长度增加，其对应的合法单词，编辑距离计算将会很多。不可取。

所以需要最优解，找出用户输入词，编辑距离最小的目标词即可</div>2019-01-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/1d/7d/368df396.jpg" width="30px"><span>somenzz</span> 👍（9） 💬（1）<div>有时候编辑距离最短的字符串并不能代表用户真正想输入的正确字符串，例如用户输出了 worder，实际上是想查 worker，但编辑距离为 1 的有很多，如 warder，wonder，我在想是不是应该按用户输入的字符串前辍最一致的字符串开始再计算编辑距离，例子中的 mouuse 和 mouse ，先直接替换掉前面一样的 mou,直接计算 use 和 se 的编辑距离，再从替换后面一样的 se，这样就是直接计算 u 和空串的编辑距离，这样就可以很快计算出距离为1，不知道这样理解优化是否正确，请老师指点。

</div>2019-01-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/c9/c0/730ea586.jpg" width="30px"><span>凡间的雨</span> 👍（7） 💬（3）<div>https:&#47;&#47;www.jianshu.com&#47;p&#47;4678d3f7b6f1
之前写过的一篇编辑距离文章，代码是用动态规划的方式实现的。</div>2020-04-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/63/14/06eff9a4.jpg" width="30px"><span>Jerry银银</span> 👍（6） 💬（1）<div>老师，如果让您给计算机相关的职场人推荐一本关于数学的书，您会推荐什么？</div>2019-01-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/1c/3f/eabd0cb1.jpg" width="30px"><span>Yang</span> 👍（5） 💬（1）<div>编辑距离没办法刻画语义信息，比如同义词，否定词（编辑距离很短）。</div>2019-10-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/62/8f/c0f40d98.jpg" width="30px"><span>danvid</span> 👍（4） 💬（3）<div>编辑距离解析，其实看看下面这个结合图会好理解一点，其实就是下一个结果基于上一个结果的一种情况去进行加0还是加0，老师说的真的一头雾水，大家可以参考一下
解析：
i相当于第几行，j相当于第几列
1.如果i或者j=0就是edit(i,j)=j或者i；
2.左(i-1,j)，上(i,j-1)，左上(i-1,j-1)相当于前一个子集可能出现的三种情况的下求最小值，其中左+1，上+1，右上(如果当前i=j，则+0，不等则+1)，，求这三者的最小值例如：左=1，左上=0，上=1则 edit(左)=1+1=2，如果当前格子对应行列的数据相等则edit(左上)=0+0=0，否则edit(左上)=0+1=1，edit(上)=1+1=2,所以结果就是edit(i,j)=min{edit(左),edit(左上),edit(上)}
</div>2019-05-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/39/67/743128f7.jpg" width="30px"><span>书木子谢明</span> 👍（3） 💬（1）<div>向老师请教几个问题:
1.适应动态规划的要求是 sum(每一步最优解)=最终最优解，这样的理解对吗？应该有问题不适合动态规划求解，如何辨别呢？
2. 我理解的“编辑的最短距离”描述的是两个字符串相似性的一种方式，这种方式需要逐个迭代字符，在英文环境中该算法可以推荐到单词级别，中文环境貌似只能推荐到词级别。ES中计算搜索结果相似程度也是用的“编辑距离”么？</div>2019-07-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/26/fa/266bcb89.jpg" width="30px"><span>等待</span> 👍（2） 💬（1）<div>首先，计算量非常大。我们假设字符串 A 的长度是 n，而 B 字符串中不同的字符数量是 m，那么 A 所有可能的排列大致在 m^n 这个数量级。
这里的m^n是如何得知的呢？这个没看懂，谢谢</div>2020-06-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/e7/2e/f317f6ad.jpg" width="30px"><span>伊利丹怒风</span> 👍（2） 💬（1）<div>其实例子的三种操作是对应状态转移表里面分别从：上、左、左上（斜线）变换过来的三种可能性。按这个理解会更容易一些，比如第一个A：m、B：m的理解：
1、从“左”过来：A：m，B：0，由于B：0-&gt;m，所以需要增加一个“插入”操作，也就是1+1=2
2、从“上”转移过来：A：0，B：m，由于A：0-&gt;m，所以需要增加一个“删除”操作，也就是1+1=2
3、从“左上”转移过来：A：0，B：0，由于A，B都增加了一个字符，所以需要增加一个“替换”操作，由于这里A、B增加的字符相等，所以无需“替换”，因此0+0 = 0</div>2020-02-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/2b/ec/af6d0b10.jpg" width="30px"><span>caohuan</span> 👍（2） 💬（1）<div>本篇所得：动态规划 为寻找的最优解，它只关心 最优的一个解，其他的不会再考虑，比如求解 数组的最大 和最小值，一般只有一个（可能有重复的最值，但最值是相等的）。

工作和生活中，我们一般把大问题分解为小问题，再把小问题 分解为容易解答的问题，动态规划 就是在 容易解答的问题中选择最优解。

黄老师 在文中提到：搜索引擎输入的搜索词的查询和推荐，就是对 缺失和错误的字符串进行操作，比如我们输入错误的字符串A，和正确的字符串B，需要把字符串A改到B，需要把字符串 分解到字符 的小问题，然后进行‘增、删、改’等操作，这里运用 动态规划 寻找最优解，不需要使用排列 这么复杂的方法 因为排列计算消耗的时间会很长，运用动态规划 很节能。

今天所得：解决问题的方法 （1）不断的分解问题，把大问题分解为小问题，把小问题 再分解...直至到可以解答的问题;（2）使用动态规划 求解 小问题的 最优解。

回答老师的问题：用编辑距离对字符串状态转移资源消耗的标记，会浪费很多 内存和运算资源，可以把 字符串 再分割成字符，把 二个字符串的不同的字符 掏出来，再用编辑距离 处理，应该会更快一下、占用资源也少一些，老师是否同意，也期待 黄老师的指正。

老师 可以用 斐波那契数列 来说明 动态规划的问题，更让我们易理解。</div>2019-01-21</li><br/><li><img src="" width="30px"><span>菩提</span> 👍（2） 💬（1）<div>老师，表格中插入一个字符m，编辑距离增加1。为什么说整体编辑距离是2呢？ 
如果推导表格往下移动一格，字符串A变成mo，字符串B变成了m，这时应该如何推导啊？希望您帮忙解答一下，第一次实际接触动态规划，谢谢！
最近反复看这两篇动态规划，表格推导看的有点似懂非懂。望老师指导一下</div>2019-01-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4b/46/717d5cb9.jpg" width="30px"><span>惜心（伟祺）</span> 👍（1） 💬（1）<div>局部最优 做不到全局最优</div>2020-12-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f9/88/cdda9e6f.jpg" width="30px"><span>阳仔</span> 👍（1） 💬（1）<div>动态规划要理解状态转移方程是“动态”的。
通过上一次的状态来推导本次状态，而本次可以通过不同的上一次状态来推导，
例如某个上一次状态编辑操作数是2，而本次编辑操作次数需要1，那么从该上一次状态到本次状态的操作数就是2+1=3，主要关注状态的转移带来的变化。
最后根据具体问题取其中的最优解</div>2020-06-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/51/86/b5fd8dd8.jpg" width="30px"><span>建强</span> 👍（1） 💬（1）<div>      如果词库中的词条数量很大，利用编辑距离来匹配词条的相似度效率会比较低，因为编辑距离的计算是逐个字符进行匹配扫描的，做相似度匹配时需要选出编辑距离最短的那个词条，这样就需要扫描整个词库，才能获得具有最短距离的词条。
       我个人的优化方案：预先把每个词条的前缀全部剥离出来，某些词条的前缀可能是重复的，建立前缀与词条的一对多关系，利用哈希算法，得到每个前缀的哈希值，同时把各个前缀存贮于哈希表中，哈希表中除了存贮前缀哈希值，同时还存贮该前缀属于哪个词条，即词条的索引号，这样每次查询时，先把要查询的词条按相同的哈希算法，算出哈希值，再根据哈希值，得到该前缀所属的所有词条，这样就缩小了查询范围，然后再计算每个词条和被查询的词条的编辑距离，得到相近的词。
以上是我个人的一点浮浅理解，请老师指正。</div>2019-11-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ab/10/b812ff3e.jpg" width="30px"><span>Hesher</span> 👍（1） 💬（2）<div>似乎终于理解了表格里的内容：

对于前两种插入情况，都是空串插入，A和B各插入一个m，一共做了两次插入所以编辑距离为2；

对于第三种替换情况：A、B都插入m，不需要替换，所以全程替换操作一次都没有，所以编辑距离为0（插入操作不算在编辑距离的计数中吗？）。

不知道这样理解对不对？</div>2019-03-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/24/0e/c6e1f9ea.jpg" width="30px"><span>ncubrian</span> 👍（1） 💬（1）<div>黄老师，这期怎么没有sample code</div>2019-01-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/29/e1/97/9387711d.jpg" width="30px"><span>崔晓乐</span> 👍（0） 💬（1）<div>状态转移那一节， “首先，，，那么A所有可能的排列在m^n这个数量级”，这句话什么意思，是A自己的字符排列的可能性吗？还是别的意思</div>2021-09-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/50/4f/3afb7fda.jpg" width="30px"><span>吉茄</span> 👍（0） 💬（1）<div>我觉得很难理解的原因是因为只有表格，而没有把公式给出来，导致每个人计算出来的跟表格给出的结果不一样。如果知道公式了就好理解了。</div>2021-05-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/a4/ba/9e063987.jpg" width="30px"><span>何嘉伟</span> 👍（0） 💬（1）<div>编辑距离 ：
无论如何你都要在下一步 加上一步操作 ， 除非你的两个字符是相等的状态。 两个字符相等的时候那么就要比较你当前这步操作和上一个字符的操作比较。这样的结果集就可以递推下来了。</div>2021-04-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/d4/44/0ec958f4.jpg" width="30px"><span>Eleven</span> 👍（0） 💬（1）<div>黄老师，动态规划这两篇我看了蛮久，但是还是不能理解，有啥好办法么。</div>2020-07-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/1c/4c/edfbb57a.jpg" width="30px"><span>Chuck.le</span> 👍（0） 💬（1）<div>看完了所有的评论，还是有个问题没有解答，是关于编辑距离为2，2，0的问题，具体如下，麻烦老师：
是因为替换操作不考虑插入操作，即不将A、B都插入m的操作计入总的编辑距离中，所以最后得到的总的编辑距离结果是0吗？前述两种情况都考虑了前面得到m的插入操作，替换这一步咋么就不考虑了阿</div>2020-06-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/5b/81/8c38dff8.jpg" width="30px"><span>lcqbug</span> 👍（0） 💬（1）<div>我输入一个错误的原始字符串，我要分析所有的合法字符串的编辑距离吗？</div>2020-06-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/2c/4b/87e31397.jpg" width="30px"><span>夜怀澈</span> 👍（0） 💬（1）<div>有个问题，纠正的前提是知道这个词的正确书写，那既然知道正确书写为什么还要去编辑改正呢？直接进行全量替换不行吗</div>2020-05-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg" width="30px"><span>aoe</span> 👍（0） 💬（1）<div>原来动态规划适合解决：通常只关心一个最优解，而这个最优解是单调改变的。第一次感觉动态规划没那么恐怖了！</div>2019-11-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/d4/44/0ec958f4.jpg" width="30px"><span>Eleven</span> 👍（0） 💬（2）<div>老师，表格中的三种情况：
1.插入字符：B字符串为m的时候，A空串增加一个字符变为m，编辑距离增加1，整体编辑距离距离为2（这里A从空串插入一个字符m编辑距离不就是1么？为什么会是2）
2.反过来我也有一样的疑问
这里我不解是因为为什么要从空串算起，按照图表中的情况A和B不都是m么？</div>2019-11-21</li><br/><li><img src="" width="30px"><span>Paul Shan</span> 👍（0） 💬（1）<div>我个人觉得编辑距离可以看作是一个数学归纳法的问题，不过这里的归纳是基于两个值而非一个。假设两个字符串的长度分别是m和n，编辑距离定义为d（m,n），为了让末尾匹配有三种做法，删除第一个字符串最后一个（等价为添加第一个字符串最后一个到第二个字符串），这样问题规约为d（m-1,n）+1.同样我们也可以删除第二个字符串最后一个，距离规约为d（m,n-1）+1。还有第三种就是同时删除两个字符串的末尾，这里又分为两种情况，分别对应于两个字符串最后一个是否相等（是否需要一次替换操作）d（m-1,n-1）+ (0 or 1),综合这三种，选取一种最小的，我们就可以得到一个递归式子。
请问老师，这种基于二维数学归纳法的方法和动态规划法是否在原理上等效，多谢！</div>2019-08-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/ae/f3/f9b8b077.jpg" width="30px"><span>风在身后</span> 👍（0） 💬（1）<div>编辑距离是从一个字符串变成另一个字符串的距离，那么拿suggestion来说，开始为空，然后人输入a，计算机生成a。就对应老师说的下面的情况。这个时候不应该把人输的a计算一个距离，所以应该是1，不应该是2

（1）中的情况比较绕，你可以这么来看，一开始A、B都是空串，A增加一个字符m，两者编辑距离是1，然后B增加一个字符m，即使两个m相等，编辑距离也会由1变为2，而不是维持在1，也不会降到0。因为编辑距离2表示的是A添加一个m字符，B再添加一个m字符。</div>2019-05-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7e/bb/019c18fc.jpg" width="30px"><span>徐云天</span> 👍（0） 💬（1）<div>leetcode上面居然有edit distence的题目。对动态规划一窍不通，看看可不可以参考这篇文章写出算法来，有点难啊。</div>2019-03-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/c0/50/90a8543a.jpg" width="30px"><span>uiop</span> 👍（0） 💬（1）<div>老师好，关于m行m列最大编辑距离是2，我的理解是:m和m我们用肉眼就很容易区别是相同的字母，所以编辑距离是0。但是计算机不是人，他必须遍历所有的方案，然后我们再从所有方案里的取最小的编辑距离。既然计算机是遍历所有的方案，那么最麻烦或者最复杂的方案也会遍历，那就是字符A和字符B都为空，同时插入m，所以最大编辑距离是2。

但是老师，也有另外一个思路感觉和上面我说的有点相悖。比如字符 mouuse 最终要匹配上 mouse，正确的单词mouse已经是存在的，我们只是拿用户输入的字符去匹配现成的合法单词，所以用户输入的m(字符A)，字符B是已经存在的了，因此不存在字符A和字符B同时为空的情况，那么就只需要字符A插入m即可，如果是这样的话，m行m列理解起来最大编辑距离也确实是1才对！</div>2019-02-20</li><br/>
</ul>