你好，我是LMOS。

通过前面的课程，我们学过了RISC-V的各种跳转指令以及这些指令的各种变形，并且了解了它们的机器编码。

今天，我们开始学习RISC-V下的原子指令，原子指令是RISC-V的指令扩展，命名为 ‘A’。这个扩展指令中包含两部分，分别是LR/SC指令和AMO指令。

我们先搞明白为什么需要原子指令，什么情况用得上它们。再分别学习和对比LR/SC指令与AMO指令，另外，我还会让你知道这些指令各自的使用场景是什么。

课程代码你可以从[这里](https://gitee.com/lmos/Geek-time-computer-foundation/tree/master/lesson20)下载。话不多说，让我们直接开始吧。

### 为什么需要原子指令

你对学生时代上的物理课还有什么印象么？那时候我们就接触过“原子”这个概念了。“原子”是物质的最小组成，即原子是不可分割的。虽然到现在科学家已经发现在原子内部有更小的成分，但是在广义上原子仍然保持“不可分割”的语义。

那么在芯片中的原子指令是什么呢？它延续了“不可分割”这个含义，表示**该指令的执行是不可分割的，完成的操作不会被其它外部事件打断。**

我们结合一段代码，来了解原子指令的具体作用和使用场景。

```plain
//全局变量A
int A = 0;
//线程A执行的函数
void thread_a()
{
    A++;
    printf("ThreadA A is:%d\n"，A);
    return;
}
//线程B执行的函数
void thread_b()
{
    A++;
    printf("ThreadB A is:%d\n"，A);
    return;
}
```
<div><strong>精选留言（2）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/29/a6/ad/e65aec4c.jpg" width="30px"><span>苏流郁宓</span> 👍（2） 💬（1）<div>原子指令模式（要么都执行，要么就只能返回到都不执行），随着cpu单核逼近物理极限，那么 相比于冯诺依曼结构 （原子模式随着核增多，维护数据一致浪费时间越多） 哈佛结构有没有它的优点？在多核模式下 部分领域优于冯诺依曼结构的？</div>2022-09-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/29/db/88/cc6078eb.jpg" width="30px"><span>Bean</span> 👍（0） 💬（0）<div>老师好，有个地方不是很明白
代码中：
amoadd.w a0, a1, (a0)  #原子相加a0=[a0] [a0]=[a0] + a1

翻译后的两条指令，执行过程是否有先后顺序？
如果有先后顺序，那么执行 a0=[a0] 时，是否a0的值已经更新，之后的 [a0]=[a0] + a1 是按照赋值(更新)后 a0 的值作为寻址地址，进行操作？</div>2023-01-17</li><br/>
</ul>