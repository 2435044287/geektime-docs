你好，我是LMOS。

先简单回顾一下上一节课，我们设计了MiniCPU流水线的执行相关模块。其中包括执行控制模块、通用寄存器模块，以及可以进行加减法运算、大小比较、移位操作的ALU模块。

指令执行之后就到了流水线的下一级——访存。这节课我们就重点聊聊怎么设计实现访存的相关模块。在你的设想里，访存模块必要的组成部分有哪些呢？

如果你的第一反应是访存控制模块，我只能说你只答对了一部分。访存控制模块虽然是流水线的主线，但你可能忽略了流水线中的数据相关性问题。因此，今天我们先想办法解决流水线的数据冒险问题，然后再完成流水线访存阶段相关模块的设计。

这节课的代码你可以从[这里](https://gitee.com/lmos/Geek-time-computer-foundation/tree/master/lesson06~11/mini_cpu)获取。

## 流水线数据冒险

在开始设计访存模块之前，我们得先解决一个问题，即流水线的数据冒险。

在CPU流水线里，执行不同的指令时会发生这样的情况：一条指令B，它依赖于前面还在流水线中的指令A的执行结果。当指令B到达执行阶段时，因为指令A还在访存阶段，所以这时候就无法提供指令B执行所需要的数据。这就导致指令B无法在预期的时钟周期内执行。

**当指令在流水线中重叠执行时，后面的指令需要用到前面的指令的执行结果，而前面的指令结果尚未写回，由此导致的冲突就叫数据冒险**。
<div><strong>精选留言（6）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/29/a6/ad/e65aec4c.jpg" width="30px"><span>苏流郁宓</span> 👍（8） 💬（1）<div>在硬件层面，为提高流水线效率。按照同时钟周期原则，假如ac为一组指令，c的运算必须依赖a的结果，那可以把同样周期的bd插入ac中组为abcd指令，a指令下去运算，紧接着b指令也下去运算，这样表面上c需要a的等待时间，但等待时间途中b指令也忙着，相当于cpu核没有空闲，利用指令b指令的时间间隙，a指令完成执行，结果返回给c，c执行差不多，b指令完成执行结果就可以立马返回给d指令执行了
cpu核执行指令没有空闲时间，乱序执行，这是通过增加晶体管来完成的！
这可以和今天的流水线执行方式进行互补的啊</div>2022-08-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/29/a6/ad/e65aec4c.jpg" width="30px"><span>苏流郁宓</span> 👍（2） 💬（1）<div>cpu流水线下，软硬件中断导致须停下手头工作来处理中断问题，频繁的软硬件中断会降低cpu工作效率（比如正在运行的数据需要来回存取读写），在明面上如用户一下打开多个app容易卡住，或者浏览器打开多个网页……
解决方法，如浏览器给定同时允许打开网页的最大数，或者app中也设软件cache，减少因网络即时数据存储问题导致的中断量加大，比如，优化软件结构。能就近找到的数据不要让cpu遍历去找！
在cpu层面，尽量将宽度一致的数据&#47;指令列为一组，减少内存不该有的缺页异常（该有的还得有）！</div>2022-08-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/25/5a/750924af.jpg" width="30px"><span>枫落</span> 👍（0） 💬（1）<div>空泡是什么指令呢？这个时候流水线是也处于忙状态吗？</div>2022-09-04</li><br/><li><img src="" width="30px"><span>+1</span> 👍（0） 💬（2）<div>不太理解在什么情况下需要在访存这个阶段从存储器中读取数据，不是能在执行阶段通过寄存器地址完成么？另外存储器和寄存器有什么区别呢？然后为何还有给pc地址加4的情况，不是在预读取的时候就完成了么</div>2022-08-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/27/f8/2c/92969c48.jpg" width="30px"><span>青玉白露</span> 👍（0） 💬（1）<div>精彩！锁、内存屏障等概念其实说到底就是基于访存阶段进行的特性化操作，还有很多的东西需要妈那美女消化。</div>2022-08-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/9a/89/babe8b52.jpg" width="30px"><span>A君</span> 👍（1） 💬（0）<div>数据冒险，下一条指令的源寄存器地址等于当前执行的目标寄存器地址，下一条指令的执行必须等待上一条指令完成访存和写回才能进行下去。解决方案是访存模块会把输入寄存器地址和操作数发给执行前的forwarding模块，如果该地址执行所需的源操作数地址一致，就可以用操作数替换前面从通用寄存器中读出的值，这样流水线就不需要暂停。</div>2023-11-29</li><br/>
</ul>