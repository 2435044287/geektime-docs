你好，我是LMOS。

今天我们一起来完成迷你CPU的最后一个部分——写回相关模块的设计（课程代码在[这里](https://gitee.com/lmos/Geek-time-computer-foundation/tree/master/lesson06~11/mini_cpu)）。

简单回顾一下，上节课我们完成了CPU流水线的访存相关模块的设计。在设计访存模块之前，我们发现流水线中存在数据冒险的问题。为了解决这个问题，我们设计了数据前递模块。

但是我们采用的数据前递模块，只局限于解决算术操作和数据传输中的冒险问题。在CPU流水线中还可能存在结构冒险和控制冒险的问题，我们在进行流水线规划时，已经合理地避免了结构冒险。但是，控制冒险还可能出现，下面我们就来探讨一下流水线的控制冒险问题。

## 流水线控制冒险

还记得前面我们说过的条件分支指令吗？就是根据指令设置的数值比较结果，改变并控制跳转的方向，比如beq和bne指令。

假如在流水线取出分支指令后，紧跟着在下一个时钟周期就会取下一条指令。但是，流水线并不知道下一条指令应该从哪里取，因为它刚从存储器中取出分支指令，还不能确定上一条分支指令是否会发生跳转。

上面这种**流水线需要根据上一条指令的执行结果决定下一步行为的情况，就是流水线中的控制冒险。**这时候该怎么办呢？

![图片](https://static001.geekbang.org/resource/image/62/32/622a15b75c71667b81b71a328bc98d32.jpg?wh=1920x704)

控制冒险可以使用流水线停顿的方法解决，就是在取出分支指令后，流水线马上停下来，等到分支指令的结果出来，确定下一条指令从哪个地址取之后，流水线再继续。
<div><strong>精选留言（5）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/29/a6/ad/e65aec4c.jpg" width="30px"><span>苏流郁宓</span> 👍（3） 💬（1）<div>缩减单次指令程序流执行规模（比如执行三次，假如分支预测概率为50%，第一次下去，后面两次预测一次性对的概率为0.25。执行六次则预测对的概率更低）
还有一个方法增加晶体管的规模，假如分支预测的概率为50%，增加晶体管规模，也能提高分支预测命中率（就好比，把所有的可能在同一时间利用不同的晶体管组走一遍）！</div>2022-08-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/27/f8/2c/92969c48.jpg" width="30px"><span>青玉白露</span> 👍（5） 💬（1）<div>还有其他的办法，第一种，延迟分支，在分支指令之后插入一条一定会执行的指令（根据编译器和系统来确定），这样可以充分利用时钟周期；第二种，多分支执行，跳转和不跳转并行取指，哪条不执行就丢掉</div>2022-08-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2d/ff/22/dadbadb2.jpg" width="30px"><span>云海</span> 👍（0） 💬（1）<div>老师，请问要跑仿真的话，是还需要assembler的代码吗？谢谢</div>2022-08-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/9a/89/babe8b52.jpg" width="30px"><span>A君</span> 👍（0） 💬（0）<div>控制和数据冒险还是很多的：分支预测失败得把取指和译码得到信号清掉，然后更新pc；如果下条指令要读取的寄存器需要等上一条指令访存完，那就得插入一个停顿周期。如果不想因停顿导致性能损失，可以在原停顿点插入另一条无关指令，这需要编译器来做，而且可能还需要解决信号的跨指令存储，</div>2023-11-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/39/d2/845c0e39.jpg" width="30px"><span>送过快递的码农</span> 👍（0） 💬（0）<div>看不懂，硬看。看完还是不懂，但是还是硬着头皮提个问题，cpu有个概念叫ipc，单个周期的处理量。是不是增加流水线深度也是提升ipc的办法。流水线深度增加，是不是能够增加预测的准确率（纯属外行瞎猜）</div>2023-11-24</li><br/>
</ul>