上一节，我们解析了计算虚拟化之CPU。可以看到，CPU的虚拟化是用户态的qemu和内核态的KVM共同配合完成的。它们二者通过ioctl进行通信。对于内存管理来讲，也是需要这两者配合完成的。

咱们在内存管理的时候讲过，操作系统给每个进程分配的内存都是虚拟内存，需要通过页表映射，变成物理内存进行访问。当有了虚拟机之后，情况会变得更加复杂。因为虚拟机对于物理机来讲是一个进程，但是虚拟机里面也有内核，也有虚拟机里面跑的进程。所以有了虚拟机，内存就变成了四类：

- **虚拟机里面的虚拟内存**（Guest OS Virtual Memory，GVA），这是虚拟机里面的进程看到的内存空间；
- **虚拟机里面的物理内存**（Guest OS Physical Memory，GPA），这是虚拟机里面的操作系统看到的内存，它认为这是物理内存；
- **物理机的虚拟内存**（Host Virtual Memory，HVA），这是物理机上的qemu进程看到的内存空间；
- **物理机的物理内存**（Host Physical Memory，HPA），这是物理机上的操作系统看到的内存。

咱们内存管理那一章讲的两大内容，一个是内存管理，它变得非常复杂；另一个是内存映射，具体来说就是，从GVA到GPA，到HVA，再到HPA，这样几经转手，计算机的性能就会变得很差。当然，虚拟化技术成熟的今天，有了一些优化的手段，具体怎么优化呢？我们这一节就来一一解析。
<div><strong>精选留言（19）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/ee/14/46442742.jpg" width="30px"><span>ClassCastException</span> 👍（22） 💬（3）<div>别管看不看的懂，能坚持到这的也是神级人物了</div>2019-07-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/35/73/46d6dadc.jpg" width="30px"><span>没心没肺</span> 👍（8） 💬（1）<div>快要被劝退了，硬着头皮看。</div>2019-07-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/58/9f/abb7bfe3.jpg" width="30px"><span>小龙的城堡</span> 👍（4） 💬（2）<div>把c语言写出面相对象，确实有意思！</div>2019-07-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/23/66/413c0bb5.jpg" width="30px"><span>LDxy</span> 👍（2） 💬（1）<div>真难</div>2019-07-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ad/c0/ea2b3a14.jpg" width="30px"><span>起飞的鸭子</span> 👍（2） 💬（1）<div>这配图是网易吗</div>2019-07-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/6e/0f/d6773c7e.jpg" width="30px"><span>浪子</span> 👍（1） 💬（1）<div>超哥会讲overcommit吗</div>2019-07-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a6/43/cb6ab349.jpg" width="30px"><span>Spring</span> 👍（13） 💬（0）<div>总结下来就是：虚拟机用户态qemu中的KVMSlot结构维护虚拟机进程的虚拟地址，虚拟机内核态kvm_memory_slot结构维护虚拟机的物理页面，二者通过普通页表建立映射关系。当访问虚拟机虚拟页面发生缺页异常时，切换到宿主机中分配真正的物理页面，然后通过EPT（扩展页表）建立虚拟机物理地址到宿主机物理地址的映射关系。</div>2019-10-04</li><br/><li><img src="" width="30px"><span>zKerry</span> 👍（6） 💬（0）<div>感觉怼到了一堵墙上，请问刘老师，你当初是怎么整明白的？</div>2019-10-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/fc/84/30af1749.jpg" width="30px"><span>Ascend</span> 👍（5） 💬（0）<div>我感觉这章没有先讲qemu的宏观架构，直接引入qemu细节代码，有点吃力</div>2020-10-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/74/c9/d3439ca4.jpg" width="30px"><span>why</span> 👍（2） 💬（1）<div>是不是 qemu 维护的 slot 相当于 gpa，KVM 维护的 slot 相当于 hva。</div>2020-02-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/07/bf/d4d4417c.jpg" width="30px"><span>No</span> 👍（1） 💬（1）<div>老师，你讲的这个深度作为一个虚拟化运维工程师或者云计算运维工程师是否要掌握的很熟悉？</div>2020-08-11</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/uG2kliaKAroGkNaXSwFNEmVz8xM6srw7OEHBMSBbPibuXQMctibLyuQEpRVmOth8sdojb3u5VUEjWm2D2lzRGuMDA/132" width="30px"><span>Geek_ae11ce</span> 👍（0） 💬（0）<div>这一次终于深入进去了。确实提炼得非常好！</div>2025-02-12</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/uG2kliaKAroGkNaXSwFNEmVz8xM6srw7OEHBMSBbPibuXQMctibLyuQEpRVmOth8sdojb3u5VUEjWm2D2lzRGuMDA/132" width="30px"><span>Geek_ae11ce</span> 👍（0） 💬（0）<div>请问tdp的意思就是EPT，前面已经讲过了。
是在本章讲的，还是在前边回目中讲的？因为EPT是在本文的上边刚刚给出的概念，从那往下没有看到哪里提到tdp。</div>2023-08-01</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/uG2kliaKAroGkNaXSwFNEmVz8xM6srw7OEHBMSBbPibuXQMctibLyuQEpRVmOth8sdojb3u5VUEjWm2D2lzRGuMDA/132" width="30px"><span>Geek_ae11ce</span> 👍（0） 💬（0）<div>建议从“页面分配和映射”开始单起一篇新的文章。</div>2023-07-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/91/d0/35bc62b1.jpg" width="30px"><span>无咎</span> 👍（0） 💬（0）<div>逻辑复杂，结构多，代码也多。在手机端更不上语速，只好切换到Web端来阅读。</div>2023-07-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/c1/73/a7da4215.jpg" width="30px"><span>盖满京</span> 👍（0） 💬（2）<div>能不能在虚拟机里安装虚拟机？会怎样？</div>2021-11-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/56/c9/7b3cd3e0.jpg" width="30px"><span>马振</span> 👍（0） 💬（0）<div>AddressSpace address_space_memory 来表示虚拟机的系统内存，这个就是GVA？虚拟机有一个结构 struct KVMState 表示这个虚拟机，这个结构会指向一个数组的 struct KVMSlot 表示这个虚拟机的多个内存条，这个就是GPA?</div>2021-10-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/11/ac/9cc5e692.jpg" width="30px"><span>Corner</span> 👍（0） 💬（0）<div>mmap得到的宿主机虚拟地址和虚拟机的物理地址在kvm_memory_slot中进行了联系，但并没有使用这层关系，而是直接使用EPT来建立虚拟机物理地址到宿主机物理地址的关系</div>2021-07-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/8a/38/a3260945.jpg" width="30px"><span>小呆瓜</span> 👍（0） 💬（0）<div>只要牵扯到页面页表我就开始听不懂</div>2020-11-23</li><br/>
</ul>