前面几节，我们讲了CPU和内存的虚拟化。我们知道，完全虚拟化是很慢的，而通过内核的KVM技术和EPT技术，加速虚拟机对于物理CPU和内存的使用，我们称为硬件辅助虚拟化。

对于一台虚拟机而言，除了要虚拟化CPU和内存，存储和网络也需要虚拟化，存储和网络都属于外部设备，这些外部设备应该如何虚拟化呢？

当然一种方式还是完全虚拟化。比如，有什么样的硬盘设备或者网卡设备，我们就用qemu模拟一个一模一样的软件的硬盘和网卡设备，这样在虚拟机里面的操作系统看来，使用这些设备和使用物理设备是一样的。当然缺点就是，qemu模拟的设备又是一个翻译官的角色。虽然这个时候虚拟机里面的操作系统，意识不到自己是运行在虚拟机里面的，但是这种每个指令都翻译的方式，实在是太慢了。

另外一种方式就是，虚拟机里面的操作系统不是一个通用的操作系统，它知道自己是运行在虚拟机里面的，使用的硬盘设备和网络设备都是虚拟的，应该加载特殊的驱动才能运行。这些特殊的驱动往往要通过虚拟机里面和外面配合工作的模式，来加速对于物理存储和网络设备的使用。

## virtio的基本原理

在虚拟化技术的早期，不同的虚拟化技术会针对不同硬盘设备和网络设备实现不同的驱动，虚拟机里面的操作系统也要根据不同的虚拟化技术和物理存储和网络设备，选择加载不同的驱动。但是，由于硬盘设备和网络设备太多了，驱动纷繁复杂。
<div><strong>精选留言（10）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/f6/4e/0066303c.jpg" width="30px"><span>cuikt</span> 👍（1） 💬（1）<div>留个言，讲的挺好！ </div>2019-08-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/15/5c/aa3f8306.jpg" width="30px"><span>潇是潇洒的洒</span> 👍（39） 💬（1）<div>留个爪，虽然大部分都看不懂，但是我的初心是了解操作系统的概念，所以第一遍不关注细节，构建系统的大体框架，知道有这么个事儿就好了，好像看到这里，还能坚持的人就很少了，留个言，鼓励自己一下，希望再回来来看的时候，自己会多一些明悟。</div>2019-09-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5e/96/a03175bc.jpg" width="30px"><span>莫名</span> 👍（4） 💬（1）<div>赞，之前只是粗略读了一遍，留个大概印象。最近在优化虚拟机存储性能，重新拜读，受益匪浅，理解深刻了很多。</div>2020-07-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/db/26/54f2c164.jpg" width="30px"><span>靠人品去赢</span> 👍（3） 💬（0）<div>老师他这个协程和go的协程对比有什么异同？</div>2019-09-17</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKkF14X58pdmTgBWwWzxVicJ0LQjNXiceL3xSj73eC4AZheyIPtf8tyqTicbP4VXia1TmDlm9rlCNCuDQ/132" width="30px"><span>Geek_c2c8d1</span> 👍（1） 💬（0）<div>哇！看到这里的人已经越来越少了，虽然我也看不懂，但是还是想坚持看完第一遍，有个印象。这两个月在找工作，来这里打个卡。</div>2021-08-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/68/12/031a05c3.jpg" width="30px"><span>A免帅叫哥</span> 👍（1） 💬（0）<div>这一节比内存和cpu的虚拟化简单很多。</div>2021-04-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/39/98/4c96c6f4.jpg" width="30px"><span>焦太郎</span> 👍（0） 💬（0）<div>没有什么复杂的问题是分层解决不了的，如果有，就是分的还不够（- -）</div>2023-05-17</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/yUAD9PkjPE1Xm6FMqgmWhhKMQf6zbyEdQO8oWJN5v020oRD8OgLScVDiatriakNlWQdo96m88GyWia3WVKCZtW5BQ/132" width="30px"><span>Geek_cc94b0</span> 👍（0） 💬（0）<div>看的晕，但是还是坚持下来</div>2022-07-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/80/6e/7f78292e.jpg" width="30px"><span>无</span> 👍（0） 💬（0）<div>在vm里用的大部分是协程的话,是不是一些long running的服务在vm上跑会比在裸机上跑性能更好? 用户&#47;内核态之间的切换会少很多吧?</div>2022-01-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/32/5b/d0c7e813.jpg" width="30px"><span>luo</span> 👍（0） 💬（1）<div>讲的好</div>2022-01-23</li><br/>
</ul>