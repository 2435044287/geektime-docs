如果你在线购买过春运的火车票，经历过购票网站的瘫痪，你应该深有体会，网站瘫痪是一件让人多么绝望的事情。

根据有关报道，2014年1月9日，火车票售票网站点击量高达144亿次，相当于每个中国人点击了10次，平均每秒点击了16,000次，峰值的点击量可能远远超出16,000次。这么强悍的访问量，导致了火车售票网站多次瘫痪。这是一个典型的性能错配导致的重大网络事故，处理这么大的点击量需要特殊的程序设计和架构安排。

有句俗话说：“又要马儿跑，又要马儿不吃草。”马该怎么活呀？活不了呀！要想让马跑得快，既要有好马，也要有好料。

如果可以把软件比作一匹马的话，让这匹马出生时有一个优良的基因，平日里精心地伺候，是让它跑得快的先决条件。

前一段时间，我们讨论了如何让代码“写得又快又好、读得又快又好”的话题。接下来的这段时间，我们来聊聊怎么让代码“跑得又快又好”。跑得又快又好，一般也意味着更少的运营费用。该怎么让我们写的代码有一个跑得好的基因呢？

## 需不需要“跑得快”的代码？

很多项目是面向订单的，代码的功能是需要优先考虑的任务。这并没有错误。如果不能兼顾性能，这个债将来还起来会很痛苦，成本很高。而且，很多情况下，它是躲不开、赖不掉的。
<div><strong>精选留言（27）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/79/69/5960a2af.jpg" width="30px"><span>王智</span> 👍（5） 💬（1）<div>自我表示还没成长到这一步,但是感觉性能问题是很重要,平常看微信公众号,掘金等知识文章会有很多关于性能出现问题造成的很严重的后果,还有很多如何提高性能的文章,从这点来看,性能确实是软件开发中很重要的点.
就我现在的理解,只能感觉算法很重要,现在写代码都是只要能实现就行,能跑就行,没有考虑到其它,还得修改进步.
加油,新的一年!!!
</div>2019-02-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c4/d1/209abdd6.jpg" width="30px"><span>小狼</span> 👍（3） 💬（1）<div>示例代码是leetcode上两数之和的算法题，官方题解给出的一种答案。性能问题在于算法的时间复杂度和空间复杂度都是o(n)。该示例代码影响性能的最大因素就在于算法的时间辅助和空间复杂度可以再降一降，另外就是如果没有找到符合要求的两数，可以返回null，不必抛异常</div>2019-02-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8a/5f/c60d0ffe.jpg" width="30px"><span>硅谷居士</span> 👍（3） 💬（1）<div>还有一个难找的性能问题的话，我认为可能就是算法层面了。没有对数组进行任何处理就进行计算了，当数组很大时，可能会有很多不需要计算或者重复的。</div>2019-02-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e4/e9/0dd3829f.jpg" width="30px"><span>aguan(^･ｪ･^)</span> 👍（2） 💬（1）<div>1.判断入参num数组为空时，直接返回空，这样就不用创建map
2.当for循环结束后为找到满足条件的数据是返回空，而不是直接抛出异常</div>2019-02-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8a/5f/c60d0ffe.jpg" width="30px"><span>硅谷居士</span> 👍（2） 💬（1）<div>性能问题有两个：
1. HashMap 没有指定大小，如果求组很大会导致频繁扩容
2. 抛异常不太好，异常堆栈会有性能开销

P.S.
拆箱装箱在编译时就已经做了，不会有太大性能问题</div>2019-02-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/3f/87/8860f508.jpg" width="30px"><span>卞雪达</span> 👍（1） 💬（3）<div>我最近遇到的一个性能问题。有一些数据是实时性要求不高的，我每次从数据库select的时候，都在想&quot;这些货应该放缓存里&quot;，终于忍不住，弄了一个。我的需求很简单，每10分钟捞一次数据，加载在缓存里，应用从缓存里查。我自己用ConcurrentHashMap弄过简单的，但这次想用轮子。我用了Spring的缓存实现，可我发现这个实现并不支持定时，它希望我像管理数据库一样增改缓存。我觉得这样的话复杂度并不低，而且我将有两个应用，又暂时不打算上Redis这样的内存型存储，这种情况缓存的共享也是问题。我最终改造了一下Spring的缓存默认实现，记录上次查库的时间，再查时候判断下时间，超过10分钟就重新查，否则查缓存(我是单机，也就是内存)，两个应用各存各的。老师，为什么轮子并不支持定时缓存，却希望我自己管理呢？定时这种事情是希望交给Redis这种缓存工具实在吗？</div>2019-05-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/10/bb/f1061601.jpg" width="30px"><span>Demon.Lee</span> 👍（1） 💬（1）<div>最后给出的代码性能问题是指 自动拆箱和装箱吗？老师可以在下一期里面给出解题思路么，谢谢</div>2019-02-11</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIstR9CfEytdeJyicODHOe6cYGt4icg8cNVam9mE0s7picUsInZvwvia1hEtKsyHETfic0jrAddjt0wXdA/132" width="30px"><span>Geek_d68bf9</span> 👍（0） 💬（1）<div>三五台服务器解决掉春运火车票售票网站崩溃的问题，这个本身也是伪命题，这一百万怕是不好挣了</div>2022-06-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/5c/9c/c5528d9f.jpg" width="30px"><span>天空</span> 👍（0） 💬（1）<div>老师您好！您说后续文章会分析这段代码的问题，可是我看完了整个经济篇也没有找到，是我看的不认真没发现吗？</div>2020-01-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/e9/65/9ed6a8ad.jpg" width="30px"><span>阳阳阳🌙</span> 👍（0） 💬（1）<div>nums.length 可以申明一个变量，不必每次循环都计算</div>2019-02-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8a/5f/c60d0ffe.jpg" width="30px"><span>硅谷居士</span> 👍（0） 💬（1）<div>再往底层虚拟机考虑的话，问题可能是 Integer 的缓存问题，导致大量重复对象创建，因为默认范围是 -128 到 +127</div>2019-02-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/57/0f/1f229bf5.jpg" width="30px"><span>Void_seT</span> 👍（0） 💬（1）<div>性能问题是出现在“入参数组过大，导致map频繁扩容”么？</div>2019-02-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/41/27/3ff1a1d6.jpg" width="30px"><span>hua168</span> 👍（0） 💬（1）<div>老师我有2个疑问：
1.是不是编程学到一定程度下都要求学一下算法？一些常用用算法，我看极客专栏也有算法的文章
2.我看很多小公司都没有用到什么多少算法之类，如果自己的目标是中小公司是不是不用学算法了？</div>2019-02-12</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/ibZVAmmdAibBeVpUjzwId8ibgRzNk7fkuR5pgVicB5mFSjjmt2eNadlykVLKCyGA0GxGffbhqLsHnhDRgyzxcKUhjg/132" width="30px"><span>pyhhou</span> 👍（6） 💬（0）<div>像是结尾不应该抛出异常，还有 map 需要设置大小，不然会有频繁扩容的问题，另外就是一开始判断数组 nums 为 null 或者空的话可以直接返回空数组，这些我看前面的同学都说了。但是回看这个问题，往深了想，其实很多情况没有交代明白，其中一个我想到的就是内存的问题，这个示例算法的确很快，O(n)时间复杂度，但是也会有额外的 O(n) 的空间消耗，如果说数组 nums 非常非常的大，假如说是 100G，而此时的剩余内存不足 1G，这样子的话这种方法明显行不通；在这种极端情况下，仅仅从算法角度考虑的话，退而求其次的方法是将整个数组用快排排一下序，然后用双指针分别从数组两头相向走一遍，时间复杂度O(nlgn)，空间复杂度O(1)。这也是验证了老师文章当中讲到的，考虑一个算法好坏与否，仅仅考虑算法本身是完全不够的，再精美的算法也需要结合计算机硬件，操作系统还有整体的一个架构进行考虑筛选～</div>2019-03-03</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLGibDGxtdFAaicHB4snJghQsY61Crddd7nefcvjWHBJ2OC8Eq17Kofz80eImiacFBsajRopibibOf9Z6Q/132" width="30px"><span>马大哈</span> 👍（0） 💬（0）<div>这里业务代码的空间复杂度通常都很高，大家会存很多信息，便于操作获取。 如何解决这种</div>2023-03-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg" width="30px"><span>ifelse</span> 👍（0） 💬（0）<div>另外，性能问题，大部分都是意识问题和见识问题。想得多了，见得多了，用得多了，技术就只是个选择的问题，不一定会增加我们的编码难度和成本。--记下来</div>2022-07-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/7b/bd/ccb37425.jpg" width="30px"><span>进化菌</span> 👍（0） 💬（0）<div>好的算法，可以为代码性能提高好几个数量级。
说到硬件，大概会想到这样一句“空间换时间”，也是一种粗暴的方式。不过一般情况会优先考虑当下的机器，对代码层面、机器配置等进行调优~</div>2021-11-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/87/62/f99b5b05.jpg" width="30px"><span>曙光</span> 👍（0） 💬（0）<div>将int complement 变量声明放到for之外。这段代码的算法的性能已经是O(n)了（for循环O(n), Map 插入和查询O(1)），所以考虑节省空间。</div>2020-12-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/74/10/d2bd15ab.jpg" width="30px"><span>guyunlige</span> 👍（0） 💬（0）<div>还是有点局限于语言</div>2020-10-15</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/m4zrM7PiaMhf3kfJdGqpIFTI4Uxg5IvlibaxGIJSSwibr9bYSLmG3tiafkbonRLCshdGTX3enY2nYrd7wEWMf3WicXw/132" width="30px"><span>Geek_187490</span> 👍（0） 💬（0）<div>很多时候还轮不到考虑性能，主要的还是快速的实现功能，过早的优化也是一个问题。但是追求正确和高效，这个时刻放在脑海还是有必要的。</div>2020-02-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/5b/08/b0b0db05.jpg" width="30px"><span>丁丁历险记</span> 👍（0） 💬（0）<div>认知的误解  不切实际的假设。</div>2019-11-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/5b/08/b0b0db05.jpg" width="30px"><span>丁丁历险记</span> 👍（0） 💬（0）<div>复杂度的来源，性能</div>2019-11-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/d9/e9/eaa1222d.jpg" width="30px"><span>qazwsx</span> 👍（0） 💬（0）<div>1.-XX:+ AutoBoxCacheMax增大Integer范围
2.HashMap改用TreeMap
</div>2019-07-06</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/ooZCPFY1xgC81h0Eu3vuqbWG5MaBp8RNmvXXGQwupo2LpSOLq0rBlTDRAF1yM6wF09WdeG49rA9dJSVKIUBxnQ/132" width="30px"><span>Sisyphus235</span> 👍（0） 💬（0）<div>代码的性能就是开发者的产品的质量，一般开发都会先要迅速开发出原型和 demo，这个时候无法顾及太多性能，但是要留有水平扩展的能力，或者性能开发的后续方案。

比如方法解耦，留下异步的可能，再比如能够开多线程多进程，又或者能够留有接口提升核心算法的性能。</div>2019-05-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/64/6e/a7c37ff9.jpg" width="30px"><span>陈杰</span> 👍（0） 💬（0）<div>用set应该就可以了，不需要用map。如果用加法可以不用保存结果，但时间复杂度相对弱一些</div>2019-03-09</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/X9fK7y43n7oAo19GlYHQZRQQ2Y0Dj8wHUEDXHWXUauxXOiaMtAc0TPtv1dyXHWDr4P7icDITmOLbaKVWXnY5oReQ/132" width="30px"><span>悲劇の輪廻</span> 👍（0） 💬（0）<div>好的算法确实很重要，难怪说国外程序员应聘之前必先刷LC……</div>2019-03-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/50/fb/872e2cf1.jpg" width="30px"><span>秦凯</span> 👍（0） 💬（0）<div>对性能和资源消耗有一定的意识，但是具体的开发过程中或者应用运行过程中对性能进行监控、评测、分析就束手无策了。[捂脸]</div>2019-03-01</li><br/>
</ul>