你好，我是大明。今天我们来聊聊数据迁移的问题。

我之前就注意到很多人的简历里面都会提到数据迁移方面的内容。比如：

- 重构老系统：使用新的表结构来存储数据；
- 单库拆分分库分表、分库分表扩容；
- 大表修改表结构定义。

但是在面试的时候，他们就是说不清楚数据迁移究竟应该怎么做，又或者说自己是停机迁移数据的。

这就是小看了数据迁移这个面试点。数据迁移其实是一个很能够综合体现你设计复杂方案解决棘手问题的点，它能进一步凸显你在数据库方面的积累，所以千万不能忽视。今天我就给你展示一个非常全面的不停机数据迁移的方案。

## 数据备份工具

这里我先来介绍一下 MySQL 上常用的两款数据备份工具：mysqldump和XtraBackup。

- mysqldump：一个用于备份和恢复 MySQL 数据库的命令行工具。它允许用户导出 MySQL 数据库的结构、数据以及表之间的关系，以便在数据库发生问题时进行恢复。它是一个逻辑备份工具，导出的内容是一条条 SQL。
- XtraBackup：它使用了 InnoDB 存储引擎的数据备份技术，支持增量备份和恢复，并且支持多主机备份和恢复。它是一个物理备份工具，相当于直接复制 InnoDB 的底层存储文件。

![图片](https://static001.geekbang.org/resource/image/e3/d0/e341443c3cc11c3b04d17a28134cbbd0.png?wh=1920x712)

如果你使用的不是 MySQL，可以自己收集一下你使用的数据库的工具。要注意分析这些工具的优缺点，尤其是导入导出速度以及可行的优化手段。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/d0/91/89123507.jpg" width="30px"><span>Johar</span> 👍（5） 💬（2）<div>1.由于目标表没有数据需要全量同步源表数据，会占用源库的资源，可能影响性能，此外，在进行检验恢复数据时，需要切换目标表为主库，才能写目标表。
2.可以，但是不好确认目标库数据是否已经入库，同时插入可能存在冲突，考虑这种情况，可以使用消息总线的延时队列，另外在双写目标库时使用insert into ignore进行写入。</div>2023-07-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg" width="30px"><span>peter</span> 👍（4） 💬（1）<div>请教老师几个问题：
Q1：导出源表时，截止点怎么定？数据一直在写入，在哪一行停止导出？
Q2：假设表中有一百万行数据，导出到目的表后，需要校验数据的正确性吗？ 怎么校验？逐行对比，而且每一行都对比每一列吗？
Q3：标记位是业务代码中设置的吗？还是MySQL中设置的？
Q4：Insert语句怎么拿到主键？Insert执行后返回0或1，表示插入是否成功，也没有返回主键啊。
Q5：切换双写部分的第一个图，没有目标表，可能是个笔误。</div>2023-07-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/36/f3/d4/86a99ae0.jpg" width="30px"><span>哆啦a喵</span> 👍（2） 💬（1）<div>顺便问问老师，哪里能找到做简历辅导的靠谱机构或者个人呀，比如老师您自己 = =</div>2024-04-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/10/05/af45721e.jpg" width="30px"><span>jCodePorter</span> 👍（2） 💬（1）<div>老师有没有Java版本实现双写的案例参考</div>2023-10-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2a/44/e6/2c97171c.jpg" width="30px"><span>sheep</span> 👍（1） 💬（1）<div>回答课后问题：
1. 初始化时目标表数据为空，作为源表的一个从库的话，同步过程中会占用源库的资源，影响性能。另外从库一般只提供读功能，此时要实现双写的话，就得把从库readonly=true关闭，另外此时支持从库支持写入后，从库同步应用主库过来的数据往往会有意想不到的问题（比如：主键冲突）
2. 可以，但得考虑的消费SQL时候，可能找不到对应数据了</div>2023-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2a/44/e6/2c97171c.jpg" width="30px"><span>sheep</span> 👍（1） 💬（1）<div>1. “数据一致性问题”这里，&quot;写入源表成功了，但是写入目标表失败了，该怎么办？那么最基础的回答就是不管&quot;。这里一两条的话，确实可以通过后面修复机制去完善。但是这里一直失败的话，也不管么
2. &quot;数据一致性问题&quot;这里，&quot;UPDATE xxx WHERE a = 123&quot;什么情况下目标表会写入失败呢？另外为啥通过消息队列的处理方式没办法定位到源表的哪一行？不就是a = 123这一行么</div>2023-10-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/44/cf/791d0f5e.jpg" width="30px"><span>ZhiguoXue_IT</span> 👍（1） 💬（1）<div>迁移数据的时候，新的分表分库的容量大小一般如何制定，是预估十年的存储量吗？作者这块有啥经验</div>2023-07-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/36/f3/d4/86a99ae0.jpg" width="30px"><span>哆啦a喵</span> 👍（0） 💬（1）<div>老师想问一下，“业务开启双写，以源表为准” 以及 “切换双写顺序” 的时候通过消费binlog同步，这种方案会有问题么？结合上一节课的内容，只要binlog保证能消费到，应该是ok的？但是感觉会把系统变得更复杂？</div>2024-04-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/ef/4d/83a56dad.jpg" width="30px"><span>Z.</span> 👍（0） 💬（1）<div>我有一个疑惑的点，增量校验的时候，如果出现异常的数据是一条新增的数据，那如果使用更新时间戳的话，一般新增的数据是没有更新时间戳的，那我应该怎么解决这个问题</div>2024-04-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/67/3d/71031021.jpg" width="30px"><span>nadream</span> 👍（0） 💬（1）<div>什么时候停止第一次校验与修复？是在开启双写前吗？那停止第一次校验与修复步骤与开启双写步骤会不会存在时间差，导致这段时间内的数据丢失。</div>2024-02-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/67/3d/71031021.jpg" width="30px"><span>nadream</span> 👍（0） 💬（1）<div>双写的时候，一个源表可能对应多个目标表，该怎么处理呢？</div>2024-01-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/67/3d/71031021.jpg" width="30px"><span>nadream</span> 👍（0） 💬（1）<div>GORM ConnPool 替换这块有详细代码吗？看的不是很明白</div>2024-01-20</li><br/><li><img src="" width="30px"><span>Geek_6c2524</span> 👍（0） 💬（1）<div>老师，想请教下，切换写入流程的时间节点是什么时候？比如，双写开始多久之后从——读写源表+写目标表，切换到读写目标表+写源表；多久之后，系统从双写切换到最终的单写到新目标表里？</div>2024-01-03</li><br/><li><img src="" width="30px"><span>Geek_3d0fe8</span> 👍（0） 💬（1）<div>一下子切换到新系统太粗暴了，我们之前的做法是每个用户都打上状态的标记，决定读写走哪个系统</div>2023-12-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/4a/c7/0cff4a59.jpg" width="30px"><span>木木夕</span> 👍（0） 💬（1）<div>比如原数据是不分库分表的，要前迁移到分库分表后目标数据库，也是按照你这个步骤迁移？</div>2023-10-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/da/d9/f051962f.jpg" width="30px"><span>浩仔是程序员</span> 👍（0） 💬（1）<div>老师，有没有过多个表聚合到同一张表的数据迁移数据，比如一个用户的信息，之前的数据比较分散，需要连表查询，聚合在一起方便管理和查询</div>2023-09-08</li><br/><li><img src="" width="30px"><span>Geek_0e1759</span> 👍（0） 💬（1）<div>老师，我想问一下，在增量校验和数据修复过程中，会不会跟正常的业务读写产生覆盖的问题发生</div>2023-08-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/cb/d5/fab32cf7.jpg" width="30px"><span>卖藥郎</span> 👍（0） 💬（1）<div>老师 在切换读写顺序的时候 是一下子就切换吗？正在进行的事务怎么办，需要暂时停写吗？还有写目标库可不可以异步</div>2023-08-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/cb/d5/fab32cf7.jpg" width="30px"><span>卖藥郎</span> 👍（0） 💬（1）<div>老师 课后题什么时候整理一波
</div>2023-08-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/cb/d5/fab32cf7.jpg" width="30px"><span>卖藥郎</span> 👍（0） 💬（1）<div>老师 binlog 触发 何时触发呀</div>2023-08-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/cc/a0/bd31d495.jpg" width="30px"><span>陆美芳</span> 👍（0） 💬（1）<div>我想问一下老师，xtrabackup备份迁移，如果恢复的时候my.cnf数据目录改了，行不行？我现在就是目录不一样了，因为新服务器分区目录不一样，启动时报错，错误日志里面有问是不是改了目录，在想是不是得重做系统？</div>2023-07-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/08/ab/caec7bca.jpg" width="30px"><span>humor</span> 👍（0） 💬（1）<div>当innodb_autoinc_lock_mode等于2时，mysql怎么处理insert select这种情况呢？这种语句是要执行完才能知道需要多少个主键的吧</div>2023-07-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7e/57/8c1051b6.jpg" width="30px"><span>3.0的A7</span> 👍（0） 💬（1）<div>mysqldump ，如果原表是集群分片部署的，就不太行了呀</div>2023-07-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/dc/08/64f5ab52.jpg" width="30px"><span>陈斌</span> 👍（0） 💬（1）<div>重构之后表结构改变了，表结构变化蛮大的，业务逻辑也简化了一些，这种场景能做到使用非侵入方案做到双写吗？</div>2023-07-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/44/cf/791d0f5e.jpg" width="30px"><span>ZhiguoXue_IT</span> 👍（0） 💬（1）<div>1）比如12个库，每个库有12张表，此时业务量增长，当前的数据库已经快不够了，扩容的时候，要扩容的大小有什么策略吗？
2）hashmap当数据量达到临界值的时候，此时会进行扩容两倍，然后进行全量迁移，然后在进行查询新的数据，从这样理解上，hashmap的扩容是不是一种停机迁移</div>2023-07-22</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK6phK0WjFw6rdhVEUPicZtMiaIDvdX2VLVrGvaF8QaHz6tnGOx4ANvXJyqYfYQ7LG3wFJpPbc0fibjQ/132" width="30px"><span>只为更好明天~</span> 👍（0） 💬（0）<div>数据校验时为何是用binlog作触发，直接用binlog中的数据比较不行吗</div>2025-02-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/17/4d/7e13ec93.jpg" width="30px"><span>彭俊</span> 👍（0） 💬（0）<div>请教老师几个问题：
关于利用binlog校验和修复的数据，
1. 有办法直接通过go语言获取binlog吗？
2. 我目前已知的是，通过canal伪装成从库接收binlog。如果用这个方案，会有以下问题：1. 比起update_time方案，这个方案重很多。2. 引入新的中间件，考虑这个中间件的可用性和维护成本。老师是怎么看这两个缺点的。</div>2024-09-16</li><br/><li><img src="" width="30px"><span>Geek_175c29</span> 👍（0） 💬（0）<div>一次双写，你可能立刻就收到了源表的 binlog，但是你过了好久才收到目标表的 binlog。这样会有什么问题吗。没看懂</div>2024-09-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/93/02/fcab58d1.jpg" width="30px"><span>JasonZhi</span> 👍（0） 💬（0）<div>请教一下老师；旧表一直处于高频写入的状态，然后双写切换为新表作为主导；但是此时新表依然是落后于旧表的进度；开始增量校验修复后，旧表较新的数据反而被新表所覆盖；</div>2024-09-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/3b/5c/79/efa0f16f.jpg" width="30px"><span>Haapy</span> 👍（0） 💬（0）<div>老师，增量校验和修复那一小节的binlog方案有疑问，就是如果我双写用的是aop，利用binlog监听源表，那是不是在写目标表之前，binlog就监听到源表发生改变而触发校验和修复操作了，那这校验和修复感觉没意义啊</div>2024-07-18</li><br/>
</ul>