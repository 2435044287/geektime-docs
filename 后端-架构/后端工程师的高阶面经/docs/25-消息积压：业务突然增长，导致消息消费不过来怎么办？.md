你好，我是大明。今天我们来学习消息队列中消息积压问题的解决办法。

我们说的消息积压是指消息生产速率大于消费速率，所以消息会在broker上存放着。消息积压可能会导致消息要等很久才会被消费，这对于一些业务来说损害很大。特别是一些对消息消费时效性有要求的业务，几乎不能容忍任何程度的消息积压。

消息积压在实践中是一个很容易遇到的问题，尤其是如果你所在的公司处在快速扩张期。因为在实践中很常见，所以在面试中消息积压也是一个热点题目。而大部分人面试的时候，只会说增加分区，又或者说异步消费，但是很难深入讨论。

其实消息积压的解决方案有很多，一会儿我就带你一个一个看。

## 消费者和分区的关系

在 Kafka 里面，一个分区只能有一个消费者，但是一个消费者可以同时消费多个分区。也就是说，如果你有 N 个分区，那么最多只有 N 个消费者，这个时候再增加消费者已经不能提高消费速率了。如果不足 N 个消费者，那么就会有一些消费者同时从多个分区里面拉取数据。

![图片](https://static001.geekbang.org/resource/image/c9/41/c9172f4079d1f90eb45d2a99dbab9a41.png?wh=1920x811)

这种设计导致我们不能无限制地增加消费者来解决消息积压问题。反过来说，但凡没这种限制，也就没有消息积压这回事了。

## 确定分区数量

消息积压也可以看作是分区数量不足引发的问题，毕竟如果分区数量多，就意味着消费者多，消费者足够就肯定不会产生消息积压的问题。所以为了避免消息积压，就要求你在使用消息队列的时候想清楚你需要几个分区。
<div><strong>精选留言（12）</strong></div><ul>
<li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eooNCNEO0vhRiagdrCnNW2LWzzV4g5tXJ9KkTu9hegCTx6lBrA06AZ3Uylb2wdKjvtrmZUWkKKHTGA/132" width="30px"><span>TimJuly</span> 👍（8） 💬（1）<div>在出现消息积压的时候，能不能在生产者发送的时候加个限流？
---
这个要看是什么原因导致的积压
如果是消费方能力不足导致的那就不应该给生产者加限流
如果是生产者出 bug 了，写了个死循环拼命生产消息，那么该加限流还是要加的，毕竟 MQ 它性能再高也是需要进行保护的，更别说下游系统了。</div>2023-08-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/dc/08/64f5ab52.jpg" width="30px"><span>陈斌</span> 👍（5） 💬（2）<div>有些人认为，优化生产者性能也能解决消息积压，你觉得能还是不能？为什么？
我认为这是一个没有标准答案的问题，主要看对消息积压这个名词的理解；例如整个流程是生产者拿到消息（从前端、其他上游组件甚至说另一个消息队列中）之后处理的很慢，导致写入消息队列速度很慢，而消费者都是实时消费生产者产生的消息。从整体流程上来看好像消息积压确实是在生产者这里，但是如果你把消息积压理解的更狭隘一点，消息积压中的消息你认为是消息队列中的消息，只看最后一段流程，生产者都没有生产消息，何来消息积压之说。

在出现消息积压的时候，能不能在生产者发送的时候加个限流？毕竟，限制住了发送消息的速率，自然就解决了消息积压。
看具体业务，如果业务流程中在流量高峰期确实可以做限流操作，那确实可以限制住最高的流量生产速度，如果所有消费者的消费速度确实可以cover住所有生产者的生产速度，自然就可以解决消息积压问题。此时的消息积压一般是瞬时流量徒增导致的。</div>2023-08-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/44/48/fae317c1.jpg" width="30px"><span>子休</span> 👍（2） 💬（1）<div>有些人认为，优化生产者性能也能解决消息积压，你觉得能还是不能？为什么？
优化生产者性能可以从一定程度上缓解消息积压，比如kafak的批量读写和压缩的特性，就是提升了高吞吐，以及本文中提到的聚合消息和批量消费也是优化了生产者发送。


在出现消息积压的时候，能不能在生产者发送的时候加个限流？毕竟，限制住了发送消息的速率，自然就解决了消息积压。
如果在生产者上面加限流，那么消息中间件的削峰作用也就丧失了。虽然这样限制了发送消息的速率，看似解决了消息积压，但是消息中间件本身的削峰特性就大大丧失了，有点得不偿失。
另外，如果生产者自己做限流的话，很可能会对生产者本身造成巨大的资源负担，因为这样会导致生产者被限流限制，要持续不断地运行逻辑发消息。</div>2023-08-15</li><br/><li><img src="" width="30px"><span>Geek8004</span> 👍（1） 💬（1）<div>假如批量消费10条数据,第9条数据消费失败,采用异步重新执行的方案,那成功执行的剩下9条数据会提前先提交吗?假如异步这个线程充实了好多次都没成功咋办,这会不会造成了消息丢失了呀~
第二个问题,老师您能分享一节幂等方案的课程吗?</div>2023-08-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/69/bf/58f70a2a.jpg" width="30px"><span>程序员花卷</span> 👍（0） 💬（1）<div>异步消费这个没太理解，比如RocketMQ默认就是使用线程池消费消息的，那这个异步消费还要怎么加，老师是否能给点具体的思路？一堆消息取出来之后再塞入某个本地队列然后进行异步的消费吗？</div>2023-12-08</li><br/><li><img src="" width="30px"><span>kai</span> 👍（0） 💬（1）<div>请问老师，有个问题一直没有解决，想咨询一下您。问题是这样的：

我们有一个消费者应用（同一个消费组下有 16 个消费者），部署在上海，消费深圳的 Kafka 集群的一个 Topic（16 个分区），消费之后在内存中，取出部分字段，通过 16 个生产者将数据异步发送到上海 Kafka 集群。

去年同期，消费的性能大概在 6300 QPS，但是今年大概只有 3000QPS，深圳和上海 Kafka 集群没有变化，消费应用没有变化，消费应用所在的服务器也没有变化，CPU 内存使用率大概在 50% 左右。

比较奇怪的一点是消费带宽一直没有上去。

消费应用的消费者参数：
fetch.min.bytes：100000

生产者参数：
batch.size：200000
linger.ms：100
compress.type：lz4

客户端做了各种尝试也没有提高性能，怀疑是上海到深圳之间基础网络层面有问题，但是又无法证明，因为这条路上没办法抓包。

请问一下，这种情形下如何提升消费 QPS 呢？</div>2023-10-14</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/eAXOa0O1reSCoMRUK9V4NgVlRsiaRZicvRLczuzxsKq82jUscVuwgF8WVPEQI1wL3fruo3icnPv8fmv9q2ab1jRrw/132" width="30px"><span>chooseTime</span> 👍（0） 💬（1）<div>有代码实例实战吗</div>2023-10-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/45/b9/3db96ade.jpg" width="30px"><span>锅菌鱼</span> 👍（0） 💬（1）<div>异步消费不是一个好的方案，MQ提供重试就没用了，少了一层业务保证</div>2023-09-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/da/d9/f051962f.jpg" width="30px"><span>浩仔是程序员</span> 👍（0） 💬（1）<div>最后总结的思维导图，增加分区那里有两个点重复了，都是根据消费者速率计算新的分区数量</div>2023-09-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg" width="30px"><span>peter</span> 👍（0） 💬（1）<div>对于消息重复消费，业务有不是幂等的情况吗？ 如果不是幂等，该怎么处理？</div>2023-08-14</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ep075ibtmxMf3eOYlBJ96CE9TEelLUwePaLqp8M75gWHEcM3za0voylA0oe9y3NiaboPB891rypRt7w/132" width="30px"><span>shuff1e</span> 👍（0） 💬（1）<div>在出现消息积压的时候，能不能在生产者发送的时候加个限流？
------
感觉还是要回到系统的本质，而不是为了解决问题而解决问题。
消息队列本来就是削峰填谷，如果不让消息队列积压，那就会积压在生产者那里。</div>2023-08-14</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/YbUxEV3741vKZAiasOXggWucQbmicJwIjg3HDE58oyibYXbSop9QQFqZ7X6OhynDoo6rDHwzK8njSeJjN9hx3pJXg/132" width="30px"><span>黄堃健</span> 👍（0） 💬（0）<div>候有两种做法，一种是直接启动足够数量的消费者去消费新老 topic 上的消息，在老 topic 上的消息消费完毕之后就可以停掉老的 topic 上的消费者了。另外一种做法是启动几个消费者，这些消费者会把老的 topic 上的消息转发到新的 topic 里面。同时启动消费者消费新的 topic。 ---  老师，采用新的topic不怕有消费失序的问题吗？</div>2024-05-27</li><br/>
</ul>