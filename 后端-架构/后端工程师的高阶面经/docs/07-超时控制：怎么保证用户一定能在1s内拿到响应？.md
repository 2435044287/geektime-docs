你好，我是大明。今天我们来聊一个非常常见但是经常被忽略的话题——超时控制。

和前面我们讲的熔断、限流、降级和隔离一样，超时控制也是构建高可用系统的一环，因为**它能够节省系统资源，提高资源的有效利用率。**

一般在面试的时候，关于超时控制，被问得最多的问题就是调用某个接口时的超时时间是多长，以及你为什么认为这个超时设置是合理的。一般我们都能给出一个差不多的回答，不过如果你能够在超时控制的话题下稍微深入一点，比如聊一聊监听超时时间、链路超时控制，那你绝对能成为所有候选人中最靓的仔。

所以今天我就带你来了解超时控制的方方面面，同时会给出全链路超时控制方案，让你在面试中更加出彩。

## 前置知识

超时控制是一个非常简单的东西，它是指在规定的时间内完成操作，如果不能完成，那么就返回一个超时响应。

和超时控制有关的内容，你需要记住以下几点：

- 超时控制的目标或者说好处。
- 超时控制的形态。
- 如何确定超时时间？这会是一个面试热点。
- 超时之后能不能中断业务？
- 谁来监听超时时间？

那么我们一个个看。

### 超时控制目标

超时控制有两个目标，一是**确保客户端能在预期的时间内拿到响应**。这其实是用户体验一个重要理念“坏响应也比没响应好”的体现。

![图片](https://static001.geekbang.org/resource/image/b4/49/b4541b78dc513da2591028a317404d49.png?wh=1920x1158)

二是**及时释放资源**。这其中影响最大的是线程和连接两种资源。
<div><strong>精选留言（16）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/11/0a/59639f1f.jpg" width="30px"><span>penbox</span> 👍（18） 💬（1）<div>1. 在根据被调用接口的响应时间来确定超时时间里面，提到可以使用 99 线或 999 线来作为超时时间。那么平均响应时间和响应时间的中位数，能不能作为超时时间？
不能，这意味着一半的请求都会超时，业务基本处于不可用的状态了。
2. 在监听超时那里，能不能只在服务端那边监听超时，而客户端完全不管？
我觉得不行，客户端不能保证所有服务端都是做了超时控制的，也不能保证请求就一定就能到服务端那边。
假如发生了网络故障，服务端根本收不到请求，客户端本地没做超时控制的话，就会发生线程泄露。</div>2023-07-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/cb/a2/5e7c557e.jpg" width="30px"><span>傲娇的小宝</span> 👍（2） 💬（1）<div>关于问题一：我和马云一平均我也资产上e呢，中位数对于超时场景没有意义。而且既然是中，说明有一半达不到，那服务总不能只为剩下能达到的提供正确返回呐。
关于问题二：如果客户端不管，不太保险，因为是否超时就完全取决于服务端了，一方面可能与业务要求不符，另一方面可能引发一些无法判断的问题。</div>2023-10-31</li><br/><li><img src="" width="30px"><span>Geek_680632</span> 👍（1） 💬（1）<div>1.不能，这里需要考虑的是最差的情况；2.不行，客户端需要在超时展示相应的处理方案。</div>2023-10-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/da/d9/f051962f.jpg" width="30px"><span>浩仔是程序员</span> 👍（1） 💬（1）<div>在调用第三方接口设置超时时间还应该考虑接口的qps，服务部署导致的网络因素等，如果qps很高，超时时间太长，就容易把自己系统的线程打爆</div>2023-07-27</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/YbUxEV3741vKZAiasOXggWucQbmicJwIjg3HDE58oyibYXbSop9QQFqZ7X6OhynDoo6rDHwzK8njSeJjN9hx3pJXg/132" width="30px"><span>黄堃健</span> 👍（0） 💬（1）<div>大明哥， 根据代码计算和我在限流里面讲的差不多。假如说你现在有一个接口，里面有三次数据库操作，还有一次访问 Redis 的操作和一次发送消息的操作，那么你接口的响应时间就应该这样计算：   一般代码都是多分支，似乎不好估算</div>2024-04-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/4c/b5/fcede1a9.jpg" width="30px"><span>IT小村</span> 👍（0） 💬（1）<div>上下游反了吧</div>2023-11-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/44/cf/791d0f5e.jpg" width="30px"><span>ZhiguoXue_IT</span> 👍（0） 💬（1）<div>现在的开发接口的时候，都给前端承诺当前接口的tp99，之前没实现过在服务端自己控制时长，也就是服务端是如何控制如果1s没有执行完就给客户端返回特殊的值？</div>2023-07-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/08/ab/caec7bca.jpg" width="30px"><span>humor</span> 👍（0） 💬（2）<div>原则上是看公司的可用性要求，要求几个 9 就要几个 9。如果没有硬性规定，那么看 99 线和 999 线相差多不多。不多的话就用 999 线，多的话就用 99 线。

这里为什么99线和999线差的多的话用99线呢？如果两者差距比较大，不是应该选999线更好吗，这样超时报错会少很多</div>2023-07-14</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqw0R25Bt0iahFhEHfnxmzr9iaZf0eLsDQtFUJzgGkYwHTqicU9TydMngrJ4yL7D50awD2VibHBAdqplQ/132" width="30px"><span>Geek_18dfaf</span> 👍（0） 💬（1）<div>老师，在哪些微服务框架里面，服务端做了超时时间的监听</div>2023-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2e/11/86/3ef486e0.jpg" width="30px"><span>信客</span> 👍（0） 💬（2）<div>老师，针对“用户看到失败响应，但实际已经执行成功”这种现象
1. 感觉不论是客户端监听，还是客户端和服务端都监听（比如，服务端执行完了，但恰好在传输结果时，客户端发生超时，返回了失败响应），都可能发生这种现象？
2. 站在用户的角度来说，很confusing，明明看到失败，但第二次说已经有人注册。这种情况一般要怎么处理呢？</div>2023-07-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg" width="30px"><span>peter</span> 👍（0） 💬（1）<div>请教老师几个问题：
本课有一个疑问：
Q1：“释放资源”，服务端也有这个需要吧。
超时后释放资源，文中都是针对客户端讲的。服务端没有释放资源这个需求吗？

下面是02课的问题，因为我阅读的晚，所以也发的晚，这里补上：
Q1：“客户端”并不是指终端，对吗？
本课中用到的“客户端”，我理解并不是通常意义上的网页或APP，而是相对于“服务端”的客户端；从后面的内容来看，也不是指Nginx或网关。那在微服务架构中，具体是指什么？
Q2：哈希算法怎么保证均匀吗？
文中“所以要尽可能保证哈希值计算出来的结果是均匀的”，有什么具体方法来保证哈希的均匀性？
Q3：负载均衡有多种算法，对于一个公司来说，是确定用其中的某一种吗？或者是不同的子系统可能采用不同的算法？或者有多种算法，会根据情况动态选用其中的某一种？
Q4：“响应+元数据”这种，消息是怎么发送的？
响应是给用户的，通常就是HTTP消息，元数据是内部用的，这两种怎么处理？定义一个内部消息，包含这两种，Nginx收到后取出元数据然后将响应发给用户吗？
</div>2023-06-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg" width="30px"><span>木几丶</span> 👍（0） 💬（1）<div>回答问题：
1、我觉得不能，暂时想不出用中位数或平均值作为超时时间的场景，当然可能有特殊业务场景也为可知
2、不能。服务端可以不管，客户端一定要管，因为请求经过网络，不一定会到达服务端，或者说到达服务端的时间不可控</div>2023-06-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d0/91/89123507.jpg" width="30px"><span>Johar</span> 👍（0） 💬（1）<div>1.超时时间主要看的大部分请求的响应时间，一般情况下，都是选择T99或者T999。当然具体问题具体分析，要是当前业务有长尾效应，也可以取平均响应时间或者响应时间中位数。
2. 客户端也需要监听是否超时，一般ToC的业务，客户端的请求要通过公网才能到达后端，公网的网络情况有很大未知性，不可控，也有一定的丢包率，所以在客户端监听超时，可以给客户更好的用户体验，另外也就将超时数据传回服务端，作为监控指标，方便后续优化。</div>2023-06-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/e8/55/63189817.jpg" width="30px"><span>MClink</span> 👍（0） 💬（1）<div>作为中台后端，经常被要求提高相关的公共接口性能，以避免拖前台的后腿。对于超时控制，日常用的最多的还是对服务的自我保护，避免由于调用第三方服务(下游服务，第三方接口，数据库等)，在第三方由于各种问题导致长时间不返回，导致调用方而无法及时释放协程等资源，也无法释放内存，在突然的大流量情况下，很容易出事故。因此，业务方代码会有超时控制，网关层也可以设置超时。</div>2023-06-30</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eooNCNEO0vhRiagdrCnNW2LWzzV4g5tXJ9KkTu9hegCTx6lBrA06AZ3Uylb2wdKjvtrmZUWkKKHTGA/132" width="30px"><span>TimJuly</span> 👍（0） 💬（3）<div>这篇感觉有点儿跑题了
要在规定时间内做出响应，无非就是提高并发度，做好性能优化、缓存优化、强弱依赖的容错等，文章中提到的不多，建议后面也讲讲～
文章里提到的的超时时间传递和超时控制策略我感觉更多的是解决容量问题，防止服务雪崩</div>2023-06-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/31/12/35/4ca3cc7d.jpg" width="30px"><span>lip</span> 👍（0） 💬（0）<div>请问在应用链路超时场景下，如果出现数据重复的场景该如何处理？判断是否超时，然后选择是否回滚吗</div>2024-03-26</li><br/>
</ul>