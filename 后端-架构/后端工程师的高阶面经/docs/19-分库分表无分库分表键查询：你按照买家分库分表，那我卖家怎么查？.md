你好，我是大明，今天我和你来聊一聊分库分表下的一种特殊的查询——无分库分表键查询。

在很多业务里面，分库分表键都是根据主要查询筛选出来的。那么就会有这样一个问题，那些不怎么重要的查询怎么解决呢？

比如说大多数电商的订单都是按照买家 ID 来进行分库分表的，那么商家该怎么查询订单呢？又或者买家找客服，客服要找到对应的订单，又该怎么找？在面试分库分表的过程中，这也算是一个常见的问题。

如果你对分库分表不是很熟悉，可能根本想不到这里面会有什么难点。那么今天我就带你看看怎么解决这个问题，以及如何将多个解决方案整合在一起打造一个复杂的亮点方案。

## 分库分表键选择

分库分表键是指你选择进行分库分表的业务字段，有些时候会有多个字段。那怎么选择合适的字段呢？

一句话：**根据查询来选择**。例如在订单里面，最常见的是按照买家进行分库分表。理由很简单，买家查询自己的订单是最主要的场景。既然买家查得多，买家的服务体验也更加重要，所以选择买家 ID 进行分库分表收益最大。

你也可以看到这个完全是业务驱动的。最常用的分库分表键有主键、外键、索引列。如果是范围分库分表，那么日期类型的列也很常用。

有些人喜欢把分库分表键的选择说得仿佛非常艰难，实践中根本不是这样的，因为事实上你根本没有多少个候选项。再结合业务，很快你就能选出合适的分库分表键。
<div><strong>精选留言（8）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/14/d7/b8/c42d2527.jpg" width="30px"><span>Jason Ding</span> 👍（3） 💬（2）<div>面试的时候被问到这个问题我都会加一个回答，公司有实时数仓，对 TO B实时性要求不高的查询 我们都会基于数仓做成宽表，再基于es提供查询。</div>2023-09-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/67/3d/71031021.jpg" width="30px"><span>nadream</span> 👍（1） 💬（1）<div>引入中间表的问题：中间表包含了全部分表的全部行，虽然只包含了少量字段，那么这个表数据行数会非常大，查询也存在很大的性能问题吧？</div>2024-01-22</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/sPKlUGmy9ic45Ky4Oq13poOtwGEcicszKswahLMdXh8lWpiaIy8g9OPFvdQVgCxBAFeXWUIWHVTiaRLU2oEWkxbdiaw/132" width="30px"><span>Geek_be29f8</span> 👍（0） 💬（2）<div>老师，有一种查询场景帮忙分析下：
数据量级很小，万级，但是字段数极多，成百上千的字段，且存在一些查询场景，最差情况下真的要求允许上百个查询字段条件同时存在，建立这么多字段的联合索引根本不现实。这种情况下应该怎么做，使用es 等来做合适吗，帮忙分析下</div>2024-01-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2a/44/e6/2c97171c.jpg" width="30px"><span>sheep</span> 👍（0） 💬（1）<div>老师有几个问题，没接触过分库分表场景有点懵：
(1) &quot;比如说大多数电商的订单都是按照买家 ID 来进行分库分表的，那么商家该怎么查询订单呢？又或者买家找客服，客服要找到对应的订单，又该怎么找&quot;，这里查询对应订单的话，一般都是用订单id直接去查的吧，然后订单id中如果夹带买家ID信息，不就可以定位到对应库和表了么？那这里担忧的是什么个场景呢（难道是订单id可能不是通过夹带买家ID这种情况？也就是订单id内啥用户信息都没有的情况？），可以展开sql说一下咩
(2) “引入中间表”这里，&quot;记录了 ID、卖家 ID、买家 ID 三个数据&quot;，这里第一个ID指的是订单id？
(3) ES用来解决分库分表中间件解决不了的问题，那MongoDB也同样可以使用吧？</div>2023-11-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/da/d9/f051962f.jpg" width="30px"><span>浩仔是程序员</span> 👍（0） 💬（1）<div>老师讲的挺好的。之前我也想过这个问题，比如短视频的存储，一般按照视频id去分表，但通过用户id查询自己的视频很正常，后面了解到除了视频id分表外，还有根据建表的索引如用户id去构建另外一个分表，当然存储的字段比较少，这个是代理proxy做的，空间换时间</div>2023-09-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg" width="30px"><span>peter</span> 👍（0） 💬（1）<div>请教老师几个问题：
Q1：老师工作的公司一般怎么用分库分表的，包括中间件的选型等。
Q2：文中老师对业务查询用了“变幻莫测”，在比较大的互联网公司，业务查询是一件非常麻烦的事情吗？（本人没有在互联网公司工作过，没有体会）
Q3：ES也可以当做分库分表中间件吗？第一次听说。</div>2023-07-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/44/cf/791d0f5e.jpg" width="30px"><span>ZhiguoXue_IT</span> 👍（0） 💬（1）<div>1）关于跨进程重试，简单来说就是不在一个进程执行任务，作为异步mq的消费方是一套集群，重试的时候轮循选择节点进行重试，阿里的rocketmq重试16次进行死刑队列，人工处理
2）之前也没涉及过这种业务，数据如果存放两份，高并发的情况下必然会出现数据不一致
2）对于大数据量的搜索，业界内大部分厂商会借助Elasticsearch的搜索能力，我在用Elasticsearch会发现在创建索引的时候，要制定刷盘的时间，一般都是设置的1s，为了减少压力，此时就会出现用户在插入es后，然后进行查询，并没有获取到，作者有遇到过吗</div>2023-07-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d0/91/89123507.jpg" width="30px"><span>Johar</span> 👍（0） 💬（1）<div>1. 我们目前主要是使用分布式任务调度对失败的任务进行重试
2. 有可能，造成原因是商家服务，订单服务收到的事件的时序不一样造成
3. 老师有没有什么好的方法解决分库分表在扩容或者缩容或者节点故障造成数据迁移的方案？</div>2023-07-28</li><br/>
</ul>