你好，我是大明。今天我们继续学习微服务架构，这节课我们讨论一个新的主题：熔断。

在微服务架构里面，熔断-限流-降级一般是连在一起讨论的，熔断作为微服务架构可用性保障的重要手段之一，是我们必须要掌握的，而且要能够说清楚自己在实践中是怎么利用熔断来提高系统的可用性的。

所以今天我就来给你梳理一下关于熔断有哪些知识是我们必须要掌握的，另外我还会在这个基础上给你提供一个全方位的熔断面试方案，帮助你在面试中脱颖而出。

## 前置知识

熔断在微服务架构里面是指当微服务本身出现问题的时候，它会拒绝新的请求，直到微服务恢复。

![图片](https://static001.geekbang.org/resource/image/5c/3f/5cd51264668d564aa59b7c4630e3913f.png?wh=1920x716)

看图，你会不会觉得有点困惑？服务端明明返回了错误的响应，怎么还说熔断提高了系统的可用性呢？

答案就是**熔断可以给服务端恢复的机会**。试想这么一个场景，CPU 使用率已经100%了，服务端因此触发了熔断。那么拒绝了新来的请求之后，服务端的 CPU 使用率就会在一段时间内降到100%以内。

回到熔断的基本定义上来，我们可以提炼出两个点进一步讨论。

- 怎么判断微服务出现了问题？
- 怎么知道微服务恢复了？

接下来我们要讨论的亮点也是围绕这两个方面来进行的。

### 判定服务的健康状态

第一个问题，判断微服务是否出现了问题，它有点儿像我们在负载均衡里面讨论的动态算法。本质上也是要求你根据自己的业务来选择一些指标，代表这个服务器的健康程度。比如说一般可以考虑使用响应时间、错误率。
<div><strong>精选留言（29）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/11/0a/59639f1f.jpg" width="30px"><span>penbox</span> 👍（13） 💬（3）<div>在负载均衡和熔断两节课都提到了一个关键点，如何判断一个服务是否处于健康状态，这方面你有什么自己的思考？
学习了目前这两节课，我感觉服务端节点目前是什么状态，都是靠猜测或试探来得到的。
在负载均衡算法里面，靠连接数或响应时间来判断服务器权重，这两个指标都是客户端对服务端状态的猜测，并不是服务端的真实情况。动态调整权重里面的成加败减，要反复试探多次，才能把权重调整为正确的服务端状态。  
在熔断这里，熔断之后到底恢复没有，不管是服务端和客户端都不知道，只能放点流量过去试一试。  
目前好像还缺少手段来判断服务端当前的真实情况。有没有可能类似注册中心一样，在微服务框架中引入一个”健康中心“。每个服务端根据若干个指标，对自己打一个分，定时上报给健康中心。不管是客户端还是服务端自己，发现不对劲的时候，去健康中心里找到服务端对应的分数，就能直接判断出这个服务端的真实情况。</div>2023-07-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/7b/5a/9cde8618.jpg" width="30px"><span>Bin</span> 👍（11） 💬（1）<div>What : 什么是「熔断」
在微服务架构里面是指当微服务本身出现问题的时候，它会拒绝新的请求，直到微服务恢复。

Why：微服务架构为什么要使用「熔断」
可以给服务端恢复的机会
个人理解：
「熔断」机制就是在系统高负载&#47; 服务崩溃的时候，拒绝新的请求。相当于提供给服务&#47;系统一段“喘息”时间，“喘息”时间的意义在于：
1. 服务端不再接受新请求，服务的负载可以降低下来，防止服务雪崩
2. 服务端崩溃的情况下，可以重启服恢复务，可以理解为是一种故障转移（failover）手段
3. 上游服务收到「熔断」信息返回，可以进行兜底方案处理：例如业务补偿、请求转发、同步转异步等

When：什么时候进行和结束「熔断」
微服务本身「出现问题」的时候
「熔断」的开始和结束时机判断就在于以下问题的判断：
1. 判断微服务出现问题
2. 判断微服务恢复服务

「熔断」开启：判断出现问题
判断健康状态
1. 选择业务「指标」
每个微服务实际上都是附带着业务属性（微服务的划分是根据业务的职责和边界来划分）
所以可以根据业务来选择「指标」来代表微服务的健康状态。
常见的指标可以是：「响应时间的99线」，「错误率」等
2. 设置合适的「阈值」
这也是根据业务来决定的。
假设我们选择「响应时间」作为指标。
● 根据业务要求的「指标」阈值设置
● 观察业务整体的「指标」来设置
3. 设置持续多长时间才触发「熔断」
需要持续一段时间之后才触发「熔断」，因为：
● 防止「指标」 偶发性的突然增长
● 防止「服务抖动」
「持续时间」的设置，依赖个人经验

「熔断」结束：判断恢复服务
现状：大多数是触发「熔断」后保持「一段时间」，就认为服务已经恢复正常，继续处理新请求
存在的问题：「抖动」
解决方案：
1. 「服务端控制流量」：恢复服务之后，比如说10%，20%逐步递增，不是100%恢复流量
这种做法不够好。依旧有请求因为熔断不会被处理。
2. 「客户端控制流量」：服务端熔断后，客户端不再请求这个节点，而是换一个节点。恢复之后，客户端逐步放开流量

亮点方案：客户端结合「负载均衡」控制流量，解决「抖动」问题

Question
面试中，经常在你讲完一些场景解决方案之后，面试官就会问你有自己实现吗？或者有没有落地在自己的项目中？如果回答有，面试官就会问遇到过什么问题没有？你回答没有，感觉自己给面试官的感觉又只是停留在理论上，没有实践经验。想问老师，对于类似这些问题，应该怎么去破局呢？</div>2023-06-28</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epRstZOx9oC1zrJuyZqomSYWTsDuXe5W2KSIRXvm8PDEWtICVGQibhiay5ibbEZFibYKopyhQnOYbcYpg/132" width="30px"><span>Geek_948740</span> 👍（7） 💬（1）<div>同问 这篇文章里的客户端是指什么 app和电脑的话做这些策略成本很高吧</div>2023-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/ac/23/8eb08fdf.jpg" width="30px"><span>小手冰凉*^O^*</span> 👍（7） 💬（2）<div>老师好，业界好的熔断方案都是怎么做的呢？</div>2023-06-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/8c/7a/5ee20222.jpg" width="30px"><span>小晨</span> 👍（6） 💬（1）<div>是否存在这种场景，通过客户端控制流量，熔断某个服务，将原本应该给这个服务的流量给其他节点，导致其他节点因为流量增加也导致也触发熔断，即原本可能只要熔断一个节点，但因为这个节点熔断了，流量分给了其他节点，其他节点的压力增加，进而触发熔断，造成&quot;雪崩&quot;？</div>2023-07-04</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI8qibAw4lRCic1pbnA6yzQU3UqtQm3NqV1bUJ5EiaUnJ24V1yf4rtY7n2Wx7ZVvTemqq5a61ERWrrHA/132" width="30px"><span>Alex</span> 👍（4） 💬（1）<div>请教一下大明老师 在亮点一节 是否可以用网关来解决? 由网关（比如kong）不管是检测各个服务节点的主要指标也好 还是服务端主动上报需要熔断信息也好。 如果节点健康就允许开放节点 如果不健康就下架节点保护服务。</div>2023-09-30</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eooNCNEO0vhRiagdrCnNW2LWzzV4g5tXJ9KkTu9hegCTx6lBrA06AZ3Uylb2wdKjvtrmZUWkKKHTGA/132" width="30px"><span>TimJuly</span> 👍（4） 💬（1）<div>引申一个问题，发现故障时（可能是自身引起，也可能是下游引起），怎么判断是单机故障还是集群故障</div>2023-06-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/34/56/fe22bae8.jpg" width="30px"><span>xyu</span> 👍（2） 💬（2）<div>为什么说客户端利用负载均衡来控制流量相比服务端逐步放开流量是亮点方案？
我说一下我的理解，不知道对不对：
从整个系统来看，使用客户端控制流量的方案使得整个系统的可用性更好；客户端通过调用返回情况来调整权重，交互的过程实际上也是一个考察对方恢复情况的过程，然后根据你的恢复情况来加大流量，从而避免服务器又再次陷入熔断；如果使用服务端逐步放开流量的方案，机械地按比例的放开很可能会让服务器再次陷入熔断。</div>2023-06-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2a/44/e6/2c97171c.jpg" width="30px"><span>sheep</span> 👍（1） 💬（1）<div>有两个问题：
1. &quot;这个持续三十秒是如何计算出来的？这个问题其实可以坦白回答是基于个人经验，然后你解释一下过长或者过短的弊端就可以了。&quot;，面试官要是问，从哪些经验了解到要怎么设计的呢，15秒或者35秒不行吗，这时候该怎么回答呢
2. 熔断是服务端去提示客户端的话，现在也就有普遍使用的熔断中间件么，还是说是在服务器代码内实现的呢</div>2023-08-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/06/b9/f9bf6696.jpg" width="30px"><span>牧童倒拔垂杨柳</span> 👍（1） 💬（1）<div>在负载均衡和熔断两节课里面都提到一个关键点，即如何判定一个服务是否处于健康状态，这方面你有什么自己的思考？
        这个关键点是服务端都相对被动，都需要等待客户端或者其他服务来检测状态
        在负载均衡中，静态负载均衡算法是不考虑服务端的状态的，算法决定选谁就是谁，所以会出现各个服务端节点负载不可控的情况。动态负载均衡算法会去探测服务端状态，最少连接数是看连接数量，最少活跃请求是客户端看有多少请求还没回来，最短响应时间是客户端观察平均最短响应时间，在几种算法中，服务端都相对被动，不能主动做什么
        在熔断这一课中也是这样，在熔断恢复时，不管是服务端控流量，还是客户端控流量，都是服务端基本都是被动等待
        所以我在思考是不是可以借鉴负载均衡课程中的亮点方案，在某个服务端节点熔断之后，客户端收到熔断请求，此服务端节点被移出可用列表，此服务端节点在注册中心肯定也是不可用的，那么是不是可以谁都不去探测，等服务端恢复后，主动向注册中心上报自己恢复了。客户端要做的是等待一段时间后，定时向注册中心询问，某个服务端节点是不是恢复了。如果注册中心出问题了，这个时候客户端是一定要根据可用节点列表探测服务端是否可用的，顺带着就可以把触发熔断的服务端节点探测一下</div>2023-08-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/da/d9/f051962f.jpg" width="30px"><span>浩仔是程序员</span> 👍（1） 💬（2）<div>老师，你好。我们系统目前是没有熔断机制的。我在思考，当一个系统需不需要熔断机制时取决于业务允不允许，熔断的时长对业务来说就是不可用，目前来说，我们是通常cpu使用率，内存使用率，上游调用失败或超时率等监控指标进行告警，人工进行恢复。另外，对于一些链路，为了不要上游直接打爆，可以通过消息队列异步去消费。我想问下老师，您具体负责的系统中是什么业务使用了熔断机制</div>2023-07-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0c/e1/f663213e.jpg" width="30px"><span>拾掇拾掇</span> 👍（1） 💬（1）<div>我好奇这个试探性放点流量是怎么放？count计数下几个然后就不放，等待放进去流量的响应情况吗</div>2023-07-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/5e/81/82709d6e.jpg" width="30px"><span>码小呆</span> 👍（1） 💬（3）<div>我们是夜莺,上面写一个监控脚本,定时去请求对应服务的接口,一旦有服务请求不通过,就在群里实现告警,不过,如果公司的项目都上了prometheus ,一旦流量请求出现问题,就直接在企微群发送告警,这样子应该也是可以的</div>2023-06-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/cc/50/5f13250d.jpg" width="30px"><span>hurrier</span> 👍（1） 💬（2）<div>大明老师 如果请求下流qps很低 比如几分钟才请求一次 按错误率、响应时间熔断感觉都不准确，有更好的方案吗</div>2023-06-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg" width="30px"><span>peter</span> 👍（1） 💬（1）<div>请教老师两个问题：
Q1：服务恢复框架做得不好，是因为这个问题本身难以解决吗？
文中“很可惜，这方面微服务框架都做得比较差。大多数情况下就是触发熔断之后保持一段时间，比如说一分钟”。 为什么框架做得差？是投入不够？还是说此问题本身难以解决？或者说难以解决是微服务架构本身固有的问题？
Q2：熔断以后的恢复，业界一般是怎么做的？人工干预吗？</div>2023-06-21</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/YbUxEV3741vKZAiasOXggWucQbmicJwIjg3HDE58oyibYXbSop9QQFqZ7X6OhynDoo6rDHwzK8njSeJjN9hx3pJXg/132" width="30px"><span>黄堃健</span> 👍（0） 💬（1）<div>大明老师，持续超过阈值在线上有时是不可控，因为每个api几乎都改来改去。 一旦一个api发生了变更，你很难控制阈值。 所以可以针对采集cpu的数据可以做到不用为改阈值而烦劳。 </div>2024-04-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/24/cb/351f102a.jpg" width="30px"><span>黑白之间的影像</span> 👍（0） 💬（1）<div>99线是什么意思呢？</div>2024-04-14</li><br/><li><img src="" width="30px"><span>Geek_8755c4</span> 👍（0） 💬（2）<div>为什么响应时间是由产品经理来设定的？这不有点搞笑吗？</div>2023-11-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7e/57/8c1051b6.jpg" width="30px"><span>3.0的A7</span> 👍（0） 💬（1）<div>-- 你们公司是怎么判断微服务出现故障的？比如说错误率、响应时间等等。

熔断的粒度是服务级别的吗？如果只是单一接口出了故障，难道要熔断整个服务吗？
</div>2023-10-11</li><br/><li><img src="" width="30px"><span>Geek_680632</span> 👍（0） 💬（1）<div>判断一个节点是否在线常见的方案是心跳检测，而判断节点是否处于健康状态使用的是响应时间，因为请求属性不同，在阈值的判断上需要预留一定的空间；
检测超时之后，会面临两种情况：可恢复异常、不可恢复异常；</div>2023-10-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/fa/03/eba78e43.jpg" width="30px"><span>风清扬</span> 👍（0） 💬（2）<div>我们目前的广告推荐系统中，更多的是监控服务端的机器cpu 内存 连接数等使用情况，当然也对流量波动予以监控，流量突增时相应的模块负载过高，会触发自动扩容，研发侧和运维侧收到告警也会持续关注，当前的广告推荐系统中，并没有引入熔断（之前好像开启过(类似brpc在特定窗口里失败率超过阈值)，后面不知道什么原因关闭了）</div>2023-09-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/da/d9/f051962f.jpg" width="30px"><span>浩仔是程序员</span> 👍（0） 💬（1）<div>判断一个服务是否健康，从调用方的调用来说，可以根据调用的错误和超时率，比如可以配置最小的请求量比如30个，错误请求比例比如30%，超时请求比例如何10%，时间滑动窗口的长度比如60秒。另外在熔断恢复，可以配置恢复等待时长比如60秒，探测初始通过比例比如10%，探测每满n个成功恢复比例比如10%。 在实现中，可以通过代理机制结合时间滑动窗口，对请求的成功和失败进行数据的统计。</div>2023-07-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/da/d9/f051962f.jpg" width="30px"><span>浩仔是程序员</span> 👍（0） 💬（1）<div>老师您好，我们系统是没有熔断机制的。我在思考，对于熔断，还应该考虑业务允不允许熔断，目前的话，是通过告警机制有问题</div>2023-07-27</li><br/><li><img src="" width="30px"><span>Geek_20f6bc</span> 👍（0） 💬（3）<div>看完文章,有点疑惑, 平时工作接触的熔断器(Hystrix这种),断路器的逻辑都是在服务调用者(或者叫客户端吧)来处理的,譬如A服务调用B服务的一些接口,A里面有熔断器监控B服务的接口调用情况,如果超时情况很多(或者其他异常),触发断路器, 后续对B接口的调用都直接返回异常或转到fallback处理逻辑.
但是文章中说熔断逻辑是服务端来处理的,有点奇怪,熔断机制放服务端会有问题吧,
譬如服务B有异常(碰到一次超长的GC停顿等),站在服务调用者A的角度来看,对B的调用都会超时,自然触发A的熔断器,熔断后续对B的调用, 如果熔断器放B服务, 有什么作用, 调用者的请求还是会打过来, 但是B所有业务线程都没法工作,自然也没办法处理熔断逻辑,所有请求只能傻等么</div>2023-07-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/4a/ed/d1409f9e.jpg" width="30px"><span>提提</span> 👍（0） 💬（1）<div>有个问题。如果客户端是发起的 http 请求。没法选节点发请求和移除节点，需要怎么做客户端控制呢？</div>2023-07-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/37/c1/3a/880a0932.jpg" width="30px"><span>五号特派员</span> 👍（0） 💬（1）<div>请问大明老师，我是校招生，怎么可以在面试的时候应用到课程的内容呢，空谈概念总是觉得不踏实
</div>2023-07-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/e8/55/63189817.jpg" width="30px"><span>MClink</span> 👍（0） 💬（3）<div>如何判定一个服务是否处于健康状态。以GO语言实现的微服务举例。随便讲几个指标
1、服务依赖的数据库健康情况
1.1 数据库的CPU是否处于非高负载情况
1.2 数据库响应时长是否处于正常响应水平
1.3 数据库连接是否可以正常使用，无断连情况，sql 或命令语句是否可以正常执行

2. 服务所处环境，pod （或机器）的健康情况
2.1 CPU是否正常，使用率没有太高
2.2 磁盘IO是否正常
2.3 整体负载是否正常
2.4 内存使用率是否正常

3. 服务本身是否健康
3.1 gorutine 的数量是否正常
3.2 服务的内存占用是否正常
3.3 服务网络情况是否正常
3.3 服务是否存在Panic

4.服务有没有出现大量报错日志（框架的或者业务上的）
5.服务的接口APM P99 指标是否正常，响应时长没有突然暴涨
</div>2023-06-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/cb/9f/272f5efd.jpg" width="30px"><span>。</span> 👍（0） 💬（1）<div>写的很好，可以多更点吗😀</div>2023-06-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7e/57/8c1051b6.jpg" width="30px"><span>3.0的A7</span> 👍（2） 💬（4）<div>这里的客户端是指的是网关还是真实发起请求的客户端呢？
我理解是网关，比如nginx之类
如果是真实发起请求的客户端，比如移动app、web页面,那这个的开发成本是不是有点大呢？</div>2023-06-21</li><br/>
</ul>