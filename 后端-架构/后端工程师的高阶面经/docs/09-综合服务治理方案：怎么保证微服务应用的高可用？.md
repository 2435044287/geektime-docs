你好，我是大明。今天我们来聊一个综合性的话题：给你一个微服务应用，你怎么保证它的高可用？

在面试互联网相关岗位的时候，大部分公司都会看重**高并发**、**高可用**和**大数据**相关的经验。不过有没有高并发和大数据的项目经验有点儿看命。因为如果你不是在大厂的核心部门，你是很难遇到真正的高并发和大数据场景的。

高可用不一样，即便你维护的系统月活只有一万人，依旧可以把自己的系统做成高可用的。所以相比之下，高可用就可以成为我们面试的主要发力点。

![图片](https://static001.geekbang.org/resource/image/2e/87/2e2fa14105e4af15de328b87c0467f87.png?wh=1920x1151)

当然你也需要意识到，一个类似淘宝那种量级的系统的高可用和一个简单的后台管理系统的高可用，含金量是不一样的。但还是那句话，又有几个人真的有机会接触到淘宝那种项目呢？所以如果你真的不知道怎么把自己平凡的项目说得比较有特色，那么就可以参考这节课的内容。

## 前置知识

一般衡量可用性，我们都是用 **SLA**（Service Level Aggrement）指标，通常用 N 个九来说明。例如，当我们说微服务的可用性是三个九，是指系统在一段时间内（一般是一年）正常提供服务的时间超过了 99.9%。

那么高可用究竟有多高？一般是指可用性需要达到三个九。当然有些人会认为需要达到四个九，这并没有硬性的标准。那么怎么做到高可用呢？
<div><strong>精选留言（11）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/15/e8/55/63189817.jpg" width="30px"><span>MClink</span> 👍（20） 💬（3）<div>1、每个公司对不可用时长的标准似乎不同，像我们搞sass的，标准是某个功能达到一定量的租户反馈有问题，则可算进SLA的不可用时长内。说句大实话，随着服务的增多（目前已经有上千个微服务了），几十个产品，业务的增多，人员的变动，人员能力的参差不齐，线上事故肯定还是会有的，但是我们有完善的复盘机制，也有奖罚机制，每次出问题QA都要拉人复盘，给出各种后续措施，还要全公司通报，因此管理层对服务的稳定性是十分看重，我们目前的目标也是3个9，其实只要有一个组拖后腿，这个目标就很难达成。我们目前用的很多东西都是阿里云的，没有自己搞机房，所以运维基本也都是靠阿里云的工程师来协助处理。2、其他高可用方案：多环境验证（开发、测试、予发布、生产），灰度环境验证（G0、G1、G2），代码灰度上线（根据租户力度），配置项或者数据库的执行需要管理层审核，测试来执行，服务支持跨云部署（阿里云、华为云），南北流量分发，开发流程规范，代码CR，发布回滚机制，数据库监控告警，网关流量告警，服务自动扩容，业务error日志监控告警，数据库按服务拆库隔离，按租户分库，SQL慢日志监控等等。</div>2023-07-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/67/3d/71031021.jpg" width="30px"><span>nadream</span> 👍（2） 💬（1）<div>文章中一直没有说怎么搭建监控服务，这块可以详细说下吗</div>2024-01-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/44/cf/791d0f5e.jpg" width="30px"><span>ZhiguoXue_IT</span> 👍（2） 💬（1）<div>高可用一直是微服务比较热门的词，双十一业务高峰期的时候，首先就是根据预估的量进行全链路压测，机器扩容，其次对一些核心接口进行梳理，降级</div>2023-08-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2a/44/e6/2c97171c.jpg" width="30px"><span>sheep</span> 👍（1） 💬（1）<div>话说，由业务问题尝试的错误数据，有啥自定故障处理措施咩。好像大部分都是事后bug修复完后，写维护接口来发版更新</div>2023-09-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/11/0a/59639f1f.jpg" width="30px"><span>penbox</span> 👍（1） 💬（1）<div>我觉得四个九还是很难的，必须所有模块都达到高可用状态才行。任何一个模块拖了后腿，没有及时恢复都做不到四个九了。故障率要低，恢复时间也必须要快。
即便是单个模块内，高可用方案涉及到申请资源（花钱），调整制度，在团队里面没有一定的话语权也很难进行推动。</div>2023-07-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/b6/0f/e3550f48.jpg" width="30px"><span>LargeOrange</span> 👍（0） 💬（1）<div>这些三个九四个九是设计完就能得到结论还是系统运行一段时间后得到的结论？</div>2023-11-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/da/d9/f051962f.jpg" width="30px"><span>浩仔是程序员</span> 👍（0） 💬（1）<div>1.  想要达到4个9还是非常难的
2. 老师提到的高可用措施已经涵盖大部分了，在做高可用改造时，第一步就是要梳理完整的调用链路，如LVS-RS-KONG-后端服务-数据库，缓存，消息中间件，第三方服务等，每个组件都必须是高可用的。另外，可能还要考虑多机房部署，一个机房挂了，其他机房还可以正常提供服务，甚至是多大区部署。 在实际落地中，比如缓存组件，依赖于基础组件团队提供集群，在客户端需要熔断的机制，对服务进行健康的探测，自动摘除不可用的实例，通常就是一个定时任务不断的探测，及时摘除。</div>2023-07-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/cb/9f/272f5efd.jpg" width="30px"><span>。</span> 👍（0） 💬（1）<div>老师，请教一下，服务正常提供服务的时间，是指完全正常，比如很多个接口，其中每个接口部分请求出现异常，这种算是正常提供服务吗</div>2023-07-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg" width="30px"><span>peter</span> 👍（0） 💬（1）<div>请教老师几个问题：
Q1：“混沌工程”指什么？
Q2：“故障演练”具体是怎么做的？
Q3：自动扩容，是由系统的一个控制中心完成的吗？
Q4：一个微服务一个数据库吗？即微服务的数据库是自己私有的吗？</div>2023-07-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg" width="30px"><span>木几丶</span> 👍（0） 💬（1）<div>回答问题：
1、3个9代表8.76小时，4个9代表52.6分钟，5个9代表5.26分钟。我自己做过高可用的系统，在我的系统里可用性是3个9到4个9之间接近4个9，从我的实际落地看，要达到4个9还是很有挑战的，不可用的来源主要是几个方面：程序bug、线上变更失误或方案考虑不周、机器宕机、网络故障、机房故障，前两个属于人为，后几个属于非人为，理论上说，非人为不可用自动恢复的速度是比较快的，只要机器网络不是特别烂，4个9比较容易达成，但前提是没有人为引起不可用，可实际这是很难的。
2、其他高可用方案：机房自动切换，异地多活，规范流程（虽然文中提到了，但是还是想说，太重要了）</div>2023-07-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d0/91/89123507.jpg" width="30px"><span>Johar</span> 👍（0） 💬（2）<div>1.3个9不可用时间是365*（1-0.999）= 0.365天=8.76h，同理5个9不可用时间是5.265min。4个9不可用时间是1.241h，一般要定位问题是不是最近变更引起，能不能通过回滚解决。所以上线方案中回滚方案很重要，但是要是遇到不能回滚：如变更表字段为虚拟列，redis value包路径变更等，这种情况还要和领导，业务汇报决定，然后就要看服务重新发布的时长，基本上快的话也要30min，慢一点就是1个小时，所以这个难度还是挺高的。
2.高可用其他措施：发布流程支持灰度发布；云平台发布时长；应用启动时长；异地多活等。</div>2023-07-05</li><br/>
</ul>