你好，我是大明。今天我们来聊一下如何分库分表中确定容量的问题。

在分库分表的面试中，基本上面试官都会问你，你究竟分了几个库分了几个表。这是因为面试官比较关注数据库的数据量问题，如果容量预估不准确，那么后续就需要扩容，而扩容是一个非常麻烦和棘手的事情。

大部分人在准备面试的时候很少深入思考这个容量是怎么来的，因此面试官问到的时候就是一脸懵。那么今天我就带你深入讨论一下怎么计算分库分表的容量，并教你利用扩容展示自身的能力，尤其是后面会提到的**利用流量复制和重放来做数据校验**，是一个非常高级的技巧，足以证明你在系统设计上有丰富的经验了。

我们先从分区表说起。

## 分区表

大部分数据库都支持分区表。这里我以 MySQL 为例给你介绍一下分区表的主要特性。

在 MySQL 里，分区表是表的底层组织方式。简单来说，分区表就是把一张表分成几块，每一块存储在磁盘的一个地方，一块也叫做一个分区。比如典型的按月分区，是指每个月产生的数据在一个独立的区域。数据库可以单独处理某一块，也可以多块一起处理。

分区表的优缺点还是非常分明的。

![图片](https://static001.geekbang.org/resource/image/32/10/328f7d46c31fd45e9ba55b21f3dc2310.png?wh=1920x790)

虽然分区表的缺点很明显，但在一些场合，分区表还是非常好用的，尤其是一些跟时间有明显关系的业务场景，按照时间来进行分区要比直接使用分库分表更加简单高效。
<div><strong>精选留言（9）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/d0/91/89123507.jpg" width="30px"><span>Johar</span> 👍（8） 💬（2）<div>1.需要迁走2&#47;3的数据
2.一般页的大小是16KB，每行数据大小按照1KB，B+树按照三层，主键按照8byte，地址是6byte，所以第一，二层大小为16*1024 &#47; (8+6) = 1170，总体大小就是1170*1170*16=21902400，大概就是2000万

在扩容的时候，我说 2 的幂翻倍扩容的话，只需要迁走一半的数据。如果改成用 3 的幂，原本你的数据是按照除以 3 的余数分库分表，现在变成除以 9 的余数分库分表，那么要迁走多少数据？
网络上有一种说法是超过 2000 万行数据就要分表了，你知道这个 2000 万是怎么来的吗？</div>2023-07-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/08/ab/caec7bca.jpg" width="30px"><span>humor</span> 👍（2） 💬（1）<div>流量复制与重放，这种数据检测机制不可能把所有的数据都检测一遍吧，肯定存在有的数据写了，但是没有去读的情况，或者历史数据大概率不会经常被请求，也就无法被检测到。</div>2023-08-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/dc/08/64f5ab52.jpg" width="30px"><span>陈斌</span> 👍（2） 💬（1）<div>第一个问题，迁移数据2&#47;3。
第二个问题，增加索引深度。MySQL 默认是 16K 的页面，抛开它的配置 header，大概就是 15K，因此，非叶子节点的索引页面可放 15*1024&#47;12=1280 条数据，按照每行 1K 计算，每个叶子节点可以存 15 条数据。同理，三层就是 15*1280*1280=24576000 条数据。只有数据量达到 24576000 条时，深度才会增加为 4</div>2023-07-31</li><br/><li><img src="" width="30px"><span>Geek8004</span> 👍（1） 💬（2）<div>逻辑数据库引起的性能瓶颈，这个怎么理解呀。能举个例子吗</div>2023-08-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg" width="30px"><span>peter</span> 👍（1） 💬（1）<div>请教老师几个问题：
Q1：“分区表”是指业务层面的分表？还是MySQL内部底层实现的概念？我认为是业务层面的分表，比如按月分，就是业务层面；但是文中有一句“分区表是表的底层组织方式。简单来说，分区表就是把一张表分成几块，每一块存储在磁盘的一个地方”，这句话让我理解成“MySQL底层的分表”。
Q2：用了Oracle就不用分库分表了吗？
小型公司，可能用Oracle不用分库分表了。但中大型公司，用Oracle以后估计还需要使用分库分表吧，只不过分得少，比如用MySQL需要100个库，但用Oracle只需要10个库。是这样吗？
Q3：Nginx将HTTPS转换为HTTP，是自动转换的吗？还是需要做一些配置？
Q4：流量复制与重放为什么公司很少做？不准确吗？还是因为成本高？</div>2023-08-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/36/f3/d4/86a99ae0.jpg" width="30px"><span>哆啦a喵</span> 👍（0） 💬（1）<div>请教老师一个问题，分片表又该怎么理解呢？查资料，实际上是类似分库，但是并没有分库，只是让表的存储在多个物理实例上？

那分片相关的操作是不是也可以套用老师讲的这些面试技巧和亮点呀。</div>2024-04-29</li><br/><li><img src="" width="30px"><span>geek001</span> 👍（0） 💬（1）<div>实在太干了，希望作者能补充一些数字支撑，常用的数据库硬件配置大概能抗住的iops tps 等。因为公司没有这个量级，没有清晰点的感受</div>2024-03-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/08/ab/caec7bca.jpg" width="30px"><span>humor</span> 👍（0） 💬（2）<div>如果是逻辑数据库引起的性能瓶颈，那么你就只需要在逻辑数据库这个层面进一步分库就可以了。

逻辑数据库可能有什么性能瓶颈呢？</div>2023-08-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/44/cf/791d0f5e.jpg" width="30px"><span>ZhiguoXue_IT</span> 👍（0） 💬（1）<div>1）我理解，比如扩容的时候，之前是8张表，我们新建16张表，即使按照2的倍数，迁移数据到新的表，还是需要全量迁移，作者的意思是前8张表不变，然后新加8张表吗？
2）第二题就是从b+树的角度来衡量单表的存储量</div>2023-07-31</li><br/>
</ul>