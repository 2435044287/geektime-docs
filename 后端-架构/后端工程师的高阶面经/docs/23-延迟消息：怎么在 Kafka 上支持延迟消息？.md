你好，我是大明。今天我们来讨论一个在消息队列面试中非常热的话题——延迟消息。

延迟消息在 Kafka 面试里面是非常热门的，其他消息队列多少也会问，但是不如 Kafka 问得频繁。因为 Kafka 不支持延迟消息是大家都知道的。但是偏偏 Kafka 又用得多，很多业务场景也要求使用延迟消息，因此面试的时候延迟消息就成了一个重要的考察点。

和之前的面试点不同，能把延迟消息的方案讲得清楚透彻的人就不多，更不要说刷亮点了。那么今天我就带你深入延迟消息，并且给出一个非常高级的方案。这个方案会涉及到分库分表，所以能帮助你把这些知识融会贯通。

## 延迟队列和延迟消息

延迟队列是一种特殊的队列。它里面的每个元素都有一个过期时间，当元素还没到过期时间的时候，如果你试图从队列里面获取一个元素，你会被阻塞。当有元素过期的时候，你就会拿到这个过期的元素。你可以这样想，你拿到的永远是最先过期的那个元素。

很多语言本身就提供了延迟队列的实现，比如说在 Java 里面的 DelayQueue。

这节课我们讨论的就是一种特殊形态的延迟队列，或者说是基于消息队列的延迟队列，也叫做延迟消息。具体来说，延迟消息是指消息不是立刻被消费的，而是在经过一段时间之后，才会被消费。在到时间之前，这个消息一直都被存储在消息队列的服务器上。上一节课，我就举了订单超时取消的例子，它就用到了延迟消息。
<div><strong>精选留言（26）</strong></div><ul>
<li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erxia5dpTeXMHUg3NlQmLzqw0qBic4kRjKBsNuT9ib9VD717dckYvU63S07KPkydMULG2wEcibJXmtTBA/132" width="30px"><span>第四死神</span> 👍（11） 💬（1）<div>开源版本在2022年7月20日 增加了 [RIP-43] Support Timing Messages with Arbitrary Time Delay</div>2023-08-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/dc/08/64f5ab52.jpg" width="30px"><span>陈斌</span> 👍（3） 💬（2）<div>基于 MySQL 的亮点方案 中，延时消息的延时精度，取决于延时生产者的轮询频率。如果业务有要求在业务低谷期时延时精度要在0.5s内，那么轮询频率会高于每秒两次，那么就会限制并发上限。即并发越高，我感觉该方案的时间精度可能会越低。</div>2023-08-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/82/a8/b419d69a.jpg" width="30px"><span>建涛涛涛、ᕕ( ᐛ )ᕗ</span> 👍（2） 💬（1）<div>请问一下老师， kafka + mysql 做随机时间的方案里， 既然都上mysql了。 还要kafka做什么？ 
只用 mysql, 然后轮询不就搞定了吗。</div>2023-11-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/38/c5/7a/c03cb56e.jpg" width="30px"><span>一弦一柱思华年</span> 👍（1） 💬（5）<div>这里有个问题，关于delay-topic的：延迟消费者是每拉取一条数据就立马根据剩余时间睡眠吗，那这样的话消费速度远远跟不上生产速度吧。。假如我延迟时间是1小时，如果生产量稍微大一点，比如1000条消息，那后面的消息岂不是要等1000小时才能消费到，这样的话不是早就过期了吗，恐怕严重不符合用户使用预期。因此是否需要结合批量读来实现呢：根据业务场景并发量来看一次性拉取多少条合适，然后在延迟消费者里开启多线程睡眠为每条消息定时转发</div>2024-01-16</li><br/><li><img src="" width="30px"><span>Geek_728b54</span> 👍（1） 💬（1）<div>老师好，在“分区设置不同延迟时间”方案中，如果其中一个消费者宕机和重启，这时候会不会触发整体的重平衡协议？</div>2023-12-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/08/ab/caec7bca.jpg" width="30px"><span>humor</span> 👍（1） 💬（1）<div>延迟消息体里应该存放的是消息应该发送的具体时间戳吧，那会不会有时钟不同步的问题，比如消息发送者和延迟消息组的时钟不一致，导致延迟消息被提前或者延后发送。这个问题需要关注吗，怎么处理呢？</div>2023-08-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/86/2d/90c206fe.jpg" width="30px"><span>智商未成年</span> 👍（0） 💬（1）<div>你好，我想问下 &quot;发生 rebalance 之后，等消费者再恢复过来，就不知道又会被分配到哪个分区，那么之前的睡眠就可以认为是白睡了。&quot;
这个白睡了是怎么理解呢，消费者睡眠结束后，消费另一个分区的数据，感觉对延时消费逻辑没影响，消费其他分区的数据时，还是根据剩余的延迟时间进行睡眠。</div>2024-03-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2a/44/e6/2c97171c.jpg" width="30px"><span>sheep</span> 👍（0） 💬（1）<div>有个问题，“分区设置不同延迟时间”这里，消费者获取到指定消息之后，要延迟一定时间后，才能继续处理并提交信息吗。那这里，消费者获取到这个消息后，我启动一个协程来进行延迟和处理，是不是就能解决rebalance问题了呢？但是会有数据一致性的问题吧？比如这个协程处理异常或者服务宕机了，此时消息还没有处理完毕，就先前已经被提交了？</div>2023-12-06</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/B7en9NzmQO6FFgIK8H5vibcLET3ibqGeHjnTzncfZib4VqIkaM5hTxu1LybK12cYe6TbceTppRbjJS7Yh0AKldteA/132" width="30px"><span>Geek_9affad</span> 👍（0） 💬（3）<div>mysql的方案可以替换成 Redis中有序集合的score来完成吧</div>2023-09-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/2f/bb/f663ac5a.jpg" width="30px"><span>itschenxiang</span> 👍（0） 💬（2）<div>老师你好。我这里有两个疑问哈：
1）分区设置不同延迟时间-rebalance 问题中，提出“暂停消费，睡眠一段时间 t”，这里前提是先消费到的消息先达到超时时间点吗？
2）分区设置不同延迟时间-一致性问题，这里是不是可以使用kafka的extract once，使用事务来进行转发控制呢，感觉这就是典型的使用场景？</div>2023-09-17</li><br/><li><img src="" width="30px"><span>Geek8004</span> 👍（0） 💬（1）<div>mysql这个亮点方案,延迟发送者去高频率扫表,假如有16个topic对应16个库,每个库8张表,假设每个表每天产生50万数据,每次遍历索引或者是扫全表,性能会不会很差呀,大概要多久呀</div>2023-09-01</li><br/><li><img src="" width="30px"><span>Geek8004</span> 👍（0） 💬（1）<div>老师,秒杀场景中,用户创建了未付款的订单,发了一条30min超时未支付取消订单的消息.在设置不同的延时分区这个方案里面,假如此时用户30分钟已经已经支付了,订单状态已经变成了已支付.但是30分钟到期了未付款的消息收到了,此时应该怎么办? 是不是用状态机? 状态只能往大的方向更改? 还是应该怎么处理呢?例如去把MQ里面的未支付的超时消息删除? 我觉得应该是判断当前订单的状态,如果是已支付或者已取消,那业务方就丢弃这个超时未支付的消息?</div>2023-09-01</li><br/><li><img src="" width="30px"><span>Geek8004</span> 👍（0） 💬（1）<div>每个分区设定了不同的延迟时间,比如kafka中这个参数在哪里设置?没操作过这种给分区设置不同的参数?</div>2023-08-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/d6/90/2b949521.jpg" width="30px"><span>tyro</span> 👍（0） 💬（1）<div>老师本章的内容我有几个疑问：
Q1. “不同分区设置不同的延迟时间”中，比如3min的分区。消费者每次拉取消息后pause的时间，是不是这条消息的生产时间距离这个3min延迟的剩余时间？这样才能做到消费者源源不断消费吧？应该不是每个消息，不管三七二十一的都pause 3min吧？不知道我理解的对不对？后面说的消息积压的问题，应该也是因为吞吐量过高，单个消费者转发都转发不过来导致的积压吧？所以才需要设置2min30，3min30多个接近的分区分摊压力？
Q2 针对Q1，如果我想进一步使用批量操作拉取和消费消息，这时候提交offset是不是只能这一批消息全部满足延迟并进行转发成功后，才能提交offset并拉取下一批消息？
Q3 思考题1中，我觉得把延迟阶梯从分区换成topic好像更好一点啊，每个topic可以有多个分区多个消费者了，消费能力更高。balance问题也不会导致业务股长，只是单纯的性能问题？那为什么文章不使用topic方案呢？
Q4 交替表方案中，比如我一天为单位交替写。有一批30min延迟的消息刚好在23:59这种要替换表到tab1的临界时间写到tab0来。那我替换表的时候，这些消息怎么办？这时候也不能truncate吧？就算不truncate，下次切换消费已经是24h后了？
Q5 在分库分表方案中，为了平衡不同biz_topic的负载，提出了使用轮询插入的方案。后面又说为了满足消息的有序性，有回到biz_topic分库分表了？所以这是两个角度的trade-off，无法兼顾嘛？
望老师解惑，谢谢🙏</div>2023-08-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/59/91/fa2d8bb2.jpg" width="30px"><span>不吃辣👾</span> 👍（0） 💬（1）<div>想不通最后mysql的亮点方案中 延迟消费者到底还要不要延迟，假如生产者向delay_topic先发了一条需要延迟一天的消息，紧接着发送了一条需要延迟10s的消息。这种情况下延迟消费者要睡一天，后面的需要延迟10s的得不到转存到数据库中了。延迟消费者怎么体现延迟呢？</div>2023-08-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/59/91/fa2d8bb2.jpg" width="30px"><span>不吃辣👾</span> 👍（0） 💬（1）<div>考虑延迟消息有序性的话，topic 的分区只能有一个。</div>2023-08-21</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqw0R25Bt0iahFhEHfnxmzr9iaZf0eLsDQtFUJzgGkYwHTqicU9TydMngrJ4yL7D50awD2VibHBAdqplQ/132" width="30px"><span>Geek_18dfaf</span> 👍（0） 💬（6）<div>5 个分区：延迟时间分别是 1min、3min、5min、10min、30min，针对这里有个疑问，
总不能在消费端 睡30min后再提交到正常的消费队列吧</div>2023-08-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg" width="30px"><span>peter</span> 👍（0） 💬（1）<div>请教老师两个问题：
Q1：分布式任务平台，有开源的吗？或者商用的第三方平台？
Q2：基础思路部分的“分区”不是“topic”吗？我一直是理解成topic的，但思考题里面又要区分“分区”和”topic”。 那“分区”到底是指什么？</div>2023-08-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/08/ab/caec7bca.jpg" width="30px"><span>humor</span> 👍（0） 💬（1）<div>表交替可以支撑高并发的原理是什么呢？不管用不用表交替，在同一时刻，都是只会读写一张表吧，瓶颈都在一张表上</div>2023-08-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7e/57/8c1051b6.jpg" width="30px"><span>3.0的A7</span> 👍（0） 💬（2）<div>rocketmq不支持延迟队列吗？是不是开源版的不支持
我们前两年就用到了rocketmq的延迟队列啊，没有做特殊开发。</div>2023-08-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/7b/03/03583011.jpg" width="30px"><span>天天有吃的</span> 👍（1） 💬（0）<div>RocketMQ不是很早就支持延迟消息了吗，4.9？18个level 1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h</div>2024-03-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg" width="30px"><span>木几丶</span> 👍（0） 💬（0）<div>我们的外部存储用的Redis+时间轮，ES兜底，延迟消费者消费后，写入Redis和ES，入轮，然后用时间轮推进。常规情况下，使用Redis zset+时间轮，Redis故障用ES兜底和恢复</div>2024-10-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/17/4d/7e13ec93.jpg" width="30px"><span>彭俊</span> 👍（0） 💬（0）<div>能否 消费者消费消息后，自己落db延迟处理呢</div>2024-09-23</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/ALtd8gWcgYyibSlHQgtwztDSApbwh47vlQoatCicU55svnC3jhciaBGfuzBia70ukicN5TJjcBsHBLkZRTSSMCcn48jM02lYsNq8cmSibMYen8Wrg/132" width="30px"><span>Geek_bf3d13</span> 👍（0） 💬（0）<div>还有一个一致性问题，就是如何保证延迟消费者不丢失数据，延迟消费者具体要怎么实现</div>2024-07-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/30/d4/6eb8f5af.jpg" width="30px"><span>白菜炒五花肉</span> 👍（0） 💬（0）<div>老师，kafka 消费的时候，一次性拉取多条消息，如果是不同分区的消息，sleep 的时间怎么决定</div>2024-06-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/77/7b/338c4617.jpg" width="30px"><span>瀚海</span> 👍（0） 💬（1）<div>方案过于复杂     rocktmq的延迟消息是怎么实现的呢</div>2024-04-23</li><br/>
</ul>