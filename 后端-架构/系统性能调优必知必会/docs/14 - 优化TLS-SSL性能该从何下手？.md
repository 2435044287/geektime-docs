你好，我是陶辉。

从这一讲开始，我们进入应用层协议的处理。

信息安全在当下越来越重要，绝大多数站点访问时都使用https://替代了http://，这就是在用TLS/SSL协议（下文简称为TLS协议）来保障应用层消息的安全。但另一方面，你会发现很多图片类门户网站，还在使用http://，这是因为TLS协议在对信息加解密的同时，必然会降低性能和用户体验，这些站点在权衡后选择了性能优先。

实际上，TLS协议由一系列加密算法及规范组成，这些算法的安全性和性能各不相同，甚至与你的系统硬件相关。比如当主机的CPU支持AES-NI指令集时，选择AES对称加密算法便可以大幅提升性能。然而，要想选择合适的算法，需要了解算法所用到的一些数学知识，而很多同学由于忽视了数学原理便难以正确地配置TLS算法。

同时，TLS协议优化时也需要了解网络和软件工程知识，比如我们可以在网络的不同位置缓存密钥来优化性能。而且，TLS协议还可以优化其他应用层协议的性能，比如从HTTP/1升级到HTTP/2协议便可以通过TLS协议减少1个RTT的时间。

优化TLS性能究竟该从何下手呢？在我看来主要有两个方向，一是对称加密算法的性能优化，二是如何高效地协商密钥。下面我们来详细看看优化细节。
<div><strong>精选留言（14）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/4d/49/28e73b9c.jpg" width="30px"><span>明翼</span> 👍（4） 💬（1）<div>老师我在另一本书上看DH算法不是前向安全算法动态DH算法或ECDH算法才是前向安全的</div>2020-08-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/02/43/1c2fb7b3.jpg" width="30px"><span>Bourne</span> 👍（3） 💬（1）<div>当然，用 Chrome 浏览器配合 Wireshark 可以解密消息，帮助你分析 TLS 协议的细节（具体操作方法可参考《Web 协议详解与抓包实战》第 51 课）。严重怀疑老师在给自己打广告哇，点过去一看，干货这么多，又买了，哈哈哈。不过话说回来，老师的课程质量真的很高，《Nginx核心知识100讲》还没学完，到100节左右了（其实有150讲），学到了很多，从Nginx小白到写Nginx配置信手拈来（吹个牛逼），谢谢老师的付出。</div>2020-08-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/11/78/4f0cd172.jpg" width="30px"><span>妥协</span> 👍（2） 💬（1）<div>所以TLS1.3可以放重放攻击吗</div>2020-08-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/63/2e/e49116d1.jpg" width="30px"><span>Geek_007</span> 👍（1） 💬（1）<div>陶辉老师你好，我有一个问题一直很困惑，希望能解答一下，感谢。TLS的record size 是16KB，Nginx 上有 ssl_buffer_size 参数，这个参数也会设置死 record size。如果没有像cloudflare一样做了动态tls record 的话 ，就是说TLS的record size是固定的16KB，但是假设TLS建联后每次只发1k的数据，不够16k。那么对端该如何处理呢？是等待？还是说发送发现发送的数据不够16K，就填充？如果等待会造成时延问题，如果填充会造成发送的数据总是过大。所以不知道这个 record size 为16 字节怎么理解。哦，对了，大部分Nginx都没有做动态TLS record size 吧，我是参考 https:&#47;&#47;blog.cloudflare.com&#47;optimizing-tls-over-tcp-to-reduce-latency&#47; 这篇文章才有这个疑惑的。希望讨论老师有空闲之余解答一下。</div>2020-07-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/47/b0/a9b77a1e.jpg" width="30px"><span>冬风向左吹</span> 👍（1） 💬（1）<div>请问老师，我在nginx配置中，不管ssl_certificate和ssl_certificate_key是否配置ecc证书，抓包查看服务器的server hello响应中的Cipher Suite字段都是TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256，这是正常的吗？</div>2020-05-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/d6/fb/837af7bf.jpg" width="30px"><span>董永刚</span> 👍（0） 💬（1）<div>TCP三次握手过程中传递公钥，会被黑客拦截到吗，被拦截后就可以获取到公钥信息？</div>2021-04-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/64/9b/d1ab239e.jpg" width="30px"><span>J.Smile</span> 👍（0） 💬（1）<div>读了两遍，其义自见。谓读得熟！come on!</div>2020-07-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/63/2e/e49116d1.jpg" width="30px"><span>Geek_007</span> 👍（18） 💬（0）<div>TLS1.3 感觉其实也不是优化特别大，TLS1.2 有False Start，也能做到1RTT，至于0RTT，现在主流的CDN应该也还有很多厂家不支持PSK，所以0RTT的效果也不一定好。
课后题：
1、ECC证书应该算是一种优化，因为证书更小，加解密更快。（不过好像因为客户端公钥太长，对客户端不友好，尤其是移动端）
2、算法分离、使用硬件加速卡代理计算。可以极大减轻接入层压力。
3、去掉证书链中的根证书（证书链太长可能会导致多一个RTT，毕竟TCP还在慢启动）
4、还是保持连接吧、减少连接次数。
5、客户端的session ticket 持久化，之前都是提到的服务端的session ticket，但是客户端如果是浏览器或者APP，因为重新打开等操作导致重新建立链接，应该会清空保存的会话票据，服务端即便有票据也没有用了。（个人理解，不正确的话请老师指正）
</div>2020-05-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg" width="30px"><span>我来也</span> 👍（6） 💬（4）<div>最近就遇到过tls协议版本的问题，不过我们是在开倒车。😂

最近升级到k8s后，默认的ingress nignx只支持tls1.2以上的版本，导致某些安卓5.x版本上的app无法与服务器正常通讯，为了兼容这部分用户，只能强制把tls支持的最低版本号调回到1.0。</div>2020-05-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/50/33/9dcd30c4.jpg" width="30px"><span>斯蒂芬.赵</span> 👍（0） 💬（0）<div>老想想问一下再nginx里配置tls选项时候，设置了选项 ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;  这个选项是从网上随便复制的，目前部分河南的用户安卓手机访问我们的app，报网络错误的问题，我们后台看安卓的上报日志显示：connect reset ，是因为客户端不支持这个加密套件导致的么？这个选项需要设置么？有啥影响?</div>2023-04-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/b4/94/2796de72.jpg" width="30px"><span>追风筝的人</span> 👍（0） 💬（0）<div>TLS1.3（参见RFC8446）对性能的最大提升，在于它把 TLS 握手时间从 2 个 RTT 降为 1 个 RTT。</div>2022-01-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/b4/94/2796de72.jpg" width="30px"><span>追风筝的人</span> 👍（0） 💬（0）<div>TLS1.3 中把 Hello 消息和公钥交换合并为一步，这就减少了一半的握手时间</div>2022-01-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/9a/39/82679f79.jpg" width="30px"><span>Denuth</span> 👍（0） 💬（0）<div>老师求介绍ssl硬件加速方面的实战</div>2020-05-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/11/e3/17d09788.jpg" width="30px"><span>毛立平</span> 👍（0） 💬（2）<div>OSCP-&gt;OCSP?  最近碰到过letsencrypt在国内访问ocsp的问题导致ios端延迟3s的问题。 https:&#47;&#47;mp.weixin.qq.com&#47;s&#47;z_QsomzE3jBtwi8VdVDdEA</div>2020-05-29</li><br/>
</ul>