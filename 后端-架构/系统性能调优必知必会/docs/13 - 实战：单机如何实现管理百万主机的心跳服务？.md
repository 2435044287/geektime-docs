你好，我是陶辉。

这一讲我们将结合前12讲，以一个可管理百万主机集群的心跳服务作为实战案例，看看所有高性能服务的设计思路。

首先解释下什么是心跳服务。集群中的主机如果宕机，那么管理服务必须及时发现，并做相应的容灾处理，比如将宕机主机的业务迁移到新的虚拟机上等等。怎么做到及时发现呢？可以要求每台主机定时上报心跳包，考虑到网络报文的延迟，如果管理服务在几个上报周期内未收到心跳，则认为主机宕机。当新主机加入集群后，心跳服务也可以及时识别并告知管理服务。

这就是心跳服务要解决的核心问题，虽然很简单，可是如果集群规模达到百万台虚拟机或者微服务进程，这就不再简单了。多核CPU、内存使用效率、网络带宽时延积等都必须纳入你的考虑，因为此时心跳包占用的网络带宽已经接近网卡上限，仅调动一颗CPU的计算力去处理就会大量丢包，百万级的对象、网络连接也很容易造成内存OOM。甚至判断宕机的算法都要重新设计，降低时间复杂度后才能够应对超大集群的心跳管理。

解决这种集群规模下的性能问题，需要深入掌握底层基础知识，用系统化的全局思维去解决问题，这也是程序员薪资差异的重要分水岭。接下来，我们先实现更高效的核心算法，再设计高并发服务的架构，最后再来看传输层协议的选择。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/14/64/9b/d1ab239e.jpg" width="30px"><span>J.Smile</span> 👍（5） 💬（1）<div>看到现在。每篇文章都得看两遍以上，才有感觉，相比于这些底层知识，特别感慨和好奇老师是怎么把这些抽象的东西搞得这么具体清楚！敬佩啊！</div>2020-07-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/51/29/24739c58.jpg" width="30px"><span>凉人。</span> 👍（5） 💬（1）<div>如果主机处理得速度不同，我想会不会心跳时间会有区别。这样用时间轮会不会好点。</div>2020-05-28</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/3XbCueYYVWTiclv8T5tFpwiblOxLphvSZxL4ujMdqVMibZnOiaFK2C5nKRGv407iaAsrI0CDICYVQJtiaITzkjfjbvrQ/132" width="30px"><span>有铭</span> 👍（3） 💬（5）<div>寻找宕机服务时，只要看队列首部最老的心跳包，距现在是否超过 5 秒，如果超过 5 秒就认定宕机
==========
这里的逻辑无法理解：如果要用这种方式检测心跳，那么肯定要不停的把队列首部的心跳包移除，让新的心跳包从尾部加入，那么如果这个加入的过程卡一点。岂不是就会误判？？</div>2020-05-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg" width="30px"><span>那时刻</span> 👍（3） 💬（2）<div>老师在文中提到的超过五秒没有收到心跳消息就会把这台主机从状态列表里删除了。可能有这种情况，比如主机A因为网络抖动超过五秒发来心跳消息，尽管它是alive状态，但是我们会误认为它下线了。为了应对这种情况，我们之前会采取一段时间内收到消息的百分数来计算，比如每秒一个心跳消息，在20秒内应该收到20个心跳消息，比如收到10个，比例是50%。以这个比例作为是否下线的阈值。请问老师，不知是否还有更好办法？</div>2020-05-27</li><br/><li><img src="" width="30px"><span>李新龙</span> 👍（2） 💬（4）<div>每当收到心跳包时，如果对应主机的上一个心跳包还在队列中，那么可以直接把它从队列中删除。没讲清楚，怎么找到上一个？</div>2020-09-27</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLzvaL724GwtzZ5mcldUnlicicSlI8BXL9icRZbUOB10qjRMlmog7UTvwxSBHXagnPGGR1BYdjWcGGSg/132" width="30px"><span>wwj</span> 👍（2） 💬（1）<div>感觉时间轮算法比这个更有效一些 比hash节省空间</div>2020-08-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/1f/66/59e0647a.jpg" width="30px"><span>万历十五年</span> 👍（1） 💬（1）<div>请教老师，对于做负载均衡的多个分发线程，如何做到及时并且互斥的分发包？</div>2020-08-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/19/f9/62ae32d7.jpg" width="30px"><span>Ken</span> 👍（1） 💬（1）<div>烧脑，还在消化，容我二刷回来评论😂</div>2020-05-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/21/20/1299e137.jpg" width="30px"><span>秋天</span> 👍（0） 💬（1）<div>心跳包哪一块的设计，用队列存储心跳的信息，hash表主要存储的是什么信息？以及他的作用是什么  没看太懂，请您指导</div>2020-08-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/56/75/6bf38a1e.jpg" width="30px"><span>坤哥</span> 👍（0） 💬（1）<div>无锁编程，除非一个线程一个工作队列，否则单个队列实现不了</div>2020-07-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/56/75/6bf38a1e.jpg" width="30px"><span>坤哥</span> 👍（0） 💬（2）<div>陶哥，我认为如果只用单个队列，不可避免对hash加锁，因为查看队列头部，发现过期心跳包会与工作线程同时操作hash有冲突。</div>2020-07-07</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eocvvlibbfYw4wezziaBKn2OLDpvTndicPr21ZZoeiaM5QLibICy7PJPQibCAz5zfMe08ibem7ll3LSzkWaQ/132" width="30px"><span>Geek_8c0618</span> 👍（0） 💬（1）<div>其实是LRU对吗</div>2020-07-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a9/36/d054c979.jpg" width="30px"><span>G.S.K</span> 👍（0） 💬（1）<div>老师讲的这个是单机服务，分布式服务的话，是不是前边挂个负载均衡器，采用源ip哈希就可以呢？</div>2020-07-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ed/91/1d332031.jpg" width="30px"><span>我能走多远</span> 👍（0） 💬（1）<div>感觉类似一个lru的算法。双向链表实现的队列。这个场景在dpdk源码中分片报文尾重组有应用。</div>2020-06-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/50/6c/12c39b37.jpg" width="30px"><span>几米夜空</span> 👍（0） 💬（2）<div>有几个问题:
1.若使用UDP，有的系统不支持端口重用，只能打开一个相同UDP端口，这对于百万心跳，这有可能内核缓冲区就丢包，这怎么处理？
2.这还是需要去遍历哈希表，检查是否超时?若哈希函数不好，这链表也很长，这时间复杂度还是跟前面提到的一样，有没有什么好的哈希函数保证冲突少呢？</div>2020-05-30</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/diaGeaLuw3oTAcyFMnkiaVur33RXdUZL8z1LtfHibIyh4r629YSexJQz5JXYjBH7v9rwHH7ham5CzqDZF75QnGIwg/132" width="30px"><span>野性力量</span> 👍（0） 💬（1）<div>提个和本文内容无关的问题，如果管理中心和服务网络断开，但是服务实际没有宕机，而且调用方也能访问服务，这种应该判定为宕机吗？</div>2020-05-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/63/5e/799cd6dc.jpg" width="30px"><span>🎧重返归途</span> 👍（0） 💬（1）<div>你好，MTU和MSS 有什么关联么</div>2020-05-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/b0/c5/3cf6e86b.jpg" width="30px"><span>simplesslife</span> 👍（0） 💬（2）<div>如果宕机的主机一直没有发心跳包，那就是发现不了宕机了吗？</div>2020-05-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/82/3d/356fc3d6.jpg" width="30px"><span>忆水寒</span> 👍（13） 💬（0）<div>本文收获蛮多的，可是没有遇到相关的场景，也希望多看看别人的思考和总结。
关于寻找宕机的节点，核心思路就是收到心跳包先插入队列尾部，然后通过哈希表找到队列中之前的位置进行判断是否宕机，并将队列中之前的心跳信息删除。这样用空间换时间，降低时间复杂度。
关于如何在单机模拟百万连接，可以参考https:&#47;&#47;mp.weixin.qq.com&#47;s&#47;6K9YDpdvsPbcw5_Rc0NyBQ</div>2020-05-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/f4/f7/871ff71d.jpg" width="30px"><span>Geek_David</span> 👍（1） 💬（0）<div>老师你好，这里有个问题还不太明白。
1.FIFO队列存心跳是不是应该每个服务对应一个队列
2.每个队列每一秒判断一次心跳有没有超过5秒
3.当最老的心跳超过5s我们就判断后面有没有新的心跳，直到队列中最后一个心跳还是超过5s才认为宕机

不知道我的理解对不对</div>2021-03-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4a/15/106eaaa8.jpg" width="30px"><span>stackWarn</span> 👍（1） 💬（0）<div>工作线程和分发线程 这里的设计 和 dpdk 的pipeline模式基本相同，cpu分为rx lcores，worker lcores，tx lcores ～</div>2020-06-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/31/7b/be/791d0f5e.jpg" width="30px"><span>Geek_595be5</span> 👍（0） 💬（0）<div>请教一下，设计心跳和宕机监测时，为什么要讲心跳队列看成是是新老数据交替呢？我感觉跟lfu设计很相似，就是当前心跳请求根据hashmap找到链表心跳位置，将该心跳机器移到队尾，好像没必要解释成同一机器B的t10心跳和t8心跳，同时有新老这种情况复杂情况吧？链表应该一直维持所有全量心跳机器，而不是简单理解成先进先出队列吧？不然对于一直没有心跳的机器，还需要从hashmap再次遍历，O(n)复杂度</div>2023-12-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/31/05/65/791d0f5e.jpg" width="30px"><span>寒潮nl</span> 👍（0） 💬（0）<div>按不同ip绑定到特定工作线程的方法，如果这个工作线程的任务队列过长，或者过短，该怎么进行负载均衡呢</div>2022-10-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4d/49/28e73b9c.jpg" width="30px"><span>明翼</span> 👍（0） 💬（0）<div>如果按照时间排序做小顶堆，即最早的时间再堆顶，每次来数据从堆上删除数据，然后加入堆即可，判断的时候从堆顶取元素如果超时则告警删除，直到堆顶元素不超时，既可以结束遍历</div>2022-08-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0b/44/c59fa938.jpg" width="30px"><span>AIA</span> 👍（0） 💬（0）<div>TCP这块内容太缺乏，听起来很烧脑，不过内容很详尽，需要多品👍🏻👍🏻</div>2022-05-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/d4/d6/1d4543ac.jpg" width="30px"><span>云海</span> 👍（0） 💬（0）<div>文中提到“这个队列为每个主机仅保留最新的那个心跳包。”。既然仅保留一个，那还需要队列吗？直接一个基础类型即可吧</div>2022-04-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c7/11/89ba9915.jpg" width="30px"><span>永远的草莓地</span> 👍（0） 💬（0）<div>因为 ip_local_port_range 的限制，一台代理服务器是不是理论上最多只能反向代理 65535个 长连接，感觉太少了，怎么突破这种限制？让upstream 增加端口吗？</div>2021-04-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/19/89/20488013.jpg" width="30px"><span>hanazawakana</span> 👍（0） 💬（2）<div>当然，队列中的心跳包并不是只能从队首删除，否则判断宕机流程的时间复杂度仍然是 O(N)。这里没看懂，为什么仍然是o（n），不是只需要判断队首就可以了吗</div>2020-05-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ad/c0/ea2b3a14.jpg" width="30px"><span>起飞的鸭子</span> 👍（0） 💬（0）<div>深度好文，大开眼界</div>2020-05-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/ac/b4/2ff229cb.jpg" width="30px"><span>侠影</span> 👍（0） 💬（0）<div>有序队列中替换一个节点的心跳信息，不也需要遍历由于队列吗？这里有什么优化方案吗？</div>2020-05-28</li><br/>
</ul>