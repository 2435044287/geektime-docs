你好，我是陶辉。

上一讲我们介绍了如何通过监控找到性能瓶颈，从这一讲开始，我们将具体讨论如何通过分布式系统来提升性能。

在第一部分课程中，我介绍了多种提升单机处理性能的途径，然而，进程的性能必然受制于一台服务器上各硬件的处理能力上限。如果需要进一步地提升服务性能，那只有整合多台主机组成分布式系统才能办到。

然而，当多台主机通过网络协同处理用户请求时，如果主机上的进程含有数据状态，那么必然需要在多台主机之间跨网络同步数据，由于网络存在时延，也并不稳定，因此不可靠的数据同步操作将会增加请求的处理时延。

CAP理论指出，当数据同时存放在多个主机上时，可用性与一致性是不可兼得的。根据CAP的指导性思想，我们可以通过牺牲一致性，来提升可用性中的核心因素：性能。当然，在实践中对一致性与性能并不是非黑即白的选择，而是从概率上进行不同程度的取舍。

这一讲，我们将基于分布式系统中的经典理论，从总体上看看如何设计一致性模型，通过牺牲部分数据的一致性来提升性能。

## 如何权衡性能与一致性？

首先，这节课针对的是**有状态服务**的性能优化。所谓有状态服务，是指进程会在处理完请求后，仍然保存着影响下次请求结果的用户数据，而无状态服务则只从每个请求的输入参数中获取数据，在请求处理完成后并不保存任何会话信息。因此，无状态服务拥有最好的可伸缩性，但涉及数据持久化时，则必须由有状态服务处理，这是CAP理论所要解决的问题。
<div><strong>精选留言（6）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/7f/91/962eba1a.jpg" width="30px"><span>唐朝首都</span> 👍（21） 💬（0）<div>Idc内部因为时延小，网络稳定，可采用同步模式；不同Idc之间，可采用异步模式，以保证各Idc的性能，实现最终的一致性。</div>2020-06-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/34/df/64e3d533.jpg" width="30px"><span>leslie</span> 👍（2） 💬（0）<div>老师说的物理模型其实是主从与灾备：2地3中心。
其实同城主从速率还好，我觉得这块其实云服务在这块还是做的不错的。
异地网络问题确实没有过多的好的选择：可能我们能做的选择只是把某些关键设备放在这块相对好的城市，曾经某金融交易所就是因此把核心机房搬到某一线城市。</div>2020-06-29</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eo2SjCeylLv0P3Glle5277kA4b8cAuxr1NrC0njPKEqzSpB8IEicHB29GicFFwG1qiaxs4hxRiaBmoibVw/132" width="30px"><span>阳仔</span> 👍（2） 💬（0）<div>相同idc内可以考虑强一致性cp，不同idc间选择ap，达到最终一致性就可以</div>2020-06-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/19/f9/62ae32d7.jpg" width="30px"><span>Ken</span> 👍（1） 💬（2）<div>老师，对于多机房往往存储也会做双活，在这个基础上，是否应用&#47;中间件的数据同步也能依赖于存储双活实现呢？</div>2020-06-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/bc/25/1c92a90c.jpg" width="30px"><span>tt</span> 👍（1） 💬（0）<div>如果把缓存和对应的源看做异构的副本，那write backq就能对应于异步复制，write through就能对应于同步复制了。这样忽略底层细节，只从数据一致性的角度出发，就可以统一记忆这两种处理数据的方法了。</div>2020-06-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/6f/a6/8a9cbc4f.jpg" width="30px"><span>新@青春</span> 👍（0） 💬（0）<div>对于某些一致性要求特别高的请求，采用同步比较合适，性能相对而言重要性轻，对于一致性要求不高的请求，采用异步，比较比较合适，提高用户的体验。需要对功能进行拆分（按一致性的重要性）。不知这样理解，老师认为会有些偏吗？</div>2020-06-25</li><br/>
</ul>