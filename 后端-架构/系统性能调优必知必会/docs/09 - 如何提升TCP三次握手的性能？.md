你好，我是陶辉。

上一讲我们提到TCP在三次握手建立连接、四次握手关闭连接时是怎样产生事件的，这两个过程中TCP连接经历了复杂的状态变化，既容易导致编程出错，也有很大的优化空间。这一讲我们看看在Linux操作系统下，如何优化TCP的三次握手流程，提升握手速度。

TCP是一个可以双向传输的全双工协议，所以需要经过三次握手才能建立连接。三次握手在一个HTTP请求中的平均时间占比在10%以上，在网络状况不佳、高并发或者遭遇SYN泛洪攻击等场景中，如果不能正确地调整三次握手中的参数，就会对性能有很大的影响。

TCP协议是由操作系统实现的，调整TCP必须通过操作系统提供的接口和工具，这就需要理解Linux是怎样把三次握手中的状态暴露给我们，以及通过哪些工具可以找到优化依据，并通过哪些接口修改参数。

因此，这一讲我们将介绍TCP握手过程中各状态的意义，并以状态变化作为主线，看看如何调整Linux参数才能提升握手的性能。

## 客户端的优化

客户端和服务器都可以针对三次握手优化性能。相对而言，主动发起连接的客户端优化相对简单一些，而服务器需要在监听端口上被动等待连接，并保存许多握手的中间状态，优化方法更为复杂一些。我们首先来看如何优化客户端。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="" width="30px"><span>Geek_1386e9</span> 👍（58） 💬（2）<div>我在生产系统中确实遇到了accept队列溢出导致的请求超时问题，这种问题确实不容易被发现，服务器cpu、内存、连接数监控指标都正常，只是磁盘读写时间偶尔会偏高，当时为了解决这个问题，我搭建了一个测试环境，客户端用wrk发起请求，服务端用dd模拟磁盘大量读写导致io响应慢。并用blktrace+fio分析io，同时两边用tcpdump抓包，通过抓包数据发现服务端忽略了第三次握手客户端发来的ack（tcp_abort_on_overflow=0），又重发了第二次握手的syn+ack的包，响应超过了客户端的超时时间设置，google后才知道了是因为accept队列溢出的问题，结论就是我们使用的公有云虚拟机因为同宿主机上其他客户的虚拟机io大导致我们的虚拟机磁盘读写时间长，应用程序处理慢，没能及时从accept队列里拿连接处理，导致accept队列溢出，调大accept队列只能缓解溢出情况，提升程序处理速度才能根本解决，后面我们申请了独享的虚拟机，并且换成了共享ssd磁盘，并把io调度算法改成了noop，问题完美解决，性能杠杠滴</div>2020-06-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/82/3d/356fc3d6.jpg" width="30px"><span>忆水寒</span> 👍（21） 💬（2）<div>本文的干货满满的，虽然都熟悉，但是没有这么底层的优化过。
当网络丢包严重的时候，可以使用快速重传机制。重传时间间隔是指数级退避，直到达到 120s 为止，总时间将近 15 分钟，重传次数默认是 15次 ，重传次数默认值由 &#47;proc&#47;sys&#47;net&#47;ipv4&#47;tcp_retries2 决定。</div>2020-05-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/63/2e/e49116d1.jpg" width="30px"><span>Geek_007</span> 👍（18） 💬（1）<div>看评论区，很多同学都说是长连接，普通的http keepalive 会不会有坑，三大运营商或者中间网络设备都会将超过一定时间的链接drop掉。如果没有h2这种ping保活的机制，有可能客户端莫名其妙长链接被drop掉，客户端只能依赖超时来感知异常，反倒是影响性能了。</div>2020-05-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7f/99/6a92ff95.jpg" width="30px"><span>Jesson</span> 👍（13） 💬（3）<div>老师，TFO编程的时候，为什么要改为sendto或者sendmsg啊？ 这个地方原理不太懂。</div>2020-05-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/51/29/24739c58.jpg" width="30px"><span>凉人。</span> 👍（11） 💬（1）<div>做过优化，长连接， 减少time_wait时长，复用time_wait连接</div>2020-05-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg" width="30px"><span>那时刻</span> 👍（7） 💬（2）<div>使用http的时候，为了减少tcp链接，重复使用已经链接的tcp，设置nginx的keepalive参数。</div>2020-05-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/f0/a4/9d8c3dc3.jpg" width="30px"><span>半生</span> 👍（5） 💬（1）<div>老师，请教一个问题，都是减少tcp握手的代价，那tfo和长链接分别是什么使用场景，或者说，什么场景下，tfo会比长链接性价比更高？</div>2020-09-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c9/75/62ce2d69.jpg" width="30px"><span>猿人谷</span> 👍（3） 💬（1）<div>这篇文章太精彩了，赏心悦目啊</div>2020-05-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/85/0c/252a1149.jpg" width="30px"><span>军</span> 👍（2） 💬（1）<div>感觉小林coding就是抄的这篇，太干货了，😁</div>2020-12-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5f/83/bb728e53.jpg" width="30px"><span>Douglas</span> 👍（2） 💬（4）<div>【accept队列溢出】这里讲的比较模糊，accept队列溢出。是把已经建立好的连接丢弃， 还是因为队列已满，所以，后续进来的连接直接丢弃呢？</div>2020-07-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/af/92/164e40f3.jpg" width="30px"><span>Raymond</span> 👍（2） 💬（1）<div>老师 今天内容很有价值让我对tcp连接有了更深入的了解，此时我有些问题 1.在内容中只讲到了服务端在建立连接的时候 会维护 半连接队列，和accep队列，我想问在这个过程当中，客户端会维护队列吗？如果有的 是什么样结构和规范?第二个问题  就是确认下 我今天听课的一个 收获， 我的总结是 在tcp传输过程当中 无论是客户端和服务端 再给对方发送请求时 必须要有回应，如果没有回应就会通过重试机制来重发，重试一定次数后仍然没有回应 就确认失败， 而对方在处理请求异常后，比如服务端队列已满，无法建立连接，或者异常之后，默认情况下也不会告诉对方，通过对方的重试来感知失败，RST复位是个例外 </div>2020-05-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/0e/c77ad9b1.jpg" width="30px"><span>eason2017</span> 👍（1） 💬（1）<div>文章精彩，佩付大师！</div>2020-05-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/88/d0/6e75f766.jpg" width="30px"><span>有朋自远方来</span> 👍（1） 💬（3）<div>这个 cookie  和常说的 cookie session 是一回事么？</div>2020-05-19</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKtVXiaJbfkpeXH4udkPUIlFte7z3HWMebdogk8jFpgFEkJ0ruGiawUMUcZj9RLpLkIWxV7QOzbHoSg/132" width="30px"><span>小一日一</span> 👍（1） 💬（1）<div>干货满满的一节，感谢老师</div>2020-05-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a9/36/d054c979.jpg" width="30px"><span>G.S.K</span> 👍（0） 💬（1）<div>老师，syn半连接队列、accept连接队列为什么采用队列这种数据结构，五元组是如何跟队列中的某一项关联起来的呢？</div>2020-06-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/52/5b/92eff66d.jpg" width="30px"><span>为人民服务</span> 👍（0） 💬（1）<div>很强很强，陶老师的nginx真是在工作中受益良多。</div>2020-06-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（0） 💬（1）<div>这些 linux 有关网络的参数 是怎么查看的？哪个参数在哪个配置文件的？ 可以直接查询到吗？</div>2020-05-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/64/9b/d1ab239e.jpg" width="30px"><span>J.Smile</span> 👍（8） 💬（0）<div>看来要做一个能承受高并发的服务端，从前到后各个节点都要做关注和优化：syn半连接队列---&gt;accept队列----&gt;应用程序连接获取速度（epoll异步编程）---&gt;应用程序获取连接后的业务处理速度（非阻塞）。</div>2020-06-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/63/2e/e49116d1.jpg" width="30px"><span>Geek_007</span> 👍（6） 💬（1）<div>老师，今天的内容很多只适用于内网通信或者服务端单边优化吧。生产场景，客户端经常是手机或者PC.无法修改客户端内核参数。另外TFO适用于公网么？运营商或者移动端会不会对TFO不支持。(难道非得QUIC才能优化客户端的网络连接吗)😀</div>2020-05-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/7f/91/962eba1a.jpg" width="30px"><span>唐朝首都</span> 👍（3） 💬（0）<div>刚学习了两个知识点：
（1）syncookies功能
当SYN 半连接队列已满时，并非只能丢弃连接，服务端可以实时计算出一个状态值与SYN+ACK 报文一同发出，客户端返回报文时进行实时解析验证，如果通过也是可以建立连接的，减少了客户端不断重试的时间。
（2）TFO
首次建立连接之后，客户端与服务端分别存储加密的Cookie，解决后续的信任问题，这样后续就无需再经历同样的三次握手，减少建立连接的时间。</div>2020-05-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg" width="30px"><span>我来也</span> 👍（3） 💬（0）<div>很实用的一篇文章。

今天又有新的收获，原来TFO是这么个意思，原理是这样的。
之前只在某些网络代理软件中看到过tcp_fastopen选项，但不知道啥意思。现在就明白了。
话说光软件层面开启了，内核未开启，也是享受不了的。这个就得看看内核是否默认开启了。</div>2020-05-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4a/15/106eaaa8.jpg" width="30px"><span>stackWarn</span> 👍（1） 💬（0）<div>老师讲的优化在运维工作中都有做过，关于连接队列可以通过systemtap等工具去做下实验，我补充下自己曾经做过测试的结论，半连接队列大小的值和 tcp_max_syn_backlog  以及全连接队列的那两个参数即 somaxconn 和 应用层的backlog 这三个都有关系，感谢老师的讲解，不知道生产环境中tfo有没有什么问题呢？现在有哪些公司是否有开启TFO了，求科普</div>2020-06-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/00/8e/ebe3c8ea.jpg" width="30px"><span>董泽润</span> 👍（1） 💬（0）<div>访量很大时，time_wait 会非常多，一般都用长连接来规避这个问题。但是长连接也有问题，比如保活，比如当服务端挂了，但是因为网络隔离客户端还没感知道，这时请求就会有大量超时</div>2020-05-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/44/19/a2fa21af.jpg" width="30px"><span>爱谁谁</span> 👍（1） 💬（0）<div>预建连接，连接复用，多IP竞速建立链接和复合连接~ </div>2020-05-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/48/19/14dd81d9.jpg" width="30px"><span>铲铲队</span> 👍（0） 💬（0）<div>“开启 syncookies 功能就可以在不使用 SYN 队列的情况下成功建立连接”   ---&gt;怎么理解这句话呢，老师，我看这句话的配图，看起来比较迷惑，看起来收到SYN后还是会放到SYN队列，然后返回SYN cookie的样子，怎么解释没有使用SYN队列？对于这种情况下，收到SYN以后，数据是怎么存放的？</div>2022-05-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/48/19/14dd81d9.jpg" width="30px"><span>铲铲队</span> 👍（0） 💬（0）<div>老师，您好，sysyncookies中的cookie和TFO中的cookie是一个东西吧？</div>2022-05-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/de/d4/b83c4185.jpg" width="30px"><span>David.cui</span> 👍（0） 💬（0）<div>
net.ipv4.tcp_syn_retries = 6。应该在服务器还是客户端设置</div>2022-01-14</li><br/><li><img src="" width="30px"><span>Geek_LYQ</span> 👍（0） 💬（0）<div>通常情况下，应当把 tcp_abort_on_overflow 设置为 0，因为这样更有利于应对突发流量。举个例子，当 accept 队列满导致服务器丢掉了 ACK，与此同时，客户端的连接状态却是 ESTABLISHED，进程就在建立好的连接上发送请求。只要服务器没有为请求回复 ACK，请求就会被多次重发。
陶老师，这句话“只要服务器没有为请求回复 ACK，请求就会被多次重发”不理解，Server由于连接队列满而丢ACK情况下，服务端已经是ESTABLISHED状态，并不会再回复ACK给客户端了，那么客户端怎么知道要重复ACK+请求数据呢？

</div>2021-04-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/e3/4d/8a26dbb2.jpg" width="30px"><span>枫中浪子</span> 👍（0） 💬（0）<div>文中写到：客户端发送 SYN 开启了三次握手，此时在客户端上用 netstat 命令（后续查看连接状态都使用该命令）可以看到连接的状态是 SYN_SENT（顾名思义，就是把刚 SYN 发送出去）。
请问老师这个syn是用什么工具构造的？如果不是构造的，正常情况下三次握手很快，看不到连接的中间状态吧</div>2021-04-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/03/1c/c9fe6738.jpg" width="30px"><span>Kvicii.Y</span> 👍（0） 💬（1）<div>TFO只是省掉了第二阶段客户端到服务端到那个ACK的RTT吗？</div>2020-06-23</li><br/>
</ul>