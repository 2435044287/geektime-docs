你好，我是王庆友。

在上一讲中，我和你详细介绍了打造一个高性能系统的应对策略和架构手段。那么今天，我就以1号店的秒杀系统为例，来具体说明如何实现一个高性能的系统。

## 背景和问题

先说下背景。在2014年的时候，1号店作为网上超市类电商，经常在线上举行各种大促活动。比如进口牛奶促销活动，每次促销的牛奶有几十万盒，促销价格非常优惠，一般这样的促销活动会在某个整点的时间进行开卖（如上午10点）。对于这种质高价优并且是刚需的商品，会有大量的用户来抢购，俗话说“手快有，手慢无”，往往短短几分钟内，所有牛奶就能售卖完毕。

这本质上是一种秒杀活动，但商品数量非常大，一瞬间会有大量的用户流量涌入，流量可以高达平时的几十倍。而且和少量商品的秒杀不同，这些都是有效流量，最终会生成订单。

而在正常情况下，系统因为资源有限，只能处理10%的流量，无法处理剩下的90%流量，瞬间高并发的流量涌入，很大程度上会引起后台系统超时报错，导致用户下单不成功。这样一来，用户就会反复刷新页面，多次尝试下单，不但用户的体验不好，而且系统的压力会更大。

**最终的结果就是，系统往往由于过载，整体处理能力下降，甚至瘫痪，导致所有用户都无法购买。**就像下图表示的一样，在秒杀场景下，系统会面临这样的困境：
<div><strong>精选留言（26）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/36/4c/46c43cce.jpg" width="30px"><span>小祺</span> 👍（14） 💬（2）<div>20W用户下单成功，后面的用户提示下单失败，预下单成功的用户全部放弃支付，导致活动结束了但是商品没卖出去，怎么解决？</div>2020-03-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/d0/14/50782491.jpg" width="30px"><span>zeor</span> 👍（9） 💬（3）<div>老师您好，当正常下单时采用同步方式，但流量也很大，如果按您说的，库存只有一个库，但库已经达到了瓶颈，有什么方式在同步情况下解决这个瓶颈？</div>2020-03-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/0a/7d/ac715471.jpg" width="30px"><span>独孤九剑</span> 👍（3） 💬（3）<div>请问老师，如何处理“商品详情页”在秒杀时间段的过载问题呢？</div>2021-05-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/0b/c8/15f055d3.jpg" width="30px"><span>图灵机</span> 👍（2） 💬（4）<div>redis list 没有设置初始长度的操作吧，那么这个初始长度值是另存到一个key中吗，这样的话每次新增订单需要先查一次初始长度和list llen吧?还有lindex是时间复杂度O(n)的操作吧,假如都是十万量级的list长度，redis是用链表去存，这样的话遍历也用不到局部性原理，实际应用中需要考虑这种问题吗？还有一个问题就是处理完成的订单订单号会从队列里弹出吗，这样的话和商品数量1:1的队列长度再有新的订单号进来不就超过实际商品量了吗？如果处理订单是维护一个游标移动的话是不是就符合这个问题了</div>2020-08-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/9d/01/23306c79.jpg" width="30px"><span>蓝天</span> 👍（2） 💬（2）<div>排队数据存在redis中是不也需要开启持久化呢</div>2020-03-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/64/9b/d1ab239e.jpg" width="30px"><span>J.Smile</span> 👍（2） 💬（1）<div>如果有些前置知识会比较好，比如流量洪峰到来的时候对于秒杀这种类型的活动，首先要把流量接下来，起码不能在网关入口处就被拒绝了，这个时候能用到的技术有哪些，比如nginx或者其他的方式。接下来，流量怎么分发到后端的应用服务器，负载均衡或者是直接操作redis，这里也有一些技术点。
老师整体上讲的比较言简意赅，不过我还是想关注下一些技术点，哪怕一笔带过略微提一下，也可以受益匪浅哈！感谢！</div>2020-03-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/e7/13/6f76ada6.jpg" width="30px"><span>大龄程序员在线治掉发</span> 👍（1） 💬（1）<div>用户在排队中,如果要通知用户秒杀成功或失败,这个时候是不是应该使用websocket的方式推送?</div>2021-05-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/97/e1/0f4d90ff.jpg" width="30px"><span>乖，摸摸头</span> 👍（1） 💬（1）<div>根据排队号获取消息在队列中的位置，是怎么实现的？redis list 并没找到这样的接口。如果是通过 LINDEX 来获取，感觉比 遍历还慢。

为啥还要弄个请求队列，不直接去读商品秒杀队列，商品队列读取不到了就返回失败</div>2020-06-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/81/e6/6cafed37.jpg" width="30px"><span>旅途</span> 👍（1） 💬（1）<div>老师,后台服务消费队列的线程数这个是压测得来的吗,这个是使用的程序内部的线程是吧</div>2020-05-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/56/06/ea49b29d.jpg" width="30px"><span>小洛</span> 👍（1） 💬（1）<div>首先感谢老师您的分享 有两个问题请教下老师：
1、一个秒杀商品一个单独redis队列，如果秒杀商品几十万，就算按照1:1的比例  那么理论上瞬间也有10万的请求打到redis上，单个redis 支撑10W， 这里是不是还有一些限流的策略？
2、老师能加餐分享下库存的方案吗
</div>2020-04-05</li><br/><li><img src="" width="30px"><span>肖奈</span> 👍（0） 💬（1）<div>问两个问题：
如果无法提前识别是秒杀商品怎么办？
用redis库存扣减异步刷db，下单失败库存回补怎么做？（回补是要依靠正向扣减流水的，否则会出问题）</div>2023-07-12</li><br/><li><img src="" width="30px"><span>公众号：咔咔闲谈</span> 👍（0） 💬（1）<div>抢购20W商品，队列里数量已经达到20，此时队列里还进不进数据？</div>2023-03-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/1b/9d/78cd27a9.jpg" width="30px"><span>被雪吹过的夏天</span> 👍（0） 💬（1）<div>&quot;如果发现秒杀流程有问题，我们还可以快速切回到常规的购物流程&quot; ，和下文  &quot;因此我们建立了活动库存的概念，把少量参与促销的商品种类单独放在一个库里&quot;。  换言之，常规和秒杀两个流程，都会指向一个单独的活动库。  这样可能引发几个问题:  1. 势必要修改常规流程的业务代码，2. 常规流程扣减库存会操作两个数据库</div>2021-09-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/1b/93/e3b44969.jpg" width="30px"><span>sgl</span> 👍（0） 💬（3）<div>用redis做队列，如果一个商品有40万库存，这个队列就是大key，会有这个问题吗</div>2020-09-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/b8/91/1cc25137.jpg" width="30px"><span>……</span> 👍（0） 💬（1）<div>根据排队号获取消息再队列中的位置，怎么实现的，通过遍历吗？</div>2020-04-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c6/00/683bb4f0.jpg" width="30px"><span>正在减肥的胖籽。</span> 👍（0） 💬（1）<div>老师您好。我有几个问题先请教你下。
1.如果系统有上万个商品，redis一个商品一个队列，然后生成上万个队列？
2.异步化处理逻辑，来削峰流量。但是如果需要同步，库存事实扣的？这种可以讲一下吗？因为数据库是有状态的，数据库并发能力就比较弱，这方面可以讲一下吗？
3.</div>2020-03-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg" width="30px"><span>Jxin</span> 👍（2） 💬（6）<div>1.秒杀案例讲得很棒。
2.外卖那个场景，其实单纯讲加机器，易伸缩。感觉没说到点子上。这个场景其实是做性能优化，价值会很高的场景。如何通过技术手段和各种权衡，在有限的资源下满足更多的并发。这个话题会比较在点子上。
3.限于篇幅，已经很棒，感谢栏主分享。</div>2020-03-30</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83er0h19PTdaZDp4oHBHocYp5uYZicCPMibIPQ9c8TP29hRObZl8kJgaSQHdHGdXGCRiaLibJN3I1IxnWKg/132" width="30px"><span>Geek__b3bddc1474fa</span> 👍（1） 💬（1）<div>我之前做过电商中央库存系统的建设，活动库存的难点不在于文章中的内容。一个品今天可以作为活动库存，明天可以作为非活动库存，甚至一天内50%作为活动品去卖，50%作为非活动品去卖。如果产品提出这种需求，文章的方案就行不通哦</div>2022-08-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/67/ab/fcf0cec4.jpg" width="30px"><span>寒光</span> 👍（1） 💬（0）<div>库存扣减部分，有一个思路是先把要扣的写一条记录到一个流水表，后面检查库存够不够是就拿库存表中的库存减去流水表中的汇总库存，够就继续写入流水表，不够就返回库存不够。

这样减少了真实库存表因为更新操作带来的并发效率下降问题。

当然，流水表里的记录不能太多，达到一定数量后就要及时转移并更新真实库存表。</div>2021-01-08</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyLCPnVq4gKMN5jPcd9wVVEXtZMibCNAkLrJf4uZKdV40Nelb3uPtCETfuw5hbbC693sUHQpRUMiaA/132" width="30px"><span>Robin康F</span> 👍（1） 💬（0）<div>公司应对高并发的措施有：限流、降级、异步消息、redis缓存化、增加节点</div>2020-05-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/74/d5/bd75fe69.jpg" width="30px"><span>😶😶😶😶</span> 👍（0） 💬（0）<div>改变业务流程  </div>2022-08-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/78/15/a8b7315c.jpg" width="30px"><span>兔子先生</span> 👍（0） 💬（0）<div>老师，期待外卖订单的午高峰来一讲</div>2021-09-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/30/c1/2dde6700.jpg" width="30px"><span>密码123456</span> 👍（0） 💬（0）<div>通过排队系统，对流量进行消峰</div>2020-05-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0f/bf/ee93c4cf.jpg" width="30px"><span>雨霖铃声声慢</span> 👍（0） 💬（0）<div>我们的并发场景没那么多用户，所以靠最土的办法: 增加机器节点+缓存 扛过去的，囧</div>2020-04-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/bc/25/1c92a90c.jpg" width="30px"><span>tt</span> 👍（0） 💬（0）<div>这节课讲得方法挺适合我们的，我们之前上过一个抢购的活动，由于没有经验，所以跑起来很卡，今天讲的方法不复杂，还能解决问题，真好。</div>2020-03-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/46/d1/a1ddf49f.jpg" width="30px"><span>阿杜</span> 👍（0） 💬（0）<div>讲解的比较精炼，也很实用，能满足大部分秒杀业务，业务落地简单快速。</div>2020-03-30</li><br/>
</ul>