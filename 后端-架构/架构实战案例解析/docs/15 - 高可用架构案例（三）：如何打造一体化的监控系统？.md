你好，我是王庆友。

上一讲，我与你介绍了整体化监控系统的设计方案，今天我就带你深入它的内部设计，让你可以了解它具体是如何落地的。

这个监控系统主要分为4大部分：节点信息采集、节点接入、数据上报和前端展示。下面，我就来为你具体展开介绍。

## 节点信息采集

在上一讲中，我提到过，Agent负责采集节点的健康数据，每隔3s，主动访问一次；然后，Agent会根据这些数据，结合相应的规则，来判断节点的健康状态。最终的健康状态有三种，分别是错误、警告和正常，这三种状态也对应了Dashboard中节点的红黄绿三种颜色。

节点分为4类：Web应用、Redis、MQ和数据库。下面我就来具体讲一下，系统是如何对它们进行监控的。

- **对于Redis节点**，Agent通过Jredis API，尝试连接Redis实例并进行简单的读写。如果这个操作没有问题，就表明Redis当前的健康状态是正常的，否则就是错误的。
- **对于MQ节点**，Agent是通过MQ API，来检测MQ节点是否有活跃的消费者在连接，同时检测队列积压的消息数量。如果没有活跃的消费者，或者未消费的消息超过了预设的值，就表明当前的MQ节点的健康状态是错误的，否则它就是正常的。
- **对于数据库节点**，Agent是通过JDBC去连接数据库，并对表进行简单的读写。如果操作成功，表明数据库的健康状态是正常的，否则就是错误的。
<div><strong>精选留言（24）</strong></div><ul>
<li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEIE3Vw0icEQic96rOykFD2bUo6KotVx53gvtG0CDe8tUKC3pNXxIQYMuyPyrgL06Zn32UWtEXTIVWMw/132" width="30px"><span>Geek_fd81b3</span> 👍（3） 💬（1）<div>有个疑问请教一下哈：一整个链路下来，某个服务往外提供的接口肯定会有很多，那我根据这个服务的哪个接口来判断我这个服务是否正常呢？举个例子，订单服务可能提供了下单接口，按用户查订单接口，按id查订单接口，订单修改接口等等……老师上边提到提供一个接口，返回这个服务的健康状态，那是否我这个接口里要去通过大量的逻辑，来判断我这个服务是否正常呢？</div>2020-05-28</li><br/><li><img src="" width="30px"><span>Geek_c19d96</span> 👍（3） 💬（2）<div>老师您好，想问下这个系统服务间的依赖关系是通过手动维护的还是通过中间件的数据自动绘制的呢？</div>2020-04-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/78/15/a8b7315c.jpg" width="30px"><span>兔子先生</span> 👍（2） 💬（1）<div>请教老师，所有节点的配置信息存储在数据库，会不会有安全问题。一旦监控系统被黑，所有节点的账号密码全部暴露。
另外，监控设计应该尽量少侵入应用系统，您讲的“SDK 在 HashMap 内部，不会记录每个接口调用的详细日志，而是只维护几个简单的总数值，因此 SDK 对应用的内存和 CPU 影响，都可以忽略不计”具体在落地时候该用什么样的量化指标考虑对系统的侵入程度呢。</div>2021-09-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0d/5a/e60f4125.jpg" width="30px"><span>camel</span> 👍（2） 💬（2）<div>老师你好，我的理解“最近3s”应该是个滑动窗口，而hashmap记录的是每个接口的总时间、总次数等聚合的值，那么下一秒的“最近3s”统计值是怎么根据当前的“最近3s”计算的呢？</div>2021-08-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/db/1a/30201f1a.jpg" width="30px"><span>Geek_kevin</span> 👍（2） 💬（2）<div>请教老师,那个页面的动态布局设计,避免了前端的定制化,这里有没有再具体一点的信息可供参考的?</div>2020-03-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/41/87/46d7e1c2.jpg" width="30px"><span>Better me</span> 👍（2） 💬（1）<div>老师这里对应用的监控是通过agent每3s请求接口得到相关信息，然后取最差接口，这里是否会影响到接口的性能，应该如何平衡</div>2020-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/57/6e/b6795c44.jpg" width="30px"><span>夜空中最亮的星</span> 👍（2） 💬（2）<div>这个是自己开发的？有开源软件的参考吗？</div>2020-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f6/6d/143deae5.jpg" width="30px"><span>冬天的树</span> 👍（1） 💬（3）<div>老师你好，有几个问题请教一下
1.wen应用中是不是需要每一个接口都要调用sdk的logHeahthInfo？这个作用是啥？
2.既然我们有提供一个sdk了，为什么不把这个额外接口直接封装在sdk中呢？这样业务系统就无需在实现了，我理解的是agent调用http是调用这个额外的接口去采集数据
3.监控db的时候，实现简单的插入，那么垃圾出来怎么处理？如果插入验证后就删除，那每次就需要执行2次SQL,那性能如何保证？</div>2021-07-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/9d/01/23306c79.jpg" width="30px"><span>蓝天</span> 👍（1） 💬（1）<div>1，最大的挑战是过度设计，总觉得流量要大到不行，其实并没有
2，我们还在使用rmi调用，虽然性能够用，但扩展性差，个人感觉不适合微服务治理等，但在公司使用较长，有些根深蒂固的，架构师们也不推，不知道是否我的看法不对，老师有啥好的建议呢？</div>2020-03-26</li><br/><li><img src="" width="30px"><span>吴雪峰</span> 👍（0） 💬（1）<div>请教老师， “具体包括最近 3s 的接口调用次数、接口平均响应时间、接口出错次数” 这是对agent的响应的统计吗？还是对正常业务响应的统计。如果是前者，是否有代表性? 如果是后者，不是对每次业务响应都要有所记录？</div>2020-11-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c6/00/683bb4f0.jpg" width="30px"><span>正在减肥的胖籽。</span> 👍（14） 💬（1）<div>老师您好。有参考的代码吗？我主要的困境是代码如何落地。</div>2020-03-25</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyibojtJCnzALT1CleOHlTfS1XpFQHibXA7B2j631I2icHL2Uy5XvvviaEXBWPSNkU5G7LQP3JJHicgzQ/132" width="30px"><span>邹</span> 👍（2） 💬（0）<div>感觉节点间的依赖关系时手动维护的，既然有SDK了，那我们是不是可以考虑SDK来做这个事情，agent调用check方法来收集相关数据。比如说DB，Redis，RPC等依赖在服务启动时拿到相关配置信息，然后再运行过程中，观察相关bean实例的变化来动态的收集信息。比如：Dubbo，还可以在运行过程中查询依赖服务的相关信息。</div>2020-07-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/5b/08/b0b0db05.jpg" width="30px"><span>丁丁历险记</span> 👍（1） 💬（0）<div>两个挑战，技术栈选择，与如何吃掉需求。</div>2020-05-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/5b/08/b0b0db05.jpg" width="30px"><span>丁丁历险记</span> 👍（1） 💬（0）<div>前端至少用个bootstrap  美化一点吧，用yablw  太粗糙了。</div>2020-05-04</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyLCPnVq4gKMN5jPcd9wVVEXtZMibCNAkLrJf4uZKdV40Nelb3uPtCETfuw5hbbC693sUHQpRUMiaA/132" width="30px"><span>Robin康F</span> 👍（1） 💬（0）<div>模块边界划分不清晰，技术栈不能完整保证幂等性</div>2020-04-30</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/LalJD9ruYQI5zVM1GOCe4PjunIbbeeMiacFHC4TAj0DBVeialKt3vRCLs9dxn1vYXvfp8pgcyaeEQkh1nde1JoBQ/132" width="30px"><span>jun</span> 👍（1） 💬（0）<div>有效的监控可以及时发现问题并解决，不过目前很多公司对监控这块并不是很重视，而且考虑人员时间成本，可能根本就不会去认真的做监控这块的东西，后续市面上应该会有专业的监控商业软件来满足这块的需求；</div>2020-04-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0f/bf/ee93c4cf.jpg" width="30px"><span>雨霖铃声声慢</span> 👍（1） 💬（0）<div>架构设计中最大的挑战是如何控制好平衡性，既不过度设计又能满足将来扩展的需求，这个度很难把控。</div>2020-04-05</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqMib1RDh7yMjERiaFvmay128fZw7EWOvUgL08WaxvxtrqBFqjezOTurR1ZnHbicAdiaCy5uwfQJwZicCg/132" width="30px"><span>Minasix</span> 👍（1） 💬（0）<div>以前总是很局限的看项目，业务功能为主，看了老师的课程，发现架构整体层面和监控如此重要，学到了，感谢</div>2020-03-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a2/fb/94af9cf1.jpg" width="30px"><span>Alex</span> 👍（1） 💬（0）<div>监控系统有两条线一条是预警一条是排障。预警就是针对关键指标设阀值主动提醒。排障以业务异常为主线，实现统一日志，纵通过以traceid 看调用链信息，横向看错误时间点附近资源是否异常。我原来按这个思路做的监控。</div>2020-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/bc/25/1c92a90c.jpg" width="30px"><span>tt</span> 👍（1） 💬（0）<div>我觉得难点就在于这一句话“用 20% 的成本，实现了 80% 的效果”。

最近设计的一个系统，目标就是满足业务用最小的代价能最快速地上线新的业务，这样，即使错了，也没有什么损失。

运行了一阵，觉得产品是可以自己生长的，设计之初不用过度设计，让业务去快速使用，然后再来调整系统的设计，帮它更好地生长。</div>2020-03-25</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/6LaITPQ4Lk5fZn8ib1tfsPW8vI9icTuSwAddiajVfibPDiaDvMU2br6ZT7K0LWCKibSQuicT7sIEVmY4K7ibXY0T7UQEiag/132" width="30px"><span>尔东橙</span> 👍（0） 💬（0）<div>现在skywalking  必须要埋点么，那不是代码侵入性很大，有针对现成微服务不修改代码接入的方式么</div>2021-08-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/eb/37/a2f4c9f8.jpg" width="30px"><span>starj</span> 👍（0） 💬（1）<div>感觉这个系统很复杂啊，对于我们人员缺少的小公司很难花时间去实现</div>2020-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg" width="30px"><span>Jxin</span> 👍（0） 💬（0）<div>感觉这个监控应该要包含全链路监控的职能。这样子全链路监控除了定时采样外，还能记录 上述监控异常场景时的调用链路信息。便于定位问题。</div>2020-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8f/bb/7068f251.jpg" width="30px"><span>老姜</span> 👍（0） 💬（0）<div>利用现有的监控的API可以实现吗？不是开源的开发成本不小，还有集成的成本。</div>2020-03-25</li><br/>
</ul>