你好，我是王庆友。

在上一讲中，我提到过，在架构设计中，要实现业务上的复用，一个比较可行的做法是，把各个基础业务封装成共享服务，供上层所有应用调用。所以今天，我就来和你聊一聊，如何从头开始，落地这样一个典型的共享服务。

我们知道，落地一个微服务其实并不困难，但要实现一个能够高度复用的共享服务并不容易，在落地过程中，经常会有一系列的问题困扰着我们。

- 我们事先对服务的边界没有进行很好的划分，结果在落地的过程中，大家反复争论具体功能的归属。
- 由于对业务的了解不够深入，我们要么设计不足，导致同一个服务有很多版本；要么服务过度设计，实现了一堆永远用不上的功能。

**对于落地一个共享服务来说，服务边界的划分和功能的抽象设计是核心。**服务边界确定了这个服务应该“做什么”，抽象设计确定了这个服务应该“怎么做”。

接下来，我就以一个**实际的订单服务例子**，为你详细讲解一下要如何重点解决这两个问题。这样你可以通过具体的案例，去深入地理解如何落地共享服务，实现业务能力的复用。

## 订单业务架构

不同企业的订单业务是不一样的，所以这里我先介绍下这个订单的业务场景。

这是个O2O（Online To Offline，线上到线下）的交易业务，订单的来源有两个，一个是自有小程序或App过来的订单，还有一个是外卖平台过来的订单，然后这些线上的订单会同步到门店的收银系统进行接单和进一步处理。这里我放了一张订单的业务架构图，你可以到文稿中看下：
<div><strong>精选留言（15）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg" width="30px"><span>Jxin</span> 👍（9） 💬（1）<div>1.碰巧也是做订单系统的。
2.目前接管的订单系统是一个开发了四五年的单体订单系统。
3.没有边界划分，以往的实现，基本就是开发将产品的业务逻辑翻译成代码。现象就是部分拆单策略非常复杂，所有本该外部系统承接的业务逻辑都由订单组完成。这就导致你想维护订单组，支付，营销，会员，商品你都要懂业务。（起步简单，可能这些现在的分组都是那么几个人来完成，但随着业务线的发展，各组的业务都膨胀了很多，已经不是个人短时间能够掌握的）。
4.代码耦合非常严重，一个商品组的表对象do，会在各个组的api包里面被依赖，相关的业务逻辑也严重依赖该do。牵一发动全身，常常因为一个字段的调整开很久的会议。
5.代码实现没任何扩展性和灵活性，大量逻辑判断依赖入参状态，导致从单体转多元输入后，一个方法动不动就上千行代码，大量根据数据元做逻辑跳转的代码。

6.职责模糊，功能复杂，代码耦合高，实现逻辑基本硬编码没有扩展的能力，没有任何单元测试。

7.现在需要该项目能灵活支撑多元业务的接入，基本就是单体往saas发展了。我能想到的方法都需要较大成本，因为最小的组成单元“策略”，本身的实现不具备可灵活复用的特性，必须重构其实现方式。但如此一来，成本太大。领导是接受不了的。</div>2020-03-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/56/06/ea49b29d.jpg" width="30px"><span>小洛</span> 👍（6） 💬（1）<div>请教下老师
1、关于设计两个状态字段管理订单主状态和子状态，可以主状态是个单独字段，而子状态放在扩展字段吗？那么订单还承接按照子状态纬度的查询
2、关于订单主状态，基本状态是不可变的，比如支付，下单，结账（结束）但是我们公司的业务就是结账状态有个逆操作反结账，然后还可以不停地在原订单的基础上再加菜，这样的设计合理吗</div>2020-03-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/64/9b/d1ab239e.jpg" width="30px"><span>J.Smile</span> 👍（6） 💬（4）<div>老师好，订单服务在异步通知应用的时候使用的技术我觉得不一定非要mq吧，只要应用把自己的通知url告知订单服务，订单服务负责在信息变动时进行推送就可以了，这种更简单一些，不过可能可用性不是很高而已。</div>2020-03-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/40/47/b62d0a64.jpg" width="30px"><span>中国合伙人</span> 👍（5） 💬（1）<div>我想问一下，订单模型不一样，我们经常通过扩展字段存储差异化数据。那在哪解析扩展字段？基础服务负责解析这些差异字段吗？这里要怎么设计不同业务类型订单查询？</div>2020-03-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c3/88/d16816a8.jpg" width="30px"><span>如来神掌</span> 👍（2） 💬（1）<div>数据如何存储? 比如A应用产生的数据和B应用产生的数据，在数据库设计上如何设计和存储呢？</div>2020-11-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/01/0d/75b3cb10.jpg" width="30px"><span>AYOU</span> 👍（2） 💬（2）<div>老师好：
  1.基本信息管理里面有用户信息，这个用户信息是用户系统的用户基本信息吗？上层系统下单组装用户信息时，订单系统只存用户id还是存一个用户的基本信息？
  2.一般退货的流程是在订单系统做吗？</div>2020-03-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/46/c0/106d98e7.jpg" width="30px"><span>Sam_Deep_Thinking</span> 👍（1） 💬（1）<div>请问一下，针对c端的下单接口，是由订单基础服务来提供还是由订单的聚合服务来提供？如果是基础服务来提供的话，那由于下单的时候，还是需要调用其他服务获取数据，进行订单数据落地，这就违反了文章中提到的原则，如果是聚合层来提供下单接口的话，那么基础服务落地订单数据时，聚合层就必须传递订单所需要的所有数据。</div>2020-06-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ef/09/904be048.jpg" width="30px"><span>蓦然回首</span> 👍（1） 💬（1）<div>老师好，针对订单服务，如果要支持的业务模型不一样，比如商品、酒店、外卖，订单接口比如下单，是使用一个接口还是按业务分成多个接口比较好？底层存储是按业务分开存储，还是通过通过抽象和扩展放到一个库中好呢？</div>2020-04-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ee/d2/7024431c.jpg" width="30px"><span>探索无止境</span> 👍（9） 💬（0）<div>可惜只有22讲，每一讲都有收获</div>2020-03-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/bc/25/1c92a90c.jpg" width="30px"><span>tt</span> 👍（5） 💬（3）<div>可复用的两个点：清晰的边界划分和抽象的内部设计。

1、对于边界划分。在服务的设计之处，总是会现有一个头脑风暴、各方需求裹挟的发散过程，然后随着设计的进行，必需经过收敛，所以我觉得界定服务不做什么更有实践意义。同时，服务功能越单一，越利于复用。

2、对于内部抽象设计。

我听完本科，觉得抽象设计还是紧紧的围绕到目前为止的不变的核心：数据和规则（这里特制对外的服务）。

对于数据，不仅要保证需要的数据要覆盖全面（基础信息、组合信息、外部系统使用的信息——之前的可也讲过，服务是相互正交、互不调用的，但可以共享一定的数据），而且要考虑数据是动态的（比如订单状态的变化），变化就涉及到状态检验规则。这就又涉及到了数据的全面到底是什么含义？是胡子眉毛一把抓么？不是的，是应该抓主要矛盾（比如订单分为基本状态和子状态）


不主动调用外部，并不是说和外部没有信息交互。这时，使用消息队列进行消息通知自然是一个好的选择，使得内外部解耦。

进一步，订阅发布模式使得发布消息的实体和接受消息的实体解耦了，双方只需要面对消息本身即可。这是一个理解消息队列的高级的视角。</div>2020-03-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ef/8d/5c0d2e9c.jpg" width="30px"><span>Iqexception</span> 👍（0） 💬（0）<div>这样设计的订单系统就只剩下CRUD了</div>2024-07-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d8/02/c749e2c7.jpg" width="30px"><span>天空</span> 👍（0） 💬（0）<div>这一讲精彩</div>2021-07-29</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/ydFhHonicUQibGlAfsAYBibNOfSxpCG5cJNp9oRibTJm3TrxM7Hj4WPPCRE3vluZJb0TGQqpKCaBWLdmra5Su1KF5Q/132" width="30px"><span>yudidi</span> 👍（0） 💬（1）<div>&quot;主状态和子状态&quot;这种设计，我们有些其他业务(非订单业务)也有用到, 使用过程中有2点感觉不舒服: 
比如有主状态A(其下子状态a1,a2),主状态B(其下子状态b1,b2),
1.如果子状态从a2切换为b1, 还需要变更主状态A=&gt;B。
2.状态正向变化很ok,但是状态逆向变化是很麻烦的。比如从b2回到a2, 那么主状态也要从B恢复A。
如果业务的状态很多，又有逆向变化情况，那么大家一定会遇到这些问题，不知道大家有何高见。
这算是业务自身复杂度导致的吗?
</div>2020-10-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/30/c1/2dde6700.jpg" width="30px"><span>密码123456</span> 👍（0） 💬（0）<div>我觉得最难的就是，服务的划分和通用化设计。异步通知解耦和主动调用接口粒度划分会容易很多。</div>2020-04-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/3e/39/de5a3618.jpg" width="30px"><span>舞命小丢</span> 👍（0） 💬（0）<div>讲的挺好的</div>2020-03-28</li><br/>
</ul>