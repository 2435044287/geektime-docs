你好，我是盛延敏，这里是网络编程实战第13讲，欢迎回来。

在上一篇文章里，我在应用程序中模拟了TCP Keep-Alive机制，完成TCP心跳检测，达到发现不活跃连接的目的。在这一讲里，我们将从TCP角度看待数据流的发送和接收。

如果你学过计算机网络的话，那么对于发送窗口、接收窗口、拥塞窗口等名词肯定不会陌生，它们各自解决的是什么问题，又是如何解决的？在今天的文章里，我希望能从一个更加通俗易懂的角度进行剖析。

## 调用数据发送接口以后……

在前面的内容中，我们已经熟悉如何通过套接字发送数据，比如使用write或者send方法来进行数据流的发送。

我们已经知道，**调用这些接口并不意味着数据被真正发送到网络上，其实，这些数据只是从应用程序中被拷贝到了系统内核的套接字缓冲区中，或者说是发送缓冲区中**，等待协议栈的处理。至于这些数据是什么时候被发送出去的，对应用程序来说，是无法预知的。对这件事情真正负责的，是运行于操作系统内核的TCP协议栈实现模块。

## 流量控制和生产者-消费者模型

我们可以把理想中的TCP协议可以想象成一队运输货物的货车，运送的货物就是TCP数据包，这些货车将数据包从发送端运送到接收端，就这样不断周而复始。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/cb/61/b62d8a3b.jpg" width="30px"><span>张立华</span> 👍（24） 💬（1）<div>非阻塞socket，对于write和send， 返回实际发送的字节数。所以一般在while里不断发送，直到全部发送完毕。    send根据只要根据要发送的buf做个偏移，很方便。   而writev 就很繁琐了啊</div>2019-08-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/27/cd/aa796a0d.jpg" width="30px"><span>Donkey</span> 👍（19） 💬（5）<div>请教老师一个愚钝问题：大数据循环发送时，那接收方怎么接收才能接收完整的包？不会发生粘包等现象呢？</div>2019-09-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4d/fd/0aa0e39f.jpg" width="30px"><span>许童童</span> 👍（12） 💬（4）<div>TCP 拥塞控制算法,我知道最新的有BBR算法，这个算法在网络包填满路由器缓冲区之前就触发流量控制，而不在丢包后才触发，有效的降低了延迟。</div>2019-08-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/f3/b3/0ba7a760.jpg" width="30px"><span>一凡</span> 👍（9） 💬（2）<div>telnet是使用Nagle 算法的吗，但是远程操作是实时性的呀？额</div>2020-04-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7c/16/4d1e5cc1.jpg" width="30px"><span>mgxian</span> 👍（8） 💬（4）<div>问题1 ： grep &#39;IOV_MAX&#39; &#47;usr&#47;include&#47;limits.h</div>2019-09-18</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKVUskibDnhMt5MCIJ8227HWkeg2wEEyewps8GuWhWaY5fy7Ya56bu2ktMlxdla3K29Wqia9efCkWaQ/132" width="30px"><span>衬衫的价格是19美元</span> 👍（6） 💬（1）<div>拥塞控制算法的话，应该是bbr吧，已经被合入linux  4.9内核了。与传统的reno, cubic等策略相比，最大的不同是，bbr不会因为链路噪声而执行乘性减窗，导致延迟过大。实际上，目前gwf的随机丢包的策略也是链路噪声。</div>2019-10-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/be/9a/b0b89be3.jpg" width="30px"><span>不动声色满心澎湃</span> 👍（6） 💬（1）<div>writev是减少write的使用次数吧。一次writev中的数据也有可能分多个包发出去。我说的对吗老师</div>2019-08-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ae/0c/f39f847a.jpg" width="30px"><span>D</span> 👍（6） 💬（1）<div>就拥塞控制算法这块，记得前一阵阿里发布一个HPCC算法，盛老师点评一下?谢谢</div>2019-08-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/23/66/413c0bb5.jpg" width="30px"><span>LDxy</span> 👍（4） 💬（1）<div>下载软件通常使用多线程建立多个TCP连接来下载一个大文件，是不是也是为了尽量避免TCP拥塞控制带来的影响，从而充分利用带宽？因为从实际使用来看，下载软件一旦跑满带宽，其他软件基本是是抢不过它的</div>2019-08-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/67/8a/babd74dc.jpg" width="30px"><span>锦</span> 👍（3） 💬（3）<div>问题一：Linux中最多允许1024个元素
请教一个问题，tcp中有各种窗口，很头晕，比如，发送窗口，接收窗口，通告窗口（Advertised window），滑动窗口，拥塞窗口。为什么要弄这么多窗口呢？都是为了做流量控制吗？如何去理解呢？</div>2019-08-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/09/d6/5f366427.jpg" width="30px"><span>码农Kevin亮</span> 👍（2） 💬（1）<div>请问老师，文中提到的小数据包发送的场景二三都是基于同一个目的地的吧？不同目的地的数据包不管多小，也不能合并发送吧？</div>2019-11-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/06/7e/735968e2.jpg" width="30px"><span>西门吹牛</span> 👍（1） 💬（1）<div>老师问个问题，客户端向服务端发送数据，在服务端，数据到达 socket 缓存区后，就给户 ack 确认，还是 socket 缓存区中的数据，被应用层从缓存中读取后才返回 ack 确认，我理解的是，只要到达服务端 socket 缓存区就给出 ack</div>2022-01-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/af/00/9b49f42b.jpg" width="30px"><span>skye</span> 👍（1） 💬（1）<div>发送窗口的大小是怎么定的？</div>2019-12-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/81/4e/d71092f4.jpg" width="30px"><span>夏目</span> 👍（1） 💬（1）<div>老师，我有个问题，你举的那个例子里面，取发送窗口和拥塞窗口最小值的80，缓冲区数据是100不能发送出去。那么这个缓冲区数据要什么时候才能发送出去呢，是等到发送缓冲区大于100吗？发送窗口是上一次的ack返回时发送端拿到的吗？那发送端怎么知道什么时候大于100的呢？</div>2019-11-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/1e/ae/a6d5e24a.jpg" width="30px"><span>🐗Jinx</span> 👍（0） 💬（1）<div>老师，为什么很多网络库都自己设计了一套缓冲区？其最大的目的是为了什么呢？如果自己要实现一个，应该要从哪些方面考虑和入手呢？</div>2020-12-20</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epKJlW7sqts2ZbPuhMbseTAdvHWnrc4ficAeSZyKibkvn6qyxflPrkKKU3mH6XCNmYvDg11tB6y0pxg/132" width="30px"><span>pc</span> 👍（0） 💬（1）<div>老师举例中的一个请求拆成一个包的例子--可以在代码中处理合并写入缓冲区。那么对于一个请求数据过大，缓冲区放不下一次请求包，不得已拆成两次进行两次请求，这种怎么办？是必然会造成延迟么？</div>2020-05-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/12/13/e103a6e3.jpg" width="30px"><span>扩散性百万咸面包</span> 👍（0） 💬（2）<div>老师，这一章好像没有server端的代码，无法复现。是需要自己实现吗？使用readv接受数据后打印吗？有没有特别的地方呢？</div>2020-04-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/52/d8/123a4981.jpg" width="30px"><span>绿箭侠</span> 👍（0） 💬（1）<div>老师，代码的例子，服务端数据是怎么分清是两条数据的？根据换行符？</div>2020-02-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/af/43/2caad539.jpg" width="30px"><span>咸鱼强</span> 👍（0） 💬（1）<div>客户端代码的第30行  变量n 好像并没有用到？</div>2019-12-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/93/02/fcab58d1.jpg" width="30px"><span>JasonZhi</span> 👍（0） 💬（1）<div>老师你好，有个问题想求证一下，对文件执行write 操作时会经过缓冲区，缓冲区满了才执行磁盘操作。而对socket 执行write 操作，虽然也会经过缓冲区，但是并不一定需要等到缓冲区满了才发送。不知我的理解是否正确？</div>2019-09-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/50/da/ed4803cb.jpg" width="30px"><span>CCC</span> 👍（0） 💬（1）<div>「客户端分两次将一个请求发送出去」，这种情况我在本地模拟只看到了当数据包比MSS大的时候TCP才会拆包发送，请问老师还有别的情况会让一个请求多次发送出去吗？还有就是这种拆包发送有可能拆成两个小数据包（小于MSS）吗？</div>2019-09-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ff/3f/bbb8a88c.jpg" width="30px"><span>徐凯</span> 👍（0） 💬（1）<div>老师  最后提到的那个问题  那些网络库会不会在内部做处理  就像是运行库函数内部还有缓存的原理一样</div>2019-09-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/dd/60/eae432c6.jpg" width="30px"><span>yusuf</span> 👍（0） 💬（5）<div>场景二中，发送端把接下来连续的几个小数据包存储起来，等待接收到前一个小数据包的 ACK 分组之后，再将数据一次性发送出去。

是将多个数据包合并成了1个包吗？</div>2019-09-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/71/91/caecb8ff.jpg" width="30px"><span>谢童</span> 👍（0） 💬（1）<div>老师，writev 是原子操作吗？在多线程的情况下可以不加锁使用吗？</div>2019-08-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/67/8a/babd74dc.jpg" width="30px"><span>锦</span> 👍（0） 💬（2）<div>请教老师一个问题，慢启动是因为需要探测网络带宽质量，快恢复，快重连是什么意思呢？</div>2019-08-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（1） 💬（0）<div>概念较多，不过举个例子就好理解了，比如：在北京和华盛顿之间有一条可以双向传输货物的传送带，计算机的一切都是为了更快的速度和更大的容量，底层的实现更是如此，再对照各种概念就好理解了，他们所做的一切就是为了更有效地利用网络带宽。
需要权衡的就是，发多少信息？啥时候发？收发之间怎么实现无缝衔接，都没有无谓的等待，各种设备都满负荷的运转。</div>2019-11-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/37/e6/48/c8ca3db6.jpg" width="30px"><span>Y.X</span> 👍（0） 💬（0）<div>我们知道，接收端需要对每个接收到的 TCP 分组进行确认，也就是发送 ACK 报文，但是 ACK 报文本身是不带数据的分段，如果一直这样发送大量的 ACK 报文，就会消耗大量的带宽。
老师，请问1.TCP分组的分组是什么？2.数据的分段是什么？</div>2023-07-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/37/e6/48/c8ca3db6.jpg" width="30px"><span>Y.X</span> 👍（0） 💬（0）<div>为此，它提出，在任何一个时刻，&quot;未被确认的小数据包不能超过一个“。这里的小数据包，指的是长度小于最大报文段长度 MSS 的 TCP 分组。这样，发送端就可以把接下来连续的几个小数据包存储起来，等待接收到前一个小数据包的 ACK 分组之后，再将数据一次性发送出去。
老师，两个问题。
1. 请问未被确认的小数据包不能超过一个是什么意思？怎么实现的呢？
2. 如果我把几个小数据包一起发出，他们的ack是分别还是一起？</div>2023-07-01</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/88nXicqmkJWm3IXVfPfGQSk8SKIBVKjuC4qhzaCkf5Ud88uvKgS4Vf5AzCJ1uaFO0gpPnxdh4CowfhpxV1kSbXw/132" width="30px"><span>lixin</span> 👍（0） 💬（0）<div>老师，请教一下一个场景： 如果发送方使用writev()发送多个buf数据，接收端 用read()，而不是readv() 来读取数据，能否把writev的数据原样读取到么？是否 writev&#47;readv 需要配对使用？谢谢</div>2022-08-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/dd/60/eae432c6.jpg" width="30px"><span>yusuf</span> 👍（0） 💬（0）<div>1)、iov_len的总和&lt;=32767, iovcnt &lt;= 16</div>2019-09-02</li><br/>
</ul>