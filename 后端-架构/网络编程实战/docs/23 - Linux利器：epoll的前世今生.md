你好，我是盛延敏，这里是网络编程实战第23讲，欢迎回来。

性能篇的前三讲，非阻塞I/O加上I/O多路复用，已经渐渐帮助我们在高性能网络编程这个领域搭建了初步的基石。但是，离最终的目标还差那么一点，如果说I/O多路复用帮我们打开了高性能网络编程的窗口，那么今天的主题——epoll，将为我们增添足够的动力。

这里有放置了一张图，这张图来自The Linux Programming Interface(No Starch Press)。这张图直观地为我们展示了select、poll、epoll几种不同的I/O复用技术在面对不同文件描述符大小时的表现差异。

![](https://static001.geekbang.org/resource/image/fd/60/fd2e25f72a5103ef78c05c7ad2dab060.png?wh=681%2A129)  
从图中可以明显地看到，epoll的性能是最好的，即使在多达10000个文件描述的情况下，其性能的下降和有10个文件描述符的情况相比，差别也不是很大。而随着文件描述符的增大，常规的select和poll方法性能逐渐变得很差。

那么，epoll究竟使用了什么样的“魔法”，取得了如此令人惊讶的效果呢？接下来，我们就来一起分析一下。

## epoll的用法

在分析对比epoll、poll和select几种技术之前，我们先看一下怎么使用epoll来完成一个服务器程序，具体的原理我将在29讲中进行讲解。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/df/1e/cea897e8.jpg" width="30px"><span>传说中的成大大</span> 👍（68） 💬（5）<div>我回想和对了poll和epoll的代码 觉得效率问题主要出现在 epoll返回的是有事件发生的数组,而poll返回的是准备好的个数,每次poll函数返回都要遍历注册的描述符结合数组 尤其是数量越大遍历次数就越多 我觉得性能差异在这里 抛开阻塞和阻塞i&#47;o层面</div>2019-10-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/dd/60/eae432c6.jpg" width="30px"><span>yusuf</span> 👍（22） 💬（1）<div>https:&#47;&#47;github.com&#47;linuxxiaoyu&#47;block
执行后都会重复打印”need read socket_fd“和“poll need to read”，所以select和poll应该都是条件触发</div>2019-10-21</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLLOldQf1VmafqYpeDj2RFdWfo3O4KV5jjHIzaSnmuJf4RjyAtibIkbzuYTX1NGyvznm9asmiaHvyVw/132" width="30px"><span>moob</span> 👍（21） 💬（1）<div>边缘触发的情况， 如果epoll_wait时提供的events数组太小，那么会错过事件？</div>2019-10-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/dd/60/eae432c6.jpg" width="30px"><span>yusuf</span> 👍（15） 💬（4）<div>之前对epoll01.c中第66行while(1)很困惑，不明白是从哪里跳出这个循环的。后来通过gdb调试分析，发现在55行把socket_fd设置为了非阻塞，然后在68行调用read时，socket_fd没有数据可读会直接返回-1(errno = EAGAIN),从而在73行通过break跳出了while(1)循环。希望对同样有此困惑的同学有所帮助。</div>2019-10-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ea/df/ecd66509.jpg" width="30px"><span>空想家</span> 👍（12） 💬（2）<div>LT + non-blocking 和 ET + non-blocking 有什么区别吗？性能谁更好一点？

epoll 的惊群问题会讲吗？</div>2019-09-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/50/35/079d04c8.jpg" width="30px"><span>向东</span> 👍（6） 💬（1）<div>为何在水平触发的epoll03，当tcpclient都退出了，还说有数据可读呢，get event on socket fd ==5，二是请问为何每次都从五开始呢，前面0-5分别是谁占用了呢，谢谢。</div>2019-10-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/9b/88/34c171f1.jpg" width="30px"><span>herongwei</span> 👍（5） 💬（3）<div>老师，您好，在总结里：“避免了用户态 - 内核态频繁的数据拷贝”这句话是什么意思的呢？文稿中好像没有提到 epoll 的数据拷贝？频繁指的是什么呢？另外，对比之前的 ，select，poll，epoll 三者在数据拷贝之间的区别又有什么不同呢？希望老师回答一下，谢谢！</div>2019-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/40/aa/49bbb007.jpg" width="30px"><span>нáпの゛</span> 👍（4） 💬（1）<div>老师，边沿触发的时候，如果没有把数据全部读完，剩余的未读数据后续是什么情况。在缓存区中会影响socket后续的读写操作吗，比如这会请求其他资源，触发另一个读时间，会不会读到前面未读的数据？还是说不影响，内核在新的读操作之后会清理掉？</div>2020-09-02</li><br/><li><img src="" width="30px"><span>ray</span> 👍（4） 💬（1）<div>老师您好，
想跟您请教什么时候会触发EPOLLOUT事件，我们的课程范例好像都只有EPOLLIN事件。
当读事件触发后，为什么不用为fd设置EPOLLOUT事件，就可以直接将资料写回fd，这样我们要怎么知道一个fd是否可写呢？

谢谢老师的解答！</div>2020-04-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/c1/39/11904266.jpg" width="30px"><span>Steiner</span> 👍（4） 💬（1）<div>请问如果我用epoll_ctl显式更改event事件，那么epoll_wait会不会检测到，并装载到events数组中？</div>2019-10-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/82/42/8b04d489.jpg" width="30px"><span>刘丹</span> 👍（4） 💬（1）<div>提个小建议，能否把代码解说（例如：第 41-46 行判断了各种错误情况）作为注释放在代码里？</div>2019-09-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/c1/39/11904266.jpg" width="30px"><span>Steiner</span> 👍（2） 💬（1）<div>错误事件需要我们手动注册吗 还是说系统在遇到错误发生会通过设置events字段来通知我们
压根就不需要我们注册？
poll也是这样吗？</div>2021-02-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0b/34/f41d73a4.jpg" width="30px"><span>王盛武</span> 👍（2） 💬（5）<div>边缘触发不是很理解，只通知第一次，如果报文没读完，后续的数据怎么办？</div>2019-11-06</li><br/><li><img src="" width="30px"><span>Geek_ae5ebf</span> 👍（1） 💬（1）<div>老师，代码的第69-70行我感觉你写反了，应该是先close(socket_fd)，再error(1, errno, &quot;read error&quot;)，
代码的第75行，我感觉应该不是break，而是continue，不然event数组后面的fd就没机会执行了</div>2022-01-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/a6/72/526fd3df.jpg" width="30px"><span>ICE FROG</span> 👍（1） 💬（1）<div>边缘触发相同的条件只会触发一次，那来自两个客户端的连接事件会受影响吗？</div>2021-03-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/61/2d/65f016bf.jpg" width="30px"><span>常文龙</span> 👍（1） 💬（3）<div>老师，您好。我看几个例子都只注册了读时间，epoll的例子也只注册了EPOLLIN事件，在处理完EPOLLIN事件后立马做了写操作，这个写操作时，写缓冲区会不会还没准备好？这里可以通过监听EPOLLOUT来做写操作吗？一般什么场景下回去监听写事件呢？</div>2020-06-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/a6/a7/b52de33e.jpg" width="30px"><span>leving</span> 👍（1） 💬（1）<div>想问下老师，epoll的边缘触发比水平触发的效率要高，请问下，边缘触发效率高在哪里？</div>2019-12-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7d/d8/d7c77764.jpg" width="30px"><span>HunterYuan</span> 👍（1） 💬（1）<div>老师给的例子，是不是把close(efd)，给掉了？还是不用关闭</div>2019-11-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/c1/39/11904266.jpg" width="30px"><span>Steiner</span> 👍（1） 💬（1）<div>这个注册过的fd好像删不删都无所谓啊</div>2019-11-07</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/2Iw3M4Myq6G3TO1BQExJP9JKtazBEfptXhG1WcMsnZSWRyiaXCeq0NibsWmmerJVRSpybhfezib8pBGlowlR2wg2A/132" width="30px"><span>Geek9772</span> 👍（0） 💬（1）<div>“边缘触发，只有第一次满足条件才触发”，那么如果用户程序没有处理这个socket缓冲区的数据，那么缓冲区的数据会一直在，还是被清掉？</div>2022-04-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/d7/88/6f6b245c.jpg" width="30px"><span>张浩轩</span> 👍（0） 💬（1）<div>问题1: 不小心把FD_ISSET(fd, &amp;readSet) 写到判断accept的分支里了，发现select会不停的调用返回然后判断是否listenfd上有事件。所以select是条件触发。</div>2022-01-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/79/2d/dbb5570f.jpg" width="30px"><span>huadanian</span> 👍（0） 💬（1）<div>请问老师，代码第74行和第75行之间，是否需要使用epoll_ctl来EPOLL_CTL_DELETE相关的event？？</div>2021-11-22</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132" width="30px"><span>null</span> 👍（0） 💬（2）<div>原文：也就是说他觉得类似 select 或 poll 的数组方式是可以的，而队列方式则是不可取的。

这句话应该怎么理解吖，是因为数组的访问比队列的性能要好么？谢谢。</div>2021-08-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/b9/7c/afe6f1eb.jpg" width="30px"><span>vv_test</span> 👍（0） 💬（1）<div>从 Linux 2.6.8 开始，参数 size 被自动忽略，但是该值仍需要一个大于 0 的整数。
为什么都忽略了，还需要一个大于0的。
</div>2021-06-27</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132" width="30px"><span>null</span> 👍（0） 💬（2）<div>老师，您好
select 处理 fd 的上限不是 1024 么？这里为啥能处理 10000 个文件描述呀？
谢谢</div>2021-04-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/9b/88/34c171f1.jpg" width="30px"><span>herongwei</span> 👍（0） 💬（1）<div>想问一下老师，epoll_wait 返回时，对于就绪的事件，网上好多文章说 epoll 使用共享内存的方式，但我最近看 EPOLL 源码，好像根本没有</div>2021-03-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/66/77/194ba21d.jpg" width="30px"><span>ileruza</span> 👍（0） 💬（1）<div>老师event.data.fd主要目的是什么呀？epoll_ctl不是也传了一个同样的fd吗？
event.data.fd = listen_fd; 
event.events = EPOLLIN | EPOLLET;
epoll_ctl(efd, EPOLL_CTL_ADD, listen_fd, &amp;event)

这么好的课，居然学的人这么少</div>2021-02-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/c1/39/11904266.jpg" width="30px"><span>Steiner</span> 👍（0） 💬（1）<div>有个细节问题，如果我对一个套接字设置了超时选项，epoll会通过那种事件来通知我们，这个套接字超时了？</div>2021-02-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/1c/c4/3e593863.jpg" width="30px"><span>cool</span> 👍（0） 💬（1）<div>为啥write 不考虑是否成功？如果发送缓冲区满了，事例中write 会有问题吧？ write 应该用到异步io吧？</div>2020-05-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/43/5b/17fef3ba.jpg" width="30px"><span>我瑟瑟的方法</span> 👍（0） 💬（3）<div>老师，什么是文件描述符，10000个文件描述符要具体指什么</div>2020-04-21</li><br/>
</ul>