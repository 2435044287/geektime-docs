你好，我是盛延敏，这里是网络编程实战第19讲，欢迎回来。

这一篇文章是提高篇的答疑部分，也是提高篇的最后一篇文章。非常感谢大家的积极评论与留言，让每一篇文章的留言区都成为学习互动的好地方。在今天的内容里，我将针对大家的问题做一次集中回答，希望能帮助你解决前面碰到的一些问题。

这部分，我将采用Q&amp;A的形式来展开。

## 如何理解TCP四次挥手？

TCP建立一个连接需3次握手，而终止一个连接则需要四次挥手。四次挥手的整个过程是这样的：

![](https://static001.geekbang.org/resource/image/b8/ea/b8911347d23251b6b0ca07c6ec03a1ea.png?wh=828%2A592)  
首先，一方应用程序调用close，我们称该方为主动关闭方，该端的TCP发送一个FIN包，表示需要关闭连接。之后主动关闭方进入FIN\_WAIT\_1状态。

接着，接收到这个FIN包的对端执行被动关闭。这个FIN由TCP协议栈处理，我们知道，TCP协议栈为FIN包插入一个文件结束符EOF到接收缓冲区中，应用程序可以通过read调用来感知这个FIN包。一定要注意，这个EOF会被放在**已排队等候的其他已接收的数据之后**，这就意味着接收端应用程序需要处理这种异常情况，因为EOF表示在该连接上再无额外数据到达。此时，被动关闭方进入CLOSE\_WAIT状态。

接下来，被动关闭方将读到这个EOF，于是，应用程序也调用close关闭它的套接字，这导致它的TCP也发送一个FIN包。这样，被动关闭方将进入LAST\_ACK状态。
<div><strong>精选留言（28）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg" width="30px"><span>安排</span> 👍（20） 💬（9）<div>MSL的值怎么和TTL对应的啊？比如MSL设置为30秒，那怎么计算出TTL的值呢？怎么保证一个报文在网络中真的存活不超过30秒？</div>2019-09-13</li><br/><li><img src="" width="30px"><span>Geek_f8c379</span> 👍（6） 💬（1）<div>signal(SIGPIPE, SIG_IGN); 实际上是忽略信号 而不是 按照默认的信号处理程序即退出</div>2020-08-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/12/13/e103a6e3.jpg" width="30px"><span>扩散性百万咸面包</span> 👍（4） 💬（1）<div>请问老师，SO_REUSEADDR虽说是重用TIME_WAIT的socket，为什么不能作为TIME_WAIT的解决方案呢？本质上是解决了端口占用问题，而TIME_WAIT的主要弊端不就在与端口占用吗？</div>2020-04-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（4） 💬（1）<div>MSL 是任何 IP 数据报能够在因特网中存活的最长时间。其实它的实现不是靠计时器来完成的，在每个数据报里都包含有一个被称为 TTL（time to live）的 8 位字段，它的最大值为 255。TTL 可译为“生存时间”，这个生存时间由源主机设置初始值，它表示的是一个 IP 数据报可以经过的最大跳跃数，每经过一个路由器，就相当于经过了一跳，它的值就减 1，当此值减为 0 时，则所在的路由器会将其丢弃，同时发送 ICMP 报文通知源主机

这是否意味着一个IP数据报不可能经过255个路由器？
请问一个IP数据报经过多少路由器，这个由谁决定？怎么决定？和网络距离距离有什么关系？

😅感觉老师的回答和问题，没有完全的对上？</div>2019-11-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/49/29/bbeccb9f.jpg" width="30px"><span>风羽星泉</span> 👍（2） 💬（1）<div>老师，我找到我提交的问题答案了。 使用 man listen 命令，可以找到下面这一句话：
If the backlog argument is greater than the value in &#47;proc&#47;sys&#47;net&#47;core&#47;somaxconn, then it is silently truncated to that value;   也就是说backlog 设置的值大于somaxconn，会被截断为somaxconn 的值。</div>2019-09-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cf/22/5a483755.jpg" width="30px"><span>小蛋壳</span> 👍（2） 💬（1）<div>高性能的网络通信框架，是不是类似netty做的事？。那比如spring mvc或者其他任何应用程序框架其实底层都需要处理网络通讯这块。可以说知名的框架这块其实处理的都很好？ java应用，是tomcat处理网络请求还是spring来处理的？还有nginx</div>2019-09-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2c/96/98/89b96cda.jpg" width="30px"><span>三年二班邱小东</span> 👍（1） 💬（2）<div>老师，为FIN包插入EOF的TCP协议栈是主动关闭方插入的，还是被动关闭方插入的？</div>2022-02-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/49/29/bbeccb9f.jpg" width="30px"><span>风羽星泉</span> 👍（1） 💬（2）<div>老师，我修改了程序中的backlog为10，&#47;proc&#47;sys&#47;net&#47;core&#47;somaxconn没有变还是默认值128。测试程序同时发起800个连接请求，用netstat观察每次大概能建立10个连接，最后有大量连接报错“A connection attempt failed because the connected party did not properly respond after a period of time, or established connection failed because connected host has failed to respond.”；
当我修改程序中的backlog为1000时，最大可连接数并没有突破128，最后也是报上面那个错误。
是不是backlog设置的值只能小于内核somaxconn的值，如果比它大，则取内核设置的值。</div>2019-09-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/48/19/14dd81d9.jpg" width="30px"><span>铲铲队</span> 👍（0） 💬（1）<div>至于已完成连接队列，如果声明的 backlog 参数比 &#47;proc&#47;sys&#47;net&#47;core&#47;somaxconn 的参数要大，那么就会使用我们声明的那个值
-----》老师，这里是不是有问题呢，原文是这样的： If  the  backlog  argument  is greater than the value in &#47;proc&#47;sys&#47;net&#47;core&#47;somaxconn, then it issilently truncated to that value
意思应该是设置的backlog值超过了最大值，则被截断为最大值把。
</div>2022-04-23</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/sOuSC65kXWdWBAIIs6uXAD41Ed8Wo8tib81LLVOQJ2oK23TgPDy6x0PGmp7rXwLR3BHOicaKx1zib1DyfpCITK3dw/132" width="30px"><span>GeekYanger</span> 👍（0） 💬（1）<div>记录一下，TIME_WAIT本身还是很有价值的，TIME_WAIT 的引入是为了让 TCP 报文得以自然消失，同时为了让被动关闭方能够正常关闭。</div>2021-10-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/a5/4e/1c89bca4.jpg" width="30px"><span>landing</span> 👍（0） 💬（1）<div>&quot;注意服务器端程序，先通过 recvfrom 函数调用获取了客户端的地址和端口信息，这当然是可以的，因为 UDP 报文里面包含了这部分信息。&quot;这里不理解。如果解释了客户端收到服务端的数据是因为服务端第一次接受客户端数据时获得了客户端的地址，然后通过sendto告诉了内核，那么第一步内核为什么把数据给服务端套接字，这一步没有建立映射关系，内核应该也不知道啊</div>2021-10-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/54/85/ab5148ce.jpg" width="30px"><span>duckman</span> 👍（0） 💬（1）<div>突然发现了

无论是TCP&#47;UDP, 建立连接之后, 服务端总是先read, 客户端总是先write。

所以，有了IO多路复用之后, 是不是 服务端&#47;客户端可以抛弃这个经典的对话模式，完全根据业务层面的需求, 决定是先write还是先read, 而且两个动作是独立的，互不影响。
</div>2020-12-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/20/dd/6e/8f6f79d2.jpg" width="30px"><span>YUAN</span> 👍（0） 💬（1）<div>使用udp时，客户端如何知道服务器端收到了它发送的请求？例如dns查询，客户端发送的请求如果丢失，那么客户端如何知道发生了报文丢失？</div>2020-10-03</li><br/><li><img src="" width="30px"><span>宋菁</span> 👍（0） 💬（1）<div>老师好，udp没绑定端口的话，操作系统动态分配端口，有可能会出现两个socket自动绑定到同一个端口的情况吗</div>2020-07-03</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epKJlW7sqts2ZbPuhMbseTAdvHWnrc4ficAeSZyKibkvn6qyxflPrkKKU3mH6XCNmYvDg11tB6y0pxg/132" width="30px"><span>pc</span> 👍（0） 💬（2）<div>看了前面的连接关闭、TCP对链路异常的感知，以及四次挥手，串起来后总感觉有点糊涂。看完这篇的几个问题，又稍微明白了一点。想着还是总结着提问一下：
1、首先ACK M+1 和 FIN N两次挥手不能合并吧？上学课本还有一些博客不是都有提到，两者之前被动关闭的一方还可以继续发送数据的。

2、所以TCP四次挥手简单总结为：A端发送FIN包、B端返回ACK；B端继续send data；B端发送FIN包、A端进入TIME_WAIT并发送ACK。
针对“被动关闭方继续send data”这点，回应到本文最后一个问题、以及TCP感知链路异常的几种情况———如果A端是close关闭，B端继续send data的时候就会收到RST、再write则触发SIGPIPE信号；如果A端是shutdown(1)关闭，才可以继续接收到B端的数据，B端也正常的继续send data。（就是文中最后的时序图）
这样的话，对于是不是可以理解成shutdown关闭的时候才是四次挥手的场景呢？反过来说，关闭的时候并不都是“标准的四次挥手”？

3、像kill -9这种暴力关闭程序，都应该类似close关闭吧？
</div>2020-06-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/46/27/e0b34360.jpg" width="30px"><span>林子</span> 👍（0） 💬（1）<div>针对UDP connect的问题有个疑问，按照上文说的是为了让内核记录目标ip端口到socket的映射关系，那如果源主机上有两个udp socket都connect同一个目标ip端口，这时如果出现icmp报文时内核是不是会通知这两个socket呢</div>2020-04-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/50/02/cce1cf67.jpg" width="30px"><span>awmthink</span> 👍（0） 💬（2）<div>老师，如果连接双方正好同时close conn fd，会怎么样呢，相当于FIN_WAIT_1时，收到了FIN，会不会直接跳过了FIN_WAIT_2，发送ACK后进入TIME_WAIT了呢。</div>2020-03-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7e/05/431d380f.jpg" width="30px"><span>拂尘</span> 👍（0） 💬（2）<div>老师，文章开头描述4次挥手，被动方读取数据到eof后，向主动方发fin的ack，主动方进入fin_wait_2，这里是不是缺失了？</div>2020-02-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5f/e5/54325854.jpg" width="30px"><span>范闲</span> 👍（0） 💬（3）<div>四次挥手的ACKM+1 和 FIN N为啥不能合并到一起？</div>2020-02-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5f/83/bb728e53.jpg" width="30px"><span>Douglas</span> 👍（0） 💬（1）<div>老师好像并没有讲为啥是4次挥手</div>2020-01-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/af/00/9b49f42b.jpg" width="30px"><span>skye</span> 👍（0） 💬（2）<div>请问老师，我看一些开源代码中shutdown之后再调用close，这是为什么？</div>2020-01-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f4/ae/3b101c00.jpg" width="30px"><span>fl260919784</span> 👍（0） 💬（1）<div>应用程序如何模拟三次挥手关闭一条tcp连接（一般情况下是fin,ack,fin,ack，但也存在fin,ack+fin,ack）</div>2019-10-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/09/d6/5f366427.jpg" width="30px"><span>码农Kevin亮</span> 👍（0） 💬（4）<div>请问老师，为什么四次挥手中，被动关闭方不能把ack与fin合并呢</div>2019-09-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/03/39/18956b2e.jpg" width="30px"><span>kabuka</span> 👍（0） 💬（1）<div>“这个 EOF 会被放在已排队等候的其他已接收的数据之后，这就意味着接收端应用程序需要处理这种异常情况“   這種情況不屬於正常嗎？ EOF按照順序排在隊列最後面，在處理完隊列前面的消息后，在處理EOF，正常結束。老師說的需要處理異常情況是指什麼？
 </div>2019-09-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/fa/17/d0b8135f.jpg" width="30px"><span>灰色</span> 👍（0） 💬（1）<div>即使经过了2MSL也不一定保证一个tcp分组的TTL为0吧，也就是这个分组变得无效，那么TIME_WAIT如何避免连接“化身”的问题呢？</div>2019-09-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/df/1e/cea897e8.jpg" width="30px"><span>传说中的成大大</span> 👍（0） 💬（1）<div>今天又回头讲udp的connect突然想起来 那udp的send是个广播操作？</div>2019-09-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/f6/e3/e4bcd69e.jpg" width="30px"><span>沉淀的梦想</span> 👍（0） 💬（1）<div>实验了一下往半关闭（本端shutdown）状态的连接里写东西，发现不会返回任何错误信息,，感觉就像正常的连接write一样(然它写多少字节，它就返回多少)，这个是为什么呢？</div>2019-09-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg" width="30px"><span>安排</span> 👍（0） 💬（1）<div>对于udp那里，connect的作用应该是记录服务端ip,端口号和socket的对应关系吧</div>2019-09-13</li><br/>
</ul>