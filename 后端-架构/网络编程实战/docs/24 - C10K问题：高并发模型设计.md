你好，我是盛延敏，这里是网络编程实战第24讲，欢迎回来。

在性能篇的前4讲里，我们陆续讲解了select、poll、epoll等几种I/O多路复用技术，以及非阻塞I/O模型，为高性能网络编程提供了必要的知识储备。这一讲里，我们了解一下历史上有名的C10K问题，并借着C10K问题系统地梳理一下高性能网络编程的方法论。

## C10K问题

随着互联网的蓬勃发展，一个非常重要的问题摆在计算机工业界面前。这个问题就是如何使用最低的成本满足高性能和高并发的需求。这个问题在过去可能不是一个严重的问题，但是在2000年前后，互联网用户的人数井喷，如果说之前单机服务的用户数量还保持在一个比较低的水平，比如说只有上百个用户，那么在互联网逐渐普及的情况下，服务于成千上万个用户就将是非常普遍的情形，在这种情形下，如果还按照之前单机的玩法，成本就将超过人们想象，只有超级有钱的大玩家才可以继续下去。

于是，C10K问题应运而生。C10K问题是这样的：如何在一台物理机上同时服务10000个用户？这里C表示并发，10K等于10000。得益于操作系统、编程语言的发展，在现在的条件下，普通用户使用Java Netty、Libevent等框架或库就可以轻轻松松写出支持并发超过10000的服务器端程序，甚至于经过优化之后可以达到十万，乃至百万的并发，但在二十年前，突破C10K问题可费了不少的心思，是一个了不起的突破。
<div><strong>精选留言（24）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/82/3d/356fc3d6.jpg" width="30px"><span>忆水寒</span> 👍（49） 💬（2）<div>第一个问题，涉及netty的三种模型，常用的是主从reacter模型，分别由eventloopgroup线程池来处理连接和IO事件，底层就是epoll。
第二个问题，要实现 C10M ，就不只是增加物理资源，或者优化内核和应用程序可以解决的问题了。这时候，就需要用 XDP 的方式，在内核协议栈之前处理网络包；或者用 DPDK 直接跳过网络协议栈，在用户空间通过轮询的方式直接处理网络包。</div>2020-03-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/82/42/8b04d489.jpg" width="30px"><span>刘丹</span> 👍（14） 💬（1）<div>可以介绍一下C1M的解决方案吗？毕竟C10M很少有需求。</div>2019-10-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a3/fc/379387a4.jpg" width="30px"><span>ly</span> 👍（10） 💬（2）<div>netty看过它的一些源码，感觉像是倒数第二种“非阻塞 I&#47;O +  readiness notification + 多线程”。它默认有2组eventloop线程，一组是用来监听事件，叫主eventloop，监听完以后将事件发给另外一组eventloop线程，这组线程叫工作eventloop。不知道对不对，请老师点评，另外对netty很有好感，但是还没有研究好它的源码。</div>2019-11-05</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqyicZYyW7ahaXgXUD8ZAS8x0t8jx5rYLhwbUCJiawRepKIZfsLdkxdQ9XQMo99c1UDibmNVfFnAqwPg/132" width="30px"><span>程序水果宝</span> 👍（6） 💬（1）<div>C10M问题应该不能再通过应用层和硬件资源的优化来解决了，性能瓶颈应该是冗长的内核协议栈了，要通过已经有的解决方案有dpdk</div>2019-10-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0b/34/f41d73a4.jpg" width="30px"><span>王盛武</span> 👍（5） 💬（3）<div>老师好，这就是所谓的主从 reactor 模式。  这句有疑惑，我专门查了一下，网上说的主从不是指多核多线程就是主从reactor。主从是指两个线程池，主处理accptor，从处理read write</div>2019-11-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/cb/61/b62d8a3b.jpg" width="30px"><span>张立华</span> 👍（4） 💬（1）<div>C10M，10个处理epoll队列的线程。 每个线程处理一个epoll队列，每个epoll队列容纳最多100万个socket</div>2019-10-03</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqf54z1ZmqQY1kmJ6t1HAnrqMM3j6WKf0oDeVLhtnA2ZUKY6AX9MK6RjvcO8SiczXy3uU0IzBQ3tpw/132" width="30px"><span>Geek_68d3d2</span> 👍（3） 💬（5）<div>百万啊 端口已经不够用了</div>2019-12-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/99/27/47aa9dea.jpg" width="30px"><span>阿卡牛</span> 👍（3） 💬（3）<div>是否使用了select poll epoll等就是非阻塞了？</div>2019-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f0/61/68462a07.jpg" width="30px"><span>无名</span> 👍（3） 💬（1）<div>tcp_wmem和tcp_rmem文件中的缓冲区值，单位是bit？不是byte吗？</div>2019-10-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2d/7c/45/949ec41d.jpg" width="30px"><span>开学！</span> 👍（2） 💬（1）<div>在服务端上：一个连接套接字需要占用一个新的端口吗？

换句话说，如果想要服务端支持1万个连接，除了进程限制的句柄数要设置到1万以上，还要不要求有1万个空闲端口？</div>2022-04-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ff/3f/bbb8a88c.jpg" width="30px"><span>徐凯</span> 👍（2） 💬（1）<div>在哪些地方会有C10M的出现呢，会有千万级同时在线的公司，服务器不都是分布式的，分配到每个服务器上连接应该不至于太多把，可以让那些用户连接的时候通过keepalive模块进行负载均衡，返回新的节点地址让它去连，这样用户请求就不至于都积压到一块去了。</div>2019-10-22</li><br/><li><img src="" width="30px"><span>ray</span> 👍（1） 💬（1）<div>老师您好，
您在课程中提到，假设 1 万个连接，每个连接每秒传输大约 1KB 的数据，那么带宽需要 10000 x 1KB&#47;s x8 = 80Mbps。这地方不是很明白为什么要最后要乘8，一万连接，每秒1K，不是1000 x 1KB&#47;s就好了吗？

谢谢老师的解答^^</div>2020-04-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/55/e6/87197b10.jpg" width="30px"><span>GeekAmI</span> 👍（1） 💬（1）<div>Netty是用的“非阻塞 I&#47;O +  readiness notification + 多线程”。
当serverBootstrap.channel(NioServerSocketChannel.class)时，用的poll事件分发器；
当serverBootstrap.channel(EpollServerSocketChannel.class)时，用的epoll事件分发器。
ps：BioServerSocketChannel一般不考虑。</div>2019-10-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/25/62/78/6e7642a3.jpg" width="30px"><span>王蓬勃</span> 👍（0） 💬（1）<div>老师问一个问题，网络带宽那里为什么还要乘8，10000 * 1kb&#47;s * 8,  我家的带宽是百兆的，迅雷下载的视频的时候显示十几兆每秒，这个该怎么理解？是这个应用程序开了很多个线程，每个线程也是读取接收几kb的数据吗？</div>2021-11-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/ed/6c/6fb35017.jpg" width="30px"><span>群书</span> 👍（0） 💬（1）<div>老师你好问个问题 一个客户端连接它不调用read函数从网络中读数据 作为服务端如何知道？</div>2020-12-11</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/3XbCueYYVWTiclv8T5tFpwiblOxLphvSZxL4ujMdqVMibZnOiaFK2C5nKRGv407iaAsrI0CDICYVQJtiaITzkjfjbvrQ/132" width="30px"><span>有铭</span> 👍（0） 💬（1）<div>看过一些关于C10M的资料，说到Unix(Linux)本身是为电话机交换设计的系统，在内核上存在一些局限性，如果想达到10M，必须像协程取代线程那样，摆脱内核，完全由程序自身机制来控制。但是具体的实现是啥样，我貌似没见人做出来过</div>2019-12-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/9d/ab/6589d91a.jpg" width="30px"><span>林林</span> 👍（0） 💬（2）<div>上面提到的主从处理，主和从能否分别是不同的进程？acceptor进程通过消息队列把监听到的新连接fd发到reader进程进行读写操作？</div>2019-11-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/99/27/47aa9dea.jpg" width="30px"><span>阿卡牛</span> 👍（0） 💬（1）<div>文中假设每个连接每秒的传输速率1KB是否离现实情况太远了？</div>2019-10-24</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKVUskibDnhMt5MCIJ8227HWkeg2wEEyewps8GuWhWaY5fy7Ya56bu2ktMlxdla3K29Wqia9efCkWaQ/132" width="30px"><span>衬衫的价格是19美元</span> 👍（3） 💬（1）<div>c10M的话，前面分析的缓存大小和带宽分别要放大1000倍，也就是，需要1.2 * 1000 = 1.2T的内存，80Mbps *1000 = 80Gbps 的带宽, 同时，连接数也要达到10000000</div>2019-10-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/df/1e/cea897e8.jpg" width="30px"><span>传说中的成大大</span> 👍（1） 💬（0）<div>补充一句 还有带宽限制</div>2019-10-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/df/1e/cea897e8.jpg" width="30px"><span>传说中的成大大</span> 👍（1） 💬（2）<div>这篇课程虽然全是理论 但是我不知道为啥还是认认真真的读了两遍才去看问题和写评论,感觉这篇文章的理论基础很承上启下啊
这里直接回答第二问 实现应该是能实现 挑战和瓶颈在于 首先操作系统方面能否支持千万级别数量的套接字,其次内存方面 能否有足够的内存提供千万级别的套接字读缓冲区和写缓冲区, 第三内核能否同时处理千万级别描述符的事件 第四应用层方面虽然采用了线程池减少了线程的创建开销,但是如果同时在线的连接数量还是很大的话 线程的切换和调度也会很耗性能,大概能想到这些问题</div>2019-10-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/37/e6/48/c8ca3db6.jpg" width="30px"><span>Y.X</span> 👍（0） 💬（0）<div>老师，轮询这个词是不是被滥用了？我的理解是，轮询是指loop所有的事件，poll&#47;select是loop注册的事件，epoll是loop需要处理的事件。</div>2023-07-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cf/69/f5309c93.jpg" width="30px"><span>廣州老炮儿</span> 👍（0） 💬（0）<div>TCP服务器会为每个新的连接分配一个新的本地端口号，这个本地端口号是由操作系统动态分配的。对于大多数操作系统来说，本地端口号的范围通常是从1024到65535，因此，理论上，一个TCP服务器可以同时处理大约65000个客户端连接。不知道这样理解对不对？</div>2023-06-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（0） 💬（0）<div>这篇好，承上启下，问题解决方案的发展轨迹也勾勒了出来。
C10K，第一次读到这个词，不知道啥意思，嘿嘿，现在明白啦！
C10K=C+10K=Concurrty+10*1000，是指单台物理机如何能同时支持1万并发连接的问题，C10M问题同理

面对的问题估计是类似的，内存够不够？带宽够不够？网络响应是否及时？

值得反复看</div>2019-11-24</li><br/>
</ul>