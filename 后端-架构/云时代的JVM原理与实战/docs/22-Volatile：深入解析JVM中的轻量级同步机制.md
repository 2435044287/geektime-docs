你好，我是康杨。

在多线程编程中，确保数据的可见性和一致性至关重要。为了解决这个问题，Java 提供了一个特殊的关键字——Volatile，它可以保证线程之间的可见性并提供一种轻量级的同步机制。

今天我们将深入解析 JVM 中的 Volatile 关键字，详细介绍它的工作原理、使用场景及其在实际应用中的最佳实践。这对于深入理解 Java 多线程编程以及提高并发编程能力都是非常有益的。通过学习和掌握 Volatile 关键字的使用方法和原理，我们能够编写出更加高效和可靠的多线程程序。

## Volatile VS JMM

我前面介绍过，Java 内存模型（JMM）是Java程序在内存中的表示和操作规范。它定义了线程如何在共享内存中存取数据的原则，包括原子性、可见性、有序性等。**Volatile 关键字正是基于 JMM 的原则来实现其功能的。**

![图片](https://static001.geekbang.org/resource/image/49/c9/491e73c5e5ec4e47768c42f4cacccfc9.jpg?wh=1858x872)

### 可见性

JMM 中有一个主内存和工作内存的概念。主内存是所有线程共享的内存区域，工作内存是每个线程独立的内存区域。当一个线程修改了主内存中的变量时，这个修改对其他线程是立即可见的。Volatile 关键字正是利用了 JMM 的这一特性，确保变量的可见性。

### 禁止指令重排序

JMM 对指令重排序做了限制，要求处理器按照顺序执行指令。但是为了提高执行效率，编译器和处理器可能会对指令进行重排序。在这种情况下，Volatile 关键字就派上用场了。它会禁止编译器和处理器对代码进行指令重排序优化，确保代码有序执行。
<div><strong>精选留言（2）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/b6/60/d3b03cb7.jpg" width="30px"><span>whisper</span> 👍（1） 💬（3）<div>计数器这个不对吧，volatile不能保证原子性。多线程修改而且依赖当前值，计数会错误。</div>2024-07-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg" width="30px"><span>peter</span> 👍（1） 💬（0）<div>请教老师几个问题：
Q1：一个用户进程对应一个JVM实例吗？
比如，笔记本电脑上启动3个Java进程，这3个进程是共享一个JVM实例吗？ 还是一个进程一个实例？
Q2：什么样的变量会放到“主进程”？
文中谈到线程有自己的工作区，还有所有线程共享的主内存。那么，什么样的变量会放到主内存？(或者说，怎么定义一个变量使其放在主内存？)
Q3:volatile影响的范围有多大？
比如函数有100行代码，变量定义由10行，变量A用volatile修饰，所有100行代码都受volatile影响吗？还是只有A定义这行代码受影响？或者A之前的代码受影响？
Q4：编译器的写屏障与CPU的写屏障是什么关系？</div>2023-10-18</li><br/>
</ul>