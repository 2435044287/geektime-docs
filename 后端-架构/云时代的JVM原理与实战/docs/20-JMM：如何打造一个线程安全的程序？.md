你好，我是康杨。

在编程过程中，你有没有遇到过在运行多线程程序时想用共享变量来通讯，却发现程序结果和预期不一致的情况？这个常见的问题就是多线程编程的难点，涉及**内存可见性和重排**等问题。今天我们就来解决这些问题，并探讨JVM如何通过它的内存模型JMM来解决它们。

## 可见性问题

第一个问题出现在处理器和内存之间。现代电脑系统中，处理器速度很快，内存的读写速度却远远不能比肩。为了解决这种矛盾，引入了高速缓存，处理器将计算所需数据复制到缓存，从而加快运算速度。然而，这也引发了缓存的一致性问题，也就是说，在多处理器系统里，如果每个处理器都同时使用相同的内存，那么它们的缓存数据可能会出现差异。

处理器必须按照一些协议进行同步操作，在读写时维持缓存一致性。这里就涉及到内存可见性问题，也就是**一个线程修改的状态能够即时在其他线程中可见**。

## 重排问题

我们日常写的代码，在实际运行之前，都会经过JVM及底层CPU等各种优化，来达到最优的执行性能。但是这种优化都是基于单线程考虑的优化，如果你的程序是以多线程的方式运行，反而很容易引发各种问题。所以**对于多线程的程序，知道JVM实际进行了哪些优化非常重要。**

指令序列从源代码到实际执行的过程可能会经历以下三种重新排序。
<div><strong>精选留言（1）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg" width="30px"><span>peter</span> 👍（0） 💬（0）<div>请教老师几个问题：
Q1：编译器重排的例子，怎么禁止编译器重排列？
Q2：指令并行重排的例子，指令并行，是指“a = 1”和“flag = true”这两个指令并行处理，而且并行处理的时候，“flag = true”比“a = 1”先执行吗？  另外，while (!flag)，是不是多加了一个“！”？“重叠执行”就是指并行执行吗？
Q3：缓存系统的重排，“处理器利用了缓存以及读写缓冲区”这句话中，“缓存”是指CPU缓存吗？“读写缓冲区”又是指什么？“负载和保存的任务”，这句话中，“负载任务”和“保存任务”分别指什么？
Q4：JVM，主内存和工作内存部分。假设系统物理内存是100M，不考虑操作系统和其他应用，假设有两个进程A和B，A用10M内存，B用20M内存，那剩下的70M内存就是主内存吗？
Q5：“当某个进程对某一变量进行读取或修改操作的时候，需要先把相关数据从主存搬到工作区，完成后又需要把改动后的内容重新拷贝回主存。”，对于某个进程，对于所有的变量修改都需要这样操作吗？还是只针对某些变量？</div>2023-10-15</li><br/>
</ul>