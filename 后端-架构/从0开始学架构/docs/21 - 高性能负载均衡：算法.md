负载均衡算法数量较多，而且可以根据一些业务特性进行定制开发，抛开细节上的差异，根据算法期望达到的目的，大体上可以分为下面几类。

- 任务平分类：负载均衡系统将收到的任务平均分配给服务器进行处理，这里的“平均”可以是绝对数量的平均，也可以是比例或者权重上的平均。
- 负载均衡类：负载均衡系统根据服务器的负载来进行分配，这里的负载并不一定是通常意义上我们说的“CPU负载”，而是系统当前的压力，可以用CPU负载来衡量，也可以用连接数、I/O使用率、网卡吞吐量等来衡量系统的压力。
- 性能最优类：负载均衡系统根据服务器的响应时间来进行任务分配，优先将新任务分配给响应最快的服务器。
- Hash类：负载均衡系统根据任务中的某些关键信息进行Hash运算，将相同Hash值的请求分配到同一台服务器上。常见的有源地址Hash、目标地址Hash、session id hash、用户ID Hash等。

接下来我介绍一下负载均衡算法以及它们的优缺点。

## 轮询

负载均衡系统收到请求后，按照顺序轮流分配到服务器上。

轮询是最简单的一个策略，无须关注服务器本身的状态，例如：
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/e5/0d/b4258141.jpg" width="30px"><span>姜泮昌</span> 👍（123） 💬（4）<div>微信抢红包架构应该至少包含两个负载均衡，一个是应用服务器的负载均衡，用于将任务请求分发到不同应用服务器，这里可以采用轮询或加速轮询的算法，因为这种速度快，适合抢红包的业务场景;另一起负载均衡是数据服务器的负载均衡，这里更适合根据红包ID进行hash负载均衡，将所有数据请求在同一台服务器上进行，防止多台服务器间的不同步问题。</div>2018-06-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/fc/e5/605f423f.jpg" width="30px"><span>肖一林</span> 👍（101） 💬（3）<div>看完了方乐明的对微信红包架构描述的技术文章，来回答一下问题：

有三个基本动作:发红包，抢红包，拆红包。发红包就是在数据库插一条红包库存数据，抢红包就是查询红包库存数据，拆红包就是插入一条秒杀流水并更新库存数据。

有三个难点:一是海量的并发，二是资金安全，三是良好的用户体验。资金安全决定了交易只能直接建立在数据库上，不能建立在缓存上。良好的用户体验就是要求不能出现不公平的现象，保证先抢先得，先抢的不能失败。

解决方案是:
1.分而治之，分成很多个并行的服务和数据库。相同的红包id总是分到相同的服务和数据库。所以负载均衡算法应该是hash算法
2.相同红包id的所有请求放在一个先进先出队列。然后分配一个独立的线程&#47;进程处理。杜绝抢锁。
3.分离过期数据，减少单表数据量

</div>2018-06-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cf/bb/22af0e52.jpg" width="30px"><span>孙振超</span> 👍（51） 💬（2）<div>负载均衡算法一共十来种之多，但经过抽取共性归纳之后就变成了4类，不仅容易记忆，即使以后再新增加其他的算法，也不外乎是进行了丰富，种类并没有什么变化，归纳为4类之后遇到类似的问题也可以用这样的方式去予以解决，从中也可以看到高手不只是机械性的记忆，而是带着思考去看待问题。

具体到微信红包的算法选择上，由于并发量特别高，需要有一个简单高效的算法，因而性能优先类算法可以不做考虑。对于微信这种级别的机房，其容器化技术必然是炉火纯青，每一台vm的配置是可以完全相同的，因而也就无需采用负载均衡类算法和权重轮询算法，剩下来的就是hash类算法和简单轮询算法。对于红包业务，最主要的操作是发红包和抢红包：不管是发个人红包还是发群红包整体业务相差不大，可以采用简单轮询算法，到任何一台服务器均可。但抢个人红包和抢群红包是不同的，抢群红包是有先后顺序，当有多个人抢同一个群红包时最好是由同一个服务器进行处理，这台服务器在收到抢红包的请求后将请求放到一个队列中，而后按照先进先出的方式进行消费，可以保证先到的人能抢到红包，后到的人后抢到红包。因而对于抢红包业务最好按照红包id进行hash负载。
如果是只选择一个负载算法的话，就是hash负载，发红包按照userid进行hash负载，抢红包按照红包id进行hash负载</div>2018-07-22</li><br/><li><img src="" width="30px"><span>Tom</span> 👍（22） 💬（8）<div>看到评论说按红包id hash，上亿人抢同一个新年红包，应该只有一个红包id 吧？</div>2018-06-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ed/92/9e58858c.jpg" width="30px"><span>赵正 Allen</span> 👍（14） 💬（2）<div>发红包业务应该以红包的生命周期为思考的出发点。主要经历：发，抢，查询，回收（没抢完，返回给发红包的用户）。如果按这些细颗粒来看，抢，查询红包的并发要求最高，发红包次之，回收最低。
首先，发红包使用加权轮询，简单适用，成功后返回红包ID给客户端。
其次，抢红包，查询红包都带着ID给服务端，根据ID计算HASH，再利用一致性hash算法，找到最近的一个结点提供服务。
最后，回收应该由服务端定时触发，可以同样按抢红包处理。
</div>2018-06-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c5/3d/7f3b821c.jpg" width="30px"><span>Dofla Mingle</span> 👍（7） 💬（1）<div>一个红包对应多人去抢，服务器端要根据红包状态（是否抢完）来计算用户的结果（无法抢或抢了多少）。所以感觉最好是在同一台服务器上计算才能提高性能。那么红包和所有能够抢的用户之间应该有某个一致的关联信息（红包所在群的id），根据这个信息的负载算法负载到同一个服务器。所以我认为选hash算法合适，不知道想的对不对。</div>2018-06-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/de/17/75e2b624.jpg" width="30px"><span>feifei</span> 👍（4） 💬（1）<div>针对这个问题首先分析下抢红包的流程
1，首先一个用户在群组内发了一个红包，分成10份，并设置为随机大小。
2，假如群共有50人，都参与抢红包。
3，群里只能前10个用户可以抢到红包，并且金额随机
再来分析下业务流程
1，首先需要扣除发红包用户的红包金额。
2，按用户请求到达的先后顺序排队，进行抢红包，需要事务保证。
3，在队列中的用户抢到红包，其他用户没抢到红包。

然后再分析负载均衡的算法，主要针对抢红包的核心流程负载：
轮询，与加权轮训，都无法满足业务，此场景中存在事务，所以不合适
按机器负载，也无法满足，也是事务问题。
最后是hast，使用群id作为key进行分配，可以让同一个用户组的人负载到同一台机器，就可以完成事务。

所以我最终的负载均衡方案是选择hast算法。

我的分析是否合理？欢迎指正



</div>2018-06-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/34/67/06a7f9be.jpg" width="30px"><span>while (1)等;</span> 👍（3） 💬（1）<div>有个问题想请教老师，进出的流量是不是都要通过负载均衡的那台机器。比如a是NGINX负载均衡服务器，bcd是具体的机器，http请求时是不是所有的input和output都经过负载均衡返回给客户端？</div>2021-08-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d6/1a/532f8a66.jpg" width="30px"><span>summer</span> 👍（3） 💬（1）<div>微信抢红包，最好所有人都在红包所在server进行抢劫。适合ID hash这种算法</div>2018-06-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/32/3f/fa4ac035.jpg" width="30px"><span>sunlight001</span> 👍（3） 💬（1）<div>性能最优优先算法，抢发红包需要响应及时，该算法最优，但是复杂度比较好，需要不断调优。</div>2018-06-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c2/1f/343f2dec.jpg" width="30px"><span>9527</span> 👍（2） 💬（1）<div>老师好，这几天讲的负载均衡分类，算法，还有前面的reactor，proactor，这些东西我想再深细看一下，有没有什么相关的书籍可以推荐呢</div>2018-06-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e4/38/06ec9119.jpg" width="30px"><span>莫何</span> 👍（2） 💬（1）<div>抢红包时可以根据红包标识hash，将同一红包路由到一台机器以减少后端逻辑复杂度，分布式一致性等难度。不过考虑企业客户发的大红包，会不会瞬间击垮一台服务器需要斟酌。红包发到哪台机器可以采取其他均衡策略。</div>2018-06-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/58/02/2b7ccf09.jpg" width="30px"><span>民工597</span> 👍（1） 💬（2）<div>简单来讲，就三个字，接化发</div>2020-12-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/11/78/4f0cd172.jpg" width="30px"><span>妥协</span> 👍（1） 💬（2）<div>请教老师 最少连接数优先的算法中，负载均衡器和服务器之间不管是通过连接池，还是单个长链接方式，都可以统计当前请求数来统计，也就是发送请求加一，收到响应减一。以服务器为单位统计，为何说连接池不适合用这种算法。</div>2019-10-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/36/2c/8bd4be3a.jpg" width="30px"><span>小喵喵</span> 👍（1） 💬（2）<div>什么hash算法，轮循加权完全看不懂啊，是不是数据结构的知识，数据结构和算法全部还给老师了。</div>2018-06-17</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eo3DrWeV7ZwRLXrRZg4V3ic1LQYdZ3u1oicDhqPic47vMguvf5QS69roTiaJrwDr5Re3Sy2UyHDWwmsTA/132" width="30px"><span>大光头</span> 👍（1） 💬（1）<div>通过读你的这篇文章，我觉得到底采用哪种策略取决于业务，是否要求有session或者需要用户访问指定机器，如果是需要用hash，如果不是则考虑其它三种，轮巡和性能分配，采用哪种策略取决于性能轮巡算法的复杂度和用户体验，如果复杂度高，往往采用简单轮巡更加，用户体验对响应时间跟你敏感，也需要采用性能分配。
微信抢红包，业务是有大量高并发请求，它不需要session，所以不用hash策论。由于用户体验是快速响应，所以应该采用性能响应时间策略</div>2018-06-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d7/37/d8c8acdf.jpg" width="30px"><span>求渔</span> 👍（1） 💬（1）<div>个人认为带权重的轮询和基于会话id的hash都可以</div>2018-06-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a7/d5/94f1d391.jpg" width="30px"><span>黄国瑞</span> 👍（1） 💬（1）<div>随机负载以及相应的加权应该也算是一个不错的负载方式吧和轮询类似。

另外TCP场景下还可以最小连接类似性能最优这种负载，然后再结合随机和加权在特定业务场景还挺好用。

微信抢红包负载，个人感觉应该是一种轮询加权重加性能最优结合的吧。而且感觉里面应该还会设计hash负载，因为有可能设计数据不一致，这种高并发同步数据代价比较大，可以使用这种在里面减少这种操作。
具体怎么搞没有细研究过。</div>2018-06-14</li><br/><li><img src="" width="30px"><span>Geek_2883c7</span> 👍（0） 💬（1）<div>nginx怎么配置ID Hash呢</div>2023-02-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/72/65/68bd8177.jpg" width="30px"><span>雪飞鸿</span> 👍（0） 💬（3）<div>进一步概括负载均衡算法，可以分为考虑服务器实际情况和不考虑服务器实际情况两类。轮询，Hash属于前者，加权轮询、性能最优和负载最低属于后者。</div>2022-04-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/d1/29/1b1234ed.jpg" width="30px"><span>DFighting</span> 👍（0） 💬（1）<div>发红包没有太多的业务需求，任意一台服务器处理都可以，适合按照服务器负载均衡分发；抢红包虽然可能会因为不同地方的网络等差异导致请求到达服务器的时机不同，但抛却这个差异来看，同一个时间点到达的请求应该遵照公平原则，所以适合按照红包Id进行hash运算，从另一个角度来看，抢红包存在一个转账的操作，如果同一个红包抢的请求被分派到了不同服务器，就需要额外处理多节点间的异常情况，所以还是一个红包放在一个节点比较合适。</div>2021-03-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg" width="30px"><span>escray</span> 👍（0） 💬（1）<div>“负载均衡”这个翻译稍微有一点误导，load balancing 里面的 balance 的英文解释其实并没有“均分”的意思。

四类负载均衡算法：任务平分，负载均衡，性能最优，Hash 类。按我的理解，上一节讲到的 软硬件负载均衡（F5、A10 和 Nginx、LVS），应该可以配置不同的算法。

（DNS 只能按照 IP 简单的配置为访问最近的服务器，而且负载均衡的控制权属于域名商。）

看过留言，也按图索骥去看了方乐明的《百亿级微信红包的高并发资金交易系统设计方案》，微信抢红包的高并发架构还是挺巧妙的，只是不知道大概三年之后，架构有没有什么变化。

我觉的核心是在于将 红包ID 做 Hash 来进行了 SET 化。

在我看来，因为红包在一开始的时候就已经设定了金额和份数，那么代码实现的时候其实可以在发出的时候就完成随机分配。

比如一个 100 元红包随机 20 份，那么发出的时候，就可以在数据库红包分配表上直接插入 20 条记录，金额随机人名空缺（或者写成发送人的ID，可以帮助回收）。有人抢红包的时候，就不需要插入操作，而是更新操作即可。

不过这样一来，似乎在性能上未必有优势。</div>2020-09-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/21/78/732a2e33.jpg" width="30px"><span>M1racle</span> 👍（0） 💬（1）<div>抢红包为了快速响应，应该选择性能最优的那种方式</div>2020-07-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0f/40/e838871e.jpg" width="30px"><span>zk_207</span> 👍（0） 💬（1）<div>华哥，请教个问题，面试的时候面试官问：介绍下你项目的架构，这个问题应该从哪些方面分析作答呢？能回复下吗。谢谢</div>2020-03-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/64/9b/d1ab239e.jpg" width="30px"><span>J.Smile</span> 👍（0） 💬（3）<div>后端服务器挂掉一台，负载均衡设备怎么感知到呢？nginx可以直接支持吗？</div>2020-02-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/46/d1/a1ddf49f.jpg" width="30px"><span>阿杜</span> 👍（0） 💬（1）<div>还有随机，也是很实用的负载均衡算法</div>2020-01-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（0） 💬（1）<div>1：分活策略
1-1：平分——轮询
1-2：我讨厌谁，就给谁多分——加权轮询
1-3：想给就给谁——随机
1-4：谁干的快给谁——负载均衡
1-5：谁干的少给谁——性能最优
1-6：前端给小云，后端给小强——哈希

微信红包应该用什么分配策略？
微信红包细分有如下环节：发、抢、拆、查、返，其中发、查、返相对容易处理，抢和拆是最难处理的，抢和拆也是关联起来的，抢的时候需要处理高并发，不能抢到拆不出红包，也不能把钱分多或分少啦！
发的时候随机到那台机器生产红包的记录就行
抢的时候需要排队抢先到先得，用哈希把抢的人都分到一个红包所在的机器上排队强
拆的时候就是查看抢了多少钱也是用哈希
查是在看一下自己抢了多少钱，随机一台机器查下就行
返把没抢完的返回去随机一台就行吧
</div>2019-08-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/9b/a4/ddb31c5b.jpg" width="30px"><span>小狮子辛巴</span> 👍（0） 💬（1）<div>微信红包可能的方案有
1、加权轮询  因为有不同配置的机器，不能简单的采用最普通的轮询
2、负载最低优先， 对于微信红包业务应该用”CPU负载“来衡量服务器负载</div>2018-11-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/1b/3f/9316f3f6.jpg" width="30px"><span>水月洞天</span> 👍（0） 💬（1）<div>红包逻辑是先发红包，再抢红包，最后拆红包。。关键点是红包的拆开金额不能超过当前红包金额。鉴于性能考虑，发红包时最好按照红包id负载红包库存。用户抢红包时根据红包id负载到不同的队列上，并处理拆红包业务。</div>2018-09-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/69/c2/34490844.jpg" width="30px"><span>Sky</span> 👍（0） 💬（1）<div>你好，请问：红包id做hash路由，负载均衡器要解析抢红包协议，来得到红包id，然后分派到不同的业务服吗？</div>2018-08-26</li><br/>
</ul>