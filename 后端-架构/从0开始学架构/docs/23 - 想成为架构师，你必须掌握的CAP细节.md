理论的优点在于清晰简洁、易于理解，但缺点就是高度抽象化，省略了很多细节，导致在将理论应用到实践时，由于各种复杂情况，可能出现误解和偏差，CAP理论也不例外。如果我们没有意识到这些关键的细节点，那么在实践中应用CAP理论时，就可能发现方案很难落地。

而且当谈到数据一致性时，CAP、ACID、BASE难免会被我们拿出来讨论，原因在于这三者都是和数据一致性相关的理论，如果不仔细理解三者之间的差别，则可能会陷入一头雾水的状态，不知道应该用哪个才好。

今天，我来讲讲CAP的具体细节，简单对比一下ACID、BASE几个概念的关键区别点。

## CAP关键细节点

埃里克·布鲁尔（Eric Brewer）在《CAP理论十二年回顾：“规则”变了》（[http://www.infoq.com/cn/articles/cap-twelve-years-later-how-the-rules-have-changed](http://www.infoq.com/cn/articles/cap-twelve-years-later-how-the-rules-have-changed)）一文中详细地阐述了理解和应用CAP的一些细节点，可能是由于作者写作风格的原因，对于一些非常关键的细节点一句话就带过了，这里我特别提炼出来重点阐述。

- CAP关注的粒度是**数据**，而不是整个系统。

原文就只有一句话：

> C与A之间的取舍可以在同一系统内以非常细小的粒度反复发生，而每一次的决策可能因为具体的操作，乃至因为牵涉到特定的数据或用户而有所不同。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/0f/80/7c3f35e4.jpg" width="30px"><span>luop</span> 👍（472） 💬（26）<div>结合这两期对 CAP 的学习和思考，谈下个人的理解。

设计分布式系统的两大初衷：横向扩展（scalability）和高可用性（availability）。“横向扩展”是为了解决单点瓶颈问题，进而保证高并发量下的「可用性」；“高可用性”是为了解决单点故障（SPOF）问题，进而保证部分节点故障时的「可用性」。由此可以看出，分布式系统的核心诉求就是「可用性」。这个「可用性」正是 CAP 中的 A：用户访问系统时，可以在合理的时间内得到合理的响应。

为了保证「可用性」，一个分布式系统通常由多个节点组成。这些节点各自维护一份数据，但是不管用户访问到哪个节点，原则上都应该读取到相同的数据。为了达到这个效果，一个节点收到写入请求更新自己的数据后，必须将数据同步到其他节点，以保证各个节点的数据「一致性」。这个「一致性」正是 CAP 中的 C：用户访问系统时，可以读取到最近写入的数据。

需要注意的是：CAP 并没有考虑数据同步的耗时，所以现实中的分布式系统，理论上无法保证任何时刻的绝对「一致性」；不同业务系统对上述耗时的敏感度不同。

分布式系统中，节点之间的数据同步是基于网络的。由于网络本身固有的不可靠属性，极端情况下会出现网络不可用的情况，进而将网络两端的节点孤立开来，这就是所谓的“网络分区”现象。“网络分区”理论上是无法避免的，虽然实际发生的概率较低、时长较短。没有发生“网络分区”时，系统可以做到同时保证「一致性」和「可用性」。

发生“网络分区”时，系统中多个节点的数据一定是不一致的，但是可以选择对用户表现出「一致性」，代价是牺牲「可用性」：将未能同步得到新数据的部分节点置为“不可用状态”，访问到这些节点的用户显然感知到系统是不可用的。发生“网络分区”时，系统也可以选择「可用性」，此时系统中各个节点都是可用的，只是返回给用户的数据是不一致的。这里的选择，就是 CAP 中的 P。

分布式系统理论上一定会存在 P，所以理论上只能做到 CP 或 AP。如果套用 CAP 中离散的 C&#47;A&#47;P 的概念，理论上没有 P 的只可能是单点（子）系统，所以理论上可以做到 CA。但是单点（子）系统并不是分布式系统，所以其实并不在 CAP 理论的描述范围内。</div>2018-08-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/a8/1b/ced1d171.jpg" width="30px"><span>空档滑行</span> 👍（103） 💬（6）<div>一个电商网站核心模块有会员，订单，商品，支付，促销管理等。
对于会员模块，包括登录，个人设置，个人订单，购物车，收藏夹等，这些模块保证AP，数据短时间不一致不影响使用。
订单模块的下单付款扣减库存操作是整个系统的核心，我觉得CA都需要保证，在极端情况下牺牲P是可以的。
商品模块的商品上下架和库存管理保证CP,搜索功能因为本身就不是实时性非常高的模块，所以保证AP就可以了。
促销是短时间的数据不一致，结果就是优惠信息看不到，但是已有的优惠要保证可用，而且优惠可以提前预计算，所以可以保证AP
现在大部分的电商网站对于支付这一块是独立的系统，或者使用第三方的支付宝，微信。其实CAP是由第三方来保证的，支付系统是一个对CAP要求极高的系统，C是必须要保证的，AP中A相对更重要，不能因为分区，导致所有人都不能支付
</div>2018-06-20</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/05Wiazxo0OS5w9KdJ4OQAeicibpMJ2OHyPOia8WwRkuz3JymeW0m4F3m9ia3ZIUVUoicNxSCUGpgJyVMeh8vkQZ0hSaw/132" width="30px"><span>刘毅</span> 👍（38） 💬（1）<div>CAP理解：
任何一个正常运行的分布式系统，起源于CA状态，中间（发生分区时）可能经过CP和AP状态，最后回到CA状态。
所以一个分布式系统，需要考虑实现三点：
1.正常运行时的CA状态。
2.发生分区时转变为CP或AP状态。
3.分区解决时变会CA状态。</div>2020-06-16</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLwSoTjHPX5tm4whBSfoZLX6toZxrZGUaLABQywKNf4MDc9toK3QSV7Z99ATcGicFCysoleQ5ISzmw/132" width="30px"><span>乘风</span> 👍（32） 💬（5）<div>老师 你上面说redis集群是互联且数据共享，但按官网上说redis集群后，每个主节点的数据是不一致的，也不存在共享数据，现在对cap中指的分布式系统(互联且数据共享)还是不太明白，谢谢老师</div>2018-11-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/dd/cb/23b114a7.jpg" width="30px"><span>xiao皮孩。。</span> 👍（26） 💬（8）<div>理解CAP理论的最简单方式是想象两个节点分处分区两侧。允许至少一个节点更新状态会导致数据不一致，即丧失了C性质。如果为了保证数据一致性，将分区一侧的节点设置为不可用，那么又丧失了A性质。除非两个节点可以互相通信，才能既保证C又保证A，这又会导致丧失P性质。</div>2019-04-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/fe/c5/3467cf94.jpg" width="30px"><span>正是那朵玫瑰</span> 👍（21） 💬（3）<div>老师有个疑问，像电商这样的系统，有订单系统和库存系统，创建订单会调用库存系统，这两个系统是互联的，但是并没有数据共享，但超时的情况下，会造成订单数据和库存数据状态不一致，这种算不算cap讨论范畴呢？</div>2018-08-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d5/3f/80bf4841.jpg" width="30px"><span>文竹</span> 👍（16） 💬（2）<div>电商网站核心功能有用户、产品、订单、支付、库存，相应的数据有用户、产品、订单、支付、库存。

对于用户数据，选择CP。因为用户注册后，可能几分钟后重新登录，所以需要满足一致性；在网络出现分区时，因为需要满足一致性而暂时不能提供写服务，所以无法满足可用性；对于分区容错性，只要能返回一个合理的响应就能满足，这一点能很好满足。

对于产品数据，无需满足一致性，所以选择AP。
对于订单数据，业务需要满足一致性，所以选择CP。
对于支付数据，业务需要满足一致性，所以选择CP。
对于库存数据，业务需要满足一致性，所以选择CP。
</div>2018-08-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/e5/39/951f89c8.jpg" width="30px"><span>信信</span> 👍（13） 💬（1）<div>PACELC定理了解一下？
在理论计算机科学中，PACELC定理是CAP定理的扩展。它指出，在分布式计算机系统中，在网络分区（P）的情况下，必须在可用性（A）和一致性（C）之间进行选择（根据c a p定理），但是（E），即使系统在没有分区的情况下正常运行，也必须在延迟（L）和一致性（C）之间进行选择。
PACELC定理首先由耶鲁大学的Daniel J. Abadi 在2010年的一篇博文中描述，他后来在2012年的一篇论文中正式确定。PACELC的目的是声称他的论点“忽略复制系统的一致性&#47;延迟权衡是一个主要的疏忽[在CAP中]，因为它在系统运行期间始终存在，而CAP仅在可以说是罕见的网络分区情况下才相关。</div>2020-03-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/20/2d/dfa5bec8.jpg" width="30px"><span>Han</span> 👍（9） 💬（1）<div>您提到CAP是要求各个节点都可以提供读写操作，但现在大部分的分布式中间件实现基本都是一主多从架构，只有主节点才会接收写请求，主从节点都能接收读请求。 而且很多一致性算法都是设定只有主节点才接收写请求，然后把数据同步到从节点。 请问您怎么看？</div>2020-07-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c9/da/22328e47.jpg" width="30px"><span>zhouwm</span> 👍（9） 💬（1）<div>CAP理论延时问题：因为延时无法避免意味着完美CP场景不存在。—— 这个说法有问题，一致性是从外部使用者的角度去看的（黑盒），只要在回复应答前保障数据已经同步到其他节点，后续请求能得到新数据就是一致的，etcd就是完美cp，zk其实也能算完美cp。延时问题是系统设计的时候要考虑的点</div>2018-07-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/de/17/75e2b624.jpg" width="30px"><span>feifei</span> 👍（7） 💬（1）<div>电商网站要做高可用架构，就必须先确定业务模块，我没有过电商的经验，就说说我的理解，电商主要有商品，用户，交易，这3快核心

商品，商户发布某商品或者修改商品，用户查看商品，不需要非常强的一致性，即可以一部分用户先看到，可以使用最终一致性，满足可用性和容错性，可以使用发布队列，进行发布

用户，有普通的用户，商户这2种用户，用户模块的功能都是注册和登录，需要保证一致性，不能出现用户注册成功了，却不能登录。为了将宕机影响控制在最小，以用户进行分布，针对单节点可以使用数据库的主从，从节点分担读压力

交易，由于交易系统有强一致性要求，用户的交易要只能成功或者失败，有强事务的处理，考虑交易量大的问题，也按照用户进行分布，单节点采用数据库的集群，数据的多分写入

这是我的一个初步设计，还请老师指点，谢谢</div>2018-06-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c9/da/22328e47.jpg" width="30px"><span>zhouwm</span> 👍（6） 💬（3）<div>cap的c指的是线性一致性还是顺序一致性？如果把zk改成读写请求都通过master的话，是否就算完美CP了？因为延时对外不可见。raft在什么情况下丢数据，我理解的丢数据指的是给了请求者正确应答后，写入的数据没保存好，理论上不应该出现的（如果是磁盘缓存导致的，有可能），k8s之类的用etcd也是基于raft的，如果会丢数据都无法保证的话，坑有点大，应该不会有人用吧</div>2018-07-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a7/d3/af0c1e4c.jpg" width="30px"><span>我的名字叫浩仔丶</span> 👍（6） 💬（1）<div>老师，请教下P是什么时机才会触发分区呢？</div>2018-06-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/fc/e5/605f423f.jpg" width="30px"><span>肖一林</span> 👍（6） 💬（2）<div>在开源的分布式系统中，通常可以让用户配置，选择是CP还是AP，比如kafka，每种消息都可以选择配置。这就是CAP理论对数据粒度的控制。老师归纳的非常好。</div>2018-06-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/50/2b/2344cdaa.jpg" width="30px"><span>第一装甲集群司令克莱斯特</span> 👍（4） 💬（1）<div>CAP追求强一致性是丰满的梦想，BASE最终一致性才是骨感的现实！</div>2020-10-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/61/f2/ca989d6f.jpg" width="30px"><span>Leon Wong</span> 👍（4） 💬（1）<div>我理解CA和CP不是系统的整体设计，而是具体业务点的设计权衡，一种tradeoff ，表现形式是分布式系统在检测到网络分区发生的时候，是倾向于一致性C或是可用性A。而CA对应到的场景是不考虑分区容错的场景，数据有可能在整个分布式系统里只存一份(如果引入多副本相当于引入分区问题)，那么就会有单点故障的风险，只能通过将数据分散存储在不同服务器的做法来降低风险的影响面。

可见每一个设计都有优势，也有弊端，我们需要根据具体场景去做tradeoff……</div>2018-06-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/05/e5/aa579968.jpg" width="30px"><span>王磊</span> 👍（4） 💬（2）<div>系统架构中考虑p和不考虑p，对外表现是什么?例如对于考虑p的系统，当p发生时，它还是functon的?发生分区意味着节点间不再联通，数据不再共享，要么为了c回复错误，此时丢了a; 要么为了a，但可能会返回过期数据，丢了c。所以考虑了p比没考虑p的系统到底带来额外什么好处?</div>2018-06-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/36/80/a7167a3a.jpg" width="30px"><span>姜华梁taric</span> 👍（3） 💬（1）<div>老师，互联与共享数据，怎么理解，可以举一个实例嘛</div>2018-11-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/d1/29/1b1234ed.jpg" width="30px"><span>DFighting</span> 👍（2） 💬（1）<div>读到这里算是慢慢有点理解CAP了，首先，网络环境下，只要系统节点间互联+数据共享，那么P就是很常见的一个场景，那么余下的就是如何选择CA了，以这个电商平台为例，我们可以分为用户、商品、订单和支付数据，其中每个数据又可能存在增删改查几种情况，忽略后者，就这几种数据本身来看，
用户数据，只要最终数据一致，问题都不大，所以应该是AP
商品数据，涉及到库存的扣减等直接的数据操作，用户感知其实不大，所以得优先保障CP
支付数据，这个数据很敏感，绝对不可以做，也不能无法支付，所以可以考虑单点CA
订单数据，这部分我不太理解订单是啥的抽象，感觉和商品数据关联性比较大，只要最终订单提交成功，我觉得都可以，所以应该是CP
看到这里，感觉直接面对用户的数据抽象A&gt;C,后台的重要数据C&gt;A，涉及到钱的肯定是CA都要</div>2021-04-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/56/43/abb7bfe3.jpg" width="30px"><span>阿巍-豆夫</span> 👍（2） 💬（2）<div>老师，我一直很困惑，在cp的架构中，如果一旦发生分区，怎么保证c呢？ 连个节点网络都不可达了，怎么可能保证一致性呢？ ap我能理解为很好实现。</div>2018-09-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/23/18/4284361f.jpg" width="30px"><span>易飞</span> 👍（1） 💬（1）<div>理论理解了，真正去落地还是有难度的</div>2022-01-23</li><br/><li><img src="" width="30px"><span>Geek_88604f</span> 👍（1） 💬（1）<div>        电商架构从场景上看主要涉及到查询和下单，对查询操作来说可以满足BASE理论:正常情况下用户查询到某个商品有剩余，但是查询的时候却提示商品已售完，这也是可以接受的（即软状态）；当后端服务出现异常时可以通过降级等措施优先保证A（即基本可用）；当用户实际下单的时候还会涉及到扣款和扣库存，通常采用TCC或MQ异步确保型等分布式事务技术来保证C，异常情况下人工介入保证E。
          从业务特点上看电商业务流量大、时延低、可靠性要求高。要支持大流量后端必须是多实例，通过ID或HASH的方式将用户分配到不同实例上。每个实例对接独立的DB。DB可以选择单实例以保证C，这样当实例故障后该分区的用户会业务不可用，由于只影响少量用户只要做到快速恢复即可，如果还要考虑数据迁移那就太复杂了。；也可以选择主备以保证A（当选择A时主备可能发生脑裂，即P）。
        从数据上看分为用户数据、商品数据、订单数据，每种数据进一步细分为关键数据和非关键数据，关键数据要满足C，非关键数据可以就考虑满足A。这里的商品数据需要特别考虑，因为必须每个分区共享，但是由于同步的时间差是没有办法做到真正的C的。</div>2019-09-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（1） 💬（1）<div>电商系统，首先回想一下，我觉得涉及的东西相当庞杂，如果以是否对用户可见来划分，对用户可见的部分有账户管理、商品搜索管理、订单管理等，主要涉及用户登录，商品搜索列表页，商品详情页，商品结算页，商品支付页，订单列表页，订单详情页，售后商品页等。用户不可见的主要是商品的采购管理，商品的仓储管理，订单的物流管理，订单的退换货，订单的备件管理等，当然，还有秒杀、夺宝岛、时效等。根据CAP理论P不可避免，我们只能根据业务情况去权衡是选择C还是A，我觉得只要和钱不直接挂钩的为了系统的高可用性都会选择A，保证系统的可用性，数据一致性采用最终一致性，而和钱直接挂钩比如：支付，我觉得就应该选择C啦！即使提示支付失败牺牲点用户的体验，也不要造成用户的误会。
不过，这些情况发生的概率比较小，可能我们的系统相对用户感知度小，经过几次大促都没有出现什么特别大的问题。如果有问题，我们也会保A的，系统都不可用了，那比出现可弥补的错误要严重的多。</div>2019-08-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f1/97/e3bbbb14.jpg" width="30px"><span>胖胖的程序猿</span> 👍（1） 💬（1）<div>怎么理解共享数据，假如A,B两个不同服务相连，并且公用同一个数据库表，这个是否算共享，是否算CAP范围。看上篇是要节点间发生数据复制情况才在cap范围，那一般是中间件系统才会有节点数据复制，web应用一般都不会有数据复制吧</div>2019-04-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d9/a2/afbc447c.jpg" width="30px"><span>海军上校</span> 👍（1） 💬（1）<div>选择ap后，节点2如何感知到分区存在，然后返回错误的～不太懂</div>2018-07-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d6/60/f21b2164.jpg" width="30px"><span>jacy</span> 👍（1） 💬（1）<div>只从电商网站的核心业务分析，不考虑登录注册等业务，商品信息显示可细分为关键商品信息（如价格，库存）和非关键信息（商品介绍，用户评论），可按以前提到的分表分库的方法进行信息切割，对关键信息采用ca,非关键信息采用ap,最终达到base即可。</div>2018-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/21/33/acacb6ac.jpg" width="30px"><span>砖用冰西瓜</span> 👍（0） 💬（1）<div>“因此单个用户的余额、单个商品的库存，理论上要求选择 CP 而实际上 CP 都做不到，只能选择 CA” 这句话最后的 CA 是不是应该是 AP？还是说在这种情况下，就是单机的情况？但是单机的话又哪儿来的 A？
这里确实没有看懂。</div>2023-07-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/e1/6b/74a8b7d8.jpg" width="30px"><span>Hugh</span> 👍（0） 💬（2）<div>既然CAP是忽略网络延迟的，无法做到完美的一致性，那为什么说CAP的一致性是指强一致性呢？</div>2022-05-12</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eosNxKtseLC7SDdK2NzgBvqjDiaEQZyHiblaMT4MuYicn6rgk9LxXDUUNhL4yia7WAFmeXUZRTVLxSNbg/132" width="30px"><span>Geek_06b952</span> 👍（0） 💬（1）<div>现在大厂好像用raft 协议比较多。能简单介绍一下 raft吗？</div>2022-04-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/4b/d7/f46c6dfd.jpg" width="30px"><span>William Ning</span> 👍（0） 💬（1）<div>看了文章和评论以及回复，感觉大佬很多～ Keep Learning～</div>2022-04-19</li><br/>
</ul>