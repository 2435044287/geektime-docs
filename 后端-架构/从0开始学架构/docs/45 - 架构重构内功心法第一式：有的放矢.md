在[专栏第8期](http://time.geekbang.org/column/article/7071)“架构设计三原则”中的演化原则部分，我提到了系统的架构是不断演化的，少部分架构演化可能需要推倒重来进行重写，但绝大部分的架构演化都是通过架构重构来实现的。相比全新的架构设计来说，架构重构对架构师的要求更高，主要体现在：

- 业务已经上线，不能停下来

架构重构时，业务已经上线运行了，重构既需要尽量保证业务继续往前发展，又要完成架构调整，这就好比“给飞行中的波音747换引擎”；而如果是新设计架构，业务还没有上线，则即使做砸了对业务也不会有太大影响。

- 关联方众多，牵一发动全身

架构重构涉及的业务关联方很多，不同关联方的资源投入程度、业务发展速度、对架构痛点的敏感度等有很大差异，如何尽量减少对关联方的影响，或者协调关联方统一行动，是一项很大的挑战；而如果是新设计架构，则在新架构上线前，对关联方没有影响。

- 旧架构的约束

架构重构需要在旧的架构基础上进行，这是一个很强的约束，会限制架构师的技术选择范围；而如果是新设计架构，则架构师的技术选择余地大得多。

即使是我们决定推倒到重来，完全抛弃旧的架构而去设计新的架构，新架构也会受到旧架构的约束和影响，因为业务在旧架构上产生的数据是不能推倒重来的，新架构必须考虑如何将旧架构产生的数据转换过来。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/cf/bb/22af0e52.jpg" width="30px"><span>孙振超</span> 👍（80） 💬（9）<div>思考了下当前负责的系统，感觉更多的是需要优化而不是重构，主要原因是如果从新来过还是会采用当前的结构，只是功能需要进一步完善和改进。

之前做过一次缓存架构的重构（自认为的）：我们的系统是3地5中心的部署架构，我们数据的写入是固定在一个机房进行单点写入，然后同步到其他的集群去，db层面的同步是通过数据库自身的主从同步机制实现的；而缓存的同步则是通过消息中间件来进行的，写入集群发送消息，其他集群接收消息而后写入到各地的缓存集群中。写入时是db写入成功就认为写入成功，返回调用方成功。这种实现方式虽然有数据同步延迟和少量的缓存db数据不一致，但对于绝大多数场景都是可以接受。

后来随着业务的发展，出现了写入后立即读的场景（读和写不在同城）,并且不允许读到的数据和写入的数据不一致。在这种情况下原有的缓存更新机制就有问题了：db写入成功缓存消息处理失败或者读请求时消息还没有到达异地机房，这时都会导致缓存和db数据不一致，引起业务异常。
面对此种场景，最初提出的解决方案是让业务方在调用写服务成功后再调用读服务，如果读到的数据和写入的数据一致才进行后续的操作，但这种方案实现总体成本比较高：如果有5个调用方，5个调用方都需要这样修改，重复工作，并且做了不需要自己关注的内容；同时在调用读请求时还要考虑重试机制，实现方案也有些复杂。这个方案提出来后没有一个调用方按照这个做的。
后面进行review的时候决定还是应该自己来做这件事，对外屏蔽复杂性。因而对这一块进行了重构：将缓存内容根据缓存key按照一定的规则进行分区存储，对于实时性和一致性要求高的数据采取同步写缓存操作，如果缓存写失败，直接返回业务方本次写操作失败，由业务方重试。同时本地发送一个删除缓存的消息，异步将缓存删除，确保之后有机会从db中读取最新的数据。这样改造完成后，整体的请求耗时（因为要跨区同步写缓存）和业务失败率有所增加，但满足业务方的需求。
这个改造简要而言是将业务从pa模式改为了pc模式。</div>2018-10-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f9/e3/2529c7dd.jpg" width="30px"><span>吴科🍀</span> 👍（37） 💬（2）<div>系统优化，我们公司就是一个字，拆，拆数据库，拆服务，没有依赖就没有伤害</div>2018-08-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0e/32/6cae3632.jpg" width="30px"><span>宋岩</span> 👍（20） 💬（6）<div>老师您好，我们现在面临一个运行18年的.net业务系统，业务一刻不能停止，大约2000张oracle表，大量的存储过程函数等实现的业务逻辑，现在要用java来重构，面临的问题就是好多大表都在Oracle中，想去o就涉及到很多表关联，做不到垂直拆分，业务耦合太紧，您有什么好的建议或者我们该从哪方面切入？</div>2018-08-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8d/aa/e739c4fa.jpg" width="30px"><span>彼得.林</span> 👍（20） 💬（1）<div>总之，架构重构需要架构师既要说得动老板，也要镇得住同事；既要技术攻关，又要协调资源；既要保证业务正常发展，又要在指定时间内完成目标……总之就是十八般武艺要样样精通。



老师，这些都是架构师的软技能吧？市场上的课都偏技术，可以讲讲这些吗？谢谢</div>2018-08-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e9/13/1f92e7f5.jpg" width="30px"><span>one day</span> 👍（17） 💬（3）<div>我公司正巧在重构系统。定期3个月。电商系统。原来是dubbo 服务间调用 ，redis 缓存，mysql，模块化开发，云平台,svn。问题，关联查询太多，dubbo部署的相关模块太多，业务复杂度太高，业务调用同步慢，一搞活动，数据库就爆，业务逻辑懂的人换了一茬又一茬。目标spring cloud,docker,k8s,git,禁止关联查询即单表，解藕慢操作即异步，接口细粒度，层次调用分明，服务隔离能缓存就缓存，业务大拆解。最终会是什么样，静待。学了老师这么多，手术台上实习了，哈哈.      缓存，异步，事务消息最终一致，强制单表查询，业务边界，规范。牵一发动全身，业务等待，加班加班……</div>2018-08-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/16/2d/2753369a.jpg" width="30px"><span>Geek_58ezrw</span> 👍（15） 💬（2）<div>老师，我们现在公司遇到的问题和你说的X系统很相似，现在也在逐步将那些热门业务做成微服务，拆分出去，但是涉及到的数据表，拆到其它RDS上去，涉及到的跨库查询很麻烦。现在只能做成接口了</div>2018-08-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/a8/1b/ced1d171.jpg" width="30px"><span>空档滑行</span> 👍（13） 💬（1）<div>当前的系统刚刚做过一次重构，当时选择重构的原因有这么几个，原系统有一个大的面向客户的web系统和多个单独的进程组成，前后端在一个war包，后端服务单机远行，两者通过db交换数据。问题有这么几个，web系统累积了5年的代码，改个bug已经随时搞挂整个web端。后端服务单点问题。数据库压力很大，一个功能的sql拖垮整个库。
重构的思路是，先将单体后端进程服务化，服务化过程中非核心数据从主表分离出来。web系统结构不动，上线一个服务就从原来的查db改成调用服务。服务梳理差不多了将web端重新实现前后端分离。做完这些后将数据库结构重新设计。总的来说跟文中的第三个例子有点像。
</div>2018-08-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4b/d4/b7719327.jpg" width="30px"><span>波波安</span> 👍（12） 💬（2）<div>我们系统目前的瓶颈在数据存储，之前数据的存储都是oracle加上redis做缓存。现在活跃用户在500万左右。拿卡券业务来说，每个月产生的优惠券数量都在6000万左右，导致现在需要运维每两个月就要对表做瘦身，并且前端用户也只能查询两个月内的卡券。
目前讨论的技术方案是使用mycat做分库分表，数据库使用mysql。遇到的问题有事务控制的问题，典型的就是卡券转赠，之前在oracle就直接利用数据库事务就可以解决。现在由于转赠记录和受赠记录不会落在同一个库，所以需要程序做策略来保证最终一致性。</div>2018-09-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/0c/30/d4737cd5.jpg" width="30px"><span>lyonger</span> 👍（8） 💬（1）<div>架构师的要求好高啊，既要对业务非常熟悉，也能精通各种技术，其次还要能hold住人心。</div>2020-03-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a7/b7/00b87f2d.jpg" width="30px"><span>黑小子在路上</span> 👍（6） 💬（3）<div>目前系统采用类似微服务模式。如有1后台管理，2商家pc后台，3商家app接口服务，4server，都是独立部署。前面的1 2 3都依赖4。目前的问题是1也会访问数据库，server也访问数据库，有一部分重复。2 和3 也有重复逻辑。目前一个小需求，都可能要改多个端，由多个人介入，开发成本比较高。 近期准备重构，使用多模块形式来聚合工程，提取公用服务，但会保留现有独立部署模式，以此来达到提效的目的:-O</div>2018-08-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/61/f2/ca989d6f.jpg" width="30px"><span>Leon Wong</span> 👍（5） 💬（2）<div>双中心如何同步数据？比如我在A中心写入了数据，此时未同步到B，并且发生了宕机，B此时是没有这个数据，还允许被再写入一次，这种场景如何避免数据不一致呢？</div>2018-11-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/05/d8/cd269378.jpg" width="30px"><span>一叶</span> 👍（5） 💬（2）<div>华哥请问一下文中ab系统双中心改造，是数据分区还是两个中心都有完整数据。
1.如果是分区，那其中一个中心宕掉之后，部分人或业务在另外一个中心是没法使用的？
2.如果是完整的数据，当网络出现异常的时候，不是出现脑裂？</div>2018-10-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d5/3f/80bf4841.jpg" width="30px"><span>文竹</span> 👍（5） 💬（1）<div>目前开发的系统最大的复杂度在于大数据量计算。数据目前是保存到ES中的，但发现ES对于大数据聚合计算表现得无能为力，未来考虑使用hadoop中spark来做计算。</div>2018-08-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（4） 💬（6）<div>课后思考及问题
我们的系统正在重构中，并且已经搞了一年左右，重构的系统在验证中，由于老系统本身业务逻辑比较复杂又是0级系统，一旦有问题秒秒钟就会影响大批订单，所以，不完全验证OK不敢上。
重构的原因：
第一业务运维困难，特别是大促、节假日时，页面配置复杂，并且不灵活
第二系统已经运行5年+补丁太多，代码臃肿，理解、开发、测试困难，同时存在第一代及第三代的代码，原来的老代码不敢删除，各种分支判断令人眼花缭乱，有些逻辑已经不知道为啥那样写
第三有人想要更好的KPI
上不了的原因：
第一系统太过复杂，想想看一个方法像老鼠洞一样一层套一层，看完一个方法需要一两天，另外，重构的也不是一个系统，有负责页面配置的系统，有专门负责刷新缓存的系统，有专门负责对外提供服务的系统，有专门负责核心业务逻辑计算的系统，有专门负责持久化数据的系统等
第二改了逻辑但还需要覆盖原来的业务，验证困难
第三领导核心关注点在后台业务逻辑，页面也非常多和复杂，但是压根没有测试，目前业务验证自然会发现很多bug
第四主产品离职了，另外小组长也离职了，他俩级别挺高，组长听说是家庭原因，主产品比较奇怪，他不但级别高工资高而且资格老没人管，他也离职啦
第五团队氛围不佳，安排活都给你细到小时，管人的方式采用雪橇犬理论的方式
第五想一次重构结构N个问题，已不是最初的业务运维困难的痛点了，这就好像和华仔讲的相反——无的放矢
没有聚焦解决一个问题，后面问题扩大化啦

抱歉，借华仔的地盘发一下牢骚哈😄

1：本文核心观点
1-1：重构系统的基本原则——从一大堆纷繁复杂的问题中识别出真正要通过架构重构来解决的问题，集中力量快速解决，而不是想着通过架构重构来解决所有的问题
1-2：重构时架构师要做的事情——架构师需要透过问题表象看到问题本质，找出真正需要通过架构重构解决的核心问题，从而做到有的放矢，既不会耗费大量的人力和时间投入，又能够解决核心问题。
1-3：如何判断系统实现需要重构——假设我们现在需要从 0 开始设计当前系统，新架构和老架构是否类似？如果差异不大，说明采取系统优化即可；如果差异很大，那可能就要进行系统重构了。
有的放矢，如果提炼一下有两点：
第一定位出问题的真正根源是什么
第二聚焦解决主要矛盾的主要方面</div>2019-09-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f5/2f/56117bab.jpg" width="30px"><span>张玮(大圣)</span> 👍（4） 💬（1）<div>确定是不是要重构挺难的，那就等到问题频出，改到想吐的时候做重构吧，

大公司在创新，小公司也在创新，一般2.3年的系统设计不会太差吧，除非影响业务了，影响老板心情了，

归纳下：能优化的别修补，能修补的别重构，保证核心业务OK，更好的支撑创新业务线发展吧 哈哈

如果要重构，拉都拉不住，那就做好预备方案，保证新旧系统并行，时间可控，做好切换时风险控制，要不然，萌萌哒，😄</div>2018-08-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/6c/28/a1f9f0ad.jpg" width="30px"><span>陈树义</span> 👍（2） 💬（1）<div>重构真的是一门艺术，不仅需要技术过人，还需要有经验，更要有洞察力。

专业技能到家了，但是没有经验，很可能大刀阔斧地全部重做。但这样的后果就是出问题的风险很大，并且基本上会难产。只有有经验，才知道怎么一点点去重构。另外也需要洞察哪些东西是最重要的，哪些是不重要的，挑合适的功能先一点点做。

简单概括：重构也需要小步快跑，一点点做，这样成功率更高！</div>2020-05-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/7e/8b/3cc461b3.jpg" width="30px"><span>宋晓明</span> 👍（2） 💬（1）<div>老师 ，如果把很大的功能拆分成多个子系统，每个子系统的功能都是独立的，这样会成为单点系统，难道单点系统不做高可用吗？</div>2019-01-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/03/58/777af42a.jpg" width="30px"><span>Ethan.Yan</span> 👍（1） 💬（1）<div>“假设我们现在需要从 0 开始设计当前系统，新架构和老架构是否类似？如果差异不大，说明采取系统优化即可；如果差异很大，那可能就要进行系统重构了。” 👍 学习了。 </div>2022-06-19</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJNeCwealtX0j5libPP67McmBGsHEKlNYPedF7tom3MIGF2ib6rPliaqR5QYS7WaTiaJdPhZjfQ4ZNdRA/132" width="30px"><span>刘二</span> 👍（1） 💬（1）<div>我感觉首先要识别问题，也就是问题的抽象能力。不知道这块有没有好的建议</div>2021-08-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/66/d1/8664c464.jpg" width="30px"><span>flyCoder</span> 👍（1） 💬（2）<div>目前系统遇到一个时效性问题，在广告监测数据上传由于网络原因到库存扣减中间有很多延迟，导致超发的问题，目前想到的解决方案是提供阈值提醒的功能到阈值时扩大库存的值避免超发，或者提前将广告下线。</div>2020-10-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/22/d7/d166f764.jpg" width="30px"><span>付锐涛</span> 👍（1） 💬（3）<div>说一下我们公司的业务管理系统，有一个业务大表单（10个子页面组装而成，使用easyui+js实现），不同的业务场景，这个大表单的元素需要动态变化（可见、必填、校验规则）。
以前的做法是大范围变化全部复制一套，小范围变化使用JavaScript做动态控制，随着业务的演进这样的表单复制了5套，对应的js文件也复制了5套并做个性化修改，当需要维护表单的时候经常要5套一起修改，经常出现错改或者漏改的情况。
这个表单是核心业务表单，随着业务的发展修改频率非常高，所以想着能不能做成可配置的，刚开始想到以下两个方案：
1.引入vue
2.在后台生成表单html
由于团队内都是后端程序员，所以vue的学习成本导致被放弃。使用第二套方案相当于要开发一套表单生成系统，而且要保证前端样式不变，难度比vue还高。
最后结合实际情况，区分出表单中可变性（可见、必填、校验规则）和不可变性（表单布局），将表单布局整理出一套模板，再在数据库中存储每个元素的可变属性，页面渲染成功之后动态调整可变性。

由于履历原因，一直没有机会参与到架构搭建和架构重构这种级别的改造中，所做的重构也都是功能级别的，正在探索架构师的玩法。</div>2020-04-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/e7/f0/d0bf3a5f.jpg" width="30px"><span>Regis</span> 👍（1） 💬（1）<div>学习是一个漫长的过程，尤其架构这方面，需要有丰富的开发经验及开发过程中的总结才能成长起来，加油💪</div>2020-03-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/1b/70/547042ee.jpg" width="30px"><span>谭方敏</span> 👍（1） 💬（1）<div>有的放矢
架构师的首要任务是从一大堆纷繁复杂的问题中识别比较真正要通过架构重构来解决的问题，集中力量快速解决，而不是想着通过架构重构来解决所有的问题。

我公司目前的开发系统需要重构，主要有两方面：
1）管理所有节点的全局服务器本身应该是单点，并且与业务无相关的，它的职责就是动态管理各个节点增删查改，以及服务器配置但是因为业务逻辑上也需要一些全局数据，比如跨网关业务，所以当初为了偷懒，就把用户在线状态丢全局服务器里了。现在因为业务耦合度，全局服务器需要频繁调整业务逻辑。
需要梳理这块业务流程，不在全局服务管理，这样才能使得全局服务器完全业务无相关。

2）数据库服务器单点，当初也是基于当时用户规模来决定的，如果数据库存在多点的话，又需要进行负载均衡，这样会加大调用方难度。所以权衡之下，在数据库方面采用集群化，这样确保数据高可用，而业务逻辑上面追求简单处理，而采用了单点处理逻辑。
3）调用方式都是采用直接调用api的方式，没有做到调用解耦，比如引入mq。
</div>2020-03-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/46/58/31205087.jpg" width="30px"><span>恋着歌</span> 👍（1） 💬（2）<div>当初的一个 demo 到现在已经做了3年了，迟迟没有重构。作为一个前端我感觉现在急需数据库层的重构。现在一个业务涉及多个 site，但是一个 site 一个库，最近上线通过程序 addsite 功能，导致多种问题。1，要实现动态数据源，2，要引入 mq 通知另一台 tomcat 更新数据源。历时一个半月才上线了一个粗糙版本。我给的方案是同一个业务就同一个数据库，上面的两问题都不存在了。现在重构的最大阻力是旧数据迁移，请问老师在这放面有比较好的建议吗？</div>2018-08-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6b/f8/b4da7936.jpg" width="30px"><span>大魔王汪汪</span> 👍（1） 💬（2）<div>重构系统首先是建立在熟悉系统业务上，有了全局的业务视角在架构选型和构件上才会有的放矢。

华哥可以开个架构师软技能专栏，继续订阅。</div>2018-08-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/0e/5a/617f28bf.jpg" width="30px"><span>数据小白</span> 👍（0） 💬（1）<div>当前任职的公司，曾经发起了多次系统优化，系统性能得到了很大的提升，但是随着业务的发展，原有的架构已无法满足业务的需求，所以公司对系统整体的架构进行了重构，我理解下来，进行架构重构还是优化，主要还是看是否能满足业务需求，如果能满足业务需求，优化即可，投入人力也不会很多，如果已无法满足业务发展，则需要进行重构。</div>2023-02-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/29/74/3f/5c9fd08f.jpg" width="30px"><span>李晨</span> 👍（0） 💬（2）<div>我现在开发的是cdp，现在存在的问题有：
1、数据没有分层，即没有分出ods、dwd、dws、dwt、ads这几层。导致的问题是数据的扩展性很差，即新增一个需求，可能需要在数据表上直接增加字段，最后变成了大宽表，会产生性能问题；
2、原有的架构很简单，就是kafka+doris（用来做实时数仓）。缺乏数据回写、批处理操作等特性；
结合以上两点原因，我认为需要的是重构而不是优化</div>2022-08-08</li><br/><li><img src="" width="30px"><span>Geek_9f2339</span> 👍（0） 💬（1）<div>我想站在程序员的角度讨论一下这个问题（希望大佬给与指正）：
1. 作为程序员 小到一个模块，一个类，大到一个服务，一个系统，其实在我们眼里就是一个对象，
2. 重构，优化，其实就是面向对象编程的一个思考，在业务发展的不同阶段，站在不同的角度，看到的对象不尽相同
3. 架构的重构 是站在较高的维度取观察整个业务系统，剥离出其中一层一层的对象，而根据业务权重来区分这些对象，如：业务发展的初期，我们把一个电商平台称之为一个对象，所以对应的就是单体应用，随着业务的发展，我们可能会在电商平台下 抽象出 商品搜索、购物车、订单、支付 等等多个对象，对象之间松散耦合，我们称之为微服务架构。
个人的理解架构重构优化，就是在之前的对象中找到更小对象。让更小的对象，松散的耦合，独立演变。</div>2022-03-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/b2/17/3161b49c.jpg" width="30px"><span>达叔灬</span> 👍（0） 💬（1）<div>目前 就职 一家传统的互联网企业团队人数3个前端3个后端1个运维 18年的时候 经历了主要业务系统重构 耗时接近10个月，主要是三个大一统的.net fromework 项目，根据业务功能 拆分为七个大颗粒的分布式集群服务(netcore)，包括数据库 缓存 所有相关模块 全部重构 完成后经历了 一个月测试后上线 进行数据整理、数据库切换 整体切换线上服务。虽然我不太同意 这种一次性切换的方式，风险略大。</div>2021-11-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/d1/29/1b1234ed.jpg" width="30px"><span>DFighting</span> 👍（0） 💬（1）<div>感觉老师最后判断是系统优化还是重构的方式很形象：推倒重来架子一样，优化，否则重构，学习到了</div>2021-11-21</li><br/>
</ul>