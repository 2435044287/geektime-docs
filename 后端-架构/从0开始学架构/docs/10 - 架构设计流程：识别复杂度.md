从今天开始，我将分4期，结合复杂度来源和架构设计原则，通过一个模拟的设计场景“前浪微博”，和你一起看看在实践中究竟如何进行架构设计。今天先来看架构设计流程第1步：识别复杂度。

## 架构设计第1步：识别复杂度

我在前面讲过，架构设计的本质目的是为了解决软件系统的复杂性，所以在我们设计架构时，首先就要分析系统的复杂性。只有正确分析出了系统的复杂性，后续的架构设计方案才不会偏离方向；否则，如果对系统的复杂性判断错误，即使后续的架构设计方案再完美再先进，都是南辕北辙，做的越好，错的越多、越离谱。

例如，如果一个系统的复杂度本来是业务逻辑太复杂，功能耦合严重，架构师却设计了一个TPS达到50000/秒的高性能架构，即使这个架构最终的性能再优秀也没有任何意义，因为架构没有解决正确的复杂性问题。

架构的复杂度主要来源于“高性能”“高可用”“可扩展”等几个方面，但架构师在具体判断复杂性的时候，不能生搬硬套，认为任何时候架构都必须同时满足这三方面的要求。实际上大部分场景下，复杂度只是其中的某一个，少数情况下包含其中两个，如果真的出现同时需要解决三个或者三个以上的复杂度，要么说明这个系统之前设计的有问题，要么可能就是架构师的判断出现了失误，即使真的认为要同时满足这三方面的要求，也必须要进行优先级排序。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/64/a8/ad627315.jpg" width="30px"><span>pk</span> 👍（387） 💬（25）<div>文中有一句话：TPS 1780 并不高。这个结论怎么来的？作者经验丰富，见过很高的TPS。 但作为新手，如何衡量这个性能要求高还是不高呢？</div>2018-05-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/54/5c/6855e2d5.jpg" width="30px"><span>XP</span> 👍（88） 💬（13）<div>感觉这个专栏定位是扫盲，留言的读者都是老司机</div>2018-05-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d4/d2/96dbfa5a.jpg" width="30px"><span>云辉</span> 👍（87） 💬（12）<div>复杂度问题，还有是方案简单，但是沟通协调成本高，跨部门了，请问华仔，你们是自己推动，还是技术PMO推动。</div>2018-05-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/a8/1b/ced1d171.jpg" width="30px"><span>空档滑行</span> 👍（45） 💬（3）<div>说下之前改造的一个系统，当时是这个系统从其他系统同步数据，经过一整套流程后将数据拆解到本地库的各个业务表中。
原来的系统是一个单机多线程程序，到了大促的时候延时非常厉害，因为马上又要大促了，首先想到的是扩展性的问题，于是就做了无状态服务拆分，可以横向扩展。在这过程成因为要控制单个同步实体任务的并发在处理幂等性上也花很大的功夫。做完这个后，又对非关键流程做了消息解耦，提高主流程的处理速度。
系统上线后运行稳定，但是到了大促当日发现速度提升很有限，将机器扩展到10台速度只提升了2-3倍，而且数据库和应用压力都很小。
后来分析下来瓶颈竟然是在数据库中间件上。其他系统大量的慢sql导致中间件处排队严重。
现在想起来，其实还是改造前优先级没搞清楚，根据之前的经验就把问题归结到扩展性上，投入了大部分精力在扩展性和可用性上，而没有对原来单机系统的性能做完整的测试和评估。其实当时做一个单机程序的压测大概就可以判断出问题所在(改造过程中也发现老的程序确实有bug)。还有就是高性能的优先级远大于扩展性和可用性，因为这个系统重启的影响非常小。改造的时候过于理想化的，想做一个各个方面均衡完善的架构</div>2018-05-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/bf/b6/ee3b4ef7.jpg" width="30px"><span>herome</span> 👍（28） 💬（3）<div>最近在做一个平台化的crm系统，也就是公司各个业务线都可以接入 ，或者外面的业务线也能接入。但是我们在开发过程中，比如查看商家等级列表这个接口，以前所有的接入方，都是查看就是查看，但是有个主要对接方提出了个需求是，查看后如果不存在 就插入一个默认等级。，但是其他对接方没有这样的需求，也就说原接口不能变，如果没有其他接入方我直接修改原来的接口即可，根本不考虑兼容。类似的问题数不胜数， 我们每次要么是if else这种代码走不同的逻辑，要么是 新写个接口，现在我们的代码的维护已经很混乱了，一个简单的逻辑，如查看等级列表，我就要维护好几套接口，好几套逻辑。 有想过变成可配置化的，但是没有好的思路。华哥对这方面有好的建议吗？😂 </div>2018-05-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/80/82/3c21b30c.jpg" width="30px"><span>梅子黄时雨</span> 👍（26） 💬（4）<div>微服务架构，是解决了什么复杂性问题呢</div>2018-05-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/e8/47/3e4a03ac.jpg" width="30px"><span>renwotao</span> 👍（17） 💬（3）<div>公司架构日志占了百分之二十的cpu，有什么好的解决方案吗</div>2018-06-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/cc/6b/7f66d425.jpg" width="30px"><span>joyafa</span> 👍（17） 💬（2）<div>我现在做的是交易转发网关，性能瓶颈很大一部分也受上级券商网关影响，系统无状态，无数据库操作，因为涉及到交易，对可用性要求很高，需要能快速处理客户端的请求，经过多次压测，也没有排查出自身系统问题出在哪里，对系统压测，以及测试得到的数据该怎么分析，怎么找出问题所在？</div>2018-05-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/16/2d/2753369a.jpg" width="30px"><span>Geek_58ezrw</span> 👍（16） 💬（3）<div>识别复杂度方面比较难，如果判断错误，容易误入歧途。像我们公司是属于创业型公司，业务迭代很快，前面两三年都在堆业务，并且所有的业务都在一个系统上，web服务器一台，数据库RDS一台，那个时候流量并不大，公司高层没有重视，不考虑优化，还是以发展业务为主。

今年业务量起来了之后才重视，流量会对现有系统有所影响。于是讨论出最终方案，重新起一套框架，来重构，原来的老系统继续使用。结果实施发现周期重新起一套开发时间上，公司等不及，开发了3个月都没有出来就胎死腹中了。

但那个时候开始老系统经常频繁出问题了，有时是web请求量比较大WEB服务器CPU 100%，WEB服务器都登录不进去。有时是数据库操作比较频繁，数据库100%。只能重启web服务器来临时应对，有一次业务高峰更尴尬，连服务器重启都没有用，一重启流量一进来又100%。

这个时候通过分析web请求日志，慢查询日志来进行分析，然后来制定出优化方案，在原有的老系统上来进行优化。

但推进这个优化的过程中，也是比较费劲，研发人员比较害怕在老的系统上来进行优化了，怕优化后用不了，这好比是在给飞行中的飞机加油。后面通过领导的支持下达，通过分析报告的结果，把老系统的服务由简单到难逐步拆分：
1. 先拆分的是静态资源放到OSS上并做成CDN化。
2. 将慢查询进行优化，能利用缓存的，用缓存，大表的联表查询，拆分成单表查询。
3. 将轮询在调用接口的迁移到其他服务器，将一些轮询的计划任务服务也迁移到其他服务器。
这样子系统算是稳定下来，但要走的路还很长。

我写了这些事故的经历，就是在互联网公司成长过程中都会经历，对于技术复杂度的判断很重要，要是一开始我们就打算先从老系统来进行优化，就会避免一些事故的发生，还有就是技术上的推动，还是需要由公司领导的大力支持，首先要说服领导，说服老板，上通下达才行。</div>2018-12-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/e0/6b/f61d7466.jpg" width="30px"><span>prader26</span> 👍（15） 💬（1）<div>做了一个很小的系统，就给几个领导看，所以写代码的时候，没注意加锁，和并发。所有的功能都在一个系统里，只求速度。。。</div>2021-01-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/04/ff/4ccc8168.jpg" width="30px"><span>Sir Peng</span> 👍（11） 💬（2）<div>华仔，架构师要具备的五项全能中，&quot;撕逼&quot;能在哪种情况中得已体现？</div>2018-05-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/eb/91/12612612.jpg" width="30px"><span>彡工鸟</span> 👍（11） 💬（1）<div>个人看法，在顶层上看一个系统，确实会有高可用，高性能，可扩展等等多个复杂度的要求，而且可能还真的无法分出个优先级。这样就落到都要抓，都要硬，最终无法分出个主次，导致设计四不像的系统出来。针对这种情况，是否就应该动用子系统一说，将系统拆分到一定的粒度，可以聚焦到一个，或者至多两个复杂度上？而子系统自然有子系统的架构设计，技术选型来针对性地解决其复杂度问题</div>2018-05-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/fe/83/df562574.jpg" width="30px"><span>慎独明强</span> 👍（7） 💬（1）<div>如何去分析自己系统的复杂度，那么项目中的痛点应该就是自己项目复杂度所在。我之前负责订单履约系统，由于订单是交易平台通过mq推送给我们，高并发不是我们系统的复杂度所在。订单拆单与发货都是自己内部系统，高性能也不是我们系统复杂度。但是我们的高可用影响到订单发货和客服满意度，订单系统是供应链的源头，与很多部门都有交互。响应业务快速性，业务复杂度和高可用是我们系统复杂度所在。按这样排序，业务复杂度，高可用，高性能。</div>2020-07-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e4/45/846f8441.jpg" width="30px"><span>MichaelJY</span> 👍（6） 💬（1）<div>现在遇到这样的系统:
1.前后端没有分离，因为业务情况需要多窗口显示，然后是通过div分隔的，在多窗口的使用下会出现id冲突或者在a窗口的操作影响到b窗口的数据
2.系统分为三个子系统，业务子系统处理具体业务，公共子系统处理类似登录，权限，审批等，定时任务负责调度，三者之间通过http交互，没有集群，现在业务子系统耦合比较严重。业务子系统大概可以分为接入层，业务处理层，结算层，现在是一整个系统，经常发现结算层的逻辑变更，会导致接入层和业务层不可用
3.因为历史原因，对于数据校验方面做的比较差，经常出现数据格式问题，当然新增代码已经处理了这些，但是历史债务比较严重，且业务迭代很快
4.整个系统是单点，所有发版升级都会停服

我觉得最急的是4 &gt;2 &gt;1 &gt;3，不知道对不对
</div>2018-05-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/7f/de/7d17e15b.jpg" width="30px"><span>冰封无名</span> 👍（5） 💬（2）<div>很多时候碰到的都是业务复杂，但这“三高”要求不那么严格的系统。没碰到“三高”系统，如何更有效的思考架构的设计？请大牛指点一下！</div>2019-03-01</li><br/><li><img src="" width="30px"><span>xiaoya</span> 👍（4） 💬（4）<div>我是个新手，听一遍就忘了。记住的不多😭不开心。是我接触的太少不太重视这些吧，这些很关键?这么多理论的东西，嗨，我心性太差了。一口老想都吃掉，结果都不好。认识自己驾驭自己，一点点</div>2018-08-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/63/11/ea921534.jpg" width="30px"><span>itperson</span> 👍（4） 💬（1）<div>以前的系统基本不需要考虑高可用和高性能 但我有个问题在于高性能和高可用具体是否有衡量标准 请在后面的课程详细讲解一下 自己如何证明验证高可用和高性能</div>2018-05-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/21/20/1299e137.jpg" width="30px"><span>秋天</span> 👍（4） 💬（1）<div>有没有系统提升架构思维的资料推荐，感觉还没有打破那个灵感，请大神指教？</div>2018-05-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/1b/7f/9698e2bd.jpg" width="30px"><span>关汉聪</span> 👍（3） 💬（1）<div>老师，kafka号称百万级，动辄几万几十万的QPS，这里QPS 只有 13800，为什么说“ 已经比较高了，因此高性能读取是复杂度之一” 呢？</div>2021-01-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/19/72/87ecf8bf.jpg" width="30px"><span>W.Kalman</span> 👍（3） 💬（1）<div>菜鸟一只，有些地方不太理解。。
微博子系统每通知一个子系统，就要设计接口，进行测试，效率很低。
 这里是说 微博通知 这个方法调用了 【审核】【广告预测】【发布消息】等方法，加多其他新一个方法 不符合封闭原则吗？还是说有其他地方我没想到。。</div>2018-08-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5b/fc/da52e7df.jpg" width="30px"><span>Ryan Feng</span> 👍（3） 💬（1）<div>tps、qps一般用什么测？我看你的tps是qps十倍，意思就是多少子系统就是多少倍？这个数据不考虑网络通讯和系统复杂度差异吗？</div>2018-05-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f8/ba/d28174a9.jpg" width="30px"><span>Geek_zbvt62</span> 👍（3） 💬（2）<div>疑问:1 文中描述架构师还是凭借老司机经验发现系统的问题在于耦合度 2 tps qps的表示的意思已经被错用，正确的理解是什么？文中看来t指外部产生的事务？

</div>2018-05-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/d1/29/1b1234ed.jpg" width="30px"><span>DFighting</span> 👍（2） 💬（1）<div>我没设计过类似这种中间件的系统，考虑的思路是业务拆分，每个子部分有单独的复杂度，比如现在做的一个审计系统，信息采集，任务调度和审计三部分复杂的点都不一样，信息采集主要是性能和兼容多来源；任务调度对性能上和可用上要求高点，百万的任务调度不能中途崩溃掉；审计主要负责的是业务场景多，功能可扩展性要求比较高。不过我是新手，听了老师讲的，我感觉自己离架构师还很早，老老实实设计好小模块，写好代码，边学边用，从小结构开始尝试，慢慢前进吧</div>2021-02-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/1b/70/547042ee.jpg" width="30px"><span>谭方敏</span> 👍（2） 💬（1）<div>从近期负责的自建物联网平台建设和优化的工作中，也感觉到识别复杂度的重要性，之前我们最原始的感觉是系统高性能，高可用是最大的复杂度，于是我们在这个事情上面孜孜不倦，不断追求高性能，某些关键接口tps从不到1000优化到8000，在大家都觉真正解决问题了，但其实发展效果不大。
后来冷静下来分析，以前的高性能不过是整个业务系统的局部优化而已，而这样是没法发挥整体性能最大的，而系统的复杂度应该关注在业务复杂度上面，针对工作业务流设计（流程，架构）等。
比如对我们来说在没有第三方厂商接入现有自建物联网平台的情况下，那么物联网平台就不能要求那么高的独立性，需要整合公司业务进去考虑，而不仅仅只是个通道，做个linker而已，这样让自建物联网平台和业务服务器之间交互变得复杂，而且对于部分业务数据无法保证数据一致性。最最重要的是工作业务流非常长，容易出现问题后无法定位到问题，因为大家都习惯了在局部点找问题了。
跟他们老大们反映了这些问题，但是他们觉得业务流设计以及业务架构设计没问题，罗马大厦已经建成了，而要做的只剩下</div>2020-02-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/fd/94/8704d2b0.jpg" width="30px"><span>spoofer</span> 👍（2） 💬（1）<div>我觉得tps，qps的计算是不是应该引入2-8定律？系统流量一般出现在每日20%的时间里。</div>2019-12-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/75/2c/df8aaf20.jpg" width="30px"><span>小楼一夜听春雨</span> 👍（2） 💬（1）<div>这里把TPS和QPS分开来说，有什么考虑？TPS和QPS分别对应写、读（查询访问）？我们实际过程中，有的时候并没有特别去区分两者吧。</div>2019-07-28</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqsFicCU21tKou4mFvfy5fOn9sfNYHNDfna8eozeVOLGs58gcAu8v2IIVFRsM6R8DIuWSVAjzubh8A/132" width="30px"><span>郑佳宁</span> 👍（2） 💬（1）<div>为什么架构设计只考虑这几个复杂性呢？其他的非功能性需求还有很多很多，比如可测试性、可布署性、等等，如何权衡？</div>2019-05-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/08/75/512b9f26.jpg" width="30px"><span>张汉桂-东莞</span> 👍（2） 💬（1）<div>我发现一直做的都很盲目。来了项目，先做了再说。我所在的公司套路是：把功能实现，合同验收，收到钱就是王道。
我还是继续了解多些架构设计的知识，说不定哪天就有机会真枪实弹应用起来，就学会做架构了。
</div>2018-12-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/25/25/fb2ba003.jpg" width="30px"><span>Duo An</span> 👍（2） 💬（1）<div>我参与设计了一个离线数据生产的系统。主要的功能就是将HDFS上的大文件按天增量刷到线上高可用的存储数据库中比如dynamodb. 慢点有几个: 文件都是全量数据,每次写全量不靠谱 太费钱也浪费计算资源; 数据必须完全正确地写入, 部分数据需要时实行要求. 数据量每天大概5~10T .</div>2018-05-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/27/f7/ba/08044ec3.jpg" width="30px"><span>张平</span> 👍（1） 💬（1）<div>留言区里的牛人太多了，向你们学习，致敬。</div>2021-08-10</li><br/>
</ul>