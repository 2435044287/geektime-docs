你好，我是华仔。

前几讲我介绍了异地多活方案。它主要用来应对系统级的故障，例如机器宕机、机房故障和网络故障等问题。这些系统级的故障虽然影响很大，但发生概率较小。在实际业务运行过程中，还有另外一种故障影响可能没有那么大，但发生的概率较高，这就是今天我要跟你聊的接口级的故障。

接口级故障的典型表现就是，系统并没有宕机、网络也没有中断，但业务却出现问题了，例如业务响应缓慢、大量访问超时和大量访问出现异常（给用户弹出提示“无法连接数据库”）。

这类问题的主要原因在于系统压力太大、负载太高，导致无法快速处理业务请求，由此引发更多的后续问题。最常见的情况就是，数据库慢查询将数据库的服务器资源耗尽，导致读写超时，业务读写数据库时要么无法连接数据库、要么超时，最终用户看到的现象就是访问很慢，一会儿访问抛出异常，一会儿访问又是正常结果。

如果进一步探究，导致接口级故障的原因可以分为两大类：

1. **内部原因**：包括程序bug导致死循环，某个接口导致数据库慢查询，程序逻辑不完善导致耗尽内存等。
2. **外部原因**：包括黑客攻击，促销或者抢购引入了超出平时几倍甚至几十倍的用户，第三方系统大量请求，第三方系统响应缓慢等。

解决接口级故障的核心思想和异地多活基本类似，都是**优先保证核心业务**和**优先保证绝大部分用户**。常见的应对方法有四种，降级、熔断、限流和排队，下面我会一一讲解。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/a8/1b/ced1d171.jpg" width="30px"><span>空档滑行</span> 👍（154） 💬（2）<div>1.对于用户服务，在抢购期间可以准备降级策略，压力过大时保证用户登录的可用，注册和修改信息可以做降级处理
2.抢购下单涉及到订单，库存，和商品查询。可通过请求排队来限流，超出库存的请求直接返回。
为了应对库存和商品服务可能发生的故障，可以提前对商品数据和库存数据做缓存，如果对端服务故障，本地也可以提供服务
3.支付依赖第三方系统，合理设置熔断策略，如支付平均时长超过限制可提示用户稍晚做支付</div>2018-07-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c6/23/c4265a46.jpg" width="30px"><span>climber</span> 👍（52） 💬（3）<div>1.抢购页面最大程度静态化，一般用户开始前会尝试刷新页面，查询压力要比下单压力大很多
2.抢购页面要求登陆后访问，一般人不会抢购开始那一刻才进来，错开登陆压力
3.活动未开始，不允许点击抢购按钮。对请求做轻量分析，对于请求过频繁或者可疑ua等做拉黑，为防误杀要求输验证码
4.抢购下单接口采用排队+限流，降低压力的同时保证公平性，如抢购1000件，只放2000人进来，其他返回排队人数过多。进来的请求全部入列，固定数量的队列消费者控制订单生成速率以及走到支付流程的速率。支付是下单流程核心功能，降级不应该降级掉。队列做削峰，保证支付系统不会压力过大。
请指正～</div>2018-07-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/b7/03/a6c86c93.jpg" width="30px"><span>张浩</span> 👍（30） 💬（1）<div>我发现了,系列文章越到后面,人越少.还好我坚持看到了这里...</div>2018-09-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/1d/8e/0a546871.jpg" width="30px"><span>凡凡</span> 👍（20） 💬（1）<div>1.登录接口在流量特别大的时候，可以适当降级，较少参与人数，另外一点是登录一般有有效期（尤其对于web客户端），可以适当延长登录有效期。2.抢购接口采用队列方式，无法支撑时，也可以适当限流。另外一点，秒杀一般还会有一个秒杀结果查询的接口，也可以降级或者减小请求频次。3.支付接口，一般第三方支付对接入方有流量限制，可以提前申请扩大限制，同时做好降级准备。</div>2018-07-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ce/3d/385b8263.jpg" width="30px"><span>星火燎原</span> 👍（15） 💬（1）<div>整点限量抢购核心业务应该是登录和抢购，抢购完了放入购物车不一定马上支付，所以在系统负载较高的时候可以让支付接口做降级处理，过了整点再恢复。抢购接口一般采取商品对应一个抢购队列，队列到上限之后拒绝流量进来，系统根据自身负载情况去消息队列进行流量的拉取，大致思路如上所述，还有什么遗漏还请老师指教</div>2018-07-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/fc/34/c733b116.jpg" width="30px"><span>何磊</span> 👍（12） 💬（2）<div>老师你好，关于排队方式请教个问题：
比如用户从pc发一个请求过来，我们将这个请求放到队列，这个时候就直接返回客户端，客户端定时轮训排队状况，还是说是其它处理方案呢？</div>2018-08-10</li><br/><li><img src="" width="30px"><span>Tom</span> 👍（8） 💬（1）<div>功能：登录、抢购、支付。
接口故障应对方法：降级、熔断、限流和排队。
三个功能是有依赖关系的，登录了才能抢购，抢购了才能支付。因此如果从依赖关系考虑，总体访问量过大无法满足时，降级时优先保留登录，其次是抢购，再其次是支付。但是支付是成交关键，并且访问数量比登录抢购少很多，可以说不是一个数量级，因此我觉得支付优先级是最高的。
其中只有支付涉及外部调用，因此只需为支付提供熔断方案。
抢购功能提供排队和限流方案，对于每个参与抢购活动的商品根据商品数量设定队列长度，限流也根据商品数量进行限流。
支付失败要怎么处理？</div>2018-07-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/9b/a4/ddb31c5b.jpg" width="30px"><span>小狮子辛巴</span> 👍（5） 💬（1）<div>
第一版（不看评论的思考回答）
		
	假如有100种商品，每个商品1k件。首先设计100个队列。
	对于已经登录的用户
		限定每个队列只能有1w个排队的人，如果超过1w人，就提示人数太大，只能等下次了。

	已经未登录的用户
		如果抢购时间段同时登录人数太多，超过100w, 逐步降级和熔断
		a.可以登录，但不能参与抢购了
		b.暂停登录，拒绝服务 （防止把系统拖垮，影响正常的不抢购的用户）

第二版（看过评论之后的思考回答）
	1、 忘记了熔断是对外的。老师特意提示了依赖了第三方支付。
	所以上面 逐步降级和熔断  感觉应该是   逐步降级和限流

假如有100种商品，每个商品1k件。首先设计100个队列。
对于已经登录的用户
	1、抢购 限定每个队列只能有1w个排队的人，如果超过1w人，就提示人数太大，只能等下次了。
	2、熔断处理， 提示抢购成功的同学，“歇歇再支付，不着急。” 分散支付请求 。
已经未登录的用户
	如果抢购时间段同时登录人数太多，超过100w, 逐步降级
	a.可以登录，但不能参与抢购了
	b.暂停登录，拒绝服务 （防止把其他系统拖垮，影响正常的不抢购的用户）</div>2018-11-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/08/36/98be3d69.jpg" width="30px"><span>奋斗心</span> 👍（5） 💬（1）<div>访问的流量在每个环节可能逐步递减（登陆例外）
1、引导部分用户提前登陆；
2、秒杀价系统独立部署（感觉和其他系统部署在一起才需要降级）；
3、抢购使用排队方式。有界队列，队列大小可以预估较大长度，队列外的拒绝；
4、（如果要求以支付成功为准）通过队列和熔断。
（如果以下单成功为准）使用熔断。提醒稍后再付
</div>2018-09-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f4/d9/e572ae4d.jpg" width="30px"><span>食指可爱多</span> 👍（5） 💬（1）<div>“每一个参加秒杀活动的商品保存一个队列，队列的大小可以根据参与秒杀的商品数量（或加点余量）自行定义。”我之前也思考过类似于淘宝秒杀或12306这种高并发系统，应该不会所以资源在一个队列里排队，这样整个系统并发度无法水平伸缩，那么请问老师一个技术细节问题，每个商品一个队列这个有啥推荐的实现方案吗？</div>2018-07-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/49/a5/e4c1c2d4.jpg" width="30px"><span>小文同学</span> 👍（4） 💬（1）<div>1、在抢购开始前，可以通过降级来保证登陆服务。例如提前半小时限制注册、修改用户信息的服务。
2、整个流量的洪峰应该在于下单。下单可以同时基于限流和排队两种方案，这个需要大概估计到。譬如说100W人抢购100件商品，可以在整点时对下单操作做99%的限流，把1000K的访问问题改写为10k，10k里面再进行排队。
3、支付属于第三方调用，使用熔断机制（譬如说下单后保留30分钟的支付的时间，等待支付宝服务恢复）

未实际开发过实际抢购系统，期望老师和其他同学提供好的方案借鉴学习</div>2018-07-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/56/eb/c862a6bd.jpg" width="30px"><span>最美的时光</span> 👍（3） 💬（1）<div>登录功能：用户微服务，在抢购的时候很小的概率是在整点才登录，用户服务压力应该不大；个人理解活动再火爆也不能限制用户登录。
商品信息模块：商品中台，不会允许用户直接查mysql，应该会把商品的各种表数据异构到es；商品分页应该是走es，商品详情应该是走分布式缓存。
订单模块：订单微服务，抢购本质上就是生成订单再调用支付服务完成支付，抢购接口做限流，限流本质上就是通过队列做缓冲，再通过调度模块匀速去处理队列中的请求，生成待支付的订单
支付模块：当用户点击结算的时候，在支付模块调用第三方的支付接口完成支付。订单状态改为已支付。调用第三方支付接口的时候需要做熔断，比如接口超时，再熔断后做fallback处理，提示用户稍后重试
</div>2022-11-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cf/bb/22af0e52.jpg" width="30px"><span>孙振超</span> 👍（3） 💬（1）<div>登录大体可分为免密登录和非免密登陆（包含登陆密码、人脸登陆、短信登录等），95%左右的都是免密登录，内部的实现相对也比较简单，采用限流方式就可以了；对于非免密登录，内部实现相对会复杂些，并且会有风控策略，因而面对大流量需要同时采取限流和内部降级两种策略了。
对于抢购，优先采用排队策略，可以避免限流策略下前面的用户因限流导致抢购失败而后面的用户限流通过情况下用户体验不好的情况。
支付采用熔断策略即可，同时要将对应的错误码进行适当的优化，并提供用户再次进行支付的入口。熔断策略的实现可能会稍微有点复杂，并且需要系统报警+人工确认双重保证，避免网络、机器、电源等情况引起的误触发。</div>2018-09-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d3/3c/ab6425f7.jpg" width="30px"><span>hello</span> 👍（3） 💬（1）<div>我认为核心需要保证的业务的是抢购，抢购业务可能并发用户较多，对于抢购可以采取排队策略，对参与抢购的用户进行排队。对于登录服务，当发生接口故障的时候，为了保证抢购业务顺利，可以采取降级策略，可以让部分用户登录失败，可以停掉注册等接口，当大量调用支付系统，而支付系统反应慢而影响整个系统的时候，可以对支付系统进行容错处理，可以让用户过段时间再支付。对于熔断的阈值可以根据具体的业务来判断。</div>2018-08-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cd/ee/f204ba32.jpg" width="30px"><span>100kg</span> 👍（3） 💬（1）<div>老师，我有个双机那节的问题，如果采用了mysql 双主架构，对于库存这样的字段，在并发较高时，如果两个mysql同时 update 了库存（采用乐观锁，库存本身作为版本号)，这样会不会导致货物被两个人购买但库存却只减了1呢？该怎么解决呢？求赐教</div>2018-07-08</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqjZHY70Lke3YzZFibuibLTmt0NfXqj3zVBIGrauOzZj19B3RMo4iaY9ibXq3ar9lSGPdgcqzw2UrgMjQ/132" width="30px"><span>InfoQ_6792a017d8d3</span> 👍（2） 💬（1）<div>真是非常棒。
这节不仅讲了降级、限流、排队、熔点。
还让个人了解了上述知识在整个可用性架构中的位置。

对引导构建已有知识的架构体系尤为有用。

这课买的赚飞了，顺便还买了书，还是更喜欢翻书的感觉</div>2020-08-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/5f/aa/63e641c1.jpg" width="30px"><span>H</span> 👍（2） 💬（1）<div>想问一个问题。关于设计一个接口，一台机器能抗多少量。应该根据一天的总请求量，响应时间，cpu,内存等参数，根据哪个参数来设计？
比如我现在一个接口的一天访问量是2500W，20WDAU。如果推量到100WDAU，访问量是不是直接涨5倍，12500W访问量？往指教</div>2020-05-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/1e/89/25b12054.jpg" width="30px"><span>Andy</span> 👍（2） 💬（1）<div>请教老师一个技术之外的问题，解决方案架构师和系统架构师的区别是什么？各有什么侧重点吗</div>2019-05-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/37/1b/82310e20.jpg" width="30px"><span>拿笔小星</span> 👍（1） 💬（2）<div>老师我们系统用令牌桶做得限流。通过本课学习，发现不妥啊</div>2023-03-10</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/YbUxEV3741vKZAiasOXggWucQbmicJwIjg3HDE58oyibYXbSop9QQFqZ7X6OhynDoo6rDHwzK8njSeJjN9hx3pJXg/132" width="30px"><span>黄堃健</span> 👍（1） 💬（1）<div>结合应用场景就更好了，觉得有点空洞</div>2020-06-17</li><br/><li><img src="" width="30px"><span>GeekCoder</span> 👍（1） 💬（1）<div>如何应对域名故障？如域名被hold。</div>2019-07-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/1b/79/07e442ad.jpg" width="30px"><span>今天</span> 👍（1） 💬（1）<div>感谢老师的专栏，写的很专业，学到了很多，物超所值，尤其是一些方法类的东西，受益终生，以前学习过程中的疑问，也从老师这找到了答案。也期待老师的其他专栏。</div>2018-10-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/02/56/dffa6797.jpg" width="30px"><span>筱龍</span> 👍（1） 💬（1）<div>老师，请问能否基于springcloud或者dubbo来给我们讲讲这些架构，算是最佳实践，多谢</div>2018-07-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/fe/c5/3467cf94.jpg" width="30px"><span>正是那朵玫瑰</span> 👍（1） 💬（2）<div>我觉得秒杀系统最应该做的就是限流，比如1元卖iphone，100台，有1000万人参与秒杀，通过边缘计算只放200人过去秒杀系统，其他用户全部返回秒杀结束，我想200的并发怎么样也扛得住！</div>2018-07-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/06/81/28418795.jpg" width="30px"><span>衣申人</span> 👍（1） 💬（1）<div>整点前降级其他非核心功能，登录采用限流，抢购采用排队加限流，支付对支付宝要有熔断，可加限流。完毕！</div>2018-07-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/35/82/6a/c29f0a54.jpg" width="30px"><span>Leo</span> 👍（0） 💬（1）<div>漏桶算法与令牌桶算法的区别是：
1.令牌桶发放令牌速率，能控制输入速率；而漏桶无输入速率限制；
2.令牌桶一般桶容量比漏桶小。
所以我的理解是：
1.令牌桶用于流量速率控制，控制流量速率不超过令牌添加速率，让流量平滑；从这点来说不允许高突发，允许低于令牌发放速率下的突发，类似于电感电流不能突变。
2.漏桶因为只有一个同容量限制，所以允许突发，输入速率没有限制。</div>2024-01-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/18/3f/7b33cd3c.jpg" width="30px"><span>凌</span> 👍（0） 💬（1）<div>登录模块。首先要对单用户限流做封堵异常IP防止黄牛；其次要进行部分业务降级关闭修改信息更换头像等无关业务。
抢购下单。首先对系统整体做限流对单个产品单个时间的访问量做限制；其次将用户操作进行排队，统一由Consumer调度中心来决定消费顺序。
支付依赖第三方系统。要做熔断，例如银行接口响应慢应提示用户晚些支付。</div>2023-06-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/6b/56/37a4cea7.jpg" width="30px"><span>单朋荣</span> 👍（0） 💬（1）<div>登录、注册，抢购下单、查询，支付为例。
1. 登录和注册，注册功能可以降级处理。
2.抢购时候，查询功能可以限流，用漏捅，处理不了的请求就丢弃返回刷新失败；下单采取限流+排队，参考商品库存确定队列大小，进入队列的用户按先进先出排队。
3.支付功能采取限流+熔断。无故障情况下，使用令牌桶控制请求银行支付速度；故障时，直接熔断并增加容错措施，同时保留30分钟内支付功能。</div>2023-06-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/74/d5/bd75fe69.jpg" width="30px"><span>😶😶😶😶</span> 👍（0） 💬（1）<div>请问 令牌桶 和漏桶    是不是可以相互转换   漏桶关注总量 换算成系统 的tps 是否就可以使用令牌桶了</div>2022-07-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/7a/f5/54a5084b.jpg" width="30px"><span>简单猫</span> 👍（0） 💬（1）<div>一，登入，大并发降级，去掉不必要的信息读取
二，一定量抢，令牌桶，也好，队列也好，看情况吧
如果并发吃住，漏桶也可以，超过阈值直接拒绝
三，支付，要保证唯一性，使用队列比较合适

如果是服务器集群，可以把业务量分散到不同服务器处理，提高并发处理速度
通过hash，用户id ，IP等来分散到不同服务器，并保证最终唯一性</div>2022-03-17</li><br/>
</ul>