你好，我是华仔。

上一节我们讲解了微服务架构“数据分布式”挑战的应对方式：分布式事务。分布式事务都是基于接口或者消息来协作的，而分布式环境下，接口调用可能会失败，消息可能丢失，我们只能采取重试的方式来尽力保证数据最终能够达到一致性。重试机制就涉及微服务架构设计的另外一个技巧：**全局幂等**。

其中，**幂等**（Idempotence）是一个数学与计算机科学中的概念，它指的是某个操作或函数可以多次执行并且保持同样的效果，即无论执行多少次，结果都不会改变。具体来说，如果一个操作是幂等的，那么对同一个输入重复应用这个操作将不会产生额外的效果或变化。

举个最简单的例子：当我们在网上购物，使用微信或者支付宝支付的时候，点击确认支付后网络正好断了，你也不知道是否支付成功，于是又重新刷新支付了一次。对于微信和支付宝来说，如果不做幂等判断，就会出现一个订单支付了两次的情况；而有了幂等判断，就能够保证一个订单只支付一次。

你可能会有疑问，为什么我们要在幂等前面加上“全局”两个字呢？其实这也是微服务架构的“服务分布式”特点决定的：同样的接口请求或者消息，并不一定会被同一个微服务实例处理。因此我们需要在全局的多个微服务范围内保证“幂等”，所以叫“全局幂等”。
<div><strong>精选留言（2）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/21/dc/8f/d7e4a6d1.jpg" width="30px"><span>蒹葭残辉</span> 👍（0） 💬（2）<div>之前参与的对接外部平台的证券类的交易系统架构和老师说的很类似，有幸参与了架构设计和开发。感觉听都是这么说，全都能串起来了。

在这个系统中，分交易服务、交易网关服务和三方平台交易服务（某官方交易机构）。
用户报价请求由Nginx分发给交易服务，交易服务采用了订单号加订单状态进行幂等（这里通过的是数据库for update加报价状态判断），若幂等校验通过将生成全局唯一操作编号，将携带操作编号字段将这个操作发送给交易网关。
交易网关服务接收到交易服务请求后，通过数据库唯一键的方式，尝试写入操作记录。并生成一个三方系统外部请求编号，并采用同步处理模式，将这个操作请求发送给了三方交易系统服务。
三方交易系统采用的是异步处理模式，处理完成后，回调交易网关服务告知操作结果，交易网关服务根据回传的三方系统外部请求编号获取到之前的操作记录，更新订单状态，并通过交易服务。

因此，在这个系统中，涵盖了老师说的几乎所有种的模式。但这其中有一些异常场景，比如，交易服务发给交易网关，未获取到网关响应结果，可能原因有：
1 交易服务发给交易网关，结果结易网关响应值丢失
2 交易网关未收到三方机构的异步响应报文
3 交易网关在接收到三方机构的响应报文时处理异常
等等

因此，交易服务需要有不断重试的机制。当交易服务触发重试时，为防止重复操作，调整为查询逻辑。交易网关先查询三方机构报文是否已经接收完毕，若完成则直接返回查询结果。若未完毕，则主动调用三方机构查询接口进行同步查询，并返回查询结果。

看似设计非常美好，但在有一天压测时，发现，交易服务给交易网关发送了一个报价的操作，由于网关层数据库压力大，导致在写唯一键的时候阻塞时间过长，导致交易服务请求超时。最终导致了交易服务在10秒后重试调用网关进行报价查询，结果此时写唯一键的操作仍然没有提交，网关查询为空，直接响应交易服务此次操作失败，结果在30秒后，网关操作成功，此时又给了交易服务操作成功的消息，此时交易服务接收到成功报文直接是一脸的懵，对于这个问题，不知道老师可有好的建议？</div>2025-02-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/2e/f9/c0a6232c.jpg" width="30px"><span>Capricornus</span> 👍（0） 💬（1）<div>老师，您好。我有个问题，在商城中购买商品，状态只能从下单，购买，付款，发货这样的流程，其中付款只能付款一次。

在业务逻辑中的具体做法，对比数据库的“状态”字段，如果该商品或者订单id（唯一标识）已经付款，就不调用支付宝等支付的接口，直接返回。

这算是保证幂等性了吗？</div>2025-01-08</li><br/>
</ul>