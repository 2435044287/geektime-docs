专栏上一期，我谈了实施微服务需要避免踩的陷阱，简单提炼为：

- 微服务拆分过细，过分强调“small”。
- 微服务基础设施不健全，忽略了“automated”。
- 微服务并不轻量级，规模大了后，“lightweight”不再适应。

针对这些问题，今天我们看看微服务最佳实践应该如何去做。我会分两期介绍这部分内容，今天是微服务架构最佳实践的方法篇，下一期是基础设施篇。

## 服务粒度

针对微服务拆分过细导致的问题，我建议基于团队规模进行拆分，类似贝索斯在定义团队规模时提出的“两个披萨”理论（每个团队的人数不能多到两张披萨都不够吃的地步），分享一个我认为微服务拆分粒度的“三个火枪手”原则，即一个微服务三个人负责开发。当我们在实施微服务架构时，根据团队规模来划分微服务数量，如果业务规继续发展，团队规模扩大，我们再将已有的微服务进行拆分。例如，团队最初有6个人，那么可以划分为2个微服务，随着业务的发展，业务功能越来越多，逻辑越来越复杂，团队扩展到12个人，那么我们可以将已有的2个微服务进行拆分，变成4个微服务。

为什么是3个人，不是4个，也不是2个呢？

首先，从系统规模来讲，3个人负责开发一个系统，系统的复杂度刚好达到每个人都能全面理解整个系统，又能够进行分工的粒度；如果是2个人开发一个系统，系统的复杂度不够，开发人员可能觉得无法体现自己的技术实力；如果是4个甚至更多人开发一个系统，系统复杂度又会无法让开发人员对系统的细节都了解很深。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/ac/a1/43d83698.jpg" width="30px"><span>云学</span> 👍（132） 💬（1）<div>这篇很实用，谢谢分享</div>2018-07-17</li><br/><li><img src="" width="30px"><span>herist</span> 👍（30） 💬（12）<div>感谢老师对微服务解读，有3个问题：目前公司有个在线交易系统，大概几百个表的单体服务项目，其他业务前端都远程调用这个项目，现在想做微服务的改造。
1、实施微服务按业务职责划分后，是否对应模块的数据库也必须要独立？
2、若为每个微服务项目都拆出来新的数据库，原来各业务间的数据依赖（单库的时候Join查询就ok了），拆分多个项目后，有何好的处理办法？
3、团队开发时的问题，由于每小团队负责一个微服务，但开发时需要访问其他微服务，应该有个开发环境负责集成大家提交的代码，构建新版本供其他团队调用和调试，即：开发团队都可以作为消费者访问服务器上微服务（互通），但是开发人员本机启动调试时，不能注册到这台服务器（隔离），这块如何能很好解决？</div>2018-07-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4e/c5/78626367.jpg" width="30px"><span>型火🔥</span> 👍（14） 💬（1）<div>三个火枪手分前后端吗？</div>2018-07-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4e/7d/33feec7e.jpg" width="30px"><span>赵武艺</span> 👍（14） 💬（1）<div>看来小企业还是不太适合微服务架构，尤其是开发人员少的？</div>2018-07-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d7/cd/6ebfc468.jpg" width="30px"><span>王刚</span> 👍（9） 💬（1）<div>听了老师的课对我自己有很大帮助，最近我们公司也在研究微服务～总感觉是一头雾水～希望老师多讲解一下关于微服务经常会涉及到的精髓！</div>2018-07-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e4/e3/b56b31f5.jpg" width="30px"><span>Ivan</span> 👍（9） 💬（1）<div>使用dubbo体系，开发微服务。那么一个微服务是指一个部署单元(jar or war)还是指一个暴露的接口？我的答案是部署单元。请老师帮忙解惑，谢谢！</div>2018-07-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e9/e9/1f95e422.jpg" width="30px"><span>杨陆伟</span> 👍（8） 💬（1）<div>为什么说配置中心可以提升测试和运维的效率，这里不是太理解</div>2019-03-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/a5/ff/6201122c.jpg" width="30px"><span>Geek_89bbab</span> 👍（8） 💬（1）<div>那么对于像kafka，rabbitmq这样的对应的消费者服务的消费地址是否应该放置到配置中心动态配置？还是不建议动态修改？</div>2018-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5b/30/9dcf35ff.jpg" width="30px"><span>森林</span> 👍（8） 💬（2）<div>这里有个先有鸡还是现有蛋的问题。究竟是先根据人数量决定服务数量，还是根据服务数量决定人的数量。就像文章里提到的，很多时候需要根据各种需求场景拆分服务，当生产确切不拆分就会导致问题时，应该反向以服务数量评估要扩招的人</div>2018-09-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cf/bb/22af0e52.jpg" width="30px"><span>孙振超</span> 👍（7） 💬（1）<div>咨询老师一个问题：在服务切分的时候会存两个系统间数据发生交集的情况，比如一个是设备系统，另一个是用户系统，用户的各项操作必然发生在设备上，这样就会存在设备和用户的各种关系和操作记录，像这样的数据设备系统和用户系统都希望以自己为准，而后对外提供相应的服务。如果是数据存储两份，设备系统存储设备和用户的关系，用户系统存储用户和设备的关系，那么在数据一致性和调用链路上就会变得复杂；如果只存储一份，放在那个系统上另一个系统都会有意见。对于此种情况，有什么比较好的解法？</div>2018-09-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0f/d7/31d07471.jpg" width="30px"><span>牛年榴莲</span> 👍（6） 💬（1）<div>接口框架这个词还是第一次听说，有哪些常用的选型呢？</div>2022-09-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/86/68/bda37080.jpg" width="30px"><span>wind2017</span> 👍（6） 💬（1）<div>老师，目前Spring Cloud哪个版本更稳定些？</div>2018-07-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/1b/70/547042ee.jpg" width="30px"><span>谭方敏</span> 👍（5） 💬（1）<div>服务粒度
三个火枪手，一个服务三个人。
好处包括：1）全面了解系统，2）相互形成备份，3）相互讨论。

拆分原则
1）基于业务逻辑
结合三个火枪手选择，计算服务数量，由此决定服务的职责范围。
2）基于可扩展性
将成熟的和不变化的服务分为稳定服务，而将不成熟和变化的服务称为变化服。
3）基于可靠性
将业务模块按照优先级排序，将高可用的核心模块和不高可用的非核心模块分开，重点保证核心模块的高可用性。
好处有a）让非核心业务不再影响核心业务，b）让核心业务变得更加简单，c）降低高可用成本
4）基于性能
类似于基于可靠性分析，将对性能要求高的和负载大的模块拆分出来，避免受其它业务影响。
基础设施
包括四大块：
1）服务发现，服务路由，服务容错
2）接口框架，api网关
3）自动化部署，自动化测试，配置中心
4）服务监控，服务跟踪，服务安全。
在现有微服务上拆分上，之前并没有将研发人数跟服务数量很好地结合起来。三个火枪手的原则很实用。不用特别高大上，异常接地气。
另外在描述基础设施的时候，表述非常全面。</div>2020-03-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/fd/b4/b5483cd5.jpg" width="30px"><span>LB</span> 👍（5） 💬（1）<div>我所在工作单位系统基本都是外部采购，大概有100多个，开发、测试人员大部分是各个公司的外包人员，开发和运维部门又相对比较独立。请问实施微服务是否是一个明智的选择？代价会有多大？领导觉得SOA的ESB太重，又没有使用。希望华仔帮忙给些架构方面的建议，谢谢。</div>2018-07-18</li><br/><li><img src="" width="30px"><span>Kevin</span> 👍（4） 💬（2）<div>老师，微服务路由一般指代什么，我的理解现在的微服务网关都可以配置路由，是不是不需要单独的路由组件了？</div>2022-06-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/42/54/0530d18d.jpg" width="30px"><span>msgx</span> 👍（4） 💬（1）<div>老师，问下现在我们APP访问我们业务中台微服务的中间加了一层聚合服务，每次APP调用后台业务都由APP聚合服务统一调用后台服务接口，这样设计感觉虽然方面了APP对接服务的数量，但每次都要聚合层包装一下是否也不好。</div>2021-05-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/a5/ff/6201122c.jpg" width="30px"><span>Geek_89bbab</span> 👍（4） 💬（4）<div>老师，问一下关于配置中心的问题，
配置中心修改配置，然后通知对应的微服务，那么收到通知的微服务怎么使新的配置生效，我这里特别指的是那些通过配置有创建长生命周期对象的那种。比如mysql连接池，redis-client。比如数据库配置修改了，怎么使新的配置生效？求解惑</div>2018-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a3/e2/5cb4f43f.jpg" width="30px"><span>laolinshi</span> 👍（4） 💬（1）<div>看评论中的那些问题真是受益良多。</div>2018-09-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/53/a8/abc96f70.jpg" width="30px"><span>return</span> 👍（4） 💬（1）<div>三个火枪手， 很犀利。 </div>2018-07-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/cf/10/9fa2e5ba.jpg" width="30px"><span>进击的巨人</span> 👍（3） 💬（1）<div>老师请问，微服务拆饭是否可以按照层拆分，例如电商的商品，拆分成基础商品中心层，这样相当于沉淀了一个商品基础服务，这样拆的好处在于，上层可以构建不同业务模式的商品业务服务，例如传统B2C的商品可以作为一个微服务，社区团购的商品又可以作为一个微服务，达到了商品基础模型能力的复用</div>2021-02-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/25/4a/091c7373.jpg" width="30px"><span>陈栋</span> 👍（3） 💬（1）<div>DDD也算是微服务划分的利器了</div>2020-09-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4e/27/cd9796cd.jpg" width="30px"><span>希望</span> 👍（3） 💬（3）<div>老师请教一个问题，如果一个业务需要由多个微服务参与。如果在调用链中一部分已经成功，数据已提交数据库，此时某服务失败，那么此时如何保证所有服务上的数据一致性呢？</div>2018-12-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/22/e0/8e58a7e1.jpg" width="30px"><span>小思绪</span> 👍（3） 💬（1）<div>请问“接口框架”是指什么？有无成熟产品可以借鉴，它的作用是什么？API网关是指通用网关，比如支付宝开放平台网关，还是业务网关呢？我理解的业务网关的职责应该包括协议转换（比如外网的HTTP转内部Dubbo）和业务逻辑。</div>2018-10-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d5/3f/80bf4841.jpg" width="30px"><span>文竹</span> 👍（3） 💬（1）<div>目前业务中只使用了网关，为什么首先使用网关呢？因为想对一批互不关联的服务进行统一认证、限流等。这样的话，这批服务就不是微服务了，因为服务间没有关联。面对这种场景，认为不能完全照搬微服务的一些设施，具体问题还得具体分析。

由于服务间不存在互相调用，所以一些微服务的设施可以不使用。比如：
1、服务追踪，服务发现、路由，容错。
2、配置中心
</div>2018-08-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cd/22/dfa52b74.jpg" width="30px"><span>张威</span> 👍（3） 💬（3）<div>我们项目正好相反，将系统拆分了多个子系统，但是同一个库，子系统之间没有相互调用，而是直接对相同库中的表进行操作。在开发过程中发现每个系统中多少会有些重复的代码。该系统是校级系统，目前没发现其它弊端</div>2018-07-19</li><br/><li><img src="" width="30px"><span>yason li</span> 👍（3） 💬（1）<div>感觉应该还可以按照领域模型中数据一致性的维度来拆分。比如对实时一致性要求比较高的业务，尽量避免散落在太多服务中，增加分布式事务管理的复杂度。还有，感觉现在各种服务治理的架构其实还是造名词多一些，本质上都应该算是SOA思想的延伸或者变形。比如现在很火的Service Mesh本质上就是借鉴了通信领域的控制面数据面分离思想做出的去中心化的ESB。</div>2018-07-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/a8/1b/ced1d171.jpg" width="30px"><span>空档滑行</span> 👍（3） 💬（1）<div>这里面服务容错是比较容易被忽视的，见过太多的开发问，服务好好的怎么会出错呢？我做开发2,3年了也没见过数据库数据损坏。
关于api网关请教下，什么时候应该考虑加网关层，以微服务数量来评估吗？
还有现在讨论的比较多的service mesh，单独把通信层解耦出来，感觉对于一般的中型互联网公司也没有必要吧</div>2018-07-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/50/b3/9269cd59.jpg" width="30px"><span>LWD</span> 👍（2） 💬（1）<div>redis数据多个服务去共享合理吗？
比如订单服务需要用到用户信息，直接自己根据用户id去redis里面去取用户服务设置的缓存信息，而不是统一都通过用户服务接口获取。
我个人认为是很不合理的，因为缓存属于实现细节，如果缓存失效了或者结构改变了那这些引用的客户端处理起来就很麻烦了。
但是领导确以要多走一次RT为由拒掉这个说法，我也不好据理力争，请问华哥该怎么理解这个问题呢？</div>2023-03-25</li><br/><li><img src="" width="30px"><span>BIZ_UI_3</span> 👍（2） 💬（2）<div>按人员数量拆分简直误人子弟。。。同样的业务，难道团队3人就1个服务，团队要是30人就10个服务吗？</div>2022-03-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/91/6b/3590eb7f.jpg" width="30px"><span>青山</span> 👍（2） 💬（1）<div>很多优秀的军队底层组合都是三三制原则，三个火枪手，这个原则好👍</div>2022-02-03</li><br/>
</ul>