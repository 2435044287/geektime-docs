完成备选方案的设计和选择后，我们终于可以长出一口气，因为整个架构设计最难的一步已经完成了，但整体方案尚未完成，架构师还需继续努力。接下来我们需要再接再励，将最终确定的备选方案进行细化，使得备选方案变成一个可以落地的设计方案。所以今天我来讲讲架构设计流程第4步：详细方案设计。

## 架构设计第4步：详细方案设计

简单来说，详细方案设计就是将方案涉及的关键技术细节给确定下来。

- 假如我们确定使用Elasticsearch来做全文搜索，那么就需要确定Elasticsearch的索引是按照业务划分，还是一个大索引就可以了；副本数量是2个、3个还是4个，集群节点数量是3个还是6个等。
- 假如我们确定使用MySQL分库分表，那么就需要确定哪些表要分库分表，按照什么维度来分库分表，分库分表后联合查询怎么处理等。
- 假如我们确定引入Nginx来做负载均衡，那么Nginx的主备怎么做，Nginx的负载均衡策略用哪个（权重分配？轮询？ip\_hash？）等。

可以看到，详细设计方案里面其实也有一些技术点和备选方案类似。例如，Nginx的负载均衡策略，备选有轮询、权重分配、ip\_hash、fair、url\_hash五个，具体选哪个呢？看起来和备选方案阶段面临的问题类似，但实际上这里的技术方案选择是**很轻量级的**，我们无须像备选方案阶段那样操作，而只需要简单根据这些技术的适用场景选择就可以了。

例如，Nginx的负载均衡策略，简单按照下面的规则选择就可以了。

- 轮询（默认）

每个请求按时间顺序逐一分配到不同的后端服务器，后端服务器分配的请求数基本一致，如果后端服务器“down掉”，能自动剔除。

- 加权轮询

根据权重来进行轮询，权重高的服务器分配的请求更多，主要适应于后端服务器性能不均的情况，如新老服务器混用。

- ip\_hash

每个请求按访问IP的hash结果分配，这样每个访客固定访问一个后端服务器，主要用于解决session的问题，如购物车类的应用。

- fair

按后端服务器的响应时间来分配请求，响应时间短的优先分配，能够最大化地平衡各后端服务器的压力，可以适用于后端服务器性能不均衡的情况，也可以防止某台后端服务器性能不足的情况下还继续接收同样多的请求从而造成雪崩效应。

- url\_hash

按访问URL的hash结果来分配请求，每个URL定向到同一个后端服务器，适用于后端服务器能够将URL的响应结果缓存的情况。

这几个策略的适用场景区别还是比较明显的，根据我们的业务需要，挑选一个合适的即可。例如，比如一个电商架构，由于和session比较强相关，因此如果用Nginx来做集群负载均衡，那么选择ip\_hash策略是比较合适的。

**详细设计方案阶段可能遇到的一种极端情况就是在详细设计阶段发现备选方案不可行，一般情况下主要的原因是备选方案设计时遗漏了某个关键技术点或者关键的质量属性。**例如，我曾经参与过一个项目，在备选方案阶段确定是可行的，但在详细方案设计阶段，发现由于细节点太多，方案非常庞大，整个项目可能要开发长达1年时间，最后只得废弃原来的备选方案，重新调整项目目标、计划和方案。这个项目的主要失误就是在备选方案评估时忽略了开发周期这个质量属性。

幸运的是，这种情况可以通过下面方式有效地避免：
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/fe/c5/3467cf94.jpg" width="30px"><span>正是那朵玫瑰</span> 👍（267） 💬（15）<div>可以完善的细节：
1、发送端和消费端如何寻址
利用zookeeper做注册中心，把broker的地址注册到zk上，发送端和消费端只要配置注册中心的地址即可获取集群所以broker地址，当有broker下线时，发送端和消费端能及时更新broker地址。
2、发送端消息重试
当发送消息发生网络异常时（不包括超时异常），可以重新选择下一台broker来重试发送，重试策略可以自定义。
3、消息消费采用pull还是push？
考虑push模式会更复杂，故放弃，采用pull模式，消费端主动去拉，为了达到与push模式相同的低延迟效果，可以采用长轮询的方式，消费端轮询拉取消息费，当有消费可消费时，返回消息，如果没有可消费的消息，挂起当前线程，直到超时或者有可消费的消息为止。
4、消息重复问题
消息中间件不解决消息重复的问题，有业务系统自己根据业务的唯一id去重。
5、顺序消息
发送端在发生顺序消息时，只发送到相同broker的相同队列，消费端消费时，顺序消息只能由同一个消费端消息。
6、定时消息
发送端指定消息延时多长时间消费，broker端定时扫描定时消息，达到延时时间的消息加入到消费队列。
7、事务消息
发送端分两步，先预发送消息，broker端只记录消息为预发送状态，再执行本地事务，然后再根据本地事务的成功或者失败发送确认消息（回滚还是提交），这步如果发生异常，broker启动定时任务，把未确认的消息发送给发送端回查事务状态（需要发送端提供回查接口）。

目前就想到这么多。</div>2018-05-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ed/68/737f97c8.jpg" width="30px"><span>ant</span> 👍（62） 💬（2）<div>很有幸我们现在的架构师就是PPT架构师，我觉得他的优点就是懂了很多的概念，能说话到，可以忽悠住老板。缺点也很明显，就是他知道的都不是很深，比如曾经我们的搜索引擎原型，他并不能说出ES和solr的优缺点(当然我也不知道，平时用solr多点)，最后我们选了ES，他给的原因就是朋友说的ES比solr好，后面搜索这里就交给我来搞了。我们是互联网项目，在重构的项目的时候他选择了jpa，这就导致变化需求的时候，查询这块比较麻烦，不灵活。
其实就像前面说的，每个技术存在就是合理的，只是每个有每个技术的使用点，架构师应该对常见的技术栈原理非常清楚，知道什么时候应该使用什么技术。
我理解的PPT架构师的特点就是知识点多，知道概念，能虎住老板，缺点就是技术栈不咋滴，特别是细节上。我觉得架构师应该帮助员工成长，而不是遇到问题就说这个问题我没遇到过，你上网搜索下解决方案。
初次留言，欢迎板砖</div>2018-05-26</li><br/><li><img src="" width="30px"><span>蜗牛</span> 👍（57） 💬（2）<div>就一些新的技术引入，架构师需要做哪些技术验证，或者研究到什么深度以后，才认为该技术适合呢？</div>2018-05-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/65/d5/88beb15a.jpg" width="30px"><span>李志博</span> 👍（39） 💬（6）<div>认识一个工作10多年的架构师，天天只会说代码命名和注释的问题，从来没谈过什么高大上的架构，也从来没见他写过代码，有一次我来他来帮我看一个问题，他装没听见，走了……</div>2018-05-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/fb/49/e14b1c54.jpg" width="30px"><span>稳健的少年</span> 👍（39） 💬（2）<div>PPT架构师以脱离一线时间较久的领导居多吧。很多技术他们没有真正使用过，只是从各种途径得知很强大，其他公司（BAT）都在用，于是就在PPT中写入这种技术。缺点就是很容易做出貌似可行，深究其细节全是坑的设计。</div>2018-05-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/9f/dd/5f2bb469.jpg" width="30px"><span>Nick</span> 👍（25） 💬（4）<div>好吧，我就是ppt架构师😓
架构的层级看，有企业架构、业务架构、IT架构等，EA分业务、应用、技术、数据、基础设施等，不同的架构对架构师要求不一样，这个教程主要是讲技术架构，要求架构师对技术细节掌握较深，其他几种架构师虽然在写ppt但是真得不简单呢，知识面广度，行业理解，客户需求，抽象思维，心理揣摩，产品知识样样都要掌握</div>2018-11-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/65/b1/5fdf77ef.jpg" width="30px"><span>YiZhiYu</span> 👍（15） 💬（1）<div>没理解日志表在这里的意义，如果单纯是为了尾部追加，消息表也是尾部追加的操作吧，如果是为了记录消息，可消息表本身也记录了消息。

原因我能想到的作用，是记录消息存储队列，即哪个消息存在了哪个队列

另外，消息表中是不是应该添加一个消息消费确认字段，当消息被消费成功后，更改该字段，这也可以避免重复消费

以上，请华哥指点</div>2018-09-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/a8/1b/ced1d171.jpg" width="30px"><span>空档滑行</span> 👍（15） 💬（2）<div>真见过PPT架构师，1.自己基本不写代码，2.对某一项技术比较精通所以架构设计时尽量往这上面靠，比如对mysql很熟悉所以设计出的系统大量用到mysql 存储过程，3.设计出来的架构完全不考虑老系统兼容或者迁移难度</div>2018-05-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/da/74/fb0049af.jpg" width="30px"><span>L</span> 👍（10） 💬（6）<div>业务系统发布消息时，首先写入到日志表，日志表写入成功就代表消息写入成功；后台线程再从日志表中读取消息写入记录，将消息内容写入到消息表中。

业务系统读取消息时，从消息表中读取。


这里的设计是不是冗余了？？</div>2018-05-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/03/a2/ceb37046.jpg" width="30px"><span>crazyone</span> 👍（9） 💬（3）<div>华哥，&quot;日志表是尾部追加，性能高&quot;，这个具体实施细节能否讲解下。</div>2018-05-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/a7/c5/a660de90.jpg" width="30px"><span>Neo</span> 👍（8） 💬（1）<div>关于写入日志再写入消息表的问题，我如下理解，你看对不:

你们实现了一个专门的日志表的功能程序，方式就是文件尾部追加，其实和mysql是独立存在的，只是名字叫日志表其实是一个文件，另外会有程序负责把这个文件内的数据逐条同步到mysql数据库里面，不知道可不可以这么理解</div>2018-11-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg" width="30px"><span>piboye</span> 👍（7） 💬（2）<div>一个这么低量级的mq，消息格式为什么选择tcp和pb？调试和测试，压测工具单独开发的工作量呢？http协议多简单，http可以轻松做到10wqps，难道是Java的netty性能不行？
</div>2020-08-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7d/66/070a7fb2.jpg" width="30px"><span>MavenTalker</span> 👍（7） 💬（1）<div>架构师对个人的知识点、知识面、知识体系要求很高，也就是技术宽度与深度的问题。

平常说打杂也不为过，什么都要懂，但不一定都得上手做，要能指引他人按着蓝图去实施，当然碰到棘手问题，还是要深入进去解决。

架构师是体现了一个团队的技术强度，PPT架构师有时候还是需要做一做，但不能只停留在PPT里，落地实战同样不能逊色。
</div>2018-05-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/39/17/25833aa7.jpg" width="30px"><span>李雷</span> 👍（6） 💬（2）<div>若没有日志表，直接使用消息表，同步写入性能低，评论中您写到多个消息表的寻址性能比较低，日志表作为缓冲表，尾部写入性能高，再加上异步写入消息表，总体比单消息表设计性能高，我的理解对吗？谢纠正</div>2018-08-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ce/46/67c145ee.jpg" width="30px"><span>bluefantasy</span> 👍（6） 💬（1）<div>请教华仔：您说的”日志表是尾部追加，性能高”，这个日志表是用myisam存储引擎吗？我刚刚查了文档innodb只有系统表空间和日志文件是序列化写呀，普通表文件都是随机写。  请指教。</div>2018-05-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/fc/b8/95c7959b.jpg" width="30px"><span>Jolie Liang</span> 👍（6） 💬（2）<div>对于PPT架构师，总结有以下几个特点：
1）整体思路照搬
2）不能准确定位业务需要解决的痛点
3）对所需技术的原理理解不深
4）执行到后期，返工及补坑的工作比较多
.......</div>2018-05-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0e/cc/766a0e62.jpg" width="30px"><span>Q_x H!</span> 👍（4） 💬（1）<div>看到好多评论在讨论日志表尾部追加的问题，我的理解，mysql 每张表在磁盘上都有自己相应的文件存储数据，当10条不同的消息要写进不同的10个表数据文件时就属于随机写了有性能损耗，如果先写到日志表的话是对同一个表的文件进行顺序写。故通过日志表的尾部追加来提高写性能。不知道理解的对不对</div>2021-08-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d1/72/4cc8475c.jpg" width="30px"><span>Leaf</span> 👍（4） 💬（2）<div>关于日志表尾部追加，也有一个问题：如果只单表写入日志表是尾部追加，不会有其他的位置寻址；不过有后台程序会读取日志表，将日志表的数据再写入消息表，这时写入日志表和写入消息表可能是并发的，然后数据库写入数据到磁盘时，也是需要切换寻址的。所以怎么理解提高了性能？</div>2020-04-19</li><br/><li><img src="" width="30px"><span>Geek_88604f</span> 👍（4） 💬（1）<div>架构设计四步走:
        架构设计第一步是识别复杂度，架构师需要根据业务需求，当前现状，未来的行业发展以及技术发展能够比较准确的识别系统的复杂度到底在哪。是业务的高TPS还是低时延还是高可用。一旦识别错误将导致有限的研发资源投入到错误的方向。曾经历过项目中架构师预判复杂度的情况，最初认为系统的高TPS是最高优先级。但是系统上线后才发现系统高可用是最关键的问题，特别是系统依赖的第三方关键组件可靠性低，经常宕机甚至丢失数据，无法满足客户诉求导致客户投诉。
        架构设计的第二步是设计备选方案。通常情况下需要3～5个备选方案。备选方案之间要有明显的技术差异，备选方案要适当采用新技术，关注技术选型而不是细节。回想起曾经经历的项目架构备选方案倒是有，但是没有本质的差异，无聊的选择是一样的，只是组建的交互流程有区别，会议上对于刘成争论不休。
        架构设计的第三步是评估和选择备选方案。关系评估和选择方式有最牛派，最简派，最熟派和领导派。不同的场景下需要选择不同的方式，往往是综合起来的360度环评，它是一个定性评估，依赖于架构师丰富的经验。从不同的维度根据优先级确定，这是最难的一环。
        架构设计的第四部是详细设计，在方案选定后需要进一步确定方案的技术细节。系统中各组建的工作模式，组建间的交互模式，组建的依赖关系，数据库的设计，关键业务逻辑的梳理，业务界面如何呈现等。</div>2019-08-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/00/e4/2ca385ce.jpg" width="30px"><span>小龙</span> 👍（4） 💬（1）<div>架构师需要把框架搭起来吗？还是只是以文档形式把方案写出来，团队根据文档搭框架写代码？现在的专栏技术都是讲解互联网电商行业的技术及架构，您专栏讲的架构知识是否适用于工业领域？比如自动化码头调度监控所有自动化设备的软件系统。</div>2018-06-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f8/ba/d28174a9.jpg" width="30px"><span>Geek_zbvt62</span> 👍（4） 💬（1）<div>我理解的ppt架构师和大家不同，我理解的ppt架构师往往类似咨询公司的那种，要充分熟悉领域业务，有成熟方案经验，只要方案成功过就行，至于怎么落地就是你的事了。这种会有市场，主要还是对某些领域的整体摸得比较熟。
今天这个方案，有一个日志消息表的目的，是为了把消费和写入操作带来的压力分开嘛？考虑到写和读的比例是11比10，所以日志表每个库只有一个？
文章似乎没提具体如何记录消费者读取消息位置，这也是个关键trade off的点，决定了qos。下期会说？
另外有个吹毛求疵的想法，自研发sdk往往比看起来的难，需要设计功力，有bug了如何及时分发新版本都是问题。选型时需要开发sdk的都是减分项。
怎么看这都是消息队列擅长的场景，使用成熟三方实现成本会非常非常低，不能和运维大哥商量一下么？-_-
</div>2018-05-26</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eocvvlibbfYw4wezziaBKn2OLDpvTndicPr21ZZoeiaM5QLibICy7PJPQibCAz5zfMe08ibem7ll3LSzkWaQ/132" width="30px"><span>Geek_8c0618</span> 👍（3） 💬（1）<div>实不相瞒 我在的组就用redis做了一个消息队列。。</div>2021-03-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/16/2d/2753369a.jpg" width="30px"><span>Geek_58ezrw</span> 👍（3） 💬（1）<div>PPT架构师，基本上是从网上找资料过来，没有根据业务中实际情况来进行验证，而确定了方案。是这样子吗？</div>2018-12-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/8e/0b/89055f4c.jpg" width="30px"><span>cn</span> 👍（3） 💬（2）<div>主备同步只是消息表，如果主机挂了日志表里还没入消息表的记录是否就丢失了？</div>2018-09-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/10/4f/ac326acf.jpg" width="30px"><span>绿豆先生</span> 👍（3） 💬（1）<div>有个问题咨询下，选用ip_hash作负载均衡策略时，如果一台机器挂掉了，因为有对应ip机器上存储session的原因，如何保证整体的映射规则的平稳过渡呢</div>2018-07-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e3/8a/a256607d.jpg" width="30px"><span>Hook</span> 👍（3） 💬（2）<div>请老师指导下：
同一个队列的消息数据是不是被分散到了不同的分区上？此时假如要考虑消息顺序性的话，是不是就不满足了？</div>2018-05-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f7/9d/be04b331.jpg" width="30px"><span>落叶飞逝的恋</span> 👍（2） 💬（1）<div>公司内部系统开发，都是直接调用基础组件，然后编写业务代码，部署交给运维，没看到过有人分享这些步骤。幸好读了这个专栏</div>2020-09-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg" width="30px"><span>escray</span> 👍（2） 💬（2）<div>因为缺乏经验，所以对详细方案设计这里没有可以表达的，感觉需要先去看一下极客时间的《消息队列高手课》和《Kafka核心技术与实战》。

详细方案设计这里是不是应该有一个大概的思路，比如从客户端读写，到中间件的响应，再到后端的存储。专栏中罗列的设计点似乎更多的是从数据库、服务器和存储的角度考虑；而留言中 @正是那朵玫瑰 的留言里面，补充的大多是从客户端和消息中间件角度。

看到留言里面不少同学在讨论“PPT 架构师”，我觉的这种“装腔”架构师也是有存在必要的，其实他可能更像一个售前，通过高大上的名词和天花乱坠的演讲，能够说服领导、威慑客户、拿到单子。至于开发部署，当然不能完全按照 PPT 上的来。

虽然我自己的目标是“经济适用架构师”，但是我也准备学习一下如何做出漂亮的 PPT，并且学好沟通和演讲。</div>2020-09-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg" width="30px"><span>piboye</span> 👍（2） 💬（2）<div>日志表相当于wal，消息表异步刷新，时间延迟不严格的可以做批量合并。日志表尽快删除记录是防止表的脏页再刷一次磁盘。 个人感觉不一定更差，binlog都是顺序写，差别是脏页，而消息表本身也不去改数据也是顺序的，脏页基本也是顺序刷盘。所以不知道是不是测试过这两种的性能差异？</div>2020-08-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/0e/e9/98b6ea61.jpg" width="30px"><span>程序员大天地</span> 👍（2） 💬（1）<div>技术小白是不是不适合听这个课，文中讲到的技术有些只听过名字</div>2019-10-25</li><br/>
</ul>