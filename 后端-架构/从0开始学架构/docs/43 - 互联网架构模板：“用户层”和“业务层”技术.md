上一期，我从计算机网络层的角度谈了应对“高性能”和“高可用”的整体架构设计。今天，我将从“用户层”和“业务层”的角度谈谈常见的应用场景和关键技术。

## 用户层技术

1.用户管理

互联网业务的一个典型特征就是通过互联网将众多分散的用户连接起来，因此用户管理是互联网业务必不可少的一部分。

稍微大一点的互联网业务，肯定会涉及多个子系统，这些子系统不可能每个都管理这么庞大的用户，由此引申出用户管理的第一个目标：**单点登录（SSO）**，又叫统一登录。单点登录的技术实现手段较多，例如cookie、JSONP、token等，目前最成熟的开源单点登录方案当属CAS，其架构如下（[https://apereo.github.io/cas/4.2.x/planning/Architecture.html](https://apereo.github.io/cas/4.2.x/planning/Architecture.html) ）：

![](https://static001.geekbang.org/resource/image/26/e3/269ca104c464b2f6f50ec922059f38e3.jpg?wh=4461%2A3906)

除此之外，当业务做大成为了平台后，开放成为了促进业务进一步发展的手段，需要允许第三方应用接入，由此引申出用户管理的第二个目标：**授权登录**。现在最流行的授权登录就是OAuth 2.0协议，基本上已经成为了事实上的标准，如果要做开放平台，则最好用这个协议，私有协议漏洞多，第三方接入也麻烦。

用户管理系统面临的主要问题是用户数巨大，一般至少千万级，QQ、微信、支付宝这种巨无霸应用都是亿级用户。不过也不要被这个数据给吓倒了，用户管理虽然数据量巨大，但实现起来并不难，原因是什么呢？ 因为用户数据量虽然大，但是不同用户之间没有太强的业务关联，A用户登录和B用户登录基本没有关系。因此虽然数据量巨大，但我们用一个简单的负载均衡架构就能轻松应对。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/8a/16/10420350.jpg" width="30px"><span>LouisLimTJ</span> 👍（59） 💬（2）<div>当然正确的话是要根据业务和团队来设计虚服务域。但是个人看法，粒度方面要粗一些，本来虚服务域就是来解决系统拆分过细的问题。
至于具体多少个为好，我们可以仿照管理学关于一个一层管理团队的理想大小，其答案不一定，但一般是不要超过10个，我个人比较舒服的数目是3到7个。</div>2018-08-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（13） 💬（2）<div>课后思考及问题
1：本文核心观点
1-1：面对庞大复杂的东西，用拆字决——化整为零，分而治之。
1-2：面对细微量多的东西，用合字决——分久必合，合二为一。
2：虚拟业务域划分的粒度需要粗一些还是要细一些？你建议虚拟业务域的数量大概是多少，理由是什么？
要粗一些，大概5～7个
理由：虚拟业务域要解决的是划分的系统太细太多的问题，关键是太细导致了太多，这是分而治之现在要合二为一，所以，最好粗一些，咱们的集体领导制最高领导人也就5或7个人，十几亿人民也是管理的好好的。划分的太少，容易集中，复杂化，划分的太多，容易分散，不好管理。</div>2019-09-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/0c/30/d4737cd5.jpg" width="30px"><span>lyonger</span> 👍（9） 💬（2）<div>一开始以为互联网架构模版中的技术，会介绍具体的技术知识，结果理论居多。😹</div>2020-03-22</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epmAicDUiaUdtLhVwSs6fT0yx69ibWy6ia46ZD4vblGtyee8QFz71icKZJkzccAFG3zHnMngSz7WeGBtKw/132" width="30px"><span>小神david</span> 👍（7） 💬（1）<div>互联网业务千差万别万别，不过如果对比粗细来划分，虚拟域是要粗一些的，因为它出现的目标就是如此，整合更细粒度的微服务。具体数量这个没办法统一来分，结合实际业务情况和团队人员情况而定吧。</div>2021-03-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/bc/ee/c42cdaf7.jpg" width="30px"><span>风雨无阻</span> 👍（6） 💬（1）<div>虚拟域是不是有点像中台了</div>2018-10-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d0/08/979cc9dc.jpg" width="30px"><span>l-m-a</span> 👍（6） 💬（1）<div>个人觉得增加了facade层，服务器机器数量提升，另外服务之间的调用并没有减少反而还增加了，facade层的性能直接影响内部服务的能力。</div>2018-08-06</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI8mFt5wSkia31qc8paRg2uPSB6AuEBDricrSxvFBuTpP3NnnflekpJ7wqvN0nRrJyu7zVbzd7Lwjxw/132" width="30px"><span>Geek_steven_wang</span> 👍（3） 💬（1）<div>数量上应该根据具体业务领域逐层汇总，到达一个团队可接受的数量，一开始建议尽量少5个一下，要考虑后面业务扩展还会加，但最多不建议超过9。

另外问题就是一个域内的服务数量还是多，这个有什么办法吗？不能再汇总出网关了，这样层级太深。</div>2020-01-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/15/03/c0fe1dbf.jpg" width="30px"><span>考休</span> 👍（3） 💬（2）<div>请问老师，目前大部分系统都是前后端分离的架构，前后台的调用使用jwt做token验证，在这种前提下，还需要考虑单点登录的方案吗，是不是所有的模块只需要采用相同的验证、生成规则就可以了，当然对于微服务架构的话，将鉴权放到网关上完成就可以了，感觉像cas这样的方法像是可以给之前jsp时代用的</div>2019-11-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f8/4b/5ae62b10.jpg" width="30px"><span>Geek_b04b12</span> 👍（3） 💬（1）<div>有几个知识盲点：
1.facade模式，和工厂模式一个范畴？
2，虚拟业务域中图片中的网关，是啥意思？相对于域名来调用服务？还是别的？在阿里的接口和域名访问，用户能感受到吗？或者作为学习者有验证的端倪吗？</div>2018-08-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a8/ab/5d25cd32.jpg" width="30px"><span>客舟听雨来coding</span> 👍（2） 💬（1）<div>这虚拟域感觉有些像领域驱动设计的限界上下文</div>2019-10-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/47/a0/f12115b7.jpg" width="30px"><span>Sam.张朝</span> 👍（2） 💬（2）<div>原来最初接触微服务，只知道要拆分，不能拆分过细。
现在是要按照业务域拆分合并。</div>2019-09-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f0/13/70cdc365.jpg" width="30px"><span>wikili</span> 👍（2） 💬（1）<div>在同一个虚拟业务域下合并的两个业务子系统自我调用怎么实现的？比如A子系统需要调用B子系统</div>2019-01-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d5/3f/80bf4841.jpg" width="30px"><span>文竹</span> 👍（2） 💬（1）<div>首先根据团队人数来决定业务域的数量，一个业务域可以由3个开发人员负责。如果有12个开发人员，那么就划分成4个业务域，再来看是用粗还是细粒度划分。</div>2018-08-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/de/17/75e2b624.jpg" width="30px"><span>feifei</span> 👍（2） 💬（1）<div>这个肯定要粗一些，高内聚么，这样肯定功能类似的都被合并为一个了！我觉得控制在个位数吧！我觉得这是相对的一个平衡吧</div>2018-08-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f5/2f/56117bab.jpg" width="30px"><span>张玮(大圣)</span> 👍（2） 💬（1）<div>既然上升到虚拟域了，粒度粗一些会好很多，细的话容易淹没在业务中，理不清域之间边界了。

从以前经历的一些项目得出的结论，10 个全是比较多了，再多的话就需要加入子域来说明了。

最后，一起陪伴走过这么多专栏课时，运华兄辛苦！</div>2018-08-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/2c/e7/3c0eba8b.jpg" width="30px"><span>wuhulala</span> 👍（2） 💬（1）<div>我们现在比如说有一个a子系统里面有两个子工程b和c  b和c单独提供服务 那么这样b和 c算是两个微服务 a算是虚拟业务域 如果是这样的话 我认为这样划分逻辑清晰 也无需多做什么工作 有何不可呢。期待答疑</div>2018-08-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ee/d2/7024431c.jpg" width="30px"><span>探索无止境</span> 👍（2） 💬（1）<div>不知不觉专栏就到尾声了，感谢老师的梳理，把我的整个知识体系理顺了，是否可以提供一些相关技术延伸的优质文章链接，老师是否有开新专栏的打算？</div>2018-08-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/4b/40/9c8b9027.jpg" width="30px"><span>杨涛,..</span> 👍（1） 💬（1）<div>我们的微服务也用域包容起来了，但是业务中台和数据中台加起来就有18个域了，还有各种平台，这让我们苦不堪言</div>2022-04-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/07/8c/0d886dcc.jpg" width="30px"><span>蚂蚁内推+v</span> 👍（1） 💬（1）<div>老师好 方便介绍下单点登录吗</div>2018-08-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/37/1b/82310e20.jpg" width="30px"><span>拿笔小星</span> 👍（0） 💬（1）<div>大佬，这里的虚服务域，和BFF层有啥关系？</div>2023-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/b5/3c/967d7291.jpg" width="30px"><span>艺超(鲁鸣)</span> 👍（0） 💬（1）<div>粒度要尽量粗一些吧，毕竟虚服务域的主要目的就是合并过细的微服务。至于数量的话，还是根据业务情况而定吧。</div>2022-07-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg" width="30px"><span>ifelse</span> 👍（0） 💬（1）<div>看了老师的文章，有种总览全局，豁然开朗的感觉</div>2022-03-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/29/ba/8e/4645afae.jpg" width="30px"><span>Drake敏</span> 👍（0） 💬（1）<div>细一点，这样对业务影响没有那么大...而且方便查问题，一般分成5个子系统最好，主要服务肯定是尽量保持正常</div>2021-09-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/cf/10/9fa2e5ba.jpg" width="30px"><span>进击的巨人</span> 👍（0） 💬（1）<div>后面这个按照业务域拆分，这岂不会出现多个系统之间相互调用，类似循环依赖问题，请问这个怎么解决？</div>2020-11-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/08/36/98be3d69.jpg" width="30px"><span>奋斗心</span> 👍（0） 💬（1）<div>这一个星期学到很多。感谢，纠正我不少理解
DDD专栏名字叫什么,没找到</div>2018-10-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/2c/e7/3c0eba8b.jpg" width="30px"><span>wuhulala</span> 👍（0） 💬（1）<div>不能连续回复 有点差评 
老师回复的那个虚拟域的概念是 我一直以为我这样划分算是微服务</div>2018-08-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d5/e1/a05a9e22.jpg" width="30px"><span>kyll</span> 👍（0） 💬（1）<div>虚拟业务域，有点类似服务聚合层？</div>2018-08-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/1d/8e/0a546871.jpg" width="30px"><span>凡凡</span> 👍（0） 💬（1）<div>关键因素是团队规模和组织架构，一个团队内部最多两个人一个虚拟业务域，再多就很容易出现频繁切换业务域，业务域没有足够备份的情况，出现弊大于利的状况。</div>2018-08-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/2c/e7/3c0eba8b.jpg" width="30px"><span>wuhulala</span> 👍（0） 💬（1）<div>我觉得还是看团队大小的 像我们这种只有十几个人一个产品 或者说是项目团队来说 每两到三个人负责一个系统还是可以的 我划分的时候 主要是按照主流程分几个子系统 然后周边系统根据其功能性 如展示系统、第三方对接系统</div>2018-08-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ce/3d/385b8263.jpg" width="30px"><span>星火燎原</span> 👍（0） 💬（1）<div>虚拟业务域涉及到DDD，老师有木有计划开这方面课程？</div>2018-08-04</li><br/>
</ul>