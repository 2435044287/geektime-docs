周四，我为你讲了架构设计的主要目的是为了解决软件系统复杂度带来的问题。那么从今天开始，我将为你深入分析复杂度的6个来源，先来聊聊复杂度的来源之一高性能。

对性能孜孜不倦的追求是整个人类技术不断发展的根本驱动力。例如计算机，从电子管计算机到晶体管计算机再到集成电路计算机，运算性能从每秒几次提升到每秒几亿次。但伴随性能越来越高，相应的方法和系统复杂度也是越来越高。现代的计算机CPU集成了几亿颗晶体管，逻辑复杂度和制造复杂度相比最初的晶体管计算机，根本不可同日而语。

软件系统也存在同样的现象。最近几十年软件系统性能飞速发展，从最初的计算机只能进行简单的科学计算，到现在Google能够支撑每秒几万次的搜索。与此同时，软件系统规模也从单台计算机扩展到上万台计算机；从最初的单用户单工的字符界面Dos操作系统，到现在的多用户多工的Windows 10图形操作系统。

当然，技术发展带来了性能上的提升，不一定带来复杂度的提升。例如，硬件存储从纸带→磁带→磁盘→SSD，并没有显著带来系统复杂度的增加。因为新技术会逐步淘汰旧技术，这种情况下我们直接用新技术即可，不用担心系统复杂度会随之提升。只有那些并不是用来取代旧技术，而是开辟了一个全新领域的技术，才会给软件系统带来复杂度，因为软件系统在设计的时候就需要在这些技术之间进行判断选择或者组合。就像汽车的发明无法取代火车，飞机的出现也并不能完全取代火车，所以我们在出行的时候，需要考虑选择汽车、火车还是飞机，这个选择的过程就比较复杂了，要考虑价格、时间、速度、舒适度等各种因素。

软件系统中高性能带来的复杂度主要体现在两方面，一方面是**单台计算机内部为了高性能带来的复杂度**；另一方面是**多台计算机集群为了高性能带来的复杂度**。

## 单机复杂度

计算机内部复杂度最关键的地方就是操作系统。计算机性能的发展本质上是由硬件发展驱动的，尤其是CPU的性能发展。著名的“摩尔定律”表明了CPU的处理能力每隔18个月就翻一番；而将硬件性能充分发挥出来的关键就是操作系统，所以操作系统本身其实也是跟随硬件的发展而发展的，操作系统是软件系统的运行环境，操作系统的复杂度直接决定了软件系统的复杂度。

操作系统和性能最相关的就是**进程**和**线程**。最早的计算机其实是没有操作系统的，只有输入、计算和输出功能，用户输入一个指令，计算机完成操作，大部分时候计算机都在等待用户输入指令，这样的处理性能很显然是很低效的，因为人的输入速度是远远比不上计算机的运算速度的。

为了解决手工操作带来的低效，批处理操作系统应运而生。批处理简单来说就是先把要执行的指令预先写下来（写到纸带、磁带、磁盘等），形成一个指令清单，这个指令清单就是我们常说的“任务”，然后将任务交给计算机去执行，批处理操作系统负责读取“任务”中的指令清单并进行处理，计算机执行的过程中无须等待人工手工操作，这样性能就有了很大的提升。

批处理程序大大提升了处理性能，但有一个很明显的缺点：计算机一次只能执行一个任务，如果某个任务需要从I/O设备（例如磁带）读取大量的数据，在I/O操作的过程中，CPU其实是空闲的，而这个空闲时间本来是可以进行其他计算的。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/c0/95/6f0aad03.jpg" width="30px"><span>loveluckystar</span> 👍（116） 💬（8）<div>之前我们的系统是all-in的单系统模式，虽然水平扩展了大量机器，但是仍然存在性能问题，比如类似秒杀之类的活动，几乎会在瞬间把整个系统的数据库连接耗尽，导致其他服务发生卡顿甚至不可用；并且全在一个业务系统中，开发部属效率极低，扩展性也存在问题。

于是我们将系统进行了拆分，起初是按照业务拆分成几个核心系统，同时针对不同业务的负载情况进行了合理的水平扩展，整个系统的性能得到了提升，扩展性得到了保证，并且开发部署效率也得到了极大的提高。

但是随着业务的发展，之前的系统拆分不能满足现有业务，同时随着公司很多老员工的离开，之前的架构设计思路没有人清楚，于是就变成了走一步看一步的推进模式，衍生出了各种独立的服务达40个左右，这样系统之间的边界越来越模糊，甚至出现了服务间的循环调用，白白浪费时间。而且一次调用链路过长，发生问题很难定位。

所以我觉得我们的系统就是一个活生生的，没有搞好架构设计的例子，前期是没有设计导致性能瓶颈，后期是过度设计导致系统复杂。</div>2018-05-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/f5/81/92d01e3a.jpg" width="30px"><span>Sean</span> 👍（71） 💬（1）<div>架构无处不在，生活中也有很多例子。就比如去快餐厅去吃饭，涉及的任务就有打饭，选菜，付款，找座位。
普通的快餐厅，比如**缘，就是单线程，所有必须排队进行，最原始的系统架构。所以你会发现效率低，通常会拍队列，体验就不好。
而去**王吃饭，进去就有一个引导员(负载均衡)，提前帮你分配座位，发点餐单，而且有多个引导员同时工作(负载均衡集群)，而且各种菜系可以同时进行(并行)。另外一些需要等待的菜，会让你边吃边等(异步)。所以看上去人好多，很少有在排队的现象。可见，这位老板也是位不错的架构师。</div>2018-10-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/78/71/15d36122.jpg" width="30px"><span>pavel</span> 👍（71） 💬（2）<div>感谢老师回复。我们系统的量，每天学到存储大概有2T，采用mysql和hbase做存储。我们是做网站统计的，类似cnzz。每天接到的pv请求会到十亿次以上。我们使用集群接收，Kafka做消息队列，storm实时消费。统计结果存储在mysql，行为数据等存储在hbase。由于实时性要求以及量大，存储性能实在是一个瓶颈，主从同步滞后也相对严重，现在都已经去掉从库了。针对这种IO场景，而且实时性要求较高，R如何来应对呢？之前有个方案是mysql采取大量的分表分库，总共20台服务器，ssd硬盘，这样是能支持，但是成本还是挺大的，是否有更好的，或者我应该从哪方便去考虑呢？</div>2018-05-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/59/26/1015d573.jpg" width="30px"><span>gevin</span> 👍（55） 💬（7）<div>我这边很多项目都是面向传统行业国企的，他们成熟的传统方案都和IT无关，先现在要向IT靠拢。通常用户那边的业务量、并发量小，企业不差钱，所以一般都是通过硬件层面的垂直扩展来提高性能的。对我们的用户而言，一方面喜欢性能强悍的硬件设备，另一方面，当我们给他们写软件开发的报告时，什么样的技术方案火，就要在报告里体现出什么样的技术（比如现在给用户的方案都要和向微服务靠拢），面子上的工作要做足，也很有意思~</div>2018-05-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/36/2c/8bd4be3a.jpg" width="30px"><span>小喵喵</span> 👍（28） 💬（2）<div>李老师，当一个系统分为很多子系统时，每个子系统都有独立的数据库，如何保证数据的一致性呢？比如我有一个业务需要在A库插入一跳数据，在B库也要插入了一跳数据，然后在C库修改一条数据。假设中间那个库操作失败了，如何做到这个数据的一致性呢？</div>2018-05-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/25/2c/0a/61f4a0c3.jpg" width="30px"><span>汪彬英</span> 👍（19） 💬（1）<div>我目前是一家中型互联网公司技术部平台组leader。我们，目前的架构其实是更接近第二种。做了微服务拆分。它在一定程度上解决了单系统时期面临的各种问题。但是就像文中说的，我觉得我们的拆分力度没有把握的很好。也导致了近2年开始出现，特别是大促的时候，机器增加比例比请求增加的比例大很多。一个完整的调用流程，调用链非常长。核心原因是当时做微服务拆分的时候，完全是基于数据库做拆分的，比如，所有跟用户信息有关的东西拆分成用户系统，跟你订单有关的东西拆分成订单系统，跟渠道有关的东西拆分成渠道系统等等。这样拆分之后，一个在用户看起来应该很连贯的操作，我们内部却需要调很多系统。想问一下老师，基于这种现状，有没有比较好的建议呢？</div>2021-06-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d3/97/953a9f5a.jpg" width="30px"><span>清泉</span> 👍（19） 💬（3）<div>说说我的理解，不管是任务分配还是任务分解，都是通过分摊单台机器的流量来提高整个系统的处理性能。

对于任务分解，我认为不但没有性能上的收益，反而有性能上的损耗，本来可以在一个进程内部完成的交互，分解后却需要进行服务器间的网络交互。（分解前后业务逻辑不变的情况下）


不知道我这么理解对不对，但是与楼主说的任务分解一定程度上可以提高性能有些矛盾，求楼主指点迷津😊</div>2018-05-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/03/6a/c18d8e09.jpg" width="30px"><span>马亮</span> 👍（8） 💬（1）<div>单台服务器性能打八折，这个数字怎么来的呢？经验值还是测算值？比较好奇</div>2019-02-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0c/e1/e0ba4e87.jpg" width="30px"><span>卡莫拉内西</span> 👍（8） 💬（3）<div>我们公司做的政府项目，没有高并发的场景，业务大多也是crud，高可用是有的，高扩展的场景较少，需求基本上是产品经理整理好的，一台ng，两台应用服务器，一主两从mysql，nas设备，redis都可以不用，请问这样业务场景的公司是否适合长期呆下去，还是说可以为了架构而架构，公司本身不差钱，给政府做项目几乎也是友情价，老板在乎的可能是数据</div>2018-05-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/7c/71/322a97f9.jpg" width="30px"><span>新人小胖</span> 👍（8） 💬（3）<div>我们现在的系统是一个消息处理系统，主要的瓶颈在于消息的处理是必须要是顺序的，不能乱序，所以subscribe消息是单线程的，目前需要解决这个问题。</div>2018-05-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/55/08/f98b2a33.jpg" width="30px"><span>Colin</span> 👍（7） 💬（1）<div>之前拆分过WMS系统，按业务划分，商品信息管理，收货模块，发货模块，仓内操作模块等等，项目更清晰，性能扩展方便，性能更好</div>2018-05-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f5/2f/56117bab.jpg" width="30px"><span>张玮(大圣)</span> 👍（6） 💬（1）<div>1. 读了所有的评论，其实随着这几年微服务架构思想的就行，很多时候一些架构设计同学都会选择一步到位把系统按照业务做拆分，当然这里有粒度的把控，过粗过细都会导致问题，这里可以理解为任务分配+任务分解思想的运用

2. 性能优化点思路总结起来还是两步走:先单机后集群，如多线程、协程等编程模型的使用，缓存的使用，最终都是为了更快完成一次请求服务

3. 运华兄，点赞，加油，希望突破千万订阅者！</div>2018-05-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/53/3d/1189e48a.jpg" width="30px"><span>微思</span> 👍（5） 💬（1）<div>李老师，文章写得很棒，受益匪浅！但有一点疑惑的地方，通篇读完似乎没有看到具体的对高性能的定义，到底什么是高性能？高性能可以具体由哪些指标来衡量？是否遗漏了，还是说已经包含在行文里了，需要读者提炼？</div>2018-05-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/14/5d/d44e3cff.jpg" width="30px"><span>TLC</span> 👍（3） 💬（1）<div>谈一谈：我们刚开始就是单体架构war，提升性能主要通过应用程如JVM优化，tomcat优化，应用架构优化，硬件提升数据库CPU内存，服务器高性能硬盘等。后来请求上来了，部署了多台集群，同时提供了nginx转发请求，数据库也由单台变为主从架构</div>2020-09-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ee/c6/bebcbcf0.jpg" width="30px"><span>俯瞰风景.</span> 👍（3） 💬（1）<div>任务分配是所有的功能都可以在一台业务服务器上完成，业务模块之间可以在一台服务器上相互调用。
而任务分解是把功能逻辑拆分到不同的业务服务器上了，业务模块之间的相互调用要通过网络。
业务越来越复杂，单台机器处理的性能会越来越低是由于一个进程会占用更多资源么？
可以这样理解么？
——任务分解是在业务复杂之后，代码耦合度很高，为了优化代码逻辑，实现更高效的单独处理某一业务需求的模块。</div>2018-11-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0f/33/bff127ef.jpg" width="30px"><span>wkplus</span> 👍（3） 💬（1）<div>介绍线程的时候，只是提到因为单进程内部也需要并行，所以需要多线程，感觉还不够充分。比如文中餐饮管理进程的例子，排位、点餐需要并行，也可以引入多进程来实现。为什么需要线程，我觉得还是要提及多线程和多进程效率对比，比如线程&#47;进程创建的开销，多线程&#47;进程相互通信的开销等。</div>2018-05-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/43/e1/b7be5560.jpg" width="30px"><span>sam</span> 👍（3） 💬（1）<div>工作中主要偏重前端开发，对老师讲的这些虽然理解(收获也很大)，但工作经验中并没有实践过，希望老师能推荐一些基础的实例的上手项目供我们这些初级菜鸟练习的机会。</div>2018-05-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/2e/fb/96cfe162.jpg" width="30px"><span>张琦</span> 👍（2） 💬（1）<div>我发现不少大神在评论区，越厉害越学习，我要努力了。</div>2019-08-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/8f/b1/7b697ed4.jpg" width="30px"><span>晓晨同学</span> 👍（2） 💬（1）<div>提高系统高性能的方式，第一种是通过物理手段提高硬件的性能，另外一种是水平的拓展，我理解也分为两种，集群和分布式，集群自不必说，分布式就是将一个复杂的业务进行更细致的拆解</div>2019-02-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/c6/51/30c17473.jpg" width="30px"><span>aaaaaaaaaaaas</span> 👍（2） 💬（1）<div>高性能会给系统带来复杂度，而架构就是来解决这些复杂度。任务分配会有机器的瓶颈，微服务会有服务数量的瓶颈，每一种解决方式都有一个度，控制好合理使用任务分配+任务分解</div>2018-09-18</li><br/><li><img src="" width="30px"><span>huangshuihua</span> 👍（2） 💬（1）<div>果然大神。这个梳理和总结气到了醍醐灌顶的作用！</div>2018-05-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e8/18/1c05a082.jpg" width="30px"><span>smiledou123</span> 👍（2） 💬（1）<div>谢谢老师，149ms问题已经明白，不过对于您在文章中提到的一些计算机原理知识我并不是太懂，能请您为像我一样的初级运维推荐一些需要看的计算机书籍吗？</div>2018-05-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/77/eb/205ff49c.jpg" width="30px"><span>淡彩</span> 👍（2） 💬（1）<div>目前的业务系统主要是将用户界面、服务、数据库分层，除数据库外其他两层的服务都走LB用HAProxy。因为业务量不大，所以性能瓶颈暂时还不存在，不过服务层没有做到完全无状态化，有一些坑。本节内容主旨业务划分，节点扩张，后面应该慢慢就走向SOA，microservice了</div>2018-05-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg" width="30px"><span>escray</span> 👍（1） 💬（1）<div>开辟新领域的技术，增加了选择或组合的可能，给软件系统带来复杂度。

高性能可以带来良好的用户体验（快），满足业务增长的需要（Google、淘宝、微信）。

操作系统似乎已经帮助人们（开发和用户）屏蔽的很多复杂性。

当单机性能无法支撑业务复杂度时，就要采用集群的方式，从任务分配到任务分解，尽可能提高整体性能。

现在比较流行的微服务有点类似于任务分解？</div>2020-09-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/5f/aa/63e641c1.jpg" width="30px"><span>H</span> 👍（1） 💬（1）<div>很想问一下作者关于qps的理解：
其实，关于qps是指一天的评论值，还是指某一刻的最大值。比如：我负责的项目是700K&#47;小时，qps是直接等于700000除以3600吗？还是qps等于全天的访问量，再除以86400？
网上很多文章都参差不齐的，很难明白qps的真正含义。往作者指导，感谢</div>2020-05-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/20/80/55e93141.jpg" width="30px"><span>拾光漫步</span> 👍（1） 💬（1）<div>“任务分配器”也并不一定只能是物理上存在的机器或者一个独立运行的程序，也可以是嵌入在其他程序中的算法，例如 Memcache 的集群架构。
这个就不存在任务分配器的瓶颈了 因为 是由客户端计算的 </div>2019-11-08</li><br/><li><img src="" width="30px"><span>Geek_88604f</span> 👍（1） 💬（2）<div>关于高性能大家主要讨论了单机优化和堆机器来达到很高的TPS。我们这里的高性能还有另外一个核心诉求——低时延，每个请求必须在很短的时间内返回结果，否则就会被其它系统忽略（我们的系统是更大系统的一部分，和给我们分配的时间是固定的）。当系统收到请术求后会触发数据库执行存储过程，问题是存储过程会随着业务的发现逐渐增多，有些存储过程之间还相互依赖，这意味着计算时延会越来越高，一段时间后就无反法满足整个系统的要求了，然后就是痛苦的局部计算优化，如此往复。能不能从架构上彻底解决这个问题，李老师？</div>2019-07-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ca/ff/ca3df848.jpg" width="30px"><span>朱伟</span> 👍（1） 💬（1）<div>关于微信的架构，是实战经验总结还是自己推算？感觉不太对啊</div>2018-05-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e6/e1/f44cdfaf.jpg" width="30px"><span>J</span> 👍（1） 💬（1）<div>之前的公司用的是任务分解，现在的公司用的是任务分配，请教一下 ，文中的任务分解无需任务分配器么？比如ng?</div>2018-05-15</li><br/><li><img src="" width="30px"><span>闭嘴</span> 👍（1） 💬（1）<div>看完大神写的这篇文章，感觉主要是针对互联网的系统的架构，传统的企业级的架构思路难道也是要学习互联网的这种架构方式?</div>2018-05-05</li><br/>
</ul>