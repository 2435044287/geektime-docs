今天，我们聊聊复杂度的第二个来源高可用。

参考维基百科，先来看看高可用的定义。

> 系统无中断地执行其功能的能力，代表系统的可用性程度，是进行系统设计时的准则之一。

这个定义的关键在于“**无中断**”，但恰好难点也在“无中断”上面，因为无论是单个硬件还是单个软件，都不可能做到无中断，硬件会出故障，软件会有bug；硬件会逐渐老化，软件会越来越复杂和庞大……

除了硬件和软件本质上无法做到“无中断”，外部环境导致的不可用更加不可避免、不受控制。例如，断电、水灾、地震，这些事故或者灾难也会导致系统不可用，而且影响程度更加严重，更加难以预测和规避。

所以，系统的高可用方案五花八门，但万变不离其宗，本质上都是通过“**冗余**”来实现高可用。通俗点来讲，就是一台机器不够就两台，两台不够就四台；一个机房可能断电，那就部署两个机房；一条通道可能故障，那就用两条，两条不够那就用三条（移动、电信、联通一起上）。高可用的“冗余”解决方案，单纯从形式上来看，和之前讲的高性能是一样的，都是通过增加更多机器来达到目的，但其实本质上是有根本区别的：**高性能增加机器目的在于“扩展”处理性能；高可用增加机器目的在于“冗余”处理单元**。

通过冗余增强了可用性，但同时也带来了复杂性，我会根据不同的应用场景逐一分析。

## 计算高可用

这里的“计算”指的是业务的逻辑处理。计算有一个特点就是**无论在哪台机器上进行计算，同样的算法和输入数据，产出的结果都是一样的**，所以将计算从一台机器迁移到另外一台机器，对业务并没有什么影响。既然如此，计算高可用的复杂度体现在哪里呢？我以最简单的单机变双机为例进行分析。先来看一个单机变双机的简单架构示意图。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/73/48/ced94e09.jpg" width="30px"><span>小超在努力</span> 👍（115） 💬（7）<div>古人有言：先解决有无，再解决优化。所以可用更难，性能次之，找对象同理。</div>2018-08-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/eb/91/12612612.jpg" width="30px"><span>彡工鸟</span> 👍（92） 💬（5）<div>这么多回复里，没有人提到高可用和高性能的量化指标，没有这个指标前提下，无法断定哪个更复杂吧。打个比方，高可用两条99就行了，你觉得会复杂，会难么？高性能要求你在并发百万，千万级调用十几个服务前提下，仍能保持10多毫秒，你觉得简单？复杂与否还是要指标。另外，很多人都关注应用节点和硬件节点高可用，却忽略了业务高可用这个视角，系统全挂了，你人工接入业务，在后台帮用户开通，办理，对业务来说也是高可用吧。以上个人看法</div>2018-05-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d9/22/047fbc47.jpg" width="30px"><span>bieber</span> 👍（77） 💬（2）<div>高可用的解决方法不是解决，而是减少或者规避，而规避某个问题的时候，一般都会引发另一个问题，只是这个问题比之前的小，高可用的设计过程其实也是一个取舍的过程。这也就是为什么系统可用性永远只是说几个九，永远缺少那个一。
而高性能，这个基本上就是定义计算能力，可以通过架构的优化，算法的改进，硬件的升级都可以得到很好的解决，从而达到我们心里对性能的预期…</div>2018-05-25</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIyhbzdkFM64HvRATbWjc3hkic7icUszl9hU9hpIMZcibKH4wWam4SHfkcvM7MUoKjGDRrvYGXuvR91Q/132" width="30px"><span>性能</span> 👍（38） 💬（4）<div>老师，银行账务类强一致性业务，适用最终一致性方案吗？我们通常要求既要实时看到账务操作结果，又要提供高性能，最终只能用依赖于数据库实现一致性，但性能压力很大</div>2018-05-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/8f/b1/7b697ed4.jpg" width="30px"><span>晓晨同学</span> 👍（35） 💬（4）<div>核心思想：网站高可用的主要技术手段是服务与数据的冗余备份与失效转移。同一服务组件部署在多台服务器上；数据存储在多台服务器上互相备份。通过上述技术手段，当任何一台服务器宕机或出现各种不可预期的问题时，就将相应的服务切换到其他可用的服务器上，不影响系统的整体可用性，也不会导致数据丢失。

从架构角度看可用性：当前网站系统多采用经典的分层模型，从上到下为：应用层、服务层与数据层。应用层主要实现业务逻辑处理；服务层提供可复用的服务；数据层负责数据读写；在部署架构上常采用应用和数据分离部署，应用会部署到不同服务器上，这些服务器被称为应用层的服务器；这些可复用的服务也会各自部署在不同服务器上，称为服务层的服务器；而各类数据库系统、文件柜等数据则部署在数据层的服务器。

硬件故障方面引起不可用的技术解决措施：(1)应用服务器。可通过负载均衡设备将多个应用服务器构建为集群对外提供服务（前提是这些服务需要设计为无状态，即应用服务器不保存业务的上下文信息，而仅根据每次请求提交的数据进行业务逻辑的操作响应），当均衡设备通过心跳检测手段检测到应用服务器不可用时，则将其从集群中移除，并将请求切换到其他可用的应用服务上。(2)服务层服务器。这些服务器被应用层通过分布式服务框架（如Dubbo）访问，分布式服务框架可在应用层客户端程序中实现软件负载均衡，并通过服务注册中心提供服务的服务器进行心跳检测，当发现有服务器不可用时，立即通知客户端程序修改服务列表，同时移除响应的服务器。(3)数据服务器。需要在数据写入时进行数据同步复制，将数据写入多台服务器上，实现数据冗余备份；当数据服务器宕机时，应用程序将访问切换到有备份数据的服务器上。
</div>2019-02-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6a/d5/73c75eb3.jpg" width="30px"><span>夜行观星</span> 👍（31） 💬（2）<div>就我一个人注意到ZK的选举算法不是Paxos吗？虽然不是本文重点😂</div>2018-05-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/3d/35/ab80a720.jpg" width="30px"><span>A李文</span> 👍（24） 💬（5）<div>冷备、温备、热备的具体区别是</div>2020-03-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/45/c9/a4f7054f.jpg" width="30px"><span>佳</span> 👍（16） 💬（1）<div>高性能虽然复杂，但是只要通过合理的集群方案还是可以解决业务的性能需求，但是高可用也只能做到相对高可用，绝对高可用是不存在的，总会有诸多突发外界因素进行干扰，高性能的实现是受人为控制的，只要是在人的控制范围内，那问题都不是问题，但是要做到高可用，很多事情都不是人能控制的，比如天灾人祸</div>2018-10-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cf/bb/22af0e52.jpg" width="30px"><span>孙振超</span> 👍（13） 💬（2）<div>相对而言还是高可用更难些，按照作者说的高性能其实就是容量，在负载均衡系统高可用的情况下加机器就可以了，而想做到各个环节的高可用不是靠加机器就能搞定的，通常需要复杂的算法、引入更多的中间件、牺牲一定的性能才能实现，这其中还要进行各种权衡取舍裁剪才可以</div>2018-05-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ac/a1/43d83698.jpg" width="30px"><span>云学</span> 👍（11） 💬（1）<div>有些人把高可用与高可靠混淆了，高可用是不要中断服务，高可靠是数据不丢失。</div>2018-05-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/a9/b8/d7182af2.jpg" width="30px"><span>Geek_d8f635</span> 👍（11） 💬（2）<div>区块链技术如果越来越成熟，是不是对高性能有很大帮助？</div>2018-05-09</li><br/><li><img src="" width="30px"><span>Geek_88604f</span> 👍（10） 💬（3）<div>本质上高可用更难。到目前为止业界还没有办法明确度量到底能达到几个9。你交付给我一个系统，你可以说达到了3个9或4个9，我怎么能相信你呢？反之性能指标是可以很快就能实测出来的。
        一般地讲，高可用和高性能就像列车的两条轨道共同进退。一方面为了实现数据库的高可用需要部署主从模式或一主多从模式，但是这样会影响数据库的读写性能；另一方面为了实现高性能，对业务服务器进行扩容，大规模的集群有上千台服务器，几乎每天都会出现各种类型的故障，这就影响到了系统的高可用。</div>2019-07-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/e3/19/7eba0a69.jpg" width="30px"><span>邱荣财</span> 👍（6） 💬（1）<div>高性能路线，拆拆拆，拆系统，拆服务，拆微服务，拆函数服务，拆任务，拆进程，拆线程，任务调度，加机器。
高可用路线，合合合，多条链接合起来作为一个线路，主备合起来作为一个系统，主从合起来作为一个系统，多份数据合起来作为一份数据，状态决策，CAP</div>2020-10-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4d/fe/882eaf0f.jpg" width="30px"><span>威</span> 👍（5） 💬（2）<div>老师你好，高性能和高可用有明确的界限吗，感觉有时候是混着用的。例如现实中我们会使用扩展处理单元的形式来提高性能，但是同时也提高了系统的可用性。比如为了不出现单点，我们会把业务系统双机部署，同时提供无状态服务，上游通过nginx来分流，既提高了性能，也能在某台机down掉时，另一个节点也能提高服务，从而达到高可用目的</div>2019-03-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/14/a3/0782e181.jpg" width="30px"><span>Joker</span> 👍（5） 💬（1）<div>高性能是为了达到一个量化的目标，通常我们会有各种不同的办法去实现，抛开消耗来说，方法有很多种，就像上篇讲到的，粗暴加机器，优雅划分等;但是高可用是为了规避一个非量化的抽象bug场景集合，这些不都是能提前预测到的，所以高可用一般来说都会比高性能复杂！</div>2018-05-25</li><br/><li><img src="" width="30px"><span>dbo</span> 👍（5） 💬（1）<div>CAP理论的作者已经重新解释了很多人对CAP的误解，C A P 三者并不是互斥关系只能选其二，而是在出现网络分区时，可以选择0.9 + 0.9 + 0.7之类的措施，在三者间进行平衡取舍。</div>2018-05-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/01/1b/24db90c7.jpg" width="30px"><span>Cola</span> 👍（4） 💬（1）<div>对于普通公司来说，高可用远比高性能复杂的多。现代软件系统由于硬件设备性能大幅提升与一系列成熟稳定的云服务&#47;解决方案，要达到用户层面的高性能其实不难，甚至通过单纯的砸钱于设备质量与数量也能达到普义上的高性能。但是高可用却要考虑一系列负载均衡，多进程集群(无状态设计)，服务治理(熔断设计，失效转移，快速恢复)，监控(状态报警，自动扩展，黑名单)，缓存与存储(数据的一致性，脏数据的处理，冷热备份)，这是一个庞大的技术栈。但是当用户量级达到另一个层面，高性能难度也成指数性增长，这时候这两个命题你中有我我中有你，两者是密不可分的。</div>2018-06-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/1a/74/8f7f8786.jpg" width="30px"><span>GLADIATOR</span> 👍（3） 💬（3）<div>民主虽然可能造成效率问题，但政治风险较小。独裁寄托于单点皇帝，容易形成单点故障，万一碰到一个开倒车的，就是灾难啊</div>2020-11-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/dd/cb/23b114a7.jpg" width="30px"><span>xiao皮孩。。</span> 👍（3） 💬（1）<div>让我明白了脑裂这个词。

高性能三板斧:加机器，缓存，异步
高可用:集群，set化
请大神补充</div>2019-03-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7a/e9/da5c0203.jpg" width="30px"><span>亚伦碎语</span> 👍（3） 💬（1）<div>状态是分布式系统的噩梦，然而一个系统又不可能没有状态</div>2018-05-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ca/cc/97fd68ec.jpg" width="30px"><span>高歌在羊城</span> 👍（3） 💬（1）<div>大神，希望后面多一些落地的案例分析，章节篇幅可以长一点，一次讲一个要点都行😁</div>2018-05-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c4/c9/90c8a53e.jpg" width="30px"><span>missa</span> 👍（2） 💬（1）<div>高性能，高可用。
高可用会比较复杂，性能这块随意现在硬件的发展，成本越来越低价了。大多数公司也不会专门的对机器进行性能的调优。
高可用需要考虑的存储高可用，和状态高可用就比较复杂多样的场景了。</div>2018-05-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/22/e0/8e58a7e1.jpg" width="30px"><span>小思绪</span> 👍（2） 💬（1）<div>协商式中的双主也是脑裂吧？</div>2018-05-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/05/26/05aeb46c.jpg" width="30px"><span>fxp</span> 👍（2） 💬（1）<div>解决高性能问题的必经之路就是高可用。</div>2018-05-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/7f/1a/eb8021c3.jpg" width="30px"><span>追寻云的痕迹</span> 👍（2） 💬（1）<div>化繁为简，通过简单的举例，就把核心概念说说清楚了。架构师的作用就在于各种场景中做出合适的取舍，而不是像普通程序员那样陷入Paxos还是Raft好的争论中。PowerShell之父Jeffery Snover有一句话叫，To ship is to choose，讲的就是取舍的问题。</div>2018-05-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/63/c6/0167415c.jpg" width="30px"><span>林肯</span> 👍（1） 💬（1）<div>高可用解决方案：冗余；
计算高可用：冗余多台机器，机器都是无状态的；
存储高可用：难点不在冗余，而在于平衡高可用和一致性；CAP理论
广义的讲：高可用不仅仅是冗余；关键时刻部分业务做降级也是可选项。
阿里三板斧：可灰度、可监控、可降级；都是保证高可用的手段</div>2022-04-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/bb/56/05459f43.jpg" width="30px"><span>Geek_h6mwnx</span> 👍（1） 💬（1）<div>我认为高可用与高性能，它们的复杂度都会根据相应的指标与业务场景发生变化，是两条函数曲线。高性能复杂度起点较低，随着业务复杂度提升增长较快；而高可用的复杂度起点较高，随着业务复杂度提升增长较慢。两条曲线会有一个相交点。</div>2021-03-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/64/9b/d1ab239e.jpg" width="30px"><span>J.Smile</span> 👍（1） 💬（1）<div>这个世界本身就不是永恒不变的，而高可用却追求永久恒定。显然有违天道人伦，理想很丰满，现实很骨感。高可用如何高呢？我觉得就是能对用户的最终目标负责，那就是高可用，只不过是体验的好坏不同罢了，所以高可用归根结底可以说是高体验。---个人观点。</div>2020-12-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/21/78/732a2e33.jpg" width="30px"><span>M1racle</span> 👍（1） 💬（1）<div>我觉得高可用更复杂，高性能起码是正向解决问题，高可用绝对是各种妥协思量的选择，一不小心就是坑</div>2020-06-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e4/3b/9c3afa01.jpg" width="30px"><span>wesley</span> 👍（1） 💬（1）<div>高可用更多的是如何去预防，比如在做容量规划是留些预留，通过冗余来提升可用性。通过监控数据来持续优化可用。</div>2020-06-15</li><br/>
</ul>