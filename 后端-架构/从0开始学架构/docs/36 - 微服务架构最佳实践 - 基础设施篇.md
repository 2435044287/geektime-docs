每项微服务基础设施都是一个平台、一个系统、一个解决方案，如果要自己实现，其过程和做业务系统类似，都需要经过需求分析、架构设计、开发、测试、部署上线等步骤，专栏里我来简单介绍一下每个基础设施的主要作用，更多详细设计你可以参考Spring Cloud的相关资料（[https://projects.spring.io/spring-cloud/](https://projects.spring.io/spring-cloud/)）。

下面进入今天的内容，微服务架构最佳实践的基础设施篇。

## 自动化测试

微服务将原本大一统的系统拆分为多个独立运行的“微”服务，微服务之间的接口数量大大增加，并且微服务提倡快速交付，版本周期短，版本更新频繁。如果每次更新都靠人工回归整个系统，则工作量大，效率低下，达不到“快速交付”的目的，因此必须通过自动化测试系统来完成绝大部分测试回归的工作。

自动化测试涵盖的范围包括代码级的单元测试、单个系统级的集成测试、系统间的接口测试，理想情况是每类测试都自动化。如果因为团队规模和人力的原因无法全面覆盖，至少要做到接口测试自动化。

## 自动化部署

相比大一统的系统，微服务需要部署的节点增加了几倍甚至十几倍，微服务部署的频率也会大幅提升（例如，我们的业务系统70%的工作日都有部署操作），综合计算下来，微服务部署的次数是大一统系统部署次数的几十倍。这么大量的部署操作，如果继续采用人工手工处理，需要投入大量的人力，且容易出错，因此需要自动化部署的系统来完成部署操作。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/cf/bb/22af0e52.jpg" width="30px"><span>孙振超</span> 👍（241） 💬（10）<div>文章中一共列了11个部分，但只有10个人，很明显是不可能是同时开工的，即使能够同时开工也是需要经过几轮迭代才能达到一个比较完善的状态。

依据简单原则和演化原则以及“三个火枪手”的人员分配原则，首先可以做API 网关、配置中心、服务发现、服务路由这4部分，经过一个月的开发+半个月的联调的先让基础框架搭建起来，业务能够运行起来。
业务上线后，为了保证用户体验和问题跟踪，在保留一两个留守同学的情况下，开始服务容错、服务监控、服务跟踪这几部分的开发，因为这个阶段中可能还要回头修改已完成的部分让这几个部分配合的更好，联调的工作量也多了不少，这个过程大概要2.5月。
而后随着业务逐渐增多，流量逐渐增加，为避免被黑产“薅羊毛”需要把服务安全部分给完成，同时为了快速响应新的业务需要把接口框架给完成，但此时有些同学会被已完成部分的日常维护、修bug等，这些初步需要两个月时间。
在这里都完成后，可以开始自动化测试、自动化部署这部分，也按照两个月的时间，这样一轮下来总体需要8个月时间。

经过第一轮后微服务的基础实施是有了，但要真正的运作起来还需要经过几轮的迭代才可以，但此时面对老系统的维护新系统的开发整体的进度会变慢不少，这样一个合格的比较完善的微服务基础设施差不多要两年时间了。</div>2018-09-18</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJcvQzf86HsxOkPcRpibBdCxDW0IK9wel9TmkEhicHPUHPRhzKna8wecDcJcVbNHNSrUMt4GHLxY3iaA/132" width="30px"><span>Coder4</span> 👍（62） 💬（1）<div>看怎么定义自研了，今年花了1个月，每天半小时代码。半开源，半代码，已经实现了 服务发现，追踪，自动部署，以及后端服务数据库，消息队列，缓存，内存数据库的对接，
真正熟悉了，花不了太多时间，另外得合理利用轮子。</div>2018-07-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7b/e8/9402d347.jpg" width="30px"><span>无痕</span> 👍（21） 💬（5）<div>老师，很多人把oauth2的鉴权放到了网关，这个你怎么看</div>2018-07-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8d/44/f3d0017c.jpg" width="30px"><span>程启</span> 👍（18） 💬（1）<div>华仔老师，

之前看您留言提到过service mesh不成熟，中小公司不建议使用。请问看起来最近gcp云平台，主推的k8s加上Istio&#47;envoy实现服务治理，您认为未来方向如何，这个是试用中小型团队的方案吗？感谢解答！</div>2018-08-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f8/23/165d2f0e.jpg" width="30px"><span>成功</span> 👍（13） 💬（3）<div>30天左右</div>2018-07-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a0/b3/abb7bfe3.jpg" width="30px"><span>每天学英语的小沈</span> 👍（9） 💬（1）<div>微服务这两章讲的非常好，解决了长久以来的困惑</div>2019-01-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/54/eb/1b981a56.jpg" width="30px"><span>水云波</span> 👍（5） 💬（2）<div>老师，你说API网关的主要包括接入鉴权、权限控制，然后在留言中又说不应该把oauth2的鉴权放到网关。我觉得前后矛盾了，是我对鉴权和权限控制哪里理解的还不到位吗？</div>2019-06-11</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI8mFt5wSkia31qc8paRg2uPSB6AuEBDricrSxvFBuTpP3NnnflekpJ7wqvN0nRrJyu7zVbzd7Lwjxw/132" width="30px"><span>Geek_steven_wang</span> 👍（4） 💬（1）<div>华哥，你好！请问：服务间的安全策略通过配置中心下发给各节点，一般采用那些安全策略？我了解到的有黑白名单（根据服务名、IP），这个方案比较容易伪造（服务名和IP），还有其它策略吗？</div>2020-01-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/a8/1b/ced1d171.jpg" width="30px"><span>空档滑行</span> 👍（4） 💬（1）<div>工作量需要看这一套框架要应对的服务规模和流量。以100个微服务，接口平均qps100以下做了简单测算，不考虑同城和异地多活，达到基本可用的话
配置中心，包括配置项管理和推送，和微服务一起打包的客户端
接口框架，使用http和Json的话，只需要一种语言的解析包
Api网关，后端服务对接和接入层实现
服务发现，使用自理式，注册中心服务端加客户端，加注册中心高可用
服务路由，相对简单
服务容错，包括熔断和流控等
服务监控，包括采集和分析
跟踪，各端trace注入，数据上传，数据查询和计算
安全，权限控制，配置支持
按10个高级开发，3人一组的话，大概半年左右</div>2018-07-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/25/33/290fcb42.jpg" width="30px"><span>依乐祝</span> 👍（3） 💬（1）<div>看了这么久第一次留言，老师你好，刚看你说网关层不建议做鉴权！但是如果这样的话，那内部微服务之间如何进行通信呢？我的理解是网关做与url有关的权限处理！而具体的业务服务里面做与数据相关的权限鉴别！这样职业分开！然后内部进行通信的话就可以采用rpc进行高效的交互，而且都是可信的！不知道我的理解是否有误，还请老师指正下哈</div>2019-01-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/2e/b5/5f1c7ae1.jpg" width="30px"><span>AmosWooo</span> 👍（3） 💬（1）<div>李老师，请教个问题: API网关提供认证授权功能，那请求穿透API网关这一层之后，后续的业务流程依然会涉及在多个子服务之间交互，此时如何授权呢?难道需要反向去API网关查询吗? 谢谢回答</div>2018-10-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e0/9f/9259a6b9.jpg" width="30px"><span>Kyle</span> 👍（3） 💬（1）<div>Dubbo弄了这么久，配套的基础设施都还没有。高级的水平也有高有低。总觉得怎么也要个一年半载吧。</div>2018-07-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/b9/32/84346d4a.jpg" width="30px"><span>雪碧心拔凉</span> 👍（2） 💬（1）<div>服务安全的实现能详细讲讲吗  或者哪里有文档参考</div>2021-11-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/9a/a6/3bddb98c.jpg" width="30px"><span>大叶枫</span> 👍（2） 💬（1）<div>API网关：外部系统访问接口和协议、包含接入鉴权、权限控制、传输加密、请求路由、路由控制。
配置中心：包含配置版本管理、增删改查配置、节点管理、配置同步、配置推送。
服务发现：自动化注册和发现服务，提升节点自动化运维能力。
服务路由：一般集成到服务发现里实现路由算法，常见的有随机路由、轮训路由、最小压力路由、最小连接数路由。
服务容错：包括请求重试、流控和服务隔离，一般服务容错会集成到服务发现和服务路由系统中。
服务监控：宏观实时采集信息并分析，故障预警能力，一般作为独立系统建设。
服务跟踪：微观实时采集记录服务调用的链路信息，记录完整的服务链路路径，后置定位使用。
服务安全：分接入、数据、传输三个部分，一般集成到配置中心实现安全策略。
自动化测试：代码级单元测试、单系统级集成测试、系统间的接口测试等自动化测试。
自动化部署：包含微服务版本管理、资源管理（机器、虚拟机）、部署操作、回退操作等功能

故建设优先级，先做业务运行的基础建设、后做业务运行的体验建设、再做业务可持续维护的建设分三个阶段。
业务运行的基础建设（2个月）：完成配置中心、服务发现和路由建设，投入兵力6个人，相互主备，剩余四个人做API网关在细分投入。
业务运行的体验建设（4个月）：服务容错（2人）、监控（2人）、跟踪（2人）、安全（1人），除了监控外，其他三者集成到已建设的服务发现（1人）。维护老系统（1~2人）
业务可持续维护建设（6个月）：自动化测试、自动化部署。以DevOps相关的配套工具围绕测试和部署体系建设。已建设的8块内容投入4个人做维护运转，增量业务支持投入2人。剩余4人做自动化测试和部署。

大概我会这么安排。。

</div>2021-08-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/20/2d/dfa5bec8.jpg" width="30px"><span>Han</span> 👍（2） 💬（2）<div>您说的自研微服务基础设施，该不会是自己从零开始造全部轮子吧？ 不太符合现实，也没几家公司会这样操作吧？ 有这么多现成的微服务框架工具，大多数人都是直接拿来用。🌝</div>2020-07-18</li><br/><li><img src="" width="30px"><span>mayer</span> 👍（2） 💬（1）<div>这10个人分别有相关经验的话，不考虑复杂的业务逻辑实现调试，整个框架搭起来可应用，应该在3个月左右可以完成，条件是高级工程师真的高级，哈哈😄</div>2018-07-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2e/27/b4/df65c0f7.jpg" width="30px"><span>| ~浑蛋~</span> 👍（1） 💬（1）<div>我所在的小组就是做这些基础设施，主力是三个高级工程师加上我这个菜鸟，已经做了两年，API网关，服务发现，配置中心，接口框架基本稳定了，现在集中精力在服务监控和链路追踪这一块。自动化部署是专门负责devops的小组做。</div>2022-06-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/f7/b2/b9d2d7d8.jpg" width="30px"><span>只因</span> 👍（1） 💬（1）<div>服务发现还有这种ServiceMesh</div>2021-08-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/b5/3c/967d7291.jpg" width="30px"><span>艺超(鲁鸣)</span> 👍（1） 💬（1）<div>一直有一个疑问，就是对于web页面的某个功能，可能同时需要几个微服务一起完成，为了避免网络传输，会合为一个接口；目前看有两个方案，1：由其中一个微服务统一完成，然后注册到网关给web使用；2：由网关负责完成，也就是类似BFF这种吧，老师有什么好的建议吗？</div>2020-11-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/7a/87/668a4f38.jpg" width="30px"><span>草上飞蝶号🙈</span> 👍（1） 💬（1）<div>我们将原有系统从传统架构调整为为服务，基本按照spring boot全家桶来搞，拆分成了接近20个微服务，做的过程中微服务尤其表的划分以及互相之间调用，十分头疼。涉及代码100万。整个开发加测试耗时10个月，人员100人左右。</div>2020-03-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/1b/70/547042ee.jpg" width="30px"><span>谭方敏</span> 👍（1） 💬（2）<div>自动化测试（代码级单元测试，单个系统级系统测试，接口间接口测试）
自动化部署（版本管理，资源管理（机器管理，虚拟机管理），部署操作，回退操作）
配置中心（配置版本管理，节点管理，配置同步，配置推送，增删查改操作）
服务监控(宏观，考察请求次数，响应平均时间，响应最高值，减少故障处理时间，针对故障提前预警)
服务跟踪（微观，某次请求的发起请求记录，响应时间，响应错误码，请求参数等）
服务安全（接入安全，数据安全，传输安全）
接口框架（对外用http&#47;json方式，对内用rpc方式）
api网关（唯一提供外部访问的，接入鉴权（是否接入），权限控制（是否能访问），流量控制，请求路由，传输加密）
服务发现（自主式（每个微服务之间自己完成服务发现），代理式（每个微服务之间借助负载均衡系统完成服务发现））
服务路由（随机，轮询，最小压力，最小连接）
服务容错（请求重试，流式和服务隔离）

根据简单和演化原则，自研项目可以从最简单的开始，比如从服务发现，服务路由，服务容错，以及接口框架和api网关出发，等迭代完毕后再跟进自动化测试，自动化部署，配置中心，服务监控，服务跟踪，服务安全，按照逐步迭代，不断演化的思路。至于预测时间，真不好预测，之前做一个基于旧业务的新框架翻新，前前后后花了半年多才出雏形，后面再花半年才稳定下来。还不包括踩坑什么的。</div>2020-03-12</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqsFicCU21tKou4mFvfy5fOn9sfNYHNDfna8eozeVOLGs58gcAu8v2IIVFRsM6R8DIuWSVAjzubh8A/132" width="30px"><span>郑佳宁</span> 👍（1） 💬（1）<div>基础设施为啥要自研呢？有没有现成的成熟框架？如果有，不知道后面作者会不会有对比分析？</div>2019-06-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d5/3f/80bf4841.jpg" width="30px"><span>文竹</span> 👍（1） 💬（1）<div>自动化测试：主要支持接口测试，可以使用robot framework，无需额外人天。

自动化部署：使用开源jenkins进行构建，无需人天。

配置中心：需要支持的功能有服务节点管理，节点配置管理，配置版本管理，配置变更通知。
实现这些功能估计需要30人天。

接口框架：采用HTTP Rest Json形式，需要指定规范的json格式，目前Json解析能很好地支持于各语言，所以无需提供客户端库。由于主要工作在于规范化，估计需7人天。

API网关：可以使用开源的API网关，比如Kong。Kong也支持插件化扩展功能。这里估计需7人天。

服务发现、路由、容错：要实现这三个功能，还要实现服务注册中心。估计60人天。

服务监控：收集信息并分析，由于数据量比较多，估计需要30人天。

服务跟踪：是服务监控的升级版，特点也是数据量大，估计需要30人天。

服务安全：这里需要做一个通用的认证授权方案。估计需要30人天。

综合以上，似乎一个人半年左右就能完成初版。10个人同时进行的话，估计一个月左右。总觉得估计的时间比较紧，如果根据更细腻度的功能划分的话，可能在2个月左右。</div>2018-08-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/36/2c/8bd4be3a.jpg" width="30px"><span>小喵喵</span> 👍（1） 💬（1）<div>微服务的基础设施需要程序猿写代码来实现吗？</div>2018-07-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/1d/8e/0a546871.jpg" width="30px"><span>凡凡</span> 👍（1） 💬（1）<div>按照以往了解的基础架构部的开发速度来看，而且文中涉及的基础设施都有开源实现可以借鉴，一个基础设施从调研（开源系统代码review），到设计，再到开发，再到小流量接入，全公司推广，一个基础设施3个人大概5到6个月时间，如果去掉小流量和推广阶段，估计也需要3到4个月。

文中说到的前10个微服务，按照单个3*3人月算下来的话，理想情况下，需要9个月。

当然，这里没有考虑严格的测试和压力测试，否则每个系统，需要增加至少一个人月的周期。</div>2018-07-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/04/78/37b46ba6.jpg" width="30px"><span>鲁米</span> 👍（0） 💬（1）<div>我看到同学的留言中对工期评估，我有一个疑问 一年的时间开发，项目立项都那么轻松么？没有对比就没有伤害啊。如果领导既要基础设施建设，又要不能影响当前业务开发的情况下。是不是就果断放弃投入了。</div>2023-08-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/37/1b/82310e20.jpg" width="30px"><span>拿笔小星</span> 👍（0） 💬（1）<div>我们的服务发现就是代理式，服务直接通过SLB请求转发。SLB从服务发现那获取服务的IP列表</div>2023-03-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/b9/32/84346d4a.jpg" width="30px"><span>雪碧心拔凉</span> 👍（0） 💬（2）<div>对于网关是否包含鉴权功能，我们也遇到类似的问题，我们目前是将认证鉴权放到服务网关中(其实是由服务网关去调用认证和鉴权服务）。
另外我们网关分服务网关和api网关，服务网关包含认证、鉴权、路由等功能，api网关算是服务网关的裁剪版，只有路由功能，但是将网关分类了总觉得怪怪的。不知老师有没有更好的看法，请指正</div>2021-11-10</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJNeCwealtX0j5libPP67McmBGsHEKlNYPedF7tom3MIGF2ib6rPliaqR5QYS7WaTiaJdPhZjfQ4ZNdRA/132" width="30px"><span>刘二</span> 👍（0） 💬（1）<div>总结下基础设施：
# 功能篇
* 服务发现、路由
* API网关
* 配置中心
* 安全管控

# 运维篇
* 服务监控
* 服务跟踪
* 服务容错（流控、熔断等）
* 自动化测试、部署</div>2021-08-14</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/bvj76PmeUvW8kokyu91IZWuRATKmabibDWbzAj2TajeEic7WvKCJOLaOh6jibEmdQ36EO3sBUZ0HibAiapsrZo64U8w/132" width="30px"><span>梦倚栏杆</span> 👍（0） 💬（1）<div>老师这里提的服务数量多，是指的单个服务实例多吧，不是技术部整体服务个数多吧</div>2021-04-14</li><br/>
</ul>