上一期，基于异地多活架构设计复杂度最高的“跨城异地”，我结合自己的经验总结了异地多活设计的4个技巧及其核心思想，我认为掌握这些技巧是进入具体设计步骤的前提。

今天，在掌握这4大技巧的基础上，我来讲讲跨城异地多活架构设计的4个步骤。

## 第1步：业务分级

按照一定的标准将业务进行分级，挑选出核心的业务，只为核心业务设计异地多活，降低方案整体复杂度和实现成本。

常见的分级标准有下面几种：

- 访问量大的业务

以用户管理系统为例，业务包括登录、注册、用户信息管理，其中登录的访问量肯定是最大的。

- 核心业务

以QQ为例，QQ的主场景是聊天，QQ空间虽然也是重要业务，但和聊天相比，重要性就会低一些，如果要从聊天和QQ空间两个业务里面挑选一个做异地多活，那明显聊天要更重要（当然，此类公司如腾讯，应该是两个都实现了异地多活的）。

- 产生大量收入的业务

同样以QQ为例，聊天可能很难为腾讯带来收益，因为聊天没法插入广告；而QQ空间反而可能带来更多收益，因为QQ空间可以插入很多广告，因此如果从收入的角度来看，QQ空间做异地多活的优先级反而高于QQ聊天了。

以我们一直在举例的用户管理系统为例，“登录”业务符合“访问量大的业务”和“核心业务”这两条标准，因此我们将登录业务作为核心业务。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/9e/ce/d8283814.jpg" width="30px"><span>xuan</span> 👍（90） 💬（5）<div>业务分级我觉得得从如下方面来分析：
	1.部门或者公司当期的发力点，如果着重新用户的增长 我觉得顺序应该是ACB，如果着重现有客户满意度，我觉得顺序应该是CBA，如果看重看重收益，那B的优先级最高
	2.可通过预期货币价值分析，进行业务分级；大致维度如下：风险发生概率  风险损耗成本  技术改造陈本 技术改造时长（月）  改造后成本节省（月） </div>2018-07-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d6/1a/532f8a66.jpg" width="30px"><span>summer</span> 👍（44） 💬（1）<div>业务分级讨论的时候，产品说 A 也很重要，因为影响用户使用；B 也很重要，因为影响公司收入；C 也很重要，因为会导致客户投诉……这种情况下我们该如何处理业务分级？
了解产品挣钱的底层商业逻辑，就可以知道怎么分级了。不是每一单都要赚钱的，在这里亏的，在别处或下次再挣回来。比如微信聊天业务不挣钱，但是影响面大，坏了口碑，大家不来玩了，商家凭什么来投广告。减少影响面，然后跪求被影响用户的原谅</div>2018-07-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cf/bb/22af0e52.jpg" width="30px"><span>孙振超</span> 👍（20） 💬（1）<div>涉及到取舍时就需要参考公司的核心目标和愿景了，如果是和核心目标相关的优先级就高，和核心目标无关或关联度不大的优先级就低。
如同最近的滴滴，在以扩规模增利润作为核心目标时必须会优先处理司机端和线路规划相关的业务，而对于增加成本降低利润的用户端和客服系统优先级肯定会比较低；当事故频发引发公司战略转向到安全第一时，原先一直没有得以优化的客服系统、警方查询对接系统优先级将会排到第一位。

在异地多活时排定优先级时也是如此了，牺牲什么保证什么，都是和公司最为关注的内容和目标挂钩的。</div>2018-08-29</li><br/><li><img src="" width="30px"><span>Geek_92f9aa</span> 👍（10） 💬（2）<div>突然想到华神是不是讲少了一点：容灾演练？
像我以前公司每个月要求进行一次容灾演练，演练的方式是运维直接断掉广州或北京的网络，然后看线上服务是否正常运行，出问题的业务责令在在一定时间内改完再重新演练。</div>2020-10-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/b0/74/f553f094.jpg" width="30px"><span>Enjoystudy</span> 👍（7） 💬（6）<div>我们如果通过某种路由策略，比如用户id保证同一个用户的请求都路由到同一个机房就可以解决同步延时的问题</div>2018-07-12</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/kHoDdV15McXMpmNj0rCkjiaxB8liaKbMOCucv2PJ4tQ1xDSUcNSvEibaBpPpIib41PbwxXWH9YCXr5y2khyibltbL1w/132" width="30px"><span>bryan</span> 👍（6） 💬（1）<div>如果MQ和数据库同步同时进行，假设是新增数据，MQ先到，数据库后到！那不就主键冲突了！</div>2021-07-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f8/23/165d2f0e.jpg" width="30px"><span>成功</span> 👍（5） 💬（1）<div>B优先级最高，A第二，C第三。B要考虑跨城多活，A做同城多活，C不同机房就行</div>2018-07-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/a8/1b/ced1d171.jpg" width="30px"><span>空档滑行</span> 👍（4） 💬（1）<div>通常来说toC的应用，影响用户使用的应该是比较靠前的，尤其是产品还处于抢市场的阶段。
to B的应用客户买的是专业性，相对来说用户体验可以往后排，用户能使用和公司收入还是比较重要的。客户相对固定，可以通过客服主动联系客户的方式来做部分挽回</div>2018-07-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/12/e5/592d9324.jpg" width="30px"><span>TH</span> 👍（4） 💬（1）<div>之前学到过一个应对这种多因素筛选的方法，不知道对不对：列出所有参与讨论的业务，以及考虑到的影响因素（访问量、影响使用、收益……），每个因素设定一个权值，每个业务针对每个因素进行打分（权值和打分均不允许有重复值），最后计算每个业务的加权和，得出核心业务</div>2018-07-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/eb/a5/5d04b7cd.jpg" width="30px"><span>但莫</span> 👍（3） 💬（1）<div>
多个场景都重要的情况可以进行层次分析，首先俩俩比较，得到分析矩阵，进行归一化处理，经过计算可以得到每种场景的重要性权重。

当然，俩俩比较的时候判断哪个更重要就看评判人的喜好了，这一步可以通过头脑风暴的到一个平均值。


记得之前的课程中介绍过另一种方法，一时没想起来名字。</div>2018-07-05</li><br/><li><img src="" width="30px"><span>301</span> 👍（2） 💬（3）<div>华哥，请教一个问题，异地多活中用户归属于特定单元，如何平滑切换用户归属单元呢？我的理解是不是需要先禁写数据层，然后再下发新的路由规则？如果直接改路由配置，可能因为下发时效性，导致短时间内用户归属单元不一致</div>2023-03-13</li><br/><li><img src="" width="30px"><span>陈峰</span> 👍（1） 💬（1）<div>如果有多点都认为很重要需要异地多活，我觉得可以重新分析功能点。

因为系统是可以演化的，那么实际上目前的设计应该是在目前成本上最合适的设计，而不是说其他功能点未来不会设计异地多活。

首先应该明确哪些功能点没有异地多活是确实会导致用户口碑流失和业务扩展(比如，用户登录，核心功能的使用，比如qq的聊天等)，这类功能应该是最先要保证异地多活的。

不过具体的异地多活级别，也应该结合业务规模和风险概率来分析，因为跨城级异地多活的风险规避是为了城级风险，也许当前也许仅仅需要简单的区级多活就可以了(后续复杂设计可以等规模大了再加)，这样就可以简单当同机房处理，会简单很多。

在这核心功能之后，再考虑收入和投诉。投诉和收入本质上是一样的，都是经济权衡。应该分析概率和损失(比如处理投诉以后付出的成本)。如果，投诉概率不高，但投诉后为避免口碑，补偿成本很高，也应该考虑为收入上的风险点。在分析之后，依据优先度排序，优先处理风险高的</div>2023-10-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/d8/c1/2d9b9595.jpg" width="30px"><span>felix</span> 👍（1） 💬（1）<div>华神也是炉石传说爱好者吗😄</div>2021-07-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/12/b9/95e37a48.jpg" width="30px"><span>liuliu</span> 👍（1） 💬（3）<div>我这里是集设计中使用了MQ做数据同步，但是消息是有顺序性的，给消息加了顺序标签，但是感觉顺序处理部分还是不好操作，如果一定要用MQ同步有序数据可行吗？</div>2019-10-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/18/59/daeb0b6c.jpg" width="30px"><span>日光倾城</span> 👍（1） 💬（1）<div>“数据库同步走内网连接这种方式”请问跨城异地多活这种场景如何建立内网连接呢</div>2019-07-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/1d/8e/0a546871.jpg" width="30px"><span>凡凡</span> 👍（1） 💬（1）<div>对于业务分级，往往不会有固定的优先级，首先最重要的是明确各种情况的没在逻辑，如何影响用户，如何影响公司收入，如何导致客诉。明确内在逻辑之后，客诉一般要优先处理，不然对公司的声誉影响很大，也会造成公司业务部门对技术部门信任的崩塌。另外，外讨论的时候，需要看各种情况是否能够以迭代的方式，同步开展，小步幅行进，。现实情况，这往往也是居多的一种结果。</div>2018-07-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/02/72/6933412b.jpg" width="30px"><span>刹那间的永恒</span> 👍（1） 💬（1）<div>关于最后的思考题我认为首先确保用户体验才能扩大用户群体，同时一定程度上减少用户投诉以及间接性为公司增加收入；其次处理客户投诉效率同样也能为公司带来口碑，创造粉丝用户，所以我认为a&gt;c&gt;b</div>2018-07-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/a8/64/965e0d9b.jpg" width="30px"><span>王维</span> 👍（1） 💬（1）<div>另外，想问下华仔，消息队列在分布式系统中比较重要，您能写一篇消息队列的文章吗？例如什么时候用消息队列，用消息队列要注意什么？万分期待！谢谢！</div>2018-07-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/63/39/486faadf.jpg" width="30px"><span>浪子恒心</span> 👍（1） 💬（1）<div>能讲讲阿里的异地多活是怎么做的吗？</div>2018-07-05</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/7P4wtgRQt1l0YQlVOtiaUKey2AFZqQCAcABzdCNTP0JR027tkhVkRYgj1iaYF8OlqsE8j6A6icsAvYHIAX8E31WNg/132" width="30px"><span>killer</span> 👍（0） 💬（2）<div>华哥，有2个疑问在多活的架构设计中，A和B两个机房，用户1在A机房操作数据同步给B机房，在B机房操作的数据同步给A机房
1、在消息体上是不是要加一个标志？防止同步出现死循环；
2、在极端情况下，用户在两个省之间，某一时刻数据写入A机房，A机房数据同步B机房未完成，也在B机房操作了数据，同样B机房也同步数据给A机房，数据覆盖问题怎么解决呢？</div>2025-02-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/31/57/b2f831a7.jpg" width="30px"><span>深圳小草</span> 👍（0） 💬（1）<div>业务系统同时写两个异地机房的数据库能否可行，因为机房间数据同步必然是有延迟的。</div>2024-08-26</li><br/><li><img src="" width="30px"><span>Wei Lixia</span> 👍（0） 💬（1）<div>这些理论适用于部署在云上吗？</div>2022-11-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/9f/a1/d75219ee.jpg" width="30px"><span>po</span> 👍（0） 💬（1）<div>我还不是很确定银行转账这种A B机房的同步在应对各种场景下的方案，麻烦老师再讲下</div>2022-02-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/d6/46/5eb5261b.jpg" width="30px"><span>Sudouble</span> 👍（0） 💬（1）<div>结合公司目前的战略是规划，看侧重点在那个业务面上。如果还是不好分，列一些更细致的影响因素，进行打分，最终排列出一个优先级。</div>2022-02-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/6c/95/bb237f51.jpg" width="30px"><span>李梦嘉</span> 👍（0） 💬（2）<div>mq同步方式, 生产和消费都是并发进行的，存在乱序的可能, 怎么能够保障？</div>2021-09-04</li><br/><li><img src="" width="30px"><span>田军</span> 👍（0） 💬（1）<div>这个时候可以看看公司的北极星目标或者愿景，看看ABC哪个在作用哪个更大，这样就有了决策的方向、依据</div>2021-06-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/b5/3c/967d7291.jpg" width="30px"><span>艺超(鲁鸣)</span> 👍（0） 💬（1）<div>老师好，日志记录中的，服务器日志应该就是业务服务器吧。那本地独立日志存储系统怎么理解呢，是相对谁独立的呢，看解释是说应对业务服务器和数据库宕机的情况，那是说存储到本地文件系统吗？和服务器日志的区别是什么呢？谢谢</div>2021-03-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/73/18/ace2eb4f.jpg" width="30px"><span>cat</span> 👍（0） 💬（1）<div>老师，请问一下，比如说我有一个秒杀份额只有十万，为了实现高性能，放在缓存做cas。现在要做跨城容灾，如果还是同一份缓存，性能会下降，如果多份缓存，这里面涉及到怎么分配，请问老师，之前有没有过，类似案例可以做分享？</div>2020-06-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/15/4e/4636a81d.jpg" width="30px"><span>jian</span> 👍（0） 💬（1）<div>请问老师，本地独立系统保存日志为什么可以避免业务服务器和数据库同时宕机的情况？麻烦具体说明一下</div>2020-03-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/f1/84/7d21bd9e.jpg" width="30px"><span>Goal</span> 👍（0） 💬（1）<div>课程内容可以压缩一下呀，虽然讲的是架构，简单的来说就是通过增加机器冗余，提高系统可用性，但课程内容没有必要也冗余吧，好多重复的话语，也可以精炼一下，比较我们读起来节约时间。</div>2020-01-19</li><br/>
</ul>