关于复杂度来源，前面的专栏已经讲了高性能、高可用和可扩展性，今天我来聊聊复杂度另外三个来源低成本、安全和规模。

## 低成本

当我们的架构方案只涉及几台或者十几台服务器时，一般情况下成本并不是我们重点关注的目标，但如果架构方案涉及几百上千甚至上万台服务器，成本就会变成一个非常重要的架构设计考虑点。例如，A方案需要10000台机器，B方案只需要8000台机器，单从比例来看，也就节省了20%的成本，但从数量来看，B方案能节省2000台机器，1台机器成本预算每年大约2万元，这样一年下来就能节省4000万元，4000万元成本不是小数目，给100人的团队发奖金每人可以发40万元了，这可是算得上天价奖金了。通过一个架构方案的设计，就能轻松节约几千万元，不但展现了技术的强大力量，也带来了可观的收益，对于技术人员来说，最有满足感的事情莫过于如此了。

当我们设计“高性能”“高可用”的架构时，通用的手段都是增加更多服务器来满足“高性能”和“高可用”的要求；而低成本正好与此相反，我们需要减少服务器的数量才能达成低成本的目标。因此，低成本本质上是与高性能和高可用冲突的，所以低成本很多时候不会是架构设计的首要目标，而是架构设计的附加约束。也就是说，我们首先设定一个成本目标，当我们根据高性能、高可用的要求设计出方案时，评估一下方案是否能满足成本目标，如果不行，就需要重新设计架构；如果无论如何都无法设计出满足成本要求的方案，那就只能找老板调整成本目标了。

低成本给架构设计带来的主要复杂度体现在，**往往只有“创新”才能达到低成本目标**。这里的“创新”既包括开创一个全新的技术领域（这个要求对绝大部分公司太高），也包括引入新技术，如果没有找到能够解决自己问题的新技术，那么就真的需要自己创造新技术了。

类似的新技术例子很多，我来举几个。

- NoSQL（Memcache、Redis等）的出现是为了解决关系型数据库无法应对高并发访问带来的访问压力。
- 全文搜索引擎（Sphinx、Elasticsearch、Solr）的出现是为了解决关系型数据库like搜索的低效的问题。
- Hadoop的出现是为了解决传统文件系统无法应对海量数据存储和计算的问题。

我再来举几个业界类似的例子。

- Facebook为了解决PHP的低效问题，刚开始的解决方案是HipHop PHP，可以将PHP语言翻译为C++语言执行，后来改为HHVM，将PHP翻译为字节码然后由虚拟机执行，和Java的JVM类似。
- 新浪微博将传统的Redis/MC + MySQL方式，扩展为Redis/MC + SSD Cache + MySQL方式，SSD Cache作为L2缓存使用，既解决了MC/Redis成本过高，容量小的问题，也解决了穿透DB带来的数据库访问压力（来源：[http://www.infoq.com/cn/articles/weibo-platform-archieture](http://www.infoq.com/cn/articles/weibo-platform-archieture) ）。
- Linkedin为了处理每天5千亿的事件，开发了高效的Kafka消息系统。
- 其他类似将Ruby on Rails改为Java、Lua + redis改为Go语言实现的例子还有很多。

无论是引入新技术，还是自己创造新技术，都是一件复杂的事情。引入新技术的主要复杂度在于需要去熟悉新技术，并且将新技术与已有技术结合起来；创造新技术的主要复杂度在于需要自己去创造全新的理念和技术，并且新技术跟旧技术相比，需要有质的飞跃。

相比来说，创造新技术复杂度更高，因此一般中小公司基本都是靠引入新技术来达到低成本的目标；而大公司更有可能自己去创造新的技术来达到低成本的目标，因为大公司才有足够的资源、技术和时间去创造新技术。

## 安全

安全本身是一个庞大而又复杂的技术领域，并且一旦出问题，对业务和企业形象影响非常大。例如：

- 2016年雅虎爆出史上最大规模信息泄露事件，逾5亿用户资料在2014年被窃取。
- 2016年10月美国遭史上最大规模DDoS攻击，东海岸网站集体瘫痪。
- 2013年10月，为全国4500多家酒店提供网络服务的浙江慧达驿站网络有限公司，因安全漏洞问题，致2千万条入住酒店的客户信息泄露，由此导致很多敲诈、家庭破裂的后续事件。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/38/91/d8ee9a19.jpg" width="30px"><span>RookieDBA</span> 👍（90） 💬（2）<div>老师你好，请问后续的课程会有如何画好架构图的方法探讨或者方法论么？工作中时常因为汇报要画架构图，又总觉得自己架构图画不好。有没有推荐学习的材料。谢谢</div>2018-05-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cf/bb/22af0e52.jpg" width="30px"><span>孙振超</span> 👍（33） 💬（1）<div>架构设计中最为重要的是考虑各种非功能性需求，同样的功能但不同的非功能性需求设计方案会有很大的不同，比如登陆系统，功能都是相同，但一个要求是100&#47;s，另一个是10w&#47;s，，这两个架构是完全不一样。在实际情况下在安全性上的考虑会弱些，需要借助于专门的安全团队去进行评估和提供建议，架构师更多的精力在性能、容量、高可用、扩展性等方面</div>2018-05-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e8/1d/bbb92216.jpg" width="30px"><span>张平</span> 👍（32） 💬（2）<div>内容比较理论化，有点像教科书，科普一下还行</div>2018-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d4/1d/4af48531.jpg" width="30px"><span>苟哥</span> 👍（27） 💬（1）<div>我们现在做的项目是一个针对教培机构的一站式营销解决方案平台。有个疑问想请教老师，目前数据规模还不大，所以单机即可满足，但是接下去随着用户量、和业务数据量的增大，我应该在哪个节点去往集群的方式部署呢？有没有一个评估的方法论？</div>2018-05-23</li><br/><li><img src="" width="30px"><span>Geek_88604f</span> 👍（21） 💬（1）<div>        关于规模的论述非常经典，上升到了哲学的高度。量变是质变的必要准备，质变是量变的必然结果。当规模随着业务的发展逐渐增大时复杂度逐渐增加。一旦规模超过一定的量级时复杂度就会出现指数级的上升，完全超出预计。因此要做到在规模上升的时候不断演进架构，不断重构代码，并起且做好运维监控，防微杜渐。
        软件领域的成本和硬件领域的成本有很大的不同。在硬件领域随着规模的增大成本会降低，基本上是一次性的技术成本，因为根据摩尔定律，每一美元买到的电脑性能将每隔18～24个月翻一倍。软件领域为什么会不一样呢？归根到底是软件销售模式发生了变化，以前软件的销售模式和硬件的销售模式是一致的，开发出了一个软件产品到处复制销售，每卖出一份软件产品和卖出一块CPU是等同的，卖的多成本就可以持续下降——薄利多销。现在软件的销售模式发生了很大的变化，是账号+充值+移动消费。用户侧的开销很小，只需要一个浏览器就可以了，软件能力基本在服务端，这就导致了服务端规模上升成本就上升的尴尬境地，要想降低成本必须寻找新的技术和方法，而新的方法和技术需要创新，创新后还要引入到现有的生产环节和现有的技术结合，复杂度可想而知，成本的投入是持续的。
        云化架构下安全带来的复杂度主要体现在如下两方面:一是物理部署架构的变化，同一个系统的不同子系统部署在不同的安全区域，不同的安全区域需要不同的安全策略和不同的安全技术。另一个是不同的安全区域之间的通信需要选择或研发新的协议。原本简洁的网络通讯变得复杂和难以理解。</div>2019-08-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/5b/08/b0b0db05.jpg" width="30px"><span>丁丁历险记</span> 👍（10） 💬（1）<div>有幸在15年遭遇30g 流量冲击。
直接被机房下架。</div>2021-01-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/38/b6/234a17a7.jpg" width="30px"><span>陈问渔</span> 👍（8） 💬（1）<div>2018年，美国东部时间 2 月 28 日，GitHub 在一瞬间遭到高达 1.35Tbps 的带宽攻击。这应该才是现在现在最大的拒绝服务攻击~</div>2018-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f0/21/104b9565.jpg" width="30px"><span>小飞哥 ‍超級會員</span> 👍（6） 💬（1）<div>觉得后面这几节课讲的太严肃了，都有点听不懂了，虽然是很面的，但讲的氛围让人走心。
老师能否讲课向两个人聊天一样，让人听着不那么累！</div>2018-05-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c3/09/ee1b7ac0.jpg" width="30px"><span>Up</span> 👍（4） 💬（1）<div>首先感谢作者的分享，学到很多思考的角度。作者是从系统技术角度分析复杂度，我想补充下系统实施的角度。随着系统的规模、技术难度的增加，实施难度也在增加，需要做的辅助工作越来越多，比如需求文档、技术文档、学习成本，如果这些辅助工作没做好，那么实施难度会越来越高，团队成员的更换成本非常高，所以我认为实施难度也是复杂度来源之一！</div>2018-05-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/4f/cb/ede92cd5.jpg" width="30px"><span>Alex</span> 👍（3） 💬（2）<div>在实战中最大的挑战不是划分这6个维度，而是要结合本团队的研发能力、项目需要（时间要求），做出较优解来实现项目规模的扩大。
个人理解，6个维度是考虑问题的角度，做出分析，但最终还是要将架构扩展后的风险控制下来。从这个意义上讲，需求的理解是核心，离开需求单纯说架构没太大的意义。合适最重要
</div>2020-07-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/59/26/1015d573.jpg" width="30px"><span>gevin</span> 👍（3） 💬（1）<div>架构设计是要解决软件系统的复杂性，我觉得软件系统还有一个复杂性是，业务逻辑的复杂性，这个主要靠需求分析和业务架构设计来解决，这个靠软件架构设计比较难解决吧？

从这个角度出发，是不是架构设计之初，先要分业务架构设计和软件架构设计两步走？</div>2018-11-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d6/f1/6564febf.jpg" width="30px"><span>品闲生活</span> 👍（3） 💬（2）<div>系统的复杂度 = 功能数量 + 功能之间的连接数量
应该是乘法吧？</div>2018-05-14</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJGiahPncXAMXlRibCVapHxib4V90Pxa56QQr6iatHmHn77YibSibWhdBe9YKxrD5ria9ZI4JfFjD1SecAmg/132" width="30px"><span>杜秀清</span> 👍（2） 💬（1）<div>除了功能安全、架构安全外，我们一般会考虑数据安全，比如数据的加密解密脱敏等、数据备份等等</div>2022-06-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg" width="30px"><span>escray</span> 👍（2） 💬（1）<div>从专栏文章来看，我觉得架构师需要有安全意识（作为程序员也一样），但是安全的事情可能还是需要专业的人去处理。

我以前面对的系统可能勉强可以算的上是中等规模，功能比较多，数据量中等，应该还没有到“量变引起质变”的时候，但是应对起来似乎也比较勉强。

顺便回答思考题，这个系统的复杂度主要来源在于高可靠，一般是要求 24 × 7 不停机的，但是实际上估计达不到 4 个 9 的可靠性。

看到留言里面提到了“可伸缩性”，如果是租用数据中心的存储和计算资源，那么可伸缩性可以省钱，是有意义的；如果是自建系统，那么“可伸”类似于“可扩展”，“可缩”的意义就不大了，很难在自建环境中调配使用。</div>2020-09-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/99/c9/5dc9fa46.jpg" width="30px"><span>Even</span> 👍（2） 💬（1）<div>我们做银行内部系统的，企业架构和老师贴出来的类似，公司的系统多了，一般都有一套模板架构，例如普通的web系统，在安全方面考虑的并不多，就是一些XSS, SQL注入等之类的问题。
最近两年公司开始用公有云了，安全方面会多一些，例如使用VPN技术，bluecoat 代理，API的认证等方面，不知道这次有没有安全方面比较详细的讲解，谢谢老师。</div>2018-05-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f8/ba/d28174a9.jpg" width="30px"><span>Geek_zbvt62</span> 👍（2） 💬（1）<div>一直觉得好多（包括我）架构师是从开发做起的，对可用性，性能，业务复杂度有些经验，但安全性上认识不足，知识缺乏，想重视但重视不起来。不知道大厂的情况如何？会不会有专门的安全性保障部门，或者安全架构师来审核架构设计？</div>2018-05-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/49/2a/83fe5388.jpg" width="30px"><span>C1zel</span> 👍（2） 💬（1）<div>低成本带来的复杂度，体现在资源（机器，软件）的成本上，就需要更换编程语言和开源软件来减少资源的使用。复杂度体现在哪一块呢？</div>2018-05-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2b/da/67/e18b690e.jpg" width="30px"><span>神经蛙</span> 👍（1） 💬（1）<div>服务鉴权，选择 https 协议等是属于功能安全的范畴吗？</div>2023-03-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/31/fb/e5918d39.jpg" width="30px"><span>飞机</span> 👍（1） 💬（1）<div>项目因为是嵌入式项目，单体机器，性能差没有引入搜索引擎，所有模糊搜索都是基于mysql查询，导致代码复杂，维护成本高，结合实际情况来看，确实不适合，更好的方法应该是基于代码设计和SQL语句进行优化，使其易维护</div>2021-06-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ae/00/791d0f5e.jpg" width="30px"><span>忍者无敌1995</span> 👍（1） 💬（1）<div>架构小白，根据最近的复杂度来源学习，分析下当前公司项目的主要复杂度有哪些吧
1. 高性能：由于系统不存在太多高并发的场景，而且根据业务功能已经比较合理的拆分成多个微服务，
基本问题不大；但是有些时候会存在微服务之间http请求调用超时的场景，导致某些请求失败
2. 高可用：微服务注册采用zk，zk的ZAB算法可以保证高可用；mysql采用一主一从，一般问题也不大；redis采用哨兵一主多从；异步通信采用kafka, 当某台机器消费的分区线程卡死时，对应分区会积压数据，导致消费不及时存在问题，只能重启对应机器，打算采用其他MQ替代
3. 可扩展性：数据库采用mycat根据城市分库，水平扩展快；微服务直接加机器就可以了；代码层面设计模式有用到策略模式，将共性写在抽象类中，实现类继承抽象类，重写特定的方法
4. 低成本：量暂时还没达到，所以这块不是重点
5. 安全：代码规范+合适的框架；DDoS攻击没有太关注
6. 规模：项目趋于稳定
5. 安全：功能安全-选择合适的框架和代码要规范</div>2019-04-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/96/ce/8c3bdbe5.jpg" width="30px"><span>Geek_fb3db2</span> 👍（1） 💬（1）<div>内容都懂，感觉就是那么回事，但是还是做不好架构师，如何破
复杂性，业务特别复杂，一个功能改动可能需要耗费很久，而且出现bug很多，典型的功能划分不清晰，没有边界</div>2018-12-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/58/f6/07ca7f70.jpg" width="30px"><span>miketan</span> 👍（1） 💬（1）<div>个人觉得从公司规模来说，小公司更注重前期用户养成，需要关注高可用、安全，其次是性能、成本，然后再是可扩展和规模；中间层次的公司注重稳定性，需要关注高可用、安全、可扩展，其次是成本、性能，最后是规模；大公司应该都会关注，此时都会针对不同方面成立相应部门来解决；</div>2018-09-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/dd/bd/9b93ea26.jpg" width="30px"><span>blacknccccc</span> 👍（1） 💬（3）<div>感觉我们系统现在的复杂度主要是数据库这块，单表数据到了两百多万，修改和查询相对较慢，考虑到做分表，但是分表的维度和查询问题还没考虑清楚</div>2018-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/18/59/daeb0b6c.jpg" width="30px"><span>日光倾城</span> 👍（1） 💬（1）<div>针对我们整个p2p平台，主要还是高可用和安全方面的考量导致的复杂度！当然我觉得针对系统的各个模块，可能侧重的点又不一样，有的侧重高性能，有的侧重可扩展。我们需要抓住模块的复杂度痛点，然后设法去解决它，老师说的六大复杂度点，值得我们结合系统深入研究</div>2018-05-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/5d/78/f011d586.jpg" width="30px"><span>遇见阳光</span> 👍（0） 💬（1）<div>成本确实会制约架构的设计. 不同成本对应的架构完全不一样, 就拿数据库层面设计而言. 主流的mysql. 分布式领域的Tidb. 如果能使用分布式数据库,那么业务侧就不用考虑分库分表带来的一系列问题了. 只需完全关注业务即可. </div>2024-08-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/e6/09/2d4f564f.jpg" width="30px"><span>卑鄙的我</span> 👍（0） 💬（1）<div>前来考古，mysql现在支持在线添加索引并不会堵塞业务，但需要低峰期，</div>2024-04-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/6b/56/37a4cea7.jpg" width="30px"><span>单朋荣</span> 👍（0） 💬（1）<div>大佬们，谁有google那大数据三篇论文的中英文下载地址？</div>2023-05-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/a2/bb/cf822570.jpg" width="30px"><span>咖啡不加糖</span> 👍（0） 💬（1）<div>规模太复杂了，文章举的例子的我觉得很生动，一个系统有8个功能点的系统比3个功能点的系统要复杂的多。我现在做的就是企业系统，一直都是做这个系统的一部分，总是很难去搞清楚这个系统的全貌，但是也在尝试慢慢把系统搞懂。</div>2022-09-22</li><br/><li><img src="" width="30px"><span>sudo</span> 👍（0） 💬（1）<div>我有个问题想请教一下老师：对于提供api的服务，有哪些防止ddos攻击比较好效果的常见手段呢？静态资源可以用cdn，但api套cdn后会出现数据不一致的问题，特别是，动态cdn又太贵</div>2022-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/4b/d7/f46c6dfd.jpg" width="30px"><span>William Ning</span> 👍（0） 💬（2）<div>老师同学好，关于文中 ---- “尤其是互联网领域的 DDoS 攻击，轻则几 GB，重则几十 GB。2016 年知名安全研究人员布莱恩·克莱布斯（Brian Krebs）的安全博客网站遭遇 DDoS 攻击，攻击带宽达 665Gbps，是目前在网络犯罪领域已知的最大的拒绝服务攻击。这种规模的攻击，如果用防火墙来防，则需要部署大量的防火墙，成本会很高。例如，中高端一些的防火墙价格 10 万元，每秒能抗住大约 25GB 流量，那么应对这种攻击就需要将近 30 台防火墙，成本将近 300 万元” 

665Gbps，每秒能抗住大约 25GB 流量，那么应对这种攻击就需要将近 30 台防火墙，没看明白是怎么计算的？
665Gbps = 665GBps ？
665&#47;25 = 26.6 约等于 30 ？

望解答，谢谢</div>2022-04-01</li><br/>
</ul>