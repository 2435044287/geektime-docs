无论是高可用计算架构，还是高可用存储架构，其本质的设计目的都是为了解决部分服务器故障的场景下，如何保证系统能够继续提供服务。但在一些极端场景下，有可能所有服务器都出现故障。例如，典型的有机房断电、机房火灾、地震、水灾……这些极端情况会导致某个系统所有服务器都故障，或者业务整体瘫痪，而且即使有其他地区的备份，把备份业务系统全部恢复到能够正常提供业务，花费的时间也比较长，可能是半小时，也可能是12小时。因为备份系统平时不对外提供服务，可能会存在很多隐藏的问题没有发现。如果业务期望达到即使在此类灾难性故障的情况下，业务也不受影响，或者在几分钟内就能够很快恢复，那么就需要设计异地多活架构。

今天我来聊聊异地多活架构，接下来还会再讲异地多活架构的设计技巧和流程。

## 应用场景

顾名思义，异地多活架构的关键点就是异地、多活，其中异地就是指地理位置上不同的地方，类似于“不要把鸡蛋都放在同一篮子里”；多活就是指不同地理位置上的系统都能够提供业务服务，这里的“活”是活动、活跃的意思。判断一个系统是否符合异地多活，需要满足两个标准：

- 正常情况下，用户无论访问哪一个地点的业务系统，都能够得到正确的业务服务。
- 某个地方业务异常的时候，用户访问其他地方正常的业务系统，能够得到正确的业务服务。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/a8/1b/ced1d171.jpg" width="30px"><span>空档滑行</span> 👍（162） 💬（4）<div>备份系统平常没有流量，如果直接上线可能触发平常测试不到的故障。
再实时的系统也会有数据延时，如果涉及到金融这种系统，仍然是不敢直接切换的。
系统运行过程中会有很多中间数据，缓存数据等。系统不经过预热直接把流量倒过来，大流量会直接把系统拖垮</div>2018-06-30</li><br/><li><img src="" width="30px"><span>Geek_88604f</span> 👍（57） 💬（3）<div>        首先第一点业务会中断一分钟，这对于微信或支付宝这样的系统来说是不可接受的，特别是像春节这样的关键时刻，万万不可掉链子。
        第二点数据不一致，如果在主分区故障前还没有将数据同步到备分区，那么在主分区恢复前数据一直不一致。对于像新闻或微博之类的应用还好说，对于电商或微信等系统就不可接受。
        第三点备用分区的可用性，发生故障往往是在业务高峰期，这个时候备份区能否抗住是值得怀疑的。一个从来没有锻炼过的人，突然让他跑马拉松估计扛不住。
        最后一点缓存，如果系统中存在缓存，缓存的数据在备分区是没有的，缓存需要预热，一下子切到备出现缓存击穿导致存储扛不住</div>2019-09-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/05/e5/aa579968.jpg" width="30px"><span>王磊</span> 👍（27） 💬（1）<div>文章提到异地多活的代价时，说到复杂的架构，但通篇没有一个架构图，从文字看，也没完全理解架构的细节，例如异地之间如何同步，一地出现问题，如何切换，例如北京的业务系统出问题了，怎么用广州的业务系统来抗过去。</div>2018-06-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/2a/50/ec923346.jpg" width="30px"><span>微风</span> 👍（22） 💬（1）<div>李老师，像文中提到的不同的异地多活架构产生的不同成本，没有直观印象，您能否系统性的给个具体的分析～</div>2018-10-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/15/04/0a822bc9.jpg" width="30px"><span>Mr.Null</span> 👍（14） 💬（2）<div>现在流行云服务，对于企业做异地多活、灾备会不会很省事？</div>2018-06-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c7/30/2f8b78e9.jpg" width="30px"><span>CYH</span> 👍（12） 💬（1）<div>请教个问题：文章说支付宝类的金融服务一般采用的是同城异区架构.那假如真的发生了类似奥尔良水灾问题，支付宝如何保证业务正常？要解决这问题的话是多地部署（多地间服务状态不同步），存储高可用？</div>2018-07-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/12/07/29f12e6b.jpg" width="30px"><span>大宝</span> 👍（10） 💬（2）<div>最近看CIPS（人民币跨境支付系统）的相关信息，官网中有这么一条新闻：　　
“本次CIPS主备中心切换用时67秒，较上一次切换运行用时缩短了19秒，进一步提高了切换效率及系统连续运行能力。此次切换运行充分验证了CIPS二期全面投产后备份中心系统配置的正确性和可用性。后续，CIPS运营机构将进一步提高业务连续性保障能力，完善系统服务功能，提升用户使用体验。”
结合老师讲的最近几章，推断CIPS是主备系统架构，不是异地多活，使用的是数据分区备份，并且官网之前也提到主系统在上海，备份系统在无锡。
但是我感觉有两个奇怪的地方：一个是：主备在上海和无锡，这两个地方觉得不远也不近，看了下地图约150公里吧，感觉既不是“同城异区”，也算不上“跨城异地”。另一个他作为金融系统使用主备架构，而没有使用异地多活架构，是不是有点业余？</div>2018-10-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d3/2f/f54b8fd1.jpg" width="30px"><span>freebird4ever</span> 👍（7） 💬（1）<div>文章中支付宝转账的例子不对。支付宝通过分布式事务保证转账交易的原子性。oceanbase保证异地多个节点中大部分节点写成功。未写成功的节点异步恢复。未恢复前不可发生新的交易。</div>2018-07-11</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoDPdI6NFplQgjoU6yy9JIq6y2xFE3z3DuWn2tuekRceicp5mKUAERwCcy3I64Jz07jr29kNMfJaqA/132" width="30px"><span>夜行者</span> 👍（6） 💬（2）<div>支付宝跨国异地多活是怎么架构的？用户在国外也能用支付宝呀</div>2020-03-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/53/12/783f6294.jpg" width="30px"><span>天使</span> 👍（6） 💬（1）<div>“您提到的支付宝同城异区万一主区出现故障。转账的时候正好停留在那1ms没能到达备用区域怎么解决？” 我理解的是：日志+补偿+人工处理肯定是能从业务上解决这个问题的；纯技术角度，区块链是另外的选择，就是不是很了解目前的技术成熟度是否能满足支付宝这么大的体量；还有一个就是未来量子计算机发展到一定程度了，或许就没有“异地多活”了。</div>2018-07-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cf/bb/22af0e52.jpg" width="30px"><span>孙振超</span> 👍（4） 💬（1）<div>假设我们做了前面提到的高可用存储架构中的数据分区备份，又通过自动化运维能够保证 1 分钟就能将全部系统正常启动，那是否意味着没有必要做异地多活了？

数据分区备份意味着分区中的数据和当前提供服务的机房数据可能存在这延迟，同时备份系统启动后能否按照期望的sla提供服务是无法保证的。

但不同类型的系统对于数据和可用性的要求也是不同的，对于新闻、网络小说、论坛、政府学校等以阅读资讯为主的系统来说如果可以做到分钟级正常重启，是没有必要做异地多活的；对于电商、银行和钱相关的系统还是需要做异地多活的。</div>2018-08-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/63/39/486faadf.jpg" width="30px"><span>浪子恒心</span> 👍（4） 💬（1）<div>这期讲的有点浅，希望能更深入的谈谈异地多活怎么实现，有没有什么模式。</div>2018-06-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a7/ce/7ee0d672.jpg" width="30px"><span>Regular</span> 👍（4） 💬（1）<div>这得看这1分钟对业务的影响，如果影响不大就没必要做，如果影响较大，还是得做异地多活</div>2018-06-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f9/fa/abe4ca5d.jpg" width="30px"><span>碧海蓝天</span> 👍（3） 💬（1）<div>余额数据同城异区对比跨城异地在数据一致性上同样存在时间差，只是时间窗口更小而己，如果两地都支持写的话，存在被双花攻击的可能，风险还是很大，有什么方法避免吗</div>2018-10-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/05/e5/aa579968.jpg" width="30px"><span>王磊</span> 👍（3） 💬（1）<div>有个问题，不太清楚。异地多活，即使同城异区，他们都有对用户不同的访问ip吗，当一地出现问题的时候，用户自己尝试访问另一地?如果是自动切换，是什么机制，dns全部解析到另一地的ip?</div>2018-06-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/44/a0/16d0d300.jpg" width="30px"><span>ZHANGPING</span> 👍（2） 💬（1）<div>异地多活不是那么好做，当前服务依赖的服务需要对等安装，如果存在跨机房调用：会因为网络延迟，导致吞吐量直线下降，流量拥塞，服务雪崩一系列问题。</div>2021-07-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/79/eb/4fa1b5bc.jpg" width="30px"><span>J</span> 👍（2） 💬（1）<div>老师，我对文章中提到的支付宝不采用跨城异地，而采用同城异区的多活存在疑问，从逻辑上来讲同城异区即便网络延迟很小，但总归是有延迟的，也会从某种程度上影响一致性，架构也必须引入方案解决一致性问题，两者不存在一致性上的复杂度差异，而同城和异地的差异是不是应该是在用户体验上来区别？比如，同样是转账业务，一个转账请求需要在多个活动机房都同步后才向用户返回成功，这样的话，同城的优势就在于响应时间很快，而异地可能就会很慢。</div>2018-08-26</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/7SOblVZ7dNJ88wkeYR0HklxdR9VuiaQ0GMscAnrlic6EjvRZS52m4n1VPypwZFsmabbJ4STZRbHFfVZE24Jjqr1w/132" width="30px"><span>今夕是何年</span> 👍（2） 💬（1）<div>还是要考虑异地多活的。数据备份和存储高可用没法应对大规模停电 地震这种极端灾难。
</div>2018-07-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/37/1b/82310e20.jpg" width="30px"><span>拿笔小星</span> 👍（1） 💬（1）<div>老师，举得亚马逊的业务。中国账号的无法登录美国亚马逊。是因为，数据没有同步？如果是这样的话，那不就是相当于部署两套业务系统嘛。这个算多活吗</div>2023-03-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/50/b3/9269cd59.jpg" width="30px"><span>LWD</span> 👍（1） 💬（2）<div>异地多活怎么感觉就是主主架构啊，只不过这里强调的是地理距离</div>2023-02-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ce/ed/04ce3d70.jpg" width="30px"><span>波</span> 👍（1） 💬（2）<div>请问下，淘宝的秒杀活动，是同城多活方案，还是异地多活方案？</div>2022-11-22</li><br/><li><img src="" width="30px"><span>Geek_733181</span> 👍（1） 💬（1）<div>兄弟萌我卷到这里了</div>2022-04-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/20/d8/47/78355da1.jpg" width="30px"><span>aduan</span> 👍（1） 💬（1）<div>请教下，央行推出的数字货币，是如何保障高可用和高性能的。</div>2021-02-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（1） 💬（1）<div>课后思考及问题
1：异地多活——老听到这个词，不过不明白其本质含义，现在好一点了。四个字不太容易理解，那就拆开理解。
异地——表示不同的地理位置的意思，
多活——表示多个活跃的服务节点，
合起来，异地多活——表示多个不同的地理位置上有多个活跃的服务节点。
目的是为了应对极度灾难问题，引起的应用架构不可用的问题，比如：台风、地震、发水、大面积停电、光缆被挖断、电缆被拖断等问题，这类问题影响的区域范围大，如果一个服务的所有机器都部署在同一个机房，地理位置非常近，那可能存在所有服务都不可用的问题，这样这个应用就不可用啦！
好处是增强了系统可用性，代价是需花更多的钱。
感觉异地多活，就是把一个集群中部署相邻的机器，通过架设专有的网络通道不断的扩大两者之间的距离，根据位置远近，又分为同城移区、同国异城、同球异国，也许为了会有同宙异星。

2：不过有如下疑问？
2-1：多活之间应该也需要数据同步吧？如果需要，一地由于天灾完全不可用，另一地还可以，那之前产生的数据问题怎么解决？
2-2：异地多活，是同时对外提供服务吧？不同的地区可以就近访问对于的服务，服务对于客户来讲是逻辑一体的，但是物理上是分开的并且距离较远，那数据延迟估计会更高，这类问题又该如何搞定？

3：假设我们做了前面提到的高可用存储架构中的数据分区备份，又通过自动化运维能够保证 1 分钟就能将全部系统正常启动，那是否意味着没有必要做异地多活了？
做不做异地多活，需要看具体业务和成本承担能力，因为异地多活主要是为了解决极度灾难性情况引的系统不可用问题的，如果不怕这种灾难，或者差钱那就没必要了，当然，业务上不合适也不行。不差钱，业务合适(主要是读服务，有延迟也无所谓)那应该做异地多活。
</div>2019-08-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d0/80/67e3312c.jpg" width="30px"><span>超</span> 👍（1） 💬（1）<div>目的不同吧，即使做了前面提到的高可用存储架构中的数据分区备份，又通过自动化运维能够保证 1 分钟就能将全部系统正常启动，那还是不能解决不可抗力(自然灾害等)带来的不可用，因此，对于需要做异地多活的业务还是有必要做异地多活的。</div>2019-05-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/1a/8a/9a303af4.jpg" width="30px"><span>尼古拉斯·俊杰</span> 👍（1） 💬（1）<div>多活不是同时运行的吗</div>2018-08-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/45/ab/2775aaca.jpg" width="30px"><span>xderam</span> 👍（1） 💬（1）<div>以前微博做过异地机房 但是因为种种原因 还是回到了同城多机房的架构</div>2018-07-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/31/dc/af9c4356.jpg" width="30px"><span>Alan</span> 👍（1） 💬（1）<div>能不能给一个系分的案例呢，全面一点的</div>2018-07-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/de/17/75e2b624.jpg" width="30px"><span>feifei</span> 👍（1） 💬（1）<div> 对于此问题，我觉得还是业务决定的
比如微博，微博面向的用户是全中国地区的用户，而且用户的规模已经上亿级别，就有必要做异地多活架构，这样既可以容灾，又可以加快不同地区的访问

再比如支付宝，已经国际化，就需要跨国多活架构，像老师说提到的余额，就需要单独处理，针对不同地区还可以有差异化的服务</div>2018-07-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/17/be/73be948a.jpg" width="30px"><span>沧海一粟</span> 👍（1） 💬（1）<div>针对异地多活架构，如果真的发生了故障，数据出现了不一致，如何确定数据恢复到一致性，数据不一致，被影响的用户暂时不能服务了是不是，如支付宝，微信支付类金融产品。</div>2018-07-01</li><br/>
</ul>