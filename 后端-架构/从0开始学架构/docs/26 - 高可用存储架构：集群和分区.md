上一期我讲了高可用存储架构中常见的双机架构，分别为主备复制、主从复制、双机切换和主主复制，并分析了每类架构的优缺点以及适应场景。

今天我们一起来看看另外两种常见的高可用存储架构：数据集群和数据分区。

## 数据集群

主备、主从、主主架构本质上都有一个隐含的假设：主机能够存储所有数据，但主机本身的存储和处理能力肯定是有极限的。以PC为例，Intel 386时代服务器存储能力只有几百MB，Intel 奔腾时代服务器存储能力可以有几十GB，Intel 酷睿多核时代的服务器可以有几个TB。单纯从硬件发展的角度来看，似乎发展速度还是挺快的，但如果和业务发展速度对比，那就差得远了。早在2013年，Facebook就有2500亿张上传照片，当时这些照片的容量就已经达到了250 PB字节（250 × 1024TB），平均一天上传的图片有3亿5000万张。如此大量的数据，单台服务器肯定是无法存储和处理的，我们必须使用多台服务器来存储数据，这就是数据集群架构。

简单来说，集群就是多台机器组合在一起形成一个统一的系统，这里的“多台”，数量上至少是3台；相比而言，主备、主从都是2台机器。根据集群中机器承担的不同角色来划分，集群可以分为两类：数据集中集群、数据分散集群。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/a8/1b/ced1d171.jpg" width="30px"><span>空档滑行</span> 👍（96） 💬（1）<div>1.远距离集群网络延时较高，而且网络出问题的几率加大，导致数据复制的逻辑会比较复杂
2.成本过高，数据全量复制，等于存储多份
所以更好的办法是从业务端对数据做分区，出现地理故障时只形象一部分用户或者功能的使用</div>2018-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cf/bb/22af0e52.jpg" width="30px"><span>孙振超</span> 👍（58） 💬（1）<div>数据集群可以做到在不同节点之间复制数据，确保当一个集群断网断电的情况下，仍然有机房可以读取数据，但是在对外提供服务时不仅仅考虑是否能读写数据，还需要考虑读写数据所需的耗时。距离过远意味着耗时较长，如果是搭建专线，成本也会非常高，因而从成本和用户体验两个纬度考量远距离同步集群不适合直接对外提供服务。

对于城市级数据集群出故障，主要还是通过短距异地（网络耗时在十毫秒级别）集群来解决，远距离集群主要还是用于做冷备、数据离线比对等功能。</div>2018-08-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/c8/34/fb871b2c.jpg" width="30px"><span>海罗沃德</span> 👍（38） 💬（4）<div>AWS按照地理分区为region，每个region之间大约相当于跨国分区，当然在很多国家里AWS都有多个region比如us-west-1，us-west-2，就分别位于加利福尼亚和俄勒冈，而us-east-1在弗吉尼亚

每个AWS的region下面又有多个availablility zone简称AZ，就是所谓us-west-2 a，us-west-2 b这样的，AZ基本上是不在同一个城市，距离至少要在数百公里以上，以保证地理级别可用

不同的region级别上数据是很难迁移的，如果有多region的数据同步需求，可能需要联系AWS的工程师来调配资源，而且费用也会很高，但是同region下的AZ级别数据同步是很容易的，费用也很低</div>2019-07-14</li><br/><li><img src="" width="30px"><span>Geek_88604f</span> 👍（18） 💬（1）<div>        既然数据集群就可以做到不同节点之间复制数据，为何不搭建一个远距离分布的集群来应对地理位置级别的故障呢？从以下几个方面来考虑:业务本身、均衡性、容错性、可伸缩性。
        业务本身:在这样的一个集群上网络访问的质量是不可控的，导致用户体验差，用户无法忍受就只能放弃。
        均衡性:在大规模的情况下算法很难保证各个服务器上的数据分区是均衡的。一个可能是算法本身在大规模的情况下失效了;另一个可能是集群中节点的负载情况时时刻刻在发生变化，分区一直处在调整当中。
        容错性:大规模集群中服务器故障是家常便饭，当服务器故障时数据分区需要分配给其他服务器，这就导致了时时刻刻在发生数据迁移，影响正常业务的带宽。
        可伸缩性:一是这样的集群Master是瓶颈，系统节点规模有上限;二是增加或删除节点带来数据分区的大面积迁移
        总的来说，搭建一个远距离分布的集群来应对地理位置级别的故障是很不实际的方案，它注定不能将均衡性、容错性、可伸缩性这三者的影响控制在有限的范围内，进而影响正常业务的开展。</div>2019-09-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/1b/70/547042ee.jpg" width="30px"><span>谭方敏</span> 👍（14） 💬（1）<div>数据集群与数据分区。
其中数据集群又分数据集中集群和数据分散集群。
数据集中集群需要考虑的是，1）数据复制，2）状态检测，3）故障选举，典型代表zookeeper。
数据分散集群需要考虑的是，1) 均衡性，2）容错性，3）扩展性, 典型代表Hadoop. 
数据分区需要考虑的是，1）数据量，2）分区规则，3）复制规则。
其中复制负责有可以分为1）集中式，2）互备式，3）独立式。

拿现在公司业务来说，现在选择的是mongodb，它能支持数据集中式集群（副本集，一主多从）和数据分散集群（数据分片）
公司在四个区（sz，as，us，eu）都有自己的DC中心，数据分区复制规则为集中式，具体表现是备份数据库都在as，
数据集群模式还是采用数据集中集群，虽然mongodb支持数据分散集群的，但是发现由延迟带来的数据复制问题变得非常严重。后来只弄取消这种方案。
</div>2020-03-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/9a/e6/e8439f9a.jpg" width="30px"><span>ttxser</span> 👍（13） 💬（3）<div>我觉得这是我购买的众多课程中，最值的一个，谢谢！</div>2018-07-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/60/b7/4a665c73.jpg" width="30px"><span>小鬼爱风雪</span> 👍（9） 💬（1）<div>老师讲的很好，但是从架构层面讲技术总有浅尝辄止的感觉，是不是我要从更抽象层面去理解架构。</div>2021-06-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d5/3f/80bf4841.jpg" width="30px"><span>文竹</span> 👍（5） 💬（1）<div>数据分散集群具有均衡性，容错性，可伸缩性特点，响应比较快。

远距离分布的集群可有如下特点：
1、更容易出现不可用性，具体表现在业务响应慢，数据读&#47;写&#47;复制延迟高
2、一致性也难保证
3、也难保证均衡性，容错性，可伸缩性特点
4、复杂度较近距离的集群呈现指数级增长


</div>2018-08-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/ed/39/5245da19.jpg" width="30px"><span>echozheng</span> 👍（4） 💬（2）<div>老师您好，有个问题没想明白，还请解答一下哈哈。数据分区集群，那不同地区的用户产生的数据就会存储在不同地区吧？比如北京的用户产生的数据就存储在北京分区，这时北京的用户来到广州时，读的还是北京分区的数据吗？产生的数据也是写回北京分区吗？如果写到北京分区，那耗时变长体验不太好，如果写到广州分区，那用户的数据就会分散在各个区了？这是个问题吗？会有这个问题吧？谢谢解答</div>2023-05-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/50/b3/9269cd59.jpg" width="30px"><span>LWD</span> 👍（4） 💬（1）<div>老师您好，数据分散集群和分区感觉就是现在各种中间件的分片思想，为啥这里要严格区分分区和分散集群的概念呢？文章的分区我反复看了好几遍感觉本质还是分散集群，只不过文章强调了地理位置要足够远，其实本质还是一样的；</div>2023-02-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/06/81/28418795.jpg" width="30px"><span>衣申人</span> 👍（4） 💬（1）<div>请问数据分散集群不就是分区吗？文章在论述时的分类和层次上是不是有点重合？还是我理解错了呢？请老师指导</div>2018-07-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/b5/e0/229b940f.jpg" width="30px"><span>yue-stronger</span> 👍（2） 💬（1）<div>Redis集群属于哪种数据集中式集群还是数据分散式集群呢？我的理解应该是分散式集群吧？毕竟每个服务都有属于自己的slot，还是不属于这两种集群类型？</div>2021-09-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c6/6f/ac3003fa.jpg" width="30px"><span>xiong</span> 👍（2） 💬（1）<div>您好，想问下，集中式数据备份模式，是不同地区的数据都备份到同一个库中吗，还是各备份数据在备份中心也是各自独立的？</div>2019-11-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/29/74/3f/5c9fd08f.jpg" width="30px"><span>李晨</span> 👍（1） 💬（1）<div>1、网络延迟、网络故障都可能会导致数据出现不一致性等问题，处理这些问题有可能会引入其他的问题
2、集群架构的话，数据应该是多副本的，数据量会导致成本过高</div>2022-08-02</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIkkg9icSGleYMAnwlb7A9MMJYOdovl8kOCA0asMkDe6grPNF74ib0prQMicicJTNa1WsdpMJ4p1CWkUQ/132" width="30px"><span>shawn</span> 👍（1） 💬（1）<div>kafka属于哪种类型呢？应该不属于分散集群，因为没有一master来分配数据读写，这样理解对吗？</div>2021-12-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/f4/8c/0866b228.jpg" width="30px"><span>子房</span> 👍（1） 💬（1）<div>后面越来越精彩</div>2021-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/d1/29/1b1234ed.jpg" width="30px"><span>DFighting</span> 👍（1） 💬（1）<div>网络由局域网发展为广域网甚至更大的网络，网络延迟、带宽和可靠性，相比于小范围内的数据集群，这些都会给业务响应、系统备份、故障恢复和运维等方面等带来很大的影响。换个角度来说，数据分区从某个角度来说是一种风险分担策略，受影响的只是小部分数据和业务，而且还可以快速恢复。</div>2021-04-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c9/ce/cc85c6c3.jpg" width="30px"><span>阿恒</span> 👍（1） 💬（1）<div>远距离分布式，存在的网络成本比较高，存在延时。
听了这么多节架构课，感触最深的就是，没有十全十美的架构，只有就业务场景而言相对合理的架构。</div>2020-03-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/fe/c5/3467cf94.jpg" width="30px"><span>正是那朵玫瑰</span> 👍（1） 💬（1）<div>老师回复留言真是好快呀！定了好几个专栏，华仔老师对留言的回复是最认真和最负责任的，从专栏学习了很多东西，此留言是特意感谢华仔老师的！
另外rocketmq确实是producer轮训发给每个master，应该是producer充当了算法分配角色，我开始理解以为一定要服务器端一个节点来充当！</div>2018-08-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/06/81/28418795.jpg" width="30px"><span>衣申人</span> 👍（1） 💬（1）<div>老师，数据分散集群，数据应该是不一样的吧？关键是分区吧，虽然可能节点会互备数量数据，但不等于数据都相同，不然和数据集中集群有和区别？</div>2018-07-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/06/81/28418795.jpg" width="30px"><span>衣申人</span> 👍（1） 💬（1）<div>思考题里的跨地域复制集群，不就是异地多活吗？请问我有理解错吗？</div>2018-07-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d5/31/b09432cc.jpg" width="30px"><span>@漆~心endless</span> 👍（1） 💬（1）<div>能否引入区块链的相关思想去做数据备份，将非机密数据进行“去中心化”操作，这样能降低硬件成本，以及提高容灾能力。</div>2018-06-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/45/fe/cd8defff.jpg" width="30px"><span>生活就是态度</span> 👍（1） 💬（1）<div>可以讲讲es,kafka这些中间件优化及应用不</div>2018-06-28</li><br/><li><img src="" width="30px"><span>Tom</span> 👍（1） 💬（1）<div>用分布式集群和数据分区备份主要区别应该是复制时间点不一样。集群一般是有写入就开始复制，这个时候一般都是业务繁忙的时候，此时进行远程复制会占用太多带宽会影响正常业务。而数据分区备份可以选择非业务繁忙时段比如深夜进行复制。</div>2018-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/b6/74/c63449b1.jpg" width="30px"><span>问题究竟系边度</span> 👍（1） 💬（1）<div>如果采用远距离集群，网络抖动和延时就会对整个集群性能造成影响。 如果出现网络分区，数据出现差别。 同时副本复制的控制会比较复杂</div>2018-06-27</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/7P4wtgRQt1l0YQlVOtiaUKey2AFZqQCAcABzdCNTP0JR027tkhVkRYgj1iaYF8OlqsE8j6A6icsAvYHIAX8E31WNg/132" width="30px"><span>killer</span> 👍（0） 💬（1）<div>
集群架构分2种
1、集中式：1主n从，数据写入靠主节点，数据写入完成复制到其他从节点，mongodb就是类似的架构，难点是如何讲数据复制给多个从节点，如何检查主机的状态以及主节点挂掉后如何选举主节点；
2、数据分散式：也是多个服务组成1个集群，跟集中式的区别在于每台服务器都负责存储数据并且备份一部分数据，难点是考虑数据均衡性、容错性、可伸缩性，典型的场景是hadoop，tidb也是。

我们在使用tidb时，每当新增节点，新节点是需要从现有节点同步一份数据的，每次扩容都会预留一些空间避免频繁扩容。

现在从几方面聊聊搭建一个远距离分布式集群对应地理位置故障技术方案可行性。
1、远距离数据传输，存在网络延迟、不稳定性、数据一致性问题，如何确保数据是否写入备份集群本身就很复杂；另外，数据恢复拉取效率以及性能问题也很会很严重，集群会承担很大的读取压力；
2、集群架构(1).采用集中式架构，只有1个写入节点，容易成为性能瓶颈，并且集中式架构的难点需要解决;(1).采用数据分散式架构，备份数据体量大均衡性和可伸缩性又是难题，新增机器，数据复制到新机器延迟等问题可能会导致数据恢复失败；

没有类似经验，如果做成本高、复杂度高，不太可行啊。</div>2025-01-22</li><br/><li><img src="" width="30px"><span>陈峰</span> 👍（0） 💬（1）<div>老师，问一个问题，数据地域性分区以后，意味着不同人的数据在不同的区域。是不是，假设我注册账号和访问业务的时候，数据存储在武汉区域，那么无论我在哪个城市，我在进行业务处理的时候，都是访问的武汉区域呢？

这样会不会对部分用户造成数据访问延迟呢(比如，最初我的业务数据都路由到了武汉，但实际上我后来去了距离很远的城市继续使用业务)</div>2023-10-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/37/1b/82310e20.jpg" width="30px"><span>拿笔小星</span> 👍（0） 💬（1）<div>说一下简单理解，数据分散集群和数据分区的区别，前者集群中的机器还是同一个机房的。后者却是跨机房的，且机房是异地的。不知道，说得对吗</div>2023-03-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/23/18/4284361f.jpg" width="30px"><span>易飞</span> 👍（0） 💬（1）<div>远距离集群会有访问访问时延大的问题；如果数据量大，备份时也会存在网络问题</div>2022-02-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/23/18/4284361f.jpg" width="30px"><span>易飞</span> 👍（0） 💬（1）<div>互备分区，如果两两互备的话，应该不存在扩展麻烦的问题吧？</div>2022-02-05</li><br/>
</ul>