你好，我是 aoe（发音是汉语拼音），是一名普通的 Java 程序员。今天想和你分享一下我学习TDD的故事。

我开始学习TDD，起因是工作中出了一个大Bug。我在日常工作中会接触到一些和财务相关的业务，完成此类工作时一直都特别小心谨慎，生怕出错。工作很多年，一直风平浪静，直到有一天运营部门的同事告诉我，管理后台显示打给用户的金额比正常情况多了几十万！

## 一个价值几十万的符号

完整故事是这样的：我们公司的产品是一款语聊App，聊天室内用户赠送给主播礼物，主播收到礼物后可以获得报酬，主播报酬 = 礼物价值 ✖️ 主播分成比例。

本次需求是根据主播评级动态来获取的主播分成比例，正常逻辑是先从Redis获取。如果 Redis中没有，就再从数据库获取；如果数据库中也没有，就返回一个默认值，并保存至  Redis。

问题就出在默认值上。正常情况下，主播分成比例应该小于100%，但由于我的失误，返回了一个无意义的值 -1，在计算主播收益时，所有参与运算的数据都取绝对值后再运算，这样 -1 就变成了 1，主播分成比例也就变成了 100%。

当财务部门给主播结算报酬时发现要多出几十万，这才发现不对劲儿。往日不起眼的小 Bug，瞬间升级成了重大 Bug，幸亏发现及时才没有造成更大损失。
<div><strong>精选留言（2）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/29/87/e1/b3edcc09.jpg" width="30px"><span>范飞扬</span> 👍（0） 💬（0）<div>小巨人项目用的书单，赞.
讨论群的笔记，赞</div>2024-02-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/29/87/e1/b3edcc09.jpg" width="30px"><span>范飞扬</span> 👍（0） 💬（0）<div>这句话可以修改一下：
不过，你要是以为我会一无所获并浪费时间时，其实到这个项目结束之时，我发现自己已经体会到 Inline、提取方法、提取变量（局部、方法参数、类变量）这些常用的重构手法，并已经能熟练地运用在日常开发中了。</div>2024-02-29</li><br/>
</ul>