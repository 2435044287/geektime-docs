你好，我是李智慧。

秒杀是电子商务应用常见的一种营销手段：将少量商品（常常只有一件）以极低的价格，在特定的时间点出售。比如，周日晚上8点整，开售1部1元钱的手机。 因为商品价格诱人，而且数量有限，所以用户趋之若鹜，在秒杀活动开始前涌入系统， 等到秒杀活动开始的一瞬间，点下购买按钮（在此之前购买按钮为灰色，不可以点击），抢购商品。

秒杀虽然对应用推广有很多好处，但是对系统技术却是极大的挑战：系统是为正常运营设计的，而秒杀活动带来的并发访问用户却是平时的数百倍甚至上千倍。也就是说，秒杀的时候，系统需要承受比平时多得多的负载压力。

为了应对这种比较特殊的营销活动，我们启动了一个专门的秒杀项目，项目代号是“Apollo”。Apollo的核心挑战是：如何应对突然出现的数百倍高并发访问压力，并保证用户只有在秒杀开始时才能下单购买秒杀商品？接下来我们就看看Apollo的需求与技术架构吧。

## 需求分析

Apollo的需求主要有两点。

- **独立开发部署秒杀系统，避免影响现有系统和业务**

秒杀活动只是网站营销的一个附加活动，这个活动具有时间短、瞬间并发访问量大的特点，如果和网站原有应用部署在一起，必然会对现有业务造成冲击，稍有不慎可能导致整个系统瘫痪。
<div><strong>精选留言（22）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/13/71/05/db554eba.jpg" width="30px"><span>👽</span> 👍（29） 💬（3）<div>首先，我个人分析：
大促跟秒杀系统最大的不同在于——秒杀大部份下单请求是被拒绝的。而双十一这种活动，是尽可能将所有请求都受理。否则就会出现损失。
持续时长一般比秒杀业务长，秒杀的高并发可能是几分钟内的，而大促活动，可能持续几小时。
并发数预测大幅度小于秒杀。

基于以上的前提设计系统。
首先，基础架构方面。大促持续时长虽然高于秒杀。但是仍然并非常态。所以，计算资源应该是支持弹性伸缩的。应对大促时，增加服务副本数量，平时将资源释放。
cdn 静态资源缓存的设计可以沿用。
网关层面，根据源IP或者用户控制请求频率。还是之前的问题，秒杀，你可以把处理不了的请求直接拒绝掉，但是大促情况下不可以。损失一个订单，就是一笔收益。所以根据ip或者用户，进行限流。
为了节约短时间内的高并发请求，也可以尝试引入消息队列中间间，将部分请求先受理，排队处理，服务器空闲时候再处理这些业务。

总结一下的话，核心就是：弹性伸缩，资源预留；用户限流，限制请求；短时间高并发，MQ削峰填谷；</div>2022-03-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/21/14/423a821f.jpg" width="30px"><span>Steven</span> 👍（11） 💬（1）<div>双十一这种电商大促场景，不同于秒杀场景，需要尽可能多的满足下单支付需求。

虚拟化技术，容器技术来进行弹性伸缩，大促阶段增加资源，大促结束了释放。
限流、熔断、降级等手段，以保证核心业务的可用性。
MQ用来消峰填谷。
多级缓存，尤其静态资源在CDN要大规模使用。

另，非技术方面，比如：
引导用户提前把要买的物品添加购物车，可以预估流量。
个别商品、商家提前进入大促，也可以分流压力。</div>2022-03-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/ee/c2/873cc8d9.jpg" width="30px"><span>Rick</span> 👍（10） 💬（1）<div>请问一下为什么要使用动态生成js文件的方式来控制按钮点亮。为什么不直接使用http api请求直接从服务器端动态获取控制参数｛是否开始秒杀了，提交请求的随机数等｝。</div>2022-03-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/96/44/886f1d63.jpg" width="30px"><span>华佗救不了你</span> 👍（6） 💬（1）<div>用来下发特殊js的那个接口，虽然占带宽不会高，但是QPS必然很高。而且还随着URL下发了一个随机数，显然这个请求不能简单地走缓存。即使可以走缓存，针对大流量是不是依旧需要部署大量的机器？
老师可以说详细点这个点吗？</div>2022-03-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg" width="30px"><span>neohope</span> 👍（4） 💬（1）<div>电商大促场景：
0、尽早做好各相关团队的沟通，做好活动动员工作
1、业务上分时段大促，不同商品分流，缓解服务器甚至快递小哥压力
2、做好静态资源缓存：浏览器、CDN、服务器缓存
3、根据过往流量、商品浏览量、购物车商品数量，估算大促流量
4、做好扩容和运维保障工作：服务器、带宽、数据库根据预测流量，进行弹性扩容，而且要有一定比例的富余量
5、大促商品信息提前加载redis缓存
6、引入MQ，异步处理订单，消除业务峰值
7、做好PlanB，限流、降级、熔断，保证核心业务稳定
8、网关控制同IP流量，屏蔽部分服务器IP断，防止部分刷单行为
9、提前做好性能测试及压力测试</div>2022-04-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/2a/a9/83684d4a.jpg" width="30px"><span>喆里</span> 👍（3） 💬（1）<div>有个问题详请教下，客户端怎么知道秒杀活动什么时候开始？ （两边的时间可能不一致）
因此，是不是客户端每次刷新，还是会请求到js服务器，秒杀没开始时，响应是空白js；秒杀开始后，返回是真正有用的js ？</div>2022-06-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/76/5e/a8b758a7.jpg" width="30px"><span>子路</span> 👍（2） 💬（1）<div>秒杀更多思考是如何处理请求，库存很少，所以99%的请求都可以被抛弃，甚至它们都请求不到服务器，在网关或者负载阶段就被拒绝了，所以秒杀的服务器并没有承载的压力！</div>2022-04-26</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/1sWUKJBuJdvOPCbp0FAwy43bxOSZ4pUazvv3icb4bcpm2Of8gFluJhyhVuIkIv3eSiaico8umibUrloz9POiapCV3Tw/132" width="30px"><span>Geek_edffd3</span> 👍（2） 💬（1）<div>1.这里url动态化使用接口获取而不是通过js同步更简单？
2.url动态化到底能起到多大作用呢？获取url可以通过脚本刷接口获得，可以更快地感知到活动开始和获取到url，也就意味着可以更早的去下单。所以，它真正起到了什么作用呢？
3.其实，不动态url，可以钓鱼，如果活动开始前调用接口就可以直接拉入黑名单。
4.关于按钮置灰，直接前端简单做个效果就好了，对于一般用户就是灰的，对于非一般用户，接口里面肯定会检验活动开始时间的，没开始也不可能成功的。
老师，希望得到你的答疑解惑，谢谢🙏</div>2022-04-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0e/fc/822a4e75.jpg" width="30px"><span>1angxi</span> 👍（2） 💬（1）<div>19年的时候搞过秒杀，因此场次比较少，所以不需要考虑anti fraud。用了单机限流只让极少流量进入下单逻辑。这里没怎么讲库存扣减的逻辑，这也是一块比较核心的技术点，秒杀超卖是绝对不能接受的。</div>2022-03-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2c/6b/6c/3e80afaf.jpg" width="30px"><span>HappyHasson</span> 👍（2） 💬（2）<div>这里会有一个风险点吧。
定时服务器在生成js脚本和随机值的时刻，想JavaScript服务器集群推消息，如果这时候某一台服务器网络有问题，没收到推送的消息，导致连到这台服务器的用户都看不到活动开始，等看到的时候已经结束了，这种情况玩家体验会很差吧。

是否可以在JavaScript服务集群实例上自己起定时器，生成随机值给到client。随机种子一致，结果一致即可。</div>2022-03-19</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/0Qp9pxHBvgdZAveKzsvUFFUicCJfe7ONzhC7jSNFQDNFvg0jRMXuqqZOdxG1qKosylUYrpIHUR2Q76w5m4HtVkg/132" width="30px"><span>Aaron</span> 👍（2） 💬（1）<div>老师，请教一下，在秒杀活动未开始之前，用户一直用的是缓存中的JavaScript，秒杀开始的时候会生成新的JavaScript，这个时候怎么能拿到可以秒杀的JavaScript？</div>2022-03-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg" width="30px"><span>peter</span> 👍（2） 💬（2）<div>请教老师几个问题啊：
Q1：秒杀系统独立部署，但秒杀是个短暂行为，秒杀结束后秒杀系统的服务器会被其他系统使用吗？（估计是秒杀系统专用吧）
Q2：秒杀系统的服务器规模一般比较小吗？本文中的例子只用了不到三十台服务器，算是比较小的规模了。大厂的秒杀系统其服务器规模大约多少？比如阿里、京东这样的大厂。
Q3：本文中的秒杀系统规模能是为多大规模的用户秒杀设计的？
百万用户在线秒杀？
Q4：秒杀与红包的区别是什么？（后面会讲红包系统吗？）
Q5：浏览器查询自身缓存，是自己的行为还是需要服务器的控制？
Q6：浏览器缓存-》CDN-》服务器，这个顺序是自动形成的？还是在服务器的控制下形成的？怎么控制的？
Q7：定时任务服务器只产生一次javascriot和随机数吗？还是定时产生多次？
Q8：秒杀开始前，秒杀按钮是灰色的，但按钮是在静态页面上，黑客能看到页面代码，那就可以修改页面代码，点亮按钮啊。这不就出现问题了吗？
Q9：服务器没有用tomcat，为什么？
系统用了apache、lighttp、jetty，但没有用tomcat，为什么？
Q10：全局计数服务器是缓存，是用redis吗？</div>2022-03-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/eb/37/a2f4c9f8.jpg" width="30px"><span>starj</span> 👍（1） 💬（1）<div>定时任务产生的javascript怎么保证秒杀开始那一瞬间准时上传？总会有延时的吧，这样秒杀就不是准点开始了</div>2022-03-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/61/c2/1da88a93.jpg" width="30px"><span>今天</span> 👍（1） 💬（1）<div>老师，非常想知道你用的画图软件是什么</div>2022-03-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/0b/73/a04b5d3f.jpg" width="30px"><span>Z.G</span> 👍（0） 💬（1）<div>老师好，有个问题希望能解惑，下单 URL 中会包含一个随机数，服务器收到用户请求的时候，检查请求中包含的随机数是否正确
1. 是个实际意义有多大？机器人可以反复请求这个js文件，同样也能拿到这个随机数吧？
2.服务器如何校验？另外还有一个表来存储随机数吗？</div>2024-04-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/e9/46/a591e965.jpg" width="30px"><span>周建勇</span> 👍（0） 💬（1）<div>需要用户手动来刷新，体验不会很差嘛？换成接口主动定时请求来点亮按钮会有什么挑战呢？只是查询时间判断是否可以开始，这种不会有什么压力吧？</div>2023-12-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg" width="30px"><span>aoe</span> 👍（8） 💬（0）<div>秒杀都是套路，谁认真谁输</div>2022-03-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/20/56/68/2b5ed596.jpg" width="30px"><span>赵惠民</span> 👍（4） 💬（0）<div>给某些用户直接返回秒杀失败，不让他们参加</div>2022-03-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/c2/5c/791d0f5e.jpg" width="30px"><span>易企秀-郭彦超</span> 👍（2） 💬（4）<div>弱弱的问一句是京东吗</div>2022-03-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/d8/42/d4e7a136.jpg" width="30px"><span>有思想的芦苇</span> 👍（0） 💬（0）<div>针对秒杀场景，除了李老师讲到的服务器端限流，是不是还可以考虑在客户端限流，客户端通过简单的算法，只允许很小的一个比例，比如1%的用户，才能向服务器端发起请求js文件或api接口。其他用户只是在等待秒杀结束，到时间后直接客户端重定向到秒杀结束页面。如果用户量足够大，客户端限流算法可以非常简单，不需要非常精确，也可以降低服务器的资源需求。</div>2022-10-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/43/79/18073134.jpg" width="30px"><span>test</span> 👍（0） 💬（0）<div>大促和秒杀不同的点：
1. 持续时间不同。秒杀是几分钟内完成，大促持续几个小时，需要做长时间的用户限流、熔断、降级
2. 商品数量不同，下单子系统等也需要支持高并发，需要做资源自动扩缩容</div>2022-05-01</li><br/><li><img src="" width="30px"><span>CoE极客账号1</span> 👍（0） 💬（2）<div>那个技术专家是你么 ？ </div>2022-03-04</li><br/>
</ul>