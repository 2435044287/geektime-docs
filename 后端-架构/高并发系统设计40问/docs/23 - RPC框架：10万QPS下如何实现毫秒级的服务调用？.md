你好，我是唐扬。

在[21讲](https://time.geekbang.org/column/article/164025)和[22讲](https://time.geekbang.org/column/article/164710)中，你的团队已经决定对垂直电商系统做服务化拆分，以便解决扩展性和研发成本高的问题。与此同时，你们在不断学习的过程中还发现系统做了服务化拆分之后会引入一些新的问题，这些问题我在上节课提到过，归纳起来主要是两点：

- 服务拆分单独部署后，引入的服务跨网络通信的问题；
- 在拆分成多个小服务之后，服务如何治理的问题。

如果想要解决这两方面问题，你需要了解微服务化所需要的中间件的基本原理和使用技巧，那么本节课，我会带你掌握解决第一个问题的核心组件：**RPC框架。**

**来思考这样一个场景：**你的垂直电商系统的QPS已经达到了每秒2万次，在做了服务化拆分之后，由于我们把业务逻辑都拆分到了单独部署的服务中，那么假设你在完成一次完整的请求时需要调用4～5次服务，计算下来，RPC服务需要承载大概每秒10万次的请求。而你该如何设计RPC框架承载如此大的请求量呢？我建议你：

- 选择合适的网络模型，有针对性地调整网络参数优化网络传输性能；
- 选择合适的序列化方式，以提升封包、解包的性能。

接下来我从原理出发，让你对于RPC有一个理性的认识，这样你在设计RPC框架时就可以清晰地知道自己的设计目标是什么了。

## 你所知道的RPC
<div><strong>精选留言（29）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/82/1a/64ec25ff.jpg" width="30px"><span>陈靖</span> 👍（52） 💬（7）<div>先把单服务优化到极致，比一来就上各种乱七八糟的分布式框架靠谱的多</div>2019-11-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8d/c4/6f97daea.jpg" width="30px"><span>长期规划</span> 👍（25） 💬（1）<div>之前搞不懂为什么要搞RPC框架，后来才知道原来还是因为性能问题。我感觉RPC是随着高并发以及系统服务化之后才有了大范围的使用需求。
系统服务化后，一个前端访问会涉及到好多个后端的服务，如果服务间还是HTTP，那高并时，会成为性能的瓶颈之一。
从可维护性，可读性上来说，我感觉RESTful的HTTP协议比RPC更好。但从性能上来说，RPC更好</div>2019-12-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/45/9c/5b06d143.jpg" width="30px"><span>芳菲菲兮满堂</span> 👍（5） 💬（3）<div>一直不太理解rpc和http之间差别有多大 为什么要用rpc呢</div>2020-03-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（3） 💬（1）<div>自己写，造轮子研究学习OK，一般还是使用成熟的方案，这些基本会考虑，业务开发逻辑里怎么优化通常是个大头。比如：数据加解密、数据解压缩、业务逻辑IO和什么存储设备交互、日志怎么打印、业务逻辑的编写是否最优等？</div>2020-04-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/5e/82/438c8534.jpg" width="30px"><span>longslee</span> 👍（3） 💬（3）<div>哈哈哈哈，我居然忘记了我还使用过WebService呢，好古老。
另外，如果系统交互间，纯使用 http RESTful 来调用，这算不算RPC呢</div>2019-11-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/36/2c/8bd4be3a.jpg" width="30px"><span>小喵喵</span> 👍（3） 💬（3）<div>PRC框架只是针对java平台的吗?对于微软的.net平台有rpc框架吗？？</div>2019-11-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0b/78/22410c47.jpg" width="30px"><span>魏春河</span> 👍（3） 💬（1）<div>老师，您文章里面插图是用什么画的？就像RPC调用过程那张图</div>2019-11-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d0/69/5dbdc245.jpg" width="30px"><span>张德</span> 👍（2） 💬（1）<div>老师为啥不推荐dubbo呢  难道是dubbo只支持java系统间的调用吗？？？</div>2019-11-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ca/bd/a51ae4b2.jpg" width="30px"><span>吃饭饭</span> 👍（2） 💬（2）<div>我感觉注册中心相当重要，序列化使用 Hession 也不错。文中提到建议关闭 Nagle 算法，但是我从其它地方看到是不建议这么做的，因为针对 Nagle 算法和延时 ACK 的优化已经非常成熟了，有可能在禁用 Nagle算法之后，性能问题反而更加严重</div>2019-11-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/b8/83/7c1ed918.jpg" width="30px"><span>如歌</span> 👍（0） 💬（1）<div>从网络传输来优化，引出io复用，🙏，自然就想到来nginx 和 redis，老师对吗？</div>2020-03-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6b/f8/b4da7936.jpg" width="30px"><span>大魔王汪汪</span> 👍（0） 💬（1）<div>老师我想问下，rpc框架可以支持泛化调用，那么这种泛化调用和非泛化调用相比是否存在性能问题呢？因为非泛化调用的长链接可以在服务启动时完成建立，而泛化调用长链接调用只能在服务发起时建立，所以应该在链接建立这里耗费时间吧</div>2019-11-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f8/ba/d28174a9.jpg" width="30px"><span>Geek_zbvt62</span> 👍（29） 💬（0）<div>其实tcp_nodelay这问题的原理挺简单的，但很多教程就是把简单问题说得复杂了。作者这种实战派讲解的就简洁易懂</div>2019-11-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6b/f8/b4da7936.jpg" width="30px"><span>大魔王汪汪</span> 👍（7） 💬（6）<div>为什么信号量方式和异步io没有普及呢？</div>2019-11-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/13/92/0b4c8e30.jpg" width="30px"><span>飞翔</span> 👍（5） 💬（2）<div>公司自己实现的rpc框架闭源，我们内部人员都看不到代码😓</div>2019-11-16</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqyicZYyW7ahaXgXUD8ZAS8x0t8jx5rYLhwbUCJiawRepKIZfsLdkxdQ9XQMo99c1UDibmNVfFnAqwPg/132" width="30px"><span>程序水果宝</span> 👍（4） 💬（2）<div>为啥RPC框架在选择高性能的 I&#47;O 模型时不优先使用异步IO多路复用呢，异步IO多路复用的性能不是更好吗？</div>2019-11-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/88/cc/e80845d5.jpg" width="30px"><span>xiaochao321</span> 👍（2） 💬（4）<div>能详细讲解一下http和rpc两者区别么，面试被问到了，为什么一定要用rpc，http也可以实现呀</div>2020-06-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/6c/06/2ac17d5a.jpg" width="30px"><span>yuan</span> 👍（2） 💬（2）<div>为什么常规RPC框架不使用异步IO 或者 信号驱动IO，偏偏选择IO多路复用这种IO模型呢？</div>2020-02-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/77/fd/c6619535.jpg" width="30px"><span>XD</span> 👍（2） 💬（0）<div>论学好操作系统的重要性。。</div>2019-11-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/99/27/47aa9dea.jpg" width="30px"><span>阿卡牛</span> 👍（1） 💬（1）<div>按照老师烧水的例子，明显应该还有个异步非阻塞I&#47;O多路复用模型？</div>2019-11-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4d/fd/0aa0e39f.jpg" width="30px"><span>许童童</span> 👍（1） 💬（0）<div>老师讲得不错。</div>2019-11-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d4/f3/129d6dfe.jpg" width="30px"><span>李二木</span> 👍（0） 💬（1）<div>http 算是rpc框架吗？</div>2022-04-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/49/10/9f702778.jpg" width="30px"><span>积极</span> 👍（0） 💬（0）<div>grpc</div>2021-05-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg" width="30px"><span>夜辉</span> 👍（0） 💬（0）<div>而 Thrift 提供了配 套的 RPC 框架，所以想要一体化的解决方案，你可以优先考虑 Thrift

请问这里的一体化的解决方案是指什么呢？</div>2021-04-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/b8/83/7c1ed918.jpg" width="30px"><span>如歌</span> 👍（0） 💬（0）<div>io复用是提升性能的关键 一句话帮我解决了很多疑惑点</div>2020-03-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/e4/a8/0d8a9cd9.jpg" width="30px"><span>orchardddd</span> 👍（0） 💬（0）<div>逻辑非常缜密！</div>2019-12-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/5d/f8/7de2c1cc.jpg" width="30px"><span>星空123</span> 👍（0） 💬（0）<div>老师 棒棒哒</div>2019-11-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f8/ba/d28174a9.jpg" width="30px"><span>Geek_zbvt62</span> 👍（0） 💬（0）<div>以前系统设计时候允许有空值，且不论这对数据库是否友好，就是在切换序列化框架时候就有问题，有的协议不存在空值这一概念。这就要求在设计时，之前两个服务之间的协议每个字段都要有默认值</div>2019-11-16</li><br/><li><img src="" width="30px"><span>Geek_e986e3</span> 👍（0） 💬（2）<div>老师多路复用也可以用异步。不是很理解单独把异步领出来是什么意思。还有信号量 能举个代码中的例子吗？比如epoll select 这类。我感觉好像都需要信号通知。也可以用异步 所以有点不是很理解你说的五个网络模型</div>2019-11-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/c8/34/fb871b2c.jpg" width="30px"><span>海罗沃德</span> 👍（0） 💬（0）<div>李玥老師的消息對列課程裡也介紹了各種RPC框架，還介紹了各種序列化方式</div>2019-11-15</li><br/>
</ul>