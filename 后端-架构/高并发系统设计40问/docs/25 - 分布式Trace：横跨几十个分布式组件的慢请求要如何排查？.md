你好，我是唐扬。

经过前面几节课的学习，你的垂直电商系统在引入RPC框架和注册中心之后已经完成基本的服务化拆分了，系统架构也有了改变：

![](https://static001.geekbang.org/resource/image/ac/4e/ac71f706f791e6f8d31d30513657534e.jpg?wh=1142%2A741)

现在，你的系统运行平稳，老板很高兴，你也安心了很多。而且你认为，在经过了服务化拆分之后，服务的可扩展性增强了很多，可以通过横向扩展服务节点的方式平滑地扩容了，对于应对峰值流量也更有信心了。

**但是这时出现了问题：**你通过监控发现，系统的核心下单接口在晚高峰的时候，会有少量的慢请求，用户也投诉在APP上下单时，等待的时间比较长。而下单的过程可能会调用多个RPC服务或者使用多个资源，一时之间，你很难快速判断究竟是哪个服务或者资源出了问题，从而导致整体流程变慢。**于是你和你的团队开始想办法如何排查这个问题。**

## 一体化架构中的慢请求排查如何做

因为在分布式环境下，请求要在多个服务之间调用，所以对于慢请求问题的排查会更困难，**我们不妨从简单的入手，**先看看在一体化架构中是如何排查这个慢请求的问题的。

最简单的思路是：打印下单操作的每一个步骤的耗时情况，然后通过比较这些耗时的数据，找到延迟最高的一步，然后再来看看这个步骤要如何优化。如果有必要的话，你还需要针对步骤中的子步骤，再增加日志来继续排查，**简单的代码就像下面这样：**
<div><strong>精选留言（27）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/16/5e/82/438c8534.jpg" width="30px"><span>longslee</span> 👍（62） 💬（11）<div>打开。感谢老师又给我复习来一遍。 调用链追踪是我们项目比较重要的部分，我们才用的是pinpoint，原生是入HBase，我们改造了一份通过队列入ES。 使用感受 pinpoint 对服务的性能负担很小，网络压力也小（udp）。
调用链追踪体现的始终是在服务之间，我们团队又前移了一步，通过JavaScript对XHR对象拦截，产生一个requestID，附在header上，网关透传，改造了下 pinpoint，使接下来的调用都传递这个 requestID，最后存下来的日志有 traceID 和 requestID 组合，那么监控 nginx 日志的时候，就能知道是哪个前端请求发起的问题，甚至知道是哪个按钮触发的，哪个JavaScript方法触发的，是不是很先进哈哈😂</div>2019-11-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0d/2b/4814d3db.jpg" width="30px"><span>阿土</span> 👍（6） 💬（2）<div>对于老旧系统如何引入分布式Trace跟踪呢？不改代码的前提下</div>2019-11-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ca/bd/a51ae4b2.jpg" width="30px"><span>吃饭饭</span> 👍（5） 💬（1）<div>这不就是链路追踪</div>2019-11-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/72/7f/5da093c5.jpg" width="30px"><span>水目沾</span> 👍（4） 💬（1）<div>老师，所有的日志都采集到一起，最终的数据量会不会非常大？一般放在什么样的系统中？</div>2019-11-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（2） 💬（1）<div>思路都是一样，目前公司在用的一个日志分析系统就是这么玩的，不过打印日志需要改造一下，这个有成本。比较倾向于使用方法监控来做分析，对慢请求定位也非常方便，方法调用量、TPS、是否可用、以及其他的聚合信息一目了然，再加上方法调用链的串接慢请求具体位置非常简单就能定位到，而且自己方法的各种信息也一目了然。</div>2020-04-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/1f/e3/e5ddbe55.jpg" width="30px"><span>枫紫深蓝</span> 👍（2） 💬（1）<div>发送到请求体中有什么特定作用吗？请求体本身已经带走当前调用的数据了，将requestId放在请求头中会不会更好？</div>2019-11-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/78/db/825d3b7c.jpg" width="30px"><span>Alex Liu</span> 👍（1） 💬（2）<div>日志采样比例的选择是需要足够业务经验才能做出的决策？还是一般都是按照10%采样？</div>2020-03-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/34/80/30e9ae41.jpg" width="30px"><span>道</span> 👍（0） 💬（1）<div>编译期做切面代码注入，让原来的引用指向代理对象。查阅了下AspectJ,基本是android环境，分布式服务端如何做静态代理</div>2020-06-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/b8/83/7c1ed918.jpg" width="30px"><span>如歌</span> 👍（0） 💬（1）<div>最近在做网关 可能会涉及到追踪的问题 学习一下</div>2020-03-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/af/e6/9c77acff.jpg" width="30px"><span>我行我素</span> 👍（0） 💬（4）<div>记得spring Cloud中就有对应的配置，开启后就能在es中根据requestId追踪日志</div>2020-02-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/43/f7/abb7bfe3.jpg" width="30px"><span>刘冲</span> 👍（0） 💬（2）<div>golang有没有办法不侵入代码，做链路追踪</div>2019-11-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d0/69/5dbdc245.jpg" width="30px"><span>张德</span> 👍（0） 💬（2）<div>老师  请教一下  把日志写入elasticSearch 然后供运维和开发使用的过程  这个是不是就是所谓的ELK??? </div>2019-11-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/39/a8/085f794c.jpg" width="30px"><span>小小</span> 👍（0） 💬（1）<div>老师，有些不明白为啥把request Id放到线程上下文，requestId本身就是私有变量线程安全吧</div>2019-11-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/61/58/7b078879.jpg" width="30px"><span>Julien</span> 👍（0） 💬（3）<div>C++有什么好的切面编程工具吗？</div>2019-11-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/36/2c/8bd4be3a.jpg" width="30px"><span>小喵喵</span> 👍（0） 💬（1）<div>我们以前的系统都是自己写日志到文本文件，或者把日志同步写到mongdb，这样是不是很low？，反正排查问题也比较难。</div>2019-11-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/bd/5f/2fec41b1.jpg" width="30px"><span>杨朔</span> 👍（0） 💬（4）<div>如果日志不打印在本地.发送到消息队列..如果消息队列挂了怎么办？</div>2019-11-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0f/ba/a2531cf0.jpg" width="30px"><span>彭越</span> 👍（7） 💬（1）<div>用skywalking做链路追踪怎么样？通过agent追踪系统性能，进行APM监控</div>2019-11-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a7/b2/274a4192.jpg" width="30px"><span>漂泊的小飘</span> 👍（5） 💬（0）<div>去年年底开发了一个trace系统 没有加日志开关 听了这个课赶快回去加</div>2020-07-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c6/65/64d1eaed.jpg" width="30px"><span>健少</span> 👍（3） 💬（0）<div>我们的日志通过啊里日志系统收集，左日志系统通过丰富的查询方式查询出某一traceID各服务的调用情况。</div>2019-11-20</li><br/><li><img src="" width="30px"><span>小胡</span> 👍（1） 💬（0）<div>RequestID和SpanID生成的逻辑是什么？</div>2021-08-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg" width="30px"><span>aoe</span> 👍（1） 💬（0）<div>Java服务也可以通过MyPerf4J，从入口处找出耗时的方法
GitHub地址：https:&#47;&#47;github.com&#47;LinShunKang&#47;MyPerf4J</div>2020-09-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/39/b6/c8/0f770ac3.jpg" width="30px"><span>青藤之凉</span> 👍（0） 💬（0）<div>分布式的静态代理怎么实现的啊</div>2024-02-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/f1/cc/c25dcc25.jpg" width="30px"><span>楼仔</span> 👍（0） 💬（0）<div>很不错！！！</div>2022-03-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/87/ed/b4b1fd64.jpg" width="30px"><span>禅尔、</span> 👍（0） 💬（0）<div>Jaeger &amp; open tracing</div>2021-04-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/b2/17/3161b49c.jpg" width="30px"><span>达叔灬</span> 👍（0） 💬（1）<div>老师为什么会有I&#47;O操作呢？
我的理解是对于链路追踪应该都是从请求上下文中直接获取对应文信息合并当前服务信息写入请求上下文同时异步的丢到消息队列中。
这里的I&#47;O操作是上下文读写吗？</div>2021-03-24</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLv9HJIW4OACkjlwOQJ9cU7HzvaDFYkACWCib2lzOMef9ZiaGDTVFqjPicpVK5KDRbBRVGGHrMHQO1Rw/132" width="30px"><span>fdconan</span> 👍（0） 💬（2）<div>想请教下，如果A服务并发调用B服务和C服务，spanId如何生成呢？</div>2019-11-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/9f/c8/0318c83e.jpg" width="30px"><span>Geek_b617bf</span> 👍（0） 💬（0）<div>我们用erlang 做的dubbo 调用链耗时采样。貌似也是官方文档支持的。不侵入业务代码靠字节码增强</div>2019-11-20</li><br/>
</ul>