你好，我是唐扬。

我用三节课的时间带你深入了解了缓存，你应该知道对于缓存来说命中率是它的生命线。

在低缓存命中率的系统中，大量查询商品信息的请求会穿透缓存到数据库，因为数据库对于并发的承受能力是比较脆弱的。一旦数据库承受不了用户大量刷新商品页面、定向搜索衣服信息，查询就会变慢，大量的请求也会阻塞在数据库查询上，造成应用服务器的连接和线程资源被占满，最终导致你的电商系统崩溃。

一般来说，我们的核心缓存的命中率要保持在99%以上，非核心缓存的命中率也要尽量保证在90%，如果低于这个标准你可能就需要优化缓存的使用方式了。

既然缓存的穿透会带来如此大的影响，那么我们该如何减少它的发生呢？本节课我就带你全面探知面对缓存穿透时，我们到底有哪些应对措施。不过在此之前你需要了解“到底什么是缓存穿透”，只有这样才能更好地考虑如何设计方案解决它。

## 什么是缓存穿透

缓存穿透其实是指从缓存中没有查到数据，而不得不从后端系统（比如数据库）中查询的情况。你可以把数据库比喻为手机，它是经受不了太多的划痕和磕碰的，所以你需要贴个膜再套个保护壳，就能对手机起到一定的保护作用了。

不过少量的缓存穿透不可避免，对系统也是没有损害的，主要有几点原因：
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/ajNVdqHZLLDuUeF7u9lAY3qmfKSfDBQzCJuveFVyIGE7D1PEI8ZQ1kTScwvRdruYHff0zpEnJWlsYicLlWGvcTg/132" width="30px"><span>小虎</span> 👍（17） 💬（3）<div>讲的很好，很透彻，实用。老师，那么这个过滤器在微服务环境下如何部署比较好？部署好了以后是否也可以起到防止洪水攻击带来的缓存穿透问题？
</div>2019-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/77/b3/991f3f9b.jpg" width="30px"><span>公号-技术夜未眠</span> 👍（30） 💬（4）<div>很实用，很赞</div>2019-10-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/6d/cf/ec335526.jpg" width="30px"><span>jc9090kkk</span> 👍（36） 💬（4）<div>布隆过滤器可以用在一些资讯app的新闻展示中，给用户推送新的资讯用来过滤掉那些用户已经浏览过的记录</div>2019-10-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8d/c4/6f97daea.jpg" width="30px"><span>长期规划</span> 👍（29） 💬（1）<div>老师，为什么会出现大量查询未注册用户的情况呢？是系统被攻击了？</div>2019-10-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg" width="30px"><span>QQ怪</span> 👍（24） 💬（1）<div>老师如何来监控缓存的命中率。</div>2019-10-21</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/LUeuiaxdQ6kZgicd40T2QVGBlRjicrkuA1PXXXZnSO70PM1zVLpicneWDVbiajdkEyZjrGKxd5vJYOCibliax2BLVGhCb2OcPXYeYicJATUwPZoG8Uk/132" width="30px"><span>jun.hai</span> 👍（19） 💬（7）<div>老师您好，请教个问题，文中讲到的缓存穿透跟缓存雪崩是一个概念么？如果不是那缓存雪崩的解决方案是什么呢？谢谢</div>2019-12-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/36/2c/8bd4be3a.jpg" width="30px"><span>小喵喵</span> 👍（17） 💬（2）<div>1.这两节都有提到分布式锁，请问下分布式锁和一般锁的有什么区别呢？
2.缓存适合存放什么样子的数据呢？还是数据库里面的所有数据都可以放入缓存呢？
谢谢</div>2019-10-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7b/98/8f1aecf4.jpg" width="30px"><span>楼下小黑哥</span> 👍（9） 💬（1）<div>布隆过滤器单独部署服务，服务启动时需要初始化数据，将数据库中数据初始化到过滤器中。后续将布隆过滤器定期写到磁盘中，防止服务重启导致丢失。
请教下老师，文中说的布隆过滤器是否如上上面说部署？
</div>2019-10-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f8/ba/d28174a9.jpg" width="30px"><span>Geek_zbvt62</span> 👍（9） 💬（5）<div>bloom filter这个用法会在各种文章教程中提出，但我一直有个疑问想求教一下：基于redis这种存储的bloom filter有没有成熟的方案？因为我觉得毕竟redis不是一种完全可靠的存储，一旦crash理论上有可能丢数据，在用户的那个案例中，一旦应该出现在bloom filter中的数据丢失了，就意味着永远也查不出这个用户来了。那是否我们还应该启动一个监控进程，一旦发现redis crash了，要重新构建bloom filter呢？
回到思考题，我现在觉得文章中的三个方案都只能解决部分场景的问题，有时候需要配合使用。除此之外，合理的数据库连接池大小以及服务限流也能起到最后防线的作用吧？</div>2019-10-21</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTL2Rw8LHaA2A9KdJ3UfQzRX3eIR1wNfUVdQJWwd0nbjVeeibEfjmvzbPiaJZYgYTtqIDgmBtLp9ROmg/132" width="30px"><span>Geek_810a90</span> 👍（6） 💬（1）<div>老师，还是有个疑惑 先查布隆过滤器存在，去查缓存，缓存中失效了或者是刚更新过数据删除了缓存，透过缓存查询数据库，在高并发的情况下，也还是会出现缓存穿透的吧</div>2019-12-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/5e/82/438c8534.jpg" width="30px"><span>longslee</span> 👍（5） 💬（1）<div>对不起老师给您丢脸了，有面试官问到如何避免缓存穿透，我一下懵了，因为我觉得缓存是可以穿透的，结果他意思应该跟您这一节课差不多，我竟然没想起布隆过滤器。</div>2020-07-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/33/5c/8c0a372a.jpg" width="30px"><span>Fourty Seven</span> 👍（5） 💬（4）<div>分布式锁的方案中，有问题吧？如果第二个线程发现有这个key说明有别的线程在加载数据，但是还没有加载完，这个时候读缓存是没有的。</div>2019-11-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/78/e9/9d807269.jpg" width="30px"><span>miracle</span> 👍（3） 💬（1）<div>如果设置缓存key值不过期，是否可以避免狗桩效应呢？
想请教下唐老师 什么场景下不适用于设置不过期的情况，一般频繁更新的场景也不适用缓存吧</div>2019-10-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/13/92/0b4c8e30.jpg" width="30px"><span>飞翔</span> 👍（3） 💬（3）<div>如果布隆过滤器会将集合中的元素判定为不在集合中，那么我们就不们就不确定，被布隆过滤器判定为不在集合中的元素，是不是在集合中。这句话是不是写反了，应该是判定为在集合中，就不能确定到底在不在集合中，因为有hash碰撞的问题</div>2019-10-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/8f/ef/01d9e141.jpg" width="30px"><span>Carl</span> 👍（2） 💬（1）<div>怎么计算缓存命中率</div>2020-02-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8d/c4/6f97daea.jpg" width="30px"><span>长期规划</span> 👍（2） 💬（4）<div>在使用分布式锁时，一个线程拿到了锁，加载数据的过程，另一个线程也来请求会阻塞吧</div>2019-10-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/5e/82/438c8534.jpg" width="30px"><span>longslee</span> 👍（2） 💬（8）<div>打卡。老师你好，请问文中介绍布隆过滤器，提到“使用多个 Hash 算法为元素计算出多个 Hash 值”，这句话怎样理解呢？如果同一个key采用多个Hash算法得出得Hash值基本不一样，那数组下标也不一样，这同一个key对应好几个下标，那跟别的key有大量冲突呀，这时该怎么判断呢。</div>2019-10-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c5/1f/8e9ee163.jpg" width="30px"><span>良记</span> 👍（2） 💬（1）<div>最后这个分布式锁并不是十分理解，如果在数据还没有被缓存到Redis的时候，其他请求查询到了“lock.1”，那么重新取数的时候是等待新数据缓存好了还是说直接拿到空值？</div>2019-10-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a5/67/bf286335.jpg" width="30px"><span>AllenGFLiu</span> 👍（1） 💬（1）<div>老师，如果问题发生的更严重，比如redis 宕机了，导致服务不可用，那应用程序如何处理这种异常？让程序去访问数据库而不是直接报错呢？</div>2020-03-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/56/45/24a5eea7.jpg" width="30px"><span>小河</span> 👍（1） 💬（5）<div>极热点数据的缓存，可以启动线程去监控key的过期时间，在快要过期之前重新加载数据。无需等待缓存过期失效了再去被动加载</div>2020-03-14</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epkttbAibb21Cf4Hvq7ASReEyk5klDhxQulmnrzQWEcqslZ6qhlFf8zw0ZpG8BA65icnz8ianlZVnkFA/132" width="30px"><span>SuperYue</span> 👍（1） 💬（4）<div>老师 布隆索隆器相比回种空值似乎更消耗内存啊，天生的消耗固定空间。而且每次写操作和查询操作，都需要访问布隆过滤器，在性能上似乎说不过去，哪怕是O(1)的，但是硬多出一次网络io啊。我更站回种空值，也不需要布署过滤器和考虑过滤器的算法可靠性和服务器可以性。老师你在公司里哪种用得更多呢</div>2020-03-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5f/e5/54325854.jpg" width="30px"><span>范闲</span> 👍（1） 💬（2）<div>缓存这部分存储的数据不需要预热么？</div>2020-03-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/6c/06/2ac17d5a.jpg" width="30px"><span>yuan</span> 👍（1） 💬（2）<div>布隆过滤器判断这个元素不在集合中时，它一定不在集合中。
___________________________________________________

假如有用户A、用户B，他们在布隆过滤器中的位置相同。A在不数据库中，布隆过滤器中A对应的值是0，B在数据库中，然后查询B是否存在，那么返回0（不存在），实际上是存在的。 如果发生这种情况，不就和上面那句话对不上了吗？</div>2020-02-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/97/3b/c98b68c1.jpg" width="30px"><span>AngryApe</span> 👍（1） 💬（2）<div>你想，如果布隆过滤器会将集合中的元素判定为不在集合中，那么我们就不确定被布隆过滤器判定为不在集合中的元素是不是在集合中。假设在刚才的场景中，如果有大量查询未注册的用户信息的请求存在，那么这些请求到达布隆过滤器之后，即使布隆过滤器判断为不是注册用户，那么我们也不确定它是不是真的不是注册用户，那么就还是需要去数据库和缓存中查询，这就使布隆过滤器失去了价值。
-------
这一段完全是错误的，建议尽快修正，不要影响到后面的读者了</div>2020-02-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/20/08/bc06bc69.jpg" width="30px"><span>Dovelol</span> 👍（1） 💬（1）<div>老师好，想问一下，关于热点缓存失效后有大量并发请求穿透到数据库去查询，这种如果用分布式锁，没有拿到锁的请求直接返回或者在查缓存都可能得到错误或者无效的结果，是不是应该等待拿到锁的查询到数据写入缓存后在去查呢？？这样有大量请求阻塞，会不会对系统造成压力。还有就是对于所有用户都读取同一份的缓存，比如排行榜，可以用定时任务在缓存失效前去更新缓存，这种方案怎么样呢？</div>2019-10-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5f/e5/54325854.jpg" width="30px"><span>范闲</span> 👍（0） 💬（2）<div>缓存部分其实有缓存击穿、缓存穿透和缓存雪崩这三种场景.
缓存击穿是某些热点key，在某些时间点被高并发访问
缓存穿透是指大量查询一定不再缓存中的key，从而导致db压力较大情况
缓存雪崩实际上是指大量key同一时间过期，导致请求流向后端db~</div>2020-06-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/cc/25/8c6eab2c.jpg" width="30px"><span>ArtistLu</span> 👍（0） 💬（1）<div>老师算大小写出每一个被除数真的很赞👍🏻</div>2020-05-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（0） 💬（1）<div>虽然，自己有对缓存穿透、击穿、雪崩的理解，也建议老师能对于这种相似的概念，弄个二维表对比讲解，这样就更清楚了。狗桩效应和击穿很相似就更需要对比讲解了，缓存穿透的解决思路基本就是回种特殊值和加过滤器了，我们基本用回种特殊值，毕竟空间相对便宜。</div>2020-04-25</li><br/><li><img src="" width="30px"><span>林腾</span> 👍（0） 💬（1）<div>老师好，有个疑问请教一下，如果出现狗桩效应，采用分布式锁的话，数据库加载到缓存是需要一定时间的，这时候没有拿到锁的请求是阻塞的状态直到获取缓存中的数据才返回么?</div>2020-04-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/2e/39/7682b49e.jpg" width="30px"><span>lofaith</span> 👍（0） 💬（1）<div>老师，启动后台线程更新数据到缓存中，如果这时候有请求过来直接返回，返回什么呢，直接返回空值吗</div>2020-03-28</li><br/>
</ul>