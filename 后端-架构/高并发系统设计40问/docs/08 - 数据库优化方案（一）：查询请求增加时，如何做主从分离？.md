你好，我是唐扬。

上节课，我们用池化技术解决了数据库连接复用的问题，这时，你的垂直电商系统虽然整体架构上没有变化，但是和数据库交互的过程有了变化，在你的Web工程和数据库之间增加了数据库连接池，减少了频繁创建连接的成本，从上节课的测试来看性能上可以提升80%。现在的架构图如下所示：

![](https://static001.geekbang.org/resource/image/26/90/2643e13598139d0964bfc40469bd8390.jpg?wh=1142%2A915)

此时，你的数据库还是单机部署，依据一些云厂商的Benchmark的结果，在4核8G的机器上运行MySQL 5.7时，大概可以支撑500的TPS和10000的QPS。这时，运营负责人说正在准备双十一活动，并且公司层面会继续投入资金在全渠道进行推广，这无疑会引发查询量骤然增加的问题。那么今天，我们就一起来看看当查询请求增加时，应该如何做主从分离来解决问题。

## 主从读写分离

其实，大部分系统的访问模型是读多写少，读写请求量的差距可能达到几个数量级。

这很好理解，刷朋友圈的请求量肯定比发朋友圈的量大，淘宝上一个商品的浏览量也肯定远大于它的下单量。因此，我们优先考虑数据库如何抵抗更高的查询请求，那么首先你需要把读写流量区分开，因为这样才方便针对读流量做单独的扩展，这就是我们所说的主从读写分离。

它其实是个流量分离的问题，就好比道路交通管制一样，一个四车道的大马路划出三个车道给领导外宾通过，另外一个车道给我们使用，优先保证领导先行，就是这个道理。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/4f/b2/1e8b5616.jpg" width="30px"><span>老男孩</span> 👍（60） 💬（5）<div>我觉得进入演进篇以后干货越来越多了。关于理论基础大家都能泛泛的谈一谈，可具体落地实操，老师的经验和能力就体现出来了。关于读写分离，主从同步延时出现的诡异现象，我之前也遇到过。我之前项目最开始没有只是配置了2个数据源，由开发人员选择写主库，读存库。后来发现很多读操作也放到主库上了，理由就是在一些场景下会出现诡异的数据不一致。于是，使用了mycat做代理，开发是比以前方便了，但诡异问题依然存在，又换成了atlas，还是不行。就如同老师说的一样，在没有完全深入了解组件的情况下贸然使用，本来是玩组件，结果被组件玩了。没办法，只好把查询放到一个事务里边，这样代理就会去主库中执行，但这样无异于还是增加的主库的压力。老师在专栏中提供基于消息队列和缓存的方案给我很好的启发，期待后续更多干货。</div>2019-10-09</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Cib5umA0W17N9pichI08pnrXAExdbyh7AVzH4nEhD6KN3FXuELk4LJJuqUPPD7xmIy9nq5Hjbgnzic7sVZG5BKiaUQ/132" width="30px"><span>被过去推开</span> 👍（33） 💬（11）<div>老师你好，我以前想要给公司分库分表，后来觉得有几个问题放在我面前，就搁浅了，现在只是挂了一个从库。
最主要的问题：我们公司每天产生许多业务订单，如果以用户id进行hash计算，分发到不同的库，对前台用户订单查询有利，但后台系统页面需要查看全部订单，以倒序排列，这样子的sql会不会执行很慢，毕竟是订单分散到几个库了。老师有好的分库分表方案吗？</div>2019-11-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/65/7b/66b9befd.jpg" width="30px"><span>Hwan</span> 👍（24） 💬（3）<div>老师，为啥优先读写分离，然后再缓存呢，是从那方面考虑的呢</div>2019-10-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/84/39/c8772466.jpg" width="30px"><span>无形</span> 👍（22） 💬（3）<div>之前发生过的一个问题，用Redis主从同步，写入Redis的数据量太大，没加频次控制，导致每秒几十万写入，主从延迟过大，运维频频报警，在主库不挂掉的情况下，这样大量写入会不会造成数据丢失？</div>2019-11-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/8a/f4/fbbe4601.jpg" width="30px"><span>_Axios丶靜ﻩ</span> 👍（20） 💬（1）<div>老师你好数据库的qps可以使用什么工具来监控</div>2019-10-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/9a/3c/bec9891a.jpg" width="30px"><span>metasearch</span> 👍（19） 💬（5）<div>总结
1 主从原理：主库通过同步binlog到从库，relaylog去读
2 从库有延迟可以通过缓存 冗余数据来解决
3 4核8g TPS  500 QPS 10000</div>2019-10-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7f/ca/ea85bfdd.jpg" width="30px"><span>helloworld</span> 👍（16） 💬（6）<div>给主从复制增加延迟告警的思路很好，另外，老师能具体讲解下QPS和TPS的区别？网上查询了很多资料没有权威的解释。感谢！打卡08</div>2019-10-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/10/e8/172b5915.jpg" width="30px"><span>张珂</span> 👍（8） 💬（6）<div>老师你好，我想讲我之前的一个面试，面试官问存储层的高可用怎么搞。

我是这么回答的：存储用最熟悉的MySQL，架起主备，主备前用keepalive + VIP漂移，可以达到秒级切换。主从复制选用半同步复制，保证数据从binlog传输到备库后再返回请求。当主库发生异常时，需要切换，但需要备库应用完本地的relay log后才能成为主库。在这之前不能写，读的话会有少量不一致性。

面试官说：半同步复制可能延时有点大，而且你还相当于“停服”了。说说改成异步复制呢？

我针对异步复制，先分析了一下当主库挂的时候，可能会丢失一些数据。这个时候可以立即切换到备库成为主库，但影响是原主库挂之前一些提交的事务都丢失了，对于业务来说可能表现成用户做了某件事但结果却没做，比如支付了订单但后来发现没有该订单，而且余额也没少。这个时候要做好产品上的公告，表明事故以及让用户重新支付等。而且原主库要做好binlog上跳过那些跟原备库（现在的主库）不一致的部分。但这个方案依然需要等待备库应用完本地的relay log完毕才能切，只要没有长事务，一般很快。

面试官又在更高机房的层次上，提出让我设计一个方案，做到一定的“可伸缩”性，。比如A机房挂了，流量切到B机房，机房可以做到一变二，二变三等，这个时候系统的实战细节等。

这个地方我实在缺乏经验，我的回答是这样的：如果启用多个机房分别服务不同的用户群，想要达到流量切换，势必需要互相同步数据，但这里有个时间窗口不一致的问题，如果A机房挂了，马上切给B，依然采用刚才的思路，没有同步过来的数据算作“没有产生过”，业务有损。这样起码可以保证数据本身的一致性。

上面的三条回答面试官有些不满意，就结束了面试。老师您能帮我看看评价一下我的回答，看是否还有更好的方案？

</div>2020-01-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/39/fe/99465085.jpg" width="30px"><span>Adrian</span> 👍（8） 💬（2）<div>文章里说通过冗余数据来解决主从延迟的问题，我有些异议，这种方式会造成缺乏扩展性，消息承载的数据很多消息组件都会有字节大小的限制，这样的话，如果后续数据量随着业务进行了扩展，就难免不会产生问题，持续扩展能力相对较差，我的理解倒是可以通过消息重试的方式来解决这个问题，如果主从同步延迟，那就消息重试，直到数据同步过来即可，这种解决方案通常业务上也是能忍受的，当然还是要按照具体case具体分析</div>2019-12-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/94/55/afc64956.jpg" width="30px"><span>三年过后</span> 👍（8） 💬（1）<div>老师讲得很好！案例说到主从的延迟时间预警，未能详细到如何通过哪个数据库中的哪个指标来判别？经验中，我记得是，在从从库中，通过监控show slave status\G命令输出的Seconds_Behind_Master参数的值来判断，是否有发生主从延时。这个参数值是通过比较sql_thread执行的event的timestamp和io_thread复制好的 event的timestamp(简写为ts)进行比较，而得到的这么一个差值。   但是，问题来了，如果复制同步主库bin_log日志的io_thread线程负载过高的话，那么，Seconds_Behind_Master这个值就一直处于0。也是无法预警的，确切地说，通过Seconds_Behind_Master这个值来判断延迟是不够准确的。 不知，还有其他更好的方式？</div>2019-10-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/5e/82/438c8534.jpg" width="30px"><span>longslee</span> 👍（5） 💬（2）<div>“在 4 核 8G 的机器上运 MySQL 5.7 时，大概可支撑 500 的 TPS 和 10000 的 QPS”，老师，可以介绍下，挂了几个读库后（比如3个），同样的机器配置，QPS能上升到多少？</div>2019-10-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/5a/ea/c034661d.jpg" width="30px"><span>🍚🐔🐢</span> 👍（5） 💬（4）<div>主库宕机之后，binlog丢失导致的主从数据不一致是不是只能手动恢复？</div>2019-10-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/9c/35/9dc79371.jpg" width="30px"><span>你好旅行者</span> 👍（5） 💬（6）<div>请问一下来时，通过缓存来抗住高并发的读请求和通过MySQL的读写分离来抗高并发他们之间的区别在哪里呢？分别有哪些适用的场景？</div>2019-10-09</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKoTDBX4a5u3Oc0zDpKDp6UbcYDcwAJXfBSmicqQwoyxaoVLEWzjIoUqYBiaDJHAYkO8icLtXqk4ibqKg/132" width="30px"><span>xu晓晨</span> 👍（3） 💬（1）<div>个人感觉中间件不是什么地方都需要高可用 得看具体的业务场景。大多的缓存场景 并发不是很高的话 可以容忍暂时穿透查库。但是一些涉及到业务逻辑的地方 就必须高可用了</div>2019-10-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/15/27/c5e4ec99.jpg" width="30px"><span>哇哦</span> 👍（3） 💬（2）<div>主从分离的，如果主节点写入sql,后面同步到从节点，那个时候，从节点实际上即在执行写，也在支持读。那主从分离的作用是保证主节点正常写？其他从节点只是通过增加机器来分担读数据io吗</div>2019-10-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（2） 💬（2）<div>嗯，凡是需要通过冗余数据的方式来实现数据高可用的存储系统都需要数据复制技术，基本也都是通过日志的方式来实现的，当然日志的存在形式可能会有所变化。
数据复制最难的就是，数据的一致性问题，由于物理规律的限制必然存在数据同步延迟问题，只是站在用户的角度有些是无感知有些可能是不能忍受的。
主从延迟这个现象需要多加注意，否则有些现象解释不通会觉得非常诡异，主从延迟的时间最好监控起来，在不可接受范围内进行预警。</div>2020-04-06</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/jXbwicoDwia7ooDfwBTRyvNYQkefnVwF1CMicMS8FqKfuFAdvVZo2pqc4ic0R9kSdHTIxaE6YyqxwX8BdNGv5PqSIw/132" width="30px"><span>kamida</span> 👍（2） 💬（1）<div>老师 您提到访问主从数据库有两种方式 能讲一下他们是怎么处理数据源的动态变化的吗 比如我们新加了一个从库</div>2020-03-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/8a/2a/f94db4dc.jpg" width="30px"><span>JoJi</span> 👍（1） 💬（1）<div>老师，我看这几个中间件功能都一大堆。如果仅仅是考虑读写分离的情况，易用性和稳定性优先，推荐选择什么呢?</div>2020-08-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/56/09/4a9d4a35.jpg" width="30px"><span>zj坚果</span> 👍（1） 💬（2）<div>老师，在哪可以看到不同数据库在什么样的服务器有多少QPS和TPS的数据，能否分享下
</div>2020-04-28</li><br/><li><img src="" width="30px"><span>林腾</span> 👍（1） 💬（1）<div>老师好，redis主从复制也存在延迟情况，如果写入redis更新缓存对象的瞬间又读取redis的同样的对象，是可能存在读不到的情况？目前jedis和redisTemplate的api有屏蔽这一点么？</div>2020-04-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/d0/4d/2116c1a4.jpg" width="30px"><span>Bravery168</span> 👍（1） 💬（2）<div>优先使用读写分离，然后再考虑缓存。
----这个我觉得还是得从业务规模和场景考虑，如果访问的热点集中于某一部分数据，且变动不频繁，直接用缓存会不会好些，毕竟并不一定需要把所有的数据都做一份拷贝到从库。
</div>2020-03-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/48/9a/d8309354.jpg" width="30px"><span>benjamin.lee</span> 👍（1） 💬（3）<div>主从分离，一个主不能挂无限多的从，一般是3-5个从库，那是不是意味着主从分离方案，从水平扩展上只能达到这种规模，再往上扩就受限了？主从分离的方案，数据库的集群大小就很有限了，很容易达到性能瓶颈？</div>2019-12-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/4d/42/8fd7c2e2.jpg" width="30px"><span>朋朋</span> 👍（1） 💬（1）<div>写入到 HDFS 中文件也会被复制到多个 DataNode 中。只是不同的组件对于复制的一致性、延迟要求不同，采用的方案也不同。 这句话 是HDFS中间件 还是中文件？ 我有点读不通顺</div>2019-12-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/9c/35/9dc79371.jpg" width="30px"><span>你好旅行者</span> 👍（1） 💬（1）<div>那请问老师缓存和主从分离可以一起使用吗？有没有什么场景？</div>2019-10-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/51/a2/4fc7df75.jpg" width="30px"><span>呆梨</span> 👍（1） 💬（1）<div>log dump 的线程发送的binlog和从库读取的binlog是什么关系啊</div>2019-10-11</li><br/><li><img src="" width="30px"><span>兢</span> 👍（1） 💬（3）<div>主从复制延迟问题，缓存的解决方案。网上有看到这种解决方案保证数据一致性，先更数据库后更缓存，用事务控制，失败了回滚。</div>2019-10-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/61/58/7b078879.jpg" width="30px"><span>Julien</span> 👍（1） 💬（5）<div>2. 主从的延迟问题，很多诡异的读取不到数据的问题都可能会和它有关，如果你遇到这类问题不妨先看看主从延迟的数据。

请问一下，如果出现了延迟较大导致从库读不到数据，怎样在代码层面一劳永逸地解决呢？谢谢老师～</div>2019-10-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/36/2c/8bd4be3a.jpg" width="30px"><span>小喵喵</span> 👍（1） 💬（1）<div>我有两个问题：
1.主从延迟的问题，如何知道主从延迟，是否有这样的工具来监控并查看每一条Sql的延迟情况，如果延迟超过设定值（比如2s）就自动报警。请老师介绍一下？
2.关于掌握原理的问题，高级程序员或者架构师都必须要掌握好原理，以便于更好的使用和把此方案运用于其他问题中，老师能否把原理讲解的更加透彻一点，比如主从复制的过程能否用代码来实现（哪怕是伪代码）。</div>2019-10-08</li><br/><li><img src="" width="30px"><span>Geek_e986e3</span> 👍（1） 💬（1）<div>老师想问问 如果读比写多 一般怎么处理的呢？</div>2019-10-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/9f/c8/0318c83e.jpg" width="30px"><span>Geek_b617bf</span> 👍（1） 💬（3）<div>一个主库挂多个从库,读取数据的时候一般怎么确定某个数据在哪个从库里呢?  还是说都扫描一遍? </div>2019-10-04</li><br/>
</ul>