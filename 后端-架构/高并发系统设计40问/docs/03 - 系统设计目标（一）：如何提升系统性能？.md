提到互联网系统设计，你可能听到最多的词儿就是“三高”，也就是“高并发”“高性能”“高可用”，它们是互联网系统架构设计永恒的主题。在前两节课中，我带你了解了高并发系统设计的含义，意义以及分层设计原则，接下来，我想带你整体了解一下高并发系统设计的目标，然后在此基础上，进入我们今天的话题：如何提升系统的性能？

## 高并发系统设计的三大目标：高性能、高可用、可扩展

**高并发，**是指运用设计手段让系统能够处理更多的用户并发请求，也就是承担更大的流量。它是一切架构设计的背景和前提，脱离了它去谈性能和可用性是没有意义的。很显然嘛，你在每秒一次请求和每秒一万次请求，两种不同的场景下，分别做到毫秒级响应时间和五个九（99.999%）的可用性，无论是设计难度还是方案的复杂度，都不是一个级别的。

**而性能和可用性，**是我们实现高并发系统设计必须考虑的因素。

性能反映了系统的使用体验，想象一下，同样承担每秒一万次请求的两个系统，一个响应时间是毫秒级，一个响应时间在秒级别，它们带给用户的体验肯定是不同的。

可用性则表示系统可以正常服务用户的时间。我们再类比一下，还是两个承担每秒一万次的系统，一个可以做到全年不停机、无故障，一个隔三差五宕机维护，如果你是用户，你会选择使用哪一个系统呢？答案不言而喻。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/13/f0/f4/22dbe2d9.jpg" width="30px"><span>肖大保健</span> 👍（190） 💬（10）<div>讲的太宽泛了，请具体实例化，这种文章在网上到处能找到，建议多点干货</div>2019-09-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg" width="30px"><span>Jxin</span> 👍（129） 💬（10）<div>1.业务价值-&gt;承载高并发-&gt;性能优化。一切的前提是业务价值需要。如果没有足够的价值，那么可读性才是第一，性能在需要的地方是no.1，但不需要的地方可能就是倒数第一稞。当下技术框架出来的软件差不到哪去，没有这种及时响应诉求的地方，削峰下慢慢跑就是了。（工作需要，常在缺少价值的地方着手性能优化，让我对这种就为个数字的操作很反感。要知道，异步，并发编程，逻辑缓存，算法真的会加剧系统的复杂度，得不偿失。如果没那个价值，简单才是王道）

2.提高并发度。要么加硬件，要么降低服务响应时间。做为开发，我们的目光更聚焦在降低响应时间这块。
1.采用非阻塞的rpc调用（高效的远端请求模式，采用容器的覆盖网络我认为也算）
2.将计算密集和io密集的的逻辑分割开，单独线程池，调整线程比例压榨单机性能（或者说找拐点）。
3.做缓存，io耗时的缓存和计算耗时的缓存（多级缓存，数据压缩降低带宽）。
4.采用享元模式，用好对象池和本地线程空间，尽量减少对象创建与销毁的开销，提高复用。
5.业务拆分，像状态变化后的外部系统通知，业务监控，es或solr等副本数据同步等操作，无需在主流程中做的事都拆掉。走canal监听表数据变化，推mq保最终一致的方式从业务项目完全解偶出来。
6.fork_join，分而治之的处理大任务。并发编程，采用多线程并行的方式处理业务。（规避伪共享，减小锁力度，采用合适的锁）。
7.数据库配置优化，查询优化。（存储优化比较头疼，毕竟不按业务拆单点跑不掉，单点性能就要命。基本只能内存库先行，后台同步数据做持久。然后内存库多副本，自修复，保留一系列自修复失败的修复手段）</div>2019-09-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/70/1f/15e5356b.jpg" width="30px"><span>平步青云</span> 👍（45） 💬（1）<div>既然老师愿意把这门课做好，作为学员提几点建议：
1.每一章都会有一个中心，几个侧重点，建议关键部分文字加粗或者字号加大一点，让重心更醒目。一遍看下来，几乎啥都没记住。
2.条理清晰，有时候你会发现，用1.2.3这种编号作用非常明显。这点得到做的挺好的，我都购买的有课程。
3.技术文章，理论讲太多，都觉得是鸡汤，看了就忘，或者说作用不大，理论大家能查阅资料，也算是理解一星半点。大家的问题都在于没把理论作用于实践中，如果每一章讲完理论后能够以实际应用辅助讲一下，可以说事半功倍。
4.我说话很直接，真正的高手也不会购买课程，购买课程的也是大家在这块有短板，希望通过这门课解决一些项目中的问题。按照2&#47;8原则，百分之八十的人项目中都没有大并发，这种系统设计和运用，大家缺乏经验。讲解时候，浅显易懂，案例分享很关键，百分之八十人看懂了，能应用了，那这门课非常成功了。
5.希望高手之间多讨论或者辩论，其实在你们的讨论中，可以学到很多，开拓视野，举一反三。希望评论中只要不是骂人，违反国家政策，涉及到问题本身讨论的，尽量显示出来。</div>2019-09-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/84/39/c8772466.jpg" width="30px"><span>无形</span> 👍（37） 💬（14）<div>之前做广告检索遇到的问题，倒排索引存在Redis，每次都要请求Redis，但是并发时，Redis连接数太大，甚至打开文件数过大，后采用Redis连接池，Redis连接数得到控制，而且响应更快，后来随着并发数的增大，连接池资源耗尽，而且Redis也有并发限制，数据传输导致大量占用带宽，响应时间更久，因此，又使用了本地缓存，每次请求先请求本地缓存，找不到再请求Redis，缓存到本地，缓存更新时通过消息队列来通知程序更新本地缓存，这样节省了大量的和Redis之间的请求耗时和带宽占用，性能有了数倍的提升。后面还有很多优化，性能优化不是一蹴而就的，每个阶段面对的场景是不一样的，需要找到每个瓶颈点针对性的优化</div>2019-10-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/4c/4e/91267714.jpg" width="30px"><span>Cola_</span> 👍（26） 💬（2）<div>高并发：高性能（响应时间）、高可用（down机、故障、维护）、可扩展（应急扩容）
响应时间（平均值、最大值、分位值），响应为1s，吞吐量为每秒1次，响应缩短到10ms，吞吐量上升到每秒100次，从用户体验来说：200ms分界点，1s为另一个分界点，健康系统的99分位值的响应时间控制在200ms以内，不超过1s的请求占比要超过99.99%
高并发下的性能优化手段：
1.提高系统的处理核心数（吞吐量=核心数(并发进程数)&#47;响应时间(s)）
  但并非无限增加核心数就可以增加吞吐量，随着进程数增加，并行的任务对于资源的争夺也增加，在某 
  个临界点，进程增加导致系统的性能下降，这就是性能测试中的拐点模型，所以在评估系统性能时，需要做压力测试，找到拐点
2.减少单次任务响应时间
cpu密集型：优化算法
io密集型：1.采用工具，linux的工具集
              2.通过监控，对任务的每一个步骤做分时统计，从而找到任务中哪一步小号消耗了更多的时间


</div>2019-09-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（20） 💬（3）<div>哈哈，看评论“真正的高手也不会购买课程”，扎心啦！😄，不过事实也应该是如此的。
我猜测一下，真正的高手在干嘛！
第一技术负责人，负责一些核心项目
第二技术专家，写书出专栏
第三开源项目贡献者，参与和贡献过知名的开源项目
第四技术社区或知名项目的领导者
第五知名公司CTO，在用技术改变世界
第六技术大神一门语言或一个框架的开创者
不过根据2&#47;8原则，猜测80%的人都不在这个范围内，这就是极客时间存在的意义。
我想表达啥呢？极客时间对我帮助还是非常大的，我也从业多年，不过比较遗憾没到高手的行列。技术是我养家糊口的工具，跟一些作者年龄相近实力却相差甚远，花几十元和他们聊聊，基本收获都是大于付出的钱的。相信极客时间的过滤功能，希望自己能够早日不用再购买课程。😅
</div>2020-04-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/6d/e9/3e1c559a.jpg" width="30px"><span>星星</span> 👍（13） 💬（2）<div>老师你好，高并发 有什么好的模拟工具？</div>2019-09-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8d/c4/6f97daea.jpg" width="30px"><span>长期规划</span> 👍（7） 💬（1）<div>从全局看，高性能需要全链路检查，常用方法是拆分，精简，换硬件等。拆分如读写分离，分片等，精简如进程→线程→协程，HTTP→RPC，换硬件如内存替换硬盘等。从编程角度，还可以使用合适的数据结构和算法</div>2019-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/6b/84/d1e6eac9.jpg" width="30px"><span>sun</span> 👍（7） 💬（3）<div>日常工作中，项目优化的不够好，那就对部门进行优化⁽⁽ଘ😇ଓ⁾⁾</div>2019-09-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ca/bd/a51ae4b2.jpg" width="30px"><span>吃饭饭</span> 👍（7） 💬（1）<div>
老师能普及一下常见的术语吗？比如 QPS 和 TPS。日常优化不从服务器谈，只说 Review 的一些常识，避免循环调用，热点数据提前预热，可以加入利用内存缓存一些配置数据等等，不知道理解的对不对：）</div>2019-09-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/01/37/12e4c9c9.jpg" width="30px"><span>高源</span> 👍（6） 💬（2）<div>从小到大从浅入深，老师我最想知道的是开发的系统如何找出程序瓶颈，问题具体出现在哪，用什么工具或者方法解决了，从而在后期有机会设计高并发高可用系统的时候根据实际情况来下手</div>2019-09-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/a4/27/15e75982.jpg" width="30px"><span>小袁</span> 👍（5） 💬（1）<div>大家不要觉得虚，看这些理论的时候，多想想自己负责的系统犯过什么傻逼的问题就能举一反三。适逢公司的架构不够用，我先过来重温一下这些理论再考虑优化。</div>2020-03-01</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEKms5faiaqcTQ0fmqZoAfsVPeZQYZib7CIWJfLCvSLWia1XaoNGpP2M9G2woDdvaIVUYfWPBJa8nLs9A/132" width="30px"><span>Geek_Rex</span> 👍（5） 💬（1）<div>请问通过什么工具可以测试WEBAPI的响应时间？</div>2019-09-24</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erbY9UsqHZhhVoI69yXNibBBg0TRdUVsKLMg2UZ1R3NJxXdMicqceI5yhdKZ5Ad6CJYO0XpFHlJzIYQ/132" width="30px"><span>饭团</span> 👍（5） 💬（3）<div>嗯，老师说的数据优先，我觉得最重要！一切的优化前提都是在数据的支撑下进行！请问老师一般系统的性能指标都问怎么统计？
比如最大响应时间，平均响应时间！分位值统计方式，我们可以在请求开始和请求返回时做时间统计！写入log之后定时分析log得到！
系统cpu指标，内存指标，io指标这种是定时通过系统函数获取信息统计吗？
其实我想问老师的是，一般高并发系统都统计系统的哪些指标？</div>2019-09-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7b/b8/6f47ba1b.jpg" width="30px"><span>Maxwell</span> 👍（3） 💬（1）<div>老师，在高并发时涉及到要更改公用的值，考虑到数据库的并发量的瓶颈，采用缓存来抗并发，但此时数据一致性的保证一般什么方案？</div>2019-09-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/64/15/9c9ca35c.jpg" width="30px"><span>sipom</span> 👍（2） 💬（1）<div>代码层：采用高效算法，避免低效代码；应用层：多线程&#47;多进程并发；数据库&#47;缓存：分库分表并发；系统层：多节点、多套系统并发&#47;负载均衡</div>2020-03-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/4b/4b/97926cba.jpg" width="30px"><span>Luciano李鑫</span> 👍（2） 💬（1）<div>“我们通常使用吞吐量或者同时在线用户数来度量并发和流量，使用吞吐量的情况会更多一些。但是你要知道，这两个指标是呈倒数关系”
这个地方是不是有问题，吞吐量和在线用户数是倒数关系？？
</div>2019-09-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/9b/c8/665100a3.jpg" width="30px"><span>周曙光爱学习</span> 👍（1） 💬（1）<div>90分位值指的是每次采样处于第90位的平均值吗？？</div>2020-03-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/f0/49/889f9ef6.jpg" width="30px"><span>M</span> 👍（1） 💬（2）<div>老师问一下，目前做线上压测有什么工具吗，或者通常用什么方法来做呢？</div>2019-11-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/34/21/11cf22de.jpg" width="30px"><span>虫子</span> 👍（1） 💬（2）<div>老师，一个系统支持的并发数峰值通常如何估算？如果通过nginx增加负载均衡后，提升多少，又如何估算?</div>2019-10-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/5e/82/438c8534.jpg" width="30px"><span>longslee</span> 👍（1） 💬（1）<div>思考时间：老师我们目前还是传统项目，所以瓶颈大部分在数据库上（即使是分布式，通过对调用链监控，发现对单体方法也以SQL问题居多），基本上解决了top SQL就能好一大半，而top SQL又大多是表关联之间和索引的优化；也有特例，咱们选用Java，对JVM监控也能看出一些问题，比如锁争用太高限制线程数增加的吞吐量增加。最后，咱还可以从业务着手，通过数学推演，减少不必要的环节。</div>2019-10-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/47/ae/0a5f7a56.jpg" width="30px"><span>此方彼方Francis</span> 👍（1） 💬（1）<div>支持一下老师，个人觉得，做事情，知道怎么做是一回事儿，知道这么做背后的指导思想又是另外一回事。</div>2019-09-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/ed/c9/9abdd4c6.jpg" width="30px"><span>大雄</span> 👍（1） 💬（1）<div>提高系统核数就从硬件角度出发，应该可以包含两方面:一是单纯地将单台服务器由1核变为多核，垂直扩展；也可以是部署负载均衡集群，进行水平扩展。</div>2019-09-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/a3/b8/00976fb7.jpg" width="30px"><span>糖包</span> 👍（1） 💬（2）<div>老师，麻烦问下分布式架构下分布式事务是需要怎么处理，有好的成熟的框架可以采用么？</div>2019-09-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/99/3b/791d0f5e.jpg" width="30px"><span>王先森</span> 👍（0） 💬（1）<div>老师问个问题，我们公司之前是用rpc方式调用其他端接口，现在全部迁移为http方式，网上查到的全部是说http调式简单，rpc定位问题难，请问能简单说下为啥么，业务语言是php</div>2020-04-04</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLAqN8yGhXKdUS9nLhEiapfesLdjEdBDJZhClibxOicYCpAeic92oIFYQnicywAF5lPROSIia6HWSrrF8pA/132" width="30px"><span>callmebaby</span> 👍（0） 💬（1）<div>目前项目上mysql 优化总结，查询慢日志、查看慢语句是否有索引，在不分表分库的情况下，可以先用分区，然后加内存，根据业务数据滚动存储。用中间件分库分表增加了很多复杂性，可能先考虑把不太重要的表拆库</div>2020-04-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/2e/39/7682b49e.jpg" width="30px"><span>lofaith</span> 👍（0） 💬（1）<div>高并发，高性能，高可用，高扩展
高并发设计原则：
有数据支撑，有问题导向，要循序渐进。
性能度量指标：
200ms最好，1s也可以接受
高并发优化方法：
1.提升核心数，相当于scale-out
要注意压力测试，经过拐点之后反而糟糕
2.减少单次任务响应时间
分为io密集型和cpu密集型，有不同的方法</div>2020-03-20</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLXQyKrqDG9ATu8ZYDT6iclkAQjcXicSbKEgV3t3c6qOmfO9Hu4vjqWZQyAWenqhVvY153fY4YQA1JQ/132" width="30px"><span>teressa</span> 👍（0） 💬（2）<div>老师，如果一个后端服务，既有cpu计算（例如计算hash值），又有大量的网络io，如果判断我的系统性能瓶颈到底是cpu还是io呢？</div>2020-01-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/15/02/66f65388.jpg" width="30px"><span>雷霹雳的爸爸</span> 👍（0） 💬（1）<div>可能是题目定在“设计”上了，所以看课程目录，关于这期提到的很重要的度量、监控，估计只有维护篇里面有几讲（30，31，32）会集中介绍，略显遗憾了，希望能看到内容的更好组织和能提供充分的参考扩展阅读信息</div>2019-11-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a1/e6/50da1b2d.jpg" width="30px"><span>旭东(Frank)</span> 👍（0） 💬（1）<div>互联网的三高，为什么没有高可靠，高可靠指定银行才会作为系统目标吗？</div>2019-10-26</li><br/>
</ul>