你好，我是唐扬。

上一节课，我带你了解了单体架构向微服务化架构演进的原因，你应该了解到当系统依赖资源的扩展性出现问题，或者是一体化架构带来的研发成本、部署成本变得难以接受时，我们会考虑对整体系统做微服务化拆分。

微服务化之后垂直电商系统的架构将会变成下面这样：

![](https://static001.geekbang.org/resource/image/1d/e9/1d5f1212017c6c22818e413ab74f88e9.jpg?wh=1142%2A791)

在这个架构中，我们将用户、订单和商品相关的逻辑抽取成服务独立的部署，原本的Web工程和队列处理程序将不再直接依赖缓存和数据库，而是通过调用服务接口查询存储中的信息。

有了构思和期望之后，为了将服务化拆分尽快落地，你们决定抽调主力研发同学共同制定拆分计划。但是仔细讨论后你们发现，虽然对服务拆分有了大致的方向可还是有很多疑问，比如：

- 服务拆分时要遵循哪些原则？
- 服务的边界如何确定？服务的粒度是怎样的？
- 在服务化之后会遇到哪些问题呢？我们又将如何来解决？

当然，你也许想知道微服务拆分的具体操作过程和步骤是怎样的，但是这部分内容涉及的知识点比较多，不太可能在一次课程中把全部内容涵盖到。而且《DDD实战课》中已经侧重讲解了微服务化拆分的具体过程，你可以借鉴。

而上面这三点内容会影响服务化拆分的效果，但在实际的项目中经常被大部分人忽略，所以是我们本节课的重点内容。我希望你能把本节课的内容和自身的业务结合起来体会，思考业务服务化拆分的方式和方法。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/cf/b5/d1ec6a7d.jpg" width="30px"><span>Stalary</span> 👍（30） 💬（2）<div>微服务化之后一些读库操作变成了远程调用，很多多次读的操作都要修改为批量读取来减少网络耗时，这里的改动还是很大的，甚至一些要求响应时间很高的，还需要做本地缓存&#47;</div>2019-11-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/84/b9/f4c1bfaf.jpg" width="30px"><span>涛</span> 👍（22） 💬（5）<div>老师好，我们在做微服务项目的时候。碰到最难受的问题就是:比如一个流程要调用三四个服务，前两个调用成功了，第三个失败了。类似的这种情况，该怎么处理呢？</div>2019-11-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/65/7b/66b9befd.jpg" width="30px"><span>Hwan</span> 👍（10） 💬（4）<div>然后想问下老师，就是我们的用户服务也是单独分出来了，有的内容放在了缓存里面了，但是目前除了去调用用户服务的接口获得数据外，有的时候是直接在其他服务里面调用用户的redis里面的数据的，感觉这样比较快，比调用接口快，然后想问下，按照微服务的话，这种放在缓存供其他服务调用是合理的吗？是不是最好还是缓存也分开，然后每次都得调用接口，然后接口里面调用缓存会比较好啊，希望老师解答，谢谢老师</div>2019-11-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/8e/79/f9d5dd3a.jpg" width="30px"><span>吕超</span> 👍（6） 💬（6）<div>两个披萨就够我一个人吃。老外一个个人高马大的，胃口咋那么小。</div>2020-01-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0c/0f/93d1c8eb.jpg" width="30px"><span>mickey</span> 👍（5） 💬（1）<div>微服务拆分以后最大的问题是故障的排查与定位问题。
</div>2019-11-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（2） 💬（1）<div>微服务化基础设施不全会很痛苦，尤其是出现服务问题时，怎么拆最关键的？具体需要看公司大环境，以及组内业务情况，不过设计原则基本是老师所说的吧！目标是提高人效节省成本，使公司业务更好的开展赚更多的钱😍</div>2020-04-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/45/9c/5b06d143.jpg" width="30px"><span>芳菲菲兮满堂</span> 👍（1） 💬（3）<div>这个微服务的编译依赖其他的微服务的 版本管理很是难受</div>2020-03-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/76/23/31e5e984.jpg" width="30px"><span>空知</span> 👍（1） 💬（1）<div>老师，问下文中说的 用户服务 和 内容服务 那里，对于内容服务内容的获取鉴权的过程，每次请求都先去用户服务那边判断是否有权限，有权限再走内容服务 没权限直接返回，而 内容服务只是获取内容 不做任何鉴权 这样做可以吗？</div>2020-01-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/64/5d/de0536e8.jpg" width="30px"><span>木木</span> 👍（0） 💬（2）<div>我们的微服务，缺少运维啊。都是一个人当两三个人用，开发测试运维都做了。导致各种基建没做好，也没有运维，就是定定位问题就太痛苦了</div>2020-04-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/45/9c/5b06d143.jpg" width="30px"><span>芳菲菲兮满堂</span> 👍（0） 💬（1）<div>
老师 编译依赖有什么实践吗 这些东西破坏了我持续交付体系 发布版本补丁时候要把之前依赖的版本都找回来 目前是通过nexus管理 但是后期想容器化的时候 这块是个拦路虎 没想到要怎么解决这个问题 老师可否提供个思路？</div>2020-03-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ff/67/6ffe3a52.jpg" width="30px"><span>马里奥的马里奥</span> 👍（0） 💬（1）<div>最明显的问题就是服务之间请求，超时很容易出现。</div>2020-03-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/0d/63/85f471e2.jpg" width="30px"><span>柚子</span> 👍（0） 💬（1）<div>老师最后一段话对我感触挺深，我们的团队总共才十个人左右，但是项目很多。很多功能包括邮件或者短信都是一样需要的。每个项目里面都写确实浪费和累赘。本来是考虑采用微服务，但是看了很多资料感觉没有必要，我们人员也少，所以采取折中方案。先进行工程拆分，把公共的这块短信和邮件拆出来。给所有项目引入！先做个这样的方案。</div>2020-02-21</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83er2VKpfrnY4HBBUbYXeIWGSiaeA0FodG9aibC6ChCcJZ5KGGU4vBl89uHMXAxf3xa3Abm11a5rvjWRw/132" width="30px"><span>Geek_2e972d</span> 👍（0） 💬（1）<div>微服务化后事物该怎么处理？</div>2019-12-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/27/d6/30456009.jpg" width="30px"><span>大象蚂蚁</span> 👍（0） 💬（1）<div>老师，微服务各子项目的端口设置为随机端口，目前能想到的是在维护上可能比较难。那么随机端口还会造成其他问题吗？</div>2019-12-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5f/81/1c614f4a.jpg" width="30px"><span>stg609</span> 👍（0） 💬（1）<div>想问下老师如何拆分数据库又不影响日常功能迭代的？ 是该先拆工程还是先拆数据库呢？</div>2019-11-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/01/37/12e4c9c9.jpg" width="30px"><span>高源</span> 👍（0） 💬（3）<div>老师阅读开源框架源码这块你们是怎么进行的，理清架构和分析架构开发思想，读开源的源代码我想要的是人家是怎么设计使用利用设计模式反射等开发出来的框架的，我理解学会了可以学习借鉴自己应用到实践中，但苦于看源码有些不懂的，该怎么进行呢</div>2019-11-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/57/6e/b6795c44.jpg" width="30px"><span>夜空中最亮的星</span> 👍（0） 💬（1）<div>我又回来啦，老师</div>2019-11-13</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/RNO4yZyBvic914hewmNNE8iblYDcfv5yGHZ9OnKuCuZXNmGR0F5qV3icKLT2xpMt66GyEpicZVvrmz8A6TIqt92MQg/132" width="30px"><span>啊啊啊哦哦</span> 👍（0） 💬（1）<div>老师问你一些我对微服务的困惑。
1:服务层是前面分层架构中讲到的service和manager层拆分出来独立部署成一个微服务吗
2业务逻辑都是写在服务层吗。比如我下一个订单。web 层直接调用服务层的下单逻辑
3。web层需要变动吗。 还是也要变成用户web层。订单web层。  
没真正接触过微服务看了网站那些有点乱
 

</div>2019-11-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/36/2c/8bd4be3a.jpg" width="30px"><span>小喵喵</span> 👍（15） 💬（1）<div>微服务拆分的原则:
原则一，做到单一服务内部功能的高内聚，和低耦合
原则二，你需要关注服务拆分的粒度，先粗略拆分，再逐渐细化。
原则三，拆分的过程，要尽量避免影响产品的日常功能迭代，也就是说，要一边做产品功能迭代，一边完成服务化拆分。
原则四，服务接口的定义要具备可扩展性。</div>2019-11-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ca/bd/a51ae4b2.jpg" width="30px"><span>吃饭饭</span> 👍（5） 💬（2）<div>服务接口修改版本号问题；服务间的循环依赖问题；传输协议的选型很重要，因为牵扯到序列化问题；链路追踪能及时发现报错日志；点太多啦：）</div>2019-11-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/97/3b/c98b68c1.jpg" width="30px"><span>AngryApe</span> 👍（4） 💬（1）<div>唐老师，请教个问题，在微服务化落地以后会有基础服务和业务服务的区分，这时候会出现两个问题：
1. 基础服务的改动会影响到很多上层业务服务，从而带来很大量的回归测试任务。
2. 随着业务的发展，经常需要基础服务跟着改动，对基础服务团队来说被业务团队牵着鼻子走。以订单服务为例，经常会有各种各样的枚举值或者数据库字段需要添加进来。
综上，当需求来临时，怎么以更小的成本去实现？</div>2020-02-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/91/7b/2dd4d0c1.jpg" width="30px"><span>大鸡腿🍗</span> 👍（1） 💬（5）<div>反驳一点，用户相关的数据有时需要冗余到本服务，跨项目有时查点数据很蛋疼，或者说加点接口，用户服务要排期，如果是冗余到自己的服务，随便加接口。
其次改接口成4个参数的时候，应该加个过期注解，保留旧的接口兼容旧的调用，让他们慢慢迁移，然后新增新的接口来实现新的逻辑。其次还有maven的快照版本跟正式版本来解决，虽然我没有去了解过，哈哈</div>2019-12-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/4b/4b/97926cba.jpg" width="30px"><span>Luciano李鑫</span> 👍（1） 💬（1）<div>感觉微服务的拆分像极了面向对象中的类的划分。</div>2019-11-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/03/55/791d0f5e.jpg" width="30px"><span>郑继强</span> 👍（0） 💬（0）<div>我不太同意老师对认证用户判断的说法，接口设计应该面向数据，而不是面向行为，如果说用户服务去提供一个是否认证用户的接口，那之后又用别的类似的需求，是不是都要不断去加接口。因为这里只是其中一个字段，并不是说需要有逻辑判断。所以我觉得用户服务应该只暴露数据，至于认证用户推内容这种，属于内容服务的逻辑。</div>2022-04-21</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/quaAPZib2arYia7XhUQAd83ribCJlM4CNwCMVicwZqyJL8SCrrKxNf84aXe7GF07rib4TOicTgicw2GjO1lSVMich5Japw/132" width="30px"><span>温旭升</span> 👍（0） 💬（0）<div>老师好，请教两个问题：
1、把一个内聚的功能逻辑，是应该设计成微服务，还是设计成类（或函数）在进程内调用问题。我理解，微服务是跨进程的调用，从性能角度，是比不过进程内的过程调用的。微服务的好处服务扩展性较强。那么，对数据处理吞吐量要求较高的场景，按微服务拆分业务处理逻辑，适用吗？
2、外部系统调用服务，可先接入服务网关，通过应用服务网关做安全鉴权，保障请求的合法性，但在系统内部的微服务之间的服务调用，还需不需要做接口调用方面的安全处理？老师在实际项目应用中，是怎么考虑及处理这个问题的？</div>2022-04-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8c/5c/3f164f66.jpg" width="30px"><span>亚林</span> 👍（0） 💬（0）<div>没钱的小老板 能不微服务就不要微服务 </div>2021-11-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/3e/78/ab4f7cbb.jpg" width="30px"><span>风</span> 👍（0） 💬（0）<div>微服务拆分也有加剧服务不可信的问题，为了避免服务调用异常导致的这身服务异常，我每次都要try catch一下调用服务，保证自身服务的可用性。由其他服务抛出来的异常，不加已处理的就抛到用户端，出了问题都不好排查，拿接口返回的message搜索自身项目都搜索不到的</div>2020-10-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/7e/64/b5f10966.jpg" width="30px"><span>互金从业者X</span> 👍（0） 💬（0）<div>其实面向对象做不好，就很难去界定单一职责，比如注册这个功能是内聚到用户中心还是给api呢，之前有在推一个服务化的项目，结果最后……一不留心有些微服务就直接给我写成远程DAO的。现在估计很多人的微服务也是这么个情况…… 最后只能折中，做取舍</div>2020-07-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/88/cc/e80845d5.jpg" width="30px"><span>xiaochao321</span> 👍（0） 💬（0）<div>服务的循环依赖？调用a、b、c三个服务，服务a b 调用成功，调用c失败怎么处理？</div>2020-06-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f9/5f/b0a125a9.jpg" width="30px"><span>chp</span> 👍（0） 💬（0）<div>公司现在的项目，用的应该是老师说的折中方法，拆分了很多子模块，但是模块与模块的依赖比较严重，像资源模块，作为基础模块，其他模块基本都要用到这模块的表，老师关于这个，针对这个依赖情况，您有什么好建议吗？如何做到高内聚低耦合</div>2019-11-18</li><br/>
</ul>