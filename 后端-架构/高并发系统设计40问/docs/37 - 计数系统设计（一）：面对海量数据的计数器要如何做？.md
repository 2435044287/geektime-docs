你好，我是唐扬。

从今天开始，我们正式进入最后的实战篇。在之前的课程中，我分别从数据库、缓存、消息队列和分布式服务化的角度，带你了解了面对高并发的时候要如何保证系统的高性能、高可用和高可扩展。课程中虽然有大量的例子辅助你理解理论知识，但是没有一个完整的实例帮你把知识串起来。

所以，为了将我们提及的知识落地，在实战篇中，我会以微博为背景，用两个完整的案例带你从实践的角度应对高并发大流量的冲击，期望给你一个更加具体的感性认识，为你在实现类似系统的时候提供一些思路。今天我要讲的第一个案例是如何设计一个支持高并发大存储量的计数系统。

**来看这样一个场景：** 在地铁上，你也许会经常刷微博、点赞热搜，如果有抽奖活动，再转发一波，而这些与微博息息相关的数据，其实就是微博场景下的计数数据，细说起来，它主要有几类：

1. 微博的评论数、点赞数、转发数、浏览数、表态数等等；
2. 用户的粉丝数、关注数、发布微博数、私信数等等。

微博维度的计数代表了这条微博受欢迎的程度，用户维度的数据（尤其是粉丝数），代表了这个用户的影响力，因此大家会普遍看重这些计数信息。并且在很多场景下，我们都需要查询计数数据（比如首页信息流页面、个人主页面），计数数据访问量巨大，所以需要设计计数系统维护它。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/dd/3c/a595eb2a.jpg" width="30px"><span>台风骆骆</span> 👍（64） 💬（3）<div>总结：
1、一开始用mysql进行计数，后来加入了主从架构，分库分表架构。
2、因为计数访问量太大了，加入了缓存，但是这个会造成相应的那个缓存和数据库数据不一致，如果要保证一性的话，就需要采用内存队列，对于同一个id的数量只能用单线程进行处理，这个会造成性能问题。
3、后来直接抛弃了mysql，直接用redis cluster来支持计数服务,因为redis通过rdb和aof来支持持久化，可以通过设置保证至少有一台从redis机器同步了数据，从redis来做相应的那个持久化操作达到数据不丢失，因为原生的redis数据结构会占用比较多的字节，这里直接进行改造，让redis的数据结构占用内存加少。
4、但是redis是全内存的，随着量越来越大肯定没法支持了，这里进行改造，引入ssd，支持把冷数据放到ssd中，热数据在内存中，当要访问冷数据时利用一个线程异步把冷数据加载到一个cold cache里面去。这个有很多开源的实现，如Pika，SSDB用ssd来替代内存存储冷数据。</div>2019-12-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/99/83/b5743382.jpg" width="30px"><span>小困</span> 👍（23） 💬（9）<div>微博点赞还有哥难点，就是用户只能点赞一次，这个该用什么存储结构呢，或者技术方案</div>2020-05-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/e9/37/4780b70c.jpg" width="30px"><span>bug工程师</span> 👍（15） 💬（3）<div>老师，关于关注关系存储，我们公司现在用户的关注列表和粉丝列表都放在redis的sortedset结构中，一个key最大能够占到2g，现在8个节点，每个节点平均已使用20g容量，redis改造的能力我们不具备，还有什么其他优化思路，能够减少存储成本，获取粉丝列表响应时间低延迟呢？</div>2020-01-04</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJw2X8ib9oJCfoAavUFQiaHUk6ibUahvDicstTSjmib3OzPSic4KgWx98z4fOyiaTyd9WUF0W8niaeCpMOxog/132" width="30px"><span>Geek_zhuyu</span> 👍（11） 💬（2）<div>老师，通过消息队列来计数的话，怎么保证计数的准确性，比如关注数和粉丝数这种对准确性要求比较高的</div>2020-01-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/b7/e9/5400cdf3.jpg" width="30px"><span>扬一场远远的风</span> 👍（9） 💬（1）<div>老师，这种海量的KV型计数，是否用 hbase存储会好简单许多？起码不用像mysql那样要在client端做分库分表。读请求依然可以走缓存。</div>2019-12-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ca/bd/a51ae4b2.jpg" width="30px"><span>吃饭饭</span> 👍（8） 💬（2）<div>【如果要存储一个 KV 类型的计数信息，Key 是 8 字节 Long 类型的 weibo_id，Value 是 4 字节 int 类型的转发数，存储在 Redis 中之后会占用超过 70 个字节的空间】这个 70 个字节是怎么算出来的，有点懵</div>2019-12-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/42/65/f444ea39.jpg" width="30px"><span>grandcool</span> 👍（7） 💬（1）<div>Redis为啥开始不搞long类型的key呢，是为了通用性吗</div>2019-12-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4e/60/0d5aa340.jpg" width="30px"><span>gogo</span> 👍（7） 💬（4）<div>通过redis存储计数的话，如果redis机器故障了怎么办呢？微博本身的信息是如何存储的呢，老师能相信讲解下吗</div>2019-12-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/20/08/bc06bc69.jpg" width="30px"><span>Dovelol</span> 👍（6） 💬（4）<div>老师好，想问下用redis的话该怎么用ssd配合做冷热数据存储呢，这块完全没经验，能讲讲具体的实现方案吗？</div>2019-12-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/42/65/f444ea39.jpg" width="30px"><span>grandcool</span> 👍（4） 💬（1）<div>Pika是不是就是在Redis中改造了下逻辑，把旧的数据dump到SSD上了啊？</div>2019-12-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/5d/f8/7de2c1cc.jpg" width="30px"><span>星空123</span> 👍（4） 💬（1）<div>老师的课虽然代码比较少，但是说实话，实际业务场景里还是能我们不少优化的思路。</div>2019-12-20</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/ydVBBkofXDqCyP7pdwkicHZ9xtyEEuZvzrrkeWcnQjZ1ibEgG60eLotQTsKJFpWibuf6e7G9r0I1xaribUAQibPMl7g/132" width="30px"><span>Geek_hpj32m</span> 👍（3） 💬（1）<div>请教一个问题，有些计数点进去是有具体数据列表的，比如评论数，计数在redis，数据在数据库，数据会不会不一致，如果引入分布式锁，会不会影响性能?</div>2020-08-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5f/81/1c614f4a.jpg" width="30px"><span>stg609</span> 👍（3） 💬（1）<div>一般达到多大的数据规模，需要考虑单独提供计数器的功能呢？还是说针对某一类的计数？

我们大部分都是直接通过sql去数据库 select count，似乎目前也没什么问题</div>2020-05-26</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epkttbAibb21Cf4Hvq7ASReEyk5klDhxQulmnrzQWEcqslZ6qhlFf8zw0ZpG8BA65icnz8ianlZVnkFA/132" width="30px"><span>SuperYue</span> 👍（3） 💬（2）<div>老师 纯用redis，怎么解决事务的强一致性呢  比如转发和评论是一个事务性质的业务，转发的redis操作成功了，评论操作失败了 要手动补数据吗</div>2020-03-23</li><br/><li><img src="" width="30px"><span>tm1234</span> 👍（2） 💬（1）<div>请问老师 mysql是支持强一致性的 但redis并不能，所以如果是对需要强一致性的计数场景（比如购物系统）是不是就不能放弃mysql完全使用redis呢？</div>2020-04-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/32/14/5eaa10f6.jpg" width="30px"><span>好望角</span> 👍（2） 💬（1）<div>原生redis改造是啥意思啊？改源代码嘛</div>2020-03-17</li><br/><li><img src="" width="30px"><span>Geek_bd613f</span> 👍（1） 💬（1）<div>老师你好，原生的 Redis 在存储 Key 时是按照字符串类型来存储的，比如一个 8 字节的 Long 类型的数据，需要 8（sdshdr 数据结构长度）+ 19（8 字节数字的长度）+1（’\0’）=28 个字节，如果我们使用 Long 类型来存储就只需要 8 个字节，会节省 20 个字节的空间。

我查了下资料：

redis 的 key 按照字符串类型储存的时候， key 由  SDS 组成，SDS 由
len     字符串长度        1byt
alloc    分配的内存       1byt
flags		是哪种实现    sdshdr4   8  16    1byt
char buf[]   字符数组用来储存    16byt

SDS 的大小是 19个字节, 
老师你说：需要8（sdshdr数据结构长度）这个是什么意思呀？
是不是我 对 redis string 类型的储存实现理解有误呀，看了半天没理解这个地方。盼回复~</div>2020-04-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/56/06/ea49b29d.jpg" width="30px"><span>小洛</span> 👍（1） 💬（1）<div>两个问题咨下老师，第一个问题是相同微博id的计数数据放在一起，那在高并发更新下，会有性能问题吗，例如锁记录等，第二个问题是redis如何改造，才能不影响原本高效的查询性能，有进一步细节的分享么？谢谢老师</div>2020-02-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/36/94/5aecb0ef.jpg" width="30px"><span>y3</span> 👍（1） 💬（1）<div>请问老师，本文中提到对原生redis组件进行改造，是指的在redis源码上进行改造和定制吗？🤔️😄</div>2020-01-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0f/f4/026bddc6.jpg" width="30px"><span>梅小西</span> 👍（1） 💬（2）<div>老师，有个地方没看懂。存数据的时候，我的理解是通过一定的hash把weiboid的位置找到，然后在数组响应的位置存入点赞数。但是在取数据的时候，你加了一个 t[pos]==weibo_id 。你这个t[pos]不是存的点赞数么，怎么又跟weibo_id来判断相不相等呢</div>2019-12-30</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqyicZYyW7ahaXgXUD8ZAS8x0t8jx5rYLhwbUCJiawRepKIZfsLdkxdQ9XQMo99c1UDibmNVfFnAqwPg/132" width="30px"><span>程序水果宝</span> 👍（1） 💬（2）<div>通过hash来分表，那每次查询的时候也要计算hash值才能知道去查哪张表，性能不会有影响吗？</div>2019-12-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f6/5f/85e82813.jpg" width="30px"><span>高峰</span> 👍（0） 💬（2）<div>老师，可以不可以用 hyperloglog 用来计数 是不是消耗更小？</div>2020-04-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/5e/82/438c8534.jpg" width="30px"><span>longslee</span> 👍（0） 💬（1）<div>打卡。老师，你后面说的需要一个大数组来存储，是不是之前提到的布隆过滤器那种方式？</div>2020-01-04</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/LUeuiaxdQ6kZgicd40T2QVGBlRjicrkuA1PXXXZnSO70PM1zVLpicneWDVbiajdkEyZjrGKxd5vJYOCibliax2BLVGhCb2OcPXYeYicJATUwPZoG8Uk/132" width="30px"><span>jun.hai</span> 👍（0） 💬（1）<div>老师，您好，对redis深度改造这块儿没太懂，如：“Key 是 8 字节 Long 类型的 weibo_id，Value 是 4 字节 int 类型的转发数，存储在 Redis 中之后会占用超过 70 个字节的空间”这块儿是怎么计算出来的？</div>2019-12-31</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEJV0t7NEwlq7iahuSyncBGYBffJOKTOZnqXnhorp47wGQdXLWj7pIoicIUtEgESIhIOHp5MrEYdyCvg/132" width="30px"><span>xiaobao</span> 👍（0） 💬（1）<div>老师您好 “一是原生的 Redis 在存储 Key 时是按照字符串类型来存储的，比如一个 8 字节的 Long 类型的数据，需要 8（sdshdr 数据结构长度）+ 19（8 字节数字的长度）+1（’\0’）=28 个字节，如果我们使用 Long 类型来存储就只需要 8 个字节，会节省 20 个字节的空间” long类型存储的话不也是 k-v结构吗？</div>2019-12-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/37/4e/5c3153b2.jpg" width="30px"><span>知行合一</span> 👍（0） 💬（1）<div>计数系统如何和业务系统保持一致性？不会少计数，需要核对数据吗？</div>2019-12-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/d2/e9/c7a80d9f.jpg" width="30px"><span>单行道</span> 👍（0） 💬（1）<div>计数器只存id的情况下，如果有按人维度查询的需求怎么办，比如查一定时间获赞数最多的人？</div>2019-12-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/dd/3c/a595eb2a.jpg" width="30px"><span>台风骆骆</span> 👍（0） 💬（2）<div>老师，请以后多出些专栏，每次看你的专栏都有火花出来</div>2019-12-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/2a/e6/c788257f.jpg" width="30px"><span>geek_arong2048</span> 👍（1） 💬（0）<div>redis可以使用tikv进行替换，tikv基于rocksdb，会将数据存储在磁盘中</div>2022-07-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/fe/04/bb427e47.jpg" width="30px"><span>码哥字节</span> 👍（1） 💬（1）<div>HyperLogLog</div>2022-04-21</li><br/>
</ul>