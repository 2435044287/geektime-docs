你好，我是唐扬。

**来想象这样一个场景：**你的垂直电商系统部署的IDC机房，在某一天发布了公告说，机房会在第二天凌晨做一次网络设备的割接，在割接过程中会不定时出现瞬间或短时间网络中断。

机房网络的中断肯定会对业务造成不利的影响，即使割接的时间在凌晨（业务的低峰期），作为技术负责人的你，也要尽量思考方案来规避隔离的影响。然而不幸的是，在现有的技术架构下，电商业务全都部署在一个IDC机房中，你并没有好的解决办法。

而IDC机房的可用性问题是整个系统的阿喀琉斯之踵，一旦IDC机房像一些大厂一样出现很严重的问题，就会对整体服务的可用性造成严重的影响。比如：

2016年7月，北京联通整顿旗下40多个IDC机房中，不规范的接入情况，大批不合规接入均被断网，这一举动致使脉脉当时使用的蓝汛机房受到影响，脉脉宕机长达15个小时，著名的A站甚至宕机超过48个小时，损失可想而知。

而目前，单一机房部署的架构特点决定了你的系统可用性受制于机房的可用性，也就是机房掌控了系统的生命线。所以，你开始思考如何通过架构的改造进一步提升系统的可用性。在网上搜索解决方案和学习一些大厂的经验后，你发现“多机房部署”可以解决这个问题。

## 多机房部署的难点是什么
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/9b/6e/edd2da0c.jpg" width="30px"><span>蓝魔丶</span> 👍（24） 💬（1）<div>读了两遍，老师有4个问题
1.同城双活方案中，应用服务在跨机房写和同机房读的策略下，应用程序是如何实现这种策略的（读写分离），有相关的实现方案吗？并且是如何应对在并发情况下主从延长导致的读同机房数据库无数据问题。
2.同城双活方案中，缓存部署架构是在各种机房中创建缓存库，不进行缓存数据的同步吗？还是会与数据库类似建立主从机制保证同步缓存数据。注册中心部署架构是只需要部署到任意一个机房就可以是吗？不需要考虑在双机房都独立部署的情况嘛？
3.异地多活方案中，是如何做到对用户进行分片，保证尽量调用本机房的服务的？
4.异地多活方案中，最后提到的那个场景，我的理解是本次服务调用需要的数据很可能是存储在异地机房中，这样无法避免的进行远程的服务调用或数据访问，为了保证可用性，只有牺牲性能上延长，但是还是应该尽量避免这种跨异地的远程访问，保证两个异地两个机房中都有对方的所有东西，包括数据和服务等。</div>2019-11-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/18/49/b1d864e5.jpg" width="30px"><span>Hinimix</span> 👍（8） 💬（5）<div>老师，比如用zk做注册中心，一个服务我在两个机房各部署了一套，我在web服务连接的时候怎么确定是本机房呢，是需要注册时候注册个机房名，然后web选择有这个机房名的吗</div>2019-12-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/e5/5d/b6378027.jpg" width="30px"><span>小山猫</span> 👍（4） 💬（3）<div>老师好，异地用户分片用什么方案比较好，比如电商中涉及到用户、商品、商家，用户只看本机房对应的商品吗</div>2020-01-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/b7/e9/5400cdf3.jpg" width="30px"><span>扬一场远远的风</span> 👍（4） 💬（3）<div>“这里有一个场景：假如在电商系统中，用户 A 要查看所有订单的信息，而这些订单中，店铺的信息和卖家的信息很可能是存储在异地机房中，那么你应该优先保证服务调用，和数据读取在本机房中进行，即使读取的是跨机房从库的数据，会有一些延迟，也是可以接受的。”这句没明白。我理解前文讲的“对于某个固定的乃，服务的调用和数据的读写都应该保证在同一个机房中”。而例子中：本人的基本信息和订单信息主库在机房A中，所以数据读取和服务调用应该保证在机房A ，而店铺信息主库和卖家信息主库在机房B中（机房A异步方式从机房B同步过来），此时，对于店铺信息和卖家信息的读取应该也是在机房A中吧？！</div>2019-11-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0d/2b/4814d3db.jpg" width="30px"><span>阿土</span> 👍（3） 💬（1）<div>老师，异地多活架构中，数据双向同步如何做？</div>2019-12-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/c8/34/fb871b2c.jpg" width="30px"><span>海罗沃德</span> 👍（2） 💬（1）<div>我們使用AWS，跨region部署，會導致緩存不同步，而AWS不支持跨region複製redis數據，而我們又沒有做用戶分片，導致PM，測試都在玩命用同一個用戶側跨region的case</div>2019-11-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/43/f7/abb7bfe3.jpg" width="30px"><span>刘冲</span> 👍（2） 💬（3）<div>同城双机房，数据库同步和异城数据库同步方案有啥区别？图上没看太懂，</div>2019-11-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/e3/a8/249f6d53.jpg" width="30px"><span>Jast</span> 👍（1） 💬（1）<div>“另一个思路是在机房 B 部署一个从库，跨机房同步主库的数据，然后机房 B 的应用就可以读取这个从库的数据了” 老师您好，这个机房B写是写到A机房的主库吗</div>2020-06-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（1） 💬（1）<div>网络通信主要依赖光和电，光和电的速度是快，不过再快从一个空间到另一个空间也需要时间。并且距离越远耗时越多，不过为了服务的可用性，也没什么好法子只能通过副本或者隔离的方式来提供更高可用的服务，很简单的道理不把鸡蛋放在同一个篮子，防止一次全部打烂。
距离远——隔离性好——服务更高可用
距离远——数据延迟大——服务架构更复杂——成本更高
想要的东西是矛盾的，无法实现都满足，只能选择一个平衡点。所以，什么时候选择同城多活或异地多活，也是一样需要寻找一个平衡点，原则是能不用就不用，逼不得已非用不可了，没得选那就用吧！此时人力物力财力，可能也能支持啦！</div>2020-05-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/75/a8/dfe4cade.jpg" width="30px"><span>电光火石</span> 👍（1） 💬（3）<div>老师请问一下，异地多活的方案中，A机房的主库同步到B机房的从库，B机房的主库同步到A机房的从库。我理解：那A机房的服务看到的是自己机房的主库和对方机房的从库，通过数据库分片，不同的数据路由到不同数据库，是这样的吗？分片在A机房主库中的数据和分片在B机房主库找那个的数据不做同步？</div>2019-12-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c5/2d/1eebfc3c.jpg" width="30px"><span>GaGi</span> 👍（0） 💬（2）<div>对于异地多活中的数据同步方案的第一个，基于存储系统的主从复制，
请问是每个机房都有部署一套主数据库和从数据库，
然后通过用户分片到不同的机房，写入对应机房的主库，
然后通过主从复制，将对应机房主库的数据同步到其他机房的备库吗</div>2020-04-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/76/f5/e3f5bd8d.jpg" width="30px"><span>宝仔</span> 👍（0） 💬（1）<div>老师想问下同城双活架构中，注册中心为什么不是一个机房一个，而是多机房共享一个注册中心</div>2020-04-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/64/15/9c9ca35c.jpg" width="30px"><span>sipom</span> 👍（0） 💬（1）<div>一般大公司、大项目，对可用性要求特别高的情况，需要考虑采用异地多活架构。主要挑战：异地通信的延迟远远大于同机房、同城，一般需要在异地机房间做数据同步。</div>2020-03-22</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/jXbwicoDwia7ooDfwBTRyvNYQkefnVwF1CMicMS8FqKfuFAdvVZo2pqc4ic0R9kSdHTIxaE6YyqxwX8BdNGv5PqSIw/132" width="30px"><span>kamida</span> 👍（0） 💬（3）<div>异地多活 每个机房都向自己的主数据库写入 怎么解决冲突的问题呢？ 比如两个机房都修改用一个信息
</div>2020-03-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/45/9c/5b06d143.jpg" width="30px"><span>芳菲菲兮满堂</span> 👍（0） 💬（1）<div>云时代 就可以多接触这种大厂才有的方案</div>2020-03-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/3d/6e/60680aa4.jpg" width="30px"><span>Li Yao</span> 👍（0） 💬（1）<div>用户分片一般是通过什么组件做的呢？DNS调度不支持用户ID分片吧？</div>2020-03-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/af/e6/9c77acff.jpg" width="30px"><span>我行我素</span> 👍（0） 💬（3）<div>不是每个都有完整的数据吗</div>2020-02-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/af/e6/9c77acff.jpg" width="30px"><span>我行我素</span> 👍（0） 💬（3）<div>想请问下，在异步多活中为什么会存在 店铺的信息和卖家的信息很可能是存储在异地机房中？</div>2020-02-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/71/05/db554eba.jpg" width="30px"><span>👽</span> 👍（0） 💬（5）<div>我的理解：还是得分析了流量价值。如果，机房宕机会给公司带来较大损失的时候。就需要考虑多活。但是，如果宕机对系统没什么太大的影响（例如停一天也没什么影响的项目），就并不需要考虑多活。</div>2019-12-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/23/c1/54ef6885.jpg" width="30px"><span>MoonGod</span> 👍（0） 💬（1）<div>老师请问一下，异地多活的方案中，两地数据库数据是相互隔离的吗？主从同步的方案只是把本机房的从库放倒对端机房。但对端机房主库写入的数据不会同步到这个从库中吧？</div>2019-11-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/36/2c/8bd4be3a.jpg" width="30px"><span>小喵喵</span> 👍（0） 💬（1）<div>在小公司，连机房都没有，都是部署在云服务器上。这怎么学习这些架构呢？</div>2019-11-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/99/27/47aa9dea.jpg" width="30px"><span>阿卡牛</span> 👍（4） 💬（1）<div>梦想还是要有的，万一有机会给我实践异地多活呢？</div>2019-11-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/a6/72/526fd3df.jpg" width="30px"><span>ICE FROG</span> 👍（3） 💬（1）<div>假定北京区数据库为A1（master）和A2（slave）；广东区为B1（Master）与B2（Slave）。按照上文所说的，A1同步给B2，B1同步给A2。那其实A1+B2与B1+A2的数据组合根本旧形成了数据孤岛。因为两两Master没有坐数据同步。如果B区挂了，A2会成为拥有B1数据的新Master。此时A1和A2就是两个数据来自不同区域的数据。此时怎么办呢？两个Master做同步的话，逗些得场景，如何解决bin log同步的回环问题呢？ 希望老师可以解答一下我的疑惑</div>2020-05-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/74/17/c86989cb.jpg" width="30px"><span>洋洋洋</span> 👍（3） 💬（2）<div>老师，我感觉你在异地多活方案写的不是很详细，比如异地双机房的主库是否同步，每个机房是保存有全量的数据，以及异地多活的架构题也不是很清晰</div>2019-12-14</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Cib5umA0W17N9pichI08pnrXAExdbyh7AVzH4nEhD6KN3FXuELk4LJJuqUPPD7xmIy9nq5Hjbgnzic7sVZG5BKiaUQ/132" width="30px"><span>被过去推开</span> 👍（3） 💬（1）<div>阿里云有跨区域mysql主从复制，比同机房的主从复制贵了不少</div>2019-12-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/5d/f8/7de2c1cc.jpg" width="30px"><span>星空123</span> 👍（2） 💬（0）<div>这就是为啥公司买服务器都会买同个大区，同个可用区的原因了。减少两个服务器交互的网络延迟</div>2019-11-27</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKvfBoRuxoicyLED9xq2XzDcibsDjMSYQj3oNUJDv0P8u6pNu3gm2CDTaattBsr4h0SZFSkNVpwX2UQ/132" width="30px"><span>西佳佳</span> 👍（0） 💬（0）<div>“假如在电商系统中，用户 A 要查看所有订单的信息，而这些订单中，店铺的信息和卖家的信息很可能是存储在异地机房中，那么你应该优先保证服务调用，和数据读取在本机房中进行，即使读取的是跨机房从库的数据，会有一些延迟，也是可以接受的。”这段话讲得有些模糊，所以在这个case中，是访问和用户A同机房的数据库（作为店铺&#47;商家信息的跨机房从库）吗？如果是这样的话，不存在“读取跨机房从库的额外延迟”呀，数据库读取是发生在本机房内的，这里可能发生的是数据非强一致性吧？</div>2024-03-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/23/50/1f5154fe.jpg" width="30px"><span>无笔秀才</span> 👍（0） 💬（0）<div>1.注册中心所在的机房断电了，岂不是所有服务之间的调用都gg了？
2.根据用户id 进行分片的话，感觉会存在一些问题：比如1用户本身在北京 却被sharding到广州机房。这里感觉应该加一个调度层，根据用户接入ip 进行调度是不是更好一些呢？</div>2022-12-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/55/77/f87f5fc1.jpg" width="30px"><span>brqi</span> 👍（0） 💬（0）<div>异地多活+set化单元部署</div>2022-12-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8c/5c/3f164f66.jpg" width="30px"><span>亚林</span> 👍（0） 💬（0）<div>现在搞外包都要同城多活落地了，还要提异地多活方案，才能参与投标😭</div>2021-12-06</li><br/>
</ul>