你好，我是唐扬。

在基础篇中，我提到了高并发系统设计的三个通用方法：缓存、异步和横向扩展。到目前为止，你接触到了缓存的使用姿势，也了解了如何使用消息队列异步处理业务逻辑。那么本节课，我将带你了解一下如何提升系统的横向扩展能力。

在之前的课程中，我也提到过提升系统横向扩展能力的一些案例。比如，[08讲](https://time.geekbang.org/column/article/145095)提到可以通过部署多个从库的方式，来提升数据库的扩展能力，从而提升数据库的查询性能，那么就需要借助组件，将查询数据库的请求按照一些既定的策略分配到多个从库上，这是负载均衡服务器所起的作用，而我们一般使用DNS服务器来承担这个角色。

不过在实际的工作中，你经常使用的负载均衡的组件应该算是Nginx，它的作用是承接前端的HTTP请求，然后将它们按照多种策略分发给后端的多个业务服务器上。这样，我们可以随时通过扩容业务服务器的方式来抵挡突发的流量高峰。与DNS不同的是，Nginx可以在域名和请求URL地址的层面做更细致的流量分配，也提供更复杂的负载均衡策略。

你可能会想到，在微服务架构中我们也会启动多个服务节点承接从用户端到应用服务器的请求，自然会需要一个负载均衡服务器作为流量的入口，实现流量的分发。那么在微服务架构中，如何使用负载均衡服务器呢？
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/66/df/501ba989.jpg" width="30px"><span>面试官问</span> 👍（42） 💬（1）<div>是否使用客户端负载均衡，跟微服务框架中服务之间通信是使用 RPC 协议还是 HTTP 协议无关，例如Spring Cloud 中的 Ribbon 就是用来进行客户端负载均衡的；一般来说，在系统接入层，使用的是服务端负载均衡，而微服务之间的内部调用，使用的是客户端负载均衡。</div>2019-11-22</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJIocn8OMjfSGqyeSJEV3ID2rquLR0S6xo0ibdNYQgzicib6L6VlqWjhgxOqD2iaicX1KhbWXWCsmBTskA/132" width="30px"><span>虚竹</span> 👍（16） 💬（3）<div>老师最后说的nginx启停服务时切流量部分，在刚刚启动时返回500，完全初始化后返回200，是指health_check接口返回的状态码是通过配置中心配置获取的，重启之前改为500，看实例日志全完启动成功之后再改为200？</div>2020-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/6d/cf/ec335526.jpg" width="30px"><span>jc9090kkk</span> 👍（12） 💬（5）<div>感谢老师分享，这一刻看完有一个疑问，对于负载均衡的一些策略都清楚了，但是对于负载均衡器的承载容量有点疑问，比如说通过nginx来作为负载均衡器，但是它本身的承载容量是有极限的，如果当前nginx的转发容量只能支撑10w&#47;s的访问请求，但是流量如果达到20w&#47;s，那么nginx作为负载均衡器来讲，是否需要增加新的负载均衡器一起协调工作，那么同时存在两个负载均衡器的话，工作于它上一层的任务由谁来处理呢？lvs？还是dns？或者是其他？负载均衡器不可能没有极限吧？</div>2020-01-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7e/53/c29c2fc9.jpg" width="30px"><span>sdjdd</span> 👍（8） 💬（1）<div>关闭服务之前，用 503 状态码响应健康检查是不是语义更明确一些。</div>2019-11-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d5/bb/98b93862.jpg" width="30px"><span>古德</span> 👍（7） 💬（1）<div>以前用阿里云的时候，我们的架构是使用阿里云的SLB，直接转发到微服务网关zuul上，再根据url去分发到对应服务。</div>2020-01-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/f0/49/889f9ef6.jpg" width="30px"><span>M</span> 👍（7） 💬（3）<div>请教下老师，app与服务器之间使用websocket协议连接，如何使用负载均衡呢？</div>2019-11-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/e7/d5/f4bb9ccf.jpg" width="30px"><span>い北风</span> 👍（5） 💬（3）<div>老师，我在之前的面试遇到过一个问题。知道已有功能，如何选取服务器。去购买服务器的配置呢？</div>2020-01-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/5e/82/438c8534.jpg" width="30px"><span>longslee</span> 👍（4） 💬（1）<div>打卡。 涨姿势了。
曾经项目使用一层 IBM WebSphere 简单路由，但是客户端学聪明了，都手动绑定 hosts ，负载不均衡了。所以还是多层不暴露比较好。
提问：老师，您讲到结合注册中心的客户端负载均衡，它又是怎么做到“动态策略”的呢？</div>2019-11-25</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/RNO4yZyBvic914hewmNNE8iblYDcfv5yGHZ9OnKuCuZXNmGR0F5qV3icKLT2xpMt66GyEpicZVvrmz8A6TIqt92MQg/132" width="30px"><span>啊啊啊哦哦</span> 👍（4） 💬（1）<div>nginx 上为什么要阶lvs。 一般dns服务器也可以实现轮训分发到不同的nginx上啊。  </div>2019-11-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/b8/83/7c1ed918.jpg" width="30px"><span>如歌</span> 👍（3） 💬（2）<div>刷第二遍了 从操作系统到网络到这本书</div>2020-03-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0d/2b/4814d3db.jpg" width="30px"><span>阿土</span> 👍（3） 💬（3）<div>优雅关机与启动有案例么？理解了原理，具体怎么实现呢？</div>2019-11-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0a/01/3bd45e1e.jpg" width="30px"><span>leesir</span> 👍（2） 💬（1）<div>求教，对于普通web服务，nginx有办法感知新增结点吗？</div>2019-11-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/36/2c/8bd4be3a.jpg" width="30px"><span>小喵喵</span> 👍（1） 💬（1）<div>1.Nginx和LVS都可以做负载均衡，这些组件也都可以应用于C&#47;S系统吗？
2.health_check只能检测到服务器和节点指点是否可用，节点可用但是并不能代表内部服务接口是可用的，这个有什么好的方案呢？</div>2019-11-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（0） 💬（2）<div>打卡，负载均衡必然用到过，不过确实没怎么摸过，原理基本了解，遇到问题还需再探索。之前有遇到，因nginx缓存出现的问题，直接粗暴重启，来解决的。😬</div>2020-04-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg" width="30px"><span>安排</span> 👍（0） 💬（1）<div>文中说的客户端应该不是app或者浏览器吧？app或者浏览器去访问一个网站时会用rpc协议吗？</div>2020-03-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/6d/46/e16291f8.jpg" width="30px"><span>丁小明</span> 👍（0） 💬（1）<div>我们还有dns负载均衡一层，之后nginx还配合keeperlive做了高可用</div>2020-02-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c5/1f/8e9ee163.jpg" width="30px"><span>良记</span> 👍（0） 💬（1）<div>老师好像很少说到Spring Cloud相关的组件，有的话也是一笔带过，请问是这些组件的性能不好吗？</div>2019-12-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/5d/f8/7de2c1cc.jpg" width="30px"><span>星空123</span> 👍（0） 💬（2）<div>老师提供的nginx_upstream_check_module 我要自己研究下，有些东西确实公司限制多，都没用过</div>2019-11-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ad/27/5556ae50.jpg" width="30px"><span>Demter</span> 👍（0） 💬（4）<div>这里说的客户端是啥，是用户的浏览器吗。。。</div>2019-11-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/9b/6e/edd2da0c.jpg" width="30px"><span>蓝魔丶</span> 👍（10） 💬（0）<div>1.nginx类的负载组件只支持静态配置，无法动态感知配置，使用openrestry代替nginx好很多，不仅可以动态配置，而且比nginx提供了更多扩展模块
2.在docker容器的k8s环境中也使用过nginx-controller代理组件，但是这个组件虽然可以实现动态配置参数，但是路由和治理能力都偏弱，可以考虑使用istio等servicemesh网关</div>2019-11-26</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epEIGtJsxNCr9mUD8stzOg5icKcwYHMPVjJhXqYY4icsc6BSIqszsibWFP2wUetDwJsibyhdhbTgXNNibg/132" width="30px"><span>Geek_4d0d3e</span> 👍（2） 💬（0）<div>我们用kong做K8S集群业务的负载均衡</div>2020-12-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/4b/4b/97926cba.jpg" width="30px"><span>Luciano李鑫</span> 👍（2） 💬（2）<div>负载均衡应该分为： 
客户端负载均衡
后端负载均衡
   DNS负载均衡
   IP负载均衡
   反向代理负载均衡</div>2019-11-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/b2/e0/d856f5a4.jpg" width="30px"><span>余松</span> 👍（1） 💬（0）<div>LVS只在使用DR模式（只修改目标MAC地址），响应不需要经过LVS。在使用NAT模式（同时目标修改IP和MAC地址时），返回仍然要经过LVS，这个时候LVS的功能类似于网关。</div>2021-03-23</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132" width="30px"><span>null</span> 👍（1） 💬（0）<div>原文：比如从负载均衡端到后端服务的活跃连接数，然后从中选择连接数最少的服务。

怎么知道哪个后端服务的活跃连接数最少？负载均衡服务不是内嵌在客户端的么？各各客户端的负载均衡数据没有共享吧。</div>2020-09-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/61/2d/65f016bf.jpg" width="30px"><span>常文龙</span> 👍（0） 💬（0）<div>k8s的pod中的readinessProbe 可以实现优雅启动
terminationGracePeriodSeconds 可以实现优雅关机
livenessProbe配合重启策略实现健康检查和自动重启</div>2023-03-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/5a/27/69b50c53.jpg" width="30px"><span>GEEKBANG_3913481</span> 👍（0） 💬（0）<div>nginx相对于业务服务来说也是客户端，是不是也能理解是客户端负载均衡？</div>2023-02-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/16/88/2ebded78.jpg" width="30px"><span>李明</span> 👍（0） 💬（1）<div>nginx代理的后端服务，如果某个正在处理请求的后端服务被nginx摘除了，那么被摘除的后端服务还没来的及返回给客户端的响应，还能正常返回不</div>2021-12-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7e/05/431d380f.jpg" width="30px"><span>拂尘</span> 👍（0） 💬（1）<div>老师，烦劳有空解答一下心中疑惑。

原文：LVS 是在网络栈的四层做请求包的转发，请求包转发之后，由客户端和后端服务直接建立连接，后续的响应包不会再经过 LVS 服务器。

1.如果lvs是工作在四层（传输层)，对于tcp协议，感觉lvs是有状态的，需要维护客户端和服务连接的吧？另外，如果lvs只做包转发，由客户端和服务直接建立连接，又感觉lvs是工作在ip网络层。
2.后续的响应包不经过lvs。

老师，由上面1和2，我猜想是不是，lvs确实工作在传输层，但是lvs只维护客户端到服务的单向连接吗？
处理客户端到服务单向连接的意思是，lvs只处理syn，从而保持客户端与服务的对应关系，而不处理传输层其他细节，比如乱序、丢包、拥塞等。这里的资源占用开销很小，所以从lvs实现层面是保持连接，而从lvs使用层面来讲就接近无状态，接近修改目标地址直接转发包，从而说成不处理客户端和服务的连接了。

盼复，谢谢！</div>2021-08-21</li><br/><li><img src="" width="30px"><span>石头</span> 👍（0） 💬（0）<div>zk实际用的是zab，consul用raft，如果探究一下raft的原理会挺有意思的，大大简化了paxos</div>2021-04-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ad/27/5556ae50.jpg" width="30px"><span>Demter</span> 👍（0） 💬（2）<div>直接部署足够多的nginx就行了，为什么还要lvs呢？</div>2020-10-12</li><br/>
</ul>