你好，我是唐扬。

到目前为止，你的垂直电商系统在经过微服务化拆分之后已经运行了一段时间了，系统的扩展性得到了很大的提升，也能够比较平稳地度过高峰期的流量了。

不过最近你发现，随着自己的电商网站知名度越来越高，系统迎来了一些“不速之客”，在凌晨的时候，系统中的搜索商品和用户接口的调用量会急剧上升，持续一段时间之后又回归正常。

**这些搜索请求有一个共同特征是来自固定的几台设备。**当你在搜索服务上加一个针对设备ID的限流功能之后，凌晨的高峰搜索请求不见了。但是不久之后，用户服务也出现了大量爬取用户信息的请求，商品接口出现了大量爬取商品信息的请求。你不得不在这两个服务上也增加一样的限流策略。

**但是这样会有一个问题：**不同的三个服务上使用同一种策略，在代码上会有冗余，无法做到重用，如果其他服务上也出现类似的问题，还要通过拷贝代码来实现，肯定是不行的。

不过作为Java程序员，**你很容易想到：**将限流的功能独立成一个单独的jar包给这三个服务来引用。不过你忽略了一种情况，那就是你的电商团队使用的除了Java，还有PHP和Go等多种语言。

用多种语言开发的服务是没有办法使用jar包来实现限流功能的，**这时你需要引入API网关。**
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/61/58/7b078879.jpg" width="30px"><span>Julien</span> 👍（32） 💬（1）<div>上一讲的负载均衡和这一讲的API网关是什么关系呢？</div>2019-11-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/56/06/ea49b29d.jpg" width="30px"><span>小洛</span> 👍（21） 💬（3）<div>之前用zuul做过网关，思路和老师说的大同小异，有授权，有检验，有限流熔断，也有线程池隔离等，就是聚合服务没有抽成单独的服务来做，因为在组织架构上，大家都不想接手这种聚合别人接口的服务，有时候这种非技术的问题让人特别困惑！所以当初就设计了一个配置api中可以配置多个服务接口，网关把结果整合，然后json返回了！</div>2020-02-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg" width="30px"><span>Darren</span> 👍（14） 💬（2）<div>Spring cloud gateway 性能比zuul好一些，并且是异步的</div>2020-04-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d0/69/5dbdc245.jpg" width="30px"><span>张德</span> 👍（10） 💬（2）<div>老师   请教一下   这个oauth2.0的登录认证   请求是先经过网关后验证是否登录了  还是什么别的流程  能否讲一下这个架构下   登录鉴权应该怎么做？？？</div>2019-11-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/42/86/d05de870.jpg" width="30px"><span>Xiang</span> 👍（4） 💬（1）<div>apisix 这个API网关性能很好  https:&#47;&#47;github.com&#47;apache&#47;incubator-apisix</div>2020-02-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/43/f7/abb7bfe3.jpg" width="30px"><span>刘冲</span> 👍（4） 💬（4）<div>请问，像sql注入拦截这种工作，是后端每个微服务要做的事情呢？还是都应该只需要放在api网关来做？</div>2019-11-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（3） 💬（2）<div>API网关，这个也一定使用过，不过距离自己的编码距离有些远，没实际直接接触过。
类似一个村子的主路口，进村时做安全、鉴权、限流、熔断等控制，出村时做认证、审计、授权等工作。</div>2020-04-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/d5/0e/dae566c7.jpg" width="30px"><span>JOHN</span> 👍（2） 💬（1）<div>看了本文，这边我有几个问题想请教下老师？
1、不太清楚业务网关与聚合服务层之间的区别
2、在服务调用上，我觉得很多接口并不是聚合接口，那是否api网关也可以直接调用原子服务层
3、api网关与web服务的最大区别点就是 web服务多了服务聚合的功能么？？</div>2020-03-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d5/bb/98b93862.jpg" width="30px"><span>古德</span> 👍（2） 💬（1）<div>我的理解聚合业务层就是BFF层吧，一般是按照业务范围来分，应该放网关层后面，网关层和业务要无关</div>2020-01-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/7a/93/c9302518.jpg" width="30px"><span>高志强</span> 👍（1） 💬（2）<div>老师我想问一下，这个api网关处在，负载均衡服务和应用服务之间么，都用它这个api网关万一挂了怎么办？</div>2020-03-31</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJkwbyTYtSCx6Qc7cQPnnRWv38Jybh3etziaPmuP8gHcgS6FMxcdftrKgWiamH6fc2iciaicDKDVEwcEibQ/132" width="30px"><span>sami</span> 👍（1） 💬（1）<div>Spring推出了一个spring cloud gateway</div>2020-03-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/5e/82/438c8534.jpg" width="30px"><span>longslee</span> 👍（1） 💬（1）<div>打卡。只是简单的使用nginx。职责链模式是我最喜欢的设计模式没有之一，哈哈哈。
提个问题：出口网关这里，还是倾向于设计一个直接调用的出口网关吗？那这样的话出口网关怎样通知调用它的下游呢？ 是否采用消息队列？
</div>2019-11-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/a2/6f/d239ed80.jpg" width="30px"><span>王新栋</span> 👍（0） 💬（1）<div>讲的非常好，API入口网关中提到的OAuth更详细的内容可以参考极客时间的另外一篇专栏《OAuth 2.0实战课》，另外出口网关还有一种演化是叫做SPI。</div>2020-08-31</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK310IyFbYZjgYgDvaxibZOic5zbk28FpjLfccfYMSAgt11kd3jicA4Db3NbF8lLl4Cs9m6uRY7EFVWA/132" width="30px"><span>陆江</span> 👍（0） 💬（1）<div>API网关层可以实现灰度发布</div>2020-03-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg" width="30px"><span>安排</span> 👍（0） 💬（2）<div>文中说入口api网关会提供客户端一个统一的接入地址，这里的客户端是说app或浏览器吗？
api网关前面是不是还有nginx负载均衡，那nginx不才是统一的入口吗？
如果api网关前面有nginx，那么nginx会和api网关建立连接吗？然后由api网关再去访问后面的具体服务，并将结果一层层的返回来，最终返回到app用户？
能讲一下用户app访问一个服务的时候，中间经过的组件的具体流程吗？希望能得到老师回答。</div>2020-03-26</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/jXbwicoDwia7ooDfwBTRyvNYQkefnVwF1CMicMS8FqKfuFAdvVZo2pqc4ic0R9kSdHTIxaE6YyqxwX8BdNGv5PqSIw/132" width="30px"><span>kamida</span> 👍（0） 💬（4）<div>web 层被api网关取代了后 那我们还有web server吗 静态文件比如html，css等放到哪里呢</div>2020-03-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/63/7a/e91c3771.jpg" width="30px"><span>WulalaOlala</span> 👍（0） 💬（1）<div>加了api网关，不是每个请求多了一层服务调用？</div>2020-03-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/59/bb/caf2b06c.jpg" width="30px"><span>皮蛋</span> 👍（0） 💬（1）<div>有了api网关还需要ng吗</div>2020-01-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/9b/6e/edd2da0c.jpg" width="30px"><span>蓝魔丶</span> 👍（0） 💬（1）<div>请教老师一下，如果有了性能很不错的入口网关的时候，还有必要使用nginx等web端代理工具嘛？</div>2019-11-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/9b/6e/edd2da0c.jpg" width="30px"><span>蓝魔丶</span> 👍（0） 💬（1）<div>最后的服务蓝图中web层应该还是保留吧，把它放到网关和微服务之间，比如提到了聚合服务就是web层服务</div>2019-11-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/36/f6/d65b7302.jpg" width="30px"><span>峰</span> 👍（0） 💬（1）<div>多路同步复用在哪一节课讲的？</div>2019-11-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ab/10/b812ff3e.jpg" width="30px"><span>Hesher</span> 👍（4） 💬（2）<div>出口网关这个概念还是第一次听到，感谢老师。对于出口网关，做与三方机构接口调用的封装、鉴权和审计。

但问题是第三方接口调用逻辑（比如调用哪几个接口、顺序是什么样的）、鉴权方式差异很大，都放在出口网关去封装，不是反而互相耦合了吗？我这边支付系统是把同类逻辑抽离出来，具体的接口调用和鉴权流程，是对每个二方或三方平台单独部署的微服务。

老师能否在细化讲一下出口网关呢？</div>2020-05-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/1a/05/f154d134.jpg" width="30px"><span>刘楠</span> 👍（2） 💬（0）<div>好像一个过滤器，系统</div>2019-11-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/74/3d/54bbc1df.jpg" width="30px"><span>Jaime</span> 👍（1） 💬（0）<div>老师你好，这个协议转换困扰好多天了，比如从http转grpc，这个协议转换没有办法做到自动转换，目前我只想到两种思路，一个是一大堆reflect操作，一个是动态生成代码去做映射。都觉得好麻烦，想着简单点，目前是想着提供一个sdk给各个微服务，然后在每个微服务端去做协议的映射转换，不知道我这个想法对不对? 多谢老师了😬</div>2020-06-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/75/a8/dfe4cade.jpg" width="30px"><span>电光火石</span> 👍（1） 💬（1）<div>聚合服务是否可以考虑用graphql来做？</div>2019-12-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/68/3f/40d1cd7f.jpg" width="30px"><span>stubborn</span> 👍（1） 💬（5）<div>请教一下老师，增加聚合服务有什么约束条件吗？比如聚合服务要同时写入服务A和服务B，这样很容易引起分布式事务。</div>2019-11-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/29/16/e6/ed66de55.jpg" width="30px"><span>请把小熊还给我</span> 👍（0） 💬（0）<div>老师你好，如果是负载均衡 -&gt; api网关 -&gt; 业务服务的架构，那么负载均衡如何选择服务节点呀？我理解api网关对外提供的是统一的地址，那负载均衡服务如何感知具体的后端服务节点呢？</div>2024-06-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/29/16/e6/ed66de55.jpg" width="30px"><span>请把小熊还给我</span> 👍（0） 💬（0）<div>老师，API网关和负载均衡都是和业务没有直接关联的，它们提供的都是一些辅助性的功能，是否可以把负载均衡的逻辑也放在API网关里面做呢？</div>2024-06-22</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEJh4fE4WryeIpjKCYB7TuWS2IEFV0paiaZt3hSh8jrPZRD8cvalPWndTv1VbdDiaEKibY0IgGGPEMbCw/132" width="30px"><span>刘聪为</span> 👍（0） 💬（0）<div>线程池配额怎么做的</div>2021-10-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/c4/36/4f7239de.jpg" width="30px"><span>codewor</span> 👍（0） 💬（0）<div>老师，请教一个问题，聚合服务与原子服务是同级还是父子关系的？</div>2020-12-08</li><br/>
</ul>