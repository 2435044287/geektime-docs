你好，我是唐扬。

前面几节课，我带你了解了缓存的原理、分类以及常用缓存的使用技巧。我们开始用缓存承担大部分的读压力，从而缓解数据库的查询压力，在提升性能的同时保证系统的稳定性。这时，你的电商系统整体的架构演变成下图的样子：

![](https://static001.geekbang.org/resource/image/6c/05/6c860d61a578cde20591968cc2741a05.jpg?wh=1142%2A559)

我们在Web层和数据库层之间增加了缓存层，请求会首先查询缓存，只有当缓存中没有需要的数据时才会查询数据库。

在这里，你需要关注缓存命中率这个指标（缓存命中率=命中缓存的请求数/总请求数）。一般来说，在你的电商系统中，核心缓存的命中率需要维持在99%甚至是99.9%，哪怕下降1%，系统都会遭受毁灭性的打击。

这绝不是危言耸听，我们来计算一下。假设系统的QPS是10000/s，每次调用会访问10次缓存或者数据库中的数据，那么当缓存命中率仅仅减少1%，数据库每秒就会增加10000 * 10 * 1% = 1000次请求。而一般来说我们单个MySQL节点的读请求量峰值就在1500/s左右，增加的这1000次请求很可能会给数据库造成极大的冲击。

命中率仅仅下降1%造成的影响就如此可怕，更不要说缓存节点故障了。而图中单点部署的缓存节点就成了整体系统中最大的隐患，那我们要如何来解决这个问题，提升缓存的可用性呢？
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/13/71/05/db554eba.jpg" width="30px"><span>👽</span> 👍（47） 💬（1）<div>大概总结了一下：
实现高可用的核心依旧是集群。多个缓存节点，提高容错率。
客户端实现：由客户端的策略决定如何写缓存，如何读缓存。性能高，但是逻辑复杂，无法跨平台。
中间件实现：所有客户端先访问中间件，然后中间件决定了缓存策略。因为引入了中间件，所以性能较差，但是可以跨平台，并且有能力的公司还可以自研中间件。
服务端实现：主从切换由服务端实现。最大的缺点是增加了运维成本。
不知道我的理解是否正确。

</div>2019-10-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（19） 💬（5）<div>高可用的设计思路没有其他的核心就是增加副本，针对数据就增加数据副本，针对服务就增加服务副本，针对机房就增加机房副本，增加副本引入的新问题是数据不一致性，下面各种算法什么的都是为了解决因增加副本而带来的数据不一致性问题或者节点挂了怎么使服务继续可用的策略。比如：数据怎么迁移？故障怎么隔离？故障节点恢复后怎么是否加入？怎么加入？最近热上了看火影，影分术就是鸣人的高可用方式，其他的高可用思路和这个如出一辙。从动漫中也可以看出，这个需要更多能量，对公司而言，需要更多机器和存储空间，技术复杂度也会增加一些，幸好有现成的组件避免人人都重复造轮子的资源浪费。</div>2020-04-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8d/c4/6f97daea.jpg" width="30px"><span>长期规划</span> 👍（16） 💬（4）<div>老师，您之前说4核8G的机器上，MySQL最高支撑QPS为1万，怎样本文开头又说MySQL读峰值才1500&#47;s呢</div>2019-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/5e/82/438c8534.jpg" width="30px"><span>longslee</span> 👍（16） 💬（5）<div>打卡。 老师好，提问：一致性Hash中，比如存在A(k1)、B(k2)、C(k3)，3个节点，括号中为分配的Key，假如B节点剔除了，那么k2会漂移到C节点。 那么此时客户端请求get k2的时候，是被计算好从C节点获取呢，还是完全就拿不到需要去数据库查？如果是从C节点获取，那感觉命中率完全没有下降。 这一点确实没搞清楚，忘老师解惑，谢谢🙏</div>2019-10-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/71/05/db554eba.jpg" width="30px"><span>👽</span> 👍（10） 💬（4）<div>另外就客户端和服务端的理解：
老实说一开始我也一脸懵逼。以为客户端就是用户端。
但是后来想通了。
应用服务器为用户提供数据接口，用户就是客户端，应用就是服务端。
但是缓存为应用服务器提供缓存服务，这时候对于缓存服务器来说应用服务器就是客户端，而缓存就是服务端。</div>2019-10-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8d/c4/6f97daea.jpg" width="30px"><span>长期规划</span> 👍（5） 💬（9）<div>老师，主从会有延迟，写入主库，但延迟同步到从库，在同步完成前去从库读数据，读不到，这如何解决呢</div>2019-12-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/84/39/c8772466.jpg" width="30px"><span>无形</span> 👍（5） 💬（9）<div>还没看完就想说一下我之前的做法，我们有两级缓存，服务器应用程序自身有一个内存缓存，再有Redis缓存，如果内存缓存没有命中，应用程序会创建一个单机的资源锁（go语言，用map+chan实现），大量请求进来，只有第一个请求会获取锁，其他请求获取锁失败，调用wait方法，等待第一个请求获取数据，第一个请求先从Redis中获取数据写入到内存缓存，Redis没有命中再读取MySQL，写会到Redis，执行结束后会通过close chan的方式广播消息，通知其他请求拿到了数据，从内存中读取数据，再释放锁。这样就解决了缓存穿透的问题，同一时刻，不论多大的并发量，真正到存储查询数据的请求只会有一个。</div>2019-11-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/99/27/47aa9dea.jpg" width="30px"><span>阿卡牛</span> 👍（4） 💬（1）<div>老师，这个客户端方案中的客户端指哪里。一般我理解的客户端是浏览器或手机app...</div>2019-10-29</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/jXbwicoDwia7ooDfwBTRyvNYQkefnVwF1CMicMS8FqKfuFAdvVZo2pqc4ic0R9kSdHTIxaE6YyqxwX8BdNGv5PqSIw/132" width="30px"><span>kamida</span> 👍（2） 💬（3）<div>分片策略是怎么配置的呢 比如说客户端或者中间层怎么知道哪个node负责consistent hash ring上的key的？有zookeeper？

还有我记得sentinel不支持分片的吧</div>2020-03-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8d/c4/6f97daea.jpg" width="30px"><span>长期规划</span> 👍（2） 💬（3）<div>老师，Redis Cluster中使用了hash槽，我理解跟一致性hash其实是等价的，对吧。不过，Redis在分片间还实现了在新增节点时自动迁移数据</div>2019-12-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d0/69/5dbdc245.jpg" width="30px"><span>张德</span> 👍（2） 💬（1）<div>老师  最近学习  这里还有一个问题   在Redis的sentinal方案中   读缓存是读Slave结点吗？？   感觉只有读Slave结点   才能实现更高的读请求性能   但是读Slave节点时   Master中的数据还没有同步过来   没有读到结果   或者读到旧数据脏数据的话  这个应该怎么解决  ？？？    还是说  读请求也只能读Master结点</div>2019-12-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/9b/6e/edd2da0c.jpg" width="30px"><span>蓝魔丶</span> 👍（2） 💬（1）<div>老师，memcached的主从机制会考虑分片实现多个主吗，还是单机全量？多副本方案中提到会选用一个主从作为一个副本组，是一个master多个slave的结构吗？但是画图没有标示这种结构</div>2019-10-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/e1/0e/9ce05946.jpg" width="30px"><span>distdev</span> 👍（2） 💬（1）<div>另外您说redis cluster不是高可用方案 为什么？</div>2019-10-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/33/5c/8c0a372a.jpg" width="30px"><span>Fourty Seven</span> 👍（1） 💬（1）<div>它将一个缓存节点计算多个 Hash 值分散到圆环的不同位置，这样既实现了数据的平均，而且当某一个节点故障或者退出的时候，它原先承担的 Key 将以更加平均的方式分配到其他节点上，从而避免雪崩的发生。
老师，这句话啥意思了？是说把一个节点分布到多个位置？</div>2019-11-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d0/69/5dbdc245.jpg" width="30px"><span>张德</span> 👍（1） 💬（4）<div>老师请教一下  客户端一致性哈希算法 四到六个结点  如果四个结点的话  删除一个结点 依然会有四分之一的请求无法命中缓存  感觉这个一直性哈希算法和普通的哈希算法  没有太大区别呀  老师能不能再仔细简介一下这个地方  看不出一致性哈希算法的优势</div>2019-11-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/36/2c/8bd4be3a.jpg" width="30px"><span>小喵喵</span> 👍（1） 💬（1）<div>老师，关于一致性hash有几点疑问，请老师解答：
1.为了防止hash环的倾斜，由实际节点虚拟出来的一部分虚拟节点是如何保证虚拟节点能均匀排列呢？还是说增加虚拟节点的算法可以自定义虚拟节点插入的位置呢？
2.假设一个真实节点宕机了，那是不是那个真实节点相对应的虚拟节点也“宕机”(不可用)了？
3.一致性hash算法在java里或者.net里面有现成的实现吗？若有是对应那个类呢？</div>2019-10-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/78/3e/c39d86f1.jpg" width="30px"><span>Chocolate</span> 👍（1） 💬（1）<div>老师，repcached 算不算 memcached 的服务端高可用方案</div>2019-10-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4e/1b/f4b786b9.jpg" width="30px"><span>飞翔</span> 👍（1） 💬（8）<div>老师 现在有redis cluster了 这个算哪种实现方案？</div>2019-10-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/46/c0/106d98e7.jpg" width="30px"><span>Sam_Deep_Thinking</span> 👍（0） 💬（1）<div>怎么没讲到本地缓存和堆外缓存，这种也是应付瞬时大流量的缓存方案。</div>2020-06-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/f4/05/cbcaaef1.jpg" width="30px"><span>Lin大坑haha~</span> 👍（0） 💬（1）<div>缓存和数据库的同步机制，有没有开源的框架实现呢？</div>2020-03-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/56/06/ea49b29d.jpg" width="30px"><span>小洛</span> 👍（0） 💬（1）<div>多副本就是缓存的缓存。解决单组m&#47;s的单机瓶颈，其实都是为了抵抗大流量，很多问题的解决思路都是相通的，谢谢老师分享</div>2020-02-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/13/f5/21fd4868.jpg" width="30px"><span>什么也不说</span> 👍（0） 💬（2）<div>老师，多副本能举个例子吗？这块没看明白
先是说一组slave会有问题
在这个方案中，当客户端发起查询请求时，请求首先会先从多个副本组中选取一个副本组发起查询，如果查询失败，就继续查询 Master&#47;Slave，并且将查询的结果回种到所有副本组中，避免副本组中脏数据的存在。

最后说在实践中我们会把 Master 和 Slave 作为一组副本组使用。</div>2019-12-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/72/03/da1fcc81.jpg" width="30px"><span>overland</span> 👍（0） 💬（1）<div>老师，那个多副本那块，是每个副本里面存着三个缓存的的热点数据还是，对应的缓存有个副本</div>2019-11-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/76/d6/a9f381bf.jpg" width="30px"><span>天青</span> 👍（0） 💬（1）<div>老师您好，文中的多副本可以解决缓存的热点数据的问题吗？我的理解是在应用服务和缓存服务之间加本地缓存层存储热点数据，起这样吗？还有没有其他解决缓存的热点数据的方式？</div>2019-11-13</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLv9HJIW4OACkjlwOQJ9cU7HzvaDFYkACWCib2lzOMef9ZiaGDTVFqjPicpVK5KDRbBRVGGHrMHQO1Rw/132" width="30px"><span>fdconan</span> 👍（0） 💬（1）<div>请教下，中间层代理方案和服务端方案有什么不同吗？文中没有详细说明哦。</div>2019-11-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/b7/e9/5400cdf3.jpg" width="30px"><span>扬一场远远的风</span> 👍（0） 💬（2）<div>您好，文章中有说MySql的峰值读请求是1500，请问一下这是在什么样的机器配置下？如果硬盘是Ssd，CPU也是多核，且Mysql的buffer能设置好几个Ｇ，万兆网卡的机器配置下是否还是不能超过1500？</div>2019-10-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/35/79/21647da2.jpg" width="30px"><span>Keith</span> 👍（0） 💬（1）<div>你好, 关于客户端模式:
1. 客户端模式是指用户代码的服务端(以我们的电商系统为例)吗?
2. 客户端模式的缓存存放在何处?</div>2019-10-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/82/1a/64ec25ff.jpg" width="30px"><span>陈靖</span> 👍（0） 💬（1）<div>没搞懂客户端和服务端代表啥</div>2019-10-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f8/ba/d28174a9.jpg" width="30px"><span>Geek_zbvt62</span> 👍（0） 💬（1）<div>1. 一致性Hash的脏数据问题里，缓存A和客户端连接出现问题，为什么客户端就能写入到B了呢？
2. 多副本的方案里，为什么说副本组只存储了更加热的数据？非热点数据不从副本组查询么？只要查询，不是依旧会写入？
这个解决方案第一次见，感觉怪怪的。担心slave的承载能力，是不是给slave再接slave就好了呢？</div>2019-10-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/49/85/3f161d95.jpg" width="30px"><span>Alpha</span> 👍（0） 💬（1）<div>请问老师memcached主从方案中是怎么做主从数据同步的，客户端双写吗？</div>2019-10-18</li><br/>
</ul>