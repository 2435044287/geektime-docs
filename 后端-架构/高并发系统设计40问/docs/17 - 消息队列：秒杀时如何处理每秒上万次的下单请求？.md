你好，我是唐扬。

在课程一开始，我就带你了解了高并发系统设计的三个目标：性能、可用性和可扩展性，而在提升系统性能方面我们一直关注的是系统的查询性能，也用了很多的篇幅去讲解数据库的分布式改造，各类缓存的原理和使用技巧。**究其原因在于我们遇到的大部分场景都是读多写少，尤其是在一个系统的初级阶段。**

比如一个社区的系统初期一定是只有少量的种子用户在生产内容，而大部分的用户都在“围观”别人在说什么。此时，整体的流量比较小，而写流量可能只占整体流量的百分之一，那么即使整体的QPS到了10000次/秒，写请求也只是到了每秒100次，如果要对写请求做性能优化，它的性价比确实不太高。

但随着业务发展，你可能会遇到一些存在**高并发写请求的场景，其中秒杀抢购就是最典型的场景。**假设你的商城策划了一期秒杀活动，活动在第五天的00:00开始，仅限前200名，那么秒杀即将开始时，后台会显示用户正在疯狂地刷新APP或者浏览器来保证自己能够尽量早的看到商品。

这时，你面对的依旧是读请求过高，**那么应对的措施有哪些呢？**

因为用户查询的是少量的商品数据，属于查询的热点数据，你可以采用缓存策略将请求尽量挡在上层的缓存中，能被静态化的数据（比如商城里的图片和视频数据）尽量做到静态化，这样就可以命中CDN节点缓存减少Web服务器的查询量和带宽负担。Web服务器比如Nginx可以直接访问分布式缓存节点，从而避免请求到达Tomcat等业务服务器。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/13/dd/5d/ea2e41d0.jpg" width="30px"><span>Victor</span> 👍（44） 💬（24）<div>秒杀场景，使用消息队列的话，怎么保证秒杀产品不超卖，这块计算逻辑是怎么处理的？</div>2019-10-28</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/LUeuiaxdQ6kZgicd40T2QVGBlRjicrkuA1PXXXZnSO70PM1zVLpicneWDVbiajdkEyZjrGKxd5vJYOCibliax2BLVGhCb2OcPXYeYicJATUwPZoG8Uk/132" width="30px"><span>jun.hai</span> 👍（31） 💬（2）<div>老师您好，请教个问题：就是前面同学提到的在秒杀场景一下保证产品不超卖方案用redis的原子性特点，那么这个原子性在客户下单的时候用还是支付成功后才能用到？如果客户下单的时候用了redis的原子性减库存了，一旦客户不支付后取消订单了，这时候怎么处理已减掉的库存问题呢？谢谢</div>2019-12-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/2f/ed/7d7825c4.jpg" width="30px"><span>Kean</span> 👍（26） 💬（10）<div>比如1000件商品  系统生成1000个令牌 拿到令牌的用户可以进入消息队列，其他未拿到令牌的直接返回已抢完，这种方式是否可以？</div>2019-11-08</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/RNO4yZyBvic914hewmNNE8iblYDcfv5yGHZ9OnKuCuZXNmGR0F5qV3icKLT2xpMt66GyEpicZVvrmz8A6TIqt92MQg/132" width="30px"><span>啊啊啊哦哦</span> 👍（21） 💬（10）<div>用户如何知道结果轮循查询。还是长连接通知
</div>2019-10-28</li><br/><li><img src="" width="30px"><span>Geek_Lee</span> 👍（12） 💬（4）<div>看过很多都是关于设计如何缓存，如何hash一致性分库分表等，，但是没有见过讲解服务容器等需求，，，希望老师能给我解答下，，比如说：10000QPS 需要多少台服务器，，需要多少tomcat类似等容器等  我的理解是 请求最终都会到达容器吧，容器扛不住，，上层设计的完美好像也不能完全解决？？？ 老师能帮我解答下吗？？谢谢</div>2019-10-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8d/c4/6f97daea.jpg" width="30px"><span>长期规划</span> 👍（9） 💬（1）<div>我理解这个解耦是为了提高整个系统的可用性。是指将业务系统的耦合转为业务系统与消息队列的耦合。即将多个系统的耦合转为对单一系统的耦合，而且这个单一系统没有业务逻辑，只存储。这两点可大大提高系统的可用性。不解耦的话，系统的可用性=A可用性 x B可用性 x C可用性... ，只要一个子系统不可用，整个系统就宕机了。解耦后只有所用子系统都不可用时，整个系统才不可用。</div>2019-12-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/b3/8f/4caf7f03.jpg" width="30px"><span>Bang</span> 👍（8） 💬（2）<div>秒杀场景使用了，消息队列，那么前端如何得获得秒杀结果呢？
消息队列的消费者，如何编写比较好， 是一个死循环监听程序吗？
</div>2019-10-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0a/e3/9637bfdb.jpg" width="30px"><span>Ricky Fung</span> 👍（5） 💬（4）<div>消息队列的应用场景：1.流量削峰（秒杀系统），2.异步处理（非核心流程异步处理 提升效率），3.系统解耦（用户下单后增加积分、通知仓储服务发货）。常用的消息中间件有rabbitmq、kafka、rocketmq。</div>2019-12-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/a8/05/90b5b097.jpg" width="30px"><span>阴建锋</span> 👍（4） 💬（2）<div>若系统要将所有请求（如:接口的请求与返回报文）的日志入库,如何实现,提高性能且不影响交易？</div>2020-03-29</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqyicZYyW7ahaXgXUD8ZAS8x0t8jx5rYLhwbUCJiawRepKIZfsLdkxdQ9XQMo99c1UDibmNVfFnAqwPg/132" width="30px"><span>程序水果宝</span> 👍（4） 💬（2）<div>消息队列的长度如何设计，以什么为参考？如果请求数量超过了所有消息队列的长度，怎么处理，直接丢弃就可以了吗？</div>2019-10-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c5/2d/1eebfc3c.jpg" width="30px"><span>GaGi</span> 👍（2） 💬（1）<div>对于这句话 “同步流程和异步流程的边界在哪里？”，老师可以列举一些例子吗？这个不是很清楚边界是指什么？</div>2020-04-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/67/0e/2a51a2df.jpg" width="30px"><span>Eric</span> 👍（2） 💬（1）<div>秒杀请求数据库扛不住 转移到消息队列上的入队 那么消息队列能支撑很多并发的入队请求吗?</div>2020-03-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/c4/f3/92f654f1.jpg" width="30px"><span>Bug? Feature!</span> 👍（2） 💬（1）<div>解耦，异步，削峰！
感谢老师的分享，谢谢！</div>2019-10-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a5/67/bf286335.jpg" width="30px"><span>AllenGFLiu</span> 👍（1） 💬（1）<div>我们会在后台启动若干个队列处理程序消费消息队列中的消息，再执行校验库存、下单等逻辑。因为只有有限个队列处理线程在执行，所以落入后端数据库上的并发请求是有限的。
这句话中的“会在后台启动若干个队列”应该是“启动若干个线程”吧？</div>2020-02-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/51/56/6a31a9b4.jpg" width="30px"><span>骑上我心爱的小摩托</span> 👍（1） 💬（2）<div>要是每一章都有代码就好了</div>2020-02-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5f/e5/54325854.jpg" width="30px"><span>范闲</span> 👍（0） 💬（1）<div>消息队列:应用在高并发写请求的时候
1.削峰填谷
2.异步处理
3.系统限流</div>2020-06-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/83/19/0a3fe8c1.jpg" width="30px"><span>Evan</span> 👍（0） 💬（1）<div>如何解决热点数据问题，按产品的数据隔离数据热点，假如有百一台服务器，如何解决热点平均分摊的问题？</div>2020-03-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/76/f5/e3f5bd8d.jpg" width="30px"><span>宝仔</span> 👍（0） 💬（1）<div>削峰填谷，削峰知道什么意思了，填谷是啥意思啊？</div>2020-03-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/10/e8/172b5915.jpg" width="30px"><span>张珂</span> 👍（0） 💬（1）<div>老师，秒杀场景下采用队列的话，那么入队性能必须要好一点，我想问一下这里用Redis的队列OK吗？如果不行的话就采用分布式，但不能超卖，那就得去加锁，那么问题又来了，加锁怎么设计，达到要求的加锁性能？</div>2020-01-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/57/31/6772744d.jpg" width="30px"><span>ちよくん</span> 👍（0） 💬（2）<div>秒杀的MQ其实可以类比计算机CPU处理速度大于主存而中间加了一层高速缓存！</div>2020-01-19</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/ajNVdqHZLLDuUeF7u9lAY3qmfKSfDBQzCJuveFVyIGE7D1PEI8ZQ1kTScwvRdruYHff0zpEnJWlsYicLlWGvcTg/132" width="30px"><span>小虎</span> 👍（0） 💬（2）<div>言简意赅，非常到位，如果能讲讲如何处理消息丢失和重复就更好了哈哈</div>2019-10-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/5e/82/438c8534.jpg" width="30px"><span>longslee</span> 👍（33） 💬（12）<div>打卡。太棒了，终于来到了消息队列环节。据说，有一种处理秒杀方式，是随机让一部分用户直接失败23333.  </div>2019-10-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0a/c0/401c240e.jpg" width="30px"><span>撒旦的堕落</span> 👍（13） 💬（2）<div>负责过课程建设系统  由于课程对于一家教育网站是属于基础数据  所以课程的修改 比如增加了 一个章  需要通知课程审核系统  作业考试  视频学习 日志记录  在线大学等系统  用消息系统替换了rpc调用  降低了系统的响应时间  降低了系统之间的耦合 提升了系统的可维护性</div>2019-10-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/fc/34/c733b116.jpg" width="30px"><span>何磊</span> 👍（3） 💬（4）<div>请教两个问题：
1. 由于秒杀数量是有限的，那么假如商品只有1000，队列满1000后，其他请求是否应该直接拒流呢？
2. 用户请求入队列后，为了及时反馈结果，前端会不断轮训查询结果。查询的读求情也会消耗资源，这部分是采用缓存策略还是结合读写访问不同业务机器来处理呢？</div>2019-11-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5f/81/1c614f4a.jpg" width="30px"><span>stg609</span> 👍（3） 💬（0）<div>老师，有没有哪节课会介绍下 在分布式高并发&quot;写&quot;的时候，可能遇到的问题及解决思路？
比如如何既保证数据的正确，又做到高性能？ 比如分布式锁的利弊？actor模式的利弊等</div>2019-10-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/8a/5a/b67a82e3.jpg" width="30px"><span>shen</span> 👍（2） 💬（0）<div>我们是将库存放到redis中，扣减redis直接通过mq通知db减库存，redis扣完直接返回已经卖光，redis处理性能很高了，老师文章说让用户等50s我觉得要用户是接受不了的</div>2020-04-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/2d/ca/02b0e397.jpg" width="30px"><span>fomy</span> 👍（2） 💬（1）<div>为了系统之间的解耦，比如要对订单金额进行统计时。
异步处理，比如秒杀时，用Redis扣减库存，然后再异步下单，提高并发。
削峰填谷，对一些高并发的请求，先缓存到队列，然后再使用固定线程池消费，降低服务器压力。</div>2019-11-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/9b/6e/edd2da0c.jpg" width="30px"><span>蓝魔丶</span> 👍（2） 💬（0）<div>数据同步、消息系统、短信系统、日志系统、事件广播等</div>2019-10-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg" width="30px"><span>夜辉</span> 👍（1） 💬（1）<div>秒杀活动，让用户等50s后知道结果
没有即时性的反馈，用户体验不好吧，又不是众筹定时开奖活动</div>2021-04-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/79/4b/abb7bfe3.jpg" width="30px"><span>SPxiaomin</span> 👍（1） 💬（1）<div>秒杀系统消息处理机处理了之后，怎么通知客户端服务的？另外建立个结果队列吗？由客户端轮训拉取？</div>2019-11-21</li><br/>
</ul>