你好，我是唐扬。

前几节课，我带你了解了在你的垂直电商项目中，如何将传统的关系型数据库改造成分布式存储服务，以抵抗高并发和大流量的冲击。

对于存储服务来说，我们一般会从两个方面对它做改造：

1.提升它的读写性能，尤其是读性能，因为我们面对的多是一些读多写少的产品。比方说，你离不开的微信朋友圈、微博和淘宝，都是查询QPS远远大于写入QPS。

2.增强它在存储上的扩展能力，从而应对大数据量的存储需求。

我之前带你学习的读写分离和分库分表就是从这两方面出发，改造传统的关系型数据库的，但仍有一些问题无法解决。

比如，在微博项目中关系的数据量达到了千亿，那么即使分隔成1024个库表，每张表的数据量也达到了亿级别，并且关系的数据量还在以极快的速度增加，即使你分隔成再多的库表，数据量也会很快增加到瓶颈。这个问题用传统数据库很难根本解决，因为它在扩展性方面是很弱的，这时，就可以利用NoSQL，因为它有着天生分布式的能力，能够提供优秀的读写性能，可以很好地补充传统关系型数据库的短板。那么它是如何做到的呢？

这节课，我就还是以你的垂直电商系统为例，带你掌握如何用NoSQL数据库和关系型数据库互补，共同承担高并发和大流量的冲击。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/bc/cd0761ff.jpg" width="30px"><span>Richeir</span> 👍（21） 💬（4）<div>这一节学到了很多新东西，感谢唐老师的总结！</div>2019-10-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/84/39/c8772466.jpg" width="30px"><span>无形</span> 👍（74） 💬（19）<div>之前在讲座业务重构中，用es查询数据，其他组的小伙伴维护的es，但是es性能不行，where条件里七八个字段，排序两个字段，查询es基本两千左右QPS，难以支撑支撑十几万人的直播讲座，而且直播人数增长很快，es已经成为了性能瓶颈，查询条件是类标签的，比如几年级，哪个学科，直播类型，还有时间类的，对于这些字段我是可以打标签的，还有开始时间、结束时间，根据类标签的查询特点，我使用了倒排索引+ roaring bitmap 来过滤，使用快速排序对多字段进行排序。使用类延时队列来完成时间的检索。整个检索过程在微秒级，而且对查询的结果做了缓存，查询条件相同的直接从缓存中取，避免了重复检索和排序，查询缓存会在讲座下次修改，更新倒排索引之后清空。重建查询缓存。重构完讲座的检索性能达到了几十倍的性能提升</div>2019-11-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/1d/15/8ad4e24a.jpg" width="30px"><span>yaomon</span> 👍（43） 💬（7）<div>目前的项目就是 MySql 配合 Elasticsearch 使用。Elasticsearch主要是做搜索用，写还是 MySql，同时发Kafka消息，消费端写ES。ES存在丢数据的问题，所以会定时全量&#47;增量从 MySql 中捞数据，覆写 ES，保证数据的一直性。</div>2019-10-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/a2/08/9db00d06.jpg" width="30px"><span>Y</span> 👍（13） 💬（1）<div>老师你好
业务中有个模块写极多读少，这种情况下是不是直接把这个数据拆分出来用单独nosql存储比较好？还是先写到nosql，再慢写到mysql好？
如果慢写到mysql一是可能会出现数据不一致问题，二是写请求会积累很多，内存型nosql支撑不住，可能要用leveldb之类的，磁盘多了一份数据，等要迁移的时候又增加了运维管理成本
</div>2019-10-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/6d/cf/ec335526.jpg" width="30px"><span>jc9090kkk</span> 👍（9） 💬（2）<div>感谢老师分享，对于文中的知识点有一些疑问，希望老师能解答下：
1.采用LSM树的nosql，跟mysql的WAL机制类似，mysql通过redo log和bin log的两阶段提交来保证数据的crash-safe，那么nosql的日志是用来做什么呢？也是为了做数据恢复的吗？
2.像Hbase这样的nosql，涉及的初衷应该是为了做统计而设计的，它支持事务吗？如果支持的话，使用场景是什么？事务的隔离级别都有哪些？因为以我的理解，统计业务，基本都是读请求，很少有写请求，用事务的场景应该极少吧？
3.因为nosql相比传统的关系型数据库来说，拓展性更好，那么就更适合做分布式系统？后期老师有想法讲一讲比如类似redis或者mongoDB这样的系统，分布式系统的一些实际经验或者说踩过什么坑么？很想了解下。。。

思考问题：
公司现在用的nosql包括Redis，ES，Kafka，ClickHouse，采用Redis是用来做cache和秒杀活动，也会有一些异步化的处理，采用Kafka+ES是一是为了采集业务端用户行为，二是ES+Kibana可以提供可视化的数据分析平台供运营部门使用，而且ES在后期的水平拓展的方案上来讲配置和维护比较简单（相比Sphinx而言），为什么采用是因为公司之前接的是第三方的数据统计平台，后期发现统计需要单独定制而且会污染业务代码不好维护，而且有时候会发现数据日志还有丢失的情况导致数据统计异常，所以采用Kafka+ES一起来支撑，从而将业务端的一些耦合较重的埋点逻辑分离出去便于维护，CLickHouse主要是为了生成一些离线的数据报表。</div>2019-10-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/7d/1e/ba1a32aa.jpg" width="30px"><span>Liush</span> 👍（6） 💬（2）<div>老师你好:
其实我对什么时候使用SQL,NOSQL,或者是NEWSQL一直存在很多疑问，就比如微博来说，每天微博增加的博文数量应该是非常大的，如果这部分用关系型数据库来存储是不是分库会很快达到瓶颈？这样会造成重新迁移分布数据,如果手动去迁移分布这部分数据，由于存在大量的历史数据迁移时间是否又是一个问题呢？像微博博文这部分是存储在SQL中还是NOSQL中？如果用nosql的话后续只要简单的将节点加入集群即可，auto sharding的特性会方便很多。如果按照我的理解在电商领域中，订单是核心系统，而且和订单系统关联的商品等数据，这部分使用关系型数据库分库分表的方式去处理，因为这部分系统需要保证事务，但是像商品详情这部分并不需要强事务的数据是否可以存储在NOSQL中？谢谢</div>2019-10-14</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erbY9UsqHZhhVoI69yXNibBBg0TRdUVsKLMg2UZ1R3NJxXdMicqceI5yhdKZ5Ad6CJYO0XpFHlJzIYQ/132" width="30px"><span>饭团</span> 👍（5） 💬（2）<div>老师，再问个问题！如果一类数据需要在nosql和关系形数据库都存储，需要存2次吗？现实开发中这样的情况多吗？能举个例子吗？</div>2019-10-11</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erbY9UsqHZhhVoI69yXNibBBg0TRdUVsKLMg2UZ1R3NJxXdMicqceI5yhdKZ5Ad6CJYO0XpFHlJzIYQ/132" width="30px"><span>饭团</span> 👍（5） 💬（2）<div>老师，是不是这个意思：
首先不管是sql数据库还是nosql数据库，提升写性能都是靠的将随机写转化为顺序写！在这方面mysql使用WAL机制已经做的很好了！但是关系形数据库主要是在扩展性方面有缺陷！相对于除了kv型的nosql数据库，其他类型的和mysql性能都差不多！
感觉mysql主要是在扩展性上有所欠缺！</div>2019-10-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（4） 💬（1）<div>目前REDIS&#47;ES&#47;MQ基本是标配，具体使用那个确实需要深入了解每个存储系统的特性和优劣势，这样才能扬长避短，深入了解需要时间和精力，不过干IT就需要一直学习。老师讲的本就是科普的，这些存储系统那个深入理解都需要花费许多的时间和精力，也有对应的专栏在。不过听听，总会有所受益的。</div>2020-04-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8d/c4/6f97daea.jpg" width="30px"><span>长期规划</span> 👍（4） 💬（4）<div>老师，MongoDB从4.0之后已经支持多文档事务了。之前谈到MySQL与MongoDB，都说当使用事务时，要用MySQL，但现在MySQL对MongoDB的优势已经随着MongoDB的进化而基本没有了，而MongoDB在可用性，可扩展性方面完胜MySQL，我感觉都没有使用MySQL的必要了。不知道这种看法是否正确</div>2019-12-22</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqyicZYyW7ahaXgXUD8ZAS8x0t8jx5rYLhwbUCJiawRepKIZfsLdkxdQ9XQMo99c1UDibmNVfFnAqwPg/132" width="30px"><span>程序水果宝</span> 👍（4） 💬（1）<div>老师说“电商系统中的商品有非常多的字段，并且不同品类的商品的字段也都不尽相同，使用关系型数据库就需要不断增加字段支持，而用文档型数据库就简单很多了”。文档型数据库也应该要新增字段吧，它的简单是体现在哪里呢？</div>2019-10-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4e/60/0d5aa340.jpg" width="30px"><span>gogo</span> 👍（4） 💬（1）<div>老师您好，你文中微博关系的例子中提到传统关系型数据库扩展性的短板，又说明了nosql有很好的性能和扩展性，请问拿微博关系的例子来说，是可以单独用nosql存储呢，还是既要存在nosql中又要保存在msylq中呢？</div>2019-10-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/b7/e9/5400cdf3.jpg" width="30px"><span>扬一场远远的风</span> 👍（3） 💬（1）<div>NOSql使用LSM 树（Log-Structured Merge Tree），牺牲了一定的读性能来换取写入数据的高性能，Hbase、Cassandra、LevelDB 都是用这种算法作为存储的引擎。是不是就是因为读性能的原因，所以走支持自动分片的mongodb, es ,hbase现在还不能替代 mysql (即使mysql 需要在client 写大量的代码来实现分区)?</div>2019-12-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/ed/89/86340059.jpg" width="30px"><span>licong</span> 👍（3） 💬（3）<div>关于《使用 NoSQL 提升写入性能》的那段，我还是有点想法：
即使是NoSQL的一些组件，假如是写磁盘的话，再怎么优化改进，也跟MySQL等传统的关系型数据库的写入性能差不多，都是同一个量级的。
Redis、MemCache等NoSQL数据库之所以读写性能高，是因为直接读写的内存，跟关系型数据库读写磁盘（也会缓存部分数据在内存中），利用的物理资源的性能都完全不是一个数量级。跟具体操作的物理资源的特性关系比较大。</div>2019-10-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/15/27/c5e4ec99.jpg" width="30px"><span>哇哦</span> 👍（3） 💬（1）<div>最近正好碰到分库分表的问题，我们有一个记录表几千w,基本上都是插入和读取，没有连表查询。这种情况是选择myql不分库先分表(就一张表暂时先不分库,)，还是直接用mogodb 之类的(直接放进入建个索引就可以不管了?)。如果是分库分表有什么中间件和框架推荐吗(sharding-jdbc,mycat?),谢谢老师。</div>2019-10-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8d/c4/6f97daea.jpg" width="30px"><span>长期规划</span> 👍（2） 💬（1）<div>老师，MongoDB在对数据进行重新分配时，对服务会有影响吗？如果没有影响，那真是太厉害了。解决了分布式存储的一大难题。原来这个也有通用解决方案</div>2019-12-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/5e/82/438c8534.jpg" width="30px"><span>longslee</span> 👍（2） 💬（5）<div>打卡。咱用到了ElasticSearch和Redis。 选用ES是用来存储海量的，从Kafka入过来的。 Redis用于一些逻辑的过滤或者按时间聚合。 踩过的坑呀，我不知道算不算坑，还是说我们运维能力不够，Redis分布式以后，某个Key在哪，要去好多地方查- -</div>2019-10-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0b/e2/68daf201.jpg" width="30px"><span>Alex</span> 👍（1） 💬（1）<div>最近正在学习es，听了老师的建议后，需要对原理和运维方面做更多的研究，提前排坑。</div>2020-03-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/2e/39/7682b49e.jpg" width="30px"><span>lofaith</span> 👍（1） 💬（1）<div>老师，我有个表数据量很大，但是写少读多，这样的表是否放在nosql中更好呢</div>2020-03-27</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI2icbib62icXtibTkThtyRksbuJLoTLMts7zook2S30MiaBtbz0f5JskwYicwqXkhpYfvCpuYkcvPTibEaQ/132" width="30px"><span>xuanyuan</span> 👍（1） 💬（3）<div>es遇到问题，团队没有人，可以招聘啊，切回mysql的成本不是更大吗？</div>2020-03-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/8f/7d/90598e6d.jpg" width="30px"><span>勇敢的心</span> 👍（1） 💬（1）<div>我想问一下老师，关于日志（包括系统日志、操作日志等等），是放在ES中还是放在mongoDB中比较合适？如果是您，您选择哪一种？</div>2020-01-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/b7/e9/5400cdf3.jpg" width="30px"><span>扬一场远远的风</span> 👍（1） 💬（1）<div>NOSql使用 LSM 树（Log-Structured Merge Tree），牺牲了一定的读性能来换取写入数据的高性能，Hbase、Cassandra、LevelDB 都是用这种算法作为存储的引擎。</div>2019-12-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d4/a2/fa41c8a8.jpg" width="30px"><span>书中迷梦</span> 👍（1） 💬（1）<div>对于技术原型问题，我觉得可以在非核心系统上来实验，积累经验以后再迁移核心系统，还有一个问题想咨询老师，不单单NOSql,像MQ,ZK的数据保存也是记录顺序文件，然后异步同步的！在Java中哪些流是操作顺序写文件的哪些是随机写文件的？还是说顺序和随机是需要自己控制，而Java并没有提供顺序写文件的类？</div>2019-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/c8/34/fb871b2c.jpg" width="30px"><span>海罗沃德</span> 👍（1） 💬（2）<div>使用MongoDB作为一个中间层，把前端需要的跟展示页面相关的数据都按照JSON格式保存起来，后端通过消息队列的形式从实际业务数据库中读取数据维护MongoDB中的数据，前端写入数据时候也是直接更新MongoDB的数据，然后给消息队列发消息，让后端异步的去更新数据库，同时MongoDB中通过定时任务保证只存储热数据，超过10页以上的数据移动到AWS S3这样的文件存储系统中作为冷数据保存

在非支付的业务场景下，这样避免前端直接查询和写入数据库，是否是一个可取的方案，老师对这样的方案有什么建议么？</div>2019-11-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/65/7b/66b9befd.jpg" width="30px"><span>Hwan</span> 👍（1） 💬（1）<div>自己用过ES和Redis,没有使用过MongoDB，不过从老师上面的描述上看，好多地方和ES很相像，比如分片和副本啥的，还有负载均衡，想问下老师，Redis在提升性能方面也是顺序写吗？还是Redis本来就是内存，然后速度很快</div>2019-10-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6b/1b/4b397b80.jpg" width="30px"><span>蛮野</span> 👍（1） 💬（1）<div>Lsm的数据结构，当涉及到修改某条数据时候（已经刷盘了），需要在有序磁盘文件中找到该数据行进行修改，是否也可能存在页分解，造成后续数据的迁移？</div>2019-10-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/72/d8/9eedbc5e.jpg" width="30px"><span>FreeMason</span> 👍（1） 💬（3）<div>对于 随机 IO 与顺序 IO 不是怎么理解，搜索出来的答案解释，都没找到好理解满意的。
疑问：
MySQL + Innodb 日志类文件如：redo log、undo log、binlog ... 等都是顺序 IO，顺序IO 与 随机IO 文件都是放在磁盘上的，为什么数据类都不能跟日志类一样是顺序 IO 呢？</div>2019-10-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/90/76/25eda12f.jpg" width="30px"><span>帝子</span> 👍（1） 💬（1）<div>对于搜索，是不是只需要在es中搜索就可以？不需要到mysql中搜索？</div>2019-10-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d3/6e/281b85aa.jpg" width="30px"><span>永光</span> 👍（1） 💬（1）<div>老师好，
“在性能方面，NoSQL 数据库使用一些算法将对磁盘的随机写转换成顺序写，提升了写的性能；”写性能提高了，读的性能下降了，读性能怎么优化？
谢谢
</div>2019-10-12</li><br/><li><img src="" width="30px"><span>Geek_e986e3</span> 👍（1） 💬（5）<div>老师想问问。你前面说关系型数据库在update某一条数据的时候会产生随即读写。可我看nosql用stable也没有避免这个问题呀。也要去里面查询到这条记录。然后update。求解答。
关于nosql。我之前在业务还没法固定的时候会考虑使用，但是一旦基本不大改动的时候还是会优先选择sql</div>2019-10-12</li><br/>
</ul>