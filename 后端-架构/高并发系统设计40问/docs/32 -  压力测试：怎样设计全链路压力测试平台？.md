你好，我是唐扬。

经过两节课的学习，我们已经搭建了服务端和客户端的监控，通过监控的报表和一些报警规则的设置，你可以实时地跟踪和解决垂直电商系统中出现的问题了。不过，你不能掉以轻心，因为监控只能发现目前系统中已经存在的问题，对于未来可能发生的性能问题是无能为力的。

一旦你的系统流量有大的增长，比如类似“双十一”的流量，那么你在面临性能问题时就可能会手足无措。为了解决后顾之忧，你需要了解在流量增长若干倍的时候，系统的哪些组件或者服务会成为整体系统的瓶颈点，这时你就需要做一次全链路的压力测试。

那么，什么是压力测试呢？要如何来做全链路的压测呢？这两个问题就是本节课重点讲解的内容。

## 什么是压力测试

压力测试（简称为压测）这个名词儿，你在业界的分享中一定听过很多次，当然了，你也可能在项目的研发过程中做过压力测试，所以，对于你来说，压力测试并不陌生。

不过我想让你回想一下，自己是怎么做压力测试的？是不是像很多同学一样：先搭建一套与正式环境功能相同的测试环境，并且导入或者生成一批测试数据，然后在另一台服务器，启动多个线程并发地调用需要压测的接口（接口的参数一般也会设置成相同的，比如，想要压测获取商品信息的接口，那么压测时会使用同一个商品ID）。最后，通过统计访问日志或者查看测试环境的监控系统，来记录最终压测QPS是多少之后，直接交差？
<div><strong>精选留言（19）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/0d/2b/4814d3db.jpg" width="30px"><span>阿土</span> 👍（20） 💬（2）<div>我所在的团队，因为没有资源提供影子库，所以一直做不起来真正的全链路压测。规划的很美好，就因为没有存储隔离，所有的东西都成了泡影。另外，业务系统领导对于系统改造支持压测也不支持，这就造成无法实施。所以目前的全链路压测都是固定的几个账号，几个商品。得到的结果可信度也有限</div>2019-12-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/78/c7/083a3a0b.jpg" width="30px"><span>新世界</span> 👍（16） 💬（1）<div>老师：流量复制和重放后的响应对比有什么工具推荐吗？还是自己去写解析？</div>2019-12-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e9/1a/6ba207a3.jpg" width="30px"><span>天天向善</span> 👍（10） 💬（1）<div>是不是我这样理解，购买商品下单要存储到影子库，第三方支付用mock，支付的回调也mock</div>2019-12-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/b6/74/c63449b1.jpg" width="30px"><span>问题究竟系边度</span> 👍（8） 💬（5）<div>如果服务里面有线程池，异步操作如何染色，发送mq消息之类怎么处理。 </div>2020-04-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/75/a8/dfe4cade.jpg" width="30px"><span>电光火石</span> 👍（7） 💬（1）<div>老师你好，有个问题，压测的流量和正常的流量是否需要分流，比如说正常的访问把他分流到某几台机器上，压测的流量把他分流道几台机器上，做物理隔离？
做的话，因为后面都是一堆的服务，如果每个服务都做分流，复杂度还是蛮高的；不做的话，是否会相互影响，尤其影响到线上流量？
谢谢了！</div>2019-12-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/78/c7/083a3a0b.jpg" width="30px"><span>新世界</span> 👍（6） 💬（1）<div>线上真实环境也是用goreplay做的流量拷贝吗？我最近也在做，但是用goreplay cpu使用率瞬间很高，担心影响线上真实系统，我想请教下老师，你们线上真实环境也是用goreplay 做流量拷贝吗？启动goreplay后也是cpu使用率很高吗</div>2019-12-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d5/bb/98b93862.jpg" width="30px"><span>古德</span> 👍（4） 💬（1）<div>如果是一个新系统还没有上线，是不是就没法通过拷贝流量的方式去做全链路压测了？
另外，如果要对拷贝的流量进行加速重放，有开源的工具能实现吗</div>2020-03-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/75/a8/dfe4cade.jpg" width="30px"><span>电光火石</span> 👍（4） 💬（1）<div>线上做压测，除了技术问题外，还有观念问题，很多人不敢做，怕出事情背锅</div>2019-12-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/82/96/30aaaa68.jpg" width="30px"><span>mghio</span> 👍（0） 💬（1）<div>公司资源和人力有限，目前只做了些主要功能接口压力测试，全链路压测对小公司感觉比较难完成</div>2020-05-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4b/46/717d5cb9.jpg" width="30px"><span>惜心（伟祺）</span> 👍（0） 💬（1）<div>讲的好棒</div>2020-02-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/fc/34/c733b116.jpg" width="30px"><span>何磊</span> 👍（0） 💬（3）<div>唐老师好，我有如下问题：
1. 链路压测的时候是一次压一个接口比如商品详情，还是一次压一个业务比如下单。
2. 如果我想全链路压一个业务（下单）这就涉及到上下游接口的依赖，如：先加购物车，再去下单结算。甚至还有用券等逻辑。如果仅仅是拷贝流量应该无法完成。是否还需要一个其他的机制呢？</div>2019-12-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/28/0d/558f6141.jpg" width="30px"><span>你净瞎说～</span> 👍（0） 💬（1）<div>老师，有个问题想请教一下，关于文中说的将压力测试产生的数据写入到影子库，redis中的key用前缀区分，这是需要改代码做兼容吗？我们现在的做法是代码兼容，比如发送短信，开了mock之后，就永远返回发送成功。</div>2019-12-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4e/60/0d5aa340.jpg" width="30px"><span>gogo</span> 👍（0） 💬（1）<div>老师您好，有个问题：在线上压测的结果 假如是2w qps，但这只是压测流量的数据结果，真实流量没有考虑进来，这样压测怎么反应真实性能呢？</div>2019-12-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（53） 💬（1）<div>前面的观点不敢苟同，压测具体怎么来做首先需要看压测的目的是什么？比如：新开发一个接口服务，想了解他的性能如何，为什么不能自己搭建环境压测？另外，现在都是容器化部署的，申请几台容器和线上容器配置一样，为什么不能评估线上容器的性能？一个服务新增一些代码逻辑，想知道性能损耗有多大，在添加代码逻辑前后进行压测进行对比也是完全可行的。
全链路压测当然好啦！不过每个环节的性能都不能保证达到预期的话，其实是得不尝试的，每逢大促尤其是店庆或双十一必然会进行系统压测。一般是各个系统自己进行压测看看自己的性能如何？如果有性能问题，需要自行先解决。等各个系统的压测都达到预期了才会进行线上全链路压测，此时使用的完全是线上的流量和真实系统，为了压测会进行流量的储备，上游会进行憋单，然后通知各个下游准备好监控及应急预案，然后放量观察。
一次全链路压测耗费成本不少，这种线上全链路压测我不信大部分公司会搞，有些公司估计也没必要搞，所以，我觉得具体怎么搞压测需要看公司的定位，和系统架构一样没必要上来就按阿里的架构来弄，当然，也弄不起的。</div>2020-05-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/28/0d/558f6141.jpg" width="30px"><span>你净瞎说～</span> 👍（2） 💬（0）<div>先搭建一套和生产环境一模一样的性能测试环境，然后造数据，针对一些第三方调用，一键mock ，最后使用Jmeter直接压就完事了</div>2019-12-06</li><br/><li><img src="" width="30px"><span>小胡</span> 👍（1） 💬（1）<div>我怎么总是感觉没有成熟的团队做线上压测风险很大呢</div>2021-09-01</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Ug0tqzEkGlUopeZqF3icbATJFbsNVYwSG0gTK2PEJbYqg3LBMooE6hUkaZ4w3PMOGwmWAYyJeyu79sjzSJCKu7Q/132" width="30px"><span>老衲只吃肉</span> 👍（1） 💬（0）<div>goreplay流量回放， 是不能直接回放生产环境的，如写的操作，用户下单，变成同一个用户又写单？ 是不是要在回放的时候做一些标记处理，然后代码也要能识别这种标记写到影子库？  这个全链路工程改造成本有点大啊。降的不是很细，很多细节都不太清楚怎么实现；又如，只想回放只读的请求，细节是怎么区分出来？</div>2020-11-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg" width="30px"><span>aoe</span> 👍（1） 💬（0）<div>压测工具：JMeter
经济实用：自己找几台机器搭建集群
土豪任性：阿里云全套环境 + JMeter压测服务
理论可行：K8S上想建多少就有多少</div>2020-09-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/2b/2b/301ae7d6.jpg" width="30px"><span>车江毅</span> 👍（0） 💬（0）<div>https:&#47;&#47;gitee.com&#47;chejiangyi&#47;lmc-autotest 全链路压测实践，如你所说，思路都是大同小异，关键是在于实践。</div>2022-11-24</li><br/>
</ul>