> 你好，我是王新栋。

> 在前面几讲，我们一起学习了OAuth 2.0 在开放环境中的使用过程。那么OAuth 2.0 不仅仅可以用在开放的场景中，它可以应用到我们任何需要授权/鉴权的地方，包括微服务。

> 因此今天，我特别邀请了我的朋友杨波，来和你分享一个基于OAuth 2.0/JWT的微服务参考架构。杨波，曾先后担任过携程框架部的研发总监和拍拍贷基础架构部的研发总监，在微服务和OAuth 2.0有非常丰富的实践经验。

> 其中，在携程工作期间，他负责过携程的API网关产品的研发工作，包括它和携程的令牌服务的集成；在拍拍贷工作期间，他负责过拍拍贷的令牌服务的研发和运维工作。这两家公司的令牌服务和OAuth 2.0类似，但要更简单些。

> 接下来，我们就开始学习杨波老师给我们带来的内容吧。

你好，我是杨波。

从单体到微服务架构的演进，是当前企业数字化转型的一大趋势。[OAuth 2.0](https://oauth.net/2/)是当前业界标准的授权协议，它的核心是若干个针对不同场景的令牌颁发和管理流程；而[JWT](https://jwt.io/)是一种轻量级、自包含的令牌，可用于在微服务间安全地传递用户信息。

据我目前了解到的情况，虽然有不少企业已经部分或全部转型到微服务架构，但是在授权认证机制方面，它们一般都是定制自研的，比方说携程和拍拍贷的令牌服务。之所以定制自研，主要原因在于标准的OAuth 2.0协议相对比较复杂，门槛也比较高。定制自研固然可以暂时解决企业的问题，但是不具备通用性，也可能有很多潜在的安全风险。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/59/0f/dfb310b5.jpg" width="30px"><span>西</span> 👍（22） 💬（1）<div>全程使用oauth2令牌，那么网关之后的每个微服务都需要自己根据令牌token去idp或者redis或者mysql中去查询用户信息，如果全程使用jwt令牌，主要是还是由于jwt自包含用户信息，存在暴露用户信息的安全风险。（如果jwt中只存在用户名，不存在其他相关信息也可以考虑全程使用jwt令牌）</div>2020-07-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/ec/0c/f20586b1.jpg" width="30px"><span>良胜</span> 👍（8） 💬（2）<div>王老师，现在我正在搭建一个微服务框架，计划在网关层做集中认证，那网关是否应该时作为OAUTH2的client组建？
另外你画的微服务的架构图，IDP 是作为什么角色？授权服务器还是client，另外Login Svc 又是承担什么工作？

我目前遇到困难，我们期望不管是web侧还是app侧，统一使用token进行认证，并且登录使用手机号+验证码的方式，现在如果访问受限资源，默认会跳到login页面，不是返回json数据，请老师指点</div>2020-08-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4d/54/9c214885.jpg" width="30px"><span>kylexy_0817</span> 👍（8） 💬（2）<div>其实全程使用JWT，也没啥问题，只是如果想其较为安全，就要把公钥放在客户端，让其加密后再传输（或者获取到令牌后就直接加密存放在cookies或localstorage），但JWT的内容较多，即使加密后的内容也会较长，公网环境传输效率不高。而访问令牌，就是为了解决公网传输效率问题。不知有没理解对。</div>2020-08-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4f/13/5197f8d2.jpg" width="30px"><span>永旭</span> 👍（3） 💬（1）<div>老师你好, 查了下BFF相关文章
有些架构图里把BFF放在API 网关层左边, 挨着web层.也有放在API 网关层里边的
能分析分析这两种的有什么优势和劣势 , 区别吗 ?</div>2020-11-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4f/13/5197f8d2.jpg" width="30px"><span>永旭</span> 👍（3） 💬（1）<div>老师, 以前我接触的架构图里有DMG层, 会部署前端. 
现在课程中 微服务架构图里已经没有了 DMG层了. 
要是有的话能部署什么呢 ?</div>2020-11-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/03/e2/5768d26e.jpg" width="30px"><span>inrtyx</span> 👍（3） 💬（3）<div>第六点是关于 Web Session，这个不太明白。token信息肯定要放浏览器啊！不然岂不是每次请求都要登录？</div>2020-07-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/da/ec/779c1a78.jpg" width="30px"><span>往事随风，顺其自然</span> 👍（3） 💬（2）<div>全程采用JWt，用户信息容易暴露，对于安全级别高，最好不使用，对于oauth在安全级别更高，但是实现用户信息更复杂，混合之后，权衡了安全性和易用性，个人理解</div>2020-07-25</li><br/><li><img src="" width="30px"><span>Geek_7c4953</span> 👍（2） 💬（1）<div>有一个问题没有理解，APP用password模式登陆和APP上的浏览器打开统一认证页用用户名密码登录，这两者之间在安全层面上有什么区别？</div>2020-11-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/1f/2f/a6a042ba.jpg" width="30px"><span>Giggle</span> 👍（2） 💬（1）<div>请问老师，若只是一个移动端app，想让其实现Oauth协议，提供对其他app的授权登录，这种app的后台Oauth协议的实现是不是不适合使用SpringSecurityOauth这个框架，因为我看框架源码里面授权码模式或者简易模式都是基于浏览器重定向机制实现返回授权码code或者token，用户未授权情况下还会返回相应的授权页面，我是不是可以理解SpringSecurityOauth其实是解决网站和网站的第三方授权的场景，假如我是一个移动端的后台，就不适合使用这个框架。</div>2020-10-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/88/23/a0966b4d.jpg" width="30px"><span>Tim Zhang</span> 👍（2） 💬（2）<div>网关获得 JWT 令牌，校验 Scope 是否有权限调用 API，如果有就转发到后台 API 进行调用。

校验是如何校验的？ 并且scope 和 authority有啥区别么</div>2020-07-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/8a/a3/aee7ded7.jpg" width="30px"><span>在路上</span> 👍（2） 💬（1）<div>全程采用JWT令牌模式，包含很多用户信息，权限信息，有泄露风险；jwt信息如果被修改，有权限越界的风险。采用OAuth令牌模式用户信息安全无问题，在领域层每次都要通过令牌查询用户级权限信息，加大的领域服务的开销，影响性能。</div>2020-07-26</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKmyjUJe2Fxe7xkpfe3fLiaukp7NJNCictNMC1wYYuIibIGN8ED5U5yR8wBWYqiaZubHpdPOibH80JB6iaQ/132" width="30px"><span>LYF_Mr</span> 👍（1） 💬（1）<div>王老师，我想问下，如果各个domain 服务之间有依赖，该如何处理？例如 A domain 进行添加数据时，其中某字段需要从 B domain 中，获取该值，那么该业务逻辑，是不是得封装在BFF层，而不应该在domain服务中实现？</div>2021-01-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0c/52/f25c3636.jpg" width="30px"><span>长脖子树</span> 👍（1） 💬（1）<div>有个问题, 场景 1：第一方 Web 应用 + 资源拥有者凭据模式 这张图里https:&#47;&#47;static001.geekbang.org&#47;resource&#47;image&#47;b6&#47;bd&#47;b658befe1da937fa3685b55522487dbd.jpg
第4步 Web 应用将用户名、密码，通过网关转发到 IDP 的令牌获取端点（POST &#47;oauth2&#47;token，grant_type=password）。
这里发送的参数包含了 client_id , client_secret, username, password 都传给了网关, 但这样不是暴露了 单个应用唯一的 client_secret (app_secert) 了么?
还是说这里的web应用, 还包含了其后台系统? 是通过后台系统直接访问内网的 IDP 服务的? </div>2020-10-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/92/fa/25b63c06.jpg" width="30px"><span>.</span> 👍（1） 💬（2）<div>session存在cookie中安全吗</div>2020-08-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/30/5e/c42bc33f.jpg" width="30px"><span>Younger Ku</span> 👍（1） 💬（1）<div>我们前端用的VUE，直接就被nginx静态代理了，nginx直接转发到用spring gateway实现的网关。那么微服务架构图中的 web 对应我们系统中的那一块呢？</div>2020-08-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/30/5e/c42bc33f.jpg" width="30px"><span>Younger Ku</span> 👍（1） 💬（1）<div>IDP 校验令牌通过后，将令牌和用户信息对应关系存储在redis中，同时返回给网关OAuth2.0令牌而不是包含用户信息的JWT。网关校验scope信息有权调用API就转发，API中再根据OAuth2.0令牌从redis中获取用户信息而不是解析JWT。请问这种方式可行不？另外验证scope是在网关中做还是网关在调用其他服务？</div>2020-08-20</li><br/><li><img src="" width="30px"><span>Geek_334e32</span> 👍（1） 💬（3）<div>场景 2：第一方移动应用 + 授权码许可模式。  这个不合适吧？现在app登陆都是用户名和密码或者验证码模式。</div>2020-07-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/7c/63/115a4b23.jpg" width="30px"><span>静海</span> 👍（0） 💬（1）<div>Spring Security OAuth，自定义token失效异常能否讲讲，</div>2021-07-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/73/a6/94b772ad.jpg" width="30px"><span>心如止水</span> 👍（0） 💬（1）<div>求解答：
网关向前对接：1.web网页、手机app、微信；2.这里前端都存了accessToken。那refreshToken也存在前端吗？
网关向后：判断是否有token，有则转换为用户信息(token不能存储太多的信息，会用redis存储更多数据，或者直接数据库查)，或者直接往后仍，没有则需要登录。
我做过在前台当做一个子系统这种，存储了clientId secret
也做过在后台把资源服务器作为一个客户端的，然后重新建立一个假的资源服务器的。
但是发现两种办法都有点取巧。
现在想能不能把网关作为客户端？前端展示页面或者手机app直接跟网关对接，登录了之后前端就可以通过实际的网关客户端返回accessToken，网关自己存储一份refreshToken（这里会用redis之类的吧？）。</div>2020-12-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/94/46/e158ab35.jpg" width="30px"><span>刘中</span> 👍（0） 💬（1）<div>作者你好，想问下在公司内部web前端和第三方应用均实现一次登录全部使用，是不是可以将内部web前端也当做第三方应用实现授权码模式即可。。</div>2020-12-27</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIq15Qq887bH7Z5aQHfXu5vHUj4Iz68RotmUIR12vG5Y3L7icUcYgL4hicwAKYyicAmPTtoZPNPfDPOg/132" width="30px"><span>流云</span> 👍（0） 💬（2）<div>如果后台管理系统是独立的用户体系，需要通过rbac认证，什么样的架构比较好呢</div>2020-10-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/94/e8/8582a747.jpg" width="30px"><span>陈威somebody</span> 👍（0） 💬（1）<div>如果是后台服务间的请求（也就是并非由用户发出的请求，而是后台服务1向向后台服务2发出请求），这种情况需要刷新令牌嘛？我想到的一个edge case是，后台服务发出的请求只有1秒的有效期，但是后台服务2花了2秒才做完，这过期了怎么办？</div>2020-10-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c4/03/f753fda7.jpg" width="30px"><span>JianXu</span> 👍（0） 💬（1）<div>老师，如果通过ApI gateway 来做权限检查，那不就相当于我家只有大门上锁，进了大门以后每个房间都是敞开的因为每个domain 服务都不检查权限了。这样只要有人侵入到任何一个ApI gateway 之后的服务，就随便调用domain 服务了，这样不安全吧。</div>2020-10-18</li><br/><li><img src="" width="30px"><span>Geek_b23444</span> 👍（0） 💬（1）<div>请问一下，实现sso,需要集中登入页吗，各个子系统可以自定义自己的登入页吗？</div>2020-08-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/30/5e/c42bc33f.jpg" width="30px"><span>Younger Ku</span> 👍（0） 💬（2）<div>如果接口的并发访问量特别大话 ，所有需要鉴权的接口每次调用经过网关的时候都需要调用IDP验证令牌，然后生成JWT返回网关，网关验证scope通过后再发起对api的真实调用，这样会不会影响性能啊？！</div>2020-08-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/bc/25/1c92a90c.jpg" width="30px"><span>tt</span> 👍（0） 💬（3）<div>有一个问题，JWT一般是加密的，在网关之后使用JWT仍然需要加密么？那会不会因为加解密带来性能问题？如果此时对报文内容也采用对称加密，性能下降会更严重。

该怎么处理呢？有了客户端凭据（appid + appsecret）对三方软件做认证的情况下，还需要公私钥证书或者硬Token么？</div>2020-07-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/50/e5/4048aa15.jpg" width="30px"><span>Zhou</span> 👍（0） 💬（1）<div>Anonymous user的请求在网关和oauth2上面应该怎么处理比较好？</div>2020-07-25</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELtOO0HKrj5SI5JSlmwiaCvaF6GLiaTmf5NX88OZaO3HymTAGTeIoicBUjqzmMF6sF5raPFjuqLFibrrw/132" width="30px"><span>gesanri</span> 👍（1） 💬（0）<div>这里网关层的根据access token生成jwt，是不是只有第一次才会这样，完后就把这个映射关系存起来了，后面access token再来就直接取jwt了，否则每次都生成的话就没意义了</div>2022-02-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/83/22/c3dae274.jpg" width="30px"><span>阿kai(aeo</span> 👍（0） 💬（0）<div>&quot;也可以采用简单的客户端 Session 方式，也称无状态 Session，也就是在客户端浏览器 Cookie 中保存 OAuth 2.0 访问令牌。&quot; - 没有很理解老师说的这句话，如果OAuth 2.0 访问令牌放在cookie里，那不是可能会被造成访问令牌泄漏吗？</div>2022-11-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/5c/13/d1a75b2e.jpg" width="30px"><span>ascend</span> 👍（0） 💬（1）<div>跨域的SSO怎么处理？</div>2022-03-11</li><br/>
</ul>