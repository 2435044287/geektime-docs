你好，我是王新栋。

在上一讲，我从为什么需要授权码这个问题开始，为你串了一遍授权码许可流程整体的通信过程。在接下来的三讲中，我会着重为你讲解关于授权服务的工作流程、授权过程中的令牌，以及如何接入OAuth 2.0。这样一来，你就可以吃透授权码许可这一最经典、最完备、最常用的授权流程了，以后再处理授权相关的逻辑就更得心应手了。现在呢，让我们开始这一讲。

在介绍授权码许可类型时，我提到了很多次 “授权服务”。一句话概括，授权服务就是**负责颁发访问令牌**的服务。更进一步地讲，OAuth 2.0的核心是授权服务，而授权服务的核心就是令牌。

为什么这么说呢？当第三方软件比如小兔，要想获取小明在京东店铺的订单，就必须先从京东商家开放平台的授权服务那里获取访问令牌，进而通过访问令牌来 **“代表”** 小明去请求小明的订单数据。这不恰恰就是整个OAuth 2.0授权体系的核心吗？

那么，授权服务到底是怎么生成访问令牌的，这其中包含了哪些操作呢？还有一个问题是，访问令牌过期了而用户又不在场的情况下，又如何重新生成访问令牌呢？

带着这两个问题，我们就以授权码许可类型为例，一起深入探索下授权服务这个核心组件吧。

## 授权服务的工作过程

开始之前，你还是要先回想下小明给小兔软件授权订单数据的整个流程。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/f8/ba/d28174a9.jpg" width="30px"><span>Geek_zbvt62</span> 👍（15） 💬（3）<div>在上一节回答留言时，老师提到，用refresh刷新access时，如果access没过期，那会给这个access续期而不会重新生成？
这节课没提到这个。请问这是oauth规定的么？或者一般都这样实现？
因为我感觉无限续期会增加access被破解的风险</div>2020-07-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/fa/dd/f640711f.jpg" width="30px"><span>哈德韦</span> 👍（9） 💬（2）<div>请问什么是 rscope？和上下文中的 scope 是一回事吗？这个 r 代表什么？</div>2020-07-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/99/b1/46570b0c.jpg" width="30px"><span>申玉宝</span> 👍（9） 💬（12）<div>为什么要 通过刷新令牌让第三方不断刷新token有效期，而不是直接给访问token一个更长的有效期？后者更简单</div>2020-07-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4f/13/5197f8d2.jpg" width="30px"><span>永旭</span> 👍（7） 💬（4）<div>当第三方软件的访问令牌过期, 触发了刷新令牌的刷新,
从新生成访问令牌和刷新令牌, 这是过期时间又被重置. 
如此循环是不是说, 永远不会过期啊 ??</div>2020-11-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/f9/15/584103d6.jpg" width="30px"><span>Ryan Pan</span> 👍（6） 💬（1）<div>请问为什麽刷新令牌用过了一定要废除呢?
有过期时间的话其实也可以用同一个来产生访问令牌不是吗?
还有想问一般来说刷新令牌的期限会设多久呢?
</div>2020-07-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/22/e0/6295a753.jpg" width="30px"><span>Harvey</span> 👍（5） 💬（8）<div>既然第三方软件需要先在授权服务上注册，那为什么不在注册时直接把回调地址也注册了，这样不是更安全？</div>2020-07-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d6/df/1e4ecd94.jpg" width="30px"><span>AA</span> 👍（5） 💬（6）<div>淘宝的refresh_token也有过期时间，通过refresh_token刷新后，返回来assessToken和refresh_token，但refresh_token过期时间不会重新刷新，这是为什么要这样设置呢，当refresh_token为0时，是不是只能通过重新登录授权</div>2020-07-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/4f/26/f21afb83.jpg" width="30px"><span>暖色浮余生</span> 👍（5） 💬（2）<div>刷新令牌有过期时间吧，不过一般设置的时间比较长。反正微信公众号的挺长的，还有一直不明白 scope的 权限范围指的是一个什么样的范围</div>2020-07-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/b0/2f/e2096905.jpg" width="30px"><span>马成</span> 👍（4） 💬（4）<div>刷新令牌和授权码的处理机制感觉非常相似。只是code是第一次生成的，刷新令牌是后续生成的，功能都是换取访问令牌。我觉得这里还有一个点没说，就是在访问令牌有效期的前半段时间，使用刷新令牌换取的访问令牌是不变的。想问一下设计上可不可使用访问令牌来换取新的访问令牌？</div>2020-07-05</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIaOAxRlZjFkGfRBn420LuAcyWkMrpq5iafGdqthX5icJPjql0ibZOAdafaqbfvw4ZpVzDmsaYglVXDw/132" width="30px"><span>唐朝农民</span> 👍（3） 💬（1）<div>String appStr = refreshTokenMap.get(&quot;refresh_token&quot;);
if(!appStr.startsWith(appId+&quot;|&quot;+&quot;USERTEST&quot;)){&#47;&#47;该refresh_token值 不是颁发给该 第三方软件的
    return;
 }
有一点不是很明白，授权服务是一个平台，不可能针对“小明”一个用户，那么在验证refresh_token时肯定不能硬编码成“USERTEST”，而是从上下文中获取的，请求这个用户ID 是 怎么传递的呢？</div>2020-07-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（3） 💬（2）<div>刷新令牌肯定是有过期时间的，要不然一次授权终身有效。 一般刷新令牌的有效期为 30 天，过期后会让用户再进行授权。
</div>2020-07-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/35/d1/12439914.jpg" width="30px"><span>树洞老人</span> 👍（2） 💬（2）<div>您好老师，我们一般如何验证第三方软件是否合法呢？</div>2020-08-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/9a/e2/271e0caf.jpg" width="30px"><span>依韵</span> 👍（2） 💬（2）<div>刷新令牌应该也是有过期时间的，因为刷新令牌有效就可以换取新的access_token，若refresh_token一直有效，那么就可以一直换取新的access_token。
令牌只存是一个多上时间有效是不够的吧，至少得加上颁发的时间、或者直接推算存上截止时间。
有一个疑问，通常会有这么一个功能：小明授权小兔一个月的访问权限。这点如何是如何实现的，目前能想到的是，存下这个期限，验证时加上是否还在范围内的判断，或者每次换新令牌时直接将令牌上的期限进行修正（假设在第28天换新令牌，令牌是5天，这这一次给的新令牌应该只有2天）。虽然都能实现，但想问，这块的标准是如何实现的。</div>2020-07-04</li><br/><li><img src="" width="30px"><span>有翼之暗</span> 👍（1） 💬（1）<div>令牌失效是在授权服务器中失效，那是怎么实现的让第三方软件中的令牌也失效呢？</div>2020-08-19</li><br/><li><img src="" width="30px"><span>有翼之暗</span> 👍（1） 💬（1）<div>刷新令牌是怎么实现触发刷新的呢？，是有一个后台守护线程不断扫描吗？是依据什么来判断令牌需要刷新呢？</div>2020-08-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/20/17/b6/ac21f221.jpg" width="30px"><span>Edison鹏</span> 👍（1） 💬（1）<div>有一点疑问：通过授权码获取到的用户token和用户主动登录获取到的token是同一个吗？如果不是同一个，那岂不是通过授权码获取到token之后 用户原来主动登录的token就失效了？但是根据历史经验来说并没有因为授权通过之后原来的应用需要重新登录啊。所以结论是 通过授权码获取到的用户token不会新生成？</div>2020-08-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg" width="30px"><span>piboye</span> 👍（1） 💬（2）<div>appsecret不应该是直接判断相等吧，appsecret不会出现在包中吧，他只是做hash验证吧</div>2020-07-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/60/ec/11cf22de.jpg" width="30px"><span>名:海东</span> 👍（1） 💬（1）<div>刷新令牌应该也是由过期时间的，不然可能存在安全问题。有个问题，需要请教老师，第三方软件(如小兔打单软件)注册到授权服务时是怎样的？它注册时有没有申请权限一说？应该没有用户(如小明)参与吧？第三方软件在用户授权时应该提前在授权服务做了注册。</div>2020-07-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/dc/71/859a59d5.jpg" width="30px"><span>hom</span> 👍（1） 💬（1）<div>请教下两个问题：
1、不断用刷新令牌一直刷新，那token是不是可以无限延长？
2、code在流程中被劫持了怎么办？ </div>2020-07-10</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/mG8pYHVExw91oF4kB43rlWtltZqx3SJPriad1GgJYZgZ3hgrkwEM9sXFVSzVliblmmN4QCxNuo5vicE26YBVBkiaXw/132" width="30px"><span>chuck</span> 👍（1） 💬（1）<div>权限范围如何验证？</div>2020-07-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/bc/25/1c92a90c.jpg" width="30px"><span>tt</span> 👍（1） 💬（2）<div>老师，有个问题一直不明白，请教一下。

用户名和密码，密码是不应该在网络上传输的，传输的一般是哈希值。

那为什么检验三方软件的身份时，app_secret可以通过网络传输呢？</div>2020-07-06</li><br/><li><img src="" width="30px"><span>Geek_be0aff</span> 👍（1） 💬（3）<div>请教老师，第三方获取access_token后，请求中带上access_token访问订单系统时，订单需要需要把access_token和请求的资源发给授权服务器做验证吧？订单系统是不需要对请求做权限校验吧？？订单系统发给授权服务的请求，是不是需要带上access_token，资源拥有者的user_id，订单系统的ID（明确客户请求的是订单系统，而不是商品系统），请求的资源；然后授权服务对请求做权限校验，结果返回给订单系统，是这样吗？特别是订单系统的唯一标识，是一定要带的吧？</div>2020-07-05</li><br/><li><img src="" width="30px"><span>有翼之暗</span> 👍（0） 💬（2）<div>访问令牌失效是什么意思？,访问令牌不是存储在授权服务器吗，所以访问令牌失效是指在授权服务器删除访问令牌吗？那这样的话，第三方软件拿到的访问令牌不是并未失效吗？</div>2020-08-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/2c/f7/e8cac1f4.jpg" width="30px"><span>泽</span> 👍（0） 💬（1）<div>请问下老师，用户登录第三方软件，用户的userid是存在哪里的，授权服务是如何user id的？</div>2020-08-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/11/65/a29958da.jpg" width="30px"><span>稻草人</span> 👍（0） 💬（1）<div>老师好，刷新令牌生成新的令牌，这个新生成的令牌有没有特定的规则，或者说算法，还是只是一个随机数，当我调用刷新令牌接口的时候是不是需要做一下权限的验证，不是谁都可以随便调用刷新令牌的接口的吧？ 期待老师回复</div>2020-07-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/11/65/a29958da.jpg" width="30px"><span>稻草人</span> 👍（0） 💬（1）<div>老师好，refresh_token 令牌 获取新的令牌， 只需要调用刷新令牌接口就可以了么，不需要再次校验appkey和密钥了吗，不是谁都可以调的吧</div>2020-07-22</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK4ibibOsboHycltqqicSIkm9eibSBu86BRNc0LQnTRTMEPGDvJXYpBicWOW4srMt7c9iaUT7b5mTmicgkjw/132" width="30px"><span>Geek_6a58c7</span> 👍（0） 💬（1）<div>老师你好，有一个问题请教一下，授权码最终还是转成access_token并在网络中传输，这样从安全角度来说还是还是不安全的，这和授权服务直接返回access_token区别是什么，用授权码主要是解决什么问题呢？</div>2020-07-14</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/mG8pYHVExw91oF4kB43rlWtltZqx3SJPriad1GgJYZgZ3hgrkwEM9sXFVSzVliblmmN4QCxNuo5vicE26YBVBkiaXw/132" width="30px"><span>chuck</span> 👍（0） 💬（1）<div>授权页面是要存储在授权服务的后端？有没有可能存在前端（项目前后端分离的）</div>2020-07-09</li><br/><li><img src="" width="30px"><span>小瞿同学</span> 👍（0） 💬（2）<div>还是没弄懂AT和RT的主要差别 我觉得AT如果因为泄漏导致不安全的话 那RT也有同样的问题啊</div>2020-07-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/7f/24/719ce9d4.jpg" width="30px"><span>AgCl</span> 👍（0） 💬（1）<div>老师，您好，不太理解scope的实现，scope背后还有一套授权的实现了对吗</div>2020-07-06</li><br/>
</ul>