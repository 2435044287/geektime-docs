你好，我是王新栋。

在课程正式开始之前，我想先问你个问题。第一次使用极客时间App的时候，你是直接使用了第三方帐号（比如微信、微博）登录，还是选择了重新注册新用户？如果你选择了重新注册用户，那你还得上传头像、输入用户名等信息。但如果你选择了使用第三方帐号微信来登录，那极客时间会直接使用你微信的这些信息作为基础信息，你就能省心很多。

到这里，我估计你会问，这是怎么实现的？微信把我的个人信息给了极客时间，它又是怎么保证我的数据安全的呢？

其实，微信这一系列授权背后的原理都可以归到一个词上，那就是OAuth 2.0。今天这节课，我们就来看看OAuth 2.0到底是什么、能干什么以及它是怎么干的。

## OAuth 2.0是什么？

用一句话总结来说，OAuth 2.0就是一种授权协议。那如何理解这里的“授权”呢？

我举个咱们生活中的例子。假如你是一名销售人员，你想去百度拜访你的大客户王总。到了百度的大楼之后，保安拦住了你，问你要工牌。你说：“保安大哥啊，我是来拜访王总的，哪里有什么工牌”。保安大哥说：“那你要去前台做个登记”。

然后你就赶紧来到前台，前台美女问你是不是做了登记。你说王总秘书昨天有要你的手机号，说是已经做过预约。小姐姐确认之后往你的手机发了个验证码，你把验证码告诉了前台小姐姐之后，她给了你一张门禁卡，于是你就可以开心地去见王总了。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/13/03/e2/5768d26e.jpg" width="30px"><span>inrtyx</span> 👍（47） 💬（17）<div>为什么要用授权码换取token，而不是直接获取token？
？</div>2020-06-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/55/6a/b7f3abb0.jpg" width="30px"><span>Geek_aceb32</span> 👍（20） 💬（8）<div>我有个疑问，小兔把客户引导到京东开放平台上，如果小兔是恶意的，做了一个和京东一样的网页让用户授权，一般用户难以仔细区分，小兔不就能拿到用户的密码了吗？</div>2020-06-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/05/02/52a52265.jpg" width="30px"><span>gavin</span> 👍（13） 💬（2）<div>这里的授权服务和受保护资源服务都是京东商家开放平台（不过应该是对应授权服务和订单服务）、客户端（第三方软件）对应的是小兔软件、资源的拥有者小明通过OAuth2.0的授权码模式授权后，小兔软件可以访问对应的订单，这里有两个点，需要老师给指点一下是否理解的正确：
1. 授权码模式我一直理解其比Implicit模式的安全性主要体现在，其访问令牌是基于再次的https请求的返回值，是加密传递的，而Implicit模式的授权码是get请求参数跳转返回的，所以安全性不高。
2. OAuth2.0的授权是基于scope实现的，一个scope值会对应一些可以访问的资源，在小兔软件请求获取授权时，要声明对应scope，小明在授权页面上能够清楚的看到授权的scope是什么，对应的返回的访问凭据也应该包含scope信息。
而且凭据中也包含了小明的身份信息，这样最终授权访问的就是scope对应的小明的相关资源。</div>2020-06-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/20/17/b6/ac21f221.jpg" width="30px"><span>Edison鹏</span> 👍（6） 💬（1）<div>我的理解：1.通过第三方应用授权通过拿到的token和用户主动登录开放平台所获得的token是两个独立的token？</div>2020-08-02</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoOGZ6lbHiboIZMN9USbeutnmCWBahVLtSlKlIENKvrZQCUQzpzeZQOxTntIkBUeDk6qZUPdqmfKrQ/132" width="30px"><span>宝宝太喜欢极客时间了</span> 👍（6） 💬（1）<div>令牌跟sessionId有什么本质区别？</div>2020-07-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/93/c4/69918422.jpg" width="30px"><span>baitaoccb</span> 👍（5） 💬（3）<div>请问为什么授权者授权后，不直接返回令牌？而是先返回授权码，然后第三方软件再通过授权码得到令牌？</div>2020-06-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/6e/75/159bafb9.jpg" width="30px"><span>兰正浩</span> 👍（4） 💬（1）<div>如何确保小兔软件只访问订单数据？</div>2020-06-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/17/3b/37bcd31e.jpg" width="30px"><span>扎紧绷带</span> 👍（3） 💬（3）<div>栋哥，我要提一个比较超前的问题，因为现在正在做一个开放平台，目前用到密码模式，第三方客户端可以通过我们平台的账号密码，访问一些数据。我的问题是，这个密码该怎样加密？可以简单说下吗</div>2020-07-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/1a/f3/41d5ba7d.jpg" width="30px"><span>iLeGeND</span> 👍（3） 💬（1）<div>oauth2 一种规范或者解决方案，还是框架？</div>2020-06-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/5b/c7/5d8b2d4f.jpg" width="30px"><span>星夜宝宝</span> 👍（3） 💬（3）<div>老师能写弄一个spring boot版本的吗？</div>2020-06-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/06/08/855abb02.jpg" width="30px"><span>Seven.Lin澤耿</span> 👍（3） 💬（2）<div>我们项目使用OAuth2.0 ，但是还是使用账号密码登录，是不是等于没有用授权的特性了==、</div>2020-06-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/4f/26/f21afb83.jpg" width="30px"><span>暖色浮余生</span> 👍（2） 💬（2）<div>最近刚好在学习这个OAuth2。觉得很绕，搞不懂各种模式应该应用在哪一种场景下，感觉这个课就是个救星啊哈哈。 </div>2020-06-30</li><br/><li><img src="" width="30px"><span>胡化敏</span> 👍（2） 💬（1）<div>故事讲的不错</div>2020-06-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/8a/a3/aee7ded7.jpg" width="30px"><span>在路上</span> 👍（1） 💬（1）<div>王老师，小兔三方软件拿到的令牌一般是多久，每次都需要重新授权，还是周期性的  一天  一周 一月 一年这种</div>2020-07-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/fe/83/df562574.jpg" width="30px"><span>慎独明强</span> 👍（1） 💬（1）<div>OAuth2.0是开放授权协议，通过用户登录后，再去授权给第三方，开放平台会给第三方erp系统一个授权认证码，第三方erp再与开放平台系统进行认证，颁发一个Access token访问令牌，令牌会有过期时间，第三方erp拿到令牌，再使用令牌请求拉单接口，就可以通过开放平台的认证访问到我们订单系统的订单数据。之前自己负责订单这块，给开放平台提供拉单接口，老师讲的这个例子，很生动。</div>2020-07-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/50/54/558506ee.jpg" width="30px"><span>沉淀</span> 👍（1） 💬（2）<div>1. 用户在获得了访问资源的token之后，去开放平台获取资源，所有资源的请求都需要通过开放平台，那开放平台就会成为一个瓶颈？不知道实际中有没有办法解决这个问题。
2. 用户授权了之后一般第三方应用就可以通过token获取资源，所以用户授权的记录需要在开放平台保留下来，用户每次的登录都会有过期时间，那就会有过期时间的刷新问题，而每次请求都要刷新这个过期时间，请求量大的时候，这个刷新也会成为一个瓶颈。大佬有好的解决方案么?
</div>2020-07-07</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJman25D8JlricJVaeweYqr70vyp2acetStqbtaDnCnroGXvuJfgr1As9q47iacTCUUMK1eRUt4KImg/132" width="30px"><span>进阶的小孔</span> 👍（0） 💬（1）<div>看完之后接着看留言，帮助不是一般的大</div>2020-07-24</li><br/><li><img src="" width="30px"><span>witluo</span> 👍（0） 💬（2）<div>期待详细讲解一下： 为什么用户授权后不直接返回access_token， 而是先需要返回 授权code。 需要中间多一个环节(code换取accessToken)  , 个人觉得直接返回access_token也没什么问题。 </div>2020-06-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/f8/ea/98738420.jpg" width="30px"><span>Jaswine</span> 👍（9） 💬（0）<div>访问百度的案例中有以下角色:我（client），前台王小姐（百度的授权、鉴权服务），大客户王总（资源），百度（资源所在的服务器）。</div>2020-06-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/1a/f3/41d5ba7d.jpg" width="30px"><span>iLeGeND</span> 👍（4） 💬（2）<div>
为什么直接用授权码 还弄个令牌</div>2020-06-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/d8/5d/07dfb3b5.jpg" width="30px"><span>杯莫停</span> 👍（3） 💬（1）<div>比如极客时间可以用微信登录，点击微信图标，极客时间会重定向到一个有微信登录二维码的页面，让我扫二维码，我扫了就是授权微信给极客时间提供授权服务。然后微信会给极客时间发授权码，极客时间收到授权码，去微信提供的api获取token。获取到token，极客时间就可以获取到我的微信头像，昵称，甚至通讯录（不知道会不会）大概是这个流程吧？</div>2021-03-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/50/1f/5563ddc2.jpg" width="30px"><span>蒋胜琳</span> 👍（3） 💬（0）<div>总结得很好，例子也不错，特别喜欢先粗讲实习原理及流程的课程，对新手很友好，容易建立起体系知识</div>2020-07-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/87/62/f99b5b05.jpg" width="30px"><span>曙光</span> 👍（1） 💬（0）<div>安全基本不同，授权方式不通。如果商家的用户名密码被盗用，页面跳转，授权码没办法保护商家了。可以再添加手机验证码验证商家信息，如果金额较高或打单数量较大，可以增加U盾来提升安全性。当然，也可以通过人脸识别，安全性高，使用方便。
如果小兔是京东商城自家应用，本身的安全级别就高，点击一次授权即可获取访问令牌</div>2020-09-12</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/7P4wtgRQt1l0YQlVOtiaUKey2AFZqQCAcABzdCNTP0JR027tkhVkRYgj1iaYF8OlqsE8j6A6icsAvYHIAX8E31WNg/132" width="30px"><span>killer</span> 👍（0） 💬（0）<div>我们是做sass的（可以类比成小兔打单软件），会接一些其它生态，比如微信小程序、公众号、抖音小程序等，我们系统提供了一些增强能力，比如：代开发&#47;代管理小程序以及授权等功能，所以系统需要客户授权微信小程序，流程如下：
1、客户使用我司系统，系统引导客户授权，系统自动调用微信生态接口生成授权码，客户扫码授完权，客户授权完成微信生态重定向到我们指定api接口；
2、微信生态通过api接口告诉我司系统访问令牌 access_token 以及过期时间，过期后需要重新获取 access_token；
3、我司系统通过token访问微信生态接口，代客户管理微信小程序。
看了这讲，对OAuth2 理解更深刻了一些，平台不会把用户的账户和密码告诉任何三方服务商，通过颁发access_token更安全。

为什么会调用微信生态接口生成授权码？生成授权码会设置一些信息，比如：重定向接口， 客户在授权时跟我们系统是失去联系的，只有授权完成之后依赖微信生态通过重定向重新和客户建立连接。</div>2024-12-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/ac/23/8eb08fdf.jpg" width="30px"><span>小手冰凉*^O^*</span> 👍（0） 💬（0）<div>code是不是同一个用户授权后就一直是同一个不变的，token大概多久更新一次</div>2023-10-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6b/1b/4b397b80.jpg" width="30px"><span>蛮野</span> 👍（0） 💬（0）<div>code是不是同一个用户授权后就一直是同一个不变的，token大概多久更新一次</div>2023-03-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/35/77/7f/4ffbdb88.jpg" width="30px"><span>花开荼靡</span> 👍（0） 💬（0）<div>老师讲的很明白，感谢。</div>2023-02-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/69/bf/58f70a2a.jpg" width="30px"><span>程序员花卷</span> 👍（0） 💬（0）<div>老师讲的很好，通俗易懂，值得点赞。
对接两次飞书开放平台、微信开放平台、支付宝开放平台等再来学这个，理解会更深刻一些</div>2023-02-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/5e/81/82709d6e.jpg" width="30px"><span>码小呆</span> 👍（0） 💬（0）<div>小兔打单那个场景是否可以使用 客户端凭证模式来实现</div>2022-10-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/29/54/30/5f146e1b.jpg" width="30px"><span>garyhimself</span> 👍（0） 💬（0）<div>如何确保小兔打单软件只去拿小明店铺的订单，小兔打单软件只拿到了一个access token，它怎么知道小明的？</div>2021-11-08</li><br/>
</ul>