你好，我是于航。

对于计算机软件的正常运作，内存（Main Memory）所发挥作用的重要性不言而喻。无论是处在“幕后”的操作系统，还是位于“台前”的用户应用程序，它们在运行时都会将所需数据从磁盘等外部存储器转移至内存。实际上，内存和 CPU 芯片上的 L1、L2 等高速缓存，一同构成了计算机中用于支撑程序高效运行的缓存系统。

今天，我们会先从整体的视角看看内存在计算机系统中的作用，然后再一起探究进程是如何在操作系统的控制下与计算机内存交互的。

## 计算机内部的缓存系统

通常，文件会被存放在容量较大的磁盘中。但磁盘作为一种提供数据持久化存储的设备，采用了机械式的数据寻址方式，这就使得它**无法匹配 CPU 在完成相关操作时，所需数据在访问速度上的要求**。而内存则以快于磁盘几万甚至十几万倍的读写效率，承担起了与 CPU 直接交互的重任。

但随着摩尔定律的不断应验，CPU 与内存两者在数据访问效率的“供需关系”上又出现了问题。因此，现代计算机通过在这两者之间引入更多读写速度更快，容量却更小的高速缓存层，并基于局部性原理，让 CPU 经常使用到的数据可以被更快地再次访问。通过这种方式，**由 L1、L2 等片上高速缓存，以及内存组成的缓存系统，便成为了计算机中用于承载应用运行时数据的主要部件**。
<div><strong>精选留言（13）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/1d/9b/e5/bd0be5c3.jpg" width="30px"><span>⁶₆⁶₆⁶₆</span> 👍（9） 💬（3）<div>为保证空指针可以触发访问缺失页的异常SIGSEGV，空出位于虚拟地址空间的最低部分，空出的虚拟地址部分不访问，就可以省下一个页大小的空间，原本空出的空间为4KB(0x0~0x1000)即可，考虑到大页机制时最小页为4MB，因此就空出4MB的空间(0x0~0x00400000),所以VAS的真实使用地址从0x400000开始</div>2022-02-27</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKwGurTWOiaZ2O2oCdxK9kbF4PcwGg0ALqsWhNq87hWvwPy8ZU9cxRzmcGOgdIeJkTOoKfbxgEKqrg/132" width="30px"><span>ZR2021</span> 👍（4） 💬（2）<div>老师，TLB中缓存的是几级页表？如果是一级的话，那对应的二级页表是不是就要到物理内存里查的？这样的话，如果是4级页表，即使第一级被TLB命中，其他3级也得到物理内存里找，好像TLB也没带来多大的性能提升……希望老师指点下，这块我一直有点不清楚</div>2022-02-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/eb/4f/6a97b1cd.jpg" width="30px"><span>猪小擎</span> 👍（2） 💬（2）<div>这一讲好难，知识的原文从哪本书里能看到</div>2022-06-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0b/6f/68cd0614.jpg" width="30px"><span>brian</span> 👍（1） 💬（1）<div>这部分内容其实是os的设计，不是c特有的，所有语言的进程都是这样使用内存的，这样理解没错吧</div>2023-04-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/55/28/66bf4bc4.jpg" width="30px"><span>荷兰小猪8813</span> 👍（1） 💬（1）<div>假设在一个 32 位地址空间中，页大小为 4KiB，每个 PTE 大小为 4 字节。此时，MMU 在进行物理地址查询时，首先会根据虚拟地址中隐含的虚拟页号信息来查找一级页表内的目标 PTE，而一级页表中的每个 PTE，此时实际上负责映射 VAS 中的一个 4MiB 的片。

这个 4MiB 是怎么算出来的呢？</div>2022-05-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/96/47/93838ff7.jpg" width="30px"><span>青鸟飞鱼</span> 👍（0） 💬（1）<div>虚拟地址与物理地址根据页表映射起来的，虚拟地址空间是存在哪里的呢，二进制可执行文件吗？是磁盘里吗？根据用到时一点点加载到内存里吗？那申请内存时（brk和mmap），会跳转到内核里，不分配物理内存，分配后的地址要写到可执行的二进制文件里吗？</div>2022-05-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/55/28/66bf4bc4.jpg" width="30px"><span>荷兰小猪8813</span> 👍（0） 💬（1）<div>则地址字段中存放有该页在物理内存中的起始位置。而在该位复位的情况下，若地址字段为空，则表明该虚拟页还未被分配。否则，地址字段中便保存有 “虚拟页内容在磁盘上的起始位置。”

这个 虚拟页内容 不是程序的数据吧，是指虚拟页自身的一些结构数据？？</div>2022-05-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/36/88/20b6a6ee.jpg" width="30px"><span>Simon</span> 👍（0） 💬（3）<div>64位系统的地址空间只有 2^48，高十六位都是0，共256T。</div>2022-02-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/8e/10/10092bb1.jpg" width="30px"><span>Luke</span> 👍（1） 💬（2）<div>老师，一级页表那块2^16GB不应该是65536GB吗？怎么是65535GB。</div>2022-10-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/29/b0/d3/200e82ff.jpg" width="30px"><span>功夫熊猫</span> 👍（1） 💬（0）<div>页面置换，请求调页</div>2022-06-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/23/66/413c0bb5.jpg" width="30px"><span>LDxy</span> 👍（1） 💬（0）<div>位于虚拟地址空间的最低部分，未赋予物理地址。任何对它的引用都是非法的，用于捕捉使用空指针和小整型值指针引用内存的异常情况。</div>2022-02-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/8d/0e/1f49ade9.jpg" width="30px"><span>海鲨数据库架构师_曾院士</span> 👍（0） 💬（0）<div>请教下多级页表,分配的时候 虚拟地址的偏移量问题? 0X7F8E84033000 被切割5个部分.除了最地位是物理内存页的偏移量.而页表中的4K页,偏移量前有大量的NULL地址,占用了内存空间.
一个进程是一个4 or 5级页表.还是多个页表存在. 毕竟STACK开始是从高地址位分配内存. LINUX系统这样看来给进程页表分配内存空间的时候,感觉也很浪费!</div>2024-12-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/f6/80/85ec2c2a.jpg" width="30px"><span>连瑞龙</span> 👍（0） 💬（0）<div>原文中：而通过下面这行命令，我们便可以查看某个运行进程的 VAS 布局情况。注意，其中的 “” 需要被替换为进程对应的 ID。这句话有问题，“” 应该是 “&lt;pid&gt;”</div>2024-01-04</li><br/>
</ul>