你好，我是刘超。

JVM调优是一个系统而又复杂的过程，但我们知道，在大多数情况下，我们基本不用去调整JVM内存分配，因为一些初始化的参数已经可以保证应用服务正常稳定地工作了。

但所有的调优都是有目标性的，JVM内存分配调优也一样。没有性能问题的时候，我们自然不会随意改变JVM内存分配的参数。那有了问题呢？有了什么样的性能问题我们需要对其进行调优呢？又该如何调优呢？这就是我今天要分享的内容。

## JVM内存分配性能问题

谈到JVM内存表现出的性能问题时，你可能会想到一些线上的JVM内存溢出事故。但这方面的事故往往是应用程序创建对象导致的内存回收对象难，一般属于代码编程问题。

但其实很多时候，在应用服务的特定场景下，JVM内存分配不合理带来的性能表现并不会像内存溢出问题这么突出。可以说如果你没有深入到各项性能指标中去，是很难发现其中隐藏的性能损耗。

JVM内存分配不合理最直接的表现就是频繁的GC，这会导致上下文切换等性能问题，从而降低系统的吞吐量、增加系统的响应时间。因此，如果你在线上环境或性能测试时，发现频繁的GC，且是正常的对象创建和回收，这个时候就需要考虑调整JVM内存分配了，从而减少GC所带来的性能开销。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/2a/54/c9990105.jpg" width="30px"><span>bro.</span> 👍（69） 💬（4）<div>堆外内存创建有两种方式:1.使用ByteBuffer.allocateDirect()得到一个DirectByteBuffer对象,初始化堆外内存大小,里面会创建Cleaner对象,绑定当前this.DirectByteBuffer的回收,通过put,get传递进去Byte数组,或者序列化对象,Cleaner对象实现一个虚引用(当内存被回收时,会受到一个系统通知)当Full GC的时候,如果DirectByteBuffer标记为垃圾被回收,则Cleaner会收到通知调用clean()方法,回收改堆外内存DirectByteBuffer</div>2019-07-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/11/6b/8034959a.jpg" width="30px"><span>迎风劲草</span> 👍（25） 💬（1）<div>老师，你的这个抢购场景下我理解是不是新生代越大越好，因为对象都是生命周期较短的对象。尽量在新生代中被回收掉。</div>2019-07-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/f5/57/ce10fb1b.jpg" width="30px"><span>天天向上</span> 👍（22） 💬（2）<div>如果你在线上环境或性能测试时，发现频繁的 GC，且是正常的对象创建和回收，这个时候就需要考虑调整 JVM 内存分配了。。有个问题，这个频率多久算频繁呢？</div>2020-01-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg" width="30px"><span>QQ怪</span> 👍（11） 💬（1）<div>盲目增大堆内存可能会让吞吐量不增反减，堆内存大了，每次gc扫描对象也就越多也越需要花费时间，反而会适得其反</div>2019-07-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（7） 💬（3）<div>课后思考及问题
1：JVM 内存分配不合理最直接的表现就是频繁的 GC，这会导致上下文切换等性能问题，从而降低系统的吞吐量、增加系统的响应时间。
频繁的GC，GC线程和应用线程会频繁的切入切出，所以，降低了系统的性能。
2：老师好，现在有这么一个问题，我们有一个定时任务跑一次大概会有2亿条数据一条数据大概40kb大小，一次大概7.4TB多的数据，分布式任务50台机器需要刷新2个多小时，我们需要持久化，为了提高性能做了异步发送MQ到另外的机器来持久化，不过MQ积压严重，数据跑一次耗时太长，有什么建议的优化思路嘛？拆分消息会加剧业务处理的复杂度，目前我能想到的是加机器加带宽。请老师给个优化的思考？
</div>2019-09-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a2/ec/205fd50c.jpg" width="30px"><span>我又不乱来</span> 👍（6） 💬（1）<div>超哥，有两个疑问。
当第一次创建对象的时候 eden 空间不足会进行一次minor gc把存活的对象放到from s区。如果这个时候from s放不下。会发生一次担保进入老年代吗？
当一次创建对象的时候eden空间不足进入from s区。当第二次创建对象的时候eden空间又不足了，这个时候会把，eden和第一次存在from s 区的对象进行gc 存活的放在 to s区，to s区空间不足，进行担保放入老年代？这样的理解对吗。
</div>2019-07-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/79/07/2f418316.jpg" width="30px"><span>恰饭哒</span> 👍（5） 💬（4）<div>超哥好，我们经常发现生产环境内存使用超过90％持续3分钟，没有outofmer,
dump下来堆没有发现问题，这种情况每不确定几小时就会一次，求解答</div>2019-07-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/15/03/c0fe1dbf.jpg" width="30px"><span>考休</span> 👍（3） 💬（3）<div>根据老师的教程，在测试项目中，将年轻代的大小调整为3g，发现的确性能提升了，Mirror GC的次数也大大减少，但是Full GC的次数也明显多了几倍，这个是因为年轻代的空间过大，压缩了老年代的内存大小吗？
java -jar -Xms4g -Xmx4g -Xmn3g heapTest-0.0.1-SNAPSHOT.jar</div>2019-11-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/8b/4b/15ab499a.jpg" width="30px"><span>风轻扬</span> 👍（3） 💬（1）<div>老师，如果允许分配担保机制失败。那即使老年代的空间不足以吃下年轻代的对象。jvm也会冒险进行minor gc的。gc之后，如果老年代还是吃不下对象，这个时候才会Full GC。那关闭这个分配担保机制，感觉好一点啊，反正有Full GC兜底呢😃</div>2019-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/79/4b/740f91ca.jpg" width="30px"><span>-W.LI-</span> 👍（3） 💬（1）<div>老师好!堆外缓存实在FGC的时候回收的吧。
AdaptiveSizePolicy这个参数是不是不太智能啊?我项目4G内存默认开启的AdaptiveSizePolicy。发现只给年轻代分配了136M内存。平时运行到没啥问题，没到定时任务的点就频繁FGC。每次定时任务执行完，都会往老年代推40多M，一天会堆300多M到老年代，也不见它把年轻代调大。用的parNew+CMS。后来把年轻代调整到1G(单次YGC耗时从20ms增加到了40ms)，每天老年代内存涨20M左右。</div>2019-07-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/dd/34/d8f198c8.jpg" width="30px"><span>Levvy</span> 👍（1） 💬（2）<div>最大堆内存1593M  还有124M 这俩数字是在哪看的，我怎么找不到</div>2019-12-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/10/7b/eed9d6d6.jpg" width="30px"><span>小笨蛋</span> 👍（1） 💬（1）<div>请问堆内存的分配有没有一个大概的标准😭既然都提到了不能太大也不能太小</div>2019-09-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/42/4f/ff1ac464.jpg" width="30px"><span>又双叒叕是一年啊</span> 👍（1） 💬（1）<div>你好，请问G1调优能不能也讲讲。主要应该注意些什么和cms这种调优的差异</div>2019-08-29</li><br/><li><img src="" width="30px"><span>Geek_323c91</span> 👍（0） 💬（1）<div>不知道能不能收到回复,我有个以为,网上查了很多资料 也没得到一个答案,-c 1000 -n 100000 和 -c 100000 和-n 10000的区别是什么 自己压测 怎么调整这2个值</div>2020-05-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/49/a5/e4c1c2d4.jpg" width="30px"><span>小文同学</span> 👍（0） 💬（1）<div>老师，调整发起老年代堆引起full gc的阈值可以起到优化的效果么？一个老项目把这个阈值设成50%存在的原因会是什么？
</div>2020-03-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/10/bb/f1061601.jpg" width="30px"><span>Demon.Lee</span> 👍（0） 💬（1）<div>老师，接着昨天提的一个问题，如果我设置了-Xms512m -Xmx512m，但因为机器跑的进程多，实际给这个进程分配的内存只有260M（通过ps aux看的），但我看GCViewer中Memory里面Total heap(usage&#47;alloc. max) 194.1M(38.7%)&#47;502M；Tenured heap(usage&#47;alloc. max) 45.3M(13.3%)&#47;341.5M；Young heap(usage&#47;alloc. max) 156.2M(97.3%)&#47;160.5M。不太懂，谢谢老师。</div>2020-03-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/c6/d5/69491af8.jpg" width="30px"><span>千年不变，万年如一🎾</span> 👍（0） 💬（2）<div>超哥，为什么 jmap -heap 出来的 Eden Space小于 From Space 和 To Space ？</div>2020-02-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/07/45/d5cdf38e.jpg" width="30px"><span>殷传宁</span> 👍（0） 💬（1）<div>吞吐量那个图是怎么查看的？方法能说一下吗？</div>2019-10-13</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqOn7k48KXia5nvt5VO0x0Fh7SN5MHrbglBAEUVicdRBFpFU3icvNmpjVXDaUVjY0vvic9OrTV5mBRqVQ/132" width="30px"><span>没有小名的曲儿</span> 👍（0） 💬（3）<div>超哥好，我们线上的的服务器经常会进行图片处理，内存15G，堆内存设置的-Xms与-Xmx都是10G，经常在进行图片处理时，用top查看java进程，占用率高达79.1%。
等传完之后，观察内存一直都是这么多。jmap也看了，是正常回收的。并且各个代free率很高，但是top查看java进程内存一直占用79.1%。
是不是因为设置了-Xms为10G，尽管GC了，也不会降低占用整个分配的物理内存呢？</div>2019-09-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/f4/0e/e200dd34.jpg" width="30px"><span>SDL</span> 👍（0） 💬（1）<div>老师 为什么我用这个java -XX查看某个参数都没有相关信息输出的？就只有版本号那些信息呢</div>2019-09-26</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/6LaITPQ4Lk5fZn8ib1tfsPW8vI9icTuSwAddiajVfibPDiaDvMU2br6ZT7K0LWCKibSQuicT7sIEVmY4K7ibXY0T7UQEiag/132" width="30px"><span>尔东橙</span> 👍（0） 💬（1）<div>ab压测是什么工具的</div>2019-09-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/b9/74/de434e5f.jpg" width="30px"><span>高鑫</span> 👍（0） 💬（2）<div>大大，有个问题请教。如果survivor区不能容纳eden区的活跃对象，那么这些对象会直接晋升到oldgen么？能否详述一下对象晋升的流程🥰</div>2019-07-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/38/f1/996a070d.jpg" width="30px"><span>LW</span> 👍（0） 💬（1）<div>老师的压测结果图形化是用什么工具做的？</div>2019-07-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ac/46/7e24bad6.jpg" width="30px"><span>杨俊</span> 👍（0） 💬（1）<div>印象中本地内存分配堆外内存，c语言用到的内存就是这样，回收是通过GC自动扫描directbytebuffer对象回收</div>2019-07-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/b3/c5/7fc124e2.jpg" width="30px"><span>Liam</span> 👍（0） 💬（1）<div>堆外内存一般是通过幻像引用的队列通知机制进行手动回收

另外去，G1如何调优呢？本篇文章的调优策略不适合G1吧</div>2019-07-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/bd/84/06654c88.jpg" width="30px"><span>slofish</span> 👍（2） 💬（0）<div>实战项目中真的发生大量gc. 增大内存也不能根本解决问题，应该明确什么原因导致这些对象不被回收，而不是盲目增加，指标不治本</div>2020-06-30</li><br/><li><img src="" width="30px"><span>刘梦春</span> 👍（1） 💬（0）<div>堆内存最多4g  年轻代3g   1g的老年代怎么给年轻代做担保？</div>2021-01-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/db/f6/eac83ef4.jpg" width="30px"><span>披荆斩棘</span> 👍（0） 💬（0）<div>超哥，我最近在学并行编程过程中，学master- work并行程序设计模式，运行书中给的示例，就是“用线程计算1到10000的3次方和”，我的电脑是8核20g内存，用一个线程和用5个线程去跑，跑出来时间差不多，非常疑惑，按道理时间是1线程跑的1&#47;5吧</div>2021-11-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/9e/24/0d6a7987.jpg" width="30px"><span>aroll</span> 👍（0） 💬（0）<div>netty4通过引用计数，来处理缓冲区的复用与回收</div>2021-03-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ff/e6/4b0ddfcf.jpg" width="30px"><span>李飞</span> 👍（0） 💬（0）<div>老师，MinorGC频率多少比较合适呢？</div>2021-03-03</li><br/>
</ul>