你好，我是刘超。

我有一个朋友，有一次他跟我说，他们公司的系统从来没有经过性能调优，功能测试完成后就上线了，线上也没有出现过什么性能问题呀，那为什么很多系统都要去做性能调优呢？

当时我就回答了他一句，如果你们公司做的是 12306 网站，不做系统性能优化就上线，试试看会是什么情况。

如果是你，你会怎么回答呢？今天，我们就从这个话题聊起，希望能跟你一起弄明白这几个问题：我们为什么要做性能调优？什么时候开始做？做性能调优是不是有标准可参考？

## 为什么要做性能调优？

一款线上产品如果没有经过性能测试，那它就好比是一颗定时炸弹，你不知道它什么时候会出现问题，你也不清楚它能承受的极限在哪儿。

有些性能问题是时间累积慢慢产生的，到了一定时间自然就爆炸了；而更多的性能问题是由访问量的波动导致的，例如，活动或者公司产品用户量上升；当然也有可能是一款产品上线后就半死不活，一直没有大访问量，所以还没有引发这颗定时炸弹。

现在假设你的系统要做一次活动，产品经理或者老板告诉你预计有几十万的用户访问量，询问系统能否承受得住这次活动的压力。如果你不清楚自己系统的性能情况，也只能战战兢兢地回答老板，有可能大概没问题吧。

所以，要不要做性能调优，这个问题其实很好回答。所有的系统在开发完之后，多多少少都会有性能问题，我们首先要做的就是想办法把问题暴露出来，例如进行压力测试、模拟可能的操作场景等等，再通过性能调优去解决这些问题。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/2f/32/db8e5674.jpg" width="30px"><span>杨军</span> 👍（175） 💬（4）<div>首先很高兴终于有人开Java性能优化的课程，我在工作中需要接触很多这方面的工作，希望通过学习这次课程能带来更多收获。
然后我想请教老师一个问题，CPU利用率和系统负载这两个指标之间是什么关系？网上很多资料讲的不清不楚，看不明白。
</div>2019-05-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/5d/78/f011d586.jpg" width="30px"><span>遇见阳光</span> 👍（80） 💬（2）<div>老师，tps qps这块还是有点不太清楚。</div>2019-05-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/f5/d1/cc6f82eb.jpg" width="30px"><span>kaixiao7</span> 👍（62） 💬（1）<div>老师，关于JVM的异常问题，您在@陆离的回答中说&quot;平时的业务异常避免生成栈追踪信息，在异常中用字符串描述业务异常信息即可&quot;，我通过throw new Exception(&quot;aaa&quot;)，debug时发现还是会调用fillInStackTrace()方法。我是不是理解错了呢？具体该怎么做？感谢</div>2019-06-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7b/b8/6f47ba1b.jpg" width="30px"><span>Maxwell</span> 👍（36） 💬（4）<div>请问老师最近段时间遇到端口被CLOSE_WAIT占用，重启后过了半天又重现，以前没有出现过，一般如何排查</div>2019-06-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/fe/fc/102a5645.jpg" width="30px"><span>天持</span> 👍（29） 💬（1）<div>今天查个问题，发现有台机器cpu使用率，明显比其他机器高了10%左右，其他指标也没发现问题，不懂呀，好好学习</div>2019-05-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg" width="30px"><span>QQ怪</span> 👍（29） 💬（2）<div>我觉得还有接口返回200的成功率吧</div>2019-05-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/69/7a/76bf4c79.jpg" width="30px"><span>大树</span> 👍（28） 💬（1）<div>抛出异常需要构建异常栈，对异常进行捕获和处理，这个过程比较消耗系统的性能，怎么理解？为什么这个过程就消耗性能？消耗什么性能呢？CPU？内存？</div>2020-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/38/ba6a106f.jpg" width="30px"><span>Phoenix</span> 👍（26） 💬（1）<div>想请教下老师，使用MySQL经常会遇到业务需要实时导出大量业务数据的需求，那么如何在不影响业务和不分库的的情况满足业务实时导出大量数据的需求呢？</div>2019-05-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/8b/59/5768aa99.jpg" width="30px"><span>诸葛</span> 👍（22） 💬（1）<div>异常：Java 应用中，抛出异常需要构建异常栈，对异常进行捕获和处理，这个过程非常消耗系统性能。如果在高并发的情况下引发异常，持续地进行异常处理，那么系统的性能就会明显地受到影响。
老师好，高并发调用方法之后第一步就是检验一堆入参，如果入参有问题立即抛出异常给前端，不再处理下边的逻辑了，这样有问题吗？我看系统性能还可以啊。压力测试也还行。如果有问题的话那应该怎么做呢，检验错误后给前端放回code码然后返回空对象吗？感谢</div>2019-05-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/12/00/ba8d3d0f.jpg" width="30px"><span>Mr. Huang</span> 👍（13） 💬（1）<div>老师您好，请问您提到的那几个响应时间测试，有没有比较好的工具推荐</div>2019-05-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a5/30/abb7bfe3.jpg" width="30px"><span>Seal</span> 👍（11） 💬（1）<div>我经常关注的一个性能指标还有QPS（每秒请求数），它体现了服务端对接口的处理能力。在响应时间一定的情况下，QPS越大，性能越高! 每个应用服务都有自己最大的QPS值，当QPS达到最大时，再持续加压，将会出现响应时间变长，QPS下降，内存或CPU升高等现象!</div>2019-05-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/3b/36/2d61e080.jpg" width="30px"><span>行者</span> 👍（7） 💬（1）<div>老师，我想到服务器响应时间可以进一步细分到服务器中位数响应时间，服务器最慢的响应时间；要尽可能让所有接口响应时间接近，避免长尾。</div>2019-05-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/8f/6a/b3b0c35e.jpg" width="30px"><span>打码程序媛(^ρ^)/</span> 👍（5） 💬（1）<div>老师您好，我看您没有区分压测和性能测试，想问问它们的指标都是一样的吗？有没有什么区别呢？</div>2019-05-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d6/64/75f772dc.jpg" width="30px"><span>SlamDunk</span> 👍（4） 💬（1）<div>请问，我们公司业务代码对异常的处理方式:先打印异常堆栈信息到日志文件，再返回错误码和业务错误信息给前端。这种做法对性能影响大吗?</div>2019-06-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e5/c9/fa9199d0.jpg" width="30px"><span>Geek_af3d01</span> 👍（3） 💬（1）<div>老师 您好 我想请问个问题 您说的压测工具ab 我用过 但是我们现在想要模拟完整的项目流程去压测(直播项目) 您有什么好的建议么</div>2019-05-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/a4/9c/b32ed9e9.jpg" width="30px"><span>陆离</span> 👍（3） 💬（1）<div>老师你好，我想问一下那个jvm异常的问题，这个在高并发的情况下出现异常是怎么影响到系统性能的呢</div>2019-05-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/55/e4/7061abd5.jpg" width="30px"><span>Mr.J</span> 👍（3） 💬（1）<div>老师您好，看到性能调优这块的指标内容，需要涉及到很多方面的知识，比如Linux操作，JVM虚拟机原理，Java源码基础知识等，这些东西对于一个刚接触后台开发的人来说，确实比较吃力，在学习本专栏课程的同时去学习这些东西，这些有优先级吗，哪些是需要先急需掌握一部分的</div>2019-05-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/af/e6/9c77acff.jpg" width="30px"><span>我行我素</span> 👍（3） 💬（1）<div>并发用户数，高可用可扩展等方面</div>2019-05-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/27/1d/1cb36854.jpg" width="30px"><span>小辉辉</span> 👍（3） 💬（1）<div>现在的项目也是没有经过压测和调优的，上线也没多久，正好跟着老师的专栏来试着优化一下性能😁😁😁</div>2019-05-20</li><br/><li><img src="" width="30px"><span>ty_young</span> 👍（2） 💬（1）<div>老师，TPS是应用处理的性能指标吧，然后由磁盘吞吐量和网络吞吐量所决定或者影响么</div>2019-05-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/02/d1/36285394.jpg" width="30px"><span>🐌🐌🐌</span> 👍（2） 💬（3）<div>请教一个数据库连接池优化的问题：

项目采用spring boot druid连接池 数据库是mysql5.7版本，偶尔会报connection holder is null的错误。   

为什么程序启动一段时间后，netstat 查询与数据库的tcp 连接数为0 会小于连接池配置的最小数量呢？


请问下可能会是什么原因，如何调试解决？
</div>2019-05-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/13/1e/00f574c1.jpg" width="30px"><span>随遇而安</span> 👍（2） 💬（1）<div>希望这次能学到真正的东西</div>2019-05-20</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIfQFSpQJNKeqW5Q9PfciaLyDDFm9heqW5SHQCzlrajXO8f38RCH3BE5k8QHGPMictbbAM9IGvicj5EQ/132" width="30px"><span>李</span> 👍（1） 💬（1）<div>老师你好,cpu使用率是多大才是比较合理的，例如并发高的情况下cpu使用率肯定高，多少并发对应多少cpu使用率才算是系统是正常的</div>2019-06-25</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoRiaKX0ulEibbbwM4xhjyMeza0Pyp7KO1mqvfJceiaM6ZNtGpXJibI6P2qHGwBP9GKwOt9LgHicHflBXw/132" width="30px"><span>Geek_ebda96</span> 👍（1） 💬（2）<div>老师你好，请问系统负载所指的正在运行或者等待的进程数和CPU的数目的百分比，但我大部分得系统来说运行的进程数目基本不会边，都是稳定的，在变的应该是应用程序本身的线程数，这个参数对于性能观察来说有用么，哪些方法能看到因为线程数过多或者线程的使用率很高导致性能问题，比如TOP查看CPU使用率？</div>2019-05-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/11/77/18b0b500.jpg" width="30px"><span>jeff zhang</span> 👍（1） 💬（1）<div>在负载和cpu那个问题，您的答复我不太理解，cpu密集型情况下一个线程一直运行为什么负载是0.1？  还有等待的线程都会算到load里面吗？多谢</div>2019-05-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/78/3e/c39d86f1.jpg" width="30px"><span>Chocolate</span> 👍（1） 💬（1）<div>网络吞吐量里面的字被和谐了</div>2019-05-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/01/76/6100f079.jpg" width="30px"><span>anz</span> 👍（1） 💬（1）<div>目前在做交易系统的性能优化,最直接的感受是,在不做产品逻辑变动的情况下,合并查询,批量操作,几乎解决了我目前遇到的80%的问题;但是配置优化方面自己比较欠缺,希望跟着老师能补补自己的短板</div>2019-05-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/38/b1/10861b45.jpg" width="30px"><span>邵岩</span> 👍（1） 💬（1）<div>Tps越高，说明系统性能越好吗？</div>2019-05-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/cb/bc/fe68899c.jpg" width="30px"><span>雪哥</span> 👍（0） 💬（1）<div>老师我想问一下，千万级并发用户的压测，一般用什么工具啊，或者其他技术手段实现超大并发的性能测试</div>2019-10-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（0） 💬（2）<div>首先，给老师点个赞，几乎有问必答，评论区很精彩，现在已经比较享受延后阅读的快感啦！
老师提到的压测性能指标已经比较全面了，我在压测时主要也是关注TP99、TPS、CPU使用情况、磁盘使用情况、网络使用情况、以及压力机多少并发数、多少台压力机、压测时间、压测时性能的抖动、被压机的JVM是否有 FULL GC、当然，被压机的本身配置也要关注几核、内存多少、磁盘多少、磁盘是什么类型等等。
老师能否给出一个常用组件的大概性能指标具体值，比如：各类MQ、各类RPC、各类数据库的什么版本配置下TPS、TP99大概多少？大部分机器我认为其极限性能都是达不到的，不过一台普通的机器性能极限大概是多少？他们本身怎么做到极致性能的这个我想了解一下，不过一个一个去压测也行，不过太耗时，可能也不准确？</div>2019-09-07</li><br/>
</ul>