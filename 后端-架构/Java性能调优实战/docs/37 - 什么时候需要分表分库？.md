你好，我是刘超。

在当今互联网时代，海量数据基本上是每一个成熟产品的共性，特别是在移动互联网产品中，几乎每天都在产生数据，例如，商城的订单表、支付系统的交易明细以及游戏中的战报等等。

对于一个日活用户在百万数量级的商城来说，每天产生的订单数量可能在百万级，特别在一些活动促销期间，甚至上千万。

假设我们基于单表来实现，每天产生上百万的数据量，不到一个月的时间就要承受上亿的数据，这时单表的性能将会严重下降。因为MySQL在InnoDB存储引擎下创建的索引都是基于B+树实现的，所以查询时的I/O次数很大程度取决于树的高度，随着B+树的树高增高，I/O次数增加，查询性能也就越差。

当我们面对一张海量数据的表时，通常有分区、NoSQL存储、分表分库等优化方案。

分区的底层虽然也是基于分表的原理实现的，即有多个底层表实现，但分区依然是在单库下进行的，在一些需要提高并发的场景中的优化空间非常有限，且一个表最多只能支持1024个分区。面对日益增长的海量数据，优化存储能力有限。不过在一些非海量数据的大表中，我们可以考虑使用分区来优化表性能。

> 分区表是由多个相关的底层表实现的，这些底层表也是由句柄对象表示，所以我们也可以直接访问各个分区，存储引擎管理分区的各个底层表和管理普通表一样（所有的底层表都必须使用相同的存储引擎），分区表的索引只是在各个底层表上各自加上一个相同的索引，从存储引擎的角度来看，底层表和一个普通表没有任何不同，存储引擎也无须知道这是一个普通表，还是一个分区表的一部分。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/ByjQiazibBiawW7X1TnuyicROLUqavhz984TuQvLdBO4Ess4FTbJhVv9EOdyq7DQMVYmYCS9nMEnmCDIp54UXTBpHQ/132" width="30px"><span>mmilan</span> 👍（36） 💬（11）<div>老师说&quot;我们在最开始设计表数据量时，尽量使用 2 的倍数来设置表数量。当我们需要扩容时，也同样按照 2 的倍数来扩容，这种方式可以减少数据的迁移量&quot;，不是很理解为什么按2的倍数，就能减少数据的迁移量？</div>2019-08-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg" width="30px"><span>Jxin</span> 👍（17） 💬（1）<div>1.中间件应该就mycat，sharding jdbc应该属于基础框架来使用。
2.提个问题，公司禁用分区，不知为何，但结果就是相关知识忘光光。本章刚好也有提到，顺带麻烦老师介绍下分区，这块反而成薄弱点了。</div>2019-08-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg" width="30px"><span>QQ怪</span> 👍（16） 💬（1）<div>现在Fescar已经改名为Seata</div>2019-08-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/88/6e/3bd860d3.jpg" width="30px"><span>.</span> 👍（10） 💬（1）<div>数据冗余后，如果数据修改后数据更新怎么方便点？</div>2020-03-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/3a/5d/c5dc789a.jpg" width="30px"><span>珠穆写码</span> 👍（10） 💬（1）<div>老师，可以用tidb这种newsql取代分库分表的方案吗</div>2019-08-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/b0/65/90387745.jpg" width="30px"><span>Mr.wang</span> 👍（6） 💬（1）<div>刘老师，这里我不太了解一个表字段非常多的时候，新增会发生跨页问题，除了老师在上一章中讲到mysql主键id不是自增id，在新增的时候会发生跨页的原因，这里的跨页还有其他原因吗？</div>2020-03-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/4c/f1/8dc266ee.jpg" width="30px"><span>儿戏</span> 👍（6） 💬（1）<div>老师，请问下 订单表用  用户ID 做hash 分库分表后，订单的item表会成倍增长，造成的数据倾斜，怎么解决？做2次分表吗？</div>2019-09-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/8f/1c/1c728388.jpg" width="30px"><span>皮卡皮卡</span> 👍（3） 💬（1）<div>GitHub上搜snowflake已经淘汰了</div>2019-09-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（3） 💬（1）<div>我使用过公司基础架构部自研的数据库中间件，对于分库分表的的数据查询可以动态路由，不过也就是动态路由，对于join的支持有限，另外分布式事务保证的也一般般。不知开源产品中有哪些佼佼者，功能多性能高?</div>2019-09-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4d/fd/0aa0e39f.jpg" width="30px"><span>许童童</span> 👍（2） 💬（1）<div>我们的系统前期没设计好，现在想分库分表很难，大量join查询，很难处理。
想用阿里云的分页式rdbms，不知道可行性。</div>2019-08-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/04/18/4b02510f.jpg" width="30px"><span>明天更美好</span> 👍（2） 💬（2）<div>有个问题请教下，对于分库分表来说主键需要严格递增，不然数据会发生倾斜的，造成部分库数据过多。雪花算法虽然好，但是只是趋势递增的，那怎么才能做到严格递增呢？并且对性能上有一定要求。</div>2019-08-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/83/19/0a3fe8c1.jpg" width="30px"><span>Evan</span> 👍（1） 💬（1）<div>分库中间件：MyCat、Cobar、sharding-jdbc
MyCat和Cobar是属于一类
Sharding-jdbc属于应用端，少一个中间件，感觉维护少一个故点，会更好一些</div>2020-03-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/18/cb/edb5a0a0.jpg" width="30px"><span>小橙橙</span> 👍（1） 💬（1）<div>老师，您好。我没有分库分表的经验。有些实践经验向您请教一下。分库分表的数量有上限吗，比如拆分了多少个库之后，查询性能也没有办法再提高了。</div>2019-08-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/09/08/f3547e77.jpg" width="30px"><span>lobby</span> 👍（0） 💬（4）<div>老师，一致性hash算法会不会对扩容问题有帮助？</div>2020-05-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/a5/f0/8648c464.jpg" width="30px"><span>Joker</span> 👍（0） 💬（1）<div>https:&#47;&#47;github.com&#47;souyunku&#47;SnowFlake  
老师这个项目的雪花算法还能使用吗？</div>2020-02-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/62/64/40e9805d.jpg" width="30px"><span>梦醒时分</span> 👍（0） 💬（2）<div>自己调研过Mycat，个人感觉挺好用的。生产上没用过，不知道稳定性怎么样</div>2019-08-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg" width="30px"><span>QQ怪</span> 👍（12） 💬（0）<div>没有什么大厂经验，看了老师的分享的确对大厂数据库分库分表设计有一定的理解和提高</div>2019-08-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/af/ac/dd36cf29.jpg" width="30px"><span>on the way</span> 👍（3） 💬（0）<div>用一致性hash算法的思想也可以减少数据的迁移</div>2020-11-13</li><br/><li><img src="" width="30px"><span>Geek_926921</span> 👍（2） 💬（0）<div>自己接触过的分布式系统中大多数还是使用了分库分表，分库主要是根据不同的业务或者服务名划分库，由于业务数据量还没那么大，仅仅做了分库，这个时候只是在报表统计这边会牵涉到多数据源查询以及不同的库进行join查询，而业务中的多数据库操作，我们是把数据操作划分到对应的服务上，可以用MQ、RPC通信、redis等操作。报表中的多数据源join实践过后是禁止这样子操作，因为不知道你join的那个库中的表是否会发生迁移，这个时候应该是把join的操作放在代码里面实现，虽然效率会比直接join要慢很多，但是可以通过多线程的方式去提升处理数据的速度，例如CompleteFutrue的异步非阻塞进行数据处理.</div>2021-07-07</li><br/><li><img src="" width="30px"><span>一眼万年</span> 👍（2） 💬（3）<div>老师，mysql单表最大储存性能分析能详细点，而不是简单一句性能能B+树深度有关</div>2019-08-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/04/18/4b02510f.jpg" width="30px"><span>明天更美好</span> 👍（2） 💬（5）<div>个人感觉单表超过500w就要分表，不然对于性能有要求的业务来说性能太差了。单库数据超2T，就得分库。这样的话可能更合理些</div>2019-08-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/f2/aa/32fc0d54.jpg" width="30px"><span>失火的夏天</span> 👍（2） 💬（0）<div>用过阿里的DRDS，它只支持一个字段作为分库分表键，不能多个字段同时分库分表，而且不支持分布式事务，如果要修改分库键的值，就要先插入再删除，或者先删除再插入。插入，更新，查询的时候都要带上分库键。不过好像有个参数可以控制是不是一定要带分库键，大概就了解这么些。</div>2019-08-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/60/85/f72f1d94.jpg" width="30px"><span>与路同飞</span> 👍（1） 💬（0）<div>基于 Elasticsearch、Solr 存储的订单数据，主要用于运营人员根据其它字段进行分页查询。这种给后台运营人员操作的数据，怎么保证实时性呢？例如运营人员手动关闭了订单，这个订单数据的写操作更新的是mysql，mysql同步到elasticSearch会有延迟。这种延迟老师有什么好的建议么？针对这种写后读的场景</div>2020-09-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e1/5c/86606d9c.jpg" width="30px"><span>湮汐</span> 👍（1） 💬（0）<div>我们用的是sharing jdbc。其实我们有一些表，查询维度很简单，而且字段比较少，每次查询一定会命中索引，数据量有3e，也没有做分表，每次查询的速度都挺快的，都在一秒以内。</div>2020-05-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/10/bb/f1061601.jpg" width="30px"><span>Demon.Lee</span> 👍（1） 💬（0）<div>泪奔，之前用微服务开发产品遇到的难点全中，要是早点看到专栏就好了，人生啊~~~</div>2019-09-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/3e/d8/8608ec03.jpg" width="30px"><span>Tree</span> 👍（0） 💬（0）<div>老师我想问一下，雪花算法的datacenterid 和 workerId  服务器该怎么获取分配？</div>2020-11-12</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/fljYjwPxibUDOSVics11AXiauT0S2ffH6tZZXXpvTusdVowemiaoFWialemCkcs5e1OTcmB0PgRkPzDjRU3hb0NvElA/132" width="30px"><span>李武</span> 👍（0） 💬（0）<div>shardingjdbc对mysql支持比较好，其他数据库貌似会有很多问题</div>2020-08-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/56/e0/a2fedc30.jpg" width="30px"><span>吴世东</span> 👍（0） 💬（0）<div>TDDL 分布分表的中间件，有全局唯一Sequence生成，用小表广播的方式解决跨节点的join问题</div>2020-04-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/c1/38/e45bbb6b.jpg" width="30px"><span>再续啸傲</span> 👍（0） 💬（0）<div>mycat。但是低版本的mycat存在一些聚合函数无法使用的问题</div>2019-08-30</li><br/><li><img src="" width="30px"><span>Geek_xbye50</span> 👍（0） 💬（0）<div>用了sharding jdbc ，但实际实现的时候尽量还是考虑单库</div>2019-08-15</li><br/>
</ul>