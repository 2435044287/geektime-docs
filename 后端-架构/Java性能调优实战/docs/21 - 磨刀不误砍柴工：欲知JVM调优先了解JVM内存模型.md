你好，我是刘超。

从今天开始，我将和你一起探讨Java虚拟机（JVM）的性能调优。JVM算是面试中的高频问题了，通常情况下总会有人问到：请你讲解下JVM的内存模型，JVM的性能调优做过吗？

## 为什么JVM在Java中如此重要？

首先你应该知道，运行一个Java应用程序，我们必须要先安装JDK或者JRE包。这是因为Java应用在编译后会变成字节码，然后通过字节码运行在JVM中，而JVM是JRE的核心组成部分。

JVM不仅承担了Java字节码的分析（JIT compiler）和执行（Runtime），同时也内置了自动内存分配管理机制。这个机制可以大大降低手动分配回收机制可能带来的内存泄露和内存溢出风险，使Java开发人员不需要关注每个对象的内存分配以及回收，从而更专注于业务本身。

## 从了解内存模型开始

JVM自动内存分配管理机制的好处很多，但实则是把双刃剑。这个机制在提升Java开发效率的同时，也容易使Java开发人员过度依赖于自动化，弱化对内存的管理能力，这样系统就很容易发生JVM的堆内存异常，垃圾回收（GC）的方式不合适以及GC次数过于频繁等问题，这些都将直接影响到应用服务的性能。

因此，要进行JVM层面的调优，就需要深入了解JVM内存分配和回收原理，这样在遇到问题时，我们才能通过日志分析快速地定位问题；也能在系统遇到性能瓶颈时，通过分析JVM调优来优化系统性能。这也是整个模块四的重点内容，今天我们就从JVM的内存模型学起，为后续的学习打下一个坚实的基础。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83eotSSnZic41tGkbflx0ogIg3ia6g2muFY1hCgosL2t3icZm7I8Ax1hcv1jNgr6vrZ53dpBuGhaoc6DKg/132" width="30px"><span>张学磊</span> 👍（95） 💬（4）<div>String a=&quot;b&quot;可能创建一个对象或者不创建对象,如果&quot;b&quot;这个字符串在常量池里不存在会在常量池创建一个String对象&quot;b&quot;,如果已经存在则a直接reference to这个常量池里的对象;
String c= new String(&quot;b&quot;)至少创建一个对象,也可能两个,因为用到new关键字,会在堆内在创建一个的String对象,它的值是&quot;b&quot;。同时,如果&quot;b&quot;这个字符串在常量池里不存在,会在常量池创建这个一个String对象&quot;b&quot;。</div>2019-07-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/fe/4c/46eb517a.jpg" width="30px"><span>Xiao</span> 👍（41） 💬（1）<div>老师，这儿其实应该说JVM内存结构更合适！JVM内存模型是一种规范，和JVM内存结构不是一个概念。其次，元空间，在Java8，不是在堆内分配的，它的大小是依赖于本地内存大小！</div>2019-07-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/b3/c5/7fc124e2.jpg" width="30px"><span>Liam</span> 👍（24） 💬（2）<div>请教一个问题，所以1.8开始，方法区是堆的一部分吗？也即是说，方法区的大小受限于堆</div>2019-07-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/dc/53/ccb62ea0.jpg" width="30px"><span>夏天39度</span> 👍（13） 💬（2）<div>超哥，我可以这样理解吗，方法区只是一个逻辑概念，方法区是包括元空间物理内存和堆内存</div>2019-07-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/04/71/853b2292.jpg" width="30px"><span>Gred</span> 👍（9） 💬（3）<div>老师，运行时变量应该都在方法区中，从java7开始只有字符串常量池移到堆中而已</div>2019-08-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a2/ec/205fd50c.jpg" width="30px"><span>我又不乱来</span> 👍（8） 💬（1）<div>String a=&quot;b&quot;应该会放在字符串常量池中。
String c= new String(&quot;b&quot;) 首先应该放在 堆中一份，再在常量池中放一份。但是常量池中有b了。
第一次留言。不知道理解的对不对。超哥</div>2019-07-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/36/d2/c7357723.jpg" width="30px"><span>发条橙子 。</span> 👍（6） 💬（1）<div>老师，这句话怎么理解 

之前永久代的类的元数据存储在了元空间，永久代的静态变量（class static variables）以及运行时常量池（runtime constant pool）则跟 Java7 一样，转移到了堆中。

方法区的一部分是由永久代实现的，永久代主要存储类的静态数据以及运行时常量池并储存在堆内存中。 但是由于容易发生permen内存溢出，后来就发明了元数据空间。那我理解元空间除了存储之前方法区的类信息还包括之前放在永久代中的 静态变量 和 运行时常量池 。 
文中为什么说和jdk7一样还是转移到堆中，那不是没有变化么？</div>2019-07-20</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/6LaITPQ4Lk5fZn8ib1tfsPW8vI9icTuSwAddiajVfibPDiaDvMU2br6ZT7K0LWCKibSQuicT7sIEVmY4K7ibXY0T7UQEiag/132" width="30px"><span>尔东橙</span> 👍（5） 💬（2）<div>老师，我看有人说字符串常量池只放引用；那new出来除了堆中会有一个对象，如果字符串常量池没有，也会创建一个，这个对象是在堆中非字符串常量池的地方么</div>2019-09-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/f3/32/44297a74.jpg" width="30px"><span>黑夜里的猫</span> 👍（5） 💬（1）<div>字符串常量不是在java8中已经被放入到堆中了吗，应该不在方法区中了，但是看到老师的图中还在方法区中</div>2019-07-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/ac/62/37912d51.jpg" width="30px"><span>东方奇骥</span> 👍（3） 💬（1）<div>老师，问一下，1.8静态变量和常量存储在的堆里面，那元空间里是什么？文中说之前永久带类的数据存储在了元空间，不是很理解，</div>2019-07-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/ff/0a/12faa44e.jpg" width="30px"><span>晓杰</span> 👍（3） 💬（1）<div>创建一个线程，就会在虚拟机中申请一个栈帧，这句话有问题吧
应该是创建一个线程，会创建一个栈，然后方法调用一次，就会申请一个栈帧吧</div>2019-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/59/66/39eeb3f9.jpg" width="30px"><span>Cain</span> 👍（3） 💬（1）<div>常量池在哪个区？堆区？栈区？方法区？静态区？方法区，静态区他俩是什么关系？</div>2019-07-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ac/ef/494f56c3.jpg" width="30px"><span>crazypokerk</span> 👍（3） 💬（1）<div>引用a和c都会放在栈中，但是a直接指向堆中的运行时常量池中的&quot;b&quot;，而引用c会先在堆中创建一个String对象，该对象会指向运行时常量池中的&quot;b&quot;。</div>2019-07-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/02/85/9a81a973.jpg" width="30px"><span>ZHANG</span> 👍（2） 💬（1）<div>老师，是这样吗，java8中类的静态变量，运行时常量池，字符串常量池都在堆中，那元空间只有一些类的信息了，比如版本什么的。</div>2019-10-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/b2/b3/798a4bb2.jpg" width="30px"><span>帽子丨影</span> 👍（2） 💬（2）<div>元空间的存储位置时本地内存，请问下本地内存是个什么东西，在第一张图里没找到啊。</div>2019-08-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/49/85/3f161d95.jpg" width="30px"><span>Alpha</span> 👍（2） 💬（1）<div>而到了 Java8，静态变量和运行时常量池与 Java7 的永久代一样，都移到了堆中。 

这句没看懂。。上一句说到java7把永久代里的静态变量和运行时常量池移到堆中，这一句又说java8移了 静态变量和运行时常量池？</div>2019-07-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/56/c6/0b449bc6.jpg" width="30px"><span>斐波那契</span> 👍（1） 💬（2）<div>老师 看完这个 对于运行时常量池和字符串常量池有点搞不清 是不是运行时常量池包括字符串常量池还是说这两个是不同的东西?</div>2019-11-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/21/b3/db933462.jpg" width="30px"><span>文灏</span> 👍（1） 💬（1）<div>请教一下，1.8中类的元数据是放在元数据区还是方法区呢？看得有点晕</div>2019-07-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/24/5d/65e61dcb.jpg" width="30px"><span>学无涯</span> 👍（1） 💬（1）<div>元空间不是本地内存吗，老师说的元空间移入堆内存是什么意思呀，不理解，是元空间属于堆内存的一部分吗？</div>2019-07-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg" width="30px"><span>Jxin</span> 👍（1） 💬（1）<div>new的会在堆申请空间。所以在堆。字符串的直接声明赋值会存在字节码的常量池加载后在常量池里面。但是常量池1.8也放堆了，所以都在堆空间。</div>2019-07-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/04/51/da465a93.jpg" width="30px"><span>超威丶</span> 👍（1） 💬（1）<div>其实常量池中是不会存储具体对象的吧，也是引用，所以说new String的话会现在常量池中去寻找，存在直接由常量池中的引用指向堆中对象，不存在直接开辟新对象？</div>2019-07-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4f/78/c3d8ecb0.jpg" width="30px"><span>undifined</span> 👍（1） 💬（1）<div>String a = &quot;b&quot;，会被存放在方法区的常量池中
String c = new String(&quot;b&quot;)会被存放在堆中</div>2019-07-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/92/e4/abb7bfe3.jpg" width="30px"><span>TerryGoForIt</span> 👍（1） 💬（1）<div>思考题：
String a=&quot;b&quot;，定义在方法区的常量池中；
new String(&quot;b&quot;) 是实例化一个 String 对象，定义在堆中；</div>2019-07-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/92/e4/abb7bfe3.jpg" width="30px"><span>TerryGoForIt</span> 👍（1） 💬（1）<div>老师您好，我想问一下，深入理解 JIT 放到下一节了嘛？我看课程目录 JIT 是在 JMM 之前哇。</div>2019-07-09</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/0Qp9pxHBvgdZAveKzsvUFFUicCJfe7ONzhC7jSNFQDNFvg0jRMXuqqZOdxG1qKosylUYrpIHUR2Q76w5m4HtVkg/132" width="30px"><span>Aaron</span> 👍（0） 💬（1）<div>&#47;&#47; 调用静态方法 
print(stu); 
&#47;&#47; 调用非静态方法 
jvmcase.sayHello(stu);

为什么sayHello比print方法先压栈？print不是在前面吗？</div>2020-03-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/af/78/a59a7d51.jpg" width="30px"><span>朝夕</span> 👍（0） 💬（1）<div>老师，上面说的物理空间堆内存，和jvm的堆概念不一样吧，物理空间堆内存是操作系统抽象出来的数据结构吗？，jvm的堆是jvm逻辑分区？</div>2020-03-05</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/6LaITPQ4Lk5fZn8ib1tfsPW8vI9icTuSwAddiajVfibPDiaDvMU2br6ZT7K0LWCKibSQuicT7sIEVmY4K7ibXY0T7UQEiag/132" width="30px"><span>尔东橙</span> 👍（0） 💬（1）<div>编译期的class文件的中，static修饰静态变量和静态代码块是不会放到常量池么？因为您文章说符号引用只包括字符串字面量和常量，加载到JVM后，静态变量是放在堆中的静态常量池么</div>2020-03-04</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/6LaITPQ4Lk5fZn8ib1tfsPW8vI9icTuSwAddiajVfibPDiaDvMU2br6ZT7K0LWCKibSQuicT7sIEVmY4K7ibXY0T7UQEiag/132" width="30px"><span>尔东橙</span> 👍（0） 💬（1）<div>静态常量池和运行时常量池都移动到堆中了吧，那么元空间存的是class的类结构信息，两者是否会有重复之处？比如，static int a = 0; 元空间会有信息，静态常量池也会有？</div>2020-03-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/fc/7b/3e7622c8.jpg" width="30px"><span>将军</span> 👍（0） 💬（1）<div>老师，这应该不叫内存模型，叫内存区域吧。内存模型不是主内存和工作内存的同步吗？</div>2019-12-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/c5/06/acc0c221.jpg" width="30px"><span>Malcolm。</span> 👍（0） 💬（1）<div>print 静态方法属于 JVMCase 类  JVMCase 类在方法区 所以静态方法也是在方法区是吧</div>2019-11-13</li><br/>
</ul>