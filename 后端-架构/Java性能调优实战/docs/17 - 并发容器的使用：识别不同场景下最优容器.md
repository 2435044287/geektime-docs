你好，我是刘超。

在并发编程中，我们经常会用到容器。今天我要和你分享的话题就是：在不同场景下我们该如何选择最优容器。

## 并发场景下的Map容器

假设我们现在要给一个电商系统设计一个简单的统计商品销量TOP 10的功能。常规情况下，我们是用一个哈希表来存储商品和销量键值对，然后使用排序获得销量前十的商品。在这里，哈希表是实现该功能的关键。那么请思考一下，如果要你设计这个功能，你会使用哪个容器呢？

在07讲中，我曾详细讲过HashMap的实现原理，以及HashMap结构的各个优化细节。我说过HashMap的性能优越，经常被用来存储键值对。那么这里我们可以使用HashMap吗？

答案是不可以，我们切忌在并发场景下使用HashMap。因为在JDK1.7之前，在并发场景下使用HashMap会出现死循环，从而导致CPU使用率居高不下，而扩容是导致死循环的主要原因。虽然Java在JDK1.8中修复了HashMap扩容导致的死循环问题，但在高并发场景下，依然会有数据丢失以及不准确的情况出现。

这时为了保证容器的线程安全，Java实现了Hashtable、ConcurrentHashMap以及ConcurrentSkipListMap等Map容器。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/15/ff/0a/12faa44e.jpg" width="30px"><span>晓杰</span> 👍（49） 💬（3）<div>可以用ConcurrentLinkedQueue，优势如下：
1、抢购场景一般都是写多读少，该队列基于链表实现，所以新增和删除元素性能较高
2、写数据时通过cas操作，性能较高。
但是LinkedQueue有一个普遍存在的问题，就是该队列是无界的，需要控制容量，否则可能引起内存溢出</div>2019-06-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/ac/62/37912d51.jpg" width="30px"><span>东方奇骥</span> 👍（30） 💬（7）<div>如果数据变动频繁，就不建议使用CopyOnWriteArrayList了，因为每次写都要拷贝一份，代价太大。老师，怎么直观理解强一致性和弱一致性？之前一直觉得ConcurrentHashMap就是用来代替HashTable的，因为HashTable并发时因为同步锁性能差。</div>2019-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/24/5d/65e61dcb.jpg" width="30px"><span>学无涯</span> 👍（27） 💬（7）<div>为什么ConcurrentHashMap和HashTable的key和value不能为空，而HashMap却可以，这么设计的原因是什么呢</div>2019-11-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4f/78/c3d8ecb0.jpg" width="30px"><span>undifined</span> 👍（14） 💬（1）<div>抢购的过程中存在并发操作，所以需要用线程安全的容器，同时，抢购的用户会很多，应当使用链表的数据结构，这种场景往往是写多读少，还需要排队，所以 ConcurrentLinkedQueue应该是最合适的</div>2019-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/f5/57/ce10fb1b.jpg" width="30px"><span>天天向上</span> 👍（7） 💬（1）<div>ConcurrentHashMap 是弱一致性的，因此有可能会导致某次读无法马上获取到写入的数据。这句话不理解啊，为什么会无法马上获取到写入的数据呢？又不像mysql那样存在事务隔离。</div>2020-04-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cc/d9/20d4f7c2.jpg" width="30px"><span>大雁小鱼</span> 👍（7） 💬（1）<div>老师，ConcurrentHashMap为啥是弱一致性的？</div>2019-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/a4/9c/b32ed9e9.jpg" width="30px"><span>陆离</span> 👍（6） 💬（1）<div>这一节要是有Queue就更好了，那几个blockingQueue还是很有意思的</div>2019-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/e9/0b/1171ac71.jpg" width="30px"><span>WL</span> 👍（5） 💬（3）<div>请问一下老师两个问题:
1. 为什么在无锁是红黑树和跳表的性能差不多呢, 红黑树再平衡的操作会不会更复杂一些.
2. 从本篇文章看好像ConcurrentSkipListMap的性能比ConcurrentHashMap性能要好, 那为啥平时还是用后者的人更多呢, 我想很定是后者相对前者也有一定的优势吧, 但我自己没想出来, 老师能不能指点一下是啥优势.</div>2019-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/b3/c5/7fc124e2.jpg" width="30px"><span>Liam</span> 👍（4） 💬（1）<div>老师，我有2个问题:

1 top 10 问题涉及到排序, 我感觉用优先级队列或带排序功能的ConcurrentSkipListMap更合适？ConcurrentHashMap不支持排序吧

2 CopyOnWrite的list为什么还要加锁呢，副本不是线程独享的吗？</div>2019-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/24/5d/65e61dcb.jpg" width="30px"><span>学无涯</span> 👍（2） 💬（2）<div>老师，我的意思是Unsafe#compareAndSetObject和Unsafe#getObjectVolatile方法，这两个方法的volatile语义可以保证数组元素的可见性。这样即使新增一个node，这俩方法也可以保证其他线程可以读到。还是说我对这两个方法有误解，请老师解惑！</div>2019-11-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/24/5d/65e61dcb.jpg" width="30px"><span>学无涯</span> 👍（2） 💬（1）<div>老师，1.7ConcurrentHashMap弱一致性我理解，但是1.8为什么呀，1.8使用CAS可以保证可见性吧</div>2019-11-12</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/WtHCCMoLJ2DvzqQwPYZyj2RlN7eibTLMHDMTSO4xIKjfKR1Eh9L98AMkkZY7FmegWyGLahRQJ5ibPzeeFtfpeSow/132" width="30px"><span>脱缰的野马__</span> 👍（1） 💬（2）<div>老师您好，黑名单的案例为什么不用线程安全的map啊，这样便于查询吧，如果总链表，要查询某个用户是否在黑名单不是要遍历整个链表吗？</div>2020-03-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/10/7b/eed9d6d6.jpg" width="30px"><span>小笨蛋</span> 👍（1） 💬（1）<div>我有个疑问，你有提到ConcurrntHashMap里面数据量比较大的情况下会有很多的红黑树的转化操作，但是据我了解Java里面的Hash算法是采用的分散很好的Time33算法，这份hash还是很均匀的，应该不会出现大量的红黑树的转化工作。能麻烦老师解答一下吗？</div>2019-08-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/57/24/2d942948.jpg" width="30px"><span>Eaglet</span> 👍（1） 💬（1）<div>老师，top10的问题，你说：在数据不断地写入和删除，且不存在数据量累积以及数据排序的场景，可以选用 CurrentHashMap。可是top10问题有排序，数据量也在实时的累积，感觉用 CurrentHashMap 也不是最合适吧？这里不太懂，请老师解释下我是否对 top10这个问题本身理解有问题。</div>2019-07-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/76/66/cbd6013c.jpg" width="30px"><span>Lambor</span> 👍（0） 💬（1）<div>老师，您好！一直有个疑惑，现在基本都是微服务架构，服务都是多实例运行，例如黑名单那个场景，数据应该不是直接使用 CopyOnWriteArrayList 保存在内存中的，这样多个实例的数据可能不一致，而是用 redis 这类中间件保存起来，服务中每次查询黑名单时从 redis 查询，写入应该也是写入到 redis 的。所以这个场景使用 CopyOnWriteArrayList 我不知道是不是能满足实际的业务需求。还望解答。</div>2020-03-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/24/5d/65e61dcb.jpg" width="30px"><span>学无涯</span> 👍（0） 💬（1）<div>concurrentHashMap添加元素用了Unsafe#compareAndSetObject方法，获取元素使用Unsafe#getObjectVolatile方法，这两个方法不是都有volatile语义吗，按道理来说都能获取到最新值呀</div>2019-11-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/43/8e/2c1ce77b.jpg" width="30px"><span>菜菜</span> 👍（0） 💬（1）<div>concurrentHashMap中的value不是加了volatile修饰吗? 为什么还存在数据弱一致性拿不到最新值的情况？</div>2019-09-22</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLM5CXZWgJuUXXbia0Gs8Th9wiacxAmibNd1qEMu1xkvUz7GEiaVUQMUfYF8SErPtrHWGuNwoSFrPgAdQ/132" width="30px"><span>老杨在努力</span> 👍（0） 💬（1）<div>个人感觉可以使用LinkedTransferQueue或者Disruptor来实现都可以，但是更倾向于后者，老师认为哪个更好？？</div>2019-08-16</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/EcYNib1bnDf5dz6JcrE8AoyZYMdqic2VNmbBtCcVZTO9EoDZZxqlQDEqQKo6klCCmklOtN9m0dTd2AOXqSneJYLw/132" width="30px"><span>博弈</span> 👍（0） 💬（1）<div>老师，可以把几个QUENE讲一讲</div>2019-08-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/83/c3/7bca8cbf.jpg" width="30px"><span>颉</span> 👍（0） 💬（1）<div>其次用户 ID 是整数类型，因此我们可以考虑使用数组来存储。----老师 这个弯没转过来 请教下 为什么id是整数类型 就要用数组？用户id可能是极度分散的…</div>2019-07-27</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIBpUsdg3ytlZrm9y64c5cq58iaqoh8kfp4rfYFqZQF8vdJ8mSCNSgbBgp1CHNrTHiaL5ibFEXZoqRoQ/132" width="30px"><span>Johnny</span> 👍（0） 💬（1）<div>还是不明白，concurrenthashmap的数组不是有volatile属性吗，就算没有锁变更了可以保证其他线程可见呀。happenbefore规则也是有这个的。</div>2019-07-17</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqw0R25Bt0iahFo3tfriat5ic3rto3u1qLdRlMI0ibGLwGR8MqiaU04N7VKsW8icpGLibo1ic0ebojUc5fNRA/132" width="30px"><span>Chaos</span> 👍（0） 💬（1）<div>老师，您好，如果这个业务用分布式锁，分布式锁是根据业务来决定锁定时间，但是如果业务没有执行完，但是redis释放了锁，这时应该怎么办啊？</div>2019-07-08</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIfQFSpQJNKeqW5Q9PfciaLyDDFm9heqW5SHQCzlrajXO8f38RCH3BE5k8QHGPMictbbAM9IGvicj5EQ/132" width="30px"><span>李</span> 👍（0） 💬（2）<div>在目前线上机器都是多台部署的，想问下老师，如上的数据结构如何选择，或者用不到如上的选择，都彩玉第3方存储，比如redis实现</div>2019-06-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/69/3d/abb7bfe3.jpg" width="30px"><span>Geek_8ra72c</span> 👍（0） 💬（1）<div>黑名单查询用户是否存在不是应该用HashSet吗？</div>2019-06-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d8/96/60e0d8fe.jpg" width="30px"><span>....</span> 👍（0） 💬（1）<div>元素增减对每层链表的变化是怎么样的</div>2019-06-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/d0/42/6fd01fb9.jpg" width="30px"><span>我已经设置了昵称</span> 👍（0） 💬（3）<div>我也没太明白什么叫弱一致性</div>2019-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg" width="30px"><span>QQ怪</span> 👍（0） 💬（1）<div>我想问下老师，concurrentHashMap是无序的，我不太明白是如何完成Top10这个需求的，麻烦解答</div>2019-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5c/c5/1231d633.jpg" width="30px"><span>梁中华</span> 👍（0） 💬（1）<div>ConcurrentHashmap和ConcurrentSkipListMap在功能上的主要区别是前者不排序，后者自动排序。并非数据量上的区别吧。控制好ConcurrentHashmap里元素key的hashcode值，尽量减少碰撞，在数据量比较大的情况下可能比ConcurrentSkipListMap的效率更好。</div>2019-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8c/f7/a4de6f64.jpg" width="30px"><span>大卫</span> 👍（0） 💬（1）<div>老师，这一讲不是讲的线程池大小如何设置哈。

抢购场景后端服务是分布式部署的，是将库存分片放到不同服务器上吗，然后考虑容器的选择么</div>2019-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/30/c1/2dde6700.jpg" width="30px"><span>密码123456</span> 👍（0） 💬（1）<div>抢购类，资源是固定的。那么说队列的长度就确定了。而消费者会特别多。需要一个强一致性进行维护。我觉得，vect比较好。</div>2019-06-27</li><br/>
</ul>