你好，我是刘超。

说到编译，我猜你一定会想到 .java文件被编译成 .class文件的过程，这个编译我们一般称为前端编译。Java的编译和运行过程非常复杂，除了前端编译，还有运行时编译。由于机器无法直接运行Java生成的字节码，所以在运行时，JIT或解释器会将字节码转换成机器码，这个过程就叫运行时编译。

类文件在运行时被进一步编译，它们可以变成高度优化的机器代码，由于C/C++编译器的所有优化都是在编译期间完成的，运行期间的性能监控仅作为基础的优化措施则无法进行，例如，调用频率预测、分支频率预测、裁剪未被选择的分支等，而Java在运行时的再次编译，就可以进行基础的优化措施。因此，JIT编译器可以说是JVM中运行时编译最重要的部分之一。

然而许多Java开发人员对JIT编译器的了解并不多，不深挖其工作原理，也不深究如何检测应用程序的即时编译情况，线上发生问题后很难做到从容应对。今天我们就来学习运行时编译如何实现对Java代码的优化。

## 类编译加载执行过程

在这之前，我们先了解下Java从编译到运行的整个过程，为后面的学习打下基础。请看下图：

![](https://static001.geekbang.org/resource/image/8d/17/8d4ec9c73ec37d69adb105aa7d052717.jpg?wh=2172%2A410)

### 类编译

在编写好代码之后，我们需要将 .java文件编译成 .class文件，才能在虚拟机上正常运行代码。文件的编译通常是由JDK中自带的Javac工具完成，一个简单的 .java文件，我们可以通过javac命令来生成 .class文件。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/1e/3a/5b21c01c.jpg" width="30px"><span>nightmare</span> 👍（53） 💬（3）<div>Class•forName有重载方法可以指定是否需要初始化，而默认的方法初始化设置为true这会初始化类执行链接和初始化操作，而ClasaLoader是有类加载器的loadClass方法加载，传入的是false只会执行链接操作，而不会执行初始化操作</div>2019-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg" width="30px"><span>QQ怪</span> 👍（31） 💬（2）<div>看老师这篇分享花了1个小时，分享的干货很多，回答下老师的问题：
不同点：
1）Class.forName()除了将类的.class文件加载到jvm中之外，还会对类进行解释，执行类中的static块，还会执行给静态变量赋值的静态方法。
2）classLoader只干一件事情，就是将.class文件加载到jvm中，不会执行static中的内容,只有在newInstance才会去执行static块。</div>2019-07-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/79/4b/740f91ca.jpg" width="30px"><span>-W.LI-</span> 👍（17） 💬（2）<div>这其实是因为由于 HotSpot 虚拟机目前的实现导致栈上分配实现比较复杂。
栈上分配影响:
1.java只有值传递，跨方法的局部变量在栈上分配的话，在现有栈实现上会影响栈的回收。
2.栈属于线程所有，实现栈上分配，会消耗更多的内存。让java的多线程更吃内存。
3.如果实现栈上分配，还需要GC作用会弱化很多吧。
4.基类型栈上分配+引用类型堆分配-&gt;全栈上分配。这么实现的话hotspot感觉全推翻了。
老师好有理解的不对的请指出谢谢</div>2019-07-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/f5/57/ce10fb1b.jpg" width="30px"><span>天天向上</span> 👍（4） 💬（1）<div>文中讲到：逃逸分析如果发现一个对象只在方法中使用，就会将对象分配在栈上。然而我们的程序大多数对象都是只在方法中使用的啊，那栈就得需要很大的空间了啊？？</div>2019-12-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ce/4f/6afbb99a.jpg" width="30px"><span>天信</span> 👍（3） 💬（2）<div>很困惑线上服务的时候如何去调整这些参数达到最优解，比如调整 ComplieThrehold 大小或者其它参数，以及调整后到如何计算收益呢</div>2020-01-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/f4/0e/e200dd34.jpg" width="30px"><span>SDL</span> 👍（2） 💬（1）<div>差了很多文章 还是没能找到在哪设置这些参数呢 望老师告知一下小白</div>2019-09-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/b3/c5/7fc124e2.jpg" width="30px"><span>Liam</span> 👍（2） 💬（1）<div>栈上分配这里，对局部变量对象的大小是否有要求，毕竟栈的内存比较小</div>2019-07-11</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/6LaITPQ4Lk5fZn8ib1tfsPW8vI9icTuSwAddiajVfibPDiaDvMU2br6ZT7K0LWCKibSQuicT7sIEVmY4K7ibXY0T7UQEiag/132" width="30px"><span>尔东橙</span> 👍（1） 💬（2）<div>老师，Javap反编译的内容是生成class文件的中间过程么（在变成二进制文件前的汇编）</div>2020-03-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5c/c5/1231d633.jpg" width="30px"><span>梁中华</span> 👍（1） 💬（1）<div>据一些书上说，因为默写原因Hotspot JVM并没有实现逃逸分析的优化，不知道最新的JVM有没有实现这条优化。</div>2019-07-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a2/ec/205fd50c.jpg" width="30px"><span>我又不乱来</span> 👍（1） 💬（1）<div>Class.forName加载类的时候会对类进行初始化，如静态代码块，ClassLoader 不会做初始化。spring做类加载的时候应该用的是ClassLoader把。超哥。</div>2019-07-11</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/6LaITPQ4Lk5fZn8ib1tfsPW8vI9icTuSwAddiajVfibPDiaDvMU2br6ZT7K0LWCKibSQuicT7sIEVmY4K7ibXY0T7UQEiag/132" width="30px"><span>尔东橙</span> 👍（0） 💬（3）<div>在非线程安全的情况下，尽量不要使用线程安全容器？这句话是不是线程安全的情况下？</div>2019-09-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/2a/54/c9990105.jpg" width="30px"><span>bro.</span> 👍（0） 💬（1）<div>逃逸分析跟标量替换在JDK 6u23以上版本都是默认开启状态的</div>2019-07-12</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/0PT9LxT8D6micyk0YbPuGQElQIeSax7puBBTXJDicJDhUHNibrbJPjEPJBRklVmcKG1PB7YV8JNh0BpsJjSicfibT5A/132" width="30px"><span>Wendy</span> 👍（0） 💬（2）<div>你好，刘兄！方便加下你微信吗？方便沟通</div>2019-07-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d0/69/5dbdc245.jpg" width="30px"><span>张德</span> 👍（8） 💬（2）<div>刘老师您好  听完这篇课程想起了以前去阿里面试一个面试官问到的问题  问题大概是 OSGI各个容器之间的类加载器是怎么进行隔离的  刘老师懂不懂  能不能回答一下  谢谢</div>2019-07-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/09/08/f3547e77.jpg" width="30px"><span>lobby</span> 👍（2） 💬（0）<div>看了另外一个专栏的jvm虚拟机的，再看编译这块没那么吃力了，这个文章有个总结性的作用挺好的</div>2020-05-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/2b/fa/1cde88d4.jpg" width="30px"><span>大俊stan</span> 👍（2） 💬（0）<div>老师花一章想把这些技术全部讲明白也是很难的</div>2020-03-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/17/16/afff9a38.jpg" width="30px"><span>好孩子</span> 👍（1） 💬（1）<div>为什么我测试的Class.forName和ClassLoader效果一样，都会执行静态代码块？</div>2020-08-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/f5/28/898a6947.jpg" width="30px"><span>瓶子</span> 👍（1） 💬（0）<div>干货满满 太干了！  给老师敬礼哈哈哈~ 慢慢消化希望都能成为自己的~</div>2020-02-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/80/ff/89ef5b24.jpg" width="30px"><span>吴 云</span> 👍（0） 💬（0）<div>老师，回边计数器记录循环体的执行次数，如果循环体内有变量 随着循环次数发生改变 不确定变量值的情况下这种也能直接变成机器码么</div>2023-08-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/06/a2/350c4af0.jpg" width="30px"><span>知易</span> 👍（0） 💬（0）<div>牛啊牛啊，干货满满。来得晚了点，但是在补课的路上了</div>2021-05-09</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132" width="30px"><span>null</span> 👍（0） 💬（0）<div>javac 将 .java 文件编译成 .class 文件，即字节码文件。
interpreter 解释执行 .class 文件，JVM 层面的执行。
JIT 将 .class 文件编译为机器码，直接通过硬件执行。

是这样么，老师。谢谢</div>2021-04-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/81/d4/e92abeb4.jpg" width="30px"><span>Jecy-8</span> 👍（0） 💬（0）<div>干货满满，谢谢老师</div>2021-04-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/35/e9/9280de62.jpg" width="30px"><span>hiwon</span> 👍（0） 💬（2）<div>你好，请问一下单例模式的double check变量一定要加volatile来确保指令重排问题？在类的创建到初始化是原子操作？</div>2021-01-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/86/4e/98dac64b.jpg" width="30px"><span>Simba</span> 👍（0） 💬（1）<div>老师，请教一下。逃逸分析那断代码如何用VisualVM抓到堆中创建的对象数量，我在执行的时候代码一瞬间就执行完了，VisualVM软件中也没有抓取到任何内存快照信息 ～  
我的开发环境是MAC系统，IDEA + visualvm launcher （插件）</div>2021-01-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/8a/5a/b67a82e3.jpg" width="30px"><span>shen</span> 👍（0） 💬（0）<div>避免在一个方法中写大量代码，习惯使用小方法体；如果大方法没有办法内联而已，但是内联的目的不就是为了变为一个大方法吗？如果从程序性能优化的角度好像没太大关系吧</div>2020-12-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/eb/63/09e7f442.jpg" width="30px"><span>溯雪</span> 👍（0） 💬（0）<div>“由于 Interpreter 的效率低下，JVM 中的 JIT 会在运行时有选择性地将运行次数较多的方法编译成二进制代码，直接运行在底层硬件上。” 老师，我想请教个比较小白的问题，为什么JIT不把所有代码都编译到底层硬件上，而是只编译热点代码呢？如果某个系统对性能要求比较高，在内存资源充足、不关心初始化时长的场景下，把所有代码编译到底层硬件是否可行？</div>2020-11-01</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJkdQpT1UAl2wjADkrc1fGy9ks9FQZnxC4P5VyABwatlWrr8AciaAr8RxA7p89CYlxlCqcdSbbmKeg/132" width="30px"><span>不可言喻的2</span> 👍（0） 💬（0）<div>之前用jdk1.8试过逃逸分析，测试过开启逃逸分析和不开启创建1000W对象时间差距很大，为嘛老师说虚拟机目前还没实现呢</div>2020-07-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/78/99/6060eb2d.jpg" width="30px"><span>平凡之路</span> 👍（0） 💬（0）<div>学习了很多</div>2019-11-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（0） 💬（3）<div>太干了，需要多点时间消化。老师这些知识，怎么持久化到脑袋里的，感觉自己脑袋里的知识都是分配在堆上的，很想放在MySQL数据库里。</div>2019-09-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0f/0e/98820fde.jpg" width="30px"><span>王龙飞</span> 👍（0） 💬（0）<div>看了三遍,干货满满,老师辛苦</div>2019-07-23</li><br/>
</ul>