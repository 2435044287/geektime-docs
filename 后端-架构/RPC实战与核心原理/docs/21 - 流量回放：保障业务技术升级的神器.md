你好，我是何小锋。上一讲我们学习了时钟轮在RPC中的应用，核心原理就一个关键字“分而治之”，我们可以把它用在任何需要高效处理大量定时任务的场景中，最具有代表性的就是在高并发场景下的请求超时检测。

回顾完上一讲的重点，我们就进入咱们今天的主题，一起看看流量回放在RPC里面的应用。

如果你经常翻阅一些技术文章的话，可能你会不止一次看到过“流量回放”这个词。我简单地介绍一下，所谓的流量就是某个时间段内的所有请求，我们通过某种手段把发送到A应用的所有请求录制下来，然后把这些请求统一转发到B应用，让B应用接收到的请求参数跟A应用保持一致，从而实现A接收到的请求在B应用里面重新请求了一遍。整个过程我们称之为“流量回放”。

这就好比今晚有场球赛，但我没空看，但我可以利用视频录播技术把球赛录下来，我随时想看都可以拿出来看，画面是一模一样的。

那在系统开发的过程中，回放功能可以用来做什么呢？

## 流量回放可以做什么？

我个人感觉，在我们日常开发过程中，可以专心致志地写代码、完成业务功能，是件很幸福的事儿，让我比较头疼的是代码开发完成后的测试环节。

在团队中，我们经常是多个需求并行开发的，在开发新需求的过程中，我们还可能夹杂着应用的重构和拆分。每到这个时候，我们基本很难做到不改动老逻辑，那只要有改动就有可能会存在考虑不周全的情况。如果你比较严谨的话，那可能在开发完成后，你会把项目里面的TestCase都跑一遍，并同时补充新功能的TestCase，只有所有的TestCase都跑通后才能安心。
<div><strong>精选留言（29）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/0f/bf/ee93c4cf.jpg" width="30px"><span>雨霖铃声声慢</span> 👍（9） 💬（2）<div>流量回放功能应该还可以用来恢复数据，比如一段时间的数据由于某种原因丢失了，那我们就应该用流量回放功能恢复这段时间的数据，当然要求接口是幂等的，否则会导致错误数据。</div>2020-04-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg" width="30px"><span>Darren</span> 👍（8） 💬（3）<div>老师，请教个问题，那既然能放在rpc做，那是不是也可以放到网关去做，比如我们机房迁移，或者服务重新部署一套的话，在网关做流量采集然后回访到另外一个网关，后面的服务都涉及到了，这样是否可行？</div>2020-04-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/3b/47/f6c772a1.jpg" width="30px"><span>Jackey</span> 👍（4） 💬（1）<div>用生产环境的流量来做压测？</div>2020-04-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/01/37/12e4c9c9.jpg" width="30px"><span>高源</span> 👍（3） 💬（2）<div>还得实践啊😊这个比较高级，能有例子参考学习最好了😊</div>2020-04-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg" width="30px"><span>每天晒白牙</span> 👍（3） 💬（1）<div>一直都是用 tcpcopy</div>2020-04-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/ab/72/91c9853e.jpg" width="30px"><span>Reason</span> 👍（2） 💬（1）<div>流量回放适用的方法是不是又限制，需要幂等的方法才可以？
</div>2020-04-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/20/08/bc06bc69.jpg" width="30px"><span>Dovelol</span> 👍（2） 💬（1）<div>还可以压测，性能优化之类的</div>2020-04-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/ef/27/c48a8fb6.jpg" width="30px"><span>Json Dumps</span> 👍（1） 💬（1）<div>只是录制请求和响应感觉不够。  响应可能和用户数据有关。  响应=请求参数+用户状态+其他依赖方状态。  </div>2020-04-17</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoz2e0Ka1CFfMIgZ8XHaVukpJm0Upibh68Wplru5a6zv0SkibM668tVaIGdMjpUHN8wEmiaTVtWgiahKQ/132" width="30px"><span>lingjiango</span> 👍（1） 💬（1）<div>流量回放重现生产问题？</div>2020-04-14</li><br/><li><img src="" width="30px"><span>鼠标</span> 👍（0） 💬（2）<div>请问update钱包咋回放，原先结果和现在结果肯定不一样吧</div>2020-04-29</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/l4nngwyggBGqeMXC0micwO8bM1hSttgQXa1Y5frJSqWa8NibDhia5icwPcHM5wOpV3hfsf0UicDY0ypFqnQ3iarG0T1w/132" width="30px"><span>Trident</span> 👍（0） 💬（1）<div>这个流量回放只使用幂等的接口吧</div>2020-04-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg" width="30px"><span>Jxin</span> 👍（0） 💬（1）<div>可是场景模拟，镜像流量只是其中一步，所有外部接口的mock也得和线上当时的场景一致，不然最后也可能脱离预期。</div>2020-04-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（21） 💬（2）<div>流量回放——之前组内做过一个类似的系统，我们叫线上验证系统——其核心就是拿到线上接口的出入参和接口信息，然后转存到另一个系统，在这个系统再调用改造、开发、或重构的接口（总之只要有变化或者想测试一下同样的如入参，调用同样的方法，只是逻辑稍微不同了，是否结果一样）就可以通过，线上验证系统来验证一下。
使用上当然，有限制啦！
首先，底层数据依赖是否一直，入不一致那结果不一致太正常了。
其次，和当前系统状态或者当前系统时间是否相关，如果相关，结果也可能不一致。
再次，就是方法是否幂等，如果不幂等，结果大概率也不一致的。
虽然，有局限性，不过也能解决一些问题，另外，结果是否一致是可定制化的，所以，对于某些特殊情况也是可以使用的。
实现思路
1：使用动态代理，切面拦截对应的方法，获取出入参
2：把拦截信息异步转存到线上验证系统
3：通过线上验证系统调用待验证的方法
4：收集结果比对信息，有报警功能（当然，在验证系统侧需要先收集和配置响应的待验证系统的信息，比如：定制化结果是否一直的条件）
5：我们一般就是用于线上验证或系统重构时使用</div>2020-05-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/47/b0/a9b77a1e.jpg" width="30px"><span>冬风向左吹</span> 👍（18） 💬（4）<div>阿里最近开源的sandbox-repeter</div>2020-04-20</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKYLPAlGUWic4yAqsGtEYBSRR7gDjyg9yiaJicNhMwiaNw4rMKQ5DHTfp7gmic0gpqEwCZaou8G6CdHKCg/132" width="30px"><span>ant</span> 👍（6） 💬（0）<div>从游戏的角度来看，我们可以利用流量回放进行玩家脚本录制，然后多线程进行大批量脚本执行从而达到压力测试的效果。</div>2020-05-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/23/d1/8de5aa5b.jpg" width="30px"><span>脏嘻嘻</span> 👍（3） 💬（0）<div>以前使用 GoReplay 去记录和重放 Http 流量，用于日常测试和压测</div>2021-02-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e0/a8/4e739cf6.jpg" width="30px"><span>Sic Pavis</span> 👍（2） 💬（1）<div>只记录入参出参，是远远达不到回放的效果的，实际情况远比文中介绍的复杂。

因为实际业务处理，经常涉及非常多的外部依赖：数据库、缓存、外部服务响应。 在回放的服务上，没有办法把这些依赖和线上环境完全保持一致。
因此，不仅要记录出参入参，至少还需要记录所有外部调用的依赖的响应内容。在回放时，mock 掉这些调用</div>2021-06-22</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ep66fdwo3ebSicKjf0iacAx4C2tZOthDDD4bSJqib1iauFBK6EoMSWUBp4UbbN2BQlib7mFR3hQD6MUwew/132" width="30px"><span>chai</span> 👍（1） 💬（0）<div>全链路压测、子链路压测</div>2021-04-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/c5/e0/7bbb6f3a.jpg" width="30px"><span>司空摘星</span> 👍（1） 💬（0）<div>流量回放，是为了模拟线上环境吧。有系统性的模拟线上环境的方法，或者有什么成熟的解决方案吗？</div>2020-12-04</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKhuGLVRYZibOTfMumk53Wn8Q0Rkg0o6DzTicbibCq42lWQoZ8lFeQvicaXuZa7dYsr9URMrtpXMVDDww/132" width="30px"><span>hello</span> 👍（1） 💬（0）<div>老师，rpc的流量复制及回放能否举个代码示例，伪代码级别就好，多谢！</div>2020-04-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/39/8c/ff48ece3.jpg" width="30px"><span>小乙哥</span> 👍（0） 💬（3）<div>流量回放的请求接口如果有DB操作（比如，创建订单），线上接口是创建成功，回放的时候已经有订单（创建失败）。这种情况回放流量怎么解决呢？</div>2022-06-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2a/39/6e/0ea71f8a.jpg" width="30px"><span>清风@知酒烈</span> 👍（0） 💬（1）<div>老师请问一个问题，我们的项目中也是使用dubbo，但是发现所有的pojo都必须实现java的Serializable接口，不然就会报错。如果说dubbo的序列化默认使用的是Hessian2，那为什么实体类还是要实现Serializable呢？</div>2022-05-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/22/f4/9fd6f8f0.jpg" width="30px"><span>核桃</span> 👍（0） 💬（0）<div>流量回放，其实本质上就是在大量重构之后，希望模拟线上真实的压力情况来暴露问题。而一种实现思路，可以考虑流量镜像，就是一个旧的还在运行的集群A，然后一个B改造后的集群，然后把请求流量复制也打一份到B上面看看，成本和维护代价还是挺高的。</div>2022-02-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/86/d7/bfd9e42a.jpg" width="30px"><span>轨迹</span> 👍（0） 💬（0）<div>流量录制之后，成倍的重放，达到压测的效果</div>2021-01-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/64/9b/d1ab239e.jpg" width="30px"><span>J.Smile</span> 👍（0） 💬（0）<div>这跟我们的预发布环境黑蕾丝啊，之前我们的预发布数据用的也是生产环境的。</div>2020-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/f1/09/a597fe8d.jpg" width="30px"><span>西柚</span> 👍（0） 💬（0）<div>流量回放可用来：
1.QA做接口探活，用线上数据调用接口（http接口只探get方法）
2.算法逻辑的验证：可用历史请求参数重跑一遍新算法逻辑，验证新算法逻辑的效果</div>2020-08-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/8c/00/c1f32133.jpg" width="30px"><span>李裕基</span> 👍（0） 💬（1）<div>老师，没太明白旁路收集rpc的流量是怎么回事，可以讲解下？</div>2020-05-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/99/b1/46570b0c.jpg" width="30px"><span>申玉宝</span> 👍（0） 💬（0）<div>参数和返回值也得存下来，安全隐患比较大； 非幂等接口想用的话，TC里最好有完整的创建数据，清理数据调用，难度也比较大</div>2020-05-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/55/f2/ba68d931.jpg" width="30px"><span>有米</span> 👍（0） 💬（2）<div>感觉没什么用处。举个例子，付款接口，你不能通过入参和出参相同就判断里面的执行结果相同，都是返回付款成功，你怎么知道实际上付款了一次还是两次？你可能会说把付款成功金额返回，但有bug的情况，付款了两次，却返回了一次的成功金额。按回放功能来跑，这个bug就发现不了。</div>2020-05-05</li><br/>
</ul>