你好，我是何小锋。上一讲我们学习了在分布式环境下如何快速定位问题，简单回顾下重点。在分布式环境下，RPC框架自身以及服务提供方的业务逻辑实现，都应该对异常进行合理地封装，让使用方可以根据异常快速地定位问题；而在依赖关系复杂且涉及多个部门合作的分布式系统中，我们也可以借助分布式链路跟踪系统，快速定位问题。

现在，切换到咱们今天的主题，一起看看时钟轮在RPC中的应用。

## 定时任务带来了什么问题？

在讲解时钟轮之前，我们先来聊聊定时任务。相信你在开发的过程中，很多场景都会使用到定时任务，在RPC框架中也有很多地方会使用到它。就以调用端请求超时的处理逻辑为例，下面我们看一下RPC框架是如果处理超时请求的。

回顾下[\[第 17 讲\]](https://time.geekbang.org/column/article/216803)，我讲解Future的时候说过：无论是同步调用还是异步调用，调用端内部实行的都是异步，而调用端在向服务端发送消息之前会创建一个Future，并存储这个消息标识与这个Future的映射，当服务端收到消息并且处理完毕后向调用端发送响应消息，调用端在接收到消息后会根据消息的唯一标识找到这个Future，并将结果注入给这个Future。

那在这个过程中，如果服务端没有及时响应消息给调用端呢？调用端该如何处理超时的请求？
<div><strong>精选留言（20）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/0f/bf/ee93c4cf.jpg" width="30px"><span>雨霖铃声声慢</span> 👍（43） 💬（8）<div>时钟轮可以实现延时消息的功能，比如让一个任务几分钟之后发送一条消息出去。在比如可以实现订单过期功能，用户下单10分钟没付款，就取消订单，可以通过时钟轮实现。</div>2020-04-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/82/3d/356fc3d6.jpg" width="30px"><span>忆水寒</span> 👍（30） 💬（1）<div>在java里面和Netty框架里面有这个类，TimeWheel时钟轮模型。</div>2020-04-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/70/67/0c1359c2.jpg" width="30px"><span>qinsi</span> 👍（18） 💬（5）<div>时钟轮存取任务的时间复杂度是O(1)，相比之下优先队列的时间复杂度是O(logN)</div>2020-04-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/01/37/12e4c9c9.jpg" width="30px"><span>高源</span> 👍（10） 💬（3）<div>时钟轮这个我头一次听到，老师如果并发线程比较多，单位时间是不是划分很细啊，但是我有个疑问例如我同时有5个线程几乎之间间隔3到5毫秒，又有3个线程10到100毫秒的，我时钟轮也得调整具体怎么划分的，这么短时间内如何保证时钟轮准确性，老师哪有参考代码学习一下</div>2020-04-06</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqMevH71ChH7gIJ18A79xFWnGicsbebuREjPYxzLMzwtX08icapU3hmsGpF1zZ2iayDt2ZoMiaic0PcG3g/132" width="30px"><span>719</span> 👍（1） 💬（2）<div>提高扫描定时任务效率还有一种方法是所有定时任务放入按照时间排序的优先队列，每次只扫描队首节点。从性能上看，哪种方法好一些？</div>2020-05-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（10） 💬（1）<div>定时任务相关解决方案：
1：线程休眠，可能需要N多线程
2：定时轮询，可能会空耗许多CPU轮询
3：时间轮，和时钟原理相似，规避1&#47;2的缺陷
只有涉及到定时任务，就可以使用时钟轮来解决，比如：
调用端超时处理、调用端和服务端的启动超时处理、定时心跳检测、延迟消息队列的延迟消息发送等。
netty框架中就有时钟轮的实现，可以研究一下。</div>2020-05-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/67/12/51b78d88.jpg" width="30px"><span>🐠</span> 👍（3） 💬（2）<div>请问老师，为什么说多层时间轮中的任务会被重复扫描呢？就上面例子的任务C来说，它处于下一层的第1个槽位，那么经过1s后，它被分布到当前的时间轮中，然后经过600ms后跳动到当前时间轮的第6个槽位，此时才会触发任务C。重复扫描的意思就是说在下一层的第1个槽位被扫描过一次，然后在当前时间轮的第6个槽位又被扫描过一次吗？</div>2021-06-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0a/a4/828a431f.jpg" width="30px"><span>张申傲</span> 👍（2） 💬（0）<div>调用方的异常重试也可以考虑使用时间轮。感触：软件设计的本质都是生活~</div>2021-02-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/25/29/cf/db5be02a.jpg" width="30px"><span>漆黑的小白</span> 👍（1） 💬（0）<div>第一次听到时间轮还是在kafka里，拿来做一些轻量级的延时处理还挺不错的</div>2022-02-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/3c/74/580d5bbb.jpg" width="30px"><span>renpeng</span> 👍（1） 💬（0）<div>技术的思想很多都是源于生活</div>2020-05-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e1/19/c756aaed.jpg" width="30px"><span>鸠摩智</span> 👍（1） 💬（8）<div>redis中的key的超时是不是也用时钟轮实现的？</div>2020-05-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/16/48/09493874.jpg" width="30px"><span>茶没喝完</span> 👍（0） 💬（0）<div>推荐参看dubbo的HashTimeWheel源码，它是单层+轮数 来实现多层时间轮。
源码不复杂，看完就可以明白时间轮的运行原理。
</div>2024-10-14</li><br/><li><img src="" width="30px"><span>hillwater</span> 👍（0） 💬（1）<div>时间槽里面的任务用什么数据结构维护呢，hashmap？</div>2022-10-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/5a/4a/856ea384.jpg" width="30px"><span>Hugo</span> 👍（0） 💬（1）<div>文中提到，时间轮的槽位越多，那么一个任务被重复扫描的概率就越小，因为只有在多层时钟轮中的任务才会被重复扫描。
这里为什么会重复扫描呢
</div>2022-07-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/67/8a/babd74dc.jpg" width="30px"><span>锦</span> 👍（0） 💬（1）<div>在实际开发中，单层时间轮和多层时间轮哪个用得多呢？</div>2021-06-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/06/7e/735968e2.jpg" width="30px"><span>西门吹牛</span> 👍（0） 💬（0）<div>定时心跳这个，可以用定时任务线程池来实现，底层是用延时队列来保存任务，普通的线程是队列中取出任务执行就完了，定时任务 ，可以从队列 取出任务，然后在重设时间，放回任务队列。</div>2021-05-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/c5/e0/7bbb6f3a.jpg" width="30px"><span>司空摘星</span> 👍（0） 💬（1）<div>为什么要自己实现时间轮，简单的超时回调不行吗？</div>2020-12-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/64/9b/d1ab239e.jpg" width="30px"><span>J.Smile</span> 👍（0） 💬（1）<div>貌似jdk的优先级队列也可以实现到期任务的优化扫描。</div>2020-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/30/c1/2dde6700.jpg" width="30px"><span>密码123456</span> 👍（0） 💬（2）<div>时间轮，是不停的走动。怎么动态新添加？</div>2020-05-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（0） 💬（0）<div>头次听说这个东西，主要解决定时任务相关的不断轮询过多耗CPU的问题。优秀代码，真应该好好研究一下。</div>2020-05-16</li><br/>
</ul>