你好，我是何小锋。上一讲我们介绍了RPC中常用的保护手段“熔断限流”，熔断是调用方为了避免在调用过程中，服务提供方出现问题的时候，自身资源被耗尽的一种保护行为；而限流则是服务提供方为防止自己被突发流量打垮的一种保护行为。虽然这两种手段作用的对象不同，但出发点都是为了实现自我保护，所以一旦发生这种行为，业务都是有损的。

那说起突发流量，限流固然是一种手段，但其实面对复杂的业务以及高并发场景时，我们还有别的手段，可以最大限度地保障业务无损，那就是隔离流量。这也是我今天重点要和你分享的内容，接下来我们就一起看看分组在RPC中的应用。

## 为什么需要分组？

在我们的日常开发中，我们不都提倡让用户使用起来越简单越好吗？如果在接口上再加一个分组维度去管理，不就让事情变复杂了吗？

实则不然，举个例子。在没有汽车的年代，我们的道路很简单，就一条，行人、洋车都在上边走。那随着汽车的普及以及猛增，我们的道路越来越宽，慢慢地有了高速、辅路、人行道等等。很显然，交通网的建设与完善不仅提高了我们的出行效率，而且还更好地保障了我们行人的安全。

同样的道理，我们用在RPC治理上也是一样的。假设你是一个服务提供方应用的负责人，在早期业务量不大的情况下，应用之间的调用关系并不会复杂，请求量也不会很大，我们的应用有足够的能力扛住日常的所有流量。我们并不需要花太多的时间去治理调用请求过来的流量，我们通常会选择最简单的方法，就是把服务实例统一管理，把所有的请求都用一个共享的“大池子”来处理。这就类似于“简单道路时期”，服务调用方跟服务提供方之间的调用拓扑如下图所示：
<div><strong>精选留言（28）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg" width="30px"><span>Darren</span> 👍（25） 💬（1）<div>我们目前使用的不同的注册中心，就是注册中心是部署了3份，prod、qa、test等，其实test和dev用的是同一个注册中心，因为我们的注册中心内部也有环境的区分，服务在往注册中心注册时，需要说明自己的环境。
所以我们目前服务间的调用是：
prod走生产网关prod.gateway.com（网关同步注册中心信息） 环境参数默认prod
qa走生产网关qa.gateway.com（网关同步注册中心信息） 环境参数默认qa
test和dev走 test.gateway.com（网关同步注册中心信息）,test需要环境的参数，test就是tets，dev就是dev
</div>2020-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/1a/05/f154d134.jpg" width="30px"><span>刘楠</span> 👍（5） 💬（1）<div>环境不同，注册中心不同</div>2020-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/66/9b/59776420.jpg" width="30px"><span>百威</span> 👍（2） 💬（3）<div>直连</div>2020-03-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/30/3c/0668d6ae.jpg" width="30px"><span>盘胧</span> 👍（2） 💬（1）<div>不是很明白了。开发这边开发环境容器化，我们云主机克隆过来或者直接拉镜像都行，最后修改好配置。就相当于和开发隔离开来了。开发这边每天的更新打包好，我们也拿过来打包升级就行了。</div>2020-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/20/08/bc06bc69.jpg" width="30px"><span>Dovelol</span> 👍（2） 💬（2）<div>老师好，如果没有用rpc而是走http调用的微服务怎么做分组呢，现在有在网关可以做分组的吗？</div>2020-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/f1/55/8ac4f169.jpg" width="30px"><span>陈国林</span> 👍（1） 💬（1）<div>开发推荐使用开发机测试，测试则使用Pre环境，互不干扰</div>2020-03-26</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKhuGLVRYZibOTfMumk53Wn8Q0Rkg0o6DzTicbibCq42lWQoZ8lFeQvicaXuZa7dYsr9URMrtpXMVDDww/132" width="30px"><span>hello</span> 👍（1） 💬（1）<div>故障隔离还能这么玩，今天又见识到了一种新思路（”借道“），感谢老师！</div>2020-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/a7/90/9a0da433.jpg" width="30px"><span>小哇</span> 👍（1） 💬（1）<div>请问老师，您讲的是同个服务集群的分组还是说不同服务的分组，如果是同个服务分组，既然同个服务里有核心和非核心接口，那是不是继续拆分服务才对呢？如果是不同服务，分组只是为了标识不同的应用而已吧？</div>2020-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/ab/72/91c9853e.jpg" width="30px"><span>Reason</span> 👍（1） 💬（1）<div>服务本身增加环境属性，注册信息中增加环境信息，服务发现时默认发现同环境的服务，类似于再增加个分组级别？</div>2020-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8c/9c/d48473ab.jpg" width="30px"><span>dancer</span> 👍（0） 💬（1）<div>请问老师如果在限流阈值配置中加入应用分组的设置，和本文方案是不是也有相同的效果？</div>2020-05-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/45/26/f54c9888.jpg" width="30px"><span>redis</span> 👍（0） 💬（2）<div>多环境的服务，我们原来采用的是修改route模块，根据调用端IP提前建立私有圈子，如果本地服务启动了就调用自己本地的.</div>2020-04-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/15/d7/96e77edd.jpg" width="30px"><span>问心</span> 👍（0） 💬（1）<div>老师，可以这样理解么？
按业务类型分组，各业务服务包含对应业务所有接口。
将对应业务中所有的接口进行分级，按级别进行分组。所有分组信息保存在限流服务中，并对各级别配置可用的临时级别，用于流量突增时临时借用，或直接对分组进行扩容。
调用方携带自身级别从限流服务中获取对应接口信息，限流服务在对应级别服务达到饱和时，考虑临时使用其他级别，并在流量降低时，停止使用临时级别。</div>2020-03-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg" width="30px"><span>Jxin</span> 👍（0） 💬（1）<div>1.测试环境和开发环境一般是隔离的，不会出现上述情况。问题可以改成：同个开发环境的小伙伴，如何保证自己测试时请求到的是自己的机器？

2.在分组后面追加变量，通过识别环境参数，做到每个人的分组都不一样，这就能做到隔离。但遗憾的是，这将复用不到一些部署在开发环境的已有应用。自己本地得跑全套。</div>2020-03-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0f/bf/ee93c4cf.jpg" width="30px"><span>雨霖铃声声慢</span> 👍（0） 💬（1）<div>这种问题会有发生，但都是做法不规范造成的，一般的做法都是通过环境来区分，如开发的有专门的dev环境，测试的有专属的QA环境，生产的有专属的prod环境。而且如果有交叉使用的情况的话就要互相知会到，没必要通过技术手段来解决这种问题。</div>2020-03-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0a/a4/828a431f.jpg" width="30px"><span>张申傲</span> 👍（2） 💬（0）<div>解决高可用的思路，还可以增加通用的紧急车道，对应 RPC 里面就是默认分组，当一个分组下所有节点都不可用时，允许将流量切到默认分组。</div>2021-02-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c6/cb/c7541d52.jpg" width="30px"><span>cwfighter</span> 👍（2） 💬（1）<div>K8S的namespace是个环境隔离好解决方案，放在rpc觉得有点重；实际的流量隔离可能更多是做业务做SET，同时也是容灾考虑，因为只是服务提供方做了流量隔离，但服务提供方依赖的服务没有做流量隔离其实意义不大，同样会因为流量突增引发异常。这样如果都做了流量隔离，其实也就是SET化架构了。所以不太明白rpc的分组功能究竟使用场景是什么，调用链一长，分组就很难维护了，还是说分组就是为了SET化功能考虑的？</div>2020-09-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/65/d5/88beb15a.jpg" width="30px"><span>李志博</span> 👍（2） 💬（2）<div>其实我想问1个问题，服务分组的方式，代码仓库还是1个，我们想用服务分组做核心和非核心链路的隔离，但是谁能保证，非核心结构的改动，不会间接影响核心的分组呢，毕竟代码还是同一套，这样的话，隔离还是不彻底的，不知道老师有没有好的解决方案</div>2020-05-18</li><br/><li><img src="" width="30px"><span>Geek_9815f1</span> 👍（1） 💬（0）<div>采用染色流量的方式区分就好了。</div>2021-05-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/b7/53/7c2b0e05.jpg" width="30px"><span>神经蛙</span> 👍（0） 💬（0）<div>分组不就是路由吗</div>2023-03-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/20/cc/b1/0daffd36.jpg" width="30px"><span>丰丰丰锅ÄÖÜ🇩🇪</span> 👍（0） 💬（1）<div>多分组的话，主分组的节点是平时正常调用的节点，次分组则没调用过。那么因异常情况切到次分组后，会不会遇到过前面“优雅启动”章节里提到的冷启情况呢</div>2022-11-30</li><br/><li><img src="" width="30px"><span>hillwater</span> 👍（0） 💬（0）<div>给服务提供方分组，分组怎么实现呢，特别是有扩缩容的情况，怎么管理维护分组呢</div>2022-10-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/82/8b/5340fb27.jpg" width="30px"><span>gsz</span> 👍（0） 💬（0）<div>分组是指将服务提供方进行分组，不同的服务调用放访问不同组的服务提供方吗？</div>2021-06-07</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/cJwhYkXicLBFezDEU6PibfNPOwwbibEZorUwuqrqya8nJqTB6FceVIKv1QpEjGAap14gS8IvQsSCPYmKTUEBlMHVg/132" width="30px"><span>Geek_9oth6g</span> 👍（0） 💬（0）<div>这里提到对服务提供方进行分组，一个应用部署到集群上，部分机器提供核心业务A类接口，部分机器提供非核心业务B类接口，这样会不会额外因素分布式事务的问题又提升了复杂度呢？</div>2021-05-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/46/d3/e25d104a.jpg" width="30px"><span>êｗěｎ</span> 👍（0） 💬（0）<div>给请求染色经过网关做路由。</div>2021-04-02</li><br/><li><img src="" width="30px"><span>程志东</span> 👍（0） 💬（0）<div>不明白:服务在注册时，是不同的ip，提供不同的分组参数吗？怎么做到的？</div>2021-03-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/68/2c/ec17f23b.jpg" width="30px"><span>Hex</span> 👍（0） 💬（1）<div>在上图分组调用拓扑图中，提供方服务提供两个分组A、B，为什么不直接拆成两个微服务呢？核心业务接口与非核心接口从服务级别分开会不会更好？</div>2020-10-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（0） 💬（0）<div>分组确实好用，而且还可以控制是否同机房调用，如果一个机房有问题也可以切到别的机房，专门的分组也可以用来灵活做别的事情，比如：直接线上联调
老师问题，针对有条件进行环境隔离的是不存在的，针对没这个条件的，可以通过类似分组的方式进行服务分组隔离，这个也做不到，哪知道约定使用方式或时间区间了，当然，最好能环境隔离，同时有你进行数据的同步控制，这样既不互相影响又能测试类似的场景。</div>2020-05-16</li><br/><li><img src="" width="30px"><span>shangrila</span> 👍（0） 💬（0）<div>都是业务实践经验的总结。</div>2020-05-11</li><br/>
</ul>