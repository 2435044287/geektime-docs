你好，我是何小锋。上一讲我们介绍了在RPC里面怎么支持流量回放，应用在引入RPC后，所有的请求都会被RPC接管，而我们在RPC里面引入回放的原因也很简单，就是想通过线上流量来验证改造后应用的正确性，而线上流量相比手动维护TestCase的场景更丰富，所以用线上流量进行测试的覆盖率会更广。

回顾完上一讲的重点，我们就切入今天的主题，一起看看动态分组在RPC里面的应用。

在[\[第 16 讲\]](https://time.geekbang.org/column/article/215668) 我们讲过，在调用方复杂的情况下，如果还是让所有调用方都调用同一个集群的话，很有可能会因为非核心业务的调用量突然增长，而让整个集群变得不可用了，进而让核心业务的调用方受到影响。为了避免这种情况发生，我们需要把整个大集群根据不同的调用方划分出不同的小集群来，从而实现调用方流量隔离的效果，进而保障业务之间不会互相影响。

## 分组后容量评估

通过人为分组的方式确实能帮服务提供方硬隔离调用方的流量，让不同的调用方拥有自己独享的集群，从而保障各个调用方之间互不影响。但这对于我们服务提供方来说，又带来了一个新的问题，就是我们该给调用方分配多大的集群才合适呢？

在[\[第 16 讲\]](https://time.geekbang.org/column/article/215668) 我们也有聊到过这样的问题，就是该怎么划分集群的分组？当然，最理想的情况就是给每个调用方都分配一个独立的分组，但是如果在服务提供方的调用方相对比较多的情况下，对于服务提供方来说要维护这些关系还是比较困难的。因此实际在给集群划分分组的时候，我们一般会选择性地合并一些调用方到同一个分组里。这就需要我们服务提供方考虑该怎么合并，且合并哪些调用方？
<div><strong>精选留言（17）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/1b/35/d1/12439914.jpg" width="30px"><span>树洞老人</span> 👍（12） 💬（1）<div>一楼哈哈，老师，是不是对非核心组也应该有个评估，感觉核心组的流量突增的话，非核心的流量肯定也会增加</div>2020-04-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg" width="30px"><span>Darren</span> 👍（9） 💬（3）<div>试着根据目前的知识储备回答下问题：不管是服务调用方还是服务提供方，其实都是定时轮训或者长链接的形式与注册中心保持联系的，可以要求服务方提供一个修改分组的接口，当注册中心修改了，调用接口更新服务提供方，或者服务提供方本身就是要定时上报心跳的，上报心跳的时候，可以把分组名称带回去。</div>2020-04-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/05/48/432c4b74.jpg" width="30px"><span>Micheal</span> 👍（1） 💬（1）<div>你好我有个疑问，一个系统有A，B，C三个服务。怎么计算这个系统的极限QPS？是三个接口的极限QPS加一起么？还有有其他的公式呢？希望老师解答下。</div>2020-04-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f0/9f/46d8f49a.jpg" width="30px"><span>华伦</span> 👍（1） 💬（1）<div>服务提供方要实现请求方的分组标示验证，通过请求中携带分组标示进行验证的，是否可以考虑使用zk单据维护服务和分组的关系，提供方缓存该关系，监听该节点，有变化中从zk中获取变更后的分组标示进行请求验证</div>2020-04-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg" width="30px"><span>Jxin</span> 👍（1） 💬（1）<div>如果分组名是一个数组而非str，命名检验是包含而不是等于。调用方优先调用0索引位的分组集群，在动态评估压力后，从1，2，3索引位依次追加集群，岂不美哉。</div>2020-04-10</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/l4nngwyggBGqeMXC0micwO8bM1hSttgQXa1Y5frJSqWa8NibDhia5icwPcHM5wOpV3hfsf0UicDY0ypFqnQ3iarG0T1w/132" width="30px"><span>Trident</span> 👍（0） 💬（1）<div>何老师，每个分组是不是都有不同的防火墙策略，这个动态分组的前提是所有的分组防火墙策略要一致才行？</div>2020-04-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0f/bf/ee93c4cf.jpg" width="30px"><span>雨霖铃声声慢</span> 👍（0） 💬（1）<div>课后思考：
可以提前计划预案，预先规划哪些集群是用于动态分组的，哪些服务需要动态扩容缩容，然后将这些服务都部署到这些集群上，这样只是没有使用到的服务只是消耗了写计算资源，不过影响到这个集群中使用的服务，比如有A，B，C三组服务部署在动态集群上，目前动态集群用于提供A服务，BC服务待命，当需要扩容B服务是，在注册中心修改集群提供B服务，这样请求B服务的请求发送到该集群上，因为B服务已经是可用状态，所以就可以无缝切换。</div>2020-04-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/17/39/3274257b.jpg" width="30px"><span>ple</span> 👍（4） 💬（3）<div>动态分组的图片没看懂, 改为B分组 然后还是画在A分组里? 调用方1和调用方2为什么都有C2?</div>2020-12-14</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eocvvlibbfYw4wezziaBKn2OLDpvTndicPr21ZZoeiaM5QLibICy7PJPQibCAz5zfMe08ibem7ll3LSzkWaQ/132" width="30px"><span>Geek_8c0618</span> 👍（2） 💬（1）<div>实际情况 不同的集群会有不同的环境变量 这个怎么解决？</div>2021-05-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（2） 💬（0）<div>服务提供方会验证调用方过来的分组名跟自身的是否一样？
可以在服务提供方进行分组名验证逻辑这一块做扩展，动态分组别名有一定的格式，验证逻辑这块识别后，可以认为是OK的，分组名不一定一模一样才能验证通过。</div>2020-05-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/fa/84/f01d203a.jpg" width="30px"><span>Simple life</span> 👍（1） 💬（0）<div>监听注册中心，数据变更的时候修改分组信息</div>2020-10-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/81/66/31c7969e.jpg" width="30px"><span>随风而逝</span> 👍（1） 💬（0）<div>通过注册中心修改服务提供的分组信息或增加临时分组信息，通过注册中心下发或者服务提供者定时拉去，都可以拿到最新的配置信息，在设计的时候就要考虑这种临时分组的情况，验证时进行常规+临时分组验证</div>2020-08-28</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyibojtJCnzALT1CleOHlTfS1XpFQHibXA7B2j631I2icHL2Uy5XvvviaEXBWPSNkU5G7LQP3JJHicgzQ/132" width="30px"><span>邹</span> 👍（1） 💬（0）<div>分组鉴别增加逻辑，除了分组名一样的可以调用，再加上动态切换的分组可以调用，在发请求的时候可以在请求头里面加上标识，标识这是一个动态切换来的分组。当流量降低之后，恢复成原来的分组标识。</div>2020-07-12</li><br/><li><img src="" width="30px"><span>嘻嘻</span> 👍（1） 💬（0）<div>分组这个事可以直接在注册中心设置调配，不用跟实际绑定</div>2020-04-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/22/f4/9fd6f8f0.jpg" width="30px"><span>核桃</span> 👍（0） 💬（0）<div>这里动态分组方案中，有时候会有一些备用的机器在随时待命的，为了进一步提高集群扩容时候，能够更加快速地加入集群。可以让备用的机器也进行预热启动，但是因为没有流量，所以启动之后，只是在随时静待候命，一旦有需要了，启动的服务就可以随时可以用了。同时关闭掉其他非该集群的服务。</div>2022-02-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/c5/e0/7bbb6f3a.jpg" width="30px"><span>司空摘星</span> 👍（0） 💬（0）<div>我觉得使用方应该提前告知自己近期的流量状况给后端依赖，后端自己扩容或者缩容</div>2020-12-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e1/19/c756aaed.jpg" width="30px"><span>鸠摩智</span> 👍（0） 💬（0）<div>这个服务分组，如果服务需要访问MySQL，不同的分组要访问不同的MySQL实例才能实现分组的隔离吧？</div>2020-09-01</li><br/>
</ul>