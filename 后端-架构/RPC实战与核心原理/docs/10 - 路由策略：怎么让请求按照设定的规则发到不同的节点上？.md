你好，我是何小锋。上一讲我们介绍了健康检测在RPC中的作用，简单来讲就是帮助调用方应用来管理所有服务提供方的连接，并动态维护每个连接的状态，方便服务调用方在每次发起请求的时候都可以拿到一个可用的连接。回顾完上一讲的重点，我们就切入今天的主题——RPC中的路由策略。

## 为什么选择路由策略？

在前面我们提到过，在真实环境中我们的服务提供方是以一个集群的方式提供服务，这对于服务调用方来说，就是一个接口会有多个服务提供方同时提供服务，所以我们的RPC在每次发起请求的时候，都需要从多个服务提供方节点里面选择一个用于发请求的节点。

既然这些节点都可以用来完成这次请求，那么我们就可以简单地认为这些节点是同质的。这里的同质怎么理解呢？就是这次请求无论发送到集合中的哪个节点上，返回的结果都是一样的。

既然服务提供方是以集群的方式对外提供服务，那就要考虑一些实际问题。要知道我们每次上线应用的时候都不止一台服务器会运行实例，那上线就涉及到变更，只要变更就可能导致原本正常运行的程序出现异常，尤其是发生重大变动的时候，导致我们应用不稳定的因素就变得很多。

为了减少这种风险，我们一般会选择灰度发布我们的应用实例，比如我们可以先发布少量实例观察是否有异常，后续再根据观察的情况，选择发布更多实例还是回滚已经上线的实例。
<div><strong>精选留言（23）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/7b/98/8f1aecf4.jpg" width="30px"><span>楼下小黑哥</span> 👍（41） 💬（2）<div>我们是做支付系统，需要对接多个银行服务。我们内部将外部服务接口都抽象化一组接口，每次接入只要相应实现即可。每个银行服务，我们会定义一个唯一ID。服务暴露的时候，利用 dubbo group 配置，将group设置为该id，个性化导出。
在银行服务前面有一个路由系统，这个系统会根据上游系统指定id，通过 dubbo 提供 api 调用，调用相应 group 的银行服务。
嘿嘿，这应该也是一种利用服务版本路由策略。</div>2020-03-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/2a/c0/aa0dfe16.jpg" width="30px"><span>noname</span> 👍（26） 💬（3）<div>路由本质是节点分组、隔离流量，因此不论打标签还是分流等特性都天然适合在路由策略里做。
这里分享一个小经验案例：虽然在调用方(上游)做路由策略选择可用的提供方(下游)集群，是天然符合RPC调用机制的，但是在团队协作上却是反人性的。想一想，当你作为下游服务方，你希望链路中扩展某种路由特性(原生不支持)，这时候你需要和你的上游协商并且需要对方优先你或与你同时上线，一般来说对方都是不情愿的，因为对对方而言不仅没有收益还要面临配合你升级带来的风险。因此遇到这种情况时(你作为下游业务方)，最好能有全局视角的人来推动不同团队服务的路由策略同时升级，或者能初期设计考虑周全，后期扩展时业务不需要更新部署(例如Dubbo的条件路由、脚本路由等都是可以从第三方写注册中心更新路由策略而无需业务变更)。
扩展新的路由策略不难，新的路由策略上线比较难😂</div>2020-03-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/d7/39/6698b6a9.jpg" width="30px"><span>Hector</span> 👍（13） 💬（3）<div>越到后面越像k8s的服务治理了，基于etcd的服务发现，pod的状态管理与探活，service的负载功能。原来好多东西都是相通的</div>2020-03-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/77/3c/64201b6f.jpg" width="30px"><span>坡岛码畜</span> 👍（8） 💬（1）<div>我们的应用场景：在多个feature同时开发的时候 可以用路由策略在test环境对某一个服务发布多个版本 在配置中心配置路由规则把来自某一个调用方的请求路由到某一个特定版本的服务上去</div>2020-03-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/15/d7/96e77edd.jpg" width="30px"><span>问心</span> 👍（5） 💬（2）<div>老师，IP级限制是好理解的，而路由应该是在rpc中相对底层的模块，而在做处理路由策略的时候，还需要应用层的数据，这样的处理感觉不是特别的合理。</div>2020-04-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/3b/47/f6c772a1.jpg" width="30px"><span>Jackey</span> 👍（5） 💬（2）<div>思考题还真想不出来别的了😅期待评论区大佬出现</div>2020-03-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/55/f2/ba68d931.jpg" width="30px"><span>有米</span> 👍（3） 💬（1）<div>我认为有一种变更是不能做灰度的，比如修改计费逻辑，不可能说不同的用户不同的计费规则，肯定是一视同仁的。所以必须全部节点同时发布</div>2020-05-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg" width="30px"><span>安排</span> 👍（2） 💬（2）<div>路由策略怎么和后面的负载均衡连接起来的呢？有形象一点的结构图吗？每个服务集群前面是不是只有一台或一组实现负载均衡的设备？负载均衡设备是怎么区别对待同一个集群里面的新应用和旧应用的呢？</div>2020-03-11</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKhuGLVRYZibOTfMumk53Wn8Q0Rkg0o6DzTicbibCq42lWQoZ8lFeQvicaXuZa7dYsr9URMrtpXMVDDww/132" width="30px"><span>hello</span> 👍（1） 💬（1）<div>这篇文章给我做灰度有了新的思路，多谢老师！</div>2020-03-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/30/c1/2dde6700.jpg" width="30px"><span>密码123456</span> 👍（0） 💬（1）<div>这篇理论太强了，感觉实现起来会很难。有参考的开源框架实现吗？</div>2020-05-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/51/29/24739c58.jpg" width="30px"><span>凉人。</span> 👍（0） 💬（1）<div>感觉和iptables作用差不多</div>2020-04-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/13/45/16c60da2.jpg" width="30px"><span>蔫巴的小白菜</span> 👍（0） 💬（1）<div>以前做B端商城业务，我们就用了两套环境，prod与smallflow，每次上线前，都是把部分商品服务切换到smallflow上，运行一段时间，没问题了，在全面切换。。。</div>2020-04-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/4c/58/25152fa9.jpg" width="30px"><span>kevin</span> 👍（0） 💬（1）<div>通过版本号也可以控制，新服务使用不同的版本号，上线后两个版本都存在，控制部分调用方使用新版本的服务，这种方案可以达到灰度的效果，但是需要调用方配合，没有路由来的方便</div>2020-03-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ae/0c/f39f847a.jpg" width="30px"><span>D</span> 👍（0） 💬（3）<div>我们可以给所有的服务提供方节点都打上标签，用来区分新老应用节点。在服务调用方发生请求的时候，我们可以很容易地拿到请求参数，也就是我们例子中的商品 ID，我们可以根据注册中心下发的规则来判断当前商品 ID 的请求是过滤掉新应用还是老应用的节点。因为规则对所有的调用方都是一样的，从而保证对应同一个商品 ID 的请求要么是新应用的节点，要么是老应用的节点。



这段是什么意思，文稿能具体一点吗，看不太明白啊</div>2020-03-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/28/9c/73e76b19.jpg" width="30px"><span>姜戈</span> 👍（0） 💬（2）<div>在使用 RPC 的过程中，除了用路由策略实现过灰度发布、定点调用等功能，还用它完成：
熔断，限流，降级</div>2020-03-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（7） 💬（0）<div>路由策略——就是决定走那一条路的判断逻辑。
回忆之前的做法，主要有以下几种方式：
1：通过环境隔离，线上＋预发布＋压测，当然也有测试＋研发
2：服务别名路由，可以控制同机房调用或者流量直走某个分组
3：业务开关这个视具体情况而定，比如：用户黑白名单、四级地址维度切流、配送中心仓库维度切流、订单类型维度切流（大家电、中小件等）配送类型切流（自提、送货上门等）这个就比较灵活了，需要根据自身情况来用，当然，比较依赖配置管理中心，也会有代码逻辑冗余</div>2020-05-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0a/a4/828a431f.jpg" width="30px"><span>张申傲</span> 👍（3） 💬（0）<div>泳道隔离，同一个泳道内的服务在同一条调用链上</div>2021-01-29</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqZbpP8Of9zVURuTeTVSWByQOr64bkViaIVc9zWID20bsbSP1ibibxxR3uibf5Qib12TlZiaxgibPSujuhSg/132" width="30px"><span>Geek_85073c</span> 👍（0） 💬（0）<div>这部分后面讲的不太对，领域职责划分有问题，路由规则作为基础设施，不应该吃这么多业务逻辑。上线新应用也需要上下游同步评估改造，切流是业务层控制的，不是基建来管的。</div>2024-07-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/6b/b1/cc19deb4.jpg" width="30px"><span>邓延良</span> 👍（0） 💬（1）<div>老师，搞不清路由策略和负载均衡的区别，请老师讲解下</div>2021-05-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/26/a6/9e858024.jpg" width="30px"><span>仲卜</span> 👍（0） 💬（0）<div>这类路由、权重是不是交给服务发现系统去做更好，rpc 只是通过服务发现的插件取到 ip，ip的权重可以在注册中心开发给开发配置。</div>2021-05-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/f1/09/a597fe8d.jpg" width="30px"><span>西柚</span> 👍（0） 💬（1）<div>对于k8s编排的rpc服务，灰度是k8s来做的吗？
有点想不到是怎么实现的，服务提供者上线后注册到注册中心，调用方已经能从注册中心拉取到最新的服务，所以怎么来做灰度呢。。。是k8s把可用ip下发给注册中心，然后注册中心再推给调用方吗？那k8s还得知道注册中心的存在</div>2020-08-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/a7/90/9a0da433.jpg" width="30px"><span>小哇</span> 👍（0） 💬（0）<div>我们也可以使用用户的维度，让测试人员直接线上也定服务来测试功能</div>2020-03-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0f/bf/ee93c4cf.jpg" width="30px"><span>雨霖铃声声慢</span> 👍（0） 💬（2）<div>感觉这个路由策略也可以来做限流，现在服务请求量的峰值保障系统可用性。</div>2020-03-12</li><br/>
</ul>