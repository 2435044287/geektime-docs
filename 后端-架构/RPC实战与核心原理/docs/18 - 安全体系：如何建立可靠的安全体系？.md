你好，我是何小锋。上一讲我们学习了在RPC里面该如何提升单机资源的利用率，你要记住的关键点就一个，那就是“异步化”。调用方利用异步化机制实现并行调用多个服务，以缩短整个调用时间；而服务提供方则可以利用异步化把业务逻辑放到自定义线程池里面去执行，以提升单机的OPS。

回顾完上一讲的重点，我们就切入今天的主题，一起来看看RPC里面的安全问题。

## 为什么需要考虑安全问题？

说起安全问题，你可能会想到像SQL注入、XSS攻击等恶意攻击行为，还有就是相对更广义的安全，像网络安全、信息安全等，那在RPC里面我们说的安全一般指什么呢？

我们知道RPC是解决应用间互相通信的框架，而应用之间的远程调用过程一般不会暴露在公网，换句话讲就是说RPC一般用于解决内部应用之间的通信，而这个“内部”是指应用都部署在同一个大局域网内。相对于公网环境，局域网的隔离性更好，也就相对更安全，所以在RPC里面我们很少考虑像数据包篡改、请求伪造等恶意行为。

**那在RPC里面我们应该关心什么样的安全问题呢？**要搞清楚这个问题，我们可以先看一个完整的RPC应用流程。

我们一般是先由服务提供方定义好一个接口，并把这个接口的Jar包发布到私服上去，然后在项目中去实现这个接口，最后通过RPC提供的API把这个接口和其对应的实现类完成对外暴露，如果是Spring应用的话直接定义成一个Bean就好了。到这儿，服务提供方就完成了一个接口的对外发布了。
<div><strong>精选留言（16）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/15/f1/55/8ac4f169.jpg" width="30px"><span>陈国林</span> 👍（11） 💬（1）<div>可以从鉴权和授权2个方面来看（参考k8s）
1. 鉴权可以用 token 的方式，token鉴权应该是目前用的最多的一种认证方式
2. 授权可以用 RBAC 方式，类似k8s里面的 serviceAccount 和 role 和 roleBinding 等等</div>2020-04-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/34/9a/1587bc6f.jpg" width="30px"><span>JDY</span> 👍（10） 💬（1）<div>我突然觉得，rpc这东西好像跟k8s有点像，k8s是类似把一个大服务拆分成很多模块，完了之后来把这些微服务管理起来，而rpc是提供了一系列接口，通过网络的方式，让各个调用方去调用。不知道能不能这样比较，求老师指点。</div>2020-04-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/b2/e0/d856f5a4.jpg" width="30px"><span>余松</span> 👍（6） 💬（1）<div>简单总结一下。服务端提供的安全校验方式。
1.md5摘要校验（安全级别较低，服务端直接提供或者网关代劳）
2.非对称加密算法就行签名（RSA和老师提到的HMAC等算法，服务端直接提供或者网关代劳)
3.Oauth2授权（有单独的授权服务，四种模式任君选择）
</div>2020-04-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/f1/55/8ac4f169.jpg" width="30px"><span>陈国林</span> 👍（5） 💬（1）<div>老师，你在上文提到的HMAC来做认证，服务提供方是使用 “公钥” 验证服务调用方的签名串吗？那如果是这样的话，是要事先生成公私钥对吧</div>2020-04-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg" width="30px"><span>Darren</span> 👍（4） 💬（2）<div>我们之前是用的配置中心来存储对应的关系，B服务可以被那些服务调用或者不可以被那些服务调用，同时，也有B服务的接口权限，然后内部网关同步相关信息，保存到内存缓存中，当调用方请求经过网管时，获取调用方，服务方，服务方具体的接口，然后去校验相关的信息，判断是否可以放行，我们的鉴权没有放在服务方本身去实现，是在网关实现的，请老师指点</div>2020-04-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/66/9b/59776420.jpg" width="30px"><span>百威</span> 👍（3） 💬（1）<div>这种授权方式，对于调用方而言，加密后的签名怎么维护呢，感觉有代码侵入呀</div>2020-04-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c7/88/a2e42dc8.jpg" width="30px"><span>波波</span> 👍（2） 💬（1）<div>老师，RPC可以用于公网通信吗？鉴权放在服务端对服务端的压力是不是也挺大的？</div>2020-04-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0f/bf/ee93c4cf.jpg" width="30px"><span>雨霖铃声声慢</span> 👍（2） 💬（1）<div>首先肯定是在服务端做，其次是应该在每一个服务提供端对其接口做权限审核，假如一个服务端提供10个接口出来，5个可以被A调用，另外5个不能被A服务调用，那么就应该有个配置文件配置这调用端和服务端各个接口的权限配置信息，这个权限配置应该放在配置中心，然后每个服务端会动态获取配置信息根据配置信息来决定是否拒绝服务。对于新增的调用服务，它需要先申请权限，然后服务端提供方修改配置文件对其提供服务。</div>2020-04-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/ce/2b/dee4b7c8.jpg" width="30px"><span>Raymond</span> 👍（1） 💬（1）<div>老师，请问服务提供方对服务调用方的授权认证后，已认证的状态应该存在服务提供端本地吧，那服务端集群中各个节点之间怎么共享同一个服务调用方应用的认证状态呢？还是说每次调用到不同的的服务提供方节点都需要从新进行鉴权？或者说是服务调用方在获取到服务提供方的IP列表后统一进行一次遍历的授权认证？请老师帮助解惑。</div>2020-05-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/54/da/e2e5ddf7.jpg" width="30px"><span>2102</span> 👍（1） 💬（1）<div>权限控制应放在服务提供方，权限控制规则可以放到单独管理节点，服务启动的时候从管理节点获取规则，权限规则变更后下发到服务节点。</div>2020-04-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（1） 💬（1）<div>在进行接口授权的同时也进行接口方法的授权</div>2020-04-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（11） 💬（2）<div>前面讲的调用方之间的安全问题，我们更多只是解决认证问题，并没有解决权限问题。在现实开发过程中，一个 RPC 接口定义里面一般会包含多个方法，但我们目前只是解决了你能不能调用接口的问题，并没有解决你能调用我接口里面的哪些方法。像这种问题，你有什么好方案吗？

这节讲的容易消化，老师提的问题，我之前在JD的时候也恰好实现过一个解决方案，我们组做过一个POP的订单中间件功能，提供的服务为了防止未知系统任意调用，在我们的那套系统里做了一个服务调用管理功能，就是到方法级。
1：我们提供服务调用的申请模板，描述那个系统，那个应用，调用我们那个服务的那个方法，调用量多少，调用应用负责人是谁，对接研发谁，还有别的配置信息
2：我们会把调用配置信息落库，然后放入缓存，使用调用者信息及我们提供服务的信息组成key，放入redis
3：在调用方调用我们的时候，去做拦截和鉴权
4：j-one统一部署平台中有系统和应用的唯一标识信息，这些信息在调用接口时作为入参的一部分，就能实现细粒度到方法基本的控制了

另外，就是使用token的方式，这种方式应用的就更多了，也是申请时分发，其实本质是一样的就看对应的配置信息存储在哪里啦！</div>2020-05-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/22/f4/9fd6f8f0.jpg" width="30px"><span>核桃</span> 👍（1） 💬（0）<div>在hadoop生态圈里面，有一个叫kerberos的东西，提供了安全认证和授权的，但是这玩意太重了。可以实现双向的认证，包括客户端和服务端。因为像https服务，一般是不验证客户端的。而实现原理是非对称加密，有一个票据中心，这个中心把服务端给的公钥信息加密，还有中心的认证加密信息一起发给客户端，让客户端在发起请求的时候带上给服务端。服务端接受到以后到票据中心认证一下。

但是这种方式，容易出现票据过期的情况，需要定时更新票据，也就是续约。而且这套服务太重了。未来可能会有其他方案来代替调。</div>2022-02-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/07/d2/0d7ee298.jpg" width="30px"><span>惘 闻</span> 👍（1） 💬（0）<div>一个接口只允许有一个应用发布提供者，避免其它应用也能发布这个接口。
这句话里的一个应用是什么意思啊,一个ip端口加应用id吗?  那一个接口只有一个服务能支撑大流量业务吗?
如果只针对应用id,那么伪装者也可以伪装这个应用id吧?</div>2021-02-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/0a/7d/ac715471.jpg" width="30px"><span>独孤九剑</span> 👍（0） 💬（0）<div>可以借鉴OAuth2的授权码策略</div>2021-07-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/00/4e/be2b206b.jpg" width="30px"><span>吴小智</span> 👍（0） 💬（0）<div>想问老师，如果有暴露到公网的 RPC Server，有哪些安全方案可以采取？</div>2020-09-06</li><br/>
</ul>