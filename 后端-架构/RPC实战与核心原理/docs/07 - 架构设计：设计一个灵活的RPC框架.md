你好，我是何小锋。到今天为止，基础篇的知识我们就全部学习完了，接下来我们进入进阶篇。

在基础篇里面，我们讲了RPC的通信原理以及RPC里各个功能组件的作用，不妨用一段话再次回顾下：“其实RPC就是把拦截到的方法参数，转成可以在网络中传输的二进制，并保证在服务提供方能正确地还原出语义，最终实现像调用本地一样地调用远程的目的。”**你记住了吗？**

那学到这儿，距离实现一个灵活的RPC框架其实还是有距离的。知道了各个功能组件只是迈出了第一步，接下来你必须要清楚各个组件之间是怎么完成数据交互的，这也是今天这讲的重点，我们一起搞清楚RPC的架构设计。

## RPC架构

说起架构设计，我相信你一定不陌生。我理解的架构设计呢，就是从顶层角度出发，厘清各模块组件之间数据交互的流程，让我们对系统有一个整体的宏观认识。我们先看看RPC里面都有哪些功能模块。

我们讲过，RPC本质上就是一个远程调用，那肯定就需要通过网络来传输数据。虽然传输协议可以有多种选择，但考虑到可靠性的话，我们一般默认采用TCP协议。为了屏蔽网络传输的复杂性，我们需要封装一个单独的数据传输模块用来收发二进制数据，这个单独模块我们可以叫做传输模块。

用户请求的时候是基于方法调用，方法出入参数都是对象数据，对象是肯定没法直接在网络中传输的，我们需要提前把它转成可传输的二进制，这就是我们说的序列化过程。但只是把方法调用参数的二进制数据传输到服务提供方是不够的，我们需要在方法调用参数的二进制数据后面增加“断句”符号来分隔出不同的请求，在两个“断句”符号中间放的内容就是我们请求的二进制数据，这个过程我们叫做协议封装。
<div><strong>精选留言（25）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/48/f3/65c7e3ef.jpg" width="30px"><span>cricket1981</span> 👍（21） 💬（4）<div>如何实现按需加载的SPI? </div>2020-03-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7b/98/8f1aecf4.jpg" width="30px"><span>楼下小黑哥</span> 👍（15） 💬（3）<div>我们系统中有个路由模块，可以分发交易到指定交易渠道。新接入的模块，只需要接入规定的接口，就能被路由模块识别到。
我觉得这也是类似于插件化开发，每次新接入交易渠道，路由模块都是无需重启。</div>2020-03-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（7） 💬（2）<div>这篇感觉很棒，高屋建瓴，一个完整的RPC架构设计图就出来了。每个部分具体怎么实现就因人因公司而异了，不过也是见证功力的地方，目前在研究thrift，感觉很有帮助。</div>2020-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e1/19/c756aaed.jpg" width="30px"><span>鸠摩智</span> 👍（1） 💬（1）<div>阿里开源的datax也用到了插件的设计</div>2020-04-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/10/90/807689c3.jpg" width="30px"><span>Geek_9ius3m</span> 👍（1） 💬（1）<div>我是个小测试。使用jmeter进行压力测试。jmeter官网中支持进行定制sampler取样器，写好的jar包放在lib\ext下，再启动jmter时就能看到了。不知道这算不算插件化开发</div>2020-03-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/20/08/bc06bc69.jpg" width="30px"><span>Dovelol</span> 👍（1） 💬（1）<div>还有spring的spring.factories这一套也是利用的面向接口编程的思想吧，感觉这个比jdk自带的spi也好很多，既然有些问题，那为啥jdk的spi不优化一下呢？</div>2020-03-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/48/20/f1898740.jpg" width="30px"><span>凹凸</span> 👍（1） 💬（1）<div>插件功能目前在我的产品中任务引擎也是通过spi和spring注入两种方式，确实做不到按需加载，这个可以优化下。</div>2020-03-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0f/bf/ee93c4cf.jpg" width="30px"><span>雨霖铃声声慢</span> 👍（1） 💬（1）<div>看到这个问题首先想到的是用过的一些框架工具的中间件结构，这些中间件应该也是插件的一种，比如django的middleware和ror的各种gem包，都可以给框架提供强大的扩展功能。</div>2020-03-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/20/08/bc06bc69.jpg" width="30px"><span>Dovelol</span> 👍（0） 💬（1）<div>老师好，想问下用jdk自带spi一般会有一个接口加载很多实现类的情况吗，因为只能用迭代器遍历，导致只能用类型判断才能找到自己想要的类，这样感觉不够优雅吧，所以我感觉应该都是一个接口配置一个实现类这样就是使用者想要的情况了</div>2020-03-11</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Gswh7ibY4tubXhp0BXOmV2pXZ3XsXic1d942ZMAEgWrRSF99bDskOTsG1g172ibORXxSCWTn9HWUX5vSSUVWU5I4A/132" width="30px"><span>奔奔奔跑</span> 👍（0） 💬（1）<div>太好了，这章内容！请问老师我可以对照这张内容和RPC微内核架构图去阅读gRPC的源码吗？我想从源码中学习收获一定非常大！</div>2020-03-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/49/2c/a2a948b6.jpg" width="30px"><span>艾斯曼</span> 👍（0） 💬（2）<div>目前工作是为工业设备联网数据采集，设备种类和型号繁多，产品中通过抽象出一套“驱动”的概念，把每类设备当作一个插件开发，整体产品架构不变，感觉有点这个概念。只是产品还不够大，其他插件体系还不够明确。</div>2020-03-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/3a/27/5d218272.jpg" width="30px"><span>八台上</span> 👍（58） 💬（6）<div>这个文章没有做到插件化～  与接口的实现（Java）耦合严重， 其他语言版本的无机可乘～</div>2021-03-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg" width="30px"><span>Darren</span> 👍（8） 💬（0）<div>插件功能都可以通过类似链式调用的方式实现，可以全量加载，但按需激活，不管是condition还是SPI，然后把所有激活的保存在List中，然后执行的时候，通过链式的形式调用</div>2020-03-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/0a/7d/ac715471.jpg" width="30px"><span>独孤九剑</span> 👍（6） 💬（1）<div>架构模式三板斧：分层+分割+分布式，节点间通过RPC框架和分布式锁等机制进行协作。</div>2021-07-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/4b/d7/f46c6dfd.jpg" width="30px"><span>William Ning</span> 👍（5） 💬（0）<div>完全避开的非java同学的问题</div>2022-01-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f3/a0/a693e561.jpg" width="30px"><span>魔曦</span> 👍（4） 💬（1）<div>这篇文章的设计思路很独特，按需加载，请问有按需加载的demo，配合demo跟有意义</div>2020-03-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2c/6b/6c/3e80afaf.jpg" width="30px"><span>HappyHasson</span> 👍（2） 💬（0）<div>读完这篇文章我知道了RPC设计要插件化，但是怎么做插件化呢？我一无所知。感觉文章这么设计优点舍本逐末。</div>2023-07-03</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epKJlW7sqts2ZbPuhMbseTAdvHWnrc4ficAeSZyKibkvn6qyxflPrkKKU3mH6XCNmYvDg11tB6y0pxg/132" width="30px"><span>pc</span> 👍（2） 💬（0）<div>完全没理解到底怎么实现插件的，或者有什么方式去实现插件的
</div>2022-11-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg" width="30px"><span>QQ怪</span> 👍（1） 💬（0）<div>想问下老师idea里面的插件是什么思想，但是现在的版本需要重启idea才能生效，但新的版本听说是不用重启就可以生效，想知道新技术是什么？</div>2020-05-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/e5/10/0a94311f.jpg" width="30px"><span>joker</span> 👍（1） 💬（1）<div>老师，您好。关于您说的那个基于插件的微内核设计架构，我有几点不理解的地方：
1.这里的插件定义似乎和我理解的不一样：拿idea来举例，它有很丰富的插件系统，可以通过实现它设计的插件接口就可以丰富idea的功能，我理解它的插件接口应该是统一的吧。所以我理解插件应该是使用同一套接口，然后有多种不同的实现，插件之间是相互独立的，它们是可以共存的。不知我的理解是否正确
2.但是在我们这边的微内核架构中，同一个插件实际上只能有一个存在，也就是说同一个模块同一时间只能有一个实现在运行。这个也能称之为插件吗？感觉是定义了一套接口，大家可以提供不同实现，然后根据业务需求加载不同的实现
3.文中说到的按需加载，我不是很理解，这里如果要实现按需加载，是我们通过配置文件的形式指定当前要加载哪一个实现吗？也就是说需要重启服务才能激活新加载的实现，对吗？</div>2020-05-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/7b/ae/66ae403d.jpg" width="30px"><span>熊猫</span> 👍（0） 💬（0）<div>老师，你好，有没有开源插件开发做的好的项目？看看怎么实现的</div>2022-10-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e5/a1/74259971.jpg" width="30px"><span>李逍遥</span> 👍（0） 💬（0）<div>这算是模板方法设计模式的提现么？</div>2022-08-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6c/ea/ce9854a5.jpg" width="30px"><span>坤</span> 👍（0） 💬（0）<div>WebHook机制算是插件机制的使用吗？</div>2020-08-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/e9/86/d34800a4.jpg" width="30px"><span>heyman</span> 👍（0） 💬（1）<div>设计好了编码格式：带有头部，头部指定payload长度。那是不是就不需要“断句”符号了呢？</div>2020-07-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/dd/50/21eb5d76.jpg" width="30px"><span>三叶泷</span> 👍（0） 💬（0）<div>在web 前后端分离的项目中，我们自定义了一套UI插件，通过后端下发规则控制显示，后端开发只需定义好显示规则即可，应该也是一种插件化开发吧。</div>2020-03-30</li><br/>
</ul>