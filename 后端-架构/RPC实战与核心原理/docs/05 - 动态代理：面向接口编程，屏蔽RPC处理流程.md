你好，我是何小锋。上一讲我分享了网络通信，其实要理解起来也很简单，RPC 是用来解决两个应用之间的通信，而网络则是两台机器之间的“桥梁”，只有架好了桥梁，我们才能把请求数据从一端传输另外一端。其实关于网络通信，你只要记住一个关键字就行了——可靠的传输。

那么接着上一讲的内容，我们再来聊聊动态代理在 RPC 里面的应用。

如果我问你，你知道动态代理吗？ 你可能会如数家珍般地告诉我动态代理的作用以及好处。那我现在接着问你，你在项目中用过动态代理吗？这时候可能有些人就会犹豫了。那我再换一个方式问你，你在项目中有实现过统一拦截的功能吗？比如授权认证、性能统计等等。你可能立马就会想到，我实现过呀，并且我知道可以用 Spring 的 AOP 功能来实现。

没错，进一步再想，在 Spring AOP 里面我们是怎么实现统一拦截的效果呢？并且是在我们不需要改动原有代码的前提下，还能实现非业务逻辑跟业务逻辑的解耦。这里的核心就是采用动态代理技术，通过对字节码进行增强，在方法调用的时候进行拦截，以便于在方法调用前后，增加我们需要的额外处理逻辑。

那话说回来，动态代理跟 RPC 又有什么关系呢？

## 远程调用的魔法

我说个具体的场景，你可能就明白了。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/0f/bf/ee93c4cf.jpg" width="30px"><span>雨霖铃声声慢</span> 👍（35） 💬（2）<div>如果没有动态代理帮我们完成方法调用拦截，那么就需要使用静态代理来实现，就需要用户对原始类中所有的方法都重新实现一遍，并且为每个方法附加相似的代码逻辑，如果在RPC中，这种需要代理的类有很多个，就需要针对每个类都创建一个代理类。</div>2020-03-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7b/98/8f1aecf4.jpg" width="30px"><span>楼下小黑哥</span> 👍（15） 💬（1）<div>没有动态代理的情况下，最简单的情况，
服务消费者将类信息序列化---》按照协议拼接报文----》调用网络程序发送报文----》收到提供者返回信息----》根据协议解析出返回信息-----》再反序列化成返回结果。
上面每一步都挺复杂的，RPC 框架使用动态代理帮我们屏蔽这种细节。

</div>2020-03-06</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKhuGLVRYZibOTfMumk53Wn8Q0Rkg0o6DzTicbibCq42lWQoZ8lFeQvicaXuZa7dYsr9URMrtpXMVDDww/132" width="30px"><span>hello</span> 👍（14） 💬（1）<div>Byte Buddy，老师这个后起之秀，是怎么完成动态代理的，能否剖析下，多谢！</div>2020-02-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f2/62/f873cd8f.jpg" width="30px"><span>tongmin_tsai</span> 👍（5） 💬（1）<div>老师，可以理解为，动态代理生成的类，就是stub吗？</div>2020-04-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/ca/82/85f6a1a2.jpg" width="30px"><span>番茄炒西红柿</span> 👍（3） 💬（1）<div>为什么不用静态代理？aspectJ之类的。提前把代理类在编译的时候创建？</div>2020-04-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/da/36/ac0ff6a7.jpg" width="30px"><span>wusiration</span> 👍（3） 💬（4）<div>如果没有动态代理完成方法拦截，那么被调用方需要有调用方的接口实现，就失去了面向接口编程的意义</div>2020-02-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg" width="30px"><span>每天晒白牙</span> 👍（3） 💬（3）<div>如果没有动态代理类帮我们完成方法调用拦截，需要用户自己加入远程调用的逻辑，这样就麻烦，且使用不方便了</div>2020-02-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/c2/fe/038a076e.jpg" width="30px"><span>阿卧</span> 👍（2） 💬（1）<div>从动态代理的原理和特点出发。动态代理帮我们生成代理类，屏蔽具体实现细节，在代理方法前实现统一封装。
如果没有动态代理，就需要手动实现每个接口类的远程调用细节了。
被面试官问到这个问题，没有回答上来...</div>2020-03-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/ef/27/c48a8fb6.jpg" width="30px"><span>Json Dumps</span> 👍（2） 💬（1）<div>看到过，GRPC，通过proto接口，生成了客户端静态代理代码。
与动态代理相比，接口变化除了更新接口文件，还要重新生成静态代理代码，并更新。
为什么非要动态代理呢？优点是什么？</div>2020-03-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/3b/47/f6c772a1.jpg" width="30px"><span>Jackey</span> 👍（2） 💬（1）<div>动态代理真是个神奇的技术，没有它的话用户就得自己写远程调用的实现了。
ps：SpringAOP也无从谈起了</div>2020-03-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c5/6a/7f858f1f.jpg" width="30px"><span>白不吃</span> 👍（0） 💬（6）<div>很难想象去年4月份就有人指出的单词错误，到现在还没修正</div>2022-02-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a6/56/abb7bfe3.jpg" width="30px"><span>云韵</span> 👍（0） 💬（2）<div>何老师，可不可以提供一下本节的代码，ClassLoaderUtils这个类找不到，想自己debug一下流程</div>2020-04-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/22/2d/b3b9aaf4.jpg" width="30px"><span>小兜</span> 👍（0） 💬（1）<div>如果没有动态代理，我们就需要自己手动的实现调用，使开发不能只关注业务了。</div>2020-04-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/04/fb/40f298bb.jpg" width="30px"><span>小罗希冀</span> 👍（0） 💬（1）<div>如果没有代理完成方法的调用拦截的话，那么业务代码会跟调用、解析RPC请求的代码耦合在一起</div>2020-03-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/01/37/12e4c9c9.jpg" width="30px"><span>高源</span> 👍（0） 💬（1）<div>请教老师，例如算法和开源框架源代码，你是如何学习深入理解的，毕竟我的想法自己能够灵活运用，个人能力有限的</div>2020-02-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/53/ae/26faa892.jpg" width="30px"><span>邵邵</span> 👍（123） 💬（14）<div>这一节RPC讲解重度依赖java知识，希望老师在后续的文章中多提炼一些跨语言层面的原理，或者用一些伪代码的方式讲解，谢谢</div>2020-03-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg" width="30px"><span>李玥</span> 👍（101） 💬（12）<div>我在工作中有幸看了不少小锋老师的代码，京东很多的基础类库中，都有小峰老师的代码。从中学到了很多。包括文章中提到的对调用方尽量屏蔽实现细节的思想，以及通过定义扩展点来剥离实现等等。</div>2020-02-29</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epY2JtiahsBz4LK1k00DbYoR2Zk56wnYaoBfP63v5X3Xu1kuH1ethAnMOMu6vT9eKQSqHqn3HrTK9Q/132" width="30px"><span>Geek_7d1d6d</span> 👍（54） 💬（0）<div>感觉这节课的通用型不好，语言选型太侧重java，以后能不能使用伪代码讲流程呢？非常感谢老师</div>2020-03-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/3a/df/ea0fc831.jpg" width="30px"><span>周天航</span> 👍（24） 💬（1）<div>这个文章的名字应该叫《Java 中使用rpc和原理》</div>2021-07-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/03/5b/3cdbc9fa.jpg" width="30px"><span>宁悦</span> 👍（7） 💬（0）<div>补充一个动态代理实现RPC的简单例子，可以辅助理解。例子来源于隔壁王争老师的《设计模式之美》专栏。
https:&#47;&#47;github.com&#47;wangzheng0822&#47;codedesign&#47;tree&#47;master&#47;com&#47;xzg&#47;cd&#47;rpc</div>2020-06-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/81/0e/ec667c01.jpg" width="30px"><span>Wallace Pang</span> 👍（6） 💬（0）<div>其实在 Java 领域，除了 JDK 默认的 nvocationHandler 能完成代理功能，应该是InvocationHandler</div>2020-06-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/03/5b/3cdbc9fa.jpg" width="30px"><span>宁悦</span> 👍（6） 💬（4）<div>我的jdk版本中找不到ClassLoaderUtils这个类，只能找到ClassLoader这个类，发现用下面的代码也能实现老师文中的例子。
 ClassLoader classLoader = ClassLoader.getSystemClassLoader();</div>2020-06-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（5） 💬（0）<div>请你设想一下，如果没有动态代理帮我们完成方法调用拦截，用户该怎么完成 RPC 调用？
1：使用静态代理实现
2：远程调度的代码和业务处理逻辑写在一块，序列化、编码、网络建连、网络传输、网络断连、以及负载均衡、失败重试等等都需要写出来，这块大家都重复造轮子，上线一个RPC调用功能现在是一天之后可能是一个月

代理模式我觉得很神奇，尤其是动态代理，真像魔法一样，许多代码你看不到不是因为他不存在而是她隐藏了起来，在代码运行的时候才出现，但是计算机不可能平白无故的运行的，你不告诉它怎么运行它是不知道怎么走的。</div>2020-05-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cb/44/22d65cf1.jpg" width="30px"><span>winy</span> 👍（4） 💬（1）<div>1.静态代理的效率是远高于动态代理的
2.类似于lombok我们可以用注解处理器现实静态代理
3.因为是编译时生成的字节码，调试的时候方法间调用逻辑更简单清晰

所以我一直不明白为什么大家都用动态代理，很多框架组合起来用一层层代理下去，在调试的时候真的令人头大2333</div>2020-06-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c6/cb/c7541d52.jpg" width="30px"><span>cwfighter</span> 👍（4） 💬（0）<div>不太明白为啥要用运行时动态生成这么损耗性能的方式，在c&#47;c++里面都是autogen自动生成框架代码以及对应的stub调用封装，业务也不需要关心rpc调用，这种静态的方式不是更好？</div>2020-06-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/1b/be/525e05ae.jpg" width="30px"><span>NiceBlueChai</span> 👍（2） 💬（0）<div>本来以为讲rpc的，你来了个Java和AOP，太具体了，能抽象一点吗</div>2022-11-20</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIQMh5jMlvAibnTgiaVXmsb333JBjpdvLVcptc232zQey5wkBOEPiauepQpv8UlRcOFqnTyhEQiadaHMA/132" width="30px"><span>winfield</span> 👍（2） 💬（1）<div>我呆的两家大厂，目前都是用静态代理，每个 rpc 的客户端都要生成代码</div>2021-02-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/82/3d/356fc3d6.jpg" width="30px"><span>忆水寒</span> 👍（2） 💬（1）<div>其实也是看需求的。如果没有动态代理，那么调用双方可以通过定义一套消息id和消息结构（才有protobuf定义），也是可以完成远程调用的。</div>2020-03-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/48/f3/65c7e3ef.jpg" width="30px"><span>cricket1981</span> 👍（2） 💬（0）<div>没有动态代理的话就只能用静态代理了</div>2020-03-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2c/6b/6c/3e80afaf.jpg" width="30px"><span>HappyHasson</span> 👍（1） 💬（0）<div>看完这篇文章，我的第一件事是去查了一下Java的AOP原理，它到底相当于我用的C++和Go中的什么内容。我觉得这种学习方式很慢。所以感觉老师应该站在更高的层次去讲解这个概念，不应该依赖具体语言的具体实现。</div>2023-07-02</li><br/>
</ul>