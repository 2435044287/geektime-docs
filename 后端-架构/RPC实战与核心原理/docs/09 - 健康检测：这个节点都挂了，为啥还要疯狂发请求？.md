你好，我是何小锋。上一讲我们介绍了超大规模集群“服务发现”的挑战，服务发现的作用就是实时感知集群IP的变化，实现接口跟服务集群节点IP的映射。在超大规模集群实战中，我们更多需要考虑的是保证最终一致性。其实总结来说，就一关键词，你要记住“推拉结合，以拉为准”。接着昨天的内容，我们再来聊聊RPC中的健康检测。

因为有了集群，所以每次发请求前，RPC框架会根据路由和负载均衡算法选择一个具体的IP地址。为了保证请求成功，我们就需要确保每次选择出来的IP对应的连接是健康的，这个逻辑你应该理解。

但你也知道，调用方跟服务集群节点之间的网络状况是瞬息万变的，两者之间可能会出现闪断或者网络设备损坏等情况，那怎么保证选择出来的连接一定是可用的呢？

从我的角度看，**终极的解决方案是让调用方实时感知到节点的状态变化**，这样他们才能做出正确的选择。这个道理像我们开车一样，车有各种各样的零件，我们不可能在开车之前先去挨个检查下他们的健康情况，转而是应该有一套反馈机制，比如今天我的大灯坏了，那中控台就可以给我提示；明天我的胎压不够了，中控台也能够收到提示。汽车中大部分关键零件的状态变化，我作为调用方，都能够第一时间了解。

那回到RPC框架里，我们应该怎么设计这套机制呢？你可以先停下来想想汽车的例子，看看他们是怎么做的。当然，回到我们RPC的框架里，这事用专业一点的词来说就是服务的健康检测。今天我们就来详细聊聊这个话题。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/7b/98/8f1aecf4.jpg" width="30px"><span>楼下小黑哥</span> 👍（47） 💬（3）<div>以前做过类似健康检查。
我们有个服务，需要通过银行安装在我们后台软件向银行分发交易。这个软件我们在使用过程发现会无故挂掉，为了能及时检测这种情况。
我通过 openresty 写了一个小插件、通过 http 接口访问银行软件，查看银行软件是否挂了。然后接入 钉钉 webhook，触发机器人报警。
这个健康检查啊我有个特别深刻记忆。由于当时是将 openresty 跟银行软件部署在同一台物理机器上去。某一天，整台机器挂了，报警机制当然也失效了。
通过这件事，我现在每次部署服务时，会注意将服务部署在不同物理机器上，防止意外发生。</div>2020-03-11</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJiaiaQYkUHByDARl4ULduH8Y4hicOpMxGjzPZmJkXK9RYd1oVMICd0icCfarxI4Yvmiap2a8t3Eae3LMg/132" width="30px"><span>etdick</span> 👍（29） 💬（2）<div>成功次数&#47;调用总次数，建议加上总次数阀值。如果2次，一次成功，一次失败，就可能误判。例如调用总数&gt;10次以上，成次数&#47;调用次数&lt;50%，才比较准确</div>2020-03-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f3/a0/a693e561.jpg" width="30px"><span>魔曦</span> 👍（16） 💬（3）<div>心跳检测需要分两个纬度，一个机器本身的，一个是应用，单纬度肯定会出问题</div>2020-03-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg" width="30px"><span>Darren</span> 👍（13） 💬（1）<div>之前使用过返回状态保存在MQ中，有专门的消费者去消费消息，其中要是失败率大于阈值，直接调用注册中心，下线该服务，同时使用agent机制，自动重启有问题的服务，之后要是还会出现失败，则报警发出，人工介入。</div>2020-03-17</li><br/><li><img src="" width="30px"><span>嘻嘻</span> 👍（7） 💬（2）<div>老师，几个问题:
1.上面说的基于失败率统计的方案，不就是熔断吗？
2.心跳检测，这个从调用方发心跳到服务方，会不会太重，基于熔断是不是就可以了
3.后面又说心跳检测可以放在多台机器去综合判断，刚刚不是说由调用方发起心跳吗？又变成第三方心跳检测了？
我理解这里有注册中心做心跳，再加熔断，失败重试等就可以了，不知道对不对</div>2020-04-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（3） 💬（5）<div>老师我认为心跳检测不应该接口的调用方来检测，这样的话调用接口的客户端量很大时，只是心跳检测就会把服务提供方的资源打满，而且当接口服务提供方很多时，客户端每个ip去健康检测也是不可能的</div>2020-03-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/69/cc/747c7629.jpg" width="30px"><span>🌀Pick Monster 🌀</span> 👍（3） 💬（1）<div>老师，内容看明白了，可用率这个指标具体怎么实现呢？因为一般使用RPC框架都是三方框架，我们是需要自己对三方接口进行重新实现吗？</div>2020-03-09</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKYLPAlGUWic4yAqsGtEYBSRR7gDjyg9yiaJicNhMwiaNw4rMKQ5DHTfp7gmic0gpqEwCZaou8G6CdHKCg/132" width="30px"><span>ant</span> 👍（2） 💬（1）<div>心跳检测，单一纬度的标准始终差点意思。还是要结合业务场景，多维度判断，来保证结果准确性。例如 连续失败是最直接的纬度，可以综合考虑变更为 单位时间内失败次数，或单位次数的成功率</div>2020-04-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg" width="30px"><span>每天晒白牙</span> 👍（2） 💬（2）<div>想请教老师，RPC 框架的心跳检测怎么做的呢？只听说过心跳检测这个概念，但在代码层面如何做，没有概念。看到老师在最后提到检测应用是否可用，可以在应用实例中开一个 url 供检测程序发 http 请求检测。但非应用级别的心跳检测也是这样做的吗？</div>2020-03-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8c/9c/d48473ab.jpg" width="30px"><span>dancer</span> 👍（1） 💬（1）<div>有一个地方没想明白，希望老师能解答一下。如果在多个机房部房部署探活程序，如果部分检测有问题 部分检测没有问题，这个状态需要怎么判断，又该怎样同步给所有探活程序？</div>2020-04-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/55/f2/ba68d931.jpg" width="30px"><span>有米</span> 👍（0） 💬（1）<div>你以为别人挂了其实是自己挂了😢</div>2020-05-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0f/bf/ee93c4cf.jpg" width="30px"><span>雨霖铃声声慢</span> 👍（0） 💬（1）<div>看完这篇文章的感触是健康检查这套逻辑需要业务和运维的配合实现，业务要提供heath check的endpoint，运维要调用这个endpoint来查看服务的情况，所以在进一步，一些通用的框架会自动集成health check的功能并可以通过配置打开，当新服务上线的时候，监控检查功能会自动提供。</div>2020-03-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/17/39/3274257b.jpg" width="30px"><span>ple</span> 👍（0） 💬（1）<div>想问下。心跳检测文中说是调用方定时去看看提供方是否存活。但是平常好像不是这么做的，会有一台专门做健康检查的机器定时去调用健康检查接口，是说这两种方式都是可以的么  觉得第一种会不会做起来成本比较高？</div>2020-03-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/58/a7/7c972eb1.jpg" width="30px"><span>jiemoon</span> 👍（0） 💬（2）<div>健康检测是不是也要检测自己</div>2020-03-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/ab/72/91c9853e.jpg" width="30px"><span>Reason</span> 👍（0） 💬（1）<div>接触的印象最深刻的检测机制是spring boot actuator的health端点了。有个问题没太理解请老师解惑，文末说检测程序可以分机房机架部署，检测程序是单独rpc框架的一套程序么？我理解一般是在rpc框架里的一个线程，不知道理解的对不？</div>2020-03-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/82/3d/356fc3d6.jpg" width="30px"><span>忆水寒</span> 👍（0） 💬（1）<div>老师，我想问一下 应用程序僵住了，但是连接还在。这种情况是不是靠心跳超时 来判断是否需要移动到不正常状态。</div>2020-03-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/01/37/12e4c9c9.jpg" width="30px"><span>高源</span> 👍（0） 💬（3）<div>老师我遇到一个棘手的问题，服务端win，客户端嵌入式Linux，之间socket通信，服务端有心跳检测，最近发现现象就是例如第一天服务端从早上8点启动然后客户端连接服务端大概10多个开始跑业务运行到下午17点，这时候呢电源关闭所有客户端与服务端断开，但不是正常关闭的，服务端检测不到客户端心跳，讲所有客户端已经连接关闭socket，服务端继续运行到第二天的8点，客户端又连服务端，出现了客户端反映能连接服务端，但是给服务端发数据包服务端没响应，这个时候我把所有客户端断开，只保留一个客户端，再重新连接服务端，还是刚才现象，排查服务端没有异常日志，但是细查发现服务端连记录客户端连接日志都没有，服务端进程和线程运行着通过工具检测。如果将服务端重启一下现象马上消失，所有客户端全部正常跑一整天没问题。这个现象只有服务端长时间开着从不关闭服务端程序才能有这个现象发生，并且客户端不正常关闭连接，强制关闭电源。请教老师如何排查，因为服务端没有异常日志，现在定位服务端监听客户端连接部分，但没有异常，日志也没记录哪个客户端访问上来。但是定位肯定是服务端问题。怎么排查，谢谢</div>2020-03-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/c2/fe/038a076e.jpg" width="30px"><span>阿卧</span> 👍（8） 💬（0）<div>健康检测：调用方向服务方发送心跳检测，如果超过3次（阈值可以设置）未响应则认为服务节点挂掉。
会存在的遇到的问题
1. 服务方会出现心跳正常响应，但是服务间歇性响应超时（亚健康状态），会导致调用方误判；可以用可用率的思路来解决。
2. 调用方心跳机制出现问题，导致误判服务方挂掉；可以用调用方集群部署，其中一台调用显示正常则认为正常的办法来减少误判。
Dubbo通过IdleStateHandler设置定时任务，服务空闲发送心跳，实现健康检测
http:&#47;&#47;dubbo.apache.org&#47;zh-cn&#47;blog&#47;dubbo-heartbeat-design.html
</div>2020-03-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg" width="30px"><span>Jxin</span> 👍（5） 💬（0）<div>个人见解：心跳检测存在滞后性,只能作为辅助手段。高并发场景，优先靠负载均衡来保证节点负载稳定。</div>2020-10-12</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epKJlW7sqts2ZbPuhMbseTAdvHWnrc4ficAeSZyKibkvn6qyxflPrkKKU3mH6XCNmYvDg11tB6y0pxg/132" width="30px"><span>pc</span> 👍（1） 💬（0）<div>有一个很大的问题，除了总结那里说用检测系统做健康检测，其他地方都说是调用者和服务方两者做保活之类的机制。这不是很合理吧？假设100个调用者节点、100个服务方节点，这中间就要有多少pingpong了？应该是服务发现去对服务方进行健康检测吧？</div>2022-11-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/06/7e/735968e2.jpg" width="30px"><span>西门吹牛</span> 👍（1） 💬（1）<div>是不是也可以采用分布式共识算法，比如Raft，来解决心跳间隙性失败带来的健康误判问题。</div>2021-05-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/f2/f5/b82f410d.jpg" width="30px"><span>Unknown element</span> 👍（0） 💬（0）<div>“根据我的经验，有一个办法可以减少误判的几率，那就是把检测程序部署在多个机器里面，分布在不同的机架，甚至不同的机房”
老师问下这里是说把健康检测从调用方分离出去，由另一个集群去做吗？那调用方想获取检测的结果是不是又要考虑检测程序所在集群的健康情况？感觉成套娃了....</div>2022-10-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/63/be6db73e.jpg" width="30px"><span>周文童</span> 👍（0） 💬（0）<div>学习了。健康检查要考虑这么多点，关键在于如何减少误判。如何界定轮询请求的阈值、如何判断业务请求正常的阈值、如何避免网络情况（机房部署，网络抖动）影响统计口径。</div>2022-06-06</li><br/><li><img src="" width="30px"><span>Geek3093</span> 👍（0） 💬（0）<div>“在负载高情况，服务端来不及处理心跳请求，由于心跳时间很短，会导致调用方很快触发连续心跳失败而造成断开连接”
这句话不是很理解，如果调用方连续失败，是不是说明该实例在高负载情况下都无法处理正常请求了，那断开连接也没有关系吧</div>2022-03-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/bf/43/2602b4a6.jpg" width="30px"><span>少平</span> 👍（0） 💬（0）<div>突然想到是不是可以 由 监控平台来处理这个事情。
1. 接口的成功率会打点到 cat
2. 拉取 cat 的监控指标，当 接口失败率低于某个阈值时，直接 通知注册中心，下线该 节点</div>2022-01-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a4/76/585dc6b3.jpg" width="30px"><span>hiyanxu</span> 👍（0） 💬（0）<div>老师，你好。
注册发现中心 -》定时发送健康检测请求到服务提供方；
服务提供方有问题 -》注册中心主动推消息到调用方。
整体的流程是上面那样吗？应该不是调用方到提供方直接的健康检测吧？</div>2021-09-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e0/a8/4e739cf6.jpg" width="30px"><span>Sic Pavis</span> 👍（0） 💬（0）<div>针对不同接口做不同场景的预警策略。请求量大的当然直接用可用率就可以，请求量少的用可用率不太好，因为波动太大，误告警可能很多。 可以考虑采用类似每分钟五次错误这样的绝对值来处理</div>2021-06-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/46/d3/e25d104a.jpg" width="30px"><span>êｗěｎ</span> 👍（0） 💬（1）<div>空闲检测+心跳 应该可以解决</div>2021-04-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/ed/6c/6fb35017.jpg" width="30px"><span>群书</span> 👍（0） 💬（0）<div>从目标机器的监控上可以看到该机器的网络指标有异常，出问题时间点 TCP 重传数比正常高 10 倍以上。

大佬请教下，如何可以监控到tcp的重传数</div>2021-03-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/88/03/805c8e0e.jpg" width="30px"><span>追忆似水年华</span> 👍（0） 💬（0）<div>健康检测在服务发现集群里是不是也存在</div>2020-10-15</li><br/>
</ul>