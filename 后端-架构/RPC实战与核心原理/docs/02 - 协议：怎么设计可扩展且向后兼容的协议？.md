你好，我是何小锋。上一讲我分享了RPC原理，其核心是让我们像调用本地一样调用远程，帮助我们的应用层屏蔽远程调用的复杂性，使得我们可以更加方便地构建分布式系统。总结起来，其实就一个关键字：透明化。

接着上一讲的内容，我们再来聊聊RPC协议。

一提到协议，你最先想到的可能是 TCP协议、UDP协议等等，这些网络传输协议的实现在我看来有点晦涩难懂。虽然在RPC中我们也会用到这些协议，但这些协议更多的是对我们上层应用是透明的，我们RPC在使用过程中并不太需要关注他们的细节。那我今天要讲的RPC协议到底是什么呢？

可能我举个例子，你立马就明白了。HTTP协议是不是很熟悉（本讲里面所说的HTTP默认都是1.X）？ 这应该是我们日常工作中用得最频繁的协议了，每天打开浏览器浏览的网页就是使用的HTTP协议。那HTTP协议跟RPC协议又有什么关系呢？看起来他俩好像不搭边，但他们有一个共性就是都属于应用层协议。

所以**我们今天要讲的RPC协议就是围绕应用层协议展开的。**我们可以先了解下HTTP协议，我们先看看它的协议格式是什么样子的。回想一下我们在浏览器里面输入一个URL会发生什么？抛开DNS解析暂且不谈，浏览器收到命令后会封装一个请求，并把请求发送到DNS解析出来的IP上，通过抓包工具我们可以抓到请求的数据包，如下图所示：
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/7b/98/8f1aecf4.jpg" width="30px"><span>楼下小黑哥</span> 👍（135） 💬（15）<div>以 Dubbo 为例，消费者发送请求时，使用 AtomicLong 自增，产生一个 消息 ID。由于 Dubbo 底层 IO 操作是异步的，Dubbo 发送请求之后，需要阻塞等待消费者返回信息。消费者会将消息 ID 保存到 Map 结构中,。为了保证请求响应可以一一对应，这就需要提供者返回的响应信息带上请求者消息 ID。 通过响应的消息 ID，通过 上面提到 Map 存储数据，就能找到对应的请求。
感兴趣的同学可以看下 Dubbo 2.6 DefaultFuture 源码。</div>2020-02-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/07/8c/0d886dcc.jpg" width="30px"><span>蚂蚁内推+v</span> 👍（54） 💬（10）<div>老师好，您课后问题我有点不能理解。
我们http 请求一个资源不就对应一个返回。是一一对应的关系，为什么会有如何关联响应和请求的问题呢</div>2020-02-19</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJM2Y17W5mKU1icTg4OTKd3xYMhANenFDsYewjBlzWMujIh3vA2Yj9yG8ibr6WQMqUjjTgeNicXTp9kw/132" width="30px"><span>jfwwlong</span> 👍（35） 💬（7）<div>你好，既然基于TCP优于HTTP，gRPC为什么选择基于HTTP2</div>2020-02-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/f3/f3/3fbb4c38.jpg" width="30px"><span>旭杰</span> 👍（19） 💬（2）<div>调用方需要维护消息ID列表，然后和返回结果中的消息ID做匹配</div>2020-02-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/0e/c77ad9b1.jpg" width="30px"><span>eason2017</span> 👍（17） 💬（2）<div>老师，你好。请求时带上消息id，响应时，响应体里面带上请求消息的id，这样可以进行关联，对吗？</div>2020-02-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（14） 💬（10）<div>网络通信在传输层就是一堆堆的0&#47;1码，如果没有协议，那谁知道这一堆堆的0&#47;1是啥意思呢？没人能知道，协议的作用就是通信双方约定好，多少个0&#47;1表示什么意思。
1：Bit Offset——标识协议的其实位置
2：魔术位——标识是什么协议
3：整体长度——标识整个协议有多长，减去协议头长度就是协议体长度
4：头长度——标识协议头的长度，因为头是可扩展的，所以具体长度不固定，需要标识一下
5：协议版本——标识当前协议的版本，用于协议兼容性控制
6：消息类型——标识消息的类型，对于文本的需要，这里也需要嘛？协议类型可能是对象？可能是XML文件？可能是JSON码？正常来讲应该都是对象才对，让用于反序列化，猜测是为了扩展预留的
7：序列化方式——用于消息的序列化和反序列化
8：消息ID——用于表示请求和响应的关系
9：协议头扩展字段——用于扩展协议头，是协议具有扩展性，更加的灵活可控
10协议体——协议的内容，一堆堆的二进制数据，双方沟通的东西

协议头——规定信息转换的规则
协议体——信息真正的内容，由于在传输层对人不友好对应用程序也不友好需要转换一下</div>2020-05-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/3b/47/f6c772a1.jpg" width="30px"><span>Jackey</span> 👍（14） 💬（1）<div>答案就在题面上，老师的消息协议图里已经设计了消息ID了😃</div>2020-02-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/f0/61/fedca2e9.jpg" width="30px"><span>(Kelen)</span> 👍（13） 💬（6）<div>hhtp现在已经支持长链接了啊</div>2020-02-19</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKUcSLVV6ia3dibe7qvTu8Vic1PVs2EibxoUdx930MC7j2Q9A6s4eibMDZlcicMFY0D0icd3RrDorMChu0zw/132" width="30px"><span>Tesla</span> 👍（12） 💬（2）<div>老师，请问一下魔术位是指的什么啊？</div>2020-03-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/79/f4/d85e7e58.jpg" width="30px"><span>看山</span> 👍（6） 💬（1）<div>你好，一般RPC为了性能，会采用异步通信的方式，请求响应对应关联，就需要一个类似身份证号的ID，我在自己的项目中实现了类似的场景，https:&#47;&#47;github.com&#47;howardliu-cn&#47;cynomys&#47;tree&#47;master&#47;cynomys-net</div>2020-04-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0f/bf/ee93c4cf.jpg" width="30px"><span>雨霖铃声声慢</span> 👍（6） 💬（2）<div>对于课后思考里提到的“ RPC 不直接用 HTTP 协议的一个原因是无法实现请求跟响应关联”，我认为是有问题的，如果是同步请求，那么使用HTTP协议也是可以实现请求和相应关联的，只有异步请求才需要做关联，另外还需要说明这里的HTTP协议是指HTTP1.1。因为gRPC使用的是HTTP2.0协议，http2.0协议已经优化编码效率问题，而且HTTP2.0支持多路复用，不需要每次请求都需要重新建立连接，提高了连接的利用率。所以其实没必须要设置私有协议。</div>2020-02-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/e5/3a/77cb17b9.jpg" width="30px"><span>James</span> 👍（5） 💬（1）<div>老师，问个极端的问题。
消息ID是不断增加的，如果消息ID达到预留位置的最大值了。或者超过了程序里存储这个ID的类型的最大值的话，怎么办呢？或者说会有这种情况么？</div>2020-04-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/24/5d/65e61dcb.jpg" width="30px"><span>学无涯</span> 👍（4） 💬（2）<div>老师，关于http每次请求都要重新建立连接这一块不太理解，它不是支持长连接吗</div>2020-02-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/1c/e3/c399ab50.jpg" width="30px"><span>李毅科</span> 👍（3） 💬（1）<div>http2和rpc在高并发下效率差多少，老师能不能公布下数据，我心里好有个底，要不然觉得用rpc很虚啊。还有在高并发场景下spring cloud是不是可以直接被淘汰了，因为它用的是http2。高并发是不是就直接选用Dubbo了，因为它用rpc。</div>2020-03-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/82/3d/356fc3d6.jpg" width="30px"><span>忆水寒</span> 👍（3） 💬（1）<div>一般服务端会给每个客户端socket（或channel）绑定一个标识id，在注册中心可以通过id找到该socket（或channel），然后将数据发送出去。</div>2020-02-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/49/2c/a2a948b6.jpg" width="30px"><span>艾斯曼</span> 👍（3） 💬（1）<div>消息Id
</div>2020-02-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/4c/58/25152fa9.jpg" width="30px"><span>kevin</span> 👍（1） 💬（1）<div>协议设计与文字断句做类比很形象。
关于请求和响应对应上的话需要请求发送方带上自己的请求标识，服务端在返回的结果中也要带上这个请求的标识，这样请求发送方就可以通过请求标识来使用不同的请求</div>2020-02-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/8a/5a/b67a82e3.jpg" width="30px"><span>shen</span> 👍（1） 💬（1）<div>我的理解是在请求里面带一个请求id，然后响应对应的请求id，这样就建立了连接</div>2020-02-17</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJkwbyTYtSCx6Qc7cQPnnRWv38Jybh3etziaPmuP8gHcgS6FMxcdftrKgWiamH6fc2iciaicDKDVEwcEibQ/132" width="30px"><span>sami</span> 👍（0） 💬（2）<div>我的理解是，协议是主要是为了解决粘包和半包问题，序列化是为了解决传输过程数据包过大的问题</div>2020-05-13</li><br/><li><img src="" width="30px"><span>蔡佳伟</span> 👍（0） 💬（1）<div>老师好，我目前在做网络库，对于你这节课的协议，我看别人做的都有提供多种方式去实现这种协议的“断句”，比如真的用&#47;n什么的去区分逻辑包，但是我觉得您说的这种方式是最好最合理的，所以有必要去提供其他方式吗？个人认为还能减少代码量嘿嘿</div>2020-05-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/51/29/24739c58.jpg" width="30px"><span>凉人。</span> 👍（0） 💬（1）<div>感觉协议头模式，也是TCP&#47;IP 的套娃操作</div>2020-05-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/51/29/24739c58.jpg" width="30px"><span>凉人。</span> 👍（0） 💬（2）<div>感觉大部分内容http已经做了呀。长连接、多路复用</div>2020-04-27</li><br/><li><img src="" width="30px"><span>Geek_ae2b66</span> 👍（0） 💬（1）<div>何老师好。能对文章设计的RPC协议头中各项内容的使用应用场景做一下解释吗？例如，协议版本。</div>2020-04-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/ec/27/827015c0.jpg" width="30px"><span>追风少年</span> 👍（0） 💬（1）<div>感觉这个协议设计的跟TCP和UDP协议内容很类似，都含有定长的协议头，不定长的协议头和协议体，字段也有很多类似的。</div>2020-04-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/63/85/1dc41622.jpg" width="30px"><span>姑射仙人</span> 👍（0） 💬（1）<div>老师，用来匹配请求与响应，实现完整的双工通信，异步调用，而不必阻塞式的将RPC异步变为同步。不知道理解是否正确。</div>2020-03-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/b6/79/22e582a5.jpg" width="30px"><span>刘岚乔月</span> 👍（0） 💬（1）<div>通过请求&#47;响应ID映射的方式。消费者在调用时带上唯一的请求ID，生产者在处理完业务后带上响应ID。</div>2020-03-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f6/00/2a248fd8.jpg" width="30px"><span>二星球</span> 👍（0） 💬（2）<div>老师请教个问题：服务器A 向 服务器B 连续发送2个请求，但是第二次的请求结果先到，第一次的请求结果后到，TCP 协议本身能够区分 请求与相应的对应关系吗？</div>2020-03-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/ab/72/91c9853e.jpg" width="30px"><span>Reason</span> 👍（0） 💬（1）<div>如何实现请求和响应关联？
在老师的协议设计部分已经有一个消息ID，可以根据消息ID关联。具体做时，则需要存储消息ID和请求响应的映射关系，比如存储为Map</div>2020-02-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/9c/e4/2d320540.jpg" width="30px"><span>Harry</span> 👍（0） 💬（1）<div>老师，thrift 的协议中，好像就没有消息id ，thrift 不能做到请求和响应一一对应。
比如，多线程公用一个thrift 的client ，并发请求server 端，client 会报相关的异常。</div>2020-02-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/a6/62/26d84c8b.jpg" width="30px"><span>the day</span> 👍（0） 💬（1）<div>那么在 RPC 里面，我们是怎么实现请求跟响应关联的呢？
上下文匹配，简单明了！</div>2020-02-21</li><br/>
</ul>