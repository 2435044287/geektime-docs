你好，我是何小锋。上一讲我们介绍了优雅停机，就是为了让服务提供方在停机应用的时候，保证所有调用方都能“安全”地切走流量，不再调用自己，从而做到对业务无损。其中实现的关键点就在于，让正在停机的服务提供方应用有状态，让调用方感知到服务提供方正在停机。

接着上一讲的内容，今天我们来聊聊优雅启动。

是不是很诧异？应用启动居然也要这么“讲究”吗？这就好比我们日常生活中的热车，行驶之前让发动机空跑一会，可以让汽车的各个部件都“热”起来，减小磨损。

换到应用上来看，原理也是一样的。运行了一段时间后的应用，执行速度会比刚启动的应用更快。这是因为在Java里面，在运行过程中，JVM虚拟机会把高频的代码编译成机器码，被加载过的类也会被缓存到JVM缓存中，再次使用的时候不会触发临时加载，这样就使得“热点”代码的执行不用每次都通过解释，从而提升执行速度。

但是这些“临时数据”，都在我们应用重启后就消失了。重启后的这些“红利”没有了之后，如果让我们刚启动的应用就承担像停机前一样的流量，这会使应用在启动之初就处于高负载状态，从而导致调用方过来的请求可能出现大面积超时，进而对线上业务产生损害行为。

在上一讲我们说过，在微服务架构里面，上线肯定是频繁发生的，那我们总不能因为上线，就让过来的请求出现大面积超时吧？所以我们得想点办法。既然问题的关键是在于“刚重启的服务提供方因为没有预跑就承担了大流量”，那我们是不是可以通过某些方法，让应用一开始只接少许流量呢？这样低功率运行一段时间后，再逐渐提升至最佳状态。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg" width="30px"><span>Darren</span> 👍（32） 💬（2）<div>如果是大批量重启，可以通过：
1、分时分批启动，就和灰度发布一样；
2、在请求低峰把，在热点的应用肯定是有使用低峰的；
3、如果必须同时大批量重启，为了保证服务的可用性，可以在低峰时期，限流，为PLUS服务，非PLUS的就提醒暂时不可用之类的友好提示。
暂时就能想到这么多，请老师指点</div>2020-03-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5c/8f/551b5624.jpg" width="30px"><span>小可</span> 👍（10） 💬（1）<div>1.启动时逐步增加流量
2.等服务资源完全启动完成，再去注册服务
3.最好在注册前预热jvm，比如提前加载业务缓存</div>2020-03-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/de/92/f867b68c.jpg" width="30px"><span>武装到牙齿</span> 👍（5） 💬（1）<div>串行重启啊，明知道留下的机器顶不住流量，硬生生的给同时强制重启肯定不行啊</div>2020-03-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/00/4e/be2b206b.jpg" width="30px"><span>吴小智</span> 👍（5） 💬（1）<div>重要的还是减少大批量重启服务的情况，应该滚动升级，逐步替代。</div>2020-03-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg" width="30px"><span>每天晒白牙</span> 👍（3） 💬（1）<div>确实有这个问题，我们在上线服务提供方时，重启的并行度会控制在比较低的状态，比如只并行2台，避免发生大量请求打到未重启的服务提供方上</div>2020-03-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8c/9c/d48473ab.jpg" width="30px"><span>dancer</span> 👍（2） 💬（1）<div>感谢老师的分享，文中举的例子是基于服务先关闭再启动的情况。像K8s这种先启动一定数量新实例再关闭旧实例的发布流程，我们在关闭和启动时要注意哪些问呢</div>2020-05-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c7/88/a2e42dc8.jpg" width="30px"><span>波波</span> 👍（1） 💬（3）<div>老师，延迟暴露那个hook具体怎么实现，如何确定资源加载完毕了呢？</div>2020-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/f1/55/8ac4f169.jpg" width="30px"><span>陈国林</span> 👍（1） 💬（1）<div>控制发布的步长，类似K8s里面的Deployment的RollingUpgrade，滚动升级保证有足够的服务在抗流量</div>2020-03-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/a1/87/259ab5a3.jpg" width="30px"><span>桂冠远航</span> 👍（1） 💬（1）<div>优雅启动确实优雅关闭一样重要。</div>2020-03-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/01/37/12e4c9c9.jpg" width="30px"><span>高源</span> 👍（1） 💬（1）<div>老师请教个问题，socket客户端和服务端通讯，开始时间同步后，跑业务跑了一段时间后，后来发现日志客户端发出和服务端接收时间差了2秒，客户端有超时设置超了2秒就报警了，这是怎么解决啊，偶尔出现现象</div>2020-03-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/1a/05/f154d134.jpg" width="30px"><span>刘楠</span> 👍（1） 💬（1）<div>启动成功，后早单独搞个任务来注册呢？</div>2020-03-20</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKhuGLVRYZibOTfMumk53Wn8Q0Rkg0o6DzTicbibCq42lWQoZ8lFeQvicaXuZa7dYsr9URMrtpXMVDDww/132" width="30px"><span>hello</span> 👍（0） 💬（1）<div>在服务端重启时，应该需要考虑服务端重启服务器的比例，一般是将服务按批重启，确保在线的服务能扛住请求端过来的流量。</div>2020-03-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/01/37/12e4c9c9.jpg" width="30px"><span>高源</span> 👍（7） 💬（0）<div>老师把服务能够遇到和需要处理的细节讲的很全面了，微服务就应该做到这，但是对于我们非互联网企业使用微服务，落地有很大借鉴👍️</div>2020-03-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/c4/36/4f7239de.jpg" width="30px"><span>codewor</span> 👍（5） 💬（0）<div>老师很牛逼，是我遇到过最牛的一个了</div>2020-12-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d6/43/0704d7db.jpg" width="30px"><span>cc</span> 👍（2） 💬（1）<div>hook 这个做预热很难达到理想的效果了，尤其是业务代码复杂的情况。</div>2022-04-23</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyibojtJCnzALT1CleOHlTfS1XpFQHibXA7B2j631I2icHL2Uy5XvvviaEXBWPSNkU5G7LQP3JJHicgzQ/132" width="30px"><span>邹</span> 👍（2） 💬（0）<div>大批量重启时：
1. 分批重启
2. 根据重启比例来设置重启服务的权重</div>2020-07-09</li><br/><li><img src="" width="30px"><span>hillwater</span> 👍（0） 💬（0）<div>在哪里判断业务启动完毕了呢？写个空bean，把order降到最低？</div>2022-10-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c9/3c/7d9b3baa.jpg" width="30px"><span>天二</span> 👍（0） 💬（0）<div>老师，启动预热是rpc本身就有的能力呢？还是需要使用者自己实现呢？</div>2022-03-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/22/f4/9fd6f8f0.jpg" width="30px"><span>核桃</span> 👍（0） 💬（1）<div>大批重启有时候是大面积宕机导致的，这种不一定是可控的，很多朋友提到的串行重启，这个前提很难存在。想到一个比较好的方式，就是业务策做出调整了，例如像学校选课官网那样，在选课高峰期，其实也可以类似节点大面积宕机那样，切换业务模式，把很多动态的网页什么的全部暂停，只有一个最基础的业务静态网页请求等等，通过减少大量的网络请求，并且削峰来压平流量，但是这样需要在业务那里也做好策略才行。</div>2022-02-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/58/2c/92c7ce3b.jpg" width="30px"><span>易轻尘</span> 👍（0） 💬（0）<div>个人猜想可以进行限流，限制注册中心发给调用方ip列表的速度</div>2021-07-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/02/fe/d539b96b.jpg" width="30px"><span>曹翔</span> 👍（0） 💬（0）<div>根据负载情况，比如读取promethus上的数据，分批启动</div>2021-03-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/fa/84/f01d203a.jpg" width="30px"><span>Simple life</span> 👍（0） 💬（0）<div>旧服务不下线啊，重启成功后再下线啊，这样旧的服务也能承载流量，如果考虑到预热，可以分批重启</div>2020-10-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/5e/86/40877404.jpg" width="30px"><span>星星滴蓝天</span> 👍（0） 💬（0）<div>我们是晚上低峰时上线，白天不让上线</div>2020-09-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/c2/fe/038a076e.jpg" width="30px"><span>阿卧</span> 👍（0） 💬（0）<div>大批量服务重启需要做到以下几点：
1. 分批次重启服务
2. 在服务低峰时候进行服务重启
3. 重启过程中对服务做限流操作</div>2020-08-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/2d/d7/74fc8f38.jpg" width="30px"><span>灿烂明天</span> 👍（0） 💬（0）<div>还有老师，这里给了两个方案，是从客户端和服务端方面的，实际用是两个最好一起用，还是哪个方案比较好点的</div>2020-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/2d/d7/74fc8f38.jpg" width="30px"><span>灿烂明天</span> 👍（0） 💬（0）<div>老师你好，那个启动预热那里权重达到了设定的固定值后挪出列表是挪出调用方的服务列表吗，达到了正常还要挪出？这里不太明白，能解惑下吗老师，谢谢</div>2020-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（0） 💬（0）<div>优雅启动：
第一启动预热
第二延迟暴露
第三分批启动

实际上线时，我们一般遵循这样的逻辑：
前提是各种测试OK，然后预发布也OK
第一先上线一台机器，验证是否OK
第二每个分组再上线一台，都验证是否OK
第三分批次把其他组内未上线部分机器都上线

一次启停大部分机器，这种场景在发现上线完成后存在某些问题，为了及时止损，可能会一次回滚大批量机器，这时就非常需要优雅启停的控制了，否则业务异常一定比较多。这是就是异常处理的事情了，及时没有优雅启停也需要赶紧回滚及时止损，出现这种情况，主要是线上验证存在漏洞造成的，还需要完善上线验证流程。</div>2020-05-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/55/f2/ba68d931.jpg" width="30px"><span>有米</span> 👍（0） 💬（0）<div>老师留下的问题其实就是引出下一节内容，限流和熔断，吃不了那么多就不给他吃了，总比撑死好</div>2020-05-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ae/0c/f39f847a.jpg" width="30px"><span>D</span> 👍（0） 💬（1）<div>老师有没有更通用的技术方案，不和语言绑定的</div>2020-03-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/01/37/12e4c9c9.jpg" width="30px"><span>高源</span> 👍（0） 💬（0）<div>客户端毫秒级别不停发日志数据过来，服务端写入文件，服务端也有自己的日志文件也不少</div>2020-03-20</li><br/>
</ul>