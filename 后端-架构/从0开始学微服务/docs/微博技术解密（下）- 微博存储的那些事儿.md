今天是微博技术解密系列的第二期，我们来聊聊微博存储的使用经验。上一期“微博技术解密”我讲到微博主要使用了两大类存储：一类是数据库，主要以MySQL为主；一类是缓存，主要以Memcached和Redis为主。

今天我来分享一下微博在使用数据库和缓存方面的经验，也欢迎你给我留言一起切磋讨论。

## MySQL

上一期我讲到微博Feed的存储使用了两层的结构，为了减少对MySQL数据库的访问压力，在前面部署了Memcached缓存，挡住了99%的访问压力，只有1%的请求会访问数据库。然而对于微博业务来说，这1%的请求也有几万QPS，对于单机只能扛几千QPS的MySQL数据库来说还是太大了。为此我们又对数据库端口进行了拆分，你可以看下面的示意图，每个用户的UID是唯一的，不同UID的用户按照一定的Hash规则访问不同的端口，这样的话单个数据库端口的访问量就会变成原来的1/8。除此之外，考虑到微博的读请求量要远大于写请求量，所以有必要对数据库的读写请求进行分离，写请求访问Master，读请求访问Slave，这样的话Master只需要一套，Slave根据访问量的需要可以有多套，也就是“一主多从”的架构。最后考虑到灾备的需要，还会在异地部署一套冷备的灾备数据库，平时不对外提供线上服务，每天对所有最新的数据进行备份，以防线上数据库发生同时宕机的情况。
<div><strong>精选留言（15）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/69/4d/81c44f45.jpg" width="30px"><span>拉欧</span> 👍（8） 💬（0）<div>redis里的布隆过滤器，也是同样的原理</div>2019-02-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4e/21/700586eb.jpg" width="30px"><span>王鸿运</span> 👍（7） 💬（2）<div>胡老师，问一个布隆过滤器问题:
因为hash函数存在冲突问题，所以布隆过滤器如果判断不存在肯定是不存在，判断存在有极低可能不存在（该key哈希后对应的三个位置都冲突了），你们是允许这种概率性误判存在，还是会通过其他方式规避?</div>2019-02-02</li><br/><li><img src="" width="30px"><span>xylsh</span> 👍（3） 💬（0）<div>不太明白L1怎么分担带宽压力的，
1、是每组L1都有自己的带宽吗？
2、带宽压力指机器接入的网络的压力吗？那岂不是每组L1都要有自己的网络带宽？？？</div>2019-07-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4b/d4/b7719327.jpg" width="30px"><span>波波安</span> 👍（2） 💬（0）<div>老师，redis单个key value占大概65个字节，这个是怎么算得？</div>2019-06-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8e/5a/2ed0cdec.jpg" width="30px"><span>donson</span> 👍（2） 💬（0）<div>redis内存有效负荷比较低，一条KV大概需要至少65个字节。 这65个字节是怎么来的？</div>2019-02-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/63/ae/3d3717a3.jpg" width="30px"><span>westbrook</span> 👍（1） 💬（0）<div>bloom过滤器 当3次Hash 都存在 只能说明可能存在，还需要进行值对比，才能确认是否真的存在</div>2019-12-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/07/d2/0d7ee298.jpg" width="30px"><span>惘 闻</span> 👍（0） 💬（1）<div>比如每天新发布的微博数量在 1 亿条左右，是否被用户读过的总数据量可能有上千亿，怎么存储是个非常大的挑战。
这是怎么算的啊,只有一千个用户吗? 还是每个用户不必存储所有的微博是否阅读标识.</div>2021-01-29</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/MlmSR4YXUfrNlZdMv7bv1ic64HaxxVKcVtaxjzhXCvNC4XByICCmYUTprhOESzIV8p59N6DnSJ7HywfvGr5nicgA/132" width="30px"><span>mz</span> 👍（0） 💬（0）<div>感谢</div>2019-02-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/46/b5/a46d5b64.jpg" width="30px"><span>小若</span> 👍（0） 💬（0）<div>胡老师新年快乐！利用七天假期完成了课程学习，受益匪浅，感谢！</div>2019-02-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5d/1b/67422d6f.jpg" width="30px"><span>CAFEBABE</span> 👍（0） 💬（0）<div>新年快乐</div>2019-02-04</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ep8fwVGUOfD2UVbgwibDUDyQib5pCfylE5XQqm9DvTibIkEINdynaA9q3poiaDkcJhAr2XHLY0icE1rkwA/132" width="30px"><span>iHai</span> 👍（0） 💬（0）<div>感谢胡老师，新年快乐</div>2019-02-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/3f/b7/0d8b5431.jpg" width="30px"><span>snakorse</span> 👍（0） 💬（0）<div>胡老师，这两期很赞，感谢，新年快乐~</div>2019-01-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/87/b5/dd0353f4.jpg" width="30px"><span>三水</span> 👍（0） 💬（0）<div>新年快乐！</div>2019-01-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg" width="30px"><span>每天晒白牙</span> 👍（0） 💬（0）<div>胡老师，新年快乐</div>2019-01-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/a4/e7/303df05e.jpg" width="30px"><span>Geek_978989</span> 👍（0） 💬（0）<div>新年快乐，希望胡老师还有新专栏</div>2019-01-31</li><br/>
</ul>