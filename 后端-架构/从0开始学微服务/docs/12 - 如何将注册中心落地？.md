专栏第5期我给你讲了服务注册和发现的原理，这里面的核心是服务提供者、服务消费者和注册中心这三个概念，以及它们之间的交互关系。你可以先回顾一下这几个关键的知识点，如果有不清楚的地方，建议你先返回[第5期](http://time.geekbang.org/column/article/14603)复习一下，再开始今天的学习。

掌握了服务注册和发现的原理之后，我们就需要考虑如何把注册中心落地实现。结合前面所讲的服务注册与发现的流程，在落地注册中心的过程中，我们需要解决一系列的问题，包括如何存储服务信息、如何注册节点、如何反注册、如何查询节点信息以及如何订阅服务变更等。这些问题你都知道如何解决吗？如果还没答案，没关系，下面我来给你一一讲解。

## 注册中心如何存储服务信息

注册中心既然是用来存储服务信息的，那么服务信息都包含哪些内容呢？

根据我的实践经验，服务信息除了包含节点信息（IP和端口号）以外，还包含其他一些信息，比如请求失败时重试的次数、请求结果是否压缩等信息。因此服务信息通常用JSON字符串来存储，包含多个字段，每个字段代表不同的含义。

除此之外，服务一般会分成多个不同的分组，每个分组的目的不同。一般来说有下面几种分组方式。

- 核心与非核心，从业务的核心程度来分。
- 机房，从机房的维度来分。
- 线上环境与测试环境，从业务场景维度来区分。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/9b/a8/6a391c66.jpg" width="30px"><span>geraltlaush</span> 👍（12） 💬（1）<div>注册中心的信息怎么实现增量更新，是通过版本号的方式吗</div>2018-10-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/49/0b/db412e36.jpg" width="30px"><span>WL</span> 👍（10） 💬（1）<div>消费者订阅了服务的变更，当服务变更的时候，注册中心就可以把变更通知单消费者，那消费者为什么还需要定期去拉注册中心的数据呢？</div>2018-10-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a8/e7/b86938a1.jpg" width="30px"><span>沙漠之鹰</span> 👍（1） 💬（1）<div>zk似乎能保证节点变更对订阅者的及时变更，这块批量反注册僵尸节点是针对哪个注册中心组件而言呢</div>2018-09-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg" width="30px"><span>每天晒白牙</span> 👍（29） 💬（6）<div>老师，文中有”以前我们的业务中经常遇到这个问题，需要定时去清理注册中心中的“僵尸节点”。后来我们通过优化反注册逻辑，对于下线机器、节点销毁的场景，通过调用注册中心提供的批量反注册接口，一次调用就可以把该节点上提供的所有服务同时反注册掉，从而避免了“僵尸节点”的出现。”
我这里有两个疑惑点:
1.之前的方案是定时清理”僵尸节点”是通过什么方法呢？ 简单的ping一下，看能否通？然后发现一个僵尸节点就删掉
2.优化反注册接口，批量删除。老师能具体说下方案吗？ 如果批量删除，会不会存在一个时间窗口，僵尸节点还在注册中心的情况？</div>2018-09-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/6d/d0/6c2b8877.jpg" width="30px"><span>吴浩</span> 👍（17） 💬（3）<div>服务注册流程中注册节点有个问题想问下

为什么查看注册的Cluster（服务的接口名）和Service（服务的的分组）是否存在，不存在就抛出异常

这里为什么不是不存在就添加这个服务的接口名了，为什么是报错，第一次初始化是在哪进行的了</div>2018-10-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/48/77/400cac74.jpg" width="30px"><span>拉风一哥</span> 👍（9） 💬（2）<div>感觉讲的太抽象了，能不能结合具体的实例。你说的这些解决方案，也是抽象的方案，比如多注册中心要如何实现，实现的时候该注意什么问题？</div>2019-03-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/9a/a9/dfea2c50.jpg" width="30px"><span>张龙大骗子</span> 👍（5） 💬（0）<div>Eureka就有僵尸节点的问题，一个服务下线后，消费者可能需要100多秒才能感知到</div>2018-09-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f5/1f/577265ea.jpg" width="30px"><span>少帅</span> 👍（4） 💬（0）<div>Eurka可以调整心跳时间来处理僵尸接点</div>2018-09-18</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/Q3auHgzwzM4XjZjjDNic658J56twmLnFMmDy4iaD5qHvVKibT94tuoic6iaia9pRQia2zCCmakSJibRFHGiaiasEdiaGukWdw/132" width="30px"><span>pscj</span> 👍（3） 💬（0）<div>吴浩同学的疑问也是我想问的，最开始中心里一个服务都没有。注册的时候为什么service不存在，就抛异常了，难道不应该是保存？</div>2018-11-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/dc/f8/9bc56db2.jpg" width="30px"><span>yga</span> 👍（3） 💬（0）<div>对于现有的注册中心，比如euraka,对于文中提到的流程优化方案，需要如何操作？</div>2018-09-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（2） 💬（0）<div>如果注册中心挂了，重启服务调用者用它存储的服务提供者信息，如果服务提供者也存在不可用的怎么弄？</div>2019-06-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/e8/0f/6882889a.jpg" width="30px"><span>风之翼</span> 👍（2） 💬（1）<div>请问老师，一个企业内有多个服务注册中心有什么利弊，是否可以通过规范强制要求各个部门使用公共的注册中心，可能存在什么需要注意的问题？</div>2018-10-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d0/ee/f5c5e191.jpg" width="30px"><span>LYy</span> 👍（1） 💬（0）<div>问题三和问题四产生的根源都是因为消费者直接感知提供者的节点信息引起的 只要消除这层复杂度 问题三和问题四就迎刃而解 解决办法就是引入负载均衡中间件：
1 提供者只对消费者暴露唯一的访问地址（如浮动ip，内部域名）
2 提供者的扩缩容只需要通过配置中心与负载均衡中间件交互，消费者不感知</div>2019-05-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/dd/3e/c3028cd5.jpg" width="30px"><span>gongxt</span> 👍（1） 💬（0）<div>反注册，服务提供者什么时候去调用这个接口呢？  如果服务提供者这个时候自己崩溃了</div>2019-03-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/f1/24/d15cf6af.jpg" width="30px"><span>英宁</span> 👍（1） 💬（0）<div>注册了节点不要update_sign嚒？</div>2018-11-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/fd/58/1af629c7.jpg" width="30px"><span>6点无痛早起学习的和尚</span> 👍（0） 💬（0）<div>其实这里还有一些问题，比如多个注册中心，这样反而增加了服务提供者、消费者的负担，为啥不直接搞一个注册中心就行，如果是为了注册中心的容灾考虑，那当然就是另外一个问题了</div>2024-05-08</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/wwM75BhyU43UYOJ6fZCZgY6pfNPGHHRlooPLQEtDGUNic4aLRHWmBRTpIiblBAFheUVm9Sw8HWAChcFsnVM2sd5Q/132" width="30px"><span>Geek_d6f50f</span> 👍（0） 💬（0）<div>这一节没太看懂，感觉有点矛盾，对service、cluster，前后的说法不一致，请老师详细再为我们举例解析一下，谢谢</div>2022-03-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/41/13/bf8e85cc.jpg" width="30px"><span>树心</span> 👍（0） 💬（0）<div>具体存储的时候，一般是按照“服务 - 分组 - 节点信息”三层结构来存储，可以用下图来描述。Service 代表服务的具体分组，Cluster 代表服务的接口名，节点信息用 KV 存储 。 这里是不是写错了?分组- 服务-节点信息</div>2022-01-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/41/13/bf8e85cc.jpg" width="30px"><span>树心</span> 👍（0） 💬（0）<div>具体存储的时候，一般是按照“服务 - 分组 - 节点信息”三层结构来存储，可以用下图来描述。Service 代表服务的具体分组，Cluster 代表服务的接口名，节点信息用 KV 存储。</div>2022-01-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ee/c6/bebcbcf0.jpg" width="30px"><span>俯瞰风景.</span> 👍（0） 💬（0）<div>注册中心提供的服务：
  1、服务提供者注册服务
  2、服务提供者反注册服务
  3、服务消费者查询服务列表
  4、服务消费者订阅服务变更

多注册中心：在实际应用中存在多注册中心的情况，对于服务消费者来说，要能够同时从多个注册中心订阅服务；对于服务提供者来说，要能够同时向多个注册中心注册服务。

并行订阅服务：并行订阅服务可以有效地减少服务订阅的时间。

批量反注册服务：对于下线机器、节点销毁的场景，通过调用注册中心提供的批量反注册接口，一次调用就可以把该节点上提供的所有服务同时反注册掉，从而避免“僵尸节点”的出现。

服务变更信息增量更新：通过增量更新的方式，注册中心只返回变化的那部分节点信息，尤其在只有少数节点信息变更时，此举可以大大减少服务消费者从注册中心拉取的数据量，从而最大程度避免产生网络风暴。</div>2021-10-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/56/c9/7b3cd3e0.jpg" width="30px"><span>马振</span> 👍（0） 💬（2）<div>反注册的含义是注册中心通过心跳主动删除不可用服务吗</div>2020-05-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f2/f7/83a8a0d8.jpg" width="30px"><span>掸尘</span> 👍（0） 💬（0）<div>“其次要查看注册的 Cluster（服务的接口名）是否存在？如果不存在就抛出异常，存在的话继续下一步。” 注册的时候，服务接口名称就存在了？</div>2020-03-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/2f/08/6b38c0b4.jpg" width="30px"><span>Usher✨</span> 👍（0） 💬（0）<div>大佬好，dubbo要怎么设置并行订阅</div>2019-07-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/b2/b3/798a4bb2.jpg" width="30px"><span>帽子丨影</span> 👍（0） 💬（0）<div>定时check sign一般间隔多久比较合理呢？</div>2019-04-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/99/af/d29273e2.jpg" width="30px"><span>饭粒</span> 👍（0） 💬（0）<div>老师，请教下多注册中心这两点“对于服务消费者来说，要能够同时从多个注册中心订阅服务；对于服务提供者来说，要能够同时向多个注册中心注册服务。”这个在dubbo和motan有很好的支持吗？据我有限的spring cloud使用时间看，它好像不支持这个。</div>2019-03-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/2b/4e/6dc3a5bf.jpg" width="30px"><span>sliver_z</span> 👍（0） 💬（1）<div>能不能讲讲，如果一个实例挂啦，怎么去调用另外一个服务，而不是报错</div>2018-11-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/10/69/ee6177bc.jpg" width="30px"><span>北风之神</span> 👍（0） 💬（0）<div>这里说的注册中心落地是自己实现注册中心的意思吗？像eureka、consul、etcd这些注册中心实现，直接用不就可以了，使用这些也需要考虑你这些问题吗？</div>2018-10-23</li><br/><li><img src="" width="30px"><span>我的球</span> 👍（0） 💬（0）<div>服务提供者要保持长连接，发送心跳，是需要单独一个进程来维护的吗？谷歌了好多文章都没有提到，我是php，看了看dubbo的文档，有个容器的概念，但不是太懂jvm，tomcat的原理，所以不知道dubbo的启动流程？</div>2018-10-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/21/20/1299e137.jpg" width="30px"><span>秋天</span> 👍（0） 💬（0）<div>反注册这个想法借鉴于哪里的？</div>2018-09-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0c/42/fbd028c2.jpg" width="30px"><span>feimeng0532</span> 👍（0） 💬（0）<div>服务提供者反注册，服务成为僵尸，服务自己怎么知道</div>2018-09-20</li><br/>
</ul>