微服务容器化运维系列的前两期，我给你详细介绍了微服务容器化后如何运维的几个关键问题：镜像仓库、资源调度、容器调度、服务编排，这些问题的产生都是因为微服务部署的节点从一台台物理机或者虚拟机变成了一个个容器，运维模式发生了根本性的变化。此时，容器运维平台也就应运而生。

微博的业务从2013年就开始进行容器化，2015年为了应对春晚以及突发热点事件带来的峰值流量，开始引入阿里云；同时也为了适应业务的发展和运维方式的变化，在2015年底开始研发新的容器运维平台DCP。今天我就和你聊聊微博容器运维平台DCP，我会讲讲一个真实的容器运维平台是如何建设的，在建设过程中面临了哪些问题，以及对应的解决方案，希望可以让你对容器运维平台的架构有所了解，并提供一些经验可供借鉴。

## DCP整体架构

首先我们先来看看DCP的架构设计，从下面这张架构图你可以看到，DCP的架构主要分为四个部分：基础设施层、主机层、调度层、编排层，对应的分别解决前面提到的容器运维平台建设的几个关键问题：基础设施层用于解决镜像仓库的问题，主机层主要解决如何进行资源调度的问题，调度层主要解决容器如何在资源上创建的问题，编排层主要解决容器如何运作以对外提供服务的问题。下面我们来看各层的详细设计。
<div><strong>精选留言（10）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/c4/b1/9239de01.jpg" width="30px"><span>kefeng</span> 👍（2） 💬（1）<div>老师，DCP服务编排是基于overlay网络吗，还是underlay网络，这部分能介绍一下吗</div>2018-11-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d8/35/ebd9052b.jpg" width="30px"><span>Sean Zhang</span> 👍（2） 💬（1）<div>我也觉得应该按方式一，各个服务自动按需扩容，前面的服务扩容以后，如果后面的能支撑就不用扩容，不能支撑也会自动扩容的，如果等到所有后面的服务扩容完成就晚了。</div>2018-11-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg" width="30px"><span>每天晒白牙</span> 👍（17） 💬（1）<div>微博的热点新闻比如前几天赵丽颖结婚事件，导致微博热搜停了一会儿，请问阿忠伯是因为扩容的时候不及时或带宽打满等原因吗？挺期待分享一下事件的原因和处理经过的</div>2018-10-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg" width="30px"><span>每天晒白牙</span> 👍（2） 💬（0）<div>我觉得采用方式一自动扩缩容的方式好一些，因为他们并行扩容等待时间段。如果采用方式二，先让依赖服务B扩容，此时服务A没有扩容，来高流量依然扛不住，等B扩容结束后再开始扩容A，相当于AB串行扩容，可能需要的时间长一些</div>2018-10-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（1） 💬（0）<div>思考题根据老师的描述，A依赖B，且此时A的流量暴增了，我觉得A和B同时扩容更好，这样对A有所冲击到B时已经扩容岂不更好。
若A和B自适应扩容，都会受到冲击。
若先扩容B，则A受到的扩容就会更久更多。</div>2019-06-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/04/18/4b02510f.jpg" width="30px"><span>明天更美好</span> 👍（1） 💬（1）<div>胡老师请教个问题。分布式缓存与数据库双写有什么好的方案吗？由于性能要求，我们数据数据全部缓存到分布式缓存中，先更新缓存在异步更新库。但是现在数据库跟缓存存在差异。有上亿数据量，现在要迁移整个idc，并且应用不停机，求数据迁移的方案  必有重谢</div>2018-10-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/69/4d/81c44f45.jpg" width="30px"><span>拉欧</span> 👍（1） 💬（0）<div>扩容可以自动进行，缩容可以按照服务依赖关系串行执行。如果扩容也串行执行，可能最后执行扩容的服务已经因为流量太大搞崩了</div>2018-10-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ee/c6/bebcbcf0.jpg" width="30px"><span>俯瞰风景.</span> 👍（0） 💬（0）<div>容器化运维主要解决的问题是“如何合理地在服务器资源上创建容器并部署服务”，还有就是为了更加高效地使用服务器资源而进行动态扩缩容。</div>2021-10-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/e0/9a/03cb3236.jpg" width="30px"><span>徐巍</span> 👍（0） 💬（0）<div>对于容器来说，扩容应该是一个很轻量级的工作(秒级扩容)，部分有损比雪崩好多了，所以先扩容B，再扩容A</div>2019-10-24</li><br/><li><img src="" width="30px"><span>龙潜潜</span> 👍（0） 💬（0）<div>关于微服务划分的问题，针对同一业务域，比如user或feed，既存在来自app端的请求，又有来自管理后台的请求。请问这种情况是设置一个微服务模块，还是区分前后端设置两个？</div>2018-10-26</li><br/>
</ul>