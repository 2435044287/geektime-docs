专栏上一期我们聊了Service Mesh的代表作Istio，由于Istio的设计理念非常新，并且它诞生在微服务容器化和Kubernetes云平台火爆之后，所以从设计和实现上，Istio都天生对云原生应用更友好。

但是现实是不是也是那么美好呢？对于一个已经上线运行多年的业务系统来说，要想从经典的微服务架构走上Istio这条看似完美的道路并不容易，各种内部基础设施的定制化以及业务稳定性优先准则等因素，都注定了大多数公司要走出一条自己的Service Mesh实践之路。今天我就来带你回顾下微博是如何一步步走向Service Mesh的。

## 跨语言服务调用的需求

我在前面讲过，微博的服务化框架采用的是自研的Motan，Motan诞生于2013年，出于微博平台业务单体化架构拆分为微服务改造的需求，在结合当时的开源服务化框架和自身实际的需求，选择了采用自研的方式。而且由于微博平台的业务采用的是Java语言开发，所以Motan早期只支持Java语言。后期随着微博业务的高速发展，越来越多的PHP业务开始登上舞台，于是在微博的流量体系中，主要是三股服务之间的相互调用：一个是Java与Java语言，一个是PHP和Java语言，一个是PHP和PHP语言。Java应用之间的调用采用的是Motan协议，而Java应用与PHP、PHP与PHP应用之间采用的都是HTTP协议。我回忆了一下当时一次PHP与Java之间的HTTP调用过程，大致需要经过DNS解析、四层LVS负载均衡、七层Nginx负载均衡，最后才能调用Java应用本身。
<div><strong>精选留言（12）</strong></div><ul>
<li><img src="" width="30px"><span>Geek_0z54le</span> 👍（5） 💬（1）<div>是如何降低链路损耗？</div>2018-12-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/6d/45/7e95bd13.jpg" width="30px"><span>小菜鸡</span> 👍（2） 💬（1）<div>周晶有个微课专门讲微博的Mesh，他是你同事吧？</div>2018-11-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/69/4d/81c44f45.jpg" width="30px"><span>拉欧</span> 👍（2） 💬（1）<div>不同语言之间调用最通用的方式是http，所以需要协议转换，把原来的rpc调用转换成http调用，然后再根据服务发现和负载均衡策略，获取相应的IP和端口</div>2018-11-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/dd/65/3b4a2930.jpg" width="30px"><span>lpf32</span> 👍（1） 💬（1）<div>回答
作为客户端，服务端需要分别把request，response转成motan协议，发送给本地motan agent
</div>2018-11-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/3c/fa/e2990931.jpg" width="30px"><span>文敦复</span> 👍（1） 💬（1）<div>请问老师，Motan数据序列化和解析比GRPC快很多吗？用的是什么序列化方式？</div>2018-11-13</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/wIWrciav7DRkOaD7vUtr084sxprq2U4obfH1ibls4RIsAw5foQlDGIt98x1RHATznNbh0iasibWV2Y7I7QpyFJ4TVA/132" width="30px"><span>Wipeher</span> 👍（0） 💬（1）<div>motan也是应用层协议吧？那么HTTP协议带来的第一个问题：中间链路损耗大，无论是否使用agent，也必然还是存在的么？</div>2020-04-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/6d/09/ffeabc27.jpg" width="30px"><span>任鑫</span> 👍（1） 💬（0）<div>Istio背靠的Google在微服务云原生方面起步早、体量大，远非微博可比。</div>2020-06-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/29/67/fc61a741.jpg" width="30px"><span>田小麦</span> 👍（0） 💬（0）<div>一门好的课程能引导出，技术演进过程，能很好的深入学习，并产生兴趣！！！</div>2022-10-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/96/a2/c1596dd8.jpg" width="30px"><span>🤔</span> 👍（0） 💬（0）<div>motan-go代理是go语言写的吗</div>2022-04-28</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/Q3auHgzwzM6xFYMRMLWdcDaAI8PJ2cyfTvicAWbv5VAVqI22Y6QqUxuntUn8W44WIWibvibbPdAxrT5szduZdduIA/132" width="30px"><span>Geek_805d64</span> 👍（0） 💬（0）<div>老师，这个dns解析是内网解析还是外网，php发请用给java需要出去转一圈回来微博的机房吗？</div>2021-06-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/75/9b/611e74ab.jpg" width="30px"><span>技术修行者</span> 👍（0） 💬（0）<div>按照作者的描述，微博Mesh使用Motan-go来做agent，负责服务发现、负载均衡以及熔断管理等。

那么每个服务发出request时，需要client来将请求转换成Motan能够识别的格式，同时，Client还需要将Motan-go返回的response转换成服务可以识别和处理的格式。</div>2019-09-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8c/5c/3f164f66.jpg" width="30px"><span>亚林</span> 👍（0） 💬（0）<div>不用的语言，每个都需要看一个轻量级的 Client？</div>2019-06-21</li><br/>
</ul>