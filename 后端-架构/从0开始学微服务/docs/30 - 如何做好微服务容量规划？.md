专栏上一期我给你讲解了单体应用拆分为微服务后带来的开发、测试和运维复杂度的提升，可以通过DevOps实现CI/CD流程的自动化来解决。除此之外，单体应用拆分为微服务还带来另外一个问题，也就是拆分出来后的多个**微服务容量如何规划**的问题。在单体应用时，只需要针对这个单体应用的访问量和实际接口性能来决定要不要给单体应用扩容，而拆分为众多的微服务之后，需要考虑每个服务的容量规划，它的复杂度主要来自下面几个方面。

- 服务数量众多，纯靠人肉运维难以管理，比如微博Feed业务仅仅RPC服务就有将近40个。
- 服务的接口表现差异巨大，有的接口属于访问量比较大，但接口响应时间比较短的轻接口；有的接口属于访问量比较小，但接口响应时间比较长的重接口。比如微博Feed业务中计数接口的平均耗时只有2～3ms，而微博Feed业务中Feed接口的平均耗时要超过200ms。
- 服务部署的集群规模大小不同，需要扩容的机器数量差异很大。比如微博的AB测试服务集群只有大约20台机器，扩容只需要几台机器就满足了；而Feed服务则有上千台机器，往往扩容需要上百台机器。
- 服务之间还存在依赖关系，在服务扩容的时候，还需要考虑依赖服务的容量是否足够。比如微博Feed业务扩容还依赖用户关系服务和Card服务，扩容时还需要考虑依赖的用户关系服务和Card服务容量是否有问题。
<div><strong>精选留言（18）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/4b/d4/b7719327.jpg" width="30px"><span>波波安</span> 👍（14） 💬（1）<div>老师，这里都是考虑服务层面的扩缩容。对于数据库层面存在瓶颈的情况，有什么经验分享吗。</div>2018-11-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg" width="30px"><span>每天晒白牙</span> 👍（13） 💬（1）<div>请问阿忠伯，分区加权计算，响应时间越长，加权越大的原因是什么呢？</div>2018-10-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/15/c6/f5c543ef.jpg" width="30px"><span>Switch</span> 👍（1） 💬（1）<div>为什么响应时间越长，权重越高？

引用：区间加权来计算，也就是把请求按照响应时间分成多个区间，每个区间分别赋予不同的权重，响应时间越长权重越高</div>2018-10-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d4/f3/129d6dfe.jpg" width="30px"><span>李二木</span> 👍（1） 💬（1）<div>问一个与本节无关的问题，微服务通过http请求调用，数据交换你们做了压缩吗？如果使用过那么用的那种方式呢？</div>2018-10-31</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/ZwLEEpglswe8uzYj4W6ZVxx0W0OdicjicFzkha4O99wZWGRXqOTF1LO8SsJaBicCXugIQhn8BQicVoTcDJic82RbwDg/132" width="30px"><span>扁扁圆圆</span> 👍（0） 💬（1）<div>
关于权重那块，慢请求越多，计算出来的单机容量更高？不是应该更低吗？</div>2018-11-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0a/e3/9637bfdb.jpg" width="30px"><span>Ricky Fung</span> 👍（5） 💬（2）<div>想问一下在生产环境做压测，由压测产生的数据要如何处理才不会污染真实的数据？</div>2018-12-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4b/d4/b7719327.jpg" width="30px"><span>波波安</span> 👍（2） 💬（1）<div>不评估数据库的承受能力吗，不停的扩展服务，把数据库压挂了怎么办？</div>2018-11-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/0a/c8/dae4a360.jpg" width="30px"><span>Do</span> 👍（1） 💬（0）<div>安全线和致命线是怎么设定的呢? 和集群容量是什么样的关系?</div>2019-01-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/0f/d5/73ebd489.jpg" width="30px"><span>于加硕</span> 👍（0） 💬（0）<div>对思考题的解答：
应用服务集群内单机负载偏离集群均值时，属于运维接入规范问题，以应用服务作为一个最小单元，该单元内业务逻辑必须保持一致。
1.从业务视角让产研调整，例如将集群内的计划任务、或定时对三方的主动调用拆分出去，或改变调用处理方式为削峰填谷。
2.从运维视角兼容这种异常，就是提供更过的冗余资源，兼容这种情况(必须是少量的应用服务)。

老师，还有一个问题想请教下：
微服务架构下可以利用率HPA、VPA快速实现应用服务容量扩速溶，为什么还需要容量规划，提前将容量扩容上去呢？
还是说容量规划只适用于尖刺流量场景？(原因是HPA效率低于尖刺增长速度)</div>2024-12-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ee/c6/bebcbcf0.jpg" width="30px"><span>俯瞰风景.</span> 👍（0） 💬（0）<div>微服务容量规划的目的是为了合理高效地利用硬件资源。

做出合理的容量规划的前提是对容量进行评估，通过监控数据指标，绘制集群水位线，然后通过水位线做出扩容和缩容的调度决策。</div>2021-10-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/3e/d8/8608ec03.jpg" width="30px"><span>Tree</span> 👍（0） 💬（0）<div>如果响应时间越大，占用的权重越大，那么最终在计算集群容量的时候该怎么计算呢</div>2021-05-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/00/4e/be2b206b.jpg" width="30px"><span>吴小智</span> 👍（0） 💬（0）<div>请问老师，服务间的资源配比怎么得到呢？</div>2021-05-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/3d/3d/a9c8d564.jpg" width="30px"><span>Joyce</span> 👍（0） 💬（0）<div>如果服务存在分区域（比如地图搜索领域，来自北京的请求路由给固定处理北京数据的微服务）的场景下，怎么去做容量规划呢？因为存在这种固定数据处理微服务的特殊情况</div>2019-11-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7d/95/dd73022c.jpg" width="30px"><span>我是曾经那个少年</span> 👍（0） 💬（0）<div>遇到特殊的单机故障，应该排除计算权重，避免部分异常机器，影响权重的计算。</div>2019-10-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（0） 💬（4）<div>流量大了就扩容
流量小了就缩容
机器是租的吗？要不缩容的机器岂不是要闲置了？
另外就是线上的压测？不会对线上业务有影响嘛？是只有数据的读，没有写嘛？如果有写怎么控制不影响线上的真实数据？</div>2019-06-16</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/tArJBBE5vlf1lZia78ZlNoeyJyXoppvXOFUtEsOqETfiamWsH51asUox1amKAOGeSjU3kwyNkKFrZTeoY2ibddJ0A/132" width="30px"><span>滚键盘</span> 👍（0） 💬（0）<div>污染的问题 可以用影子表</div>2019-03-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/69/4d/81c44f45.jpg" width="30px"><span>拉欧</span> 👍（0） 💬（0）<div>可以设置两套监控体系，一个是针对集群的，另一个是针对单机的，对于单机的负载偏高问题，可以用一致性哈希等负载均衡的方式，把请求分配到负载偏低的节点</div>2018-10-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/69/4d/81c44f45.jpg" width="30px"><span>拉欧</span> 👍（0） 💬（0）<div>可以设置两套监控体系，一个是针对集群的，另一个是针对单机的，对于单机的水位偏高，可以用负载均衡的方式，把请求分配到水位偏低的节点</div>2018-10-30</li><br/>
</ul>