专栏上一期，我给你讲解了常用的客户端负载均衡算法，它帮我们解决了服务消费者如何从众多可用的服务节点中选取一个最合适的节点发起调用的问题。但在业务中经常还会遇到这样的场景，比如服务A部署在北京、上海、广州三个数据中心，所有的服务节点按照所在的数据中心被分成了三组，那么服务A的消费者在发起调用时，该如何选择呢？这就是今天我要给你讲解的服务路由的问题。

那么什么是服务路由呢？我的理解是**服务路由就是服务消费者在发起服务调用时，必须根据特定的规则来选择服务节点，从而满足某些特定的需求**。

那么服务路由都有哪些应用场景？具体都有哪些规则呢？

## 服务路由的应用场景

根据我的实践经验，服务路由主要有以下几种应用场景：

- 分组调用。一般来讲，为了保证服务的高可用性，实现异地多活的需求，一个服务往往不止部署在一个数据中心，而且出于节省成本等考虑，有些业务可能不仅在私有机房部署，还会采用公有云部署，甚至采用多家公有云部署。服务节点也会按照不同的数据中心分成不同的分组，这时对于服务消费者来说，选择哪一个分组调用，就必须有相应的路由规则。
- 灰度发布。在服务上线发布的过程中，一般需要先在一小部分规模的服务节点上先发布服务，然后验证功能是否正常。如果正常的话就继续扩大发布范围；如果不正常的话，就需要排查问题，解决问题后继续发布。这个过程就叫作灰度发布，也叫金丝雀部署。
- 流量切换。在业务线上运行过程中，经常会遇到一些不可抗力因素导致业务故障，比如某个机房的光缆被挖断，或者发生着火等事故导致整个机房的服务都不可用。这个时候就需要按照某个指令，能够把原来调用这个机房服务的流量切换到其他正常的机房。
- 读写分离。对于大多数互联网业务来说都是读多写少，所以在进行服务部署的时候，可以把读写分开部署，所有写接口可以部署在一起，而读接口部署在另外的节点上。
<div><strong>精选留言（18）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/7c/16/4d1e5cc1.jpg" width="30px"><span>mgxian</span> 👍（4） 💬（1）<div>配置中心配置路由之后也是需要下发的 那这和动态下发方式不是重复了吗 有什么主要区别呢</div>2018-10-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/9f/8e/45ffff8f.jpg" width="30px"><span>莲花</span> 👍（2） 💬（1）<div>如果通过路由尽量将访问限定在同一个数据中心，如果同一个数据中心访问满了，怎么分流到另一个数据中心去呢？</div>2018-10-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/9a/80/2bf8d7fc.jpg" width="30px"><span>宝爷</span> 👍（1） 💬（1）<div>用一个简单的路由规则，如果希望百分之一的用户体验新版本，将用户id取模100等于1的用户请求转发给新的服务器。验证后逐步扩大用户比例，最终达到全量。
这里有个问题想请教一下老师，用docker和k8s部署一个mysql的服务，如果这个服务可以弹性伸缩，且我们通过一个虚拟ip来连接这个服务，那么我的请求会按照k8s的负载均衡规则进行路由，我希望操作一个用户相关的请求，都到同一个数据库里面，不知道这个应该怎么操作。如果有多个服务，而且可以动态的增减，这里应该会碰到一堆的问题，如果老师有碰到类似的问题，这里想知道老师是怎么解决的。</div>2018-10-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4b/d4/b7719327.jpg" width="30px"><span>波波安</span> 👍（40） 💬（0）<div>我们现在处理的方式是先圈定一批友好用户作为灰度白名单用户。对于这一批用户在登录时会写特定的cookie标识，访问时ng根据cookie标识做路由策略。将请求分发到升级好的灰度集群，验证新功能。</div>2018-10-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/bd/99/851b0db6.jpg" width="30px"><span>ylw66</span> 👍（6） 💬（2）<div>老师好，Dubbo白名单和黑名单的例子有没有写反？</div>2018-12-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/59/66/39eeb3f9.jpg" width="30px"><span>Cain</span> 👍（4） 💬（0）<div>答：可以考虑使用statefulset+headless service的方式，使用k8s内部的dns，比如pod1.svc.com方式直接访问这个pod

用一个简单的路由规则，如果希望百分之一的用户体验新版本，将用户id取模100等于1的用户请求转发给新的服务器。验证后逐步扩大用户比例，最终达到全量。
这里有个问题想请教一下老师，用docker和k8s部署一个mysql的服务，如果这个服务可以弹性伸缩，且我们通过一个虚拟ip来连接这个服务，那么我的请求会按照k8s的负载均衡规则进行路由，我希望操作一个用户相关的请求，都到同一个数据库里面，不知道这个应该怎么操作。如果有多个服务，而且可以动态的增减，这里应该会碰到一堆的问题，如果老师有碰到类似的问题，这里想知道老师是怎么解决的。</div>2019-02-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/69/4d/81c44f45.jpg" width="30px"><span>拉欧</span> 👍（4） 💬（0）<div>可以通过网关配置规则，将特定的用户导流到某一数据中心，然后通过金丝雀发布升级这一数据中心的服务</div>2018-10-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/2b/2b/bebf6eed.jpg" width="30px"><span>酱了个油</span> 👍（2） 💬（0）<div>注册中心也可以管理访问的服务名单，这和服务路由有什么区别呢？是不是一般只是帮助服务重新路由注册中心？</div>2018-10-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ee/c6/bebcbcf0.jpg" width="30px"><span>俯瞰风景.</span> 👍（1） 💬（0）<div>服务路由的目的是为了实现某些特殊的服务调用，“特殊”体现在针对某些特定服务消费者的服务调用必须通过某些特定的服务提供者。

应用场景一般是：读写分离、机房隔离、灰度发布、白名单和黑名单、排除某个服务节点等。

服务路由规则可以存放在服务消费者的本地缓存中，为了方便管理，也会在配置中心统一管理；在同一维护的时候，一般会在服务治理平台修改规则然后同步到配置中心。消费者通过消费订阅的方式下拉最新的服务路由规则到本地缓存中。</div>2021-10-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/fd/58/1af629c7.jpg" width="30px"><span>6点无痛早起学习的和尚</span> 👍（0） 💬（0）<div>我司对服务路由的一个应用场景，sim 环境（准线上联调环境），有多套，比如 366、368，路由规则就是通过 traceid 染色，比如 s366 就是打到 sim366 环境</div>2024-05-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/96/a2/c1596dd8.jpg" width="30px"><span>🤔</span> 👍（0） 💬（0）<div>istio：https:&#47;&#47;istio.io&#47;latest&#47;docs&#47;tasks&#47;traffic-management&#47;request-routing&#47;#route-based-on-user-identity</div>2022-04-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c3/6a/3272e095.jpg" width="30px"><span>李春恒</span> 👍（0） 💬（0）<div>做的网关对于服务端api的灰度发布提供了两种分发策略。
一种是按比例流量切分，按照用户设备号。
一种是定点测试(多用于内部体验)，指定用户pin，用户设备号</div>2019-07-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（0） 💬（0）<div>我们是通过开关控制的，可以有不同的维度，我们主要以用户维度，四级地址维度，配送中心和仓库维度。和服务路由有差异，主要是通过流量路由到不同的业务逻辑分支里去处理了。</div>2019-06-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4b/d4/b7719327.jpg" width="30px"><span>波波安</span> 👍（0） 💬（0）<div>我们现在处理的方式是先圈定一批友好用户作为灰度白名单用户。对于这一批用户在登录时会写特定的cookie标识，访问时ng根据cookie标识做路由策略。将请求分发到升级好的灰度集群，验证新功能。</div>2018-10-14</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eo3DrWeV7ZwRLXrRZg4V3ic1LQYdZ3u1oicDhqPic47vMguvf5QS69roTiaJrwDr5Re3Sy2UyHDWwmsTA/132" width="30px"><span>大光头</span> 👍（0） 💬（0）<div>圈定用户需要路由规则能够识别用户ID或者某些标识，比如地区等。有了这个功能就能够做到圈定用户发布。
我现在的服务并没有服务路由功能，所以这些都是做到服务内部</div>2018-10-08</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eo3DrWeV7ZwRLXrRZg4V3ic1LQYdZ3u1oicDhqPic47vMguvf5QS69roTiaJrwDr5Re3Sy2UyHDWwmsTA/132" width="30px"><span>大光头</span> 👍（0） 💬（0）<div>首先圈定用户是根据用户的ID，那就需要根据用户ID进行路由。所以需要路由规则里要能够识别用户ID才能满足要求。</div>2018-10-08</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eo3DrWeV7ZwRLXrRZg4V3ic1LQYdZ3u1oicDhqPic47vMguvf5QS69roTiaJrwDr5Re3Sy2UyHDWwmsTA/132" width="30px"><span>大光头</span> 👍（0） 💬（0）<div>首先圈定用户是根据用户的ID，那就需要根据用户ID进行路由。所以需要路由规则里要能够识别用户ID才能满足要求。</div>2018-10-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/14/c4/e354d8ba.jpg" width="30px"><span>魏颖琪</span> 👍（0） 💬（0）<div>注册中心也可以根据路由规则进行过滤，将最终的api urls结果作为服务提供者告知消费者。当然前提是注册中心是自研可控。</div>2018-10-04</li><br/>
</ul>