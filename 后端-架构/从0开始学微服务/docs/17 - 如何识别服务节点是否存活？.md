今天我要与你分享如何识别服务节点是否存活，这在服务治理中是十分重要的。在进入正题之前，你可以先复习一下[专栏第5期](http://time.geekbang.org/column/article/14603)，我在讲解注册中心原理的时候，以开源注册中心ZooKeeper为例，描述了它是如何管理注册到注册中心的节点的存活的。

其实ZooKeeper判断注册中心节点存活的机制其实就是注册中心摘除机制，服务消费者以注册中心中的数据为准，当服务端节点有变更时，注册中心就会把变更通知给服务消费者，服务消费者就会调用注册中心来拉取最新的节点信息。

这种机制在大部分情况下都可以工作得很好，但是在网络频繁抖动时，服务提供者向注册中心汇报心跳信息可能会失败，如果在规定的时间内，注册中心都没有收到服务提供者的心跳信息，就会把这个节点从可用节点列表中移除。更糟糕的是，在服务池拥有上百个节点的的时候，每个节点都可能会被移除，导致注册中心可用节点的状态一直在变化，这个时候应该如何处理呢？

下面就结合我在实践中的经验，给你讲解几种解决方案。

## 心跳开关保护机制

在网络频繁抖动的情况下，注册中心中可用的节点会不断变化，这时候服务消费者会频繁收到服务提供者节点变更的信息，于是就不断地请求注册中心来拉取最新的可用服务节点信息。当有成百上千个服务消费者，同时请求注册中心获取最新的服务提供者的节点信息时，可能会把注册中心的带宽给占满，尤其是注册中心是百兆网卡的情况下。
<div><strong>精选留言（20）</strong></div><ul>
<li><img src="https://wx.qlogo.cn/mmopen/vi_32/Q3auHgzwzM4XjZjjDNic658J56twmLnFMmDy4iaD5qHvVKibT94tuoic6iaia9pRQia2zCCmakSJibRFHGiaiasEdiaGukWdw/132" width="30px"><span>pscj</span> 👍（7） 💬（2）<div>感觉静态注册中心就完全去中心化了，没有中心的概念了，每个peer自己判断节点的死活，自己维护一套状态表，是这个意思吧？</div>2018-11-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/bc/78/4d48f9ea.jpg" width="30px"><span>东风微鸣</span> 👍（1） 💬（1）<div>你好，我们目前在上的新系统，使用的spring cloud微服务架构，目前刚刚计划改为eureka主动探测机制，目前没听过有设置保护机制，那么如果网络真出问题了，是不是很有可能出现您说的那个注册中心网络占满的问题？</div>2018-11-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/cd/7a/6c9f436a.jpg" width="30px"><span>yan</span> 👍（0） 💬（2）<div>只通知10%的用户，那么另外的90%的用户是让他们失败吗？还是后续会再次通知，只是分批次，每次通知10%，知道全部通知完毕？</div>2018-10-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d4/c2/910d231e.jpg" width="30px"><span>oddrock</span> 👍（37） 💬（1）<div>应该以客服端为准，谁使用谁有发言权。
我觉得注册中心的主动心跳探测不应作为客户端摘除不可用服务端节点的依据，而是要作为参考值，比如将这种探测信息发给客户端，客户端在负载均衡时，将这种疑似问题节点降权重或作为备用节点，这样是不是比较好</div>2018-09-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/89/62/0777bf4f.jpg" width="30px"><span>xiaoxi666</span> 👍（19） 💬（2）<div>相对于动态注册，静态注册的方式把探测任务分散到了服务消费者，在增加服务消费者工作量的同时，再考虑一个问题：如果某个服务被多个消费者调用，那么该服务提供者会收到大量探测请求，但这是不必要的。所以我认为被大量业务依赖的公共的服务提供方应尽可能采用动态注册的方式。敬请指正。</div>2018-09-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0c/42/fbd028c2.jpg" width="30px"><span>feimeng0532</span> 👍（10） 💬（1）<div>开关或者保护，怎么检测到网络抖动？</div>2018-09-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4e/21/700586eb.jpg" width="30px"><span>王鸿运</span> 👍（4） 💬（1）<div>对于注册中心网络抖动问题，能否通过下面两种方法解决:
1.服务提供方定时上报心跳，注册中心进行ack确认，并且在ack中告知下次上报的时间间隔（该时间间隔为注册中心剔除节点最大不活跃时间的一半），如果服务提供方在超时时间后未收到ack，采用指数补偿策略进行重试上报n次（比如n＝3），这种重试的方式，有可能在网络抖动情况下，因此重试包网络风暴
2.双向探测，注册中心在节点达到剔除时间时，不直接剔除，而是进行主动探测n次（比如n等于3），探测几次还是失败，才剔除，然后通知订阅方更新</div>2019-01-14</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132" width="30px"><span>null</span> 👍（2） 💬（1）<div>动态注册中心：
“心跳开关保护机制”这种机制为了保护注册中心不被挤爆，但对服务消费者不太友善，也有可能会发生大面积消费者请求服务提供者失败的情况。当有 session_timeout 服务提供者节点被摘除时，只通知 10% 的服务消费者。

问题一：是每次随机取 10%，还是之前已通知的服务消费者就不再通知了？
问题二：如何监控判断网络是否频繁抖动，并且如何打开这个开关？


静态注册中心：
控制权反转，由服务消费者维护服务提供者的存活状态，服务提供者节点不再向注册中心汇报心跳信息。
注册中心不再维护服务提供者节点的心跳信息，只有消费者节点首次启动时，从注册中心拉取服务提供者节点信息，而后续便不再获取注册中心的提供者节点信息。即使消费者节点定时获取提供者节点信息，因为注册中心不维护提供者的心路信息，所以这些数据也是不可用的。

问题三：当有新的节点加入注册中心，或者需要从注册中心下线部分节点，服务消费者如何感知？

谢谢古月老师！爱你么么哒~</div>2018-09-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/42/76/256bbd43.jpg" width="30px"><span>松花皮蛋me</span> 👍（1） 💬（0）<div>我们公司是考虑动静结合的，这样添加节点也能主动推送给客户端</div>2019-02-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/7d/da/780f149e.jpg" width="30px"><span>echo＿陈</span> 👍（1） 💬（0）<div>如果使用静态注册中心，虽然很好的解决了网络波动问题，那新增服务节点……还需要人工更新配置，感觉不是很自动化啊。如果是动态注册中心，启动的节点会自动接入集群里，免配置，更方便……唉，要是动态配置中心能根据请求行为自动探测出网络问题做一些决策就好了哈哈，我想多了</div>2018-09-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/69/4d/81c44f45.jpg" width="30px"><span>拉欧</span> 👍（1） 💬（0）<div>当然要以服务消费端为准，服务消费者才是真实的调用方</div>2018-09-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ee/c6/bebcbcf0.jpg" width="30px"><span>俯瞰风景.</span> 👍（0） 💬（0）<div>注册中心是服务于远程调用的，在服务提供者和服务消费者之间建立正确的连接。

心跳开关保护机制：当网络连接出现抖动时，在注册中心摘除机制之下，注册中心会频繁更新服务提供者信息，导致服务消费者频繁请求注册中心获得最新的信息，造成网络带宽被打满，这种情况要设置一个开关，只通知一部分服务消费者进行服务信息变更，减少带宽压力。

服务节点摘除保护机制：在网络频繁抖动时，注册中心大量“误判”下线服务节点，造成服务节点不够用。这种情况要设置一个阀值，不允许下线超过指定阀值的节点。

静态注册中心：注册中心动态更新服务节点的方式被称作动态注册中心，与之相对的是静态注册中心。通过服务消费者自己去判断服务节点是否下线，这种方式准确率更高。在这种方式下，注册中心就变成了配置中心。</div>2021-10-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/64/9b/d1ab239e.jpg" width="30px"><span>J.Smile</span> 👍（0） 💬（0）<div>应该不是叫“”心跳开关保护机制吧？我觉得应该是变更通知保护开关才对，毕竟是不让注册中心通知过多的客户端嘛！</div>2020-11-11</li><br/><li><img src="" width="30px"><span>Geek_6ea8f7</span> 👍（0） 💬（0）<div>注册中心心跳检测和客户端摘除在主流的开源框架中是如何选择的？
这些框架中是否包含心跳开关保护和摘除保护的支持？
如果支持怎样修改配置？如果不支持要如何二次开发实现？
同时使用注册中心摘除和客户端摘除，二者信息不一致时，权衡的方案又该如何设计？</div>2020-01-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/fe/55/424faed7.jpg" width="30px"><span>满力</span> 👍（0） 💬（1）<div>你好老师！我记得服务提供者不可用了，是zk主动推送给消费端的吧，你这里说的是消费端主动去拉取</div>2019-07-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（0） 💬（1）<div>如果华夏村的村委会告诉张三李四去世了，但是张三去李四家拿东西又碰见了李四。
那么问题来了，李四到底死没死？张三开始了思考。</div>2019-06-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/9b/a7/440aff07.jpg" width="30px"><span>风翱</span> 👍（0） 💬（0）<div>应该以服务消费者的为准，做为服务消费者调用成功了，说明服务提供者是可以提供服务的。注册中心未收到心跳汇报，可能是与注册中心的网络连通性的问题，并不意味着服务提供者不可提供服务。</div>2019-05-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8c/5c/3f164f66.jpg" width="30px"><span>亚林</span> 👍（0） 💬（0）<div>以【服务消费者又调用这个服务节点成功】为准，因为服务提供者与注册中心之间通信不佳，可能是网络原因导致的。</div>2019-05-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4b/d4/b7719327.jpg" width="30px"><span>波波安</span> 👍（0） 💬（0）<div>老师，有个疑问，如果采用静态注册中心，那服务超时时间，重试次数这些服务配置信息的改变怎么及时通知到消费端呢？</div>2018-10-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/12/51/f309515c.jpg" width="30px"><span>冬末未末</span> 👍（0） 💬（0）<div>静态注册中心添加节点怎么自动推送给客户端呢？</div>2018-09-29</li><br/>
</ul>