你好，我是聂鹏程。今天，我来继续带你打卡分布式核心技术。

在开篇词中，我将分布式计算划分为了四横四纵。而在前面的文章中，我们已经一起学习了四横中的分布式计算、分布式通信和分布式资源池化三横的相关知识。比如，在分布式计算中，我们学习了分布计算模式，包括MapReduce、Stream、Actor和流计算的原理和实际应用；在分布式通信中，我们学习了远程调用、订阅发布和消息队列模式的原理和应用；在分布式资源池化中，我们学习了分布式系统架构和分布式调度架构。

相信通过对这些内容的学习，你已经对分布式技术有比较深刻的了解了。分布式系统处理的关键对象是数据，前面这些文章也都是为数据处理服务的。那么，数据本身相关的分布式技术有哪些呢？这就是接下来的几讲，我要带你学习的四横中的最后一横“分布式数据存储与管理”的相关技术。

在正式介绍分布式数据存储技术之前，我需要先带你了解一个基本理论，也就是CAP理论。前面提到，分布式系统处理的关键对象是数据，而数据其实是与用户息息相关的。CAP理论指导分布式系统的设计，以保证系统的可用性、数据一致性等特征。比如电商系统中，保证用户可查询商品数据、保证不同地区访问不同服务器查询的数据是一致的等。
<div><strong>精选留言（23）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/46/32/2bb481d2.jpg" width="30px"><span>Leo</span> 👍（6） 💬（4）<div>Redis不是AP么?
1. client 写数据到 master
2. master 告知 client “ok”
3. master 同步数据到 slave</div>2020-04-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/29/8c/3a810521.jpg" width="30px"><span>CaptainBerg</span> 👍（2） 💬（1）<div>cap中的a，是针对的“非故障节点”，作者这里说的“系统提供的服务一直处于可用状态，对于用户的请求可即时响应”，是不严谨的吧</div>2020-05-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/e9/86/d34800a4.jpg" width="30px"><span>heyman</span> 👍（1） 💬（2）<div>总感觉A和P是一样的…不知道怎么理解</div>2020-04-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/49/a5/e4c1c2d4.jpg" width="30px"><span>小文同学</span> 👍（1） 💬（1）<div>CAP 理论给分布式系统划了一道上限，最大的作用是告知每一个程序员，在研究一个分布式系统，或阅读分布式代码时，要清楚一个分布式系统的取舍，理解的过程中，也不要企图满足 CAP，因为这都是徒劳的，懂得在边界内做事和理解问题。</div>2020-04-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/99/3e/8a813e51.jpg" width="30px"><span>被歌唱拯救中</span> 👍（1） 💬（2）<div>对于弃CP保A有疑问，比如网络分区后，{北京，杭州}为分区a，{上海}为分区b，分区a可以进行下单（写操作），分区b应该也可以下单（写操作）的吧？假如不同分区都进行了写操作，网络恢复后，如何做数据同步呢？拿变量x举例好了，一个分区对x赋值为2，另一个分区赋值为3，数据同步就有冲突了，也不能单纯地以某一分区为准吧？</div>2019-11-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/f2/66/b16f9ca9.jpg" width="30px"><span>南国</span> 👍（0） 💬（2）<div>有一说一 redis是保证AP吧</div>2020-04-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/9b/6e/edd2da0c.jpg" width="30px"><span>蓝魔丶</span> 👍（0） 💬（2）<div>老师，例子中A，B，C三个服务器存储相同的库存数，怎么保证电吹风在北京仓库有 20 个，在杭州仓库有 10 个，在上海仓库有 30 个，比如北京的人来下单减库存，是否应该保证最多只能卖出20个，为什么要让他们看到的库存数一样，只让北京的人看到最多20个商品库存不行嘛？</div>2019-11-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/3b/47/f6c772a1.jpg" width="30px"><span>Jackey</span> 👍（16） 💬（4）<div>base理论其实是对cap中ap的一种补充和延展。它的软状态就是一种数据不一致的状态，base所说的最终一致性，也就是牺牲了一致性。我认为cap比较理想化，实际情况是网络都会有些延迟，无法保证强一致，所谓的“强一致”和“最终一致”只是对数据不一致时间的容忍度不同</div>2019-11-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/bc/25/1c92a90c.jpg" width="30px"><span>tt</span> 👍（4） 💬（0）<div>BASE理论中的BA是“基本可用”，不是全都可用，也不是全都不可用，而是功能的某些子集如核心功能可用；进一步，为了保证BA，就只能选择最终一致性E了，此时系统就处于了S状态即软状态。</div>2019-11-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/95/ab/c68452d4.jpg" width="30px"><span>dinuo2019</span> 👍（4） 💬（0）<div>听完这一讲，我有几个想法和问题：
1，在CP系统中，是不是也有利用分布式事务，在写入时阻塞直到满足条件才会提交，也就是用户1的写入请求不会被提交，直到恢复后才会写入成功；在这期间，根据隔离级别的设置，如果系统允许读，db1和db2都会返回为1；
2，BASE理论是AP系统的一种实现思想，在不满足强一致性的时候，以最终一致性作为代替；
3，kafka的数据本分replica，看到说是CA的系统，但kafka本身是分布式的系统，需要保留P，这里该如何理解？</div>2019-11-18</li><br/><li><img src="" width="30px"><span>Geek_f1edec</span> 👍（2） 💬（1）<div>上海的服务器是60个商品，那下单买60个下单成功还是失败？</div>2020-07-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ed/3e/c1725237.jpg" width="30px"><span>楚翔style</span> 👍（2） 💬（0）<div>cassandra LWT 需要一致性，是否违反cap理论</div>2020-05-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/11/4b/fa64f061.jpg" width="30px"><span>xfan</span> 👍（2） 💬（8）<div>前后后所矛盾。
举例中说明 ：分区容错性： 在满足分区容错性 P 的情况下，Server1 和 Server2 之间即使出现网络故障也不会影响 Server1 和 Server2 分别处理用户的请求。
但是在zookeeper中 形成两个分区后，只有大于集群一半数量的新分区才可以继续服务，小于一半的无法提供服务，然后也满足分区容错性，保CP 弃A ，
前后矛盾，不知道如何去理解。</div>2019-11-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/47/65/cce8eb34.jpg" width="30px"><span>nimil</span> 👍（2） 💬（0）<div>咱以后也能听懂大佬们谈cap了，嘿嘿</div>2019-11-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/20/b7/bdb3bcf0.jpg" width="30px"><span>Eternal</span> 👍（1） 💬（0）<div>

CAP是理论下的理想状态，因为分布式系统中网络故障问题是不可改变的一直存在，所以必须分区容错P必须保证；
然后在CA之间做取舍，但是实际情况是CA都想保证，但是又不能同时保证，最终妥协的事实标准BASE诞生，BASE同时
牺牲掉一些C（数据最终一致），牺牲掉一些A（服务基本可用，核心流程的系统可用，或者保证了业务的连续性），这样的
话系统可以理解为一种软状态。参考学习留言区的小伙伴的视角，数据的一致性：站在系统的角度是最终一致性，站在用户的角度
数据是强一致性。

本节课中老师讲ACID和CAP做一个比较，感觉挺好的，两个单独拿出来说可能大家都知道，但是将二者比较分析，我却一直没思考过。</div>2019-11-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/a3/4a/d3867ca2.jpg" width="30px"><span>徐小虾</span> 👍（0） 💬（0）<div>问下老师，保 AP 弃 C的方法中。如果正确的分区库存为0，错误的分区库存为1，那么此时用户在错误的分区下单，此时能下单成功吗。
我理解是先下单成功，然后后续数据同步后，告诉你订单无效？</div>2023-01-09</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/JkZibJWnxYvJj0PUfSEMYs7hHDSrcznZqrjryrAOWV2zOqLsiarJEQMgJibGOWOdpQicj4vlAZoqgMV3XGufNAL0lA/132" width="30px"><span>单升起</span> 👍（0） 💬（0）<div>很疑惑，在前面课程中我记得说redis是最终一致性的，怎么这里是CP了？</div>2022-08-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/bf/22/26530e66.jpg" width="30px"><span>趁早</span> 👍（0） 💬（0）<div>其实往往C和A没有一个明确的界限，比如mongodb，根据客户端驱动对CAP的权衡，可以让MONGODB成为CP或者AP，更多的取决于你的要求</div>2021-09-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/64/52/e4536e9c.jpg" width="30px"><span>涛子</span> 👍（0） 💬（0）<div>一致性的强调不同，cap理论的c是强一致性，节点在任何时候都要保证数据的一致性，而base理论的一致性是最终一致性，允许数据在某些时刻不一致，但是最终都会达到一致的状态</div>2021-07-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cf/2f/4f89f22a.jpg" width="30px"><span>李鑫磊</span> 👍（0） 💬（1）<div>Redis Cluster 是怎么保证 CP 的？</div>2020-07-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（0） 💬（0）<div>说一下自己的理解，当然，也是学习过阮一峰和华仔的课程之后的认知。
1：CAP这三个字母分别代表三个英文单词，用于描述分布式系统的特性，C代表数据一致性，A代表系统可用性，P代表网络分区容错性，网络分区表示断网了，不管什么原因，反正网络不通了，当没有网络分区的时候CAP是共存的，当发生网络分区时，三者只能选其二
2：理论上还是比较容易理解的，另外，也非常赞同评论区的一个观点，站在数据的角度数据强一致性是不存在的，就是单机也是不存在的，数据强一致性应该是用户视角看数据</div>2020-02-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7d/41/3c5b770b.jpg" width="30px"><span>喵喵喵</span> 👍（0） 💬（0）<div>打卡～</div>2019-12-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/34/df/64e3d533.jpg" width="30px"><span>leslie</span> 👍（0） 💬（1）<div>    其实CAP的取舍很多时候就很难：单一的数据库系统其实无法完全满足需求；这其实是为何现在分布式反而更多的引入了ACID的A的原因吧，其实常规的分布式CP哪怕弃A对比ACID的效果还是差一些；这大概是为何现在个人的感觉其实是分布式与传统模式相互交替以互补的形式存在生产系统的原因吧。</div>2019-11-18</li><br/>
</ul>