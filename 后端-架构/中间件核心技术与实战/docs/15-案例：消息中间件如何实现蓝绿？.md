你好，我是丁威。

我们这节课结合一个真实的生产环境案例，来看看消息中间件如何实现蓝绿发布。我们会提到消息中间件的设计背景和隔离机制，在此基础上探究基于消息属性和消息主题分别如何实现蓝绿发布。

## 设计背景

消息中间件在分布式架构体系中的应用非常广泛，要想实现蓝绿发布，只在微服务调用层面实现还远远不够。

在进行具体的方案设计之前，我们还是先来看一下我们这个项目中消息中间件的部署情况：

![图片](https://static001.geekbang.org/resource/image/e2/ce/e2d8a4b3611498142585fe52f5f5d9ce.jpg?wh=1920x778)

这里有四个应用，简单解释一下。

1. 应用1支持蓝绿发布，并且处理完业务后，需要向消息中间件中的topic\_A主题发送消息。
2. 应用2不支持蓝绿发布，但同样需要在处理完业务后，向消息中间件中的topic\_A发送消息。
3. 应用3不支持蓝绿发布，需要处理完业务逻辑后，向消息中间件中的主题topic-B发送消息。
4. 应用4中创建了两个消费组，其中consumer\_group\_a订阅topicA，支持接入蓝绿；而consumer\_group\_b没有接入蓝绿。

这就是在设计蓝绿发布方案之前，我们这个项目的现状。

## 消息中间件隔离机制

那么怎么基于这一条件来设计和实施蓝绿方案呢？这又涉及到一个隔离机制的问题。因为无论是蓝绿发布还是全链路压测，需要着重解决的一个问题就是消息的隔离性。蓝绿发布的本质就是对消息进行分类，蓝颜色的消息只能被蓝颜色的消费者消费，绿颜色的消息只能被绿颜色的消费者消费。
<div><strong>精选留言（2）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/ff/51/9d5cfadd.jpg" width="30px"><span>好运来</span> 👍（0） 💬（1）<div>我在公司实践时，消费者的蓝绿发布状态有下面三个值。所有： 表示该消费组未接入蓝绿。蓝：表示该消费组接入蓝绿，并且消息属性中未带颜色的消息由蓝环境的消费者进行消费。绿：表示该消费组接入蓝绿，并且消息属性中未带颜色的消息由绿环境的消费者进行消费。

这段话是不是有误，读起来逻辑不通。</div>2022-08-27</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEIvUlicgrWtibbDzwhLw5cQrDSy2JuE1mVvmXq11KQIwpLicgDuWfpp9asE0VCN6HhibPDWn7wBc2lfmA/132" width="30px"><span>a、</span> 👍（3） 💬（1）<div>1.可以，但是这么做会导致如果broker里有蓝绿消息的话，就会出现消息丢失,
2.基于主题的过滤机制，会导致broker里的主题数3倍增长，特别是如果用kafka的话，topic太多，会导致kafka性能下降</div>2022-10-19</li><br/>
</ul>