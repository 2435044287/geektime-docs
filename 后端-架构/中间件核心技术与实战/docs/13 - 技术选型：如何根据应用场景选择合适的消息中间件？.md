你好，我是丁威。

随着微服务技术的兴起，消息中间件也成为了分布式架构体系的必备组件，所以从这节课开始，我们一起来学习消息中间件。

我们的课程还是会将理论和实践相结合，将重点落在实战。

我会分别介绍消息中间件的应用场景与技术选型、两种消息中间件（Kafka和RocketMQ）分别是如何实现高性能的。紧接着，我会结合自己的工作经验，带你看看消息中间件如何实现蓝绿发布、如何提升RocketMQ顺序消费能力；最后，我们会一起认识消息中间件优雅的生产环境运维能力，搞清如何排查消息发送、消息消费相关的故障。

我们这节课主要来看消息中间件应用场景与技术选型。

## 消息中间件的应用场景

消息中间件的应用场景主要有两个：异步解耦与削峰填谷。

我们首先通过电商平台用户注册送积分、送优惠券这个场景来理解异步解耦合。如果不使用消息中间件，电商平台送积分的实现也许是下图这个样子：

![图片](https://static001.geekbang.org/resource/image/bf/72/bf2a3604606fd02yy21092052d7a6a72.jpg?wh=1920x1070)

我们简单看一下这个流程。

1. 用户在网站前端注册页面填写相关信息，然后调用账号中心服务，注册账号。
2. 账户中心首先执行用户注册逻辑处理（例如判断用户是否已注册、是否符合注册条件等），然后写入到数据库。
3. 注册成功后，需要调用积分中心（赠送积分接口）给用户送积分。
4. 送完积分后，再调用优惠券相关接口，为用户赠送优惠券。
5. 成功送完积分、优惠券后，向用户返回“注册成功”。
<div><strong>精选留言（7）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/14/2f/2d/dce49b2b.jpg" width="30px"><span>浅qian的痕迹</span> 👍（8） 💬（1）<div>带来的问题和解决办法：
1. 系统可用性会降低
比如：MQ挂掉了
解决方案：MQ集群部署，提高可用性

2、系统复杂性提高
加入MQ，需要考虑消息重复消费、保证消息不丢失、保证消息有序等问题
数据丢失解决方案：
生产端丢失：设置MQ给生产者合理的ACK方式
MQ服务端的数据丢失：比如同步刷盘，牺牲部分性能
消费端数据丢失：同步消费，不在多线程里面消费
3、一致性问题
下游服务消费消息异常，可能导致上下游服务里的数据不一致
解决办法： 可以重复消费，错误报警，对账或者手动修复</div>2022-07-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/62/b8/0e1b655e.jpg" width="30px"><span>fireshort</span> 👍（1） 💬（1）<div>“如果公司或团队的技术栈以 Golang 为主，建议选择 RabbitMQ”？这里搞错了，RabbitMQ用的是Erlang。</div>2022-11-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/20/22/a0/d8631910.jpg" width="30px"><span>Y a n g</span> 👍（1） 💬（1）<div>带来的问题
数据一致性问题，如果用户注册和发mq消息都在账号中心同一方法内处理，那么很难保证数据的一致性。举例 用户注册写库时未提交数据库事务失败，此时mq消息已发出，再或者下游消费异常，导致数据不一致
解决方法：做分布式事务</div>2022-07-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/6b/e9/7620ae7e.jpg" width="30px"><span>雨落～紫竹</span> 👍（3） 💬（0）<div>第一 kafka 被称为分布式实时流计算平台 他比其他mq 应该很适合处理这种低延迟的场景 第二 kafka说 丢消息不是它的问题 这锅它不背 第三 确保端到端的稳定和消费 确保不会因为服务导致重启（对于强需求而言 消费端必须手动ack ）第四 随着系统增多 复杂性增高 有必要增加链路追踪服务 将每一步的消息或者重要逻辑处理结果放到追踪服务 方便排查问题</div>2022-07-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/6b/e9/7620ae7e.jpg" width="30px"><span>雨落～紫竹</span> 👍（1） 💬（0）<div>还有 老师 你上面那个流程图 我实在想不出来 为什么 开始就做成异步了 结果又出来两个rpc  无论是在技术上还是业务上</div>2022-07-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/d6/46/5eb5261b.jpg" width="30px"><span>Sudouble</span> 👍（0） 💬（0）<div>从用户角度看：当消息中间件中的处理发生了延迟的情况下，而用户注册后又要立马查看积分信息时，会出现不可用&#47;信息异常的情况。</div>2023-05-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ba/e4/6df89add.jpg" width="30px"><span>芋头</span> 👍（0） 💬（1）<div>1.可用性  引入的初衷就包含削峰填谷、解耦整体上提升系统可用性，如果这个环节脆弱也会降低可用性，解决方案：集群及持久化措施
2.复杂性：如何确保消息不丢失、顺序消费、不重复消费都是需要考虑的问题  解决方案：不重复消费可以通过业务幂等性来保证
3.一致性：由于消费存在延迟，如何解决不一致性？待学习</div>2023-03-26</li><br/>
</ul>