你好，我是丁威。

定时调度框架的应用非常广泛，例如电商平台的订单支付超时被取消时，数据清洗时等等。在中间件应用领域，定时调度框架通常和MQ等中间件组合使用，联合完成分布式环境下事务的最终一致性。

这节课，我们就一起来看看定时调度框架在消息发送领域的事务一致性设计方案和落地细节。

## 设计方案

不知道你还记不记得我在[第13讲](https://time.geekbang.org/column/article/540810)中提到的用户注册优惠活动的场景，为了实现用户注册主流程与活动的解耦合，我们引入了消息中间件，它的时序图如下所示：

![图片](https://static001.geekbang.org/resource/image/a7/10/a7fbfeec5964d217dyy47144fab89510.jpg?wh=1920x968)

这里的核心指导思想是让账户中心完成用户的注册逻辑，将用户写入到账户中心数据库，然后发送一条消息到MQ服务器，再给返回用户“注册成功”。之后，引入两个消费者，分别对消息进行对应的处理，异步赠送优惠券或者积分。

这个方法的架构思路非常不错，但是我们还不得不思考一个问题：如何保证写入数据库与消息发送这两个步骤的一致性呢？我们希望这两个步骤要么一起成功，要么一起失败，绝不能出现用户数据成功写入数据库，但消息发送失败的情况。因为这样用户无法收到优惠券，容易产生一系列的投诉和纠纷。

这其实是一个分布式事务的问题，也就是要保证数据库写入和消息发送这两个分布式操作的一致性。

一种比较常见的解决方案就是：“本地消息表+定时任务”。
<div><strong>精选留言（2）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/13/db/26/54f2c164.jpg" width="30px"><span>靠人品去赢</span> 👍（1） 💬（0）<div>要是能像前者选型的那种，比较一下市面比较流行的elasteic job，xxl-job，Schedulerx这些框架。可能接着zookeeper，顺便选型定了ElasticJob。</div>2023-03-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/46/33/e5ee1842.jpg" width="30px"><span>酱紫的小白兔</span> 👍（0） 💬（0）<div>如何评价 powerjob 这个新框架？</div>2022-12-08</li><br/>
</ul>