你好，我是文强。

这节课我们继续来讲消费端，上节课我们学习了消费模型的选择和分区消费模式设计，这节课我们将学习剩下的三部分，也就是消费分组（订阅）、消费确认、消费失败处理。

## 消费分组

消费分组是用来组织消费者、分区、消费进度关系的逻辑概念。为什么需要消费分组呢？

在没有消费分组直接消费Topic的场景下，如果希望不重复消费Topic中的数据，那么就**需要有一个标识来标识当前的消费情况，比如记录进度。**这个唯一标识就是消费分组。

在一个集群中可以有很多消费分组，消费分组间通过名称来区分。消费分组自身的数据是集群元数据的一部分，会存储在Broker的元数据存储服务中。消费分组主要有管理消费者和分区的对应关系、保存消费者的消费进度、实现消息可重复被消费三类功能。

消费分组和Topic是强相关的，它需要包含Topic才有意义，一个空的消费分组是没有意义的。如下图所示，消费分组内有很多个消费者，一个消费分组也可以订阅和消费多个Topic，一个Topic也可以被多个消费分组订阅和消费。

![](https://static001.geekbang.org/resource/image/77/52/77e59yy3fc26de63c6f6dea701a75252.jpg?wh=10666x6000)

因为 Topic 不存储真实数据，分区才存储消息数据，所以就需要解决消费者和分区的分配关系，即**哪个分区被哪个消费者消费，这个分配的过程就叫做消费重平衡（Rebalance）**。
<div><strong>精选留言（2）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/14/28/43/5062a59b.jpg" width="30px"><span>shan</span> 👍（1） 💬（0）<div>消费者客户端SDK设计总结

消费分组
通过消费者分组可以管理消费者消息的消费，一个集群中可以有很多消费组，消费者相关的元数据信息会保存在Broker的元数据存储服务中。
一个消费组可以订阅多个Topic，一个Topic也可以被多个消费组订阅和消费。

消费重平衡（Rebalance）
一般会为每个消费者分配对应的消息队列，这个分配的过程叫做消费重平衡（Rebalance），协调者的工作就是执行消费重平衡。以下两种方案：
（1）协调者进行分配：协调者内部完成消费重平衡之后，将分配结果同步给所有消费者；
（2）在消费者端完成：不需要协调者，每个消费者在自己本地进行消费重平衡，RocketMQ在5.0之前采用的就是这种方式；

一般消费者发生变化（上线或者下线）&#47; Topic分区&#47;队列发生变化的时候，会触发执行消费重平衡。

分配策略
分区&#47;消费队列的分配策略一般有以下几大类：
（1）轮询，将分区&#47;队列排序，按顺序依次分配给各个消费者，如果分区&#47;队列数量与消费者数量不均衡，有可能出现某个消费者分配过多或者有些消费者没有队列可以分配的情况，导致负载倾斜；
（2）粘性：尽量减少分区分配关系的变动，从而减少重平衡所耗费的时间和资源损耗；
（3）自定义分配策略；

RocketMQ在5.0以前按队列粒度分配给消费者，主要有以下几种策略：
（1）平均分配策略；
（2）平均轮询分配策略；
（3）一致性hash分配；
（4）根据配置进行分配；
（5）根据机房分配；
（6）优先分配同机房策略；
Rocket5.0以后可以按照消息粒度，将消息直接分配到消费者消费，具体可以参考官方文档：
https:&#47;&#47;rocketmq.apache.org&#47;zh&#47;docs&#47;featureBehavior&#47;08consumerloadbalance

消费确认
消息消费完毕之后，需要向服务端发送ACK，服务端一般有两种方式处理消费后的消息：
（1）删除数据：每条消只能被消费一次，这种方案一般很少采用；
（2）保存消费进度：服务端保存每个队列的消费进度（一般会按消费者划分），数据的删除交由过期策略执行，消息队列大多数采用的就是这种方案；</div>2023-09-23</li><br/><li><img src="" width="30px"><span>Geek_368613</span> 👍（0） 💬（0）<div>“通过消费分组的名称计算出来一个 hash 值和 __consumer_offset 的分区数，取余计算得出一个分区号”，请问下文强老师，这个计算的操作是由谁来完成的呢？</div>2023-07-19</li><br/>
</ul>