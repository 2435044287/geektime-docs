你好，我是文强。

近几年，多个知名互联网平台都出现过服务长时间不可用的情况，原因有机房断电、网络电缆中断等。对于我们业务侧来说，我们需要保证业务在任何情况都能正常运行，即服务自身拥有容灾能力是基本要求。

而消息队列作为基础组件，容灾是它的基本能力。所以这节课我们将会详细讲一下消息队列集群在发生异常时如何做好容灾，以及异常时如何保证数据不丢失。

## 容灾能力的理论基础

我们先来看一些容灾相关的基础理论知识点。

**当系统发生这些异常时，服务能够自动切换并正常运行就是我们说的容灾**。下面盘点几个常见的故障场景。

![](https://static001.geekbang.org/resource/image/78/c3/78685dac13835fe3999aa816yy68b4c3.jpg?wh=1854x1174)

为了完成容灾，从技术上来看，容灾行为可以在集群内或者集群间完成。所以容灾可以分为集群内容灾和集群间容灾两种类型。接下来我们详细了解一下这两种类型。

### 集群内和集群间容灾

先来看下图，这是一个同时具备跨可用区和跨地域容灾特性的集群架构。

![](https://static001.geekbang.org/resource/image/d0/d9/d07dabc51c22cb85fd6d3372bd720bd9.jpg?wh=10666x6000)

如上图所示，有主备两套集群。这两套集群分别部署在上海和广州，且这两套集群都是跨可用区部署的。所以当某个节点、某个机架、某个可用区发生故障时，可以通过主从切换来恢复服务。当某个地域故障时，也可以通过主备切换来恢复服务。

集群内容灾主要靠**主从切换**来达到容灾效果，集群间容灾主要靠**主备集群**切换达到容灾效果。从部署形态来看，这两种容灾方式，都可以是跨机架、跨可用区、跨地域部署的形式。