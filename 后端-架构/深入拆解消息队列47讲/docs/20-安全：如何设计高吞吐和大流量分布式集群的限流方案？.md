你好，我是文强。

上节课讲了网络隔离、传输加密、认证、鉴权，今天我们继续讲消息队列系统安全的第二部分：数据自我保护和服务自我保护。

![](https://static001.geekbang.org/resource/image/05/36/05ececaa48cd53814c75a0fd5d036436.jpg?wh=3228x1488)

数据维度的自我保护主要指如何保证服务端数据的安全，不被窃取。服务维度的自我保护主要指集群的限流机制，通过限制客户端的流量、请求、连接等保护自身不被击垮。

我们先来看一下如何保证存储的数据不会被第三方窃取。

## 集群中的数据加密

如果你从事金融或证券领域，因为企业的数据比较重要，应该经常会问：发送到消息队列中的数据能不能加密后再存储？

这个问题希望达到的效果是：当客户端发送消息A（比如 hello world）到Broker，Broker保存到磁盘的数据是一串内容A加密后的字符串，当消费端消费数据时，Broker 将加密后的字符串解密成消息A返回给消费端。

![](https://static001.geekbang.org/resource/image/4a/f3/4a3d3348afb76855fd1993333bf446f3.jpg?wh=10666x6000)

在业务看来，数据加密配合传输加密、认证、鉴权等机制，在数据的安全性上是非常强的。

**要实现这个效果一般有以下两种方案：**

1. 第一种就是上面说的，由服务端自动化做好加密解密。工作量全在服务端，客户端没有任何工作量。
2. 第二种是客户端在生产的时候自助做好加密逻辑，在消费的时候自助做好解密操作。好处在于消息队列服务端没有任何工作量，坏处在于工作量全部在客户端，所有的客户端和消费端都需要感知加密的逻辑，在编码和协调各方的成本方面较高。
<div><strong>精选留言（2）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/14/6b/18/cebd9dbc.jpg" width="30px"><span>Stark</span> 👍（0） 💬（0）<div>如果是消息量超出了消费者的能力，那么消费者自己也要做限流，这种一般应该控制拉取的消息量即可，消费完再Pull。</div>2024-11-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cb/92/cfc1cfd3.jpg" width="30px"><span>贝氏倭狐猴</span> 👍（0） 💬（1）<div>老师您好，关于全局限流问个问题。如果均摊总限流数到各个broker，会导致发生限流时总流量低于总阈值，因为broker之间的流量可能是不均衡的。而且如果只是简单均摊的话，也不需要redis等中间存储介质了。</div>2023-08-05</li><br/>
</ul>