你好，我是文强。

今天我们讲可观测性的第三部分：跟踪（Traces），在消息队列领域，Traces通常被称为消息轨迹，意思是消息在系统中的运行轨迹。消息轨迹在业务消息方向是刚需，因为业务消息如果出现丢失，大概率会导致流程异常。

比如订单的快递运送流程没有正确处理一条订单号的消息，后续就会出现无法跟踪这个订单派送的问题。如果你负责过消息队列基础服务的日常值班，一定会经常接到用户反馈说消息丢了，想让平台查清楚为什么丢了。这个问题，你会怎么排查呢？

如果想排查清楚，我们首先要搞清楚有没有丢，如果丢了，还要搞清楚是哪一个环节丢的。想弄清楚这两个问题，就必须有消息轨迹的功能。那我们今天就来讲一讲消息轨迹功能怎样设计。

## 丢消息是怎么回事？

到底什么是“丢消息”？你的第一印象是不是服务端把我的消息弄丢了。其实在消息队列里面，丢消息没这么简单。

从广义上来讲，消息队列的丢消息是指生产了一条消息，但是预期中的消费者却没有消费到这条消息。但是这个过程，不是只有一种服务端弄丢了消息这一个场景。我们结合消息的生命周期，来看看可能有哪些情况。

![](https://static001.geekbang.org/resource/image/2d/a3/2d492a43d228fa836f49aee8cbcdc2a3.jpg?wh=10666x4162)

- 生产消息失败，生产端把消息写入到服务端时失败了，这时有可能是服务端有异常，也有可能是消息的内容或格式不符合规范，比如太长了。
- 消息设置了延时属性，消息进入了延时队列后，没有在定义的延时时间内出队列，从而没有在特定的时间执行，错过了消息的有效处理时间，被业务抛弃。
- 消息在服务端存储完成后，因为服务端一致性算法（强一致、最终一致）的设定问题，或者异步刷盘、服务端重启、消息截断之类的行为，导致持久化的消息丢失了。
- 一般消息队列的消费模型是根据Offset来定位消费位点或者重置消费位置的。如果消费端设置了错误的位点，比如下一条应该消费位点100的消息，但消费端因为异常忽略了100，直接从101开始消费。从服务端的角度，100的消息就没有被消费过，而消费者看来，100的消费就是没被消费到，此时从消费端的视角，消息就是丢失了。
- 当消费端拉到消息后，如果业务处理有异常，经过了多次处理后依旧失败，消息进入了死信队列，除非业务配置了订阅消费死信队列的消息，否则这条消息的生命周期就算结束了。此时消费端还是没有消费到消息，消息可以算丢失了。
<div><strong>精选留言（1）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/1a/eb/3e/cf924a6d.jpg" width="30px"><span>fjr</span> 👍（0） 💬（0）<div>老师您好，kafka是如何实现消息轨迹得，现在单条消息得回溯比较麻烦，需要将生产端，broker，消费端各端得信息聚合在一起，这个业内有实现得案例可以分享么</div>2023-09-13</li><br/>
</ul>