你好，我是文强。

在功能篇，我们分析了消息队列中多个主要功能的技术实现。从这节课开始，我们将结合**云原生**、**Serverless**、**EDA（Event-driven Architectures）**、**存算分离**、**分层存储**、**数据集成**等一些业界较新的技术架构理念，来讲一下消息队列如何与这些架构理念结合，以及结合后会具备哪些实际价值。

这节课我们就重点学习一下消息队列的存算分离架构。

## 什么是存算分离架构

首先，你得清楚什么是存算分离架构。

存算分离中的“存”是指存储层，“算”是指“计算层”。简单理解“计算”就是功能相关的实现，“存储”是指数据落地持久化存储。消息队列中的存储层是指包括存储结构设计、消息存储格式、数据分段等具体的数据存储功能。计算层是指包括协议解析、事务消息、延时消息等主要消耗计算资源（如CPU）的功能模块。

跟存算分离相对的是存算一体，“分离”和“一体”是指计算层和存储层是否在一台机器上。

如下图所示，这是存算一体的消息队列的架构。从单机维度看，计算层和存储层都在同一个Broker中，由多台Broker组成一个集群。我们在[第15讲](https://time.geekbang.org/column/article/677936)讲过有状态服务和无状态服务，这种存算一体的架构就是典型的有状态服务。

![](https://static001.geekbang.org/resource/image/d2/cf/d2c96dyy4acde2c581df15b1yy40edcf.jpg?wh=10666x4990)

存算一体架构的最大特点就是计算层和存储层没有明显的界限，从代码层面上看，计算层和存储层交互的操作就是文件的读写，比如我们在[第06讲](https://time.geekbang.org/column/article/672152)讲到的FileChannel.write、FileChannel.read。 它的主要优势是架构简单、开发实现成本较低。缺点是它是一个有状态服务，无法快速弹性地扩容。
<div><strong>精选留言（1）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/14/28/43/5062a59b.jpg" width="30px"><span>shan</span> 👍（1） 💬（0）<div>总结
存算分离
存算分离指的是计算层和存储层分离架构，分开部署，计算层指消耗计算资源的功能模块，存储层指的是数据存储相关功能，在存算分离架构下，通常计算层需要使用存储层提供的SDK将数据写入存储层。
存算分离架构可以更好的适应云原生，进行动态扩容、弹性伸缩等。

存储层引擎
（1）对象存储：各个云厂商提供的商业化对象存储服务，如AWS的S3、腾讯云COS；
优点：局部分布式可靠存储能力、存储成本低。
缺点：读写方式不够灵活，流式读写性能较低，难以在大规模实时流数据场景中使用。

（2）分布式存储：一些专门提供分布式数据存储的组件，如HDFS、BookKeeper等；
优点：具体分布式存储能力，读写性能较高。
缺点：存储集群本身有一定稳定性和可靠性。

（3）虚拟云盘：云厂商提供在线云盘服务。
优点：支持分布式可靠存储能力。
缺点：云盘需要绑定节点，同一时间只允许一台Broker写入数据到云盘。

一般选用分布式存储方案，读写性能高，并且会提供多语言的流式写入API。如Pulsar的存储层使用的是BookKeeper。

主流存算分离架构MQ
RocketMQ 5.0之前是存算一体，功能都在Broker上，在5.0之后，往存算分离架构方向演化。Pulsar一开始设计就是存算分离的架构。
1. RocketMQ 5.0架构
RocketMQ 5.0在原先Broker集群基础上增加了Proxy层，生产者和消费者可以通过Proxy层将转发请求到Broker中，不过当前Proxy层中并没有计算的逻辑，计算存储逻辑还是在Broker中，所以并不算真正意义上的存算分离。

2. Pulsar架构
Pulsar选用了Apache BookKeeper作为存储层引擎，Bookeeper设计的初衷就是用来高性能地存储分布式流日志的，具备流式读写的能力，写入读取性能较高，具备分布式存储特性。
客户端生成消费请求，首先发送到Broker中，Broker负责处理计算逻辑，然后再通过与Bookeeper交换进行数据的读写，实现存算分离。

存算分离架构，计算层实现弹性关键点：
（1）Topic可以快速迁移，不需要进行消息数据搬迁；
（2）系统可以自动化均衡迁移，不需要人工介入；
（3）迁移过程快速，对集群没有影响；
</div>2023-09-25</li><br/>
</ul>