你好，我是庄振运。

从今天开始，我们进入新的模块：性能工程实践。在这一模块中，我会讲述在实际生产环境中应用性能工程的场景、案例。这些场景和案例都是针对大规模互联网服务，是在解决实际性能问题后总结的经验。

今天我要讲的主题是“在生产环境中进行真实场景的压力测试”。这来源于我对LinkedIn公司生产实践的总结。

LinkedIn为超过5.9亿用户提供服务，在性能优化的过程中，经常会遇到这类问题：一个服务可以承受的最大QPS是多少？要满足100K QPS的服务需求，我需要多少服务器？……

怎么解决这些问题呢，有一个大招就是在生产环境中进行真实的容量测试。

关于这个实践的详细方案和技术细节，我们曾经发表过一篇研究论文（[IEEE ICWS](https://ieeexplore.ieee.org/document/8029816)），并且很荣幸地获得了IEEE最佳论文奖，推荐你去读一读。

今天我就带你从这个场景的源头出发，一步步探索到最后的具体落地方案。

## 为什么需要在生产环境中进行容量测试？

既然我们要解决一个具体的问题，那我们一定要先问个“为什么”。

为什么要在生产环境中进行容量测试呢？要回答这个问题，我们还得再往前追问，为什么说真实的容量测试很重要呢？

我想这个问题不难回答，你应该已经有自己的答案了。

我们都知道，一个在线互联网公司的存活和发展，靠的是它提供的互联网在线服务，自然也就依赖于这些服务的性能和稳定性。要保证每个服务都能够稳定地运行，我们必须为之提供足够的服务容量，比如适当数量的服务器。
<div><strong>精选留言（9）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/4d/fd/0aa0e39f.jpg" width="30px"><span>许童童</span> 👍（2） 💬（1）<div>有个问题，生产环境流量不多或者根本就没有流量，这个时候怎么办呢？</div>2020-01-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/75/dd/9ead6e69.jpg" width="30px"><span>黄海峰</span> 👍（1） 💬（1）<div>“模仿实现一个一点也不难”。。。我被高估了，后面加餐希望多点技术细节介绍</div>2020-01-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/1b/2f/96cd2f51.jpg" width="30px"><span>lewis99</span> 👍（0） 💬（1）<div>你好，有个疑问：服务中有不同的接口，每个接口性能是不一样的，那是要针对每个接口进行容量规划和流控吗？</div>2020-03-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（0） 💬（1）<div>看评论回答是直接引流而非复制，有几个问题？
1：为什么不复制流量呢？
2：线上直接引流，线上的流量有峰谷之分，是否只针对峰流来测试？
3：流量不够，人工模拟，针对这种流量还需要拦截，不让响应吧？这个怎么做的？此时数据也会失真嘛？
4：如果针对淘宝或京东，这种大促时的流量评估，因为是发生在未来的，这种直接引流的方式，流量应该是不足的，这种怎么来弄？还是人工模拟吧？

😁
我们主要是各条线线下性能压测＋全链路线上憋单压测两者结合。</div>2020-03-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/ec/50/fc9b338e.jpg" width="30px"><span>海华(海菜)</span> 👍（0） 💬（1）<div>zhenyun老师，有几个细节问题：
1. 重定向流量是克隆流量还是直接也响应生产请求，响应生产请求意味着这个系统也是生产一部分
2. SUT应该是固定的容量例如N，如果迁移M%的流量过去导致容量达到预警&#47;瓶颈，就意味着线上容量需求是 N &#47; (M&#47;100)（例如SUT容量是5个服务单位，迁移5%流量导致，意味着线上应该用5&#47;0.05 = 100）是吗？

感谢</div>2020-02-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/79/84/c7c0435b.jpg" width="30px"><span>徐豪</span> 👍（2） 💬（0）<div>这一块国内一般称之为『全链路压测』，我也设计主导过，采用的基于日志的流量回放方式</div>2020-04-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/64/08/0287f41f.jpg" width="30px"><span>争光 Alan</span> 👍（0） 💬（0）<div>测试单机性能估算总的资源和性能关系也有疑惑
单机和分布式系统还是差异比较大的，从单机扩到两台的时候就会有比如分布式锁，某个服务特别忙，数据库扩后跟不上等等，感觉从单点轮到1k差异会更大
这一块一般是怎么处理？</div>2023-02-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/64/08/0287f41f.jpg" width="30px"><span>争光 Alan</span> 👍（0） 💬（0）<div>真实流量感觉差异会比较大，比如活动，热点事件，都会导致某个特定场景的请求链路流量方大，这一块怎么把控测试结果就能支撑目标qps呢？

还有个疑惑：比如我要做个活动，预计100kqps，线上感觉搞不到数据(活动还没开始)


</div>2023-02-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/64/08/0287f41f.jpg" width="30px"><span>争光 Alan</span> 👍（0） 💬（0）<div>如果这么压测的话，比如测试结果很差，怎么分析原因呢</div>2023-02-01</li><br/>
</ul>