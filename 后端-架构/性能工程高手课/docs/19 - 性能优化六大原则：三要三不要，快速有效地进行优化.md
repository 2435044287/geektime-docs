你好，我是庄振运。

今天我们进入了专栏的新模块：性能优化。在这个模块里，我会先从“性能优化的六大原则”开始讲起，然后再为你讲解实践中普遍采用的十个性能优化策略，并且分别针对CPU、系统、存储以及跨层这几个领域，讲讲具体的优化案例。

我们今天先探讨性能优化的原则。在讲具体原则之前，我想先给你讲一个有趣的往事。

我曾经负责过一个存储服务的性能优化和容量效率。那个服务的容量需求很大，但它的最大性能瓶颈不是CPU，而是存储的空间。

所以，虽然有很多人给我们各种建议，让我们花时间做CPU优化，我都尽量挡了回去。因为我知道CPU不是最大问题，所以坚持不懈地通过各种途径优化数据大小，甚至以牺牲CPU为代价。最后的结果很好，大幅度地降低了那个服务的容量需求。

在这个性能优化的场景，我们遵循了一个原则，那就是**优先优化最大性能瓶颈**。这其实就是马上要讲到的“三要”原则中的第一个。

## 性能优化的原则概述

在实际的性能优化中，我们需要考虑的因素很多，也经常需要在多个角度和目标间做一些平衡和取舍。为了帮助你把握这些，我个人总结出了六条原则，我把它们概括为：“**三要，三不要**”。

![](https://static001.geekbang.org/resource/image/bc/bb/bc08d73063d641b231db155d7ffe26bb.jpg?wh=2622%2A1474)

- 三个“要”原则是：要优先查最大的性能瓶颈，性能分析要确诊性能问题的根因，性能优化要考虑各种的情况。
- 三个“不要”的原则是：不要做过度的、反常态的优化，不要过早做不成熟的优化，不要做表面的肤浅优化。
<div><strong>精选留言（5）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（0） 💬（1）<div>老师的这种讲法或思维是结果性的，具体怎做的会有详细介绍嘛？</div>2020-03-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/6e/55/8c2c83f4.jpg" width="30px"><span>Wang</span> 👍（0） 💬（1）<div>庄老师，近期在验证tomcat 8 在NIO和APR两种模式下的性能差异。理论上APR在高并发的情况下性能更好一些，但是我验证的结果却是NIO的性能更好（同样的并发线程数，NIO模式的吞吐量更高，相同的吞吐量，系统的资源利用率相差并不大）。代码中只是设置了等待20或200ms然后打印输出字符，无任何逻辑。有些迷茫求庄老师帮忙分析一下，多谢🙏</div>2020-01-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/99/4a/bdf26d5c.jpg" width="30px"><span>石头汤</span> 👍（0） 💬（0）<div>“反常态优化” 我觉得是 为了优化改变了代码逻辑的结果，而且很隐晦。
例如 f(x)=y, 被优化成了 f(x) = y 或 y1。
业务层写着同步的调用，底层被优化成了 异步，导致 有时 读行为 有时有数据，有时无数据;
业务层一个写着 non null 的变量，底层做内存优化，底层在运行期 在某些时候设置成 null, 导致线上各种偶现随机崩溃，但是看业务层的代码逻辑是没问题的。 </div>2024-04-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/b4/94/2796de72.jpg" width="30px"><span>追风筝的人</span> 👍（0） 💬（0）<div>三个“要”原则是：要优先查最大的性能瓶颈，性能分析要确诊性能问题的根因，性能优化要考虑各种的情况。
三个“不要”的原则是：不要做过度的、反常态的优化，不要过早做不成熟的优化，不要做表面的肤浅优化。
优先 优化 系统最大的性能瓶颈</div>2022-07-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/ee/0f/e8d0d8cc.jpg" width="30px"><span>lazytortoise</span> 👍（0） 💬（0）<div>六个原则都挺重要的，做过度的、反常态的优化有感，盲目自信，用力过猛，影响范围增大，反而会影响业务。</div>2021-05-05</li><br/>
</ul>