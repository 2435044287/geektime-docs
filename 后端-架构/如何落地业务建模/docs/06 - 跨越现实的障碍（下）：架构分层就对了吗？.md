你好，我是徐昊。今天我们来聊聊如何有效地基于领域模型构造合理的架构。

到目前为止，我们学会了通过关联对象解决聚合/关联关系；利用角色对象分离不同上下文中的交互；并使用上下文对象完成实体对象到角色对象的扮演。这些模式通过结构上的优化，更好地组织了对核心数据的访问逻辑，使得我们可以在兼顾架构约束的同时，将领域概念与逻辑有效地转化为领域模型。

然而当我们把眼光从构造领域模型，扩展到利用领域模型构建整个应用或系统时，就会遇到新的问题：**如何组织领域逻辑与非领域逻辑，才能避免非领域逻辑对模型的污染**？

通常我们会使用分层架构（Layered Architecture）区分不同的逻辑以解决这个问题。然而由于领域层被人为赋予了最稳定的特性，破坏了分层架构间的依赖关系。所以我们需要**修正分层，才能有效地围绕领域模型来构造软件架构**。

那么今天这节课我们就看看分层架构的问题在哪儿，以及如何通过能力供应商（Capability Provider）模式获得一个更好的架构愿景。

## 领域层的“不正当关系”

**分层架构**是运用最为广泛的架构模式，它**将不同关注点的逻辑封装到不同的层中**，以便扩展维护，同时也能有效地控制变化的传播。

在使用领域驱动设计时，我们通常会将系统分成四层：
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/18/86/ae/163ec4e5.jpg" width="30px"><span>码农戏码</span> 👍（1） 💬（2）<div>理论指导实践，实践反哺理论，有时实践对了但归纳不出理论，有时有了理论却落不了地，统称摸着石头过河，这是低手所为，高手总是深刻理解理论，升华理论，实践手到擒来，行云流水

使用maven构建项目时，根据DDD拆分成四个module并如此依赖：controller -&gt; application -&gt; domain -&gt; infrastructure

但存在一个循环依赖问题：ddd中规定repository是domain,所以接口在domain层，但现实在infra层，那infra得依赖domain了，可从maven module依赖讲，domain是依赖infra的，只能先把repository接口放到infra中

可domain才是核心，最稳定的，不能被技术束缚，倒置一下，但技术并不只有db，还有IO,消息等等总不能像repository一样，把这些接口都放到domain，那domain很不纯粹

聪明的我又想到用namespace解决，从maven module讲，这些都放在domain层，但不再放在com.zhuxingsheng.domain包下，而放到对应的包下，如message放在com.zhuxingsheng.message，这样保证了domain的稳定，落地也不太别扭

这样好不好，不知道，至少说服我自己了

相比老师的能力供应商模式，差了好几个层次，第一只关注技术，没有对接口提取出领域概念，以领域知识为核心，第二虽然觉两层关系有丝丝别扭，但不敢质疑，并大声说出他们关系的不正当
</div>2021-07-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg" width="30px"><span>Jxin</span> 👍（23） 💬（5）<div>1.能力供应商&#47;防腐层，其实都是一个东西。为逻辑功能的组成部分定义清晰的业务模型 + 领域层只包含自身定义的业务模型（接口&#47;类） + 为这些业务模型定义寻找实现。隔离变化，不管是不同变化频率还是不同变化方向。

2.双向依赖大部分时候，可能是领域模型有所欠缺。识别定义抽取新的领域模型来公用会比实现双向依赖要好些，哪怕双向是隐式的，如果时间允许的话。

课后题，太晚了，脑子思绪混乱，等周末再琢磨。</div>2021-07-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4d/fe/882eaf0f.jpg" width="30px"><span>威</span> 👍（12） 💬（1）<div>为什么说支付失败的回访是应用层逻辑，而不是领域层逻辑呢，这里的划分是有什么准则吗</div>2021-07-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/c9/e6/af1a23b4.jpg" width="30px"><span>小毛球</span> 👍（3） 💬（1）<div>用拟人化去命名这个很妙！另外文章中的例子，实际设计中应该会丟一个消息中间件作为解耦。例如业务要发消息，发邮件，这样是不是就减少对基础设施的依赖？</div>2021-07-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/b9/81/1680ec3f.jpg" width="30px"><span>冯</span> 👍（3） 💬（3）<div>思考题，根据前面说的两关联一循环。这里把技术概念转换成了领域概念，然后反映到统一语言上。这就需要团队不断的执行循环，才能把知识消掉。业务方和技术方也需要紧密的配合和互相信任。</div>2021-07-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/8a/5a/b67a82e3.jpg" width="30px"><span>shen</span> 👍（2） 💬（1）<div>看到这章对老师膜拜了。看过不少DDD的内容，实际很难落地，老师结合软件设计相关内容从更高的纬度指导落地，这正是我想要的。</div>2021-07-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/93/b4/22f438d0.jpg" width="30px"><span>黄大仙</span> 👍（1） 💬（2）<div>文中能力供应商的实现方式是方法中传入，想必应该是在能接触到能力供应商的实例的最初始的调用者上传入的，比如领域服务。那么问题来了，在较为复杂的调用链中，这种传来传去很奇怪，该如何优化及避免？</div>2021-10-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/0b/73/a04b5d3f.jpg" width="30px"><span>Z.G</span> 👍（1） 💬（1）<div>老师你好，为什么失败回访是应用层的逻辑而不是领域层的逻辑呢？如何区别？比如业务需要记录一下回访的次数是不是就变成领域逻辑了？</div>2021-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/86/ae/163ec4e5.jpg" width="30px"><span>码农戏码</span> 👍（1） 💬（1）<div>对于分层，Vaughn Vernon 在《实现领域驱动设计》中把基础设施层倒置到最上面，下面依次是表现层，应用层，领域层，符合端口与适配器架构，也满足整洁架构

把基础设施层不作为层看待的确需要心理建设，相当反传统，认知中还是推荐domain是个纯内存操作，方便UT

拟人化提出新的领域概念，对产品经理来讲，也是增加了理解成本，这也是知识循环的一个阻力

</div>2021-07-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/c5/2c/184978c8.jpg" width="30px"><span>爱睡觉</span> 👍（1） 💬（1）<div>“不正当关系”😂。写的太好玩了</div>2021-07-16</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIibashTHtGDWH5L0NlbuOrA6ZuI4uc1HkMD0hbIt8iaoH8hFf3jpb8jjhsvrRLTIazZP3YoR5WpMpg/132" width="30px"><span>箭和方糖</span> 👍（1） 💬（1）<div>DDD本身有所谓的成熟度模型吗？比如总共有5档，有些项目可以做到5，有些项目受限于某些因素只能做到2或者3。这样的成熟度模型是否有意义</div>2021-07-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/82/40/02ae9409.jpg" width="30px"><span>Learner</span> 👍（0） 💬（1）<div>和iddd里的六边形架构的区别在哪呢</div>2021-07-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/93/32/e11fcd33.jpg" width="30px"><span>Oops!</span> 👍（0） 💬（2）<div>想到一个经常问到的问题，DDD需要一个common模块给所有层和域使用吗？比如customer service接口，应用层和领域层都会用到，是不是可以把customer service看作是一个通用的能力接口，(属于一种规范，比如规范了发邮件接口），提取到common中，每一层自己实现这个接口，不存在层和层的依赖问题？</div>2021-07-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/5f/d2/a39e5cea.jpg" width="30px"><span>狩月</span> 👍（0） 💬（1）<div>有点像端口适配器模式？</div>2021-07-07</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIibashTHtGDWH5L0NlbuOrA6ZuI4uc1HkMD0hbIt8iaoH8hFf3jpb8jjhsvrRLTIazZP3YoR5WpMpg/132" width="30px"><span>箭和方糖</span> 👍（0） 💬（2）<div>这种架构可能会带来额外的消耗，在于必须把所有基础设施抽象在领域模型内部，增加讨论成本，实现成本和维护成本，并且增加了通用语言的复杂度</div>2021-07-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5a/92/33bbbcac.jpg" width="30px"><span>Geek_316zyu</span> 👍（0） 💬（1）<div>添加了回访 customer service 的staff 变成了一个数组 依赖了一组客服接口 分别由基础设施层和应用实现, 是这样吗</div>2021-07-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7c/16/4d1e5cc1.jpg" width="30px"><span>mgxian</span> 👍（0） 💬（4）<div>邮件通知和回访是不是可以通过领域事件来实现，这样就不需要依赖了呢</div>2021-07-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5a/92/33bbbcac.jpg" width="30px"><span>Geek_316zyu</span> 👍（0） 💬（1）<div>我看8x flow 里面要讲究区分业务逻辑和领域逻辑，如果流程相关是业务做的 领域解决的是单点问题，这里的domain 层里面看上去也包含了业务不只是领域相关，如果是这样应用层里面也是业务，怎么安排哪些放在应用层哪些放在领域层呢</div>2021-07-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5a/92/33bbbcac.jpg" width="30px"><span>Geek_316zyu</span> 👍（0） 💬（1）<div>支付的例子里，邮件通知，本身作为基础设计来实现，然后业务变化还希望触发支付失败回访，这时属于应用层，那现在是不是领域层依赖了两个客服service，还是把之前发邮件也放到了应用层，怎么组合这两个呢</div>2021-07-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/3f/fe/35d1afbd.jpg" width="30px"><span>阿鸡</span> 👍（30） 💬（0）<div>&quot;不要用解决方案去定义问题。而是问题定义解决方案&quot; 这个很有启发！</div>2021-07-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg" width="30px"><span>马若飞</span> 👍（6） 💬（2）<div>“基础设施本身就不是层。”——八叉兄总是能以语不惊人死不休的方式震撼到我。</div>2021-07-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/3f/fe/35d1afbd.jpg" width="30px"><span>阿鸡</span> 👍（5） 💬（0）<div>领域层定义SPI，基础设施层实现SPI，作为插件和扩充。
需要注意的是，领域层定义的这些SPI被吸收进了领域的核心概念里。</div>2021-07-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/bb/cc/fac12364.jpg" width="30px"><span>xxx</span> 👍（2） 💬（0）<div>本章总结：通过提取接口实现依赖反转，四层变三层。</div>2021-07-31</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/XPenLgPCKGg3sEaC8fNpwoqX3wPoUSlk8NojV71THG4M3YE9c0L0HD4K5wAXXkeHficy8MHhoEgpYIC6vclEIUw/132" width="30px"><span>Geek_8d0790</span> 👍（1） 💬（0）<div>关于领域层可以举一些例子吗？感觉对这个概念还不是很清楚</div>2022-02-21</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/XPenLgPCKGg3sEaC8fNpwoqX3wPoUSlk8NojV71THG4M3YE9c0L0HD4K5wAXXkeHficy8MHhoEgpYIC6vclEIUw/132" width="30px"><span>Geek_8d0790</span> 👍（1） 💬（0）<div>可以对领域层举一些例子吗？有点没听懂</div>2022-02-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/c5/90/4d48ac20.jpg" width="30px"><span>stevehsuhsu</span> 👍（0） 💬（1）<div>看到这里我感觉一致是在讲领域驱动设计，好像还没到业务建模的地方，没有企业视角的业务建模</div>2023-11-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c4/03/f753fda7.jpg" width="30px"><span>JianXu</span> 👍（0） 💬（0）<div>拟人化这个提法妙，做架构我最近学到的就是先假设交互中的各个系统都是人，考虑人跟人交互需要考虑的因素，然后在架构设计中必须体现这些因素。</div>2022-10-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/49/3c/5d54c510.jpg" width="30px"><span>skull</span> 👍（0） 💬（0）<div>应用层还能给领域层提供能力，这分层划分的还有什么意义，别分层了，都一层好了</div>2022-07-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/fa/33/dc716b64.jpg" width="30px"><span>Geek_e24e2a</span> 👍（0） 💬（0）<div>本质上就是依赖抽象，不要依赖实现的设计原则的一种落地方式吧。spi为好，适配器也好，防腐层也好，还有端口模式只是实现的隔离级别不同都有各自的适用场景</div>2022-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/19/35/be8372be.jpg" width="30px"><span>quietwater</span> 👍（0） 💬（0）<div>看了这节内容的感觉就一个字，“爽”，我情感价值的需求被满足了。因为，困扰我很久的问题终于找到答案了。可能是因为学习过《整洁架构》吧，还有面向对象的设计原则，所以能够很好地理解文中的思想。感谢老师！</div>2022-05-09</li><br/>
</ul>