你好，我是谢友鹏。

相信很多人都听过“墨菲定律”——凡是可能出错的事情，总会出错。在高并发的网络实践中，这条定律常常得到验证，无论是服务器宕机、机房故障，还是通往一个城市的光纤被意外切断，都可能导致网络服务中断。因此，在网络架构设计时，我们要具备“底线思维”，假设任何一个单点都会出问题，以此设计出高可用的网络架构。

“主备”架构便是应对单点故障的有效手段之一。今天这节课，我们就结合案例深入学习一下如何从多机器、多机房、多城市的维度设计主备网络架构，确保系统的稳定、可靠。

## 主备架构要思考的几个问题

主备架构，顾名思义，是由一主和一备或多备组成的架构。在这种设计，主负责处理所有请求，而备保持待命状态。当主发生故障时，备可以迅速接管，确保服务的连续性。

对于喜欢探究原理的同学来说，可能会产生以下疑问：

- 如何确认哪个是主，哪个是备？
- 系统如何判断主出现故障？
- 如何确保请求只发送给主，而不发送到备？

下面让我们依次剖析多机器、多机房、多城市几个维度的主备架构，解开以上疑问。

## 多机器主备

设想这样一个场景：你需要为某企业的一个部门搭建一个私有化的基于HTTP的网络服务，该服务提供一个IP和端口，供其他部门访问。从企业安全的角度出发，部门之间设置了防火墙，部门之间只能使用防火墙白名单的 IP 进行访问。因此对外提供的IP一经加入白名单就不容易变动。
<div><strong>精选留言（2）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/24/7e/73/a5d76036.jpg" width="30px"><span>DoHer4S</span> 👍（3） 💬（1）<div>1. 服务和应用层: 在部署关键服务和应用时，避免依赖单一实例或节点，可以采用集群部署、微服务架构等方式来分散负载和提高容错能力。
数据传输和通信链路: 使用冗余的通信链路和协议，确保数据的可靠传输，避免单一通信路径或协议造成的传输中断。
安全策略和防护措施: 在网络安全方面，避免单一安全控制点，采用多层防御策略和安全设备，如防火墙、入侵检测系统等，来增强网络的安全性和抵御能力。
灾备和恢复策略: 设计和实施完善的灾备（DR）和业务恢复（BC）策略，包括定期备份、跨地域异地备份等措施，避免单一灾备措施或节点导致的业务中断。

2. 会导致服务不可用的情况。尽管 Keepalived 可以确保在主设备宕机时进行自动故障切换，但是它并不会监控或保护 Nginx 进程本身的运行状态。
健康检查: 设置健康检查机制，例如通过 Keepalived 或其他负载均衡器来定期检查 Nginx 进程的运行状态。如果检测到 Nginx 进程异常或停止，主备切换机制可以触发，将请求导向备用设备上的 Nginx 实例，从而避免服务中断。
自动恢复机制: 在主备切换后，实现自动恢复的机制。例如，在备用设备接管主设备角色后，自动启动 Nginx 进程，并确保服务的正常运行。
监控和警报: 配置监控系统来实时监测 Nginx 进程的运行状态和服务的可用性。设置警报机制，在 Nginx 进程异常时及时通知运维人员进行处理，以减少故障对服务的影响时间。
多点检测和冗余: 考虑使用多点检测的方式，而不仅仅依赖于单一检测点。确保健康检查能够覆盖多个方面，避免单一检测点的局限性。</div>2025-02-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/32/3f/39/11b908f0.jpg" width="30px"><span>Philo</span> 👍（0） 💬（1）<div>路由 1: 172.16.0.0&#47;26路由 2: 172.16.0.0&#47;27当数据包的目标地址为 172.16.0.100 时，两个路由都不能匹配吧，是不是写错了</div>2025-02-15</li><br/>
</ul>