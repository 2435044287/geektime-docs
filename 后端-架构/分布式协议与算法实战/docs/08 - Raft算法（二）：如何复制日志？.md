你好，我是韩健。

通过上一讲的学习，你应该知道Raft除了能实现一系列值的共识之外，还能实现各节点日志的一致，不过你也许会有这样的疑惑：“什么是日志呢？它和我的业务数据有什么关系呢？”

想象一下，一个木筏（Raft）是由多根整齐一致的原木（Log）组成的，而原木又是由木质材料组成，所以你可以认为日志是由多条日志项（Log entry）组成的，如果把日志比喻成原木，那么日志项就是木质材料。

在Raft算法中，副本数据是以日志的形式存在的，领导者接收到来自客户端写请求后，处理写请求的过程就是一个复制和应用（Apply）日志项到状态机的过程。

那Raft是如何复制日志的呢？又如何实现日志的一致的呢？这些内容是Raft中非常核心的内容，也是我今天讲解的重点，我希望你不懂就问，多在留言区提出你的想法。首先，咱们先来理解日志，这是你掌握如何复制日志、实现日志一致的基础。

## 如何理解日志？

刚刚我提到，副本数据是以日志的形式存在的，日志是由日志项组成，日志项究竟是什么样子呢？

其实，日志项是一种数据格式，它主要包含用户指定的数据，也就是指令（Command），还包含一些附加信息，比如索引值（Log index）、任期编号（Term）。那你该怎么理解这些信息呢？
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/19/cf/a4/e810c266.jpg" width="30px"><span>花家舍</span> 👍（84） 💬（8）<div>http:&#47;&#47;thesecretlivesofdata.com&#47;raft&#47;
动画演示  比文章牛逼多了</div>2020-03-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/9c/48/44965714.jpg" width="30px"><span>Mars</span> 👍（58） 💬（30）<div>老师，我有个问题，在那个复制日志的五个过程里，如果第四步执行返回结果成功了，leader突然挂了，此时leader 的状态机已经更新，follower状态机没有更新，此时新选举出来的leader怎么处理这个流程来保证上一个leader的状态机更新apply到其他节点上了呢？</div>2020-03-11</li><br/><li><img src="" width="30px"><span>Scott</span> 👍（36） 💬（33）<div>我有一个问题，考虑下面这种情况，假设集群有1 leader 多 follower
1. leader发出一条set x = 1，index为最新的appendEntries到所有的follower
2. 只有一台follower响应了，所以leader对client返回fail
3. 这时leader挂了，剩余机器重新进行选举，因为前面那台follower有最新的uncommited的日志，所以它会被选举为leader

这时就会有一个不一致，外部client认为set x = 1没有成功，但是实际上x = 1是成功的，这种情况合法吗？</div>2020-03-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/3b/7e/9b68d804.jpg" width="30px"><span>葉月喵</span> 👍（27） 💬（2）<div>上一章跟随者投票时会比较日志索引号大小，用的是已提交的日志，还是已经复制的日志？</div>2020-02-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/83/22/c3dae274.jpg" width="30px"><span>阿kai(aeo</span> 👍（16） 💬（5）<div>感觉处理日志一致性问题的时候非常不efficient，如果follower落后得多了，那么来回的RPC大部分都是failure，很耗时间和带宽。follower是否可以直接返回它拥有的最新index，然后leader根据那个index开始看是否match自己的日志，如果match就直接一次性把剩余日志都给follower发过去。这样会有效率一些吧？</div>2020-03-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg" width="30px"><span>piboye</span> 👍（12） 💬（2）<div>为什么跟随者不直接告诉领导者我从哪里缺日志，而让领导者一个一个去尝试？</div>2020-09-17</li><br/><li><img src="" width="30px"><span>Geek_d40030</span> 👍（10） 💬（1）<div>老师您好，在日志更新的时候为什么有索引值了，还要判断任期呢？理论上索引值是单调递增的就能够判断跟随者的日志在什么位置吧。
</div>2020-07-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/fb/50/04071be6.jpg" width="30px"><span>DZ</span> 👍（10） 💬（5）<div>老师，请教下如果在指定时间内没有收到大部分follower复制成功响应，只收到少数，那么领导者如何处理这次提交？是直接不做任何处理，由心跳或者下次提交重新对齐日志？还是有重试或者rollback机制？</div>2020-03-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/68/89/173601c5.jpg" width="30px"><span>bc</span> 👍（9） 💬（2）<div>客户端并不知道谁是leader，怎么保证客户端的请求一定是由lead来处理的？</div>2020-03-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/fb/7b/2d4b38fb.jpg" width="30px"><span>Jialin</span> 👍（9） 💬（1）<div>1.Raft 日志格式：
• 指令：一条由客户端请求指定的、状态机需要执行的指令。即客户端提交的数据
• 索引值：日志项对应的整数索引值，用来标识日志项的，是一个连续的、单调递增的整数号码
• 任期编号：创建这条日志项的领导者的任期编号
2.理想的日志复制阶段：
• 接收到客户端请求后，领导者基于客户端请求中的指令，创建一个新日志项，并附加到本地日志中
• 领导者通过日志复制 RPC，将新的日志项复制到其他的服务器
• 当领导者将日志项，成功复制到大多数的服务器上的时候，领导者会将这条日志项提交到它的状态机中
• 领导者将执行的结果返回给客户端
• 当跟随者接收到心跳信息，或者新的日志复制 RPC 消息后，如果跟随者发现领导者已经提交了某条日志项，而它还没提交，那么跟随者就将这条日志项提交到本地的状态机中
3.实际生产环境中，复制日志的时候遇到进程崩溃、服务器宕机等问题，这些问题会导致日志不一致。Raft 算法按照“Raft 是通过以领导者的日志为准，来实现各节点日志的一致的”原则处理不一致日志，实现日志的一致，具体如下：
• 领导者通过日志复制 RPC 的一致性检查，找到跟随者节点上与自己相同日志项的最大索引值。也就是说，这个索引值之前的日志，领导者和跟随者是一致的，之后的日志是不一致的了。
• 领导者强制跟随者更新覆盖的不一致日志项，实现日志的一致

课后思考题：领导者接收到大多数的“复制成功”响应后，就会将日志提交到它自己的状态机，然后返回“成功”响应客户端。如果此时有个节点不在“大多数”中，也就是说它接收日志项失败，那么在这种情况下，Raft 会通过日志复制 RPC 的一致性检查，找到失败者节点上，与自己相同日志项的最大索引值，然后领导者强制该失败者更新覆盖的不一致日志项，实现日志的一致</div>2020-02-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/2d/18/918eaecf.jpg" width="30px"><span>后端进阶</span> 👍（6） 💬（8）<div>老师，我这里有个疑问：文章讲了raft优化成一阶段提交，二阶段提交变成心跳或者下一次日志复制的rpc请求，那么在leader返回成功给client时，还没来得及心跳和下一次rpc日志复制，此时leader宕机了，某个follower成为新的leader，而这个follower并没有这条uncommitted log，此时会不会这条日志会不会被覆盖掉？</div>2020-04-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4d/54/9c214885.jpg" width="30px"><span>kylexy_0817</span> 👍（6） 💬（1）<div>日志必须的连续的，也就是说，新加入的节点必须要全量复制日志？如果日志量大，是否意味着新节点在完成复制日志前的一段很长的时间，都不能成为追随者？</div>2020-03-29</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erY7671v8F2joiaBbnCPsbJ6ExFruIMDsd9HRSORsOZgbzBrKibDibU9CRCGghI56hUiampklDWzMFc4A/132" width="30px"><span>华子</span> 👍（5） 💬（1）<div>日志的索引值如果是单调递增且连续，那就不需要Term值了？是我理解错了？还是说存在两种情况，Index增加Term不增加，Index不增加Term增加，所以不能只根据日志索引值判断？</div>2020-04-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0d/86/84984798.jpg" width="30px"><span>唐明</span> 👍（5） 💬（4）<div>如果领导者没有接收到大多数的“复制成功”响应，那么就返回错误给客户端。
我有个疑问，有ABC三个节点，假设领导者将日志复制给了A节点，在将日志复制给B和C时失败，A节点已经复制的日志项要怎么处理才能不出错呢？</div>2020-03-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/20/08/bc06bc69.jpg" width="30px"><span>Dovelol</span> 👍（4） 💬（1）<div>老师好，想问一下，raft算法日志复制中，假如当前客户端发送请求，领导者处理请求，日志是term是4，索引是8，那么会复制到跟随者，但是由于部分跟随者返回失败，最终领导者给客户端返回失败了，那么下次在处理请求的时候，term是4，索引会变成9还是继续保持8呢？</div>2020-06-20</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEKB0h2nibEbQKcZ6eHkgkmtwMunlibSibT3YAJ8IbDa834HnTAYiajMd8YCdpyDrfhWibCicfpmDCjJzwlA/132" width="30px"><span>z</span> 👍（4） 💬（1）<div>从follower节点的读请求一般会返回uncommitted状态的数据吗</div>2020-06-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/11/e9/b6aa6364.jpg" width="30px"><span>shenfl</span> 👍（4） 💬（4）<div>老师 有个疑问，当领导者提交日志到本地状态机后与客户端网络出问题了，此时客户端会以为本次写入不成功，这样就导致客户端与集群信息不一致，该怎么处理呢？</div>2020-02-28</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/kQ0NueqD3LTRravKIH2DgtqFKLqgjZQicDZtibdTqJ8pBRjNwlKornibGj2qibPdsgLXh2xQ3MesQ7q2JyATIEBphVHpcS2iaboZqATms4IDUibes/132" width="30px"><span>山头</span> 👍（3） 💬（1）<div> Raft 能实现一系列值的共识，一系列值的共识是什么意思</div>2020-08-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/87/23/f6835d17.jpg" width="30px"><span>语法糖不甜</span> 👍（3） 💬（1）<div>老师 我想问一下：
图中的第二步是【领导者通过日志复制 RPC，将新的日志项复制到其他的服务器。】那么此时跟随者会复制日志并提交吗吗？还是跟随者一定是在领导者确认之后才提交的呀？</div>2020-04-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f9/c4/b2b3260e.jpg" width="30px"><span>wyhqaq</span> 👍（2） 💬（6）<div>老师请问一下，如果当前有5台机器，最新的日志只comitted到了三台机器上，此时如果挂掉了其中两台机器（比如同一个交换机上），然后一个未记录这条日志的机器投票成为了leader（因为当前只有1台机器有最新日志，所以还是存在这种情况），那这条日志是不是就丢失了。</div>2020-10-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/83/14/099742ae.jpg" width="30px"><span>xzy</span> 👍（2） 💬（1）<div>你好，请问如果 leader apply 日志后，返回客户端成功，但是 follower 还未 apply，此时岂不是数据并不一致吗？那 raft 是怎么保证强一致的呢</div>2020-05-21</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKYfReHXMbPaxO890ib9GvY9iciclPIUvaAYMYON4scP7ElXCPVzicghF0SH5HN2LqibYOrdrppC7DuSpw/132" width="30px"><span>static</span> 👍（2） 💬（2）<div>老师好，我有个一直以来的疑问，例如raft算法中客户端写数据set A，此时leader发起一次日志写并且RPC复制日志给follower，如果leader收到多数请求后，且成功提交状态机，但在下一次心跳之前它挂了，其他节点还没有收到leader最新提交的心跳消息，导致最后一条数据在follower中处于未提交状态（没提交状态机），那这条数据是不是就丢了？如果其他节点成为了leader，那是不是这台挂了的机器在恢复后，也会把这条已经提交的抹掉，因为这是一条和最新的主节点不一致的数据？
类比到分布式锁来说，如果我现在加了一个分布式锁在raft算法上，但是此时leader节点挂了，follower还没应用锁信息到状态机，并且follower变为leader，此时又有一个客户端来加分布式锁，一看没锁就成功获取到锁，此时就破坏了分布式锁的同步性质？</div>2020-03-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/b3/57/2d92cf9a.jpg" width="30px"><span>姜川</span> 👍（2） 💬（1）<div>有个疑问，如果leader收到多数请求后，且成功提交状态机，但在下一次心跳之前它挂了，其他节点还没有收到leader最新提交的心跳消息，导致最后一条数据在follower中处于未提交状态，那这条数据是不是就丢了，如果其他节点成为了leader，那是不是这台挂了的机器在恢复后，也会把这条已经提交的抹掉，因为这是一条和最新的主节点不一致的数据</div>2020-03-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/2a/b8/edbafb82.jpg" width="30px"><span>彦</span> 👍（2） 💬（1）<div>请问，raft第二阶段提交中，文章中说跟随者采用RPC日志复制来进行提交操作，是不是就是依据PrevLogEntry以及PrevLogTerm和自己状态机中的数据做对比，然后进行提交的？</div>2020-03-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/12/5d/e9cea49e.jpg" width="30px"><span>老杜去哪儿</span> 👍（2） 💬（1）<div>能不能对高票对评论进行一下回答呀？高票的问题最有营养</div>2020-03-08</li><br/><li><img src="" width="30px"><span>zjm_tmac</span> 👍（2） 💬（1）<div>有两个问题，状态机指的是上层应用方的状态机吗？比如etcd-raft对应的状态机是etcd的wal模块吗？另外如果日志已经commit但未apply的情况下提交给状态机失败了，比如唯一性冲突了，这种情况下日志会怎么处理呢？</div>2020-03-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/1c/e1/c99d1473.jpg" width="30px"><span>longyi</span> 👍（2） 💬（1）<div>思考题：这个落后的节点上线后，leader会同步日志给它，如果日志已经删除了leader会同步snapshot。</div>2020-02-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg" width="30px"><span>每天晒白牙</span> 👍（2） 💬（1）<div>处理日志项一致通过RPC一致性检查，找到追随者中与自己相同日志项的最大索引，然后把后面的日志项同步过去，让追随者复制更新</div>2020-02-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg" width="30px"><span>每天晒白牙</span> 👍（2） 💬（3）<div>老师我有个小疑惑，就是Raft在处理日志不一致时会给追随者发送RPC一致性检查，找到和自己相同日志项的最大值，这里是对每个追随者而言的还是所有的追随者而言的？
</div>2020-02-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/67/d5/1b26b725.jpg" width="30px"><span>Gopher</span> 👍（1） 💬（1）<div>回答下问题：
如果节点不再大多数节点，只要等心跳来更新自己的任期，还有等到leader 的一致性检查来修复自己的日志</div>2020-07-15</li><br/>
</ul>