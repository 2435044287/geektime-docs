你好，我是韩健。

通过前两节课，我带你打卡了Paxos算法，今天我想和你聊聊最常用的共识算法，Raft算法。

Raft算法属于Multi-Paxos算法，它是在兰伯特Multi-Paxos思想的基础上，做了一些简化和限制，比如增加了日志必须是连续的，只支持领导者、跟随者和候选人三种状态，在理解和算法实现上都相对容易许多。

**除此之外，Raft算法是现在分布式系统开发首选的共识算法。**绝大多数选用Paxos算法的系统（比如Cubby、Spanner）都是在Raft算法发布前开发的，当时没得选；而全新的系统大多选择了Raft算法（比如Etcd、Consul、CockroachDB）。

对你来说，掌握这个算法，可以得心应手地处理绝大部分场景的容错和一致性需求，比如分布式配置系统、分布式NoSQL存储等等，轻松突破系统的单机限制。

**如果要用一句话概括Raft算法，我觉得是这样的：从本质上说，Raft算法是通过一切以领导者为准的方式，实现一系列值的共识和各节点日志的一致。**这句话比较抽象，我来做个比喻，领导者就是Raft算法中的霸道总裁，通过霸道的“一切以我为准”的方式，决定了日志中命令的值，也实现了各节点日志的一致。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/4b/4d/0239bc19.jpg" width="30px"><span>益军</span> 👍（50） 💬（3）<div>关于raft的领导者选举限制和局限，我的理解：
1.读写请求和数据转发压力落在领导者节点，导致领导者压力。
2.大规模跟随者的集群，领导者需要承担大量元数据维护和心跳通知的成本。
3.领导者单点问题，故障后直到新领导者选举出来期间集群不可用。
4.随着候选人规模增长，收集半数以上投票的成本更大。</div>2020-02-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg" width="30px"><span>piboye</span> 👍（36） 💬（3）<div>为什么raft不采用paxos方式选主？</div>2020-05-02</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eondPEiaia6ugMDzWTRZXt6X5RLVtsYPBwiaskicyJADq1hD0KxyiaNiaRhBxgwTGia1fmDgfDo0y8YxjzKQ/132" width="30px"><span>starwolf</span> 👍（30） 💬（11）<div>老师有两个问题请教一下，第一就是投票要获得大多数的选票，但是投票发起者怎么知道现在的票数已经超过半数了？因为分布式环境的机器数目是随时变化的。第二个问题，您在课程中说过，raft算法会让日志最完整的当选，这个不一定吧，如果第二完整的节点先发起投票，并获得大多数选票，也是可以当选的吧。这两个问题请帮忙解答一下，谢谢</div>2020-04-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/f9/31/b75cc6d5.jpg" width="30px"><span>ξ！</span> 👍（23） 💬（2）<div>http:&#47;&#47;thesecretlivesofdata.com&#47;raft&#47;     raft算法动态演示，看完老师的再看这个清晰明了</div>2020-08-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg" width="30px"><span>每天晒白牙</span> 👍（19） 💬（3）<div>Raft这种&quot;一切以我为主&quot;的强领导模型和上一讲中的chubby有点类似，chubby是只能从主节点读取，相当于单机，性能和吞吐量有限
Raft的强领导模型是写要以主为主，也相当于单机了。性能和吞吐量也会受到限制</div>2020-02-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/07/8c/0d886dcc.jpg" width="30px"><span>蚂蚁内推+v</span> 👍（13） 💬（2）<div>老师请教一个问题，如果一个日志完整度最高的节点由于随机超时时间较长，没能帅先发起投票，没能当上领导者，那么这部分日志要怎么处理？</div>2020-05-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/81/e6/6cafed37.jpg" width="30px"><span>旅途</span> 👍（12） 💬（1）<div>老师 问个问题 如果 大多数跟随者节点 被相同任期编号 但是日志序号小的  先联络到了 这样的话 不是日志序号小节点 当选了吗</div>2020-03-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/8d/c7/d66952bc.jpg" width="30px"><span>Happy</span> 👍（11） 💬（2）<div>老师您好，如果加了随机的超时时间，但是为了选取日志完整性较高的节点，导致一轮下来还是没有选举成功，那么会进行第二轮选举吗？此时的第二轮选举任期编号会 +1 吗？</div>2020-02-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/1c/e1/c99d1473.jpg" width="30px"><span>longyi</span> 👍（9） 💬（4）<div>如果一个节点孤立了，这个节点可能不断的发起选举，但是又成不了leader，所以它的term会越变越大。当它回到集群的时候，它拥有一个很大的term，会对集群其他节点造成什么影响吗？</div>2020-04-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/43/56/62c38c36.jpg" width="30px"><span>欧阳</span> 👍（9） 💬（3）<div>请问任期一般多长呢？还是只要不故障，任期一直不变？任期索引是用32位整数表示么？如果达到最大int，怎么处理呢？</div>2020-03-10</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/QFE00aXGzaS6ibbfJSJsDrpIkqs0OrIYjzZv6L9vZmMhOlut2j24iaeZb0MCQazToE6FRXN960nNiaTrsmw09YjGw/132" width="30px"><span>岁月如歌</span> 👍（9） 💬（1）<div>raft算法的局限：
1、强领导模型对于写功能基本退化单机性能，量大任然会出现性能瓶颈，适得其反。
2、选举期间会集群将出现短暂不可用现象，影响时长与选举时间相关。

有几个细节需要跟韩老师请教：
1、raft集群如何感知其他节点呢？候选节点如何判断获得的票数已经过半，从而晋升为领导者？
2、节点是如何存储任期编号？集群如果关闭重启是否任期编号归零？
3、
{1.当任期编号相同时，日志完整性高的跟随者（也就是最后一条日志项对应的任期编号值更大，索引号更大），拒绝投票给日志完整性低的候选人。比如节点 B、C 的任期编号都是 3，节点 B 的最后一条日志项对应的任期编号为 3，而节点 C 为 2，那么当节点 C 请求节点 B 投票给自己时，节点 B 将拒绝投票。}
-------------------------------------------------------------
文中该陈述应该标注为 选举有哪些规则 第6点。且表达意思与配图有所冲突: B节点(任期编号3)、C节点(任期编号4)，C节点任期编号更大，为何B节点拒绝C节点投票请求？ 请老师解析一下。</div>2020-03-06</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Uv4icib4ZLZVa4RTW7CUibJAh6h23IPM5eiaibKzlmZfxWPWibUmAmxmnpafsesQiazcy5TtghOFwaMgppv58gbAgnRicA/132" width="30px"><span>Geek_niu</span> 👍（9） 💬（1）<div>候选者在向别的节点发布请求投票的RPC时，他是通过广播洪泛，还是gossip那样的方式</div>2020-03-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg" width="30px"><span>QQ怪</span> 👍（7） 💬（4）<div>leader挂了会导致集群不可用，读写都在leader上会有性能瓶颈，类似单机</div>2020-04-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/14/c2/46ebe3a0.jpg" width="30px"><span>侧耳倾听</span> 👍（6） 💬（1）<div>随机时间的问题上，我理解的是每个跟随者随机一个超时时间，所以时间范围上从小到大的随机数，这个随机时间间隔不会太大，要不然时间小的跟随者要发起多次选举，时间的作用是为了避免同一节点多个选举的情况出现，那么，如果一个跟随者想要选举自己成为领导者，必须要得到超过半数追随者的投票，实际等待下一个超时时间间隔的意思是要一直等到跟随者失联数目超过半数，这之间可能需要经过数个间隔</div>2020-04-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/21/d0/aa5422f2.jpg" width="30px"><span>林万伟</span> 👍（5） 💬（1）<div>老师，请问A、B、C三个节点，B为leader，三个节点term都为1，然后发生网络分区，A一个子网，B、C一个子网。A因为一直选举，导致term很大。这时候会有两种情况：
1.分区期间，日志没有变化，A、B、C三个节点的日志完整性都一样，这时候A节点网络恢复。此时Leader会是谁？
2.分区期间，日志发生变化，必然是B、C子网的日志完整性更高。此时A节点网络恢复，这个时候Leader会是谁呢？

</div>2020-07-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/ad/32/8d4ca29e.jpg" width="30px"><span>贰的11次方</span> 👍（4） 💬（1）<div>老师，关于本章节中“当收到来自节点 A 的请求投票 RPC 消息时，因为消息中包含了节点 A 的任期编号，且编号为 1，那么节点 B 将把自己的任期编号更新为 1” 这段话，我有一点疑问：节点更新自己的任期编号的时机应该不包含 投票请求这一种情况吧。 因为，我的理解是，如果直接更新了任期编号，但是你的投票最终是无效的（没有超过半数）那么这个来自候选人的任期编号也是无效的吧。</div>2020-06-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/dd/51/a7e82963.jpg" width="30px"><span>波波</span> 👍（4） 💬（8）<div>老师你好，如果一个跟随者因为网络原因未收到领导者心跳，这时这个节点变成候选节点，此时这个节点发起的投票，其他正常的节点会回应投票结果么？</div>2020-03-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/11/18/8cee35f9.jpg" width="30px"><span>HuaMax</span> 👍（4） 💬（1）<div>当任期编号相同时，日志完整性高的跟随者（也就是最后一条日志项对应的任期编号值更大，索引号更大），拒绝投票给日志完整性低的候选人。比如节点 B、C 的任期编号都是 3，节点 B 的最后一条日志项对应的任期编号为 3，而节点 C 为 2，那么当节点 C 请求节点 B 投票给自己时，节点 B 将拒绝投票。
————
关于这种情况，跟配图不太一致，如果B，C任期编号相同，都是3，节点C发起的选举投票应该是4，B不就应该接受投票吗？麻烦老师解惑</div>2020-02-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/b6/11/e8506a04.jpg" width="30px"><span>小宇宙</span> 👍（3） 💬（1）<div>leader为中心主要有三个问题：1)性能问题，如果leader为慢节点会导致长尾。2)日志的同步必须是有序提交   3)切换leader时会有一段时间的不可用</div>2020-07-12</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJExu8mFzkasuz32FLic5HaYMXicEBnpl63CxZoyYywLY3c59uGicCr9FmWicqKfEA73rmYgtglc1ztAg/132" width="30px"><span>Geek_yuanhe</span> 👍（3） 💬（1）<div>raft算法中，是不是读只能读leader节点？ </div>2020-05-14</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJExu8mFzkasuz32FLic5HaYMXicEBnpl63CxZoyYywLY3c59uGicCr9FmWicqKfEA73rmYgtglc1ztAg/132" width="30px"><span>Geek_yuanhe</span> 👍（3） 💬（1）<div>老师，如果一直选举不出来，会不会出现僵死的情况？这是不是挺严重的</div>2020-05-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/29/a1/220b99b6.jpg" width="30px"><span>高山仰止</span> 👍（3） 💬（1）<div>老师你好！如果有一个跟随者因领导者心跳检测超时，变成了候选者，那么此时该候选者的提交任期编号是基于节点上一次接受到的最大任期编号+1，还是随机生成呢？</div>2020-03-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/75/dd/9ead6e69.jpg" width="30px"><span>黄海峰</span> 👍（3） 💬（3）<div>写请求无法扩容</div>2020-02-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/9e/d4/95f6fb65.jpg" width="30px"><span>仲夏夜空星星多</span> 👍（2） 💬（1）<div>感觉还是有些细节没有说到，比如候选人如果没选上，那下一个谁来竞选，由随机时间决定的话，刚刚失败那个候选人会不会再来，会不会总是它。候选随机时间怎么确定，怎么查看是否到了候选随机时间</div>2020-08-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/d9/ff/b23018a6.jpg" width="30px"><span>Heaven</span> 👍（2） 💬（1）<div>从早晨将这节课的文章读完,到在午休时候又品了一边,现在看来Raft暴露的&#39;一切以我为准&#39;还是没有跳脱Chubby的只有主节点能服务的限制,没有实际的增加吞吐量,相当于一个只保证了可用性的单机系统</div>2020-08-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/16/22/2205cf0a.jpg" width="30px"><span>余向华</span> 👍（2） 💬（1）<div>老师你好，请教个问题，你说到的是随机时间是有两种含义的，那么这两种不同含义的随机时间的值是一样的吗还是不同的？</div>2020-06-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/53/ae/26faa892.jpg" width="30px"><span>邵邵</span> 👍（2） 💬（2）<div>raft节点中的日志如何理解？</div>2020-02-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ae/8b/43ce01ca.jpg" width="30px"><span>ezekiel</span> 👍（1） 💬（1）<div>我觉得任期，理解成朝代更合适</div>2020-09-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/f9/31/b75cc6d5.jpg" width="30px"><span>ξ！</span> 👍（1） 💬（0）<div>老师!跟随者等待领导者心跳信息超时的时间间隔，是随机的；
这样的话不会频繁的发生选举过程么???</div>2020-04-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/68/89/173601c5.jpg" width="30px"><span>bc</span> 👍（1） 💬（1）<div>某个节点为收到心跳，于是发起新一轮投票，其他节点如何处理，毕竟任期编号+1</div>2020-02-27</li><br/>
</ul>