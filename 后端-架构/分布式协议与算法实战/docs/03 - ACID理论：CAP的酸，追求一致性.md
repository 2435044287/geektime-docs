你好，我是韩健。

提到ACID，我想你并不陌生，很多同学也会觉得它容易理解，在单机上实现ACID也不难，比如可以通过锁、时间序列等机制保障操作的顺序执行，让系统实现ACID特性。但是，一说要实现分布式系统的ACID特性，很多同学就犯难了。那么问题来了，为什么分布式系统的ACID特性在实现上，比较难掌握呢？

在我看来，ACID理论是对事务特性的抽象和总结，方便我们实现事务。你可以理解成：如果实现了操作的ACID特性，那么就实现了事务。而大多数人觉得比较难，是因为分布式系统涉及多个节点间的操作。加锁、时间序列等机制，只能保证单个节点上操作的ACID特性，无法保证节点间操作的ACID特性。

那么怎么做才会让实现不那么难呢？答案是你要掌握分布式事务协议，比如二阶段提交协议和TCC（Try-Confirm-Cancel）。这也是我接下来重点和你分享的内容。

不过在带你了解二阶段提交协议和TCC之前，咱们先继续看看苏秦的故事，看这回苏秦又遇到了什么事儿。

最近呢，秦国按捺不住自己躁动的心，开始骚扰魏国边境，魏王头疼，向苏秦求助，苏秦认为“三晋一家亲”，建议魏王联合赵、韩一起对抗秦国。但是这三个国家实力都很弱，需要大家都同意联合，一致行动，如果有任何一方不方便行动，就取消整个计划。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/0f/70/cdef7a3d.jpg" width="30px"><span>Joe Black</span> 👍（38） 💬（19）<div>在两阶段提交协议中，如果一个节点在第一阶段确认可以提交，然后崩溃了怎么办？第二阶段它实际没法真正应用自己那部分事务。这个看起来没法处理啊</div>2020-02-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/a5/8f/693e483e.jpg" width="30px"><span>Undefined</span> 👍（30） 💬（1）<div>真正理解2PC和TCC的使用场景之后就不会分不清这两个东西，老师可以增加使用真实场景，希望老师在后面的讲解中加上相关分布式协议思想的真实场景，要不仅凭叙述理解起来确实麻烦
2PC用在集群间一致性数据同步，所有参与者完成的是同一件事，可以理解为它们在一个start transaction--commit里面，具有强一致性
TCC是对业务过程的拆分，一致性弱于2PC</div>2020-02-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（19） 💬（10）<div>文中说到 两阶段提交的弊端：在提交请求阶段，需要预留资源，在资源预留期间，其他人不能操作

利用 TCC 可以解决，这里不是很明白，在 TCC中不是也有预留请求，同样预留资源的，难道在这期间其他事务可以使用这部分资源呢？ 如果能使用预留资源，那么在执行Confirm确定操作的时候，之前预留的资源发生了变化，这样会不会有问题？</div>2020-02-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/f6/e3/e4bcd69e.jpg" width="30px"><span>沉淀的梦想</span> 👍（16） 💬（5）<div>老师在&quot;二阶段提交存在的问题&quot;中说 &quot;数据库是独立的系统&quot;，是表达的什么意思？</div>2020-02-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/e8/a6/e74ecf7d.jpg" width="30px"><span>张克菲</span> 👍（14） 💬（2）<div>老师，在一次面试中被问到一个问题，如果一个transaction的rollback失败了，应该怎么办？回来后这个问题一直没有找到合适的答案，想看您能否分享一下您的思路？</div>2020-04-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ac/a1/43d83698.jpg" width="30px"><span>云学</span> 👍（14） 💬（2）<div>分享下我的理解，望指正：二阶段提交是保证不同系统&#47;模块的逻辑结果一致，要么都成功，要么都失败，这些系统的物理数据是完全不相关的； 而Raft是保证多个系统的数据物理一致，举例1: 对于3副本存储系统，上传数据时肯定要保证这3个副本的数据物理一致， 举例2:对于一笔交易，需要通过2PC保证订单系统和库存系统的逻辑结果一致，但订单系统和库存系统的物理数据是完全不同的； 如果把2PC协商过程应用在同一个程序的不同进程，那就可以实现Raft效果了</div>2020-02-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/52/c7/f9ad5669.jpg" width="30px"><span>时彬斌</span> 👍（11） 💬（5）<div>关于一致性有些疑问，强一致性、最终一致性的区别不是很清晰，之前学习raft的时候看到，raft的leader在收到集群内一半以上的数据节点确认操作后就认为事务完成，这时有些节点的数据并没有更新完成，此时理解应该为最终一致性，为什么说raft是强一致性呢？raft强一致性难道仅仅体现在所有请求的处理都是在leader节点处理吗？</div>2020-02-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/1d/13/31ea1b0b.jpg" width="30px"><span>峰</span> 👍（11） 💬（8）<div>一直有个问题，两阶段协议解决的是分布式事务问题，而raft 这些解决的是分布式数据共识问题，即数据在主从副本的条件下保持数据对外始终一样。为什么这两个总混在一起说是解决一致性的呢？？？</div>2020-02-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（9） 💬（1）<div>感觉 TCC 也采用了两阶段提交的思想，是不是 TCC 是两阶段提交思想的一种实现？
在看文中的图，是代表 TCC 中，是客户端直接通知所有的节点吗？没有所谓的协作者了？</div>2020-02-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/14/c2/46ebe3a0.jpg" width="30px"><span>侧耳倾听</span> 👍（6） 💬（1）<div>既然说的是事务型分布式事务，首先要关注到分布式关键字，最好的事务控制永远是单机模式，但是问题是对于并发特别高的系统来说，读写的压力都会增加，系统可用性降低，会出现延迟不可访问等问题，所以将一些写入频繁的功能从系统中剥离出来，横向扩展，降低系统压力，提高可用性。由此而带来了新的问题，事务。通过文中叙述的协议解决分布式事务问题的数据不一致性，但是因为是分阶段的确认提交，在确认提交的过程中，增加了数据库记录锁的时间，对于用户私有数据来说，这影响不大，对于公有数据而言，分布式事务和单机事务区别不大，都需要排队等待。如果牺牲一致性，选择分区容错性，允许节点数据短暂不一致，提高了系统可用性，但是数据库之间的主从关系，复制备份等问题又随之而来，又将问题进一步扩大和转移。总之，当性能还说的过去的前提下，尽量不要向分布式发展。一入此门深似海。</div>2020-04-13</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJINWmZjibZA4eibL31PzMDia2yt1icOc9QnFWwTKuXbWTFCAZaMgCrqO7Oa5sZka81pHoibPgSM8nCjibA/132" width="30px"><span>超能力先生</span> 👍（6） 💬（3）<div>TCC try阶段的时候应该是直接commit了事务，confirm做确认，不然就撤销。这样才能达到减少资源锁定时间。感觉图里第一部预留资源的说法有点歧义。</div>2020-02-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8d/d7/886e9563.jpg" width="30px"><span>张高</span> 👍（6） 💬（4）<div>文中只说明了预留阶段出错了如何撤销，却没有说明：如果确认阶段出错了，该怎么处理。</div>2020-02-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/67/d5/1b26b725.jpg" width="30px"><span>Gopher</span> 👍（5） 💬（3）<div>老师请教一个问题：TCC 在请求阶段，各个节点不需要保留资源么？为何能解决2pc 需要释放资源后才能处理的问题</div>2020-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/21/8c13a2b4.jpg" width="30px"><span>周龙亭</span> 👍（4） 💬（1）<div>在2PC中的提交执行阶段，协调者发送给参与者的确认执行消息丢失，怎么办？</div>2020-04-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/7a/93/c9302518.jpg" width="30px"><span>高志强</span> 👍（3） 💬（1）<div>想问一下老师，分布式事物，在不同节点不基于数据库的实现，是不是难度很大。如果使用mysql实现事物，多个节点是不是就无法使用了</div>2020-02-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/e9/86/d34800a4.jpg" width="30px"><span>heyman</span> 👍（2） 💬（2）<div>看完以后，感觉跟mysql的redo log和binlog的两阶段提交不是同一个东西...老师可以指教一下吗？</div>2020-07-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5b/70/6411282d.jpg" width="30px"><span>陈</span> 👍（2） 💬（1）<div>事务型分布式系统的缺点是在并发情况下的资源锁定，优点是保证一致性。</div>2020-02-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/c9/23/76511858.jpg" width="30px"><span>洛奇</span> 👍（2） 💬（3）<div>老师，幂等性的操作能举几个例子吗？</div>2020-02-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/ef/5a/5d424d50.jpg" width="30px"><span>施耀南</span> 👍（2） 💬（1）<div>谢谢韩老师的讲解，通过学习我的理解是：事务型分布式系统
优点：就是最强一致性，保证所有节点都一致。
缺点：复杂带来的开销，节点增加业务规模增加可能导致延迟。</div>2020-02-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/b9/52/3f0251b9.jpg" width="30px"><span>ZXJ</span> 👍（1） 💬（1）<div>请问”如果不是必须，尽量不要实现事务，可以考虑采用强一致性或最终一致性。“这句话怎么理解，这里的事务是指满足ACID的意思吗？分布式事务，ACID，强一致性，最终一致性之间是怎么的关系？</div>2020-04-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/d0/2f/d7b16d4c.jpg" width="30px"><span>Sure</span> 👍（1） 💬（1）<div>我想分享下我的理解和疑问~ 感觉两阶段提交部分理解得可能不到位
1. 2PC中的预留和TCC中的预留有什么区别呢？ 
我理解是，2PC的预留是相较于业务系统以外的数据库系统来做的预留，而TCC则是业务层面的预留。
比如2PC中需要同时更新A B C三个表的字段，通过加锁的方式将三条记录锁定以达到其他线程无法更改的目的来进行预留。而在TCC中，假设一个转账操作，则是先把对应的资金转到一个中间表中进行业务上的锁定，再在confirm阶段完成整个操作。
TCC我的理解是通过业务逻辑+幂等来保证最终一致性，是一个更加灵活的方式，但是会侵入业务。
在2PC中，什么场景下会出现不一致的情况？边界是什么呢？</div>2020-03-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/47/31/f35367c8.jpg" width="30px"><span>小晏子</span> 👍（1） 💬（1）<div>事务型分布式系统优点就是能解决分布式系统中分布式事务的问题，但是缺点也很明显，就是实现复杂，业务侵入性强，比如TCC还要给每个操作写一个cancel操作，而且因为实现复杂，极易引入bug，维护麻烦，遇到问题不好定位，所以能不用尽量不用。</div>2020-02-17</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTL7cOHiaxJBPvdic53UfP4VC2P4EsyYOGNEwhgYsrP4kw7MFhI7fKQ0GnIiadIHUEYVD85AkrcGv5DLg/132" width="30px"><span>burner</span> 👍（0） 💬（1）<div>没接触过两阶段提交的同学不知道是不是和我一样看完一头雾水，苏秦在真实系统中到底是个什么角色？coordinator又是什么？建议用真实系统举例会更形象清晰，不然看完满脑子都是苏秦忙来忙去，无法对应到现实系统中理解</div>2020-06-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/83/39/f9623363.jpg" width="30px"><span>竹马彦四郎的好朋友影法師</span> 👍（0） 💬（1）<div>提纲挈领，醍醐灌顶，多谢老师！</div>2020-04-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/49/fc/5627215c.jpg" width="30px"><span>小何</span> 👍（0） 💬（1）<div>老师在评论里说，针对分布式事务的一些实现细节，比如日志、重试等会有加餐内容，这个是什么时候有呢？</div>2020-04-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/b8/49/99ca2069.jpg" width="30px"><span>哼歌儿李</span> 👍（0） 💬（1）<div>关于二阶段提交和TCC有个具体的使用场景介绍就更好了</div>2020-03-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4d/49/28e73b9c.jpg" width="30px"><span>明翼</span> 👍（0） 💬（1）<div>我理解分布式事务优点在一个大型分布式系统上实现事务从而可以保存更多数据，提升性能，以前单机虽然也有事务但是数据量受限性能也差；缺点嘛，就是需要多次交互，逻辑复杂容易出错。
二阶段提交和Tcc很像，都问准备好了吗？准备好了。那就执行吧！区别tcc客户端参与很深造成代码侵入者强</div>2020-03-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg" width="30px"><span>安排</span> 👍（0） 💬（1）<div>raft自身的数据加上客户端怎么实现系统的强一致性？</div>2020-03-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/11/5b/f08018d3.jpg" width="30px"><span>paddy</span> 👍（0） 💬（1）<div>老师，ACID里的一致性与CAP理论里的一致性，是同一回事么，他们之间有区别么？我理解CAP中的C更强调数据副本中一致性，同一份数据有没有达成共识，而ACID中的C更强调事务中的一致性，比如两个账户在不同的数据库实例，转账操作一个成功了一个失败了，由于原子性没保证，导致了数据的不一致。这里有些不清楚，是概念搞混淆了么？</div>2020-03-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/78/75/44e35ec5.jpg" width="30px"><span>文龙</span> 👍（0） 💬（1）<div>能结合一些真实场景，就更好了。期待加餐 :D</div>2020-02-29</li><br/>
</ul>