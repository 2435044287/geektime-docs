你好，我是韩健。

很多同学在开发系统的时候，都会有这样的感觉：明明自己看了很多资料，掌握了技术背后的原理，可在开发和调试的时候还是很吃力，这是为什么呢？

答案很简单，因为理论和实践本来就是两回事，实践不仅需要掌握API接口的用法，还需要理解API背后的代码实现。

所以，如果你在使用Raft开发分布式系统的时候，仅仅阅读Raft论文或者Raft实现的API手册，是远远不够的。你还要吃透API背后的代码实现，“不仅知其然，也要知其所以然”，这样才能“一切尽在掌握中”，从而开发实现能稳定运行的分布式系统。那么怎么做才能吃透Raft的代码实现呢？

要知道，任何Raft实现都承载了两个目标：实现Raft算法的原理，设计易用的API接口。所以，你不仅要从算法原理的角度理解代码实现，而且要从场景使用的角度理解API接口的用法。

而我会用两节课的时间，**从代码实现和接口使用两个角度，**带你循序渐进地掌握当前流行的一个Raft实现：[Hashicorp Raft](https://github.com/hashicorp/raft)（以最新稳定版v1.1.1为例）。希望你在这个过程中集中注意力，勾划重点，以便提高学习效率，吃透原理对应的技术实现，彻底掌握Raft算法的实战技巧。

本节课，我会从算法原理的角度，聊一聊Raft算法的核心功能（领导者选举和日志复制）在Hashicorp Raft中是如何实现的。（如果Raft算法的原理你已经忘得差不多了，那你可以先回顾下7～9讲，加深印象之后，再进入今天的学习。）
<div><strong>精选留言（21）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/19/b3/57/2d92cf9a.jpg" width="30px"><span>姜川</span> 👍（21） 💬（2）<div>Java版可以看dledger </div>2020-03-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/00/4e/be2b206b.jpg" width="30px"><span>吴小智</span> 👍（8） 💬（2）<div>Raft 说到底就是保证集群中各节点的日志一致，那么在  Consul、InfluxDB、IPFS 中，Raft 又是怎么被使用的呢？</div>2020-03-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/f6/e3/e4bcd69e.jpg" width="30px"><span>沉淀的梦想</span> 👍（7） 💬（2）<div>流水线复制是如何优化日志复制的性能的呢？</div>2020-03-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/00/4e/be2b206b.jpg" width="30px"><span>吴小智</span> 👍（6） 💬（1）<div>Leader 收到 client 请求，然后把日志写到自己的 disk 中，然后通知 Follower 复制日志，然后 leader 等待相应，收到大多数相应后，commit 该条日志；在代码中，只找到了 “Leader 收到 client 请求，然后把日志写到自己的 disk 中，然后通知 Follower 复制日志”，没找到 leader 是如何判断是否有大多数相应，且是在什么时候 commit 的。希望老师可以指点一下？
PS：源代码中的 chan 通信，真的折磨人。</div>2020-03-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/53/db/858337e3.jpg" width="30px"><span>Ethan Liu</span> 👍（2） 💬（1）<div>老师 runFollower()里面这两个判断 if r.configurations.latestIndex == 0 和 if r.configurations.latestIndex == r.configurations.committedIndex &amp;&amp; !hasVote(r.configurations.latest, r.localID) 原理是什么啊？</div>2020-06-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（2） 💬（1）<div>Hashicorp Raft  找了半天 没有找到入口 main 函数</div>2020-03-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6c/ea/ce9854a5.jpg" width="30px"><span>坤</span> 👍（2） 💬（1）<div>韩老师，您好，hashicorp 实现的raft package, 我看github上的标签是build failed, 我试过多个tag都是一样的。</div>2020-03-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg" width="30px"><span>每天晒白牙</span> 👍（2） 💬（1）<div>好，下去结合之前的理论看看源码</div>2020-03-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/47/e2/cfbeb06c.jpg" width="30px"><span>cyq</span> 👍（1） 💬（2）<div>对于hashicorp&#47;raft的代码中，如果一个节点是candidate状态。那么他是在什么时候会恢复为Follower的身份?</div>2020-05-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c3/5d/ced9b5c2.jpg" width="30px"><span>Michael Tesla</span> 👍（1） 💬（2）<div>老师，是不是得先把大论文看一遍，再看代码，效果比较好？</div>2020-03-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/13/35/45391914.jpg" width="30px"><span>冷笑的花猫</span> 👍（1） 💬（1）<div>选举leader那段，先投自己一票，然后通过rpc让其它节点投票给自己。有些不理解，1  如果随机时间没收到投票怎么办？2  其它节点是如何回应这个投票信息的，基于什么标准决定投还是不投？ 谢谢</div>2020-03-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/07/8c/0d886dcc.jpg" width="30px"><span>蚂蚁内推+v</span> 👍（0） 💬（1）<div>startStopReplication和replicate函数区别是啥？怎么都是日志复制相关功能...</div>2020-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/8c/5e/8cb6fad1.jpg" width="30px"><span>cbping</span> 👍（0） 💬（1）<div>源码在哪里呢？</div>2020-04-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/e8/ca/2a7cc193.jpg" width="30px"><span>阿鼎</span> 👍（0） 💬（1）<div>请问老师，分布式系统，日志分散，排查问题有什么经验？有什么基础工具可以运用。</div>2020-04-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0a/e3/9637bfdb.jpg" width="30px"><span>Ricky Fung</span> 👍（6） 💬（0）<div>c++ 实现可以看百度开源的 braft：https:&#47;&#47;github.com&#47;baidu&#47;braft
java实现可以看蚂蚁金服开源的sofa-jraft：https:&#47;&#47;github.com&#47;sofastack&#47;sofa-jraft</div>2021-06-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0a/e3/9637bfdb.jpg" width="30px"><span>Ricky Fung</span> 👍（3） 💬（1）<div>java实现可参考蚂蚁金服开源的 sofa-jraft：https:&#47;&#47;github.com&#47;sofastack&#47;sofa-jraft
c++实现可参考百度开源的 braft：https:&#47;&#47;github.com&#47;baidu&#47;braft</div>2021-06-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/16/6b/af7c7745.jpg" width="30px"><span>tiny🌾</span> 👍（0） 💬（0）<div>只有一个领导节点能写，那怎么保证性能了？ 如果写性能扛不住怎么办啊</div>2022-04-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/15/03/682bd618.jpg" width="30px"><span>DavidJiang</span> 👍（0） 💬（0）<div>这个日志复制复制的具体是啥?和mysql中的binlog有什么本质的区别,看上去都是指令在本地执行.那么是否也会面临binlog复制的问题?</div>2021-09-22</li><br/><li><img src="" width="30px"><span>Geek_a2ca6c</span> 👍（0） 💬（0）<div>我看这个实现的源代码里，requestvote函数，先是检查本地状态机的leader信息有没有，如果有leader信息，并且和发起投票的节点不一致，就拒绝本次投票。那是不是说并不是最先超时发起投票的节点不一定成为主几点，的集群大多数人超时后失去leader信息后，才会发起投票吗。</div>2021-04-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ef/64/5b71bb14.jpg" width="30px"><span>David</span> 👍（0） 💬（0）<div>老师好，订阅这门课程有收获，谢谢！
在阅读Raft源代码时，有个疑问（可能是还没有看明白原因）：follower接收投票请求时，会做些参数验证，具体代码是这几行：
if leader := r.Leader(); leader != &quot;&quot; &amp;&amp; leader != candidate &amp;&amp; !req.LeadershipTransfer {
		r.logger.Warn(fmt.Sprintf(&quot;Rejecting vote request from %v since we have a leader: %v&quot;,
			candidate, leader))
		return
	}
我的疑问是这样的：某候选者进入拉票阶段时，因每个follower的timeout不一样，这行代码:
leader := r.Leader(); leader != &quot;&quot; &amp;&amp; leader != candidate &amp;&amp; !req.LeadershipTransfer 有概率似乎为true的，请问老师这里怎么理解呢，非常感谢！
	</div>2021-04-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/96/47/93838ff7.jpg" width="30px"><span>青鸟飞鱼</span> 👍（0） 💬（0）<div>最近正好学习了go，真是干货满满。</div>2020-11-12</li><br/>
</ul>