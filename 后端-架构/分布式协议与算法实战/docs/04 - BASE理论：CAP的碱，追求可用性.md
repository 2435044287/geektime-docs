你好，我是韩健。

很多同学可能喜欢使用事务型的分布式系统，或者是强一致性的分布式系统，因为使用起来很方便，不需要考虑太多，就像使用单机系统一样。但是学了CAP理论后，你肯定知道在分布式系统中要实现强一致性必然会影响可用性。比如，在采用两阶段提交协议的集群系统中，因为执行提交操作，需要所有节点确认和投票。

所以，集群的可用性是每个节点可用性的乘积，比如，假设3个节点的集群，每个节点的可用性为99.9％，那么整个集群的可用性为99.7％，也就是说，每个月约宕机129.6分钟，**这是非常严重的问题。** 而解决可用性低的关键在于，根据实际场景，尽量采用可用性优先的AP模型。

讲到这儿，可能会有一些同学“举手提问”：这也太难了，难道没有现成的库或者方案，来实现合适的AP模型？是的，的确没有。因为它是一个动态模型，是基于业务场景特点妥协折中后设计实现的。不过，你可以借助BASE理论帮助你达成目的。

在我看来，BASE理论是CAP理论中的AP的延伸，是对互联网大规模分布式系统的实践总结，强调可用性。几乎所有的互联网后台分布式系统都有BASE的支持，这个理论很重要，地位也很高。一旦掌握它，你就能掌握绝大部分场景的分布式系统的架构技巧，设计出适合业务场景特点的、高可用性的分布式系统。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/65/ca/38dcd55a.jpg" width="30px"><span>lupguo</span> 👍（50） 💬（1）<div>在系统过载情况，一方面考虑提供有损服务，弃朱保帅，另一方面积极寻求资源扩容，提升整体系统的吞吐量

1. 流量错峰（不同地区售票时间错峰出售）
2. 异步处理（买票排队，基于队列先收到用户买票请求，排队异步处理，延迟响应）
3. 服务降级（看到非实时数据，采用缓存数据提供服务）
4. 过载保护（熔断&#47;限流，直接拒绝掉一部分请求，或者当请求队列满了，移除一部分请求，保证整体系统可用）
5. 故障隔离（出现故障，做到故障隔离，避免影响其他服务）
6. 弹性扩容（基于Metric和Monitor实现系统态势感知，做到弹性伸缩）</div>2020-03-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/48/f3/65c7e3ef.jpg" width="30px"><span>cricket1981</span> 👍（31） 💬（1）<div>All、Quorum、One、Any一致性级别中One和Any的区别是什么？</div>2020-02-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/10/e8/ec11e306.jpg" width="30px"><span>Purson</span> 👍（20） 💬（4）<div>还有熔断和限流。 发现文稿里面关于最终一致性中，写的描述有矛盾：“写时修复：在写入数据，检测数据的不一致时，进行修复。” 后面 “在这里，我想强调的是因为写时修复不需要做数据一致性对比，性能消耗比较低，”  前面说写的时候有做一致性对比，后面说写的时候没有做一致性对比。其实写的时候修复主要通过失败重试的方式吧？</div>2020-02-19</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJOBwR7MCVqwZbPA5RQ2mjUjd571jUXUcBCE7lY5vSMibWn8D5S4PzDZMaAhRPdnRBqYbVOBTJibhJg/132" width="30px"><span>ヾ(◍°∇°◍)ﾉﾞ</span> 👍（16） 💬（1）<div>acid是数据库系统经典之作；base是在实践中受挫后的思想松绑，提出一种重要的指导，给人以信心</div>2020-02-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8d/ed/ea2cbf3a.jpg" width="30px"><span>Sinclairs</span> 👍（10） 💬（2）<div>从微服务的角度来考虑, 有这些方式能够尽可能地保证系统的基本可用:
1. 使用消息队列, 对偶然的高并发写操作进行削峰填谷;
2. 对进程间的服务调用做好熔断保护;
3. 在系统能力无法支撑高并发访问时, 对非核心业务降级;
4. 对关键服务做好限流.</div>2020-02-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/cd/e1/368f872c.jpg" width="30px"><span>NEO🍋</span> 👍（8） 💬（1）<div>All、Quorum、One、Any 是什么？没有介绍；
读写时修复 异步修复 又是个什么？修复什么？为什么需要修复？怎么修复？没讲清楚 难以理解 记住；
建议优化讲课方式 关键术语前置介绍 关键动作配合案例(不是一个大而泛的案例-比如文中的自研库 而是非常具体的数据例子)</div>2020-04-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/fa/fd/ec24cba7.jpg" width="30px"><span>fcb的鱼</span> 👍（8） 💬（1）<div>实现最终一致性的方案中,更侧重于存储层面的事情吧。假设有A,B,C三个节点，那么&quot;读时修复&quot;方案是不是意味着每个读操作，会同时访问这三个节点吗，然后比对三个节点返回的数据是否一样，一样的话返回任意一个节点的数据，不一样了再以最新的数据为准，并且修复其他不同节点的数据？在AP模型的应用中，是不是得同时校验几个节点的数据是否一致？</div>2020-02-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/3f/1c/1e4dfbc9.jpg" width="30px"><span>远方</span> 👍（6） 💬（5）<div>hadoop的hdfs文件系统和kafka消息队列，按我的理解，也是基于ap的扩展base理论开发的，是这样的吧？</div>2020-02-21</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKhuGLVRYZibOTfMumk53Wn8Q0Rkg0o6DzTicbibCq42lWQoZ8lFeQvicaXuZa7dYsr9URMrtpXMVDDww/132" width="30px"><span>hello</span> 👍（6） 💬（1）<div>重试、幂等、异步、负载均衡、故障隔离、流量切换、自动扩缩容、兜底（熔断限流降级）、容量规划</div>2020-02-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg" width="30px"><span>每天晒白牙</span> 👍（6） 💬（1）<div>1.服务调用之间做好流量限制，即限流，避免瞬时打进大量流量
2.利用MQ实现削峰填谷
3.熔断降级也是一种保证基本可用的方案，但实际工作中我还没尝试过</div>2020-02-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c7/e6/11f21cb4.jpg" width="30px"><span>川杰</span> 👍（5） 💬（1）<div>请问：写时修复：在写入数据，检测数据的不一致时，进行修复；这个比对，是指和其它节点数据比对吧？那么数据以谁为准呢？极端情况下，每个节点上的数据都不一样，我该听谁的？</div>2020-02-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/9b/94/4977913a.jpg" width="30px"><span>reven404</span> 👍（4） 💬（2）<div>“所以，集群的可用性是每个节点可用性的乘积，比如，假设 3 个节点的集群，每个节点的可用性为 99.9％，那么整个集群的可用性为 99.7％”按道理除非同时宕机否则其中一个宕机其他节点不是应该继续提供服务么？为什么可用性还是会降低，这里的集群定义是不是有其他特殊的含义？</div>2020-04-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8a/02/828938c9.jpg" width="30px"><span>Frank</span> 👍（4） 💬（4）<div>针对文中实现最终一致性的具体方式中，自己在项目中是将写时修复与异步一起用。举个例子，比如用户修改了数据，数据落库到MySQL，通过AOP切面的方式通过MQ消息异步更新数据到ES，实现最终一致性。个人觉得这样在写请求量大时，可减少延迟响应。如果写请求量较少，也可直接省掉MQ这一步，直接同步写到ES，但是要保证MySQL和ES的数据最终一致。</div>2020-03-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/36/75/e346e04e.jpg" width="30px"><span>一个慢慢爬行的普通人</span> 👍（2） 💬（1）<div>为什么写时修复不需要做一致性对比</div>2020-06-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/a1/87/259ab5a3.jpg" width="30px"><span>桂冠远航</span> 👍（1） 💬（1）<div>酸碱中和。</div>2020-03-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg" width="30px"><span>安排</span> 👍（1） 💬（1）<div>写时修复，写失败将数据缓存到本地磁盘上，这个是缓存到客户端磁盘吗？还是服务节点的磁盘？</div>2020-03-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/fa/fd/ec24cba7.jpg" width="30px"><span>fcb的鱼</span> 👍（1） 💬（1）<div>在使用Base理论的举例中，3节点2个副本的架构中，再各个节点中这2个副本的数据最终要是一样的吧？在一个系统整体的架构中，上游的系统可以使用Base理论，但是底层的系统如支付系统需要使用强一致性，这样的话，支付系统就称为了瓶颈。在这种场景中，整个系统的架构应该如何考虑呢?</div>2020-02-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c3/5d/ced9b5c2.jpg" width="30px"><span>Michael Tesla</span> 👍（1） 💬（1）<div>老师好，请教下这个 3 节点 2 副本的InfluxDB集群的工作流程：
1. 正常工作时，某个分片的数据只在节点1写入，然后节点1将数据同步到节点2。
2. 如果节点1挂了，客户端就将数据写入节点2。
3. 之后，等节点1恢复，节点2将数据同步回节点1（即写时恢复），同时客户端也重新将数据写入节点1。</div>2020-02-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/47/31/f35367c8.jpg" width="30px"><span>小晏子</span> 👍（1） 💬（1）<div>这几个“流量削峰、延迟响应、体验降级、过载保护”都是为了实现业务的基本可用的手段。比如在秒杀场景中，会突然之间有大流量的请求涌入，而对付这些过载流量，就需要使用这几个手段来保障业务的可用性。
</div>2020-02-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/30/3c/0668d6ae.jpg" width="30px"><span>盘胧</span> 👍（1） 💬（1）<div>在最前端链路就做好流量控制，和最后的兜底方案</div>2020-02-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/87/30/4626c8c0.jpg" width="30px"><span>Fs</span> 👍（1） 💬（1）<div>流量削峰、延迟响应、体验降级、过载保护这些也不只是分布式系统问题，单机同样也有</div>2020-02-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/14/c2/46ebe3a0.jpg" width="30px"><span>侧耳倾听</span> 👍（0） 💬（1）<div>几乎所有的互联网系统采用的都是最终一致性，只有在实在无法使用最终一致性，才使用强一致性或事务，比如，对于决定系统运行的敏感元数据，需要考虑采用强一致性，对于与钱有关的支付系统或金融系统的数据，需要考虑采用事务。
————
觉得这段话描述的有些歧义，互联网系统应该大部分依然采用的是强一致性的策略，最终一致性是在无法实现强一致性事务时的妥协，主宾有些倒置的感觉。</div>2020-06-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c3/5d/ced9b5c2.jpg" width="30px"><span>Michael Tesla</span> 👍（0） 💬（2）<div>老师，你好！文中提到最终一致性可以“以最新写入的数据为准”，分布式系统中这个“最新”怎么定义？我想到版本号来实现，除了这个，还有其他办法吗？</div>2020-05-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/49/a5/e4c1c2d4.jpg" width="30px"><span>小文同学</span> 👍（0） 💬（2）<div>最终一致性的实现，其实我还不是很了解。我想到了一个ABA问题，如 DB1 DB2 构成系统，并发生通信异常，DB1 的数据A 从 1-&gt;2-&gt;1，其实它的更新是最新的，而 DB2 的数据A 从 1 -&gt; 3，这个数据快于 DB1 1-&gt;2 , 但慢于其 2 -&gt; 1，这个时候，集群对数据A应该是什么值？其最终一致性又应该以什么为准?</div>2020-04-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/65/ca/38dcd55a.jpg" width="30px"><span>lupguo</span> 👍（0） 💬（1）<div>1. BASE最终一致性以什么数据为准，以及如何实现BASE一致性（读时修复、写时修复、异步修复），这块还是有一些不清晰。
2. 我理解的最终一致，有两个层面，第一层面是一个整体业务的数据一致，比如生单操作（包含订单数据、营销数据等最终一致），最终是要整体一致的，不能出现只有部分数据写成功；第二个层面是单个业务数据如果做了分片或多副本数据，需要保证每个节点的最终是一致的，允许部分分片或节点在一段时间内是不一致的，不知道这样理解是不是有偏差，请老师点评下？
3. 如果针对2中这两类情况，一致性数据以什么为准应对如何理解，以及读时修复、写时修复、异步修复这三个具体操作应该如何实施？</div>2020-03-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4d/54/9c214885.jpg" width="30px"><span>kylexy_0817</span> 👍（0） 💬（1）<div>熔断就是过载保护的其中一种实现吧？</div>2020-03-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5b/70/6411282d.jpg" width="30px"><span>陈</span> 👍（0） 💬（1）<div>我觉得还有故障和服务隔离，弹性扩容等等。</div>2020-02-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/ef/5a/5d424d50.jpg" width="30px"><span>施耀南</span> 👍（0） 💬（1）<div>谢谢老师课程，基本明白，为保证基本可用除了上述方案，我们游戏业务中，还有流量控制！</div>2020-02-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/82/3d/356fc3d6.jpg" width="30px"><span>忆水寒</span> 👍（0） 💬（1）<div>限流策略、熔断机制关闭部分服务等。</div>2020-02-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/33/14/78104f1f.jpg" width="30px"><span>Just Do IT</span> 👍（0） 💬（0）<div>延迟响应、过载保护都用到了队列，这两个不是一回事么？</div>2023-06-19</li><br/>
</ul>