你好，我是姚秋辰。

上一课我们学习了如何借助Nacos的服务发现机制获取可用服务节点列表，并发起远程服务调用。在服务调用的环节里，还有一处细节需要你思考一下：Nacos通过服务发现拿到了所有的可用服务节点列表，但服务请求只能发给一个节点，你知道服务调用是根据什么规则选择目标节点的吗？

“小孩子才做选择，大人全都要”，Nacos就是这个全都要的大人。服务列表都被它拿到了手里，但如果要完成一次完整的服务调用，它还需要一个小孩子帮忙做选择，这个做选择题的小孩就是客户端负载均衡组件Spring Cloud Loadbalancer，它根据负载均衡规则，从Nacos获取的服务列表中选取服务调用的目标地址。

那么，Loadbalancer背后是如何工作的呢？今天我就带你了解Spring Cloud御用负载均衡器Loadbalancer的原理。通过这节课，你可以收获以下内容。

1. **负载均衡的作用**：了解负载均衡的两大门派，它们分别是网关层负载均衡和客户端负载均衡。你还会理解客户端负载均衡在微服务架构中的优势；
2. **Loadbalancer工作原理**：了解Loadbalancer如何运用@Loadbalanced注解进行加载；
3. **自定义负载均衡策略**：了解Loadbalancer的自定义扩展点，在实战项目中实现金丝雀测试。
<div><strong>精选留言（24）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg" width="30px"><span>peter</span> 👍（12） 💬（3）<div>老师我有个关于代理的问题：一般用nginx将请求转发到后端多个应用服务器上。现在用了API网关，由API网关将请求转发到后端应用服务器上。这样的话，API网关和nginx的功能就重复了，就不需要nginx了，对吗？ 尤其对于中小公司，服务器数量不是很多，nginx就足够了，或者用API网关就足够了，两者选一个就够了啊。</div>2022-01-06</li><br/><li><img src="" width="30px"><span>Geek_0b93c0</span> 👍（10） 💬（1）<div>集群优先代码

    private Response&lt;ServiceInstance&gt; getSameClusterService(Request request, List&lt;ServiceInstance&gt; instances) {
        String clusterName = environment.resolvePlaceholders(&quot;${spring.cloud.nacos.discovery.cluster-name:}&quot;);
        List&lt;ServiceInstance&gt; instanceList = instances.stream().filter(v -&gt; {
            Map&lt;String, String&gt; metadata = v.getMetadata();
            String serviceClusterName = metadata.get(&quot;nacos.cluster&quot;);
            return clusterName.equals(serviceClusterName);
        }).collect(Collectors.toList());
        &#47;&#47;有同集群下服务 RoundRobin算法挑选
        if (CollectionUtils.isNotEmpty(instanceList)){
            return getRoundRobinInstance(instanceList);
        }else {
            return getRoundRobinInstance(instances);
        }
    }</div>2022-05-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/60/85/f72f1d94.jpg" width="30px"><span>与路同飞</span> 👍（10） 💬（2）<div>现在公司所有api服务都是注册到api网关上去了。api网关替我们做了负载均衡和路由规则。那业务团队是不是就不需要引用负载均衡组件了</div>2022-01-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/e9/fd/4abed049.jpg" width="30px"><span>何衍其</span> 👍（9） 💬（2）<div>&#47;&#47; 当前服务的集群名称
 String clusterName = environment.resolvePlaceholders(&quot;${spring.cloud.nacos.discovery.cluster-name:}&quot;);

&#47;&#47; 服务实列所属集群名称
serviceInstance.getMetadata().get(&quot;nacos.cluster&quot;);</div>2022-04-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/14/85/73e55be5.jpg" width="30px"><span>~</span> 👍（5） 💬（3）<div>说一下思考题我的思路：
从 CanaryRule 就可以看出来了，其实实现负载均衡的逻辑就在getRoundRobinInstance中，我们只需要改造这里就可以了。我的想法是设置一个缓存（map 也好，其他的也好），存放上次选择出的 serverInstance，如果是第一次选择，那么使用老逻辑选出一个，如果上次选择的服务已经不可用了，就从缓存中清除，重新选一个就可以了。
补充2点：
1. 怎么判断一个服务是否可用？其实在这里的代码中，传入的 List&lt;ServiceInstance&gt; 参数就是从 nacos 中获取到的可用服务的列表。那么只需要判断缓存中存放的 serviceInstance 是否也在 list 中就可以了。具体怎么获取到可用服务列表的，需要进一步查看源码才能了解。
2. 仅做一个猜想，不具有实际意义，老师如果能解答也再好不过了：能否直接在获取可用服务列表那步就直接确定一个服务？其他的逻辑也是如此。就算可行其实设计上也是不合理的，因为获取可用服务的代码就应该只负责相关逻辑，负载均衡代码就应该只管负载均衡。提出这个猜想只不过是想对源码有进一步了解，设计上还是各司其职更合理。

以上就是我的思考，附上代码（超过字数限制了，放在我的留言的回复里了），如果有问题，欢迎指出问题~
</div>2022-01-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/40/dd/0ed6f0b9.jpg" width="30px"><span>Yarnbo</span> 👍（1） 💬（1）<div>姚总好，学习了您的本节课受益匪浅。虽然照葫芦画瓢也实现了“优先调用同一个 Cluster 的服务器”，但是这样做的意义有哪些，能结合您的经验介绍下吗？（我能盲猜到的是，假如服务以集群为基本单元提供服务能力，将来方便弹性扩展机器）</div>2022-09-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/db/58/a7a0a85b.jpg" width="30px"><span>二饼</span> 👍（1） 💬（2）<div>Nacos-服务管理-服务列表-开发环境 `coupon-template-serv` 只有一个实例，不是两个，我又把前面的文章看了一遍，没有发现什么地方又说定义了两个实例，和示例代码比对了一下配置文件没看出什么问题，请教一下老师我这是什么造成的？</div>2022-08-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/27/53/fb/c62a8490.jpg" width="30px"><span>胖子菜</span> 👍（1） 💬（1）<div>dubbo整合了nacos后，因为我用的最新版本的nacos没有自带ribbon,我又引入了loadbalancer依赖，我想问下dubbo有负载均衡机制，loadbancer也有，他们冲突么，谁会生效呢</div>2022-05-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/db/26/54f2c164.jpg" width="30px"><span>靠人品去赢</span> 👍（1） 💬（1）<div>像金丝雀这些线上验证，会产生线上数据，万一没搞好打标打错了或者没配置好，导入到正常服务的机器上没有到金丝雀上，怎么辨别消除影响呢？</div>2022-04-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/39/24/963178c4.jpg" width="30px"><span>rrbbt</span> 👍（0） 💬（1）<div>老师能详细讲一下这句话吗？没太看懂，为什么不应用到全局？不加@Configuration就能不应用到全局吗？===========[原文]&quot;因为我不希望把这个负载均衡策略应用到全局，所以我没有为这个配置类添加 @Configuration 注解&quot;</div>2023-06-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/20/3a/e5/1a1b08ad.jpg" width="30px"><span>乘风</span> 👍（0） 💬（1）<div>金丝雀负载均衡策略好像并没有强依赖WebClient呀，为什么说它是专门针对WebClient方式的远程调用，难道openFeigh用不了？</div>2022-09-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d5/3e/7f3a9c2b.jpg" width="30px"><span>Jaising</span> 👍（0） 💬（2）<div>半仙老师，遇到个负载失效的问题帮忙排查下怎么回事，应用中引入了两个二方库starter A和B，两个starter都各自定义了一个RestTemplate，A做了LoadBalance，B没有，单独引入A或B都可以正常发起http调用，但是同时引入两个starter后，B正常，A却负载失效了报错no instances available，这是咋回事</div>2022-06-22</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLyfaTNuvbkiclibb8EuNOiaI2sicPgB0icmOB7f81POSbchoRickQpDxXC3p83D41icIppbHXJ4Vx1j3ulw/132" width="30px"><span>Geek_5d68ab</span> 👍（0） 💬（1）<div>把老师的代码down下来之后，启动服务，请求接口不经过CanaryRule是怎么回事？</div>2022-05-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/65/7b/cddf667b.jpg" width="30px"><span>丶凯</span> 👍（0） 💬（1）<div>包含了新的代码改动的服务器就是这个金丝雀,  老师这句话什么意思？
</div>2022-04-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/30/c1/2dde6700.jpg" width="30px"><span>密码123456</span> 👍（0） 💬（2）<div>LoadBalancerClientFactory.getLazyProvider这个方法，为什么name随便写一个值不行？必须是服务名称？</div>2022-02-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/5e/86/40877404.jpg" width="30px"><span>星星滴蓝天</span> 👍（0） 💬（1）<div>这种灰度控制一个公司里面多个部门咋协调呢？会不会搞出来冲突</div>2022-01-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2b/c6/3d/8a84d713.jpg" width="30px"><span>张叔叔</span> 👍（0） 💬（3）<div>老师 添加元数据的时候 报错&quot;caused: errCode: 500, errMsg: do metadata operation failed ;caused: errCode: 500, errMsg: do metadata operation failed Could not find leader : naming_instance_metadata ;&quot; 是什么原因呢</div>2022-01-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/1e/cf/97cd8be1.jpg" width="30px"><span>so long</span> 👍（0） 💬（1）<div>老师，自动装配器ReactorLoadBalancerClientAutoConfiguration中， 如果关闭了Loadbalancer的重试功能 ，则初始化ReactorLoadBalancerExchangeFilterFunction对象的代码复制错了</div>2022-01-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/da/67/73a0c754.jpg" width="30px"><span>gallifrey</span> 👍（0） 💬（2）<div>服务详情-编辑实例中，点击确定没有任何更新怎么办。。。找不到解决方案</div>2022-01-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cf/5d/99756164.jpg" width="30px"><span>思绪走了灬光✨</span> 👍（21） 💬（1）<div>技术人员的成长来源于两个方面，一个是工作中用到的新技术和高并发挑战，另一个就是自己主动的拓展。而越到后期，你会发现第二个方向对自己的提升逐渐占据了主导地位。为什么呢？当你工作积累到一定年限之后，很容易发现工作内的业务需求已经没有太多的技术挑战，你的技术积累也足以应付每天的工作。这时候如果没有自己由内向外的主动拓展，你很容易就陷入了一个原地踏步的境地。</div>2022-01-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/ce/cc/ec5895b0.jpg" width="30px"><span>找工作</span> 👍（3） 💬（2）<div>在postman里加header怎么都没用，鼓捣了一小时发现，不是requestcoupon的header，而是应该加在gettemplate的header</div>2022-03-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/30/c1/2dde6700.jpg" width="30px"><span>密码123456</span> 👍（1） 💬（0）<div>整明白了，根据服务名称多次建立spring容器。而且带有层级的容器。动态刷新的负载均衡配置，LoadBalancerClientSpecification</div>2022-02-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2e/3d/1b/a592fde1.jpg" width="30px"><span>帥樂</span> 👍（0） 💬（0）<div>希望你不要在技术学习上给自己设界，多去了解更多技术框架的全貌，积累到一定程度之后，这些努力都会在未来某一个时刻给你回报</div>2023-03-12</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/cjichzNjhghHD9DJEXCBrh1PqmmlfBwC84NKbn9obLYEGCBDiaqufEArL26Qy0YiaibVbhcnYON7oqh7v6HgCjmk3g/132" width="30px"><span>Geek_eca226</span> 👍（0） 💬（0）<div>原来后置处理器是这样用的，最开始学习spring讲bean的生命周期时有个前置处理，后置处理一直不知道起什么作用</div>2022-07-14</li><br/>
</ul>