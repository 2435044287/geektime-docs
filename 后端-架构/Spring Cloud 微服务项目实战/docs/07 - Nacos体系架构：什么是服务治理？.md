你好，我是姚秋辰。

从今天开始，我们的课程就正式进入Spring Cloud环节了。我先带你学习微服务架构中一个最重要的原理概念：**服务治理**。在概念讲解之后，我还会向你介绍**Nacos服务注册中心的体系结构**。通过这节课的学习，你可以了解微服务的完整生命周期，知晓服务注册中心在微服务架构中发挥了什么作用，这些内容能让你对Nacos的体系架构有一个比较全面的认识。

首先，让我通过一个例子告诉你服务治理解决了什么问题。

我的系统包含两个微服务（服务A和服务B），每一个微服务有10个虚拟节点，两个服务组成了一个20台虚拟机的微服务集群。如果此时微服务A想要调用微服务B，我们怎么来发起这个调用呢？

一种通用做法是：在服务A的配置文件中添加一个指向服务B的地址，但这个地址并不直接指向任何一台服务B集群中的节点，而是指向一个VIP（虚拟IP地址）或者是一个网关。这个VIP或网关背后维护了B集群的服务节点列表，VIP层通过负载均衡策略再将请求转到后面配置的某一台服务器。我画了一幅图来描述这个服务调用过程。

![](https://static001.geekbang.org/resource/image/fc/0d/fcd15ed204d43fe615cb50acbe58010d.jpg?wh=2000x984)

从上面的图中我们可以看出，服务A与服务B之间互相不直接通信，服务调用完全依靠VIP作为中间人来完成。我们如果想要为服务集群扩容或缩容，必须将服务器配置到对应的VIP地址上。如果你的应用是一个由数百个微服务组成的大型应用，光是管理这些VIP Pool的人力成本就够网络运维团队喝上一壶了。
<div><strong>精选留言（19）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/1c/f4/c7/037235c9.jpg" width="30px"><span>kimoti</span> 👍（24） 💬（7）<div>想请教老师为啥要保持一致性？</div>2021-12-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/59/26/1015d573.jpg" width="30px"><span>gevin</span> 👍（15） 💬（2）<div>老师，请教个问题。用nacos做服务注册时，如果有些服务时本地起的，有些是docker起的，那么默认情况下，docker起的服务，nacos中的注册地址是docker内部IP，本地起的服务，nacos中注册地址是本地服务器的IP，这就导致了本地服务访问不到docker服务的问题。
对于这个问题，现在用的比较多的解决方案有哪些？</div>2021-12-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/a1/6d/a4ff33bb.jpg" width="30px"><span>Lee</span> 👍（10） 💬（1）<div>请教老师一下，如果在a服务调用b服务的时候，b服务挂了，好像探活是有时间间隔的，万一刚好在这种时间间隔中，怎么处理</div>2022-05-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ca/e1/d8537537.jpg" width="30px"><span>梁😜</span> 👍（9） 💬（1）<div>为啥要保持一致性？因为Nacos 是一个需要存储数据的中间件，因此就需要在 Nacos 内部实现数据存储。单机下其实问题不大，简单的内嵌关系型数据库即可；但是集群模式下，就需要考虑如何保障各个节点之间的数据一致性以及数据同步，而要解决这个问题，就不得不引入共识算法，通过算法来保障各个节点之间的数据的一致性。</div>2022-01-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/d7/9a/38d14e5f.jpg" width="30px"><span>mars</span> 👍（6） 💬（1）<div>我们现在用的是eureka+apollo做的企业级的注册中心和配置中心。</div>2021-12-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/10/71/d6c2e3a0.jpg" width="30px"><span>暮雨yl晨曦</span> 👍（6） 💬（1）<div>我们部门原先用的是gRpc，不好用。无论是调试还是写proto文件都很麻烦，我记得我第一次用这玩意，搞了好几天才跑通。现在使用的用dubbo居多。我们正在考虑要用SpringCloud Alibaba，我想要深入了解一下这块。正好看到现在的课程，就买来顺手学一下。</div>2021-12-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/36/73/7fb4d31f.jpg" width="30px"><span>起开我要掉渣了</span> 👍（5） 💬（2）<div>速更速更+++</div>2021-12-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/59/26/1015d573.jpg" width="30px"><span>gevin</span> 👍（4） 💬（1）<div>远程服务调用，本质上都是RPC；但是，RESTful这种架构风格，统一了双方的通信契约，如，统一用http作为通信协议，URL均面向资源，用http方法映射为资源的CRUD，http code 反应API的语意，用json或xml做完数据的载体等，这让RESTful对开发人员更友好，也方便了异构系统等集成，所以，微服务架构，用RESTful架构风格设计API最合适</div>2021-12-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（3） 💬（1）<div>group 一般会怎么用呢？ 一个微服务一个 group 吗？ 比如：用户服务 user_group ，订单服务 order_group</div>2023-03-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/14/85/73e55be5.jpg" width="30px"><span>~</span> 👍（3） 💬（2）<div>nacos 的领域模型和数据模型感觉我搞得不是很清晰，讲一下自己的想法，老师麻烦纠正一下。
1. 数据模型我还明白点，从 namespace 到 group 再到 service ID，就是颗粒度不断减小的趋势。从开发环境或者租户隔离，到每个环境下不同分组（这里的分组看了9节的内容，感觉就是用来在 namespace 的隔离基础上自定义的隔离，比如namespace 作为租户的隔离，那么 group 就可以作为每个租户的环境隔离），再到 group 中的每个微服务（例如项目的 template 服务，calculation 服务，customer 服务，这种具体的服务）。
2. 领域模型就有些搞不懂了，实例就是每台机器提供单独的服务，集合起来就是一个集群，但是之后的服务我就有些不理解，是一个「服务」包含那张图以下的集群吗？那么服务这个「定义」是向其他的服务提供服务吗？还是我理解的：一个集群通过「服务」向其他集群请求、响应，这里的「服务」就是一个中转站。
写的有些乱，我自己也有点捉摸不透，还麻烦老师回答一下，谢谢！</div>2022-01-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/06/7e/735968e2.jpg" width="30px"><span>西门吹牛</span> 👍（2） 💬（1）<div>远程调用，直接 http 请求调用，rpc调用，网关调用
http 请求：太麻烦，需要些一堆代码，或者封装工具类，每次调用也需要引入工具类
rpc：更灵活，更方便，就像调用本地方法一样，了解过 dubbo 和 Feign，二者本质区别就是协议的区别， Feign 基于HTTP，dubbo 支持多种协议，感觉dubbo 更加轻量化
网关调用：可以在网关做统一的控制，比如限流，鉴权等</div>2022-01-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e5/09/ddabec76.jpg" width="30px"><span>李峰</span> 👍（2） 💬（1）<div>java.net.UnknownHostException: failed to resolve &#39;coupon-template-serv&#39; after 2 queries 
	at io.netty.resolver.dns.DnsResolveContext.finishResolve(DnsResolveContext.java:1013) ~[netty-resolver-dns-4.1.58.Final.jar:4.1.58.Final]
我的三个服务都是起到windos的环境里面，老师保证错，这个coupon-template-serv域名他是在哪里解析成我的ip的？是需要配置什么吗？</div>2021-12-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/7b/03/03583011.jpg" width="30px"><span>天天有吃的</span> 👍（1） 💬（1）<div>请问下，这里的实例，集群，是nacos本身高可用集群的实例，还是自己应用的实例</div>2023-02-24</li><br/><li><img src="" width="30px"><span>Geek_e93c48</span> 👍（1） 💬（1）<div>老师，假如有A服务拉取完B服务列表，但是B服务有一些节点立即挂掉了，A服务还会调用这些节点吗，如果调用，那我的上流业务是不是一直会请求超时，直到A服务重新拉取B的服务列表</div>2022-01-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/10/71/d6c2e3a0.jpg" width="30px"><span>暮雨yl晨曦</span> 👍（1） 💬（6）<div>老师这节课中提到了一致性协议，没有深入刨析，希望后续能有加餐，结合nacos深入讲解一下。</div>2021-12-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/7b/03/03583011.jpg" width="30px"><span>天天有吃的</span> 👍（0） 💬（1）<div>老师请问下，所以服务治理包括了哪些内容啊，应该不仅仅服务注册和服务发现吧</div>2023-08-11</li><br/><li><img src="" width="30px"><span>Geek9382</span> 👍（5） 💬（0）<div>主动探活很重要。。尤其是 心跳绝大部分都是与tomcat这种容器的线程池分开来的。。一旦tomcat挂了或者响应缓慢，心跳依旧维持没有任何问题，只能通过其他手段区别服务健康度了，比如响应时间 错误码频次等</div>2022-03-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4b/da/c93eaab5.jpg" width="30px"><span>18610296143</span> 👍（3） 💬（0）<div>https:&#47;&#47;space.bilibili.com&#47;1562778141
自己录了几期Nacos相关的视频课程，需要的可以看看
</div>2023-03-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/8d/f2/3b122904.jpg" width="30px"><span>小猪丶快跑</span> 👍（0） 💬（0）<div>个人认为对知识点的讲解过于笼统</div>2023-02-06</li><br/>
</ul>