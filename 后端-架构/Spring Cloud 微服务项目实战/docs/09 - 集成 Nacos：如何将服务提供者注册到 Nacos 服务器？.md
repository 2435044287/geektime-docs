你好，我是姚秋辰。

今天我们来动手集成优惠券平台项目到Nacos服务器。这个项目我们将分两节课来讲，通过这两节课的学习，你可以知道如何借助Nacos，搭建起一个端到端的微服务调用链路。在这个过程中，你还会学到Nacos自动装配器的工作原理，以及Nacos核心参数的配置。掌握了这些内容，你就可以平稳驾驭Nacos服务治理了。

在Nacos的地盘上，下游服务需要先将自己作为“服务提供者”注册到Nacos，这个流程叫做“服务注册”；而上游服务作为“服务消费者”，需要到Nacos中获取可供调用的下游服务的列表，这个流程就是“服务发现”。

今天我先从两个下游服务coupon-template-serv和coupon-calculation-serv开始，利用Nacos的服务注册功能，将服务提供者注册到Nacos服务器。在下一节课中，我再向你展示作为服务消费者的coupon-customer-serv是如何通过服务发现机制向服务提供者发起调用。

在集成Nacos之前，我们需要先把Nacos的依赖项引入到项目中。

## 添加Nacos依赖项

Nacos是Sping Cloud Alibaba项目的一款组件，在引入Nacos的依赖项之前，我们需要在项目的顶层pom中定义所要使用的Spring Cloud和Spring Cloud Alibaba的版本。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/18/6a/50/da9e1168.jpg" width="30px"><span>别拽我的红领巾</span> 👍（12） 💬（1）<div>为什么我会优先读取application的nacos配置文件而不是boostrap呢？是不是有什么配置需要修改？</div>2022-03-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/1e/cf/97cd8be1.jpg" width="30px"><span>so long</span> 👍（3） 💬（1）<div>老师你好，nacos服务注册顺藤摸瓜如下，主要靠实现 ApplicationListener&lt;WebServerInitializedEvent&gt;，服务启动初始化完成后进行服务注册。

NacosServiceRegistryAutoConfiguration-&gt;NacosAutoServiceRegistration-&gt;AbstractAutoServiceRegistration.onApplicationEvent(WebServerInitializedEvent event)-&gt;NacosServiceRegistry.register(Registration registration)-&gt;NacosNamingService.registerInstance(String serviceName, String groupName, Instance instance)-&gt;NamingProxy.registerService(String serviceName, String groupName, Instance instance) </div>2022-01-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/36/1d/f5486ffe.jpg" width="30px"><span>你的笑忘书</span> 👍（2） 💬（1）<div>Spring Cloud Alibaba 2021.1 适配的 Nacos 版本是 1.4.1</div>2022-03-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/2a/b0/f72ee91c.jpg" width="30px"><span>来来</span> 👍（2） 💬（3）<div>public class NacosDiscoveryAutoConfiguration {   &#47;&#47; 读取Nacos所有配置项并封装到NacosDiscoveryProperties中   @Bean   @ConditionalOnMissingBean   public NacosDiscoveryProperties nacosProperties() {      return new NacosDiscoveryProperties();   }

上面例子中的这个return new NacosDiscoveryProperties(); 直接new的写法有疑问，为什么不是spring的注入或者查找，直接new出来配置怎么加载的？</div>2022-01-04</li><br/><li><img src="" width="30px"><span>Geek_277281</span> 👍（1） 💬（3）<div>nacos在集群模式下,template可以注册,calculate注册失败;在-m standalone时,两个都可以成功```不明白为什么</div>2022-09-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ac/87/8ed5880a.jpg" width="30px"><span>大碗</span> 👍（1） 💬（1）<div>nacos具有环境隔离的功能，可以区分生产环境、预发环境和开发环境，请问老师正常生产环境中，只需要一套naocs注册中心就可以么？需不需要有一套测试的nacos注册中心，专门用于注册测试环境的服务</div>2021-12-31</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqjK4a3amPeGBnicFgVEnZyF0z2AcKYpjHyqTujBMf7dul0CTK5MFVsfmICaksVwMiaHU76nY7ia1dnA/132" width="30px"><span>Geek_3100bd</span> 👍（0） 💬（1）<div>我本地配置的远程注册地址，但一直读取本地文件，currentServerAddr:http:&#47;&#47;localhost:8848， err : connect timed out</div>2023-07-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/76/2a/1eeb9bcd.jpg" width="30px"><span>silent</span> 👍（0） 💬（1）<div>姚老师，我这边有个疑问啊，为什么我2个服务注册到nacos 会出现，IP1 下存在一个IP2 下存在一个，而不是每一个IP 下都展示2个服务那？</div>2023-03-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/12/05/053e383a.jpg" width="30px"><span>¯\_(ツ)_╱¯</span> 👍（0） 💬（1）<div>老师 pom,xml文件中&lt;relativePath&gt;的作用是什么 为什么有的pom文件中有配置为..&#47;pom.xml 有的文件中没有呀</div>2022-10-24</li><br/><li><img src="" width="30px"><span>Geek_277281</span> 👍（0） 💬（1）<div>老师你好,我试图在我的机器上运行您提供的源码,更改设置后,template-serv可以正常注册,但cauculation-serv不行,错误发生在cauculation-serv的启动过程中,
com.alibaba.nacos.api.exception.NacosException: failed to req API:&#47;nacos&#47;v1&#47;ns&#47;instance after all servers([localhost:8948]) tried: ErrCode:400, ErrMsg:&lt;html&gt;&lt;body&gt;&lt;h1&gt;Whitelabel Error Page&lt;&#47;h1&gt;&lt;p&gt;This application has no explicit mapping for &#47;error, so you are seeing this as a fallback.&lt;&#47;p&gt;&lt;div id=&#39;created&#39;&gt;Mon Sep 05 10:13:11 UTC 2022&lt;&#47;div&gt;&lt;div&gt;There was an unexpected error (type=Bad Request, status=400).&lt;&#47;div&gt;&lt;&#47;body&gt;&lt;&#47;html&gt;</div>2022-09-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2e/ec/3c/5b9d2fdc.jpg" width="30px"><span>MrCh1ppy</span> 👍（0） 💬（2）<div>老师您好,系统是 win11,源码使用的是您的源码,Nacos的集群已经搭建起来了,可以在控制面板看到已经节点都已经上线,单个服务启动的时候,在日志里也显示已经注册完成,但是在nacos上的控制台提示:
WARN There are no [com.alibaba.nacos.common.trace.event.naming.PushServiceTraceEvent] publishers for this event, please register
然后在服务注册的页面上看不到注册好的服务,好怪喔</div>2022-08-17</li><br/><li><img src="" width="30px"><span>郭井阳</span> 👍（0） 💬（2）<div>服务没有注册到nacos,也没有注册的日志，也没有报错</div>2022-06-17</li><br/><li><img src="" width="30px"><span>Geek_0b93c0</span> 👍（0） 💬（1）<div>coupon-template-serv 日志显示注册成功 但是网页上没有显示 yml 命名空间dev  nacos也设置了
coupon-calculation-serv则是正常的 </div>2022-05-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/02/0c/7ead6a2c.jpg" width="30px"><span>无与伦比</span> 👍（0） 💬（1）<div>老师，Spring Cloud Alibaba 2021.1对应的Nacos Client版本为1.4.1，前面用的Nacos Server版本为2.0.3，这样能正常调用服务吗？</div>2022-05-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0f/d7/31d07471.jpg" width="30px"><span>牛年榴莲</span> 👍（0） 💬（2）<div>spring-boot-starter-web

不知道为什么引入这个才能注册到 nacos ，请大佬给下提示</div>2022-04-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ce/d7/074920d5.jpg" width="30px"><span>小飞同学</span> 👍（0） 💬（1）<div>springcloud版本决定了springboot和springcloudAlibaba的版本么？怎么理解其中的依赖，sc版本是接口么</div>2022-02-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/d5/ba/601f765a.jpg" width="30px"><span>Wzefeng</span> 👍（0） 💬（1）<div>老师，请问向 nacos 注册服务，SpringBoot 服务日志提示 Cannot determine local hostname 该怎么定位问题</div>2022-01-27</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/KiaBJsepm9fHHicfPxiahhR3RqRaR4QH6YFibIHV5o5VspTIXmH72iaiaotb4cRpWtRvLC7mnh5KH1KlSNLGWlI7wUicQ/132" width="30px"><span>Rorchachl</span> 👍（0） 💬（1）<div>1. 在最上层引入spring cloud Spring cloud alibaba  依赖 
spring boot spring cloud 兼容问题 参考spring社区网站
spring cloud Alibaba spring boot spring cloud的匹配关系 从spring cloud alibaba github 获取
2. namespace 一般用于区分环境  各个环境之间是互相隔离的 即 dev环境下的实例  不能访问 production环境下的实例
租户间的隔离 每个用户都单独使用一个namespace

3. group 用于实现同一个namespace下之间的隔离
线上测试 把带测试的服务 统一设定一个分组 group-a 真实的线上流量不会导入到新建的分组中 可以通过发送测试请求到group-a 的机器上完成测试
单元封闭 同一个单元的服务设置相同的group，让微服务调用封闭在当前单元内，提高业务响应速度</div>2022-01-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/34/cf/0a316b48.jpg" width="30px"><span>蝴蝶</span> 👍（0） 💬（1）<div>org.springframework.cloud.client.serviceregistry.AbstractAutoServiceRegistration#destroy 方法,也就是Spring项目停止的时候,就会注销自己,兄弟们,我说的对吗?</div>2022-01-08</li><br/><li><img src="" width="30px"><span>Geek_e93c48</span> 👍（0） 💬（1）<div>老师，上文的nacos心跳机制机制为间隔5s，默认三次收不到心跳就会判断服务不可用，心跳超时时间应该是15s吧</div>2022-01-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/d0/ce/a81126ea.jpg" width="30px"><span>代先生。</span> 👍（0） 💬（1）<div>如果有订单服务A和订单服务B，nacos作为服务注册与发现，那么A和B服务的调用规则这块配置或者源码是怎么体现的？</div>2022-01-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2e/3c/71/a9008b3c.jpg" width="30px"><span>兮</span> 👍（9） 💬（0）<div>分享个坑，yml配置文件里namespace的是命名空间id而不是命名空间名称</div>2023-01-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/1e/cf/97cd8be1.jpg" width="30px"><span>so long</span> 👍（9） 💬（0）<div>关闭服务，服务下线：主要靠注解@PreDestroy实现
NacosServiceRegistryAutoConfiguration-&gt;NacosAutoServiceRegistration-&gt;AbstractAutoServiceRegistration.destroy()</div>2022-01-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5c/c5/1231d633.jpg" width="30px"><span>梁中华</span> 👍（4） 💬（0）<div>这个和dubbo的服务注册理念差别很大，dubbo是以接口为中心的来注册的，Springcloud是以整个服务为中心来注册的</div>2022-02-13</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/6LaITPQ4Lk5fZn8ib1tfsPW8vI9icTuSwAddiajVfibPDiaDvMU2br6ZT7K0LWCKibSQuicT7sIEVmY4K7ibXY0T7UQEiag/132" width="30px"><span>尔东橙</span> 👍（2） 💬（0）<div>为什么pom引入starter就可以自动装配？ 我写个 Hello World 它也能给我自动装配？当然是什么都能够自动装配了，但前提是我们编写的 Starter 必须要符合 SpringBoot 的自动装配规则，否则是不行的，规则是：

1、在 resources&#47;META-INF 目录下必须要有 spring.factories

2、spring.factories 文件中必须要有 org.springframework.boot.autoconfigure.EnableAutoConfiguration 对应的配置类

3、要被使用的 Bean 必须正常被扫描到</div>2022-06-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/70/93/03d8fb2e.jpg" width="30px"><span>遇镜</span> 👍（1） 💬（0）<div>Spring Cloud Nacos Discovery 遵循了 spring cloud common 标准，实现了 AutoServiceRegistration、ServiceRegistry、Registration 这三个接口。

在 spring cloud 应用的启动阶段，监听了 WebServerInitializedEvent 事件，当Web容器初始化完成后，即收到 WebServerInitializedEvent 事件后，会触发注册的动作，调用 ServiceRegistry 的 register 方法，将服务注册到 Nacos Server。
</div>2022-12-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/66/0c/370626c4.jpg" width="30px"><span>IT_matters</span> 👍（0） 💬（0）<div>踩了个坑，本地服务注册成功，nacos始终在dev命名空间中看不到服务。原因是创建nameSpace的时候我没指定命名空间id，系统自动生成了，误以为是通过命名空间的名称来关联的。</div>2023-10-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/b5/28/65f8ef3c.jpg" width="30px"><span>govern</span> 👍（0） 💬（0）<div>服务注册成功后，发现nacos的mysql中并没有服务相关的表和数据，是服务信息不需要持久化到数据库么？那怎么保证nacos集群数据的一致性？</div>2023-05-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4b/da/c93eaab5.jpg" width="30px"><span>18610296143</span> 👍（0） 💬（0）<div>https:&#47;&#47;space.bilibili.com&#47;1562778141
学完老师Nacos课程之后，录制了几个视频，喜欢的可以看看</div>2023-03-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（0） 💬（0）<div>不是很理解到 Group 的使用场景，为什么会有这个概念呢</div>2023-03-14</li><br/>
</ul>