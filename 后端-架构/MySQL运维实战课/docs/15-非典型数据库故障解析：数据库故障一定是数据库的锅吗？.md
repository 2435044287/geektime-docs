你好，我是俊达。

在前两讲中，我分别介绍了MySQL和Linux操作系统问题排查的基本思路，提供了一些判断数据库和操作系统是否有问题的方法。这一讲我们就以一个生产环境中发生的故障为例，来看看怎么运用前面讲到的基本方法，来分析和定位真实环境下的问题。

## 背景介绍

这是我们公司服务的一家客户在线业务系统中发生的故障。这家客户提供在线支付业务，大量的消费者日常都会使用到这项服务。比如我们中午或傍晚到店里扫码点餐付款时，或者在商场里扫码付款时，都可能会用到这项服务。当时，我们给这家公司提供了数据库运维保障的服务。客户的核心业务数据库采用了国内头部的一家云厂商提供的RDS for MySQL产品。

有一天下午，快接近6点钟的时候，短促的告警声打破了办公室的平静，客户的告警通知群里面，出现了大量的实例CPU和活跃会话数的告警消息。通过监控大屏，我们发现问题都出在一个核心数据库上，数据库实例的CPU资源，几乎在瞬间达到了100%。同时客户也反馈，业务端有大量的付款失败了。

## 怎么分析数据库CPU使用率高的问题？

对于数据库CPU使用率打满的问题，一般我们都会先从实例中运行的SQL入手。有两种情况都可能会导致CPU打满，一种情况是实例中运行了执行效率特别低的SQL，如大表全表扫描、大表连接并且缺少合适的连接条件或连接索引。另外一种情况是SQL的执行频率太高了。更差的情况是，SQL效率很低，同时执行的并发量还很高。
<div><strong>精选留言（4）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/15/8d/4d/992070e8.jpg" width="30px"><span>叶明</span> 👍（1） 💬（1）<div>老师你的这个案例是因为 keys 查询阻塞了 redis，导致请求积压，等 redis 恢复正常后，积压的请求 reids 能处理过来，但 mysql 处理不过来，从而被打满。不知道我理解的对不对。我去做 redis key 删除时，都是用 scan 不断遍历来模糊匹配，避免 keys 这种重操作。
另外，开发一般都有接口超时时间的吧，通常 redis 查询非常快，高于某个阈值不返回，就应该中断请求。
比较喜欢用阿里云的全量 SQL 功能，当告警时，无法确定是慢 SQL 日志中哪个 SQL 造成的时候，我就开启全量 SQL，让它跑着，再次出现问题时，去分析报警这个时间段内哪些 SQL 的 CPU 和 IO 占用较高，很多时候，从慢 SQL 日志中并不能确定引起告警的查询，即使慢日志中的 SQL 是真的慢，而且看起来真的有问题。

思考题
1、从扫描行和返回行以及执行时间来区分，如果扫描行数很多，返回行数无论是多还是少（可能是聚合查询），都说明不了什么问题，但扫描和返回行数都少的情况下，执行时间却很长的语句，更大的可能是被别的线程所影响
2、我们公司用的是阿里云的 RDS MySQL 和 Polardb MySQL，通过阿里云提供的接口，定期将云上的慢 SQL 采集到自己的平台，这样在自己的平台就可以查看一个 sql 在一段时间范围内的耗时时间，如果耗时突然增高，那么一般认为是被影响的
3、实在确定不了，我还是用阿里云的全量 SQL，就分析告警前后那段时间范围内的 CPU 占用和 IO 占用，它还有会话快照，可以用来做参考，目前用起来很爽，查找问题也很方便。</div>2024-09-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/53/18/de532447.jpg" width="30px"><span>范特西</span> 👍（0） 💬（1）<div>最后的问题我也喜欢看扫描行数，这里分享一个之前遇到了一次有趣的场景，就是问题 SQL 执行计划使用了 index merge ，慢日志中的扫描行数，只包含了取交集时的扫描行数，结果就是慢日志中显示扫描 9w 行，查询执行了 100 多秒，当时第一眼看的时候很奇怪，使用了 trace 才分析明白😊</div>2024-10-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/24/36/0829cbdc.jpg" width="30px"><span>TheOne</span> 👍（0） 💬（1）<div>好有指导意义的一篇文章🤙🤙🤙</div>2024-09-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/a1/d8/42252c48.jpg" width="30px"><span>123</span> 👍（0） 💬（1）<div>思考题：
1、首先分析当前数据库繁忙的原因是什么，是因为业务量增大，用户增多，发布一些重要活动，还是在没有外部客观原因的情况下导致的数据库繁忙，例如老师文中的例子；

2、分析数据库内部的原因，首先拿到processlist列表，观察那些time时间较长的回话，查看当前的state，分析原因；通过工具查看慢sql，分析慢SQL的数量、时间、执行次数的排序、执行时间等，同时需要检查是否有锁等待情况，业务繁忙的情况下，除了大量执行业务核心sql以外，关注非核心功能，可能存在并发问题的“sql组合”；

3、检查下原sql的执行计划是否发生了改变，例如发生了索引的更改等；

4、查看系统资源监控，是否可能是底层硬件存在瓶颈，cpu、内存、磁盘IO、网络情况，拉取资源监控分析图表，查看点位的变化的情况，是否有异常；

5、检查这个业务链路，是否是业务链路的某个环节，特别是redis缓存，如果缓存失效，并发量大，也会有大量sql请求一起到达数据库；</div>2024-09-20</li><br/>
</ul>