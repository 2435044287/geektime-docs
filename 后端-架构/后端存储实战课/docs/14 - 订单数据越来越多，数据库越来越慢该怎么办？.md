你好，我是李玥。

在前面几节课，我们一起学习了在并发持续高速增长的情况下，如何来逐步升级存储。今天这节课我们来聊一聊，如何应对数据的持续增长，特别是像订单数据这种会随着时间一直累积的数据。

为什么数据量越大数据库就越慢？你得理解这里面的根本原因。

我们知道，无论是“增删改查”哪个操作，其实都是查找问题，因为你都得先找到数据才能对数据做操作。那存储系统性能问题，其实就是查找快慢的问题。

无论是什么样的存储系统，一次查询所耗费的时间，都取决于两个因素：

1. 查找的时间复杂度；
2. 数据总量。

这也是为什么大厂面试时总喜欢问“时间复杂度”相关问题的原因。查找的时间复杂度又取决于两个因素：

1. 查找算法；
2. 存储数据的数据结构。

你看，这两个知识点也是面试问题中的常客吧？所以人家面试官并不是非要问你一些用不上的问题来为难你，这些知识点真的不是用不上，而是你不知道怎么用。

我们把话题拉回来。对于我们大多数做业务的系统，用的都是现成的数据库，数据的存储结构和查找算法都是由数据库来实现的，业务系统基本没法去改变它。比如说，我们讲过MySQL的InnoDB存储引擎，它的存储结构是B+树，查找算法大多就是树的查找，查找的时间复杂度就是O(log n)，这些都是固定的。那我们唯一能改变的，就是数据总量了。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg" width="30px"><span>李玥</span> 👍（31） 💬（0）<div>Hi，我是李玥。

这里回顾一下上节课的思考题：

课后请你想一下，复制状态机除了用于数据库的备份和复制以外，在计算机技术领域，还有哪些地方也用到了复制状态机？欢迎你在留言区与我讨论。感谢你的阅读，如果你觉得今天的内容对你有帮助，也欢迎把它分享给你的朋友。

复制状态机的应用是非常广泛的，比如说现在很火的区块链技术，也是借鉴了复制状态机理论，它的链，或者说是账本就是操作日志，每个人的钱包，就是状态。它只要保证账本一旦记录后就不会被篡改，那在任何人的电脑上，计算出来的钱包就都是一样的。</div>2020-03-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/63/0b/ad56aeb4.jpg" width="30px"><span>AI</span> 👍（34） 💬（3）<div>一下子和Java的GC算法产生了共鸣。
创建新表的方式，只复制少部分数据，效率更高，但你要能接受这段时间的STW。这是复制算法。
历史归档，删除数据的方式，会产生碎片，利用率低。只有到空间不足的情况下，才进行压缩整理（OPTIMIZE）。这是标记清理算法，关键时刻再整理（STW），CMS GC就是这个思路。
</div>2020-04-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f8/ba/d28174a9.jpg" width="30px"><span>Geek_zbvt62</span> 👍（33） 💬（3）<div>如果不进行OPTIMIZE，想通过历史表来提升性能的目的岂不是达不到了？</div>2020-03-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/1a/05/f154d134.jpg" width="30px"><span>刘楠</span> 👍（11） 💬（6）<div>alter table A engine=InnoDB 命令来重建这样也能达到释放空间的效果吧</div>2020-03-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/97/e1/0f4d90ff.jpg" width="30px"><span>乖，摸摸头</span> 👍（8） 💬（1）<div>按时间分库分表一直有个疑惑， 按月进行分表， 有几个月数据很小，有几个月数据特别大，这种会怎么处理</div>2020-05-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/5c/6c/7a4593fa.jpg" width="30px"><span>王</span> 👍（5） 💬（2）<div>老师，什么情况下需要归档，什么情况需要分库分表呢？有什么具体的指标吗？</div>2020-03-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5d/11/e1f36640.jpg" width="30px"><span>怀朔</span> 👍（4） 💬（3）<div>比这个删除规律 是不是有问题啊？
1、创建temp表
2、把历史数据迁移老表
3、check历史数据条数 
4、删除老数据？


按照老师的方法
 在rename 之前 插入之后 这时候有数据进来 数据会丢在老表里面了？</div>2020-03-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/9d/a4/e481ae48.jpg" width="30px"><span>lesserror</span> 👍（2） 💬（1）<div>老师，您的这句话：“其实每次都排序是没必要的，所以我们可以先通过一次查询，找到符合条件的历史订单中最大的那个订单 ID，然后在删除语句中把删除的条件转换成按主键删除。” 

事实上每次，都做了排序啊？为什么说没必要呢？</div>2020-05-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/0e/39/174741d1.jpg" width="30px"><span>特种流氓</span> 👍（2） 💬（1）<div>最近的订单表往归档表挪数据的过程中可能一份数据在两张表都存在 这个时候用户查询全部订单的时候是否我们在应用利用是用去重去剔除重复数据</div>2020-03-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/55/47/d217c45f.jpg" width="30px"><span>Panmax</span> 👍（1） 💬（1）<div>最后一种方案中（重建一张新的订单表），最后不应该把 orders_to_be_droppd 表删掉吧，删掉之后历史数据就丢了。</div>2020-04-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/31/16/f2269e73.jpg" width="30px"><span>better</span> 👍（0） 💬（1）<div>老师您好，我想请教一下，我们目前有一个业务需求，需要将关系型数据库MySQL中的数据迁移到另外一种数据库中存储，且要求最好是国产非商用的数据库，所以像MariaDB、PostgreSQL可能都不能作为此次的选型。

我个人觉得能找到跟MySQL比较贴近的关系型数据库的话，迁移成本应该能够最低，但目前一直找不到合适的替代品。

目前团队里其他成员预研的一种方案是Luence，但Luence和MySQL毕竟是两个区别比较大的产品。

我想请教老师的问题是：
1.当前这种业务需求和限制下，老师有什么技术选型建议，或有没有什么MySQL的替代产品推荐
2.老师觉得用Luence替代是否可行，可行性方面需要考虑哪些方面呢</div>2020-05-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/a9/cb/a431bde5.jpg" width="30px"><span>木头发芽</span> 👍（0） 💬（1）<div>手动归档方案跟用按订单日期做sharding的方式比，我觉得后者更简单方便，只要提供给用户按日期阶段查订单功能查询性能也不会有太大影响，反而少了手动归档操作，手动容易出错，耗时耗力</div>2020-03-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f9/e6/47742988.jpg" width="30px"><span>webmin</span> 👍（30） 💬（2）<div>“归档历史订单”可以灵活控制，比如把不再会进行修改的订单，迁移到偏重查询快系统（各种NOSQL），不再需要online查询的数据，可以迁移到offline的库中。
直接进行分库分表，会遇到冷热不均的问题，如：电商大促或年节购物旺季订单量与谈季和平季订单可能会量级差别。用时间这个维度去分库分表，操作上相对简单，但是到达这种需要分库分表量级的系统，切分的灵活性更加重要，怎么分业务场景不同切分维度也会不同。</div>2020-03-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/14/ee/d72a8222.jpg" width="30px"><span>攻城拔寨</span> 👍（13） 💬（1）<div>1. 自动分表需要事先做好预估，把时间间隔设置好，如果表数据增长速度不均匀（例如淡季旺季，后期业务膨胀），可能需要重新设计分表规则，很麻烦。表名也变化了，代码侵入性比较大。
优点就是如果数据增长速度变化不大，不用持续做归档。

2. 归档的好处是代码侵入性低，因为热表名字还是一样。表增长速度变成也能灵活改变归档数据大小跟速度。
缺点就是需要持续归档迁移，后期归档数据太大也会遇到瓶颈</div>2020-03-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/34/df/64e3d533.jpg" width="30px"><span>leslie</span> 👍（7） 💬（0）<div>定期归历史的方式其实oracle的使用频率是最高的。
不过删主键的方式确实不曾想到和尝试过，觉得短期不失为不错的选择。
自动分表总归会有坑：这也是为何自动化的极限还是要人去监控；自动化减少的人的机械操作而已，不是不需要人去操作和监控，尤其数据库数量众多时还是要人去自动化。
手工虽麻烦细节上的把控会比较好：细节会把控的比较好。
相对合理的方式应当是二者结合：1）拆分之前人为的做一次检查，2）拆分的动作自动化去执行，3）结果由人去复核。
毕竟当需要同时拆分的工作量很庞大时不可能全部都是手工操作，这其实就像运维：一个人去操作2-3台可能，20-50其实就很困难了，500以上要全部人为操作基本就只能自动化+人为操作了。
谢谢今天的分享：期待后续的课程。</div>2020-03-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/47/ae/0a5f7a56.jpg" width="30px"><span>此方彼方Francis</span> 👍（7） 💬（0）<div>任何时间属性相关的数据基本都可以这样处理（比如聊天数据），这种处理办法和分库分表等并不冲突。这种办法相对简单大部分情况下效果也比较好，只是如果业务发展很好，那么订单表的数据依旧有可能很多，另外历史数据表依旧是需要查询的，时间越久数据量越多，查询历史数据太慢的话迟早也会是个问题。
分库分表这种方案需要选比较好的shard key，在数据统计上会麻烦一些，单表数据量上来之后依旧有归档的需求。
按月新建表会有数据热点问题，查询和统计还是会比较麻烦。</div>2020-03-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/16/5b/83a35681.jpg" width="30px"><span>Monday</span> 👍（4） 💬（4）<div>你可能还有印象，几年前你在京东、淘宝查自己的订单时，都有一个查“三个月前订单”的选项，其实就是查订单历史表。
这个确实有印象，以前我们产品也抄了这个查询条件。不过我的问题是，现在怎么没有这个选项了？</div>2020-08-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg" width="30px"><span>Jxin</span> 👍（4） 💬（0）<div>1.前者操作所有数据都会有一个路由的前置操作，这是有开销的。其次，因为分表了，所以其区域查找这种就需要多表数据做聚合，这就会让查询变得很复杂低效（采用mycat这种中间件可以规避业务代码大量改动的问题，但聚合数据的开销依旧是跑不掉的，而且引入中间件还有多一条的问题）。

2.后者其实性能，操作成本，对业务代码的侵入程度都比前者有优势，唯一遗憾的就是其应用场景有限。只有在整体业务单量不大，且归档数据操作概率极低的情况下适用。因为如果业务单量很大，比如日单量一百万，那么这个热数据表能存多久的数据？十天？二十天？这样的时间区间是严重不符合归档条件的，往往归档数据都是半年，少说三四个月的完结订单。而且归档数据，数据量很大。意味着性能很差，频繁导入导出，查询修改，是支撑不住的。</div>2020-04-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/fa/f7/91ac44c5.jpg" width="30px"><span>Mq</span> 👍（3） 💬（0）<div>归档历史数据的优点是简单，对系统的改造少，缺点是不是长久之计
分库分表需要对数据访问层做架构变更，对系统的改造大，要考虑数据分布，对接口查询性能等业务需求的影响，另外我觉得按时间分表跟我们设计这个分库分表就不符，我们做业务数据分库分表就是想数据打散，按时间分达不到这个目的，按时间适用在做一体化系统，因为这些系统有很多报表统计需求可能用的上</div>2020-03-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg" width="30px"><span>ifelse</span> 👍（2） 💬（0）<div>解决海量数据导致存储系统慢的问题，思想非常简单，就是一个“拆”字，把一大坨数据拆分成 N 个小坨，学名叫“分片（Shard）。--记下来</div>2022-12-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/81/4e/d71092f4.jpg" width="30px"><span>夏目</span> 👍（2） 💬（0）<div>分库分表不需要迁移数据，容量也大，缺点是各个表数据可能差异较大，查询较麻烦。历史订单表查询相对简单，迁移数据麻烦</div>2020-04-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg" width="30px"><span>每天晒白牙</span> 👍（2） 💬（0）<div>思考题
把历史订单数据归档方案实现相对简单，也很有效果，需要注意的就是归档时注意对线上服务的影响。

如果采用按照订单创建时间分库分表，优点是省去了后面归档历史数据的重复工作，在一定程序上可以提高写入和查询性能，但也有不足。

首先就是采用分库分表在技术复杂度上相比历史数据归档还是高一些的

其次就是如果刚好到新的一个月，前一个月的数据还是属于热数据，所以会涉及多表查询

最后就是这种方案会造成产生大量的表，如果订单数据不大，每个表中数据量也不会太大，有点浪费资源了</div>2020-03-28</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJkwbyTYtSCx6Qc7cQPnnRWv38Jybh3etziaPmuP8gHcgS6FMxcdftrKgWiamH6fc2iciaicDKDVEwcEibQ/132" width="30px"><span>sami</span> 👍（1） 💬（2）<div>以前做过一个系统，有三类表，包括历史单，完成单和在途单。也是老师说的拆分的思路</div>2020-03-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a4/d7/5d2bfaa7.jpg" width="30px"><span>Aliliin</span> 👍（1） 💬（0）<div>归档历史数据一般可以根据日前时间分类新建表
删除历史数据要注意分批删除，还有就是删除数据但是磁盘空间并没有释放，可以执行optimism table 进行磁盘空间释放执行过程会锁表
还有一种方案就新建一张表迁移所需数据到新的表
注意别忘记和要删除的表的其他表的相关数据</div>2020-03-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a2/fb/94af9cf1.jpg" width="30px"><span>Alex</span> 👍（1） 💬（2）<div>保证关系数据库数据最小化，在抗流量的过程中很有作用。历史数据异步同步到大数据环境，定期删除关系数据库里的归档数据。保证sql 执行效率</div>2020-03-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/96/e3/dd40ec58.jpg" width="30px"><span>火车日记</span> 👍（0） 💬（0）<div>老师您好，对于分区的方式，这两种的在选择上有怎样的考量。</div>2023-08-05</li><br/><li><img src="" width="30px"><span>sotondolphin</span> 👍（0） 💬（0）<div>删除的时候还需要考虑foreign key constraitnts. 不然也容易报错</div>2022-02-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/51/86/b5fd8dd8.jpg" width="30px"><span>建强</span> 👍（0） 💬（0）<div>思考题：
1.归档历史订单，对程序的改动较少，易操作，安全可靠，缺点是，对历史数据的统计和查询仍然有性能上的问题；
2.直接分库分表，正好相反，程序的改动较大，且不容易操作，数据查询和统计较复杂，优点是，分表后，每张表的数据量可以稳定在一个量级上，数据查询性能较优。</div>2021-12-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/37/29/b3af57a7.jpg" width="30px"><span>凯文小猪</span> 👍（0） 💬（0）<div>归档库优点
1.如果线上日均GMV只有10w以内 那么通常归档库与订单库可以采用同样的分库分表结构 ，这种方式也简化了迁移成本
2.查询与写操作（通常是订单状态修改，因为付款成功通常也只改状态了，原始订单是要保存做OLAP的）改动量极小 这点老师已在文中阐释过

归档库缺点
1.对于线上日均GMV大的表（以日均百万GMV来算） 通常订单表与归档库的分布分表方案是不同的 ，代码中需要维护两套数据源 当然也可以将归档库查询下沉为api调用
2.相较于按月查询来说 会存在数据冷热不均问题。比方说某些表数据量多（因为某个用户下单多）等。通常这种问题只是牺牲下存储空间 目前基本是忽略的

按月分库优点
1.适合小数据量的订单表 如日均10W甚至更低 。通常订单库与归档库都不需要分库分表 且业务本身也就是按月查询

按月分库缺点
1.数据写入量一旦增多 还是要回归到分库分表方式
2.按人聚合查询场景天生不支持 需要自己对每笔数据做聚合 或者由大数据来做计算支撑
</div>2021-12-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4d/d3/67bdcca9.jpg" width="30px"><span>林铭铭</span> 👍（0） 💬（0）<div>数据归档也算是一种古老的技术了。</div>2021-07-29</li><br/>
</ul>