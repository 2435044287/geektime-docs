你好，我是李玥。

我们在《[15 | MySQL存储海量数据的最后一招：分库分表](https://time.geekbang.org/column/article/217568)》这节课中讲过，数据量太大的时候，单个存储节点存不下，那就只能把数据分片存储。

数据分片之后，我们对数据的查询就没那么自由了。比如订单表如果按照用户ID作为Sharding Key来分片，那就只能按照用户维度来查询。如果我是一个商家，我想查我店铺的订单，对不起，做不到了。（当然，强行查也不是不行，在所有分片上都查一遍，再把结果聚合起来，又慢又麻烦，实际意义不大。）

对于这样的需求，普遍的解决办法是用空间换时间，毕竟现在存储越来越便宜。再存一份订单数据到商家订单库，然后以店铺ID作为Sharding Key分片，专门供商家查询订单。

另外，之前我们在《[06 | 如何用Elasticsearch构建商品搜索系统](https://time.geekbang.org/column/article/208675)》这节课也讲到过，同样一份商品数据，如果我们是按照关键字搜索，放在ES里就比放在MySQL快了几个数量级。原因是，数据组织方式、物理存储结构和查询方式，对查询性能的影响是巨大的，而且海量数据还会指数级地放大这个性能差距。

所以，在大厂中，对于海量数据的处理原则，都是根据业务对数据查询的需求，反过来确定选择什么数据库、如何组织数据结构、如何分片数据，这样才能达到最优的查询性能。同样一份订单数据，除了在订单库保存一份用于在线交易以外，还会在各种数据库中，以各种各样的组织方式存储，用于满足不同业务系统的查询需求。像BAT这种大厂，它的核心业务数据，存个几十上百份是非常正常的。
<div><strong>精选留言（27）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg" width="30px"><span>李玥</span> 👍（37） 💬（7）<div>Hi，我是李玥。

这里回顾一下上节课的思考题：

对象存储并不是基于日志来进行主从复制的。假设我们的对象存储是一主二从三个副本，采用半同步方式复制数据，也就是主副本和任意一个从副本更新成功后，就给客户端返回成功响应。主副本所在节点宕机之后，这两个从副本中，至少有一个副本上的数据是和宕机的主副本上一样的，我们需要找到这个副本作为新的主副本，才能保证宕机不丢数据。但是没有了日志，如果这两个从副本上的数据不一样，我们如何确定哪个上面的数据是和主副本一样新呢？

这个问题有些同学已经在留言区给出了答案，一般都是基于版本号来解决，在Leader上，KEY每更新一次，KEY的版本号就加1，版本号作为KV的一个属性，一并复制到从节点上，通过比较版本号就可以知道哪个节点上的数据是最新的。

另外，有的同学提出用比较时间戳的方式来解决这个问题。这个方法理论上可行，但实际上非常难实现，因为它要求集群上的每个节点的时钟都必须时刻保持同步，这个要求往往非常难达到。</div>2020-04-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c9/cf/af720d94.jpg" width="30px"><span>豆腐居士</span> 👍（39） 💬（10）<div>如果预估了分区（队列）数量之后 随着业务数据的增长 需要增加分区 提高并发 怎么去做扩容？
因为统一笔订单需要打到同一个分区上 </div>2020-04-09</li><br/><li><img src="" width="30px"><span>Geek_772139</span> 👍（17） 💬（1）<div>今把binlog回退到某个时间点开始重新同步，这个需要mq消费端的消费进度支持重置，重置到过去的某一个消费进度就可以了</div>2020-05-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4c/83/7788fc66.jpg" width="30px"><span>Simon</span> 👍（11） 💬（1）<div>老师，请问下都用mq了还能是实时同步数据嘛？</div>2020-04-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4f/0c/bf76644b.jpg" width="30px"><span>VincentJiang</span> 👍（10） 💬（1）<div>请问老师，如果应用跨云（AWS和阿里）部署，并且使用的数据库不是MySQL而是PG，有什么好方法可以实时这种跨云数据同步？</div>2020-06-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4e/1b/f4b786b9.jpg" width="30px"><span>飞翔</span> 👍（8） 💬（3）<div>老师 mq 可以有多个 sharding key 是订单号，这样同一个订单号就可以保证到同一个mq里边去，保证顺序，但是canal不还是必须只有一个 不会成为瓶颈嘛</div>2020-04-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/be/d2/1400c368.jpg" width="30px"><span>饭饭</span> 👍（0） 💬（1）<div>非mysql 同步呢，mysqlsever  oracle 是否有对应功能或同步工具?</div>2020-04-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/a9/cb/a431bde5.jpg" width="30px"><span>木头发芽</span> 👍（27） 💬（0）<div>有点像cpu取指令的冒险，如果当前指令后n条指令跟当前指令没有上下文依赖就可以放入指令流水里并行执行力。计算机科学的各种理论真是到处都在用，学好基础是关键</div>2020-04-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/47/ae/0a5f7a56.jpg" width="30px"><span>此方彼方Francis</span> 👍（7） 💬（1）<div>这节课感觉可以和MySQL同步数据到redis那节合起来。</div>2020-04-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/5c/5d/974b033f.jpg" width="30px"><span>陆老师</span> 👍（6） 💬（0）<div>越到后面，留言的越少了。下游的某个同步程序或数据库出了问题，可以抛出异常不确认消息，这样，等数据库好了，再次进行消费，不过这样性能会差点，数据也有延迟。如果不想影响多个系统共用的MQ，可以把数据再发送到某个业务系统单独的MQ中去，后续自己单独慢慢消费</div>2020-04-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/24/33/bcf37f50.jpg" width="30px"><span>阿甘</span> 👍（5） 💬（0）<div>&gt; MySQL 主从同步 Binlog，是一个单线程的同步过程。为什么是单线程？原因很简单，在从库执行 Binlog 的时候，必须按顺序执行，才能保证数据和主库是一样的。为了确保数据一致性，Binlog 的顺序很重要，是绝对不能乱序的。
这是以前的MySQL了。从MySQL 5.6 版本起可以开启并行复制功能（slave_parallel_workers &gt; 0）实现多库并行化复制；MySQL 5.7 引入了MTS（Enhanced Muti‐threadedslaves）来实现并行复制，不再有基于库的并行复制限制，5.7.2 又进行了优化，增加了参数slave_parallel_type。</div>2022-01-21</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIY8df9yV6vQjOMxv5xym070hFT2GWYELpqBhxSicQoq5IqBx6teS1xJaomkOBeuzv4vkXRJfibqcMw/132" width="30px"><span>永不止步</span> 👍（2） 💬（0）<div>重新同步的话，下游的消费者需要满足幂等性，保证同一条记录只处理一次</div>2020-04-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg" width="30px"><span>那时刻</span> 👍（2） 💬（0）<div>使用MQ的消息回放功能？</div>2020-04-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/37/29/b3af57a7.jpg" width="30px"><span>凯文小猪</span> 👍（1） 💬（0）<div>二刷课程 谈一下心得体会：
这里canal分发mq主题采用的思想 和lamport老爷子的happened before是一样的：
1.两个共识或事件如果有因果关系 那么应该将其组织成偏序关系 发往一个队列 。这一点正巧和现代mq的分区思想吻合
2.没有因果关系的事件 因为空间时刻特性无法确定先后关系 所以干脆就并行分发到不同分区 释放掉压力</div>2021-12-15</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/oniasL8UwocGW1ficLibdRdV0n7pOlwH4eYdlJibvqSiaFpgJe98Xgp6aq4pWj9J14EUI95UKGAHa3Opmo9YSE75a1w/132" width="30px"><span>victor</span> 👍（1） 💬（1）<div>多张表合并成一张宽表是如何同步哪？</div>2020-09-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/e2/2b/5eab1490.jpg" width="30px"><span>会飞的鱼</span> 👍（0） 💬（0）<div>老师，感觉Canal+MQ实时同步数据对服务器资源消耗要比ETL 工具定时同步数据的消耗要小，使用ETL，要进行数据的抽取，转换和加载，相比Canal+MQ会更加复杂，是这样吗</div>2024-05-12</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJkm74Y5ia4bWLTnoPInasLsX9ULgfiaqTU7XnK9b1wO2PrHicKzeSYXkaAcPW20rIfGIv0HxkWApA8w/132" width="30px"><span>Wyifei</span> 👍（0） 💬（0）<div>binlog对顺序要求非常严格，但MQ怎么保证消息的顺序呢？以kafka为例，说canal发两次消息，但是网络原因，消息到达的顺序和消息发送的顺序不一致，怎么保证kafka内消息的顺序？</div>2023-10-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ba/e4/6df89add.jpg" width="30px"><span>芋头</span> 👍（0） 💬（0）<div>订单数据不适合存储在Es中直接查询吗，这样没必要做这么多同步了？</div>2023-03-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg" width="30px"><span>ifelse</span> 👍（0） 💬（0）<div>对于海量数据，必须要按照查询方式选择数据库类型和数据的组织方式，才能达到理想的查询性能。--记下来</div>2022-12-13</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIveS9MIL9ngiczzS9Nb2SibL7rw9uVHZnwo0SVYvX3MvAKnL7JHupcG8lCNvnYbicC02F5xmLFvZlkg/132" width="30px"><span>大碗碗小婉婉</span> 👍（0） 💬（0）<div>同步es也用mq吗，看官网有一个adapter</div>2021-12-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/37/29/b3af57a7.jpg" width="30px"><span>凯文小猪</span> 👍（0） 💬（0）<div>感谢老师的精彩介绍 对于因果一致性有了全新的认识，对于解决工作中的实际问题有了自信。最后谈下老师的问题：实际上解决思路就和之前老师说的一样 就是定期做snapshot 再讲mq当做binlog 利用mq的消息回溯来来回回擦数据就行了。唯一要注意的是消费者要做好幂等 不过这应该是互联网开发最基本的要求了吧</div>2021-04-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/a5/98/a65ff31a.jpg" width="30px"><span>djfhchdh</span> 👍（0） 💬（1）<div>这个下游的同步程序需要支持binlog同步的幂等操作，对于同一条binlog消息，要保证幂等性。</div>2020-09-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/9c/c6/05a6798f.jpg" width="30px"><span>苗</span> 👍（0） 💬（0）<div>客户端的多个线程，每个线程绑定一个队列并行处理吗？</div>2020-08-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/81/e6/6cafed37.jpg" width="30px"><span>旅途</span> 👍（0） 💬（0）<div>mq主题和并发数一致，然后下游把这些主题都监听吗?</div>2020-05-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/6d/46/e16291f8.jpg" width="30px"><span>丁小明</span> 👍（0） 💬（0）<div>mysql本身的多线程主从同步也是基于这个原理吧</div>2020-04-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（0） 💬（0）<div>确定出现问题的时间点，然后把这个时间点之后的数据，全部再重新处理对应的 binlog ，然后再发送到对应的MQ中</div>2020-04-09</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Ltu4XZ6MHlbeVk4Kt8aU4kPH7KK6FlTPwK5K6S1zX4y2wTF7J86SzFrfj6dDYkk1icgyPKiacUw0rcJvXucwPSKw/132" width="30px"><span>yasin</span> 👍（0） 💬（0）<div>订单号的id应该是时间序列递增的，将回退那个时间点的id找到，删除下游表里大于这个id的记录，然后再进行同步。</div>2020-04-09</li><br/>
</ul>