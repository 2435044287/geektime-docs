你好，我是李玥。

上节课我们在讲解CockroachDB的时候提到过，CockroachDB的存储引擎是一个分布式的KV存储集群，它用了一系列成熟的技术来解决集群问题，但是在集群的每个节点上，还需要一个单机的KV存储来保存数据，这个地方CockroachDB直接使用RocksDB作为它的KV存储引擎。

[RocksDB](https://github.com/facebook/rocksdb)是Facebook开源的一个高性能持久化KV存储。目前，你可能很少见到过哪个项目会直接使用RocksDB来保存数据，在未来，RocksDB大概率也不会像Redis那样被业务系统直接使用。那我们为什么要关注它呢？

因为越来越多的新生代数据库，都不约而同地选择RocksDB作为它们的存储引擎。在将来，很有可能出现什么样的情况呢？我们使用的很多不同的数据库，它们背后采用的存储引擎都是RocksDB。

我来给你举几个例子。我们上节课讲到的CockroachDB用到了RocksDB作为它的存储引擎。再说几个比较有名的，[MyRocks](http://myrocks.io/)这个开源项目，你看它这个名字就知道它是干什么的了。它在用RocksDB给MySQL做存储引擎，目的是取代现有的InnoDB存储引擎。并且，MySQL的亲兄弟MariaDB已经接纳了MyRocks，作为它的一个可选的存储引擎。还有大家都经常用的实时计算引擎[Flink](https://flink.apache.org/)，用过的同学都知道，Flink的State就是一个KV的存储，它使用的也是RocksDB。还有包括MongoDB、Cassandra等等很多的数据库，都在开发基于RocksDB的存储引擎。
<div><strong>精选留言（24）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg" width="30px"><span>李玥</span> 👍（44） 💬（0）<div>Hi，我是李玥。

这里回顾一下上节课的思考题：

课后请你去看一下Raft一致性协议，然后简单总结一下，CockroachDB 是如何利用 Raft 协议实现 Range 高可用、高可靠和强一致的。

这里简单说一下Raft协议，Raft是一个分布式一致性协议，在很多分布式系统中，都使用它来保证数据强一致性。它利用复制状态机来解决多个副本数据一致的问题，保证日志复制到半数以上节点才给客户端返回成功。并且，引入了主从心跳机制，当主节点故障时，其它节点能主动发起选举，选出新的主节点。通过复制状态机、心跳和选举机制，来保证集群数据的高可用、高可靠和强一致。</div>2020-04-21</li><br/><li><img src="" width="30px"><span>myrfy</span> 👍（40） 💬（1）<div>应该是标记删除，有墓碑的概念，被删除的条目，如果在memtable里，可以直接通过墓碑标记为删除，如果不在memtable里就插入一条新的删除记录，这两种情况都会在层级合并的时候真正发挥作用，同时WAL里通过一条额外的log记录这个删除操作。

另外感觉WAL里存储的其实就是操作指令流，和raft里面的日志完全一个概念，所以raft协议和leveldb&#47;rocksdb的组合简直是绝配</div>2020-04-21</li><br/><li><img src="" width="30px"><span>suke</span> 👍（18） 💬（3）<div>老师这个rocksdb的更新机制和mysql的innodb也差不多呀，mysql也是先写redo-log，类似于wal顺序写日志，然后更新内存，然后有另外的线程刷脏页数据，为啥rocksdb性能就这么高</div>2020-05-09</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/ajNVdqHZLLBllicLBj61g1ibmCeWzLYpQYEteTOtAAAypoIg6CD19ibXQBbM09VsME9Ta1G8ubwk0ibjiacItavibaeg/132" width="30px"><span>seg-上海</span> 👍（13） 💬（5）<div>老师，“越是被经常读写的热数据，它在这个分层结构中就越靠上，对这样的 Key 查找就越快“，这个是怎么保证的呢，上一层满了不就自动合并并排序写到下一层了，热点数据是怎么还留在上层的呢？
</div>2020-04-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（9） 💬（1）<div>LSM-Tree 删除数据：在每条数据上增加一个删除的标志位，查询的时候判断是否已经删除，落盘的时候根据删除标志位合并数据，但是这样会浪费一些空间资源
</div>2020-04-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/6d/46/e16291f8.jpg" width="30px"><span>丁小明</span> 👍（6） 💬（1）<div>不知道我理解的对不对，也就是说key在存储里面是有可能有多份的？查询的过程是按照顺序从一个一个table中去查询，先查内存后查磁盘，但是level0不是无序的么，怎么确定查找顺序呢</div>2020-04-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/25/f7/4cc60573.jpg" width="30px"><span>zhang</span> 👍（5） 💬（4）<div>老师，之前研究一些用B+数进行元数据的存储系统时有这样一个疑惑。 PS我是搞CDN的，存储系统的磁盘容量比较大，大约是60T以上。

假设一个对象的平均大小是100K, 小的10几k,大的通常不超过1M （超过会分片处理），也就意味着元信息总个数是10x60M个，每个元信息大约是64个字节。已就意味着这颗B+树最小也的30G的内存。

维护一颗元数据的B+树就需要30G的内存，这个开销实在太大了。 请问在实际的数据库中是否也是将整颗B+树维护在内存中吗？ 如果不是，那么它是怎么修改的呢？</div>2020-06-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/dc/ce/a144dea1.jpg" width="30px"><span>yhh</span> 👍（5） 💬（1）<div>wal，除非每写一次操作日志都刷盘，不然应该也是会存在丢数据的可能性吧？</div>2020-05-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/df/6c/5af32271.jpg" width="30px"><span>Dylan</span> 👍（0） 💬（1）<div>这篇文章才收获最多的一篇文章之一～老师应该再多加几篇类似的文章的，还没看够～</div>2020-06-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/e0/1c/aa50dc27.jpg" width="30px"><span>icyricky</span> 👍（0） 💬（2）<div>应该是和TiKV类似，删除的数据增加一个新的删除版本，等真正不用的时候 ，合并SST删除吧。。</div>2020-04-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/88/e0/292508a4.jpg" width="30px"><span>Knuth</span> 👍（28） 💬（5）<div>1.提了rocksdb，不先讲一下leveldb么？
2.讲了lsm不提前先讲下bitcask么？
3.逻辑组织建议梳理一下，tradeoff在哪里，快在哪里，慢在哪里，为什么快，为什么慢，使用场景在哪里。而不是从别的地方搬一些东西过来。</div>2020-04-22</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/ajNVdqHZLLBllicLBj61g1ibmCeWzLYpQYEteTOtAAAypoIg6CD19ibXQBbM09VsME9Ta1G8ubwk0ibjiacItavibaeg/132" width="30px"><span>seg-上海</span> 👍（5） 💬（0）<div>HBase 也是用了LSM-Tree,做到在海量数据时，非常好的写性能，而hbase读的时候需要去region中拼接所有的storeFile，所以他的读比写的性能要差些</div>2020-04-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/34/df/64e3d533.jpg" width="30px"><span>leslie</span> 👍（2） 💬（0）<div>RMDB的瓶颈其实引发了越来越的关于数据系统的研究，老牌RMDB数据库之外现在是百花齐放，许多时候在选型方面看似简单其实已经越来越难以精准定位去选择。
合理的选择才能真正的发挥DB的作用，这种合理性确实越来越难以轻易实现；有时觉得这个和私有云&#47;公有云架构一样，上云看似容易，可是如何合理的选择各种相应的组件却并非易事。
关于RockDB的删除操作其实根据老师说其写入机制时就已经说出了答案，写和删是一对逆操作；其真正的创新还是基于LSM-Tree，思路方面融合了MQ的思想-确实不一样。
谢谢老师今天的分享，期待后续的课程。</div>2020-04-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/bb/61/2c2f5024.jpg" width="30px"><span>haijian.yang</span> 👍（1） 💬（0）<div>NewSQL 已来</div>2020-04-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/47/ae/0a5f7a56.jpg" width="30px"><span>此方彼方Francis</span> 👍（1） 💬（0）<div>LSM的用处真广 感觉哪儿哪儿都用它的影子</div>2020-04-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/17/47/74458b77.jpg" width="30px"><span>杨少君</span> 👍（0） 💬（0）<div>范围查询如何处理呢？比如范围写入有间隔或者跨层级夸文件，也是依次遍历合并结果，然后把结果集优先置于内存或者上层文件level吗？老师</div>2024-09-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ca/cc/d082da9b.jpg" width="30px"><span>快乐冲浪</span> 👍（0） 💬（0）<div>太浅了</div>2024-06-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/58/2c/92c7ce3b.jpg" width="30px"><span>易轻尘</span> 👍（0） 💬（0）<div>所以lsm tree分层查找注定了他的range read性能不佳</div>2024-02-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/55/77/f87f5fc1.jpg" width="30px"><span>brqi</span> 👍（0） 💬（0）<div>cockroachdb用到的KV存储 https:&#47;&#47;github.com&#47;cockroachdb&#47;pebble </div>2023-12-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/55/77/f87f5fc1.jpg" width="30px"><span>brqi</span> 👍（0） 💬（0）<div>cockroachdb现在用自己用go语言开发的pepple kv存储了。</div>2023-12-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0c/a6/f2d8b68e.jpg" width="30px"><span>林潇</span> 👍（0） 💬（0）<div>如果我的应用除了存储以外，还需要进行检索还能用rocksdb吗？
这是我的实际应用，我需要存储nginx的请求日志，同时也要对日志进行检索，比如通过客户端IP、URL、请求方式。我的初步方案是用时间作为Key，但是我同时要支持其他条件检索的话，每次需要对时间区间内的所有记录Value进行字符匹配？假设面对要分页该怎么办呢？</div>2022-08-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/6b/0f/293b999c.jpg" width="30px"><span>旋风</span> 👍（0） 💬（0）<div>kvrocks 和 RocksDB，有什么区别，都是kv存储，只是为了兼容redis协议吗</div>2022-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/16/5b/83a35681.jpg" width="30px"><span>Monday</span> 👍（0） 💬（0）<div>一个星期撸完第一遍，对现在的任务（分表）有现实性参考意义。感谢</div>2020-08-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6a/d5/73c75eb3.jpg" width="30px"><span>夜行观星</span> 👍（0） 💬（0）<div>LSM-tree不是直接删除数据，先在memtable中打个标记，之后合并的时候再把数据删除。</div>2020-05-29</li><br/>
</ul>