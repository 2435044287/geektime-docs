你好，我是李玥。今天这节课我们来说一下电商的账户系统。

账户系统负责记录和管理用户账户的余额，这个余额就是每个用户临时存在电商的钱，来源可能是用户充值或者退货退款等多种途径。

账户系统的用途也非常广泛，不仅仅是电商，各种互联网内容提供商、网络游戏服务商，电信运营商等等，都需要账户系统来管理用户账户的余额，或者是虚拟货币。包括银行的核心系统，也同样包含一个账户系统。

从业务需求角度来分析，一个最小化的账户系统，它的数据模型可以用下面这张表来表示：

![](https://static001.geekbang.org/resource/image/e4/fb/e435af4227850bc7f01b00f4959c10fb.jpg?wh=3479%2A1380)

这个表包括用户ID、账户余额和更新时间三个字段。每次交易的时候，根据用户ID去更新这个账户的余额就可以了。

## 为什么总是对不上账？

每个账户系统都不是孤立存在的，至少要和财务、订单、交易这些系统有着密切的关联。理想情况下，账户系统内的数据应该是自洽的。所有用户的账户余额加起来，应该等于这个电商公司在银行专用账户的总余额。账户系统的数据也应该和其他系统的数据能对的上。比如说，每个用户的余额应该能和交易系统中充值记录，以及订单系统中的订单对的上。

不过，由于业务和系统的复杂性，现实情况却是，很少有账户系统能够做到一点不差的对上每一笔账。所以，稍微大型一点儿的系统，都会有一个专门的对账系统，来核对、矫正账户系统和其他系统之间的数据差异。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg" width="30px"><span>李玥</span> 👍（72） 💬（2）<div>hi，我是李玥。

我们还是回顾一下上节课留的思考题，是这样的。

既然用户的购物车数据存放在MySQL或者是Redis中各有优劣势。那能不能把购物车数据存在MySQL中，并且用Redis来做缓存呢？这样不就可以兼顾两者的优势了么？这样做是不是可行？如果可行，如何来保证Redis中的数据和MySQL中的数据是一样的呢？

关于这个问题，我这样看。

用Redis给购物车库做缓存，技术上肯定是可行的。但是有两个问题需要思考一下。

第一个问题是，值不值得这样做？因为每个人的购物车都是不一样的，所以这个缓存它的读写比差距不会很大，缓存的命中率不会太高，缓存的收益有限，为了维护缓存，还要增加系统的复杂度。所以我们就要自行权衡一下，是不是值得的问题。我的观点是，除了超大规模的系统以外，没有必要设置这个缓存。

第二个问题是，如果我们非要做这样一个缓存，用什么缓存更新策略更好呢？这里我先卖个关子，在《11 | MySQL如何应对高并发（一）：使用缓存保护MySQL》这节课中，我们会专门讲到几种常用的缓存策略，你可以学完这节课之后，再回过头来想一下这个问题。</div>2020-03-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/14/e1/ee5705a2.jpg" width="30px"><span>Zend</span> 👍（22） 💬（11）<div>老师，针对余额更新这种场景，我们是不是就应该用RC隔离级别，因为RR隔离级别会不会存在余额已经被别的事务更新了，而当前事务还是用旧数据。</div>2020-03-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/97/e1/0f4d90ff.jpg" width="30px"><span>乖，摸摸头</span> 👍（14） 💬（1）<div>这里 使用 version 和 select for update 都能解决问题，请问 李sir 实际场合种哪一种更合适</div>2020-05-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/34/b7/60281658.jpg" width="30px"><span>E</span> 👍（9） 💬（4）<div>LAST_INSERT_ID() 这个可以保证是事务里最后插入的那个id吗 会遇到是其他事务产生的id吗</div>2020-03-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/93/cd/dbafc7d1.jpg" width="30px"><span>全麦小面包</span> 👍（8） 💬（1）<div>我是java开发者，像JPA框架是不提供更新的影响行数的，那该怎么办呢？</div>2020-03-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0b/6b/bfa6f7f9.jpg" width="30px"><span>Wisee</span> 👍（6） 💬（1）<div>这种适合单库的操作，如果是业务量大了，分库分表了，就不能这么做了吧</div>2020-03-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/69/d3/d9a858cb.jpg" width="30px"><span>误</span> 👍（4） 💬（1）<div>要是更新余额(假设mysql)、记录流水(假设mongo)不是同一个存储设备，如何使用事务保证同时成功或同时失败？</div>2020-03-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f3/83/e2612d81.jpg" width="30px"><span>锐</span> 👍（3） 💬（1）<div>想知道大厂还用事务吗，或者像银行转账，会用事务吗？分布式微服务不适合事务吧，是否做补偿机制就好呢，比如搞个定时任务定时check再修复数据</div>2020-04-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c5/6a/7f858f1f.jpg" width="30px"><span>白不吃</span> 👍（3） 💬（2）<div>我有个疑问，对于mysql innodb来说，一个事物（线程）操作数据的时候不是会直接锁行么，另一个事物（线程）不是会处于阻塞等待中么？</div>2020-03-12</li><br/><li><img src="" width="30px"><span>suke</span> 👍（3） 💬（5）<div>老师，那更新失败的情况一般电商系统该如何处理？是要继续尝试？还是直接返回失败</div>2020-03-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/86/06/72b01bb7.jpg" width="30px"><span>美美</span> 👍（1） 💬（5）<div>如果隔离级别是RR那log_id作为更新条件的逻辑就可以去了吧？@玥哥</div>2020-03-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/4a/c7/0cff4a59.jpg" width="30px"><span>木木夕</span> 👍（0） 💬（1）<div>老师， LAST_INSERT_ID() 这个SQL函数，如果在业务代码中执行的顺序是accountLogMapper.insert()    接着执行XXXMapper.insert() 最后才是accountBalanceMapper.update()  -&gt; update account_balance set balance = balance + 100, log_id = LAST_INSERT_ID(), timestamp = NOW() where user_id = 0 and log_id = 3;  LAST_INSERT_ID()会自动识别accountLogMapper.insert()的LAST_INSERT_ID的吗？还是说拿到accountLogMapper.insert()返回的LAST_INSERT_ID 再传入accountBalanceMapper.update(LAST_INSERT_ID)去更新？</div>2020-05-23</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/gmP4Yh00MZPwNvr4UQdLeXaX3TVyZEEp195S3vD3Sfl1xz5jBr1474Mt6w5OPr0KsrnQObfLRy5PkKNFjSBiasA/132" width="30px"><span>大头爸爸</span> 👍（0） 💬（1）<div>请问，那个整个交易的 SQL里面，
我们要先查到log_id = 3; 然后set balances里面设定where log_id=3，
怎么才能把它搞成通用的呢？毕竟每次都要手动查很麻烦，要是下次log_id=5, SQL语句又要重改。</div>2020-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/e0/2d/1332fad1.jpg" width="30px"><span>鹏小蔡</span> 👍（0） 💬（1）<div>李sir，上面的例子说在先账户表插入最后一笔更新的流水号，但是在插入流水表的时候却没有insert流水号，这两个流水号不会不一样吗？</div>2020-04-25</li><br/><li><img src="" width="30px"><span>加油吧威基基</span> 👍（0） 💬（1）<div>老师，您文中提到的余额属于数据冗余但是是空间换时间，这就是反范式设计吧</div>2020-03-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4e/1b/f4b786b9.jpg" width="30px"><span>飞翔</span> 👍（0） 💬（4）<div>sql&gt; update account_balance -&gt; set balance = balance + 100, log_id = LAST_INSERT_ID(), timestamp = NOW() -&gt; where user_id = 0 and log_id = 3;Query OK, 1 row affected (0.00 sec)Rows matched: 1 Changed: 1 Warnings: 0 
老师在RR 可重复读的状况下， 如果一个事务修改了流水号从3到log_id=4，并且提交， 但是另一个事务应为是可重复读，他读到的流水号一直是3呀， 这样LAST_INSERT_ID() 他的值不也是3 嘛， 这样另一个事务也会执行成功，但是结果就是不对的了呀</div>2020-03-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/82/1a/64ec25ff.jpg" width="30px"><span>陈靖</span> 👍（0） 💬（5）<div>假如两个事务一起执行，把余额扣成负数了，而两个事务都执行了，该如何处理？</div>2020-03-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/da/79/9b093890.jpg" width="30px"><span>大秦皇朝</span> 👍（0） 💬（1）<div>李Sir，能否大概提一下RC和RR在一般情况下在多少数据量级别，性能差距能有多少？作为小白来说，自己做这种测试貌似受到其它外界因素影响较大，实际测试出来好像感觉不是很明显。因为您可能比较有经验或者经历过，所以想请教下您能否大概说说？感谢！</div>2020-03-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/84/49/47d48fd0.jpg" width="30px"><span>观弈道人</span> 👍（62） 💬（13）<div>这篇讲事务的文章，是遇到的讲的最清楚明白、恰到好处的一篇，没有提看似更本质、更唬人的各种锁，比如间隙锁等，可以说大部人也都不能清楚理解各种锁，对于非专职dba理解此篇的知识技巧足够了。</div>2020-03-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/01/de/bf524817.jpg" width="30px"><span>慌张而黑糖</span> 👍（24） 💬（2）<div>其中在更新账户余额时的where log_id=3这部分感觉和乐观锁中的version起到的作用很像</div>2020-03-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ef/09/209cb7ff.jpg" width="30px"><span>智超</span> 👍（14） 💬（0）<div>这篇文章看了几遍，开始觉得讲清楚了，后面又感觉缺少些什么。如果单纯是说事务，那文章还可以。
但是实际情况，需要考虑的不止这些，比如转账的问题，需要考虑幂等、死锁等。</div>2020-06-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/77/b3/991f3f9b.jpg" width="30px"><span>公号-技术夜未眠</span> 👍（7） 💬（4）<div>老师的文章是采用了乐观锁；在采用乐观锁除了要避免出现ABA问题外，还需要注意可能会出现失败的场景。此时，一般可以采用重试的策略；如果并发不是很高，可以在重试多次不行的情况下，考虑降级为悲观锁策略。</div>2020-03-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/82/83/d3926a61.jpg" width="30px"><span>Geek_fa5d8b</span> 👍（6） 💬（1）<div>READ COMMITTED —— 每次读取数据前都生成一个ReadView

REPEATABLE READ —— 在第一次读取数据时生成一个ReadView</div>2020-06-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/30/5b/ed3b2211.jpg" width="30px"><span>沧浪之水</span> 👍（5） 💬（1）<div>我的理解是，如果只是简单的把两个动作放入一个事务，当并发较大时，有锁等待的问题，只要发生了锁等待，就会引发死锁检测，这个是很耗费性能的。所以老师给出的实现方案，能有效避免锁等待的问题（因为where加了条件）如果更新成功，就提交事务，如果更新不成功，回滚事务。这样可以最大限度的提高并发的效率。因为只要有一个事务成功提交了，其他等待的事务就自动回滚了。而不会一直等着锁。
不知道我的理解对不对 @李sir</div>2020-06-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/a4/27/15e75982.jpg" width="30px"><span>小袁</span> 👍（4） 💬（6）<div>如果用户量暴涨后，流水日志db和账户db分开，就不能用这个方法了。。。</div>2020-03-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a4/d7/5d2bfaa7.jpg" width="30px"><span>Aliliin</span> 👍（4） 💬（0）<div>好喜欢这门实践课。</div>2020-03-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/6d/18/e05f72ee.jpg" width="30px"><span>冰原的苍蓝星</span> 👍（3） 💬（0）<div>这么多年了，我终于搞明白RR和RC了呜呜呜！</div>2022-03-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/08/4c/e5db89c6.jpg" width="30px"><span>活到天年</span> 👍（3） 💬（0）<div>感谢老师，学了之后感觉对事务的理解，对账户表和流水表的设计，以及涉及服务接口 有了更清晰的认识。</div>2020-03-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/51/b8/f76b15a1.jpg" width="30px"><span>sundy</span> 👍（3） 💬（12）<div>李老师，有一点不太明白，mysql默认级别是rr，如您上面的例子，但是rr是更新读的，也就是在执行更新语句时读到的是200，最终的数据不会出错，那为什么还需要您提供的策略呢？你说的记录流水号的策略解决的是具体什么问题请问？</div>2020-03-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/e6/ee/e3c4c9b3.jpg" width="30px"><span>Cranliu</span> 👍（3） 💬（6）<div>RR级别下加的是next-key锁，可以解决幻读的吧？</div>2020-03-05</li><br/>
</ul>