你好，我是李玥。

通过上节课的案例，我们知道，一个慢SQL就可以直接让MySQL瘫痪。今天这节课，我们一起看一下，怎么才能避免写出危害数据库的慢SQL。

所谓慢SQL，就是执行特别慢的SQL语句。什么样的SQL语句是慢SQL？多慢才算是慢SQL？并没有一个非常明确的标准或者说是界限。但并不是说，我们就很难区分正常的SQL和慢SQL，在大多数实际的系统中，慢SQL消耗掉的数据库资源，往往是正常SQL的几倍、几十倍甚至几百倍，所以还是非常容易区分的。

但问题是，我们不能等着系统上线，慢SQL吃光数据库资源之后，再找出慢SQL来改进，那样就晚了。那么，怎样才能在开发阶段尽量避免写出慢SQL呢？

## 定量认识MySQL

我们回顾一下上节课的案例，那个系统第一次全站宕机发生在圣诞节平安夜，故障之前的一段时间，系统并没有更新过版本，这个时候，其实慢SQL已经存在了，直到平安夜那天，访问量的峰值比平时增加一些，正是增加的这部分访问量，引发了数据库的雪崩。

这说明，**慢SQL对数据库的影响，是一个量变到质变的过程，对“量”的把握，就很重要**。作为一个合格的程序员，你需要对数据库的能力，有一个定量的认识。

影响MySQL处理能力的因素很多，比如：服务器的配置、数据库中的数据量大小、MySQL的一些参数配置、数据库的繁忙程度等等。但是，通常情况下，这些因素对于MySQL性能和处理能力影响范围，大概在几倍的性能差距。所以，我们不需要精确的性能数据，只要掌握一个大致的量级，就足够指导我们的开发工作了。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/16/01/28/134da154.jpg" width="30px"><span>冯玉鹏</span> 👍（82） 💬（7）<div>innodb 的索引是用索引关联列以b+树的形式 管理，其中主键索性和数据的物理顺序一致，也叫聚集索引。非主键索引实际上是指向主键索引。
文末的问题对 department_code 列 left 运算后，MySQL 认为运算后的结果不可与原数据列内容匹配，故采用全表扫描， 而第二个语句like  &#39;00028%&#39; 可以使用到索引 是因为索引的最左匹配选择，如果%在前面也将无法使用索引。PS:在这里MySQL的查询优化器在使用了left函数无法匹配索引可以认为有偷懒的嫌疑，哈哈~  类似的场景还有 where 列 +1 = val   查询优化器也完全可以改写成 where 列=val - 1。</div>2020-03-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/e7/f0/d0bf3a5f.jpg" width="30px"><span>Regis</span> 👍（23） 💬（3）<div>后台实际开发中，使用ORM的框架的情况是不是很多？如果使用ORM框架，SQL的写法就不可控了。实际开发中是使用ORM框架好还是直接书写SQL好？还是两种都会存在？一些复杂的查询使用框架查询感觉很痛苦</div>2020-03-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/b3/58/14e407e8.jpg" width="30px"><span>贾敏</span> 👍（14） 💬（2）<div>只知道  LIKE &#39;00028%&#39; 会使用索引， 但是为什么说是最左匹配呢？谢谢老师</div>2020-04-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/e8/55/63189817.jpg" width="30px"><span>MClink</span> 👍（3） 💬（1）<div>单表数据量尽量不要超过千万级别，可以采取的措施有水平分表和垂直分表，在报表数据统计相关的业务中，主要采取的是水平分表，按天，按月，甚至是按日，也有分区，但是这些存储的优化方案，给编码造成了一定的难度，目前我接触的数据表基本都是千万级别，有的甚至过亿，大多是业务日志表，说实话，除了统计所需要的中间表，日志表和页面展示相关的表我们都没有进行分表，我挺想知道我这种架构应该怎么去调整比较好</div>2020-06-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/b6/fe/c5d7f0dc.jpg" width="30px"><span>LiG❄️</span> 👍（2） 💬（1）<div>老师，想请教您一个问题：mysql单库表数量有限制吗？每个库多少表会比较合适啊？ps：项目中设计一个消息推送系统，消息存储现在是以人分表，一人一个消息表（会造成表数据膨胀）；还有想法是想重构，把消息都存在一起，以时间分表～没有做过大存储，还望老师指教😄</div>2020-03-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e4/ae/7b310c2d.jpg" width="30px"><span>呦呦鹿鸣</span> 👍（1） 💬（1）<div>李老师好，一直有个疑问，评估数据量时一般只考虑数据行数就可以么？相同行数下的两张表，2个字段跟20个字段的性能差异需要如何评估呢？</div>2020-04-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/0e/39/174741d1.jpg" width="30px"><span>特种流氓</span> 👍（1） 💬（3）<div>老师 能否在mysql中做设置 超时的sql查询自动停止执行</div>2020-03-25</li><br/><li><img src="" width="30px"><span>fgdgtz</span> 👍（1） 💬（3）<div>你好老师，我想问问如果是 order by 多个字段排序的执行流程是什么样的呢？
比如 有40000行 order by a desc,b desc limit 1000 ,a字段有索引，b字段无索引，a字段保存的是时间戳，有少部分时间戳是同样的，此时explain 会有 Using filesort，这样放入sort_buffer 是40000行 还是 大于1000行而小于40000行呢？或是扫描了多少行？</div>2020-03-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/a4/27/15e75982.jpg" width="30px"><span>小袁</span> 👍（30） 💬（1）<div>简单来说，要写成 &quot;索引 列 = 计算表达式&quot;这种形式，养成这个习惯
</div>2020-03-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/34/df/64e3d533.jpg" width="30px"><span>leslie</span> 👍（15） 💬（0）<div>原因很简单：函数破坏了索引，其实这种写法基本上都会在程序端禁止的；code review这关过不去的，直接发回开发-重写。like 语句其实用到了mysql 5.7所引用的特性 分列，问题就这么简单。</div>2020-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/81/4e/d71092f4.jpg" width="30px"><span>夏目</span> 👍（5） 💬（0）<div>直接在列上做运算会导致索引失效，因为原有索引值运算之后会不满足当前索引值排序，所以不会走索引，最好是把索引值运算改为相应的条件运算</div>2020-04-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg" width="30px"><span>ifelse</span> 👍（3） 💬（0）<div>对字段使用函数，就不会走索引了。</div>2022-12-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/06/7e/735968e2.jpg" width="30px"><span>西门吹牛</span> 👍（3） 💬（0）<div>思考题，对where条件字段，做了函数操作，由于B+树索引，一般涉及索引都是有序的，对字段进行函数操作，就破坏了有序性，所以在有序树上进行搜索，就不能按照搜索树来查找，只能全表扫描</div>2020-06-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/92/01/c723d180.jpg" width="30px"><span>饼子</span> 👍（3） 💬（0）<div>因为where条件使用了函数运算，那么只有扫描每一行才能确定函数执行后的值与判断是否一致</div>2020-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/51/86/b5fd8dd8.jpg" width="30px"><span>建强</span> 👍（2） 💬（0）<div>思考题，个人理解：
大部分的mysql索引都是B+树索引，建立索引时，是以被索引字段的值来创建索引树的节点，检索数据时，需要根据被检索字段的值在索引树中进行比较查找，从而定位被检索的记录ID，然后再根据记录ID，从主键索引中获取所需要的记录；如果在WHERE语句中，对字段使用了函数，那就无法在B+树中对节点的值进行比较，经过函数运算后的值可能就破坏了B+树中节点的规律，比如left(department_code, 5), 如果索引树中按department_code的值从小到大建立索引节结点，而该函数运算的结果是取department_code的前5位，而这前5位的值并不能代表department_code的值，因此，用函数运算的结果去做匹配索引结点，很可能得到错误的结果。所以mysql中对于使用了函数的字段，即使在该字段上创建了索引，也不会去使用索引。</div>2021-11-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/9d/81/d748b7eb.jpg" width="30px"><span>千锤百炼领悟之极限</span> 👍（2） 💬（0）<div>在属性上进行计算不能命中索引。
例如: select * from order where YEAR(date) &lt; = &#39;2020&#39;
即使date上建立了索引，也会全表扫描，可优化为值计算：
select * from order where date &lt; = CURDATE()
或者：
select * from order where date &lt; = &#39;2020-01-01&#39;</div>2020-08-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/da/dd/1e5e7b0c.jpg" width="30px"><span>image</span> 👍（1） 💬（0）<div>Btree索引树只能根据索引值进行范围查找，而无法进行函数运算后查找</div>2020-03-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/08/4c/e5db89c6.jpg" width="30px"><span>活到天年</span> 👍（1） 💬（0）<div>是因为等号的左边使用了函数，如果等号左边使用了函数，则会导致全表扫描，但是如果可以建立函数索引的话，也可以提高查询效率。</div>2020-03-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（1） 💬（1）<div>作为一个合格的程序员，要对数据库的处理能力，有个定量的认知。 说的很对，认同
有个问题就是，有没有一个指标可以知道MySQL每秒钟执行的SQL数量？</div>2020-03-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/14/ee/d72a8222.jpg" width="30px"><span>攻城拔寨</span> 👍（1） 💬（0）<div>索引使用函数会让索引失效，因为必须拿所有索引去计算才能得到结果</div>2020-03-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/1a/05/f154d134.jpg" width="30px"><span>刘楠</span> 👍（1） 💬（0）<div>LEFT()函数是一个字符串函数，它返回具有指定长度的字符串的左边部分。

　　LEFT(Str,length);

　　接收两个参数：

　　　　str：一个字符串；

　　　　length：想要截取的长度，是一个正整数；
left函数，会扫描所有的行，并试图找到所有能与匹配的记录，是值班表扫描</div>2020-03-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f6/f4/95191165.jpg" width="30px"><span>R20114</span> 👍（1） 💬（0）<div>MySQL 执行器去执行查询语句时会先去查询所有的 user 信息，然后对 department_code列执行函数，再和  00028 比较。</div>2020-03-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f9/e6/47742988.jpg" width="30px"><span>webmin</span> 👍（1） 💬（0）<div>left(department_code, 5)经过了函数计算，与索引建立时条件不一至，如果要让left(department_code, 5)使用索引，可以使用函数索引机制来处理。</div>2020-03-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/96/e3/dd40ec58.jpg" width="30px"><span>火车日记</span> 👍（1） 💬（0）<div>where中列使用了函数，优化器无法用到索引</div>2020-03-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/67/fe/5d17661a.jpg" width="30px"><span>悟尘</span> 👍（0） 💬（0）<div>这个思考题很明显是 函数应用，如果对加了索引列的字段使用函数，如max、min、range、left等函数，那索引是不生效的，原因如下：
在索引的构建和使用过程中，数据库系统通常会尽量避免对字段进行函数操作。因为函数会对字段的值进行转换，导致索引失效。在这个查询中，left(department_code, 5) 函数应用在 department_code 字段上，这可能会阻止数据库使用该字段的索引。</div>2023-12-26</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/ZJjl8bEt5zdqufZ304Ra0eibWtJPoVqpMjhu5xgd0o2oAj1ib6MBBWicHzTSFkEPiahxWwiaGsPib4S6N38kCFF0pDDg/132" width="30px"><span>Geek_d432e7</span> 👍（0） 💬（0）<div>针对于SQL对比性能比较那块，我个人认为应该强调一下函数会造成索引失效，并针对与B+Tree执行原理阐述一下函数造成索引失效原因比较好。另外，针对于上一章节首页的问题，我在思考是否直接使用Freemaker完成首页静态化处理是否更加合理。主要是首页待查询的内容太多了，如果黑产使用定时器大量刷新首页会出大问题，无论是针对于webserver还是数据库缓存都不是一个好的选择。如果说你考虑使用nginx加lua完成针对于高频次刚问用户IP进行封禁的策略。我完全可以使用nginx正向代码技术完美破解而且成本很低。</div>2023-05-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg" width="30px"><span>ifelse</span> 👍（0） 💬（0）<div>对于复杂的查询，最好使用 SQL 执行计划，事先对查询做一个分析。--记下来</div>2022-12-07</li><br/><li><img src="" width="30px"><span>Geek_fe19fb</span> 👍（0） 💬（0）<div>对一个千万级别的表执行查询，加上几个 WHERE 条件过滤一下，符合条件的数据最多可能在几十万或者百万量级，这还可以接受。但如果再和其他的表做一个联合查询，遍历的数据量很可能就超过千万级别了

这个观点是有问题的，关联的过程中如果被驱动表存在索引 驱动表多少数据就扫描多少行  若没有索引也不是你说的几千万这么简单的</div>2022-04-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/72/67/aa52812a.jpg" width="30px"><span>stark</span> 👍（0） 💬（0）<div>上面的sql语句的执行里有left函数了，所以没有使用到索引</div>2022-01-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/36/1d/f5486ffe.jpg" width="30px"><span>你的笑忘书</span> 👍（0） 💬（0）<div>简而言之就是：left(department_code, 5) 操作导致索引失效。</div>2021-09-13</li><br/>
</ul>