说起秒杀，我想你肯定不陌生，这两年，从双十一购物到春节抢红包，再到12306抢火车票，“秒杀”的场景处处可见。简单来说，秒杀就是在同一个时刻有大量的请求争抢购买同一个商品并完成交易的过程，用技术的行话来说就是大量的并发读和并发写。

不管是哪一门语言，并发都是程序员们最为头疼的部分。同样，对于一个软件而言也是这样，你可以很快增删改查做出一个秒杀系统，但是要让它支持高并发访问就没那么容易了。比如说，如何让系统面对百万级的请求流量不出故障？如何保证高并发情况下数据的一致性写？完全靠堆服务器来解决吗？这显然不是最好的解决方案。

在我看来，**秒杀系统本质上就是一个满足大并发、高性能和高可用的分布式系统**。今天，我们就来聊聊，如何在满足一个良好架构的分布式系统基础上，针对秒杀这种业务做到极致的性能改进。

## 架构原则：“4要1不要”

如果你是一个架构师，你首先要勾勒出一个轮廓，想一想如何构建一个超大流量并发读写、高性能，以及高可用的系统，这其中有哪些要素需要考虑。我把这些要素总结为“4要1不要”。

1\. 数据要尽量少

所谓“数据要尽量少”，首先是指用户请求的数据能少就少。请求的数据包括上传给系统的数据和系统返回给用户的数据（通常就是网页）。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/dc/b7/e59c22f0.jpg" width="30px"><span>黄金的太阳</span> 👍（282） 💬（3）<div>希望老师可以分别从1W QPS，10W QPS ，100WQPS在架构升级前遇到的性能瓶颈做为讲解入口点，为什么这样设计之后就能解决问题的方式，为什么切分点是1万，10万和100万，瓶颈的分析方式等等，感觉效果更好，否则看到一堆架构，但并不清楚为什么要这样做还是很难平移到自己的系统设计中，一点拙见，希望老师能够解惑</div>2018-10-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/12/93/3470fc43.jpg" width="30px"><span>Mr.钧👻</span> 👍（85） 💬（2）<div>高并发系统的几大方向
1.请求数据尽量少，从而减少cpu消耗
2.访问路径尽量短，减少节点消耗
3.强依赖尽量少，减少加载时间
4.不要有单点，要有备份
5.减少额外请求，减少加载时间</div>2018-10-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/36/2c/8bd4be3a.jpg" width="30px"><span>小喵喵</span> 👍（48） 💬（3）<div>1 .本地cache用什么实现好呢？
2. 通过什么方式往本地cache  写数据呢？ 
3. 秒杀系统的及时性非常高，把库存写进cache  ，怎么及时更新呢？
</div>2018-10-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/2b/2b/bebf6eed.jpg" width="30px"><span>酱了个油</span> 👍（28） 💬（1）<div>库存不会放在localcache，localcache只放静态数据。
库存是放在独立的缓存系统里，如redis，库存是采用主动失效的方式来失效缓存</div>2018-10-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/25/c3/da248508.jpg" width="30px"><span>Edward</span> 👍（26） 💬（4）<div>数据缓存在机器内存中的话，集群内如何实现多台机器数据一致性？</div>2018-10-01</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI8qNibLrzJyrNv6C3BKRm0ibbibrSrcLxiaWOicQUEcUuk75hG5tdCnAYiapHrHuSdxyXhp1B5ZDKiahHIg/0" width="30px"><span>王永旺</span> 👍（17） 💬（4）<div>单点的概念是啥意思，不太明白</div>2018-10-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/31/49/c83d3d1a.jpg" width="30px"><span>MeazZa</span> 👍（16） 💬（1）<div>请问一下减库存的结果分别是如何更新到公共缓存和本地缓存的呢？</div>2018-10-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8b/ee/56823fd7.jpg" width="30px"><span>王虹凯</span> 👍（14） 💬（1）<div>能不能给一些你认为的关键知识点在文章最后加一些对这些点的外链。这样可以更详细，当然更具系统性。 极客时间也可以考虑这样的一个功能，整个当前专栏共用这些链接。

当然，作者不加这些也没问题，只是觉得那样是不是更权威些。不过要求作者太多了！</div>2018-10-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/31/62/6f1bb71e.jpg" width="30px"><span>云飞</span> 👍（12） 💬（2）<div>老师你好，刚才说要设计时候尽量做到4要1不要，1不要就是不要用单点，也就是因为没有数据备份，想问这个单点和单点登录系统的单点有什么关系吗？希望老师有时间可以解答一下。</div>2018-11-28</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/dglMUGgevn9w5w3AGtTDibGhqGjf7G3GHwlOGXQl25xD7g2EsEktgxh2v4dgriaI2yLG2j45IhZCbhVg1eDrugOQ/132" width="30px"><span>1024</span> 👍（11） 💬（1）<div>阅读5分钟，留言中回复看了半个多小时；感觉从读者讨论中收益更大，许神加油！</div>2018-11-25</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEJjTz6oOKAXefgCNHTuTmwibBPJX9a4c407GHYmFPdMRgX67nZiavj2KhbiczicaaeSGxOxiaibnqH7icnVw/132" width="30px"><span>broken_open</span> 👍（10） 💬（12）<div>老师你好，减库存操作，update  count = count-1  where  count&gt;0，这种做法不会多卖吧？</div>2019-02-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/33/10/0592f684.jpg" width="30px"><span>李海凡</span> 👍（8） 💬（1）<div>想了解系统性能和架构升级背后的逻辑是什么，这样设计系统解决了具体什么瓶颈，例如您举的例子中，qps只能到10w、为什么只能到10w,瓶颈在什么地方，如何分析，如何解决</div>2018-10-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/70/51/f1825adb.jpg" width="30px"><span>Lugyedo</span> 👍（8） 💬（1）<div>缓存中的热点数据在高并发情况下如何保证一致</div>2018-10-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/25/66/4835d92e.jpg" width="30px"><span>潘政宇</span> 👍（7） 💬（3）<div>每经过一个节点，一般都会产生一个新的 Socket 连接。什么意思啊，不是一个tcp连接就有一个socket吗，从客户端到server就是一个tcp连接啊？</div>2018-10-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/20/dd/82d8eff2.jpg" width="30px"><span>Mine</span> 👍（6） 💬（8）<div>库存cache的更新为什么要通过mq去处理呢，感觉直接在操作数据库之后更新下缓存就可以了啊～ 为什么还要发一条消息呢～ </div>2019-04-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/26/33/6beaea17.jpg" width="30px"><span>猎户星座</span> 👍（6） 💬（1）<div>请问秒杀的时间是怎么控制的，比如十点开始，十点十分结束。各个客户端、客户端与服务器、以及集群内的服务器之间。时间如何精确同步？</div>2018-10-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/b7/c2/196932c7.jpg" width="30px"><span>南琛一梦</span> 👍（5） 💬（1）<div>文中讲的原则在后续给出的架构演变例子中，并没有很好的进行说明，看完之后，并没有对此有深刻体会</div>2018-10-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5f/a0/bc54404a.jpg" width="30px"><span>xiaoxiangran</span> 👍（4） 💬（2）<div>我对秒杀系统有个最大的疑惑，就是从页面发出的请求用同步还是异步？如果用同步的话：1，后端服务必然是分布式的，需要经过多个节点，时间可能会被拉的很长，同时失败的可能性也会增大；2，基于1的情况，会有一个长连接长时间存在，这样随着请求的增多，连接资源越来越少，系统吞吐量会是瓶颈。如果用异步的话：不断的轮询必然会增加系统的请求量，对连接资源也是一种浪费。所以，这应该怎么选择呢？</div>2019-03-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/dc/9d/e20b37d7.jpg" width="30px"><span>机遇号</span> 👍（4） 💬（1）<div>您好，
关于这个没搞懂。
把远程过程调用（RPC）变成 JVM 内部之间的方法调用。
这个怎么解释一下吗</div>2019-03-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4f/25/75316ed6.jpg" width="30px"><span>nico</span> 👍（4） 💬（1）<div>老师 ，测试秒杀系统现在比较好用的工具都有哪些？可否推荐一下。</div>2019-02-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/a8/64/965e0d9b.jpg" width="30px"><span>王维</span> 👍（4） 💬（1）<div>老师好，我觉得图1有个地方有问题，秒杀详情系统需要从cache中读取缓存数据，那么是不是缺少一个从读cache到秒杀详情系统的箭头→？</div>2018-10-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/29/7a/a60948c3.jpg" width="30px"><span>一成</span> 👍（3） 💬（1）<div>读过作者的《深入分析java技术内幕》,看到作者的专栏直接订阅了</div>2018-11-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/68/c3/8e1a8dbf.jpg" width="30px"><span>Plantegg</span> 👍（3） 💬（2）<div>还是偏理论性概念性的介绍，我想大家更多是希望可以看到可以复制的具体操作，能扛住了自然能升华到这下理论，我们缺的是具体可以复制的落地套路</div>2018-10-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/37/90/48ff56fe.jpg" width="30px"><span>九號</span> 👍（3） 💬（1）<div>localCache存的是什么样的数据？</div>2018-10-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/b5/33/9220b644.jpg" width="30px"><span>樊亚楠</span> 👍（3） 💬（1）<div>虽然还没看，但是很期待</div>2018-10-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/f5/d4/5a0a2f8d.jpg" width="30px"><span>火腿</span> 👍（2） 💬（1）<div>&quot;最关键的详情和交易系统都增加了本地缓存&quot;, 这里的本地缓存是指保存在用户浏览器的缓存还是服务器端的缓存? </div>2018-11-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/7a/b9/c3d3a92f.jpg" width="30px"><span>G小调</span> 👍（2） 💬（1）<div>很赞 给自己订个目标 看完课程后 也能设计一个好的秒杀系统</div>2018-10-01</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/YxDsehVIaqpebiaUXWXh2NFUBI3mhrNAZSzH2aiaJGFCFclgYNX7icqeV7E6WcmobZ5mSnoW1IQ2GffNWibH6cv6icw/132" width="30px"><span>Fine</span> 👍（1） 💬（1）<div>不要单点，可以理解成要做分布式部署吗</div>2019-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/54/73/4c3179ab.jpg" width="30px"><span>与你为邻</span> 👍（1） 💬（1）<div>大佬好，库存要不要加锁</div>2018-11-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/cf/e1/adacde45.jpg" width="30px"><span>无尘</span> 👍（1） 💬（1）<div>老师这个秒杀系统，支持多种库存扣减或者回补策略吗？例如订单超时回补，库存预扣，支付或者拍下等扣减时机的不同处理策略</div>2018-11-12</li><br/>
</ul>