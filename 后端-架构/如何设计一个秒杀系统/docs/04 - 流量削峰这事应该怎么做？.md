如果你看过秒杀系统的流量监控图的话，你会发现它是一条直线，就在秒杀开始那一秒是一条很直很直的线，这是因为秒杀请求在时间上高度集中于某一特定的时间点。这样一来，就会导致一个特别高的流量峰值，它对资源的消耗是瞬时的。

但是对秒杀这个场景来说，最终能够抢到商品的人数是固定的，也就是说100人和10000人发起请求的结果都是一样的，并发度越高，无效请求也越多。

但是从业务上来说，秒杀活动是希望更多的人来参与的，也就是开始之前希望有更多的人来刷页面，但是真正开始下单时，秒杀请求并不是越多越好。因此我们可以设计一些规则，让并发的请求更多地延缓，而且我们甚至可以过滤掉一些无效请求。

## 为什么要削峰

为什么要削峰呢？或者说峰值会带来哪些坏处？

我们知道服务器的处理资源是恒定的，你用或者不用它的处理能力都是一样的，所以出现峰值的话，很容易导致忙到处理不过来，闲的时候却又没有什么要处理。但是由于要保证服务质量，我们的很多处理资源只能按照忙的时候来预估，而这会导致资源的一个浪费。

这就好比因为存在早高峰和晚高峰的问题，所以有了错峰限行的解决方案。削峰的存在，一是可以让服务端处理变得更加平稳，二是可以节省服务器的资源成本。针对秒杀这一场景，削峰从本质上来说就是更多地延缓用户请求的发出，以便减少和过滤掉一些无效请求，它遵从“请求数要尽量少”的原则。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/13/20/fc/927ab903.jpg" width="30px"><span>胡镇华</span> 👍（39） 💬（10）<div>用消息队列实现的话，处理结果无法立即知晓，用户体验不真实，有没有更实时的方案？</div>2018-10-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/bd/da/3d76ea74.jpg" width="30px"><span>看不到de颜色</span> 👍（10） 💬（1）<div>看完本篇文章，有几点疑问还想请老师解答一下。
1.使用消息队列削峰的话，可以知道消息是否被消费，但是是否真的秒杀成功该如何向用户返回。
2.看到老师提到削峰的方式，之前有看过到诸如令牌桶，漏桶之类的算法。是否也可以在此引入呢？
3.如果并发请求过大的话是否可以在每个服务上加入信号量来控制，数量为库存大小。每当处理一个请求就减一下，归零不再向下处理呢。</div>2018-10-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/81/cd/f5555346.jpg" width="30px"><span>Ballontt</span> 👍（10） 💬（2）<div>可不可以前端直接按照1%的概率去请求后台接口。请数量一下就下降了100倍</div>2018-10-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7e/32/e569f729.jpg" width="30px"><span>Lost In The Echo。</span> 👍（10） 💬（1）<div>请求入队列后怎么给用户“交代”？</div>2018-10-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/31/d1/dc1f9b95.jpg" width="30px"><span>皇甫</span> 👍（9） 💬（1）<div>请问徐老师，当请求被丢进消息队列以后，是就直接返回给用户吗？ 那用户怎么知道请求是否成功了呢？</div>2018-10-08</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epLLXBLBLgticobxvBYRezd304Y66Q8ibYCl7mG9dvTHGrx9obRcn7ZmJBcib3ibsQPIX3xIbNYiaAUrOA/132" width="30px"><span>Geek_c991e0</span> 👍（5） 💬（1）<div>大神问下，如果秒杀库存总数是10，那削峰队列大小就是10吗，如果有后面不买了，但是已经入了队列了，怎么办。还是说队列放所有请求，这样的话是不是浪费啊</div>2018-11-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/3a/3b/3a6efa8f.jpg" width="30px"><span>GrubbyLu</span> 👍（4） 💬（1）<div>徐老师看了其他同学的留言以及您的回复之后，还是有一点不能理解。就是用消息队列进行解耦之后，如何把消息队列处理秒杀请求的结果反馈给用户，有什么好的通知方式嘛？（看到有一个同学留言说用长链接异步推送结果，您说用户体验偏差，麻烦能介绍一些好的方式嘛）</div>2018-10-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/25/66/4835d92e.jpg" width="30px"><span>潘政宇</span> 👍（4） 💬（1）<div>队列被打满了，直接丢包吗？</div>2018-10-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/02/a8/ff61bff2.jpg" width="30px"><span>大老杨</span> 👍（4） 💬（2）<div>这种答题的是不是对于秒杀场景用户体验不是很好</div>2018-10-04</li><br/><li><img src="" width="30px"><span>Geek_it05up</span> 👍（3） 💬（8）<div>有个奇怪的想法，比如10万个人12:00秒杀10个商品，系统在12:00前在10万个人中挑选10个用户id放缓存，真正秒杀时直接判断用户id在不在缓存中，在缓存就进入后面的逻辑，最差的情况就是缓存中的10个用户最终没有来秒杀，那再走正常的秒杀逻辑</div>2019-05-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ed/39/d9706a1a.jpg" width="30px"><span>弘毅</span> 👍（3） 💬（2）<div>我想问下，对于一个秒杀，什么样的请求是无效请求呢？感觉所有订单请求都是希望购买的有效请求，那么就这个请求的有效和无效是基于什么来区分的？</div>2018-11-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d1/27/e364df55.jpg" width="30px"><span>😂😂😂</span> 👍（3） 💬（1）<div>不好意思，我表述错了。是在给多张表插入数据时，像并发情况下，很多用户都下订单并付款，那么插入时是直接插入到数据库吗？</div>2018-10-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/7f/88/c4263c58.jpg" width="30px"><span>五年</span> 👍（3） 💬（1）<div>零点大促开始了...发放优惠券怎么操作呢....我这个时候已经在指定商品这里等着了....</div>2018-10-11</li><br/><li><img src="" width="30px"><span>Lee</span> 👍（3） 💬（1）<div>有两个小问题请教一下：
生产者将用户请求放入队列后，用户的请求就结束了，但是消费者还未处理，这时生产者给用户返回什么呢？
队列的消费者处理完用户的请求后，怎么返回结果给用户呢？ </div>2018-10-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/24/86/6069f169.jpg" width="30px"><span>func</span> 👍（3） 💬（2）<div>许大神你好，请求入队列后怎么给用户  反馈结果？</div>2018-10-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/b6/98/46ec8e9a.jpg" width="30px"><span>落雪飞花</span> 👍（3） 💬（1）<div>增加答题之后，答题系统应该也有性能瓶颈，是提前预热还是怎么处理？</div>2018-10-05</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLsia5hqVlTLn17lUBwSpSUzraib7MSH3gOUNWOx8qUwpz3Lp6gFtkIibOMUAouyMGj5RIeTcePUfNkw/132" width="30px"><span>jg4igianshu</span> 👍（2） 💬（1）<div>问题 key：userId+itemId+question_Id+time+PK
答案 key：userId+itemId+answer+PK
这两个key我不是很理解，为什么要加上time，还有pk是什么?
感谢指点！</div>2019-04-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/62/ff/221c2950.jpg" width="30px"><span>迎风追日</span> 👍（2） 💬（1）<div>我来晚了，老师还在吗？给老师点个赞！</div>2019-03-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/6f/06/82d8bdfb.jpg" width="30px"><span>D.L</span> 👍（2） 💬（1）<div>请问，分层过滤这里有点没理解，意思是说每层都做库存检验，但不做强一致（锁）是吗，直到最后一层再做？</div>2018-12-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/49/e6/4f00fe55.jpg" width="30px"><span>Mac Kwan</span> 👍（2） 💬（1）<div>让我想起了以前零点去抢特价机票的画面。输入网址打开发现被转向到了一个“小黑屋页面”，倒计时后重新自动刷新尝试才有机会进入到真正的业务网站订机票。老师你能简单分析一下这个方案实现方式以及优缺点吗</div>2018-10-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/7f/88/c4263c58.jpg" width="30px"><span>五年</span> 👍（2） 💬（1）<div>消息队列这个方式也,如果我们进入消息队列的话,想要用户实时知道抢购结果,是不是需要像小米的抢购那种,直接把页面设置成抢购中,然后再回来通知...
这个通知是否需要 websocket 长链接,又或者其他实现?</div>2018-10-11</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIqWaVic6yGdicbM2ca4KaJLo3oVtxnpea9hb2zMKSvM2UNiadF5l3PW88QJibcKiaf5b61c0cVa72ZYjw/132" width="30px"><span>杜明欣</span> 👍（1） 💬（2）<div>消息队列有处理一种方式是，用户请求进入队列之后，不立即返回而是设置超时同步等待，消息被消费会唤起等待，返回到用户。这样可以防止用户请求给下游系统造成太大压力</div>2018-10-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ea/5d/8f7b20a1.jpg" width="30px"><span>曾斌</span> 👍（1） 💬（2）<div>要对流量进行削峰，最容易想到的解决方案就是用消息队列来缓冲瞬时流量，把同步的直接调用转换成异步的间接推送，中间通过一个队...
-----------------------------
这个方式虽然提高了系统吞吐量，但是库存扣减成功了，如果通知用户秒杀成功？</div>2018-10-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/30/20/a5cf4ac4.jpg" width="30px"><span>Geek_eyc9a6</span> 👍（1） 💬（1）<div>用消息队列时，如果请求被队列接受到，可不可以理解为前端进入排队页面，然后轮询排队结果，可能抢购成功，可能抢购失败？</div>2018-10-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/36/2c/8bd4be3a.jpg" width="30px"><span>小喵喵</span> 👍（1） 💬（1）<div>1.分层过滤，既然是请求，为什么有些是无效呢？
2.将动态请求的读数据缓存（Cache）在 Web 端，过滤无效的数据读。这个cache是动态的呀，是不是经常需要更新cache呢？能举例一下，到底什么样子的动态数据缓存（Cache）在 Web 端？？
3.限流保护具体怎么做？谢谢。</div>2018-10-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/1f/58/ade4475d.jpg" width="30px"><span>李勇</span> 👍（1） 💬（1）<div>不错</div>2018-10-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/21/76/5d052ba7.jpg" width="30px"><span>Ben</span> 👍（1） 💬（1）<div>第一第一</div>2018-10-04</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLsia5hqVlTLn17lUBwSpSUzraib7MSH3gOUNWOx8qUwpz3Lp6gFtkIibOMUAouyMGj5RIeTcePUfNkw/132" width="30px"><span>jg4igianshu</span> 👍（0） 💬（1）<div>补充提问:time的精读是多少。
我思考了下正常只需要问题key，存储的数据包含cdn图片地址和答案。
答案key是做什么用？应该不需要记录玩家答题的数据吧！谢谢指点迷津！</div>2019-04-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/99/af/d29273e2.jpg" width="30px"><span>饭粒</span> 👍（0） 💬（1）<div>请问下，如果排队和答题一起采用，排队处理的位置是在系统什么位置？是在 “图 4 答题的验证逻辑” 秒杀请求之前吗？</div>2018-12-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/27/a9/80468562.jpg" width="30px"><span>流沙</span> 👍（0） 💬（1）<div>开始介绍的，使用消息列队，当队列满了之后，不可以做判断处理吗？</div>2018-10-25</li><br/>
</ul>