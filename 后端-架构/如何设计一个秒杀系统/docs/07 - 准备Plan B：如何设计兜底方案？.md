这是《如何设计一个秒杀系统》专栏的最后一篇文章，前面我们一起看了很多极致的优化思路，以及架构的优化方案。但是很遗憾，现实中总难免会发生一些这样或者那样的意外，而这些看似不经意的意外，却可能带来非常严重的后果。

我想对于很多秒杀系统而言，在诸如双十一这样的大流量的迅猛冲击下，都曾经或多或少发生过宕机的情况。当一个系统面临持续的大流量时，它其实很难单靠自身调整来恢复状态，你必须等待流量自然下降或者人为地把流量切走才行，这无疑会严重影响用户的购物体验。

同时，你也要知道，没有人能够提前预估所有情况，意外无法避免。那么，我们是不是就没办法了呢？当然不是，我们可以在系统达到不可用状态之前就做好流量限制，防止最坏情况的发生。用现在流行的话来说，任何一个系统，都需要“反脆弱”。

具体到秒杀这一场景下，为了保证系统的高可用，我们必须设计一个Plan B方案来兜底，这样在最坏情况发生时我们仍然能够从容应对。今天，我们就来看下兜底方案设计的一些具体思路。

## 高可用建设应该从哪里着手

说到系统的高可用建设，它其实是一个系统工程，需要考虑到系统建设的各个阶段，也就是说它其实贯穿了系统建设的整个生命周期，如下图所示：

![](https://static001.geekbang.org/resource/image/42/35/4225335357b6208a67410c36ea8a1535.jpg?wh=1985%2A618)

图1 高可用系统建设
<div><strong>精选留言（24）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/13/37/37/5b23a28f.jpg" width="30px"><span>似水流年</span> 👍（17） 💬（2）<div>从第一篇到第最后一篇大都是思想理论指导，有具体的例子和实现伪代码会更好</div>2018-10-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/36/2c/8bd4be3a.jpg" width="30px"><span>小喵喵</span> 👍（14） 💬（1）<div>1。降级方案可以这样设计：当秒杀流量达到 5w&#47;s 时，如何判断达到了5w&#47;s呢？我想到的写一个windows服务或者一个工具不停的跑，但这样也太low了吧。期待老师更好的方案？
2.客户端限流，是在数据库做配置吗？配置某些用户不让发起请求或者发请求次数的限制吗？
3.服务端限流，完全不明白，请老师举例说明一下。
4.例如我们的系统最高支持 1w QPS 时，可以设置 8000...，你是怎么判断是否到达8000?</div>2018-10-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/36/2c/8bd4be3a.jpg" width="30px"><span>小喵喵</span> 👍（8） 💬（1）<div>编码阶段：例如涉及远程调用问题时，要设置合理的超时退出机制，防止被其他系统拖垮，也要对调用的返回结果集有预期，防止返回的结果超出程序处理范围，最常见的做法就是对错误异常进行捕获，对无法预料的错误要有默认处理结果。
1.如何判断调用一个接口超时？接口那边不会返回超时标识的。
2.结果集有预期,后面请举一个具体的例子说明一下，什么预期，程序处理范围，错误异常进行捕获，默认处理结果等等。</div>2018-10-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/00/e6/7201c9f3.jpg" width="30px"><span>贵楠</span> 👍（4） 💬（1）<div>老师可否提供一个demo呢</div>2018-10-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（3） 💬（3）<div>意犹未尽，内功心法口诀已经传授，下面就看悟性和修炼啦！
为了系统的高可用，我们需要B计划，为了使系统仍然可用，我们准备了降级、限流、拒绝服务三件法宝。每次备战，也玩这些！不过是组织配合实现自己完全实现还远的很。
这个专栏值得反复回味！</div>2018-11-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f0/de/ef564e67.jpg" width="30px"><span>歌在云端</span> 👍（2） 💬（1）<div>最讨厌的就是kpi考核，不是流行OKR吗</div>2018-10-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/1d/27/46aeb4aa.jpg" width="30px"><span>随风</span> 👍（1） 💬（1）<div>我初试都没过，所以也就没机会碰见大佬了</div>2019-03-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/98/30/6516b094.jpg" width="30px"><span>打老师屁屁</span> 👍（1） 💬（1）<div>老师， 如何根据并发量有效的计算需要多少台机器， 比如 LB，WEB，CACHE，MQ，各需要多少台机器。有没有一个参考值</div>2018-10-15</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKwvj3wcI41yfw60JaB0vNBDgWaURgMOlGcoHVCX9mvzOFiaUjMXZu9lLmwuufEHcgibZjt2avNHXibw/132" width="30px"><span>Geek_eae456</span> 👍（0） 💬（6）<div>请问“统计qps用一个计数器就行，来一个请求加一，一秒统计一次”这种方案如果遇到【0.5，1】【1，1.3】两个区间都有4.5WQPS，假设最大是5WQPS，这样单秒没有超，可是【0.5，1.5】超了怎么处理呢？</div>2019-04-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4c/1b/b1953a5e.jpg" width="30px"><span>江中芦苇</span> 👍（57） 💬（2）<div>世界好小，大佬作为滴滴复试面试官</div>2018-11-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/cb/01/1f3cfc2d.jpg" width="30px"><span>_Mr.Bool ®</span> 👍（5） 💬（1）<div>之前分布式QPS限流用的Redis+lua实现的，还好用的redis cluster集群结构，100个节点，几十万QPS都稳定扛下来了</div>2019-02-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a6/d2/ebe20bb5.jpg" width="30px"><span>阿棠</span> 👍（1） 💬（0）<div>这课程都是思想理论，看完了，又感觉没看，要是能有一个demo结合理论就最好了。</div>2023-12-16</li><br/><li><img src="" width="30px"><span>Mango</span> 👍（1） 💬（0）<div>兜底方案可以采用最简单的方法，为极端情况下减少访问量</div>2020-03-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/b2/91/714c0f07.jpg" width="30px"><span>zero</span> 👍（1） 💬（1）<div>听完老师的课程，顿时毛塞顿开，方法方向已经有了，剩下的就靠自己摸索了，感谢</div>2020-02-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/fe/37/6745fe0c.jpg" width="30px"><span>鬼见愁</span> 👍（0） 💬（0）<div>阿里出来出来的同学为啥都卷，因为习惯了KPI</div>2024-07-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/37/3f/a9127a73.jpg" width="30px"><span>KK</span> 👍（0） 💬（1）<div>“如果优惠券系统扛不住，可能会临时降级商品详情的优惠信息展示，把有限的系统资源用在保障交易系统正确展示优惠信息上”，这是什么意思呀，有些颠来倒去的意思。“降级商品详情的优惠信息展示”，又“保障正确展示优惠信息”？优惠信息都降级了，又是如何保障优惠展示呢？！！！</div>2023-12-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/b2/91/85ff8e18.jpg" width="30px"><span>bittersweet</span> 👍（0） 💬（0）<div>如果连核心接口的强依赖挂了，有什么推荐的兜底方案吗？</div>2023-03-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg" width="30px"><span>escray</span> 👍（0） 💬（0）<div>Plan B 有两层意思，一个是说在前面所有的方案之外，再叠加一个保险方案；另外就是说，不得不用的方案。

高可用系统建设框架估计也是知易行难的事情，除非做到系统架构师级别，否则也只能是纸上谈兵。不过知道一个大致的高可用框架——架构、编码、测试、发布、运行、故障处理全生命周期，也是有意义的，至少知道整体的蓝图是什么样子的——预防、管控、监控、恢复一个也不能少。

降级、限流、拒绝服务，这个应该是一个逐步递进的兜底方案，到了拒绝服务的时候，一般来说应该不会被击穿了。即使用户体验不好，但是至少系统还活着。</div>2020-11-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/7b/0a/b65e1fae.jpg" width="30px"><span>不要挑战自己的智商</span> 👍（0） 💬（0）<div>拒绝服务也没用什么不好。秒杀本来就是一种抢购行为。库存有限。排队结果也会是后面的用户买不到商品，这和直接拒绝的效果是一样的。</div>2020-09-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/af/a6/3f15ba2f.jpg" width="30px"><span>czh</span> 👍（0） 💬（0）<div>整个专栏，一口气读完，最大收获是思考问题方法：在软件的整个【生命周期】中全面考虑如何解决！</div>2020-02-22</li><br/><li><img src="" width="30px"><span>dingdongfm</span> 👍（0） 💬（0）<div>请教一个问题：“限流”和“拒绝服务”两种方式本身也会消耗服务器的资源，如果对应服务器的资源也超负荷了，系统不是一样会被压垮么？</div>2019-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/b2/ba/b74f2ec0.jpg" width="30px"><span>橙子橘子柚子皮</span> 👍（0） 💬（0）<div>期待有针对客户端与服务端分布式环境的限流讲解</div>2019-09-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d6/55/47e76936.jpg" width="30px"><span>叶易</span> 👍（0） 💬（0）<div>许老师是把方法论给我们了，要真正掌握还是要在工作中不断实践。</div>2019-03-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/88/1e/69e84907.jpg" width="30px"><span>罗罗诺亚.恩佐</span> 👍（0） 💬（0）<div>看完了，非常不错！赞，期待新的课程上架。</div>2018-12-12</li><br/>
</ul>