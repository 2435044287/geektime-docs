十一黄金周的时候，极客时间团队邀请到了前阿里巴巴高级技术专家许令波专门撰写了《如何设计一个秒杀系统》专栏，希望带你透彻理解秒杀系统的各个关键技术点，并借助“秒杀”这个互联网高并发场景中的典型代表，带你了解如何打造一个超大流量并发读写、高性能，以及高可用的系统架构。

专栏虽然只有短短7篇，但却持续获得大量用户的支持和赞誉。留言区，我们更是可以看到大量从学习角度或业务角度出发提出的各种问题。为此，我们也特别邀请专栏作者许令波就一些关键或普遍的问题进一步“加餐”解答，希望能够给你更好的帮助。

**1. “06 | 秒杀系统‘减库存’设计的核心逻辑”一文中，很多用户比较关注应用层排队的问题，大家主要的疑问就是应用层用队列接受请求，然后结果怎么返回的问题。**

其实我这里所说的排队，更多地是说在服务端的服务调用之间采用排队的策略。例如，秒杀需要调用商品服务、调用价格优惠服务或者是创建订单服务，由于调用这些服务出现性能瓶颈，或者由于热点请求过于集中导致远程调用的连接数都被热点请求占据，那么那些正常的商品请求（非秒杀商品）就得不到服务器的资源了，这样对整个网站来说是不公平的。

再比如说，正常整个网站上每秒只有几万个请求，这几万个请求可能是非常分散的，那么假如现在有一个秒杀商品，这个秒杀商品带来的瞬间请求一下子就打满了我们的服务器资源，这样就会导致那些正常的几万个请求得不到正常的服务，这个情况对系统来说是绝对不合理的，也是应该避免的。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg" width="30px"><span>我来也</span> 👍（7） 💬（1）<div>还有加餐，厉害了👍</div>2018-11-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/0a/c8/dae4a360.jpg" width="30px"><span>Do</span> 👍（5） 💬（3）<div>你好，分组是为避免热点，这是ok的，我所说的空间浪费3倍不是指分组的浪费，我指的是组内的机器。如你的例子，一个组里面有3个varsion实例，那么假设这3个varsion实例的内存是1GB，那么其实这3个varsion实例也就只能提供1GB的的缓存。假如这个组命名为A组，分别给组内varsion实例分别命名为A1,A2A3,假设每组的热点数据是2GB,那么是否有以下几个缺陷
1：缓存不一致，会导致一台实例请求过的还需要在回源。例如有个商品A的请求，被路由到A组，那么第一次随机到A1，此时A1需要回源然后存储，那么假设下次同下是商品A的请求，还是被路由到A组，但是这次被路由到A2，此时因为A2没请求过所以还是需要回源请求下。也就是组内各个varnish的缓存数据不一致会导致不必要的请求回源；
2：集群数据扩容代价大。例如现在集权每台varnish实例是1GB内存进行HTTP缓存，然后为了提高HTTP缓存命中率，将varnish实例内存提高到2GB，尽可能的将热点数据在每个varnish实例间缓存，那么以你集群所示，一个组3台机器，由于varnish实例间不共享内存数据，所以为了能尽可能的缓存，每台机器都需要扩容到2G，也就是一共是增加了3GB内存,但是只提高了1GB的缓存增加；
 您留言说的Nginx增加热点模块，也有上述缺陷吧
我的问题是:
1.关于我所说的第一点,是否可以让商品请求在组内时，使用一致性HASH算法路由到varnish实例上而不是随机访问组内varnish实例；
2.关于第二点，有什么好的方式解决吗</div>2019-02-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/78/ac/e5e6e7f3.jpg" width="30px"><span>古夜</span> 👍（4） 💬（4）<div>第一个问题:同一个商品比如苹果，多个这种苹果的ID是否相同？

二:这个其实很好理解，Cache 实例越多，那么这些 Cache 缓存数据需要访问的次数也就越多。例如我有 3 个 Redis 实例，需要 3 个 Redis 实例都缓存商品 A，那么至少需要访问 3 次才行，而且是这 3 次访问刚好落到不同的 Redis 实例中。那么从第 4 次访问开始才会被命中，如果仅仅是一个 Redis 实例，那么第二次访问时其实就能命中了。所以理论上 Cache 实例多会影响命中率。
这块没明白，希望老师再详细讲讲</div>2019-01-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/76/20/2f9c6763.jpg" width="30px"><span>耶愿</span> 👍（4） 💬（1）<div>许老师，问个问题，关于并发写的问题，目前我知道MySQL和redis并发写即使做过优化，tps也就是上千。而淘宝的写入tps至少上万，想知道淘宝是怎么做到上万写入tps的，而用户没有等待的感觉，非常感谢！虽然其它同学有留言，但感觉他们的方法都是过家家的方法，我想知道淘宝这是怎么实现的。</div>2018-12-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/a3/dc/11eef428.jpg" width="30px"><span>Adam</span> 👍（4） 💬（1）<div>解析binlog的中间件是什么？有开源的产品么？ 不然自己实现的话代价就比较大了</div>2018-11-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/58/3a/98d6ee8d.jpg" width="30px"><span>oTo123</span> 👍（3） 💬（1）<div>老师，请问一下，一个其他问题。商品详情页这种页面，有商品数据，商家数据，评价数据，商品推荐等。这些是放到一个接口返回呢（这样接口那耦合了多个模块的数据），还是每个部分都开一个接口给前端调用（这样减少了网络开销次数）? 在性能需求下怎么权衡呢?</div>2019-01-18</li><br/><li><img src="" width="30px"><span>IT小菜鸟</span> 👍（3） 💬（4）<div>许神，打扰您一下，您抽空帮我看一下这个问题，就是我现在项目中的用的spring版本是3.2.0 的，我现在要用spring-session实现session共享，我看网上都是要求spring版本4.x以上，我在本地试了一下，发现session是能存到redis里的，但是我把项目部署到服务器上的时候却存不到redis里，不知道是什么原因，还望许神有空帮忙分析一下哈</div>2018-12-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c1/60/f5439f04.jpg" width="30px"><span>Geek_dn82ci</span> 👍（2） 💬（1）<div>失效中心可以直接调用cdn的接口服务吧</div>2019-04-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/23/85/e19f8833.jpg" width="30px"><span>tony</span> 👍（2） 💬（1）<div>针对Cache和DB的数据一致性问题，如果DB是A团队业务使用的，Cache是B团队业务使用。DB对于B团队来说不可控，可以通过什么方式对A提出较少的需求（比如是要在DB所在机器安装监控binlog的中间件吗？比如要求A团队打开DB的binlog？），实现读取Cache和A业务的DB数据一致性。</div>2018-12-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f4/49/2b938b4f.jpg" width="30px"><span>北极的大企鹅</span> 👍（1） 💬（5）<div>比较想问的是学完框架后，是先学设计模式还是先学JVM原理，并发与线程安全，然后中间件和架构设计，数据库设计，Linux学习，跨语言学习顺序，这些都是按照什么样的顺序学习的，还有源码阅读顺序</div>2019-04-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ec/7b/f082c80f.jpg" width="30px"><span>du</span> 👍（1） 💬（1）<div>所以需要采用一个分组中有多个实例缓存相同的数据（冗余）的办法来支撑更大的访问量。
………
</div>2019-03-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/92/58/b4f6365d.jpg" width="30px"><span>小北</span> 👍（1） 💬（1）<div>请问老师，关于cache失效问题，一般秒杀商品详情不怎么会变，那为什么不可以一直缓存在cache中，不设置过期呢，等秒杀结束再删掉？</div>2019-01-25</li><br/><li><img src="" width="30px"><span>15757172538</span> 👍（1） 💬（1）<div>binlog的监控有推荐的分析工具吗？
oracle有类似binlog的日志分析方式吗？</div>2018-11-19</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132" width="30px"><span>null</span> 👍（1） 💬（1）<div>re: 解析 MySQL 的 binglog，然后发现有 Insert、Update、Delete 等操作时，会把变更前的数据以及要变更的数据转成一个消息发送给订阅方

问题：
将『变更后』的数据转成消息发给订阅方，是方便不用再查询数据库获得数据么？

为啥要将『变更前』的数据也发给订阅方吖？这里的『变更前』数据，只是一个 id 之类而非全量数据吧？

谢谢</div>2018-11-15</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLGicA7oewUtC2VOuaO2UaSs5q2Feic7JJrvrJHgeaJqK4ewF1rMhsZaTZ5IeaUqibjAgTiag0W6iaDyDg/132" width="30px"><span>晓洁</span> 👍（0） 💬（1）<div>什么时候上新呢？</div>2019-02-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/0a/c8/dae4a360.jpg" width="30px"><span>Do</span> 👍（0） 💬（1）<div>你好，在2. 在“02 | 如何才能做好动静分离？有哪些方案可选？一文中，有介绍静态化的方案中关于 Hash 分组的问题。”中varnish是做了分组，分为2组，每组3台机器。我的问题是，分支并且组内多个varnish实例虽然能避免单点和热点问题，但是组内的机器其实存储的数据很大部分是一样的，varnish是单实例部署，实例间没有共享内存，这样会不会导致内存浪费。例如存储1GB的HTTP缓存，那么这个架构的话实际上就是消耗3GB存储，而且以后如果组内需要扩容的话，其实也受制于与单个varnish实例的内存大小，比如原先单个实例是1GB内存进行缓存，发现不够用了需要2GB了，那么需要的话是就只能讲组内的varnish实例的内存都增加的2G，消耗了3G确只提高了1GB的存储量，不像Aerospike或者mongode sharding模式下，增加机器就能提高整个集群的存储量。不知道我的理解对不对</div>2019-01-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/2e/36/10a11413.jpg" width="30px"><span>外星人</span> 👍（0） 💬（2）<div>如果是秒杀1个商品10个库存，服务端请求排队1000个(10倍库存量或更多)，超出1000个直接返回“秒杀结束”，这种方式有啥不好呢？</div>2018-12-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/fb/fb/701d2652.jpg" width="30px"><span>张雨桐老豆</span> 👍（84） 💬（6）<div>这方面的东西看了很多，但是，大多数程序员是接触不到或者这方面的知识让你去搭建设计一个这样的系统，一方面公司没有这么大的流量，除了一些bat公司.另一方面，就算有这个留了，一般的系统都是现成的.一个100人的团队，也许就那么一两个人负责，大多数还是在硬编码，所以说大多数的程序员都停留在一个理论阶段，很少有实践的地方</div>2018-12-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/89/46/ff27e90f.jpg" width="30px"><span>Geek_gthxw2</span> 👍（13） 💬（2）<div>看来看去 没有看出个所以然 看来还是我道行不够</div>2019-01-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/ef/55/57393993.jpg" width="30px"><span>Bf-Bus</span> 👍（1） 💬（1）<div>在没有理论与实践相结合的前提下，看完整片文章并没有特别的感觉，类似文章在网上也有很多</div>2021-03-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/95/68/41546e8a.jpg" width="30px"><span>Leo</span> 👍（1） 💬（0）<div>看完 估计也难有机会实践</div>2019-08-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/fa/44/aa19d1f6.jpg" width="30px"><span>放</span> 👍（1） 💬（0）<div>感谢老师的分享，即使不做架构师，对以后写代码的思路也有很大的提升！</div>2018-12-11</li><br/><li><img src="" width="30px"><span>李晓东</span> 👍（0） 💬（0）<div>慢慢消化</div>2022-02-22</li><br/><li><img src="" width="30px"><span>宋雨新</span> 👍（0） 💬（0）<div>感谢老师</div>2022-02-20</li><br/><li><img src="" width="30px"><span>王益维</span> 👍（0） 💬（0）<div>很有参考价值</div>2021-12-31</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eo0zjOtxgSibuXNhp6fSu8qXXiaOjE7uLHy6FhyDGYLjYZl6AxvSG0K1Nlrq9ZZqv8TW2CqE2Tgh2eg/132" width="30px"><span>杨超</span> 👍（0） 💬（0）<div>感谢老师</div>2021-09-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/23/5b/983408b9.jpg" width="30px"><span>悟空聊架构</span> 👍（0） 💬（0）<div>失效监控中心眼界大开</div>2021-04-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/86/d7/bfd9e42a.jpg" width="30px"><span>轨迹</span> 👍（0） 💬（0）<div>所以，就是redis减扣库存成功之后，所有抢库存成功的请求，都同时去生成订单吗？mysql扛得住？
还是说先记录用户抢购成功状态(消息队列异步记)，让用户进入到提交订单页面，然后分散用户创建订单时间？但是这样其实还是有可能并发量比较大啊</div>2021-04-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/e1/96/5853624a.jpg" width="30px"><span>攻城汪</span> 👍（0） 💬（0）<div>我是阿里同学，其中什么tair的集团外的人貌似看不懂，还有mysql的优化他们也想像不到，建议可以另开一个课程介绍这些他们接触不到的原理之类的，我觉得他们会非常感兴趣</div>2021-03-05</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJsOFUdib57ORVyia33dibSGRgwZZ9L2hQ90Xh5WsDUHfpHoCW2AMibnawMLBS6upGH3Qic57kl4PE6v2w/132" width="30px"><span>mbc</span> 👍（0） 💬（0）<div>提高缓存命中率有啥好的方案吗？比如根据 redis的ttl把快过期的key通过job定期去更新</div>2020-12-20</li><br/>
</ul>