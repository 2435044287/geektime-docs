上一节课，我们介绍了幂等框架的一个重要需求场景，接口超时重试。为了避免同一业务被多次重复执行，接口需要支持幂等特性。同时，我们还对功能性需求和非功能性需求做了梳理。今天，我们来讲解幂等框架的设计思路。

跟限流框架类似，幂等框架的功能性需求也比较简单，但要考虑处理的异常情况有很多，比如业务代码异常、业务系统宕机、幂等框架异常。今天，我们重点讲解如何应对这些异常情况，设计一个高度容错的幂等框架。

话不多说，让我们正式开始今天的学习吧！

## 幂等处理正常流程

调用方从发起接口请求到接收到响应，一般要经过三个阶段。第一个阶段是调用方发送请求并被实现方接收，第二个阶段是执行接口对应的业务逻辑，第三个阶段是将执行结果返回给调用方。为了实现接口幂等，我们需要将幂等相关的逻辑，添加在这三个阶段中。

正常情况下，幂等号随着请求传递到接口实现方之后，接口实现方将幂等号解析出来，传递给幂等框架。幂等框架先去数据库（比如Redis）中查找这个幂等号是否已经存在。如果存在，说明业务逻辑已经或者正在执行，就不要重复执行了。如果幂等号不存在，就将幂等号存储在数据库中，然后再执行相应的业务逻辑。

正常情况下，幂等处理流程是非常简单的，难点在于如何应对异常情况。在这三个阶段中，如果第一个阶段出现异常，比如发送请求失败或者超时，幂等号还没有记录下来，重试请求会被执行，符合我们的预期。如果第三个阶段出现异常，业务逻辑执行完成了，只是在发送结果给调用方的时候，失败或者超时了，这个时候，幂等号已经记录下来，重试请求不会被执行，也符合我们的预期。也就是说，第一、第三阶段出现异常，上述的幂等处理逻辑都可以正确应对。
<div><strong>精选留言（26）</strong></div><ul>
<li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/3XbCueYYVWTiclv8T5tFpwiblOxLphvSZxL4ujMdqVMibZnOiaFK2C5nKRGv407iaAsrI0CDICYVQJtiaITzkjfjbvrQ/132" width="30px"><span>有铭</span> 👍（72） 💬（2）<div>幂等框架是宁可错杀，不可放过，放过了（多执行）修复难度太大，错杀了无非是再执行一次</div>2020-06-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/55/e1/8c223e95.jpg" width="30px"><span>qwerboo</span> 👍（10） 💬（7）<div>那如果事务回滚，同步到redis中的值怎么处理呢？不删除的话下次请求不就会被拒绝吗？</div>2020-07-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8d/a6/22c37c91.jpg" width="30px"><span>楊_宵夜</span> 👍（4） 💬（2）<div>争哥，文中关于[业务系统宕机处理]那节的第二段，
&quot; 如果幂等号已经记录下了，但是因为机器宕机，业务还来得及执行，按照刚刚的幂等框架的处理流程，即便机器重启，业务也不会再被触发执行了，这个时候该怎么办呢？除此之外，如果记录幂等号成功了，但是在捕获到系统异常之后，要删除幂等号之前，机器宕机了，这个时候又该怎么办？ &quot;

应该是业务还‘没‘来得及执行吧？
吹毛求疵般地执行文章评审，手动狗头。</div>2020-06-25</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erkQ49YqAySHOlynF8fC7Z65ic0icmWYKVJFicAiam4RFcyzZK5IqWI9KYaicaEqw3B24ibaKSicqTOdwDzQ/132" width="30px"><span>KLOOOP</span> 👍（3） 💬（5）<div>&quot;针对这个问题，我们还有另外一种解决方案。那就是，在存储业务数据的业务数据库（ 比如 MySQL）中，建一张表来记录幂等号。幂等号先存储到业务数据库中，然后再同步给幂等框架的 Redis 数据库。&quot;--- 1.记录幂等号；2.执行业务逻辑；3.同步给幂等框架的reidis；4.以上都成功，提交事务。这样理解对么？</div>2020-06-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/b1/95/57bb9624.jpg" width="30px"><span>Jeff</span> 👍（2） 💬（1）<div>业务写执行日志到DB，性能问题怎么解决？不如写本地日志，虽然系统异常时日志可能丢失，但是不影响性能，最后只要选好日志框架问题不会太大</div>2020-08-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg" width="30px"><span>Jxin</span> 👍（23） 💬（11）<div>1.这教的不止是设计模式。还包含了设计过程中的权衡取舍。看栏主的专栏，就像个小迷弟一样，每篇都是666打call。

2.针对今天的专栏延伸一个问题。我们知道rpc接口一般都是result返回的模式。然后系统的异常可以分为业务异常和技术异常，业务异常一般重试解决不了，需要主动告警人工介入，技术异常则往往需要重试，自动化解决。这就导致result中的code往往有多个值，用于区分业务异常和技术异常走相应的逻辑。

但是我觉得这很难受，我希望result的code只有0和1，仅用于表示是否发生了技术异常，甚至我希望没有result这种返回模式（rpc框架层面处理技术异常），毕竟rpc技术就是让开发者像调用本地接口一样调用远程接口。但是如果code只表示技术异常，那么属于业务异常的标记和异常消息就只能放在data中，这又让接口返回数据和业务异常耦合了。当然，我们也可以不捕捉业务异常，让它在调用侧抛出，这更贴合像调用本地方法一样调用远程方法的理念，但这样站在服务方的角度，最外层的接口都没有处理异常，又显得不合适了。

所以，请问栏主和各位同学，rpc接口的返回应该怎么设计合理，你们又是怎么实践的？

3.回答课后题。比如某个策略依赖配置表，由于配置信息缓存延迟，发生了业务异常。这时候异常是业务异常，但引起异常的原因是缓存延迟这个技术问题。重试可以走通流程，但需要人工介入刷新缓存，或则等待缓存刷新。</div>2020-06-08</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJKj3GbvevFibxwJibTqm16NaE8MXibwDUlnt5tt73KF9WS2uypha2m1Myxic6Q47Zaj2DZOwia3AgicO7Q/132" width="30px"><span>饭</span> 👍（13） 💬（0）<div>一路跟着栏主，坚持到现在，一篇篇啃下来，不知不觉的，如今跟人聊起设计，突然也讲得头头是道。刷完这一波，再重读第二遍</div>2020-06-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/3b/67/c188d3bc.jpg" width="30px"><span>tingye</span> 👍（12） 💬（0）<div>二八原则这里看起来也适用，20%正常处理代码，80%异常处理代码。
业务异常可能有更复杂的情况，比如第一次业务操作失败原因可能是依赖的业务条件未达成（B用户不存在），但延迟一段时间就满足了（B用户创建好了），这种可能需要支持延迟重试策略，而重试也要给个上限，避免死循环</div>2020-06-09</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoiaP1gptuBzj3AXMpY8yLTIkpuarouOVzLde4636UJ7zAgnOEZibiaAIRVAicFaO64ftH45YOn1pD3VA/132" width="30px"><span>Geek_35cfdd</span> 👍（7） 💬（1）<div>那这个幂等框架每次都要依赖开启数据库事务，不然无法保障业务数据和幂等框架插入的数据同时成功或者同时失败。而开事务本身是业务方根据自己的业务场景决定，如果业务本身不需要开事务，而引入幂等框架需要强开事务，这种耦合性本身也是比较高的。
我的想法是，可以在幂等框架中幂等键引入中间状态。成功状态。失败状态。三种。
在 中间状态和成功状态 都可以幂等住。
失败状态（对应文中的删除）。
文中说的极端情况，可以引入异步任务，去更新。</div>2020-10-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e5/69/719ec5d0.jpg" width="30px"><span>Jian</span> 👍（4） 💬（0）<div>每天下班回家看一讲，快尾声了</div>2020-06-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/d9/ff/b23018a6.jpg" width="30px"><span>Heaven</span> 👍（2） 💬（1）<div>框架本身在设计的时候,尽可能的考虑到相关的异常问题,一般都够触发项目的异常的,还是启动时候因为配置文件设置错误导致的异常问题,这就需要对配置文件的正确性进行校验
而且,对于幂等号,我们是否可以设置过期时间,来方便项目组件宕机后重启,直接使用,不用手动删除幂等号了</div>2020-06-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/f4/8c/0866b228.jpg" width="30px"><span>子房</span> 👍（1） 💬（0）<div>现在都是微服务架构，服务实例的量太多了，幂等框架作为低等框架，让每一个微服务都在建立一个存储幂等号的表是否有点代价太大了</div>2021-02-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/a5/98/a65ff31a.jpg" width="30px"><span>djfhchdh</span> 👍（1） 💬（0）<div>查询redis，或者写redis的时候，如果失败，这种异常情况也需要考虑</div>2020-09-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/bd/68/3fd6428d.jpg" width="30px"><span>Cutler</span> 👍（1） 💬（0）<div>如果业务方记录了幂等号，就不用回写到redis了吧，个人偏向于数据库记录幂等号，可以一个微服务数据库对应一张幂等号的表，但幂等号要全局唯一，这个是需要业务发起方来保证的。</div>2020-07-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/1b/f9/018197f1.jpg" width="30px"><span>小江爱学术</span> 👍（0） 💬（1）<div>先把幂等号写入业务数据库，再同步至缓存这种方案，如果考虑同步的时间差呢。比如，当我业务执行完毕，幂等号写入到业务数据库，但是还没被同步到缓存，这个时候相同业务的请求被发送，由于缓存中还没有写入幂等记录，业务不是会被再执行一次吗，除非判断幂等的时候先查询缓存，如果没有再查询业务数据库，但是这样做的话，对性能，以及业务和非业务代码的分离都不友好，不知道这个问题咋考虑。</div>2023-06-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/37/63/5f/3ae4e299.jpg" width="30px"><span>许愿灵灵</span> 👍（0） 💬（0）<div>请问是视频教学吗</div>2023-05-22</li><br/><li><img src="" width="30px"><span>Geek_7e0e83</span> 👍（0） 💬（0）<div>新幂等号的并发请求场景，比如在幂等框架中遇到并发请求情况下，都会判断通过，并执行业务逻辑。
应对的方法是：加锁 同步的执行幂等判断</div>2022-12-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/1d/0b/5f353b88.jpg" width="30px"><span>芝士烤松饼</span> 👍（0） 💬（0）<div>分布式系统下还需要考虑幂等号全局唯一，不可重复，或许可以参照雪花算法实现</div>2021-12-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/e1/75/bbdf9052.jpg" width="30px"><span>饭太司替可</span> 👍（0） 💬（0）<div>本章突出一个解决问题的灵活性</div>2021-09-22</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eotIianb3beTzsGIte6BZxlIhEwc2ryrNBGxZy8ibKbfibVJyUS8d3ZxybAdfJwHPm13ydPC4VJP7Lbw/132" width="30px"><span>taku</span> 👍（0） 💬（0）<div>如果是多数据源的事务，幂等号保存位置还是要依赖分布式事务吧</div>2021-07-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/1d/7d/368df396.jpg" width="30px"><span>somenzz</span> 👍（0） 💬（1）<div>我被问到这样一个问题：在数据同步的场景下，比如说两个数据库a和b，数据从a流向b，准实时，因为是异步，a把数据推给b，b返回a 消息说OK，然后在入库，实际上b入库可能会错了，b自己也可能不知道，那么如何确保a和b的数据版本始终保持一致的？</div>2021-07-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/9c/47/f4e36efb.jpg" width="30px"><span>承诺如手中沙</span> 👍（0） 💬（0）<div>‘’幂等号先存储到业务数据库中，然后再同步给幂等框架的 Redis 数据库，同步给redis存在延时问题，怎么解决</div>2021-06-18</li><br/><li><img src="" width="30px"><span>勿更改任何信息</span> 👍（0） 💬（0）<div>其他可能的异常
记录幂等号可能超时，记录了立即去查询可能由于延迟查询不到</div>2021-06-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/f6/7b/b6abcbbe.jpg" width="30px"><span>否极泰来</span> 👍（0） 💬（0）<div>一些异常处理可以有配置来决定，由业务开发人员来确认，是允许重试，还是直接报错。
可以给默认值，约定由于配置，在特别的地方特殊处理一下就好了。</div>2021-04-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7e/bb/947c329a.jpg" width="30px"><span>程序员小跃</span> 👍（0） 💬（0）<div>数据库事务处理完了再操作redis，如果redis还出错，那就需要手动把数据库回滚回去吗?</div>2020-10-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/68/ef/6264ca3d.jpg" width="30px"><span>Magic</span> 👍（0） 💬（0）<div>并发请求下，执行多次
</div>2020-08-14</li><br/>
</ul>