上一节课，我们主要介绍了策略模式的原理和实现，以及如何利用策略模式来移除if-else或者switch-case分支判断逻辑。今天，我们结合“给文件排序”这样一个具体的例子，来详细讲一讲策略模式的设计意图和应用场景。

除此之外，在今天的讲解中，我还会通过一步一步地分析、重构，给你展示一个设计模式是如何“创造”出来的。通过今天的学习，你会发现，**设计原则和思想其实比设计模式更加普适和重要，掌握了代码的设计原则和思想，我们甚至可以自己创造出来新的设计模式**。

话不多说，让我们正式开始今天的学习吧！

## 问题与解决思路

假设有这样一个需求，希望写一个小程序，实现对一个文件进行排序的功能。文件中只包含整型数，并且，相邻的数字通过逗号来区隔。如果由你来编写这样一个小程序，你会如何来实现呢？你可以把它当作面试题，先自己思考一下，再来看我下面的讲解。

你可能会说，这不是很简单嘛，只需要将文件中的内容读取出来，并且通过逗号分割成一个一个的数字，放到内存数组中，然后编写某种排序算法（比如快排），或者直接使用编程语言提供的排序函数，对数组进行排序，最后再将数组中的数据写入文件就可以了。

但是，如果文件很大呢？比如有10GB大小，因为内存有限（比如只有8GB大小），我们没办法一次性加载文件中的所有数据到内存中，这个时候，我们就要利用外部排序算法（具体怎么做，可以参看我的另一个专栏《数据结构与算法之美》中的“排序”相关章节）了。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/4f/13/5197f8d2.jpg" width="30px"><span>永旭</span> 👍（10） 💬（3）<div>哪位了解无状态的类是什么意思 ?</div>2020-04-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4a/96/99466a06.jpg" width="30px"><span>Laughing</span> 👍（3） 💬（1）<div>在之前项目中，有个缓存的实现开始直接使用的redis来实现的，后来使用内存缓存替换，这样一来我使用了策略模式根据缓存key的类型，自动选择策略进行缓存。</div>2020-11-24</li><br/><li><img src="" width="30px"><span>一万小时</span> 👍（3） 💬（1）<div>策略模式看着像是个工厂模式</div>2020-11-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/1c/8c/3af20a8e.jpg" width="30px"><span>Fitch Kuma</span> 👍（2） 💬（1）<div>对查表法来避免if-else很有感触，之前设计Jenkins pipeline是就是用Map来存放不同的component部署到不同server的映射关系的. 感觉策略模式的本质就是多态？</div>2020-07-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d1/70/5c644be9.jpg" width="30px"><span>木又寸</span> 👍（1） 💬（3）<div>策略类膨胀的情况，小争哥有没一些最佳实践可以分享？

业务实现上，可能一个父级策略下有多个子策略（譬如促销活动有满减&#47;返现&#47;立减等，满减规则下又有几种复杂的优惠策略），这时候把所有满减规则塞进一个策略类，有些偏离我们的初衷；将子策略拆分为独立的策略，策略类的数目又会急剧膨胀。

如何取舍？或者能否混合其他模式来适应这种场景？</div>2020-05-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/00/4e/be2b206b.jpg" width="30px"><span>吴小智</span> 👍（217） 💬（6）<div>&quot;设计原则和思想比设计模式更加普适和重要&quot;，被这句话一下子点醒了。可以这样说，设计原则和思想是更高层次的理论和指导原则，设计模式只是这些理论和指导原则下，根据经验和场景，总结出来的编程范式。</div>2020-03-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/68/fe/1353168d.jpg" width="30px"><span>岁月</span> 👍（77） 💬（10）<div>看到这里我感觉好多设计模式都很类似, 都是先针对接口编程, 然后再加个查表法😂</div>2020-04-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/a0/a3/8da99bb0.jpg" width="30px"><span>业余爱好者</span> 👍（43） 💬（1）<div>策略集合的信息也可以定义成枚举，可以放在数据库，可以放kv配置中心，等等。都是一样的道理。

策略模式是对策略的定义，创建和使用解藕。定义和创建的过程与业务逻辑关系不大，写在一起会影响可读性。

创建型模式是对创建和使用的解藕。

做什么和怎么做是应该解藕的，使用者并不关心具体的细节。

在业务逻辑中，与业务逻辑不大的代码应该放在外部。就像mvc的三层架构是业界的最佳实践。在service层调用dao层，而不是直接jdbc,因为如何操作数据库是个复杂的过程，却又与业务逻辑无关，所以单独抽出一层，代码结构变得更加清晰。

声明式编程很火。它就是把使用和内部实现原理解藕。java,spring的各种注解，声明式事务等等。使用者一个注解解决所有问题，无需关心底层。

业务逻辑无关的放在一起影响可读性，即使自己过一段时间看自己的代码也会迷惑。写代码要有用户思维，不光是提供的api满足kiss原则，内部的实现也是一样。能放在外面单位代码尽量怎么放在外面。只要能表达逻辑即可。</div>2020-03-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg" width="30px"><span>Jxin</span> 👍（25） 💬（3）<div>1.为了让调度的代码更优雅时使用。（就调度策略的代码而言，可读性高。理解结构后，阅读的心智负担低，因为调度的原理已经抽象成了共同的type查表，无需逐行检阅分支判断。像一些与持久数据相关的策略，有时为了兼容老数据或则平滑过度，无法全采用type查表，这时就需要结合if来 实现。所以采用if会让我误以为是这种场景，进而逐行检阅）。

2.感觉问反了，应该是什么场景下采用ifelse和witch。毕竟这两个的场景少些。答案是，在逻辑不复杂又不好用卫语句时采用。能用卫语句就不要ifelse。因为个人而言，看到retuern或conti能很明确跳出逻辑，else脑袋得转一下，当然这可能是个人习惯影响。但ifelse还是只在逻辑简单，没啥嵌套（一个函数内部不宜嵌套过多），且语义符合的场景用好些。

3.原则和思想毕竟是指导核心，是地图和尺子，自然是最重要的。但是不等于设计模式就比其不重要了。硬要说的话，我认为两个其实一样重要。设计模式是场景的积累，拉近了普通人与天才的差距，对我这种菜鸡来说可能比设计原则还重要。毕竟从设计原则到设计模式的出现，需要丰富经验，扎实知识和妙手偶得。如果没有设计模式的铺垫，普通人拿着设计模式的知识点要一路走上高质量代码的层级，实属不易。</div>2020-03-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/e0/d7/744bd8c3.jpg" width="30px"><span>空白昵称</span> 👍（12） 💬（0）<div>很早前使用了类似策略模式的代码做了一个从各种渠道上传下载文件。（当时大学毕业，没看过策略模式，但是学过C++的多态）其实也就是基于接口而非实现编程思想。

if-else使用，如果判断较少，且未来几乎不会有新需求要再加一个else时，保持if-else即可。其他的都可以使用策略模式。不过本节demo的实例，使用range来匹配，目前看是没问题。但是如果需求变化，需要增加一个根据数据特征的动态分配排序算法，那么这里实现就麻烦了。所以需要根据具体需求来看使用什么模式... 

</div>2020-03-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/60/5f/59ee0ca2.jpg" width="30px"><span>极客海</span> 👍（11） 💬（0）<div>&quot;设计原则和思想比设计模式更加普适和重要&quot;，被这句话一下子点醒了。</div>2021-02-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/3b/47/f6c772a1.jpg" width="30px"><span>Jackey</span> 👍（9） 💬（4）<div>想想以前都没用过策略模式，一会到公司看看我的if-else有没有必要优化</div>2020-03-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/10/fa/d977627e.jpg" width="30px"><span>刘大人</span> 👍（8） 💬（0）<div>问：在什么情况下，我们才有必要去掉代码中的 if-else 或者 switch-case 分支逻辑呢？
答：自己看不下去的时候</div>2021-02-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7e/1f/b1d458a9.jpg" width="30px"><span>iamjohnnyzhuang</span> 👍（8） 💬（0）<div>策略模式平时开发用的比较多，主要目的还是解耦策略的定义和使用。在Java中，比较喜欢用枚举策略模式。可以定义一个枚举类，提供静态方法根据传入的Type动态返回对应的枚举类。然后在枚举类中定义执行策略的抽象方法，这样迫使每个枚举都得去实现。对于策略不是非常复杂的情况下，这样可以集中管理这一批策略，新增策略的时候也只要在这个枚举类中添加。但是如果策略很复杂会导致这个类非常庞大，还是用传统的方法不同类对应不同逻辑更加优雅。总之，遵循KISS原则，怎么简单怎么来；同时尽量遵循开闭原则，添加策略的时候尽量少去改动代码。其实对于什么时候去掉IF&#47;ELSE这个问题原理也是一样的。</div>2020-03-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/a8/0c/82ba8ef9.jpg" width="30px"><span>Frank</span> 👍（6） 💬（0）<div>1，最近在做规则引擎，前端用户通过页面设置出业务执行的流程图，而流程图中包含数据源节点、条件判断节点、业务分发节点、业务事件执行节点。每一种节点执行的业务校验规则都不同，这个时候适合策略模式。使用策略模式的好处是：以后随着业务的发展很有可能出现其他类型的节点，所以这个时候采用策略模式非常合适，易扩展易维护。另外在整个流程流转的规则上采用了模板方法。
2，当出现比较多的等值匹配的时候，这个时候使用switch case 更合适，结构清晰，可读性强，其他则使用if-else，当然if-else也可以进行等值比较。</div>2020-03-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/14/ee/d72a8222.jpg" width="30px"><span>攻城拔寨</span> 👍（6） 💬（0）<div>1. 奖励系统，奖励用户不同奖励是通过后台配置，从多个奖励中选择一种或者多种。
后端代码根据不同的奖励类型找到对应的奖励策略类，执行对应的代码。
2. 我觉得在 if-else 每个分支代码比较多的时候就应该拆分了。但是拆分不一定就能通过设计模式拆分，很多时候把分支逻辑抽成另一个方法就就够了，代码简洁，方便维护。
我相当同意老师 “设计原则和思想比设计模式更加普适和重要。” 这句话。</div>2020-03-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/03/01/62b32acf.jpg" width="30px"><span>王飞洋</span> 👍（6） 💬（5）<div>GB = 1024 * 1024 * 1024吧</div>2020-03-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/1d/cd/3819726f.jpg" width="30px"><span>徐同学呀</span> 👍（5） 💬（0）<div>最近在做公司的告警模块，对接收方式用了策略模式，以前也不知道这就是策略模式，只是觉得模块和思想解藕了。
还有接收方式的选择策略和升级策略都用了策略模式。

非要去掉if-else，我觉得如果分支不多，简单，以后可扩展性不强可以不去掉。否则就换成map缓存策略对象或者class。找到if-else条件和策略的对应关系。</div>2020-03-23</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqXKSvfaeicog2Ficx4W3pNeA1KRLOS7iaFy2uoxCDoYpGkGnP6KPGecKia6Dr3MtCkNGpHxAzmTMd0LA/132" width="30px"><span>Geek_East</span> 👍（4） 💬（0）<div>策略模式不仅仅是去除几个if-else，起到k-v store作用这么简单:
1. 开闭原则: 行为类封装每个具体实现，如果想要添加，直接再添加一个行为类就行，不会对已经存在的行为类造成影响，提高了水平方向上的可拓展性。
2. 依赖反转: 行为类是通过接口来传递的，能够实现业务逻辑和算法逻辑的解耦。算法层的拓展并不会影响业务层的拓展，提高了垂直方向上的可拓展性。
3. 组合大于继承: 继承就复用的粒度来说，是整个父类。如果将接口组合在类中，代码复用的粒度从父类降到了自定义大小和自定义类型(属性或者行为)，提高了代码复用的灵活性, 能够在开发新类的时候，最大程度的从已有的代码库中汲取养分。当然有个前提，code split得优秀。</div>2020-06-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/32/31/449513a1.jpg" width="30px"><span>CarlXu</span> 👍（3） 💬（0）<div>看第三遍， 每一次都有不一样的的感觉， 感觉所有模式都有基本规律， 对象的创建上使用工厂+查表发， 结构或者行为上定义一个或者多个抽象的接口类，不同的业务和功能去实现统一的接口， 然后进行手动或者自动(反射)匹配。 基于接口编程才是结偶业务的关键。 </div>2022-11-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/70/ac/83bc14c0.jpg" width="30px"><span>面向百度编程</span> 👍（3） 💬（0）<div>将业务层层封装，暴露最少的方法，获得最有用的事物，复杂度从来不能被消除，只能被转移，学到了，我以为用个context类维护策略最好，却没有考虑对于客户端来说不够透明，不够知道最少，然后我只暴露一个类型，既符合迪米特法则，又符合封装，还符合利于扩展维护，将业务封装到类中，进行处理，实在是高，大话设计模式都没您讲的好</div>2020-05-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/86/56/509535da.jpg" width="30px"><span>守拙</span> 👍（3） 💬（0）<div>在什么情况下，我们才有必要去掉代码中的 if-else 或者 switch-case 分支逻辑呢？

根据KISS原则, 默认我们不会主动去优化if-else&#47;switch-case. 
只有当if-else严重影响代码可读性与可维护性, 才考虑使用策略模式+工厂方法模式优化分支逻辑.</div>2020-03-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/ca/c7/00e544c2.jpg" width="30px"><span>黄林晴</span> 👍（3） 💬（0）<div>设计原则和思想比设计模式更加普适和重要，就像掌握算法思想比死扣每种算法的实现更重要！
虽说实践是检验真理的唯一标准，但没有理论何来实践呢</div>2020-03-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/f5/d1/cc6f82eb.jpg" width="30px"><span>kaixiao7</span> 👍（2） 💬（0）<div>在工厂模式那一讲中，配置文件解析的例子也是用了工厂+策略的模式。策略定义是各种Parser，策略创建是工厂类，策略使用是运行时动态确定的方式。那么是不是工厂模式和策略模式（运行时动态确定）经常搭配使用呢？</div>2020-08-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/50/d7/f82ed283.jpg" width="30px"><span>辣么大</span> 👍（2） 💬（1）<div>思考题1：很久没写工程代码，但接触的科研算法对比性能时一般采用策略模式。通过输入不同的参数调用不同的算法。
思考题2：通过策略模式的学习，可以看出实现简单的话一开始是不用使用策略模式的。if else中实现的逻辑都差不多，就是差不多都是干一件事（上节课例子中的购物，本节的文件排序）短的 if else相对易读，代码好理解。使用了策略模式要小心过度设计和影响了代码易读性。（对于不熟悉的项目刚看到或许会懵逼或者不好调试）</div>2020-03-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/82/3d/356fc3d6.jpg" width="30px"><span>忆水寒</span> 👍（2） 💬（0）<div>1、用过策略模式。我们在自研的rpc框架中为了灵活的设置线程数量（类似于netty里面的策略模式，默认情况下线程数量为CPU两倍，也可以指定）。
2、在每个if else里面的代码都有相似功能，可以抽取出来。</div>2020-03-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/15/69/187b9968.jpg" width="30px"><span>南山</span> 👍（2） 💬（0）<div>1:随处可见，比如根据不同的配置选择不同的分配或者负载均衡策略。
2:策略可预期的经常变更或者选择策略的条件判定方式比较复杂时可以考虑不使用if else 方式实现，反过来则if else 没什么毛病</div>2020-03-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/63/6e/6b971571.jpg" width="30px"><span>Z宇锤锤</span> 👍（1） 💬（0）<div>计算器，加减乘除四种方法的策略</div>2021-12-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/77/95/9d32e68c.jpg" width="30px"><span>风絮1994</span> 👍（1） 💬（0）<div>我觉得代码解耦很多时候跟人类分工一样，分工会提高专业化和效率，但也会增加复杂度，要根据项目的规模具体对待</div>2021-10-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/b0/ec/78be126d.jpg" width="30px"><span>迈克糖</span> 👍（1） 💬（0）<div>代码逻辑毕竟是服务于业务，我们要向省掉繁琐的逻辑判断，首选要在源头想想业务逻辑有没有必要这么麻烦。</div>2021-02-05</li><br/>
</ul>