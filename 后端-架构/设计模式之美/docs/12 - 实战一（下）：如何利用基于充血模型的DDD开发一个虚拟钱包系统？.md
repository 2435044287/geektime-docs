上一节课，我们做了一些理论知识的铺垫性讲解，讲到了两种开发模式，基于贫血模型的传统开发模式，以及基于充血模型的DDD开发模式。今天，我们正式进入实战环节，看如何分别用这两种开发模式，设计实现一个钱包系统。

话不多说，让我们正式开始今天的学习吧！

## 钱包业务背景介绍

很多具有支付、购买功能的应用（比如淘宝、滴滴出行、极客时间等）都支持钱包的功能。应用为每个用户开设一个系统内的虚拟钱包账户，支持用户充值、提现、支付、冻结、透支、转赠、查询账户余额、查询交易流水等操作。下图是一张典型的钱包功能界面，你可以直观地感受一下。

![](https://static001.geekbang.org/resource/image/9e/4a/9e91377602ef154eaf866c7e9263a64a.jpg?wh=2023%2A1423)

一般来讲，每个虚拟钱包账户都会对应用户的一个真实的支付账户，有可能是银行卡账户，也有可能是三方支付账户（比如支付宝、微信钱包）。为了方便后续的讲解，我们限定钱包暂时只支持充值、提现、支付、查询余额、查询交易流水这五个核心的功能，其他比如冻结、透支、转赠等不常用的功能，我们暂不考虑。为了让你理解这五个核心功能是如何工作的，接下来，我们来一块儿看下它们的业务实现流程。

### 1.充值

用户通过三方支付渠道，把自己银行卡账户内的钱，充值到虚拟钱包账号中。这整个过程，我们可以分解为三个主要的操作流程：第一个操作是从用户的银行卡账户转账到应用的公共银行卡账户；第二个操作是将用户的充值金额加到虚拟钱包余额上；第三个操作是记录刚刚这笔交易流水。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/13/78/e9/9d807269.jpg" width="30px"><span>miracle</span> 👍（77） 💬（20）<div>建议将完整一些的代码放到 github 上 然后感兴趣的话可以自行去github 上研究或者提 pr</div>2019-11-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/44/57/b0f3eeb5.jpg" width="30px"><span>邹佳敏</span> 👍（28） 💬（18）<div>看了一圈评论，好像没有人和我有同样的疑惑？ 
争哥说了很多交易流水表的设计，明明已经详细介绍了字段冗余的表1要明显优于表2，但为何在虚拟钱包的交易流水表的设计里，使用的又是字段紧凑的表2呢？
那么，在底层虚拟钱包的交易流水表里，同样会存在数据不一致的情况呀？A转出被记录下来了，B转入失败。</div>2019-12-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f7/9d/be04b331.jpg" width="30px"><span>落叶飞逝的恋</span> 👍（12） 💬（9）<div>还有一点，期待老师实现一个完整的案例的代码以供我们参考琢磨。</div>2019-11-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/f8/8b/74d2ab6b.jpg" width="30px"><span>斜杠青年</span> 👍（10） 💬（5）<div>有一个人问题不太懂 数据持久的话 没有set get方法 如何进行持久化？</div>2019-12-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/b8/be/2d77d643.jpg" width="30px"><span>晨间新闻</span> 👍（4） 💬（1）<div>看了下项目代码，service里的方法多数都是获取对象列表，对象入库，删除，很多方法都不是具体某个对象的某个动作，不像余额加减一样，是一个动作，对应某个属性的变化。感觉是不是用不上DDD啊。</div>2019-12-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/73/ce/23bd3997.jpg" width="30px"><span>Wiggins</span> 👍（4） 💬（2）<div>老师你好，看完自己实现的时候有个疑问，每次实例化VirtualWallet时候他的balance都会被初始化为0，我又不想把balance set的方法暴露出来，但是如果Domain不跟Repository层交互的话，就无法获取到当前其中的余额。请问下老师是否只能在构造函数中传入这一种办法？</div>2019-12-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/99/af/d29273e2.jpg" width="30px"><span>饭粒</span> 👍（3） 💬（1）<div>看完这篇对 DDD 也有了初步的认识了，区别了贫血模式的开发，DDD 应用 OOP 的设计实现提高了封装性，在业务对象类 VirtualWallet 中封装数据和基本的数据处理过程，service 使用业务对象类暴露的方法过程以完成完整的功能。实现上业务对象类具备的封装，单一职责等特性，这样在易用，易维护，易扩展，易读等方面较之贫血模型都会有提高。

另外有两个问题请教下老师：
1.贫血模型的 service 中有 VirtualWalletRepository，VirtualWalletTransactionRepository 两个 repository，看字面应该是区分是否带事务，不太明白这样写的好处或用意？因为我现在一般是直接在 service 上直接加事务。
2.钱包交易流水和虚拟钱包的交易流水的功能区分还不是特别清楚，示例代码也没有体现。事物一致性的日子记录不能直接用钱包交易流水线吗？</div>2019-12-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/47/10/2d673601.jpg" width="30px"><span>好饿早知道送外卖了</span> 👍（3） 💬（1）<div>对于前端同学而言、DDD是不是类似于MVVM啊？只是没有数据绑定的业务映射</div>2019-12-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/97/81/c457def1.jpg" width="30px"><span>鹤涵</span> 👍（1） 💬（1）<div>我有一个问题 ，我的系统太简单了，如果定义这么多bo vo全部精力都用在数据转换上了 。工期又特别赶 怎么办？一般我都是只有一个实体类，把复用的逻辑放在实体类中，可以怎么优化一下呢？请教老师</div>2020-08-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/03/15/293a185d.jpg" width="30px"><span>JRich</span> 👍（0） 💬（1）<div>老师，上一节不是说业务模型是BO吗，怎么这里又叫domain呢，我们实际开发过程中数据库对象（entity）叫domain，这个该怎么区分呢？</div>2020-11-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/f0/36/020428c7.jpg" width="30px"><span>Dana</span> 👍（0） 💬（1）<div>老师里面的代码 不怎么看得懂 没学过 java </div>2020-11-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/06/24/c2ee3b16.jpg" width="30px"><span>owen</span> 👍（0） 💬（2）<div>是不是可以理解为，orm的实体类加上业务逻辑判断，Service层只负责和Dao 层交互</div>2020-08-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/70/9f/741cd6a4.jpg" width="30px"><span>Henry</span> 👍（0） 💬（1）<div>transfer操作try catch里的操作跑出异常会导致整个事务回滚，并不会记录交易记录；应该在另一个service组合debit 和credit 操作并用将事务Propagation设为REQUIRES_NEW才能保证原子性；。。。虽然这并不是这堂客的重点；</div>2020-06-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/83/c8/5ce842f6.jpg" width="30px"><span>maybe</span> 👍（0） 💬（1）<div>之前对领域模型有重大误解，把他做成了类似repository。现在的理解应该是domain是service层中抽取出来的一些职责单一的点，数据与行为一体的充血领域类。看到阿里编程规范里面的manager层应该就是领域模型层了，controller、service 、manager、dao。不知道我现在的理解是否对了，希望老师指点迷津</div>2020-06-12</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoV9IsMsiawicpaaTXqhPzqH2mA5HUKUSyJ5fbUhoqTKhNRxJ5dibhs5bkTqCSqcuolZT7sam2sn8sBA/132" width="30px"><span>MadleS_F</span> 👍（0） 💬（1）<div>老师:
domain 没有 get set方法，如何将entity convert成domain呢？</div>2020-05-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/c7/f5/108cd83b.jpg" width="30px"><span>程序员半支烟</span> 👍（0） 💬（2）<div>老师，咨询个问题：
1、如果用了domain，那还需要用BO吗？
2、domian对象适合直接在service层返回吗？还是说要把domain转换成BO，在返回？</div>2020-01-23</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/GbZRicqbu1QJmlcOlfLyW4ican8ZVzrSZ2FRA7EygB8WAdDnoQwR6L4ldNzX3myAd4wYOuGYPguaLAccpQMWIpUg/132" width="30px"><span>Geek_d25b8d</span> 👍（0） 💬（1）<div>争哥，领域对象需要抽象出接口吗</div>2020-01-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c7/83/ca76b4f3.jpg" width="30px"><span>移动一下</span> 👍（0） 💬（1）<div>在给两个钱包加减金额的过程中，如果有任意一个操作失败，我们就将交易记录的状态标记为“失败”。这个时候是马上对其中一个成功操作做回滚，还是在后台补漏 Job中再处理好一些？</div>2020-01-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/85/a3/7e078442.jpg" width="30px"><span>东流</span> 👍（0） 💬（1）<div>service里面的getbalnce中virtualwalletRepo是不是写错了，应该还是walletRepo</div>2020-01-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/56/7a/382538dc.jpg" width="30px"><span>Elective9095</span> 👍（0） 💬（2）<div>看了这篇文章，有个问题，web开发如果采用领域设计模型，那么一些关键的逻辑会在domain中，service层调用domain的逻辑，请求过来，都要创建domain对象，关键逻辑的频繁调用，导致domain对象频繁创建，而如果把逻辑放到service中，由于是spring去管理的service，是单例的，不用频繁创建，而且service中没有成员变量，也不用考虑线程安全问题，所以，从这个角度来讲，贫血模式，要比充血模式好？</div>2020-01-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/f7/29/60e01017.jpg" width="30px"><span>wai</span> 👍（0） 💬（1）<div>针对第一个辩证讨论的问题，老师说出的三条观点中的第二条 让领域模型更加可复用，能理解成一个Domain可能对应多个Service？那Domain的命名是不是得抽象一些？</div>2020-01-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/db/c3/e11adfe8.jpg" width="30px"><span>hunter</span> 👍（0） 💬（2）<div>感觉你对DDD了解的不深</div>2019-12-31</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/BIRpwViaN51yynIeFonD7QRlwDCVtKibrG956NTxzEqibOZZVjhMMgibOPmd3VicfYxpknZsic1oJq8KicZvXkmmiajuQg/132" width="30px"><span>tuyu</span> 👍（0） 💬（1）<div>老师, 以前写算法, 程序都是如果不符合条件都会返回null, 是不是写业务逻辑, 如果不符合调节抛出异常比较好, 能不能简单介绍一下</div>2019-12-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/68/fe/1353168d.jpg" width="30px"><span>岁月</span> 👍（0） 💬（1）<div>有个问题没看明白, 事务一致性问题, 如果写入一条流水表示转账等待执行, 那么开始加减余额的时候, 如果加成功,减失败, 那不还是一样需要重新去把加的操作恢复吗? 恢复的过程又可能出错了, 所以没有原子操作的话这个做不了呀? </div>2019-12-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/3e/07/c27b53b8.jpg" width="30px"><span>Geek_ecf7bb</span> 👍（0） 💬（1）<div>有些理解充血的模式，不过还是希望能尽快看到老师更加完整的示例代码，期待老师的Github更新，谢谢老师~</div>2019-12-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/7a/3c/87e015f8.jpg" width="30px"><span>堵车</span> 👍（0） 💬（1）<div>业务复杂后，domain很大。怎么处理比较好？</div>2019-12-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/58/95/640b6465.jpg" width="30px"><span>fmouse</span> 👍（0） 💬（0）<div>这两节课中提出的一些问题，我们在讨论DDD的时候遇到了同样的问题。如果涉及到多领域的业务，放在service层，Controller层只暴露接口不做业务吗。还有业务比较复杂的时候，service层会过于臃肿庞大。业务关系比较复杂的情况下，如何来划分界限，或者说是领域。</div>2019-12-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/91/e6/03582dee.jpg" width="30px"><span>牧名</span> 👍（0） 💬（1）<div>虽然这节课的重点不是讲转帐功能，但转帐的交易流水设计存在一个问题：比如转帐失败后，单从交易流水记录上看只知道转账失败了，却不知道到底是出帐钱包扣款失败还是入帐钱包收款失败。</div>2019-12-03</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIOTLJaib1IWwr6MEZvrzmgaCnrhSLxibDzcqBx5JlQ9yVva1KicSpGW784HC6L2lm6SIBk6Dm9vAp3w/132" width="30px"><span>Geek_ncjrh5</span> 👍（0） 💬（2）<div>有点疑问，如果虚拟钱包系统只关注加减的话，日志不还是两条，如何保证一致性？</div>2019-12-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/5a/5e/a897cb0d.jpg" width="30px"><span>grey927</span> 👍（0） 💬（1）<div>如果是简单的增删改查附加一点点判断逻辑的操作，是不是不太适合用充血模型</div>2019-12-02</li><br/>
</ul>