上一节课中，我们讲了积分系统的需求分析和系统设计。今天，我们来讲它的代码实现。

上一节课中，我们把积分赚取和消费的渠道和规则的管理维护工作，划分到了上层系统中，所以，积分系统的功能变得非常简单。相应地，代码实现也比较简单。如果你有一定的项目开发经验，那实现这样一个系统，对你来说并不是件难事。

所以，我们今天讲解的重点，并不是教你如何来实现积分系统的每个功能、每个接口，更不是教你如何编写SQL语句来增删改查数据，而是给你展示一些更普适的开发思想。比如，为什么要分MVC三层来开发？为什么要针对每层定义不同的数据对象？最后，我还会总结这其中都蕴含哪些设计原则和思想，让你知其然知其所以然，做到真正地透彻理解。

话不多说，让我们正式开始今天的学习吧！

## 业务开发包括哪些工作？

实际上，我们平时做业务系统的设计与开发，无外乎有这样三方面的工作要做：接口设计、数据库设计和业务模型设计（也就是业务逻辑）。

数据库和接口的设计非常重要，一旦设计好并投入使用之后，这两部分都不能轻易改动。改动数据库表结构，需要涉及数据的迁移和适配；改动接口，需要推动接口的使用者作相应的代码修改。这两种情况，即便是微小的改动，执行起来都会非常麻烦。因此，我们在设计接口和数据库的时候，一定要多花点心思和时间，切不可过于随意。相反，业务逻辑代码侧重内部实现，不涉及被外部依赖的接口，也不包含持久化的数据，所以对改动的容忍性更大。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/97/b7/d5a83264.jpg" width="30px"><span>李朝辉</span> 👍（82） 💬（2）<div>课堂讨论1:
业务驱动的系统还是应该从业务的角度出发去做设计，这两个字段在积分明细查询中是不可或缺的，所以我认为是合理的。既然是不可或缺的，如果不记录在这张表中，就要记录在其他表中，或者查询不便，或者破坏内聚。
2.根据个人经验，insert操作的都是返回记录id，原因的个人观点是为调用方提供便利。还请老师解答</div>2019-12-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/45/2f/b0b0dd74.jpg" width="30px"><span>杨杰</span> 👍（42） 💬（4）<div>个人感觉：VO、BO、Entity 通过组合关系来复用这个类的代码不是特别好，尤其是VO。因为用组合的方式会增加返回数据的层次，这对前端来说是不是不不太友好？</div>2019-12-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/50/d7/f82ed283.jpg" width="30px"><span>辣么大</span> 👍（37） 💬（7）<div>反馈一个文章朗读的小问题：音频3:00左右 facade设计模式 应该读做&#47;fə&#39;sɑ:d&#47; ，冯老师读的不是很准确。 ”吹毛求疵“，希望专栏做的更专业。</div>2019-12-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/56/c6/0b449bc6.jpg" width="30px"><span>斐波那契</span> 👍（24） 💬（12）<div>老师 beanutils会不会性能不好 毕竟大量用到了反射 有没有代码不那么繁琐性能也比较好的方法</div>2019-12-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/ca/c7/00e544c2.jpg" width="30px"><span>黄林晴</span> 👍（17） 💬（6）<div>打卡✔
难道是我膨胀了，实战的内容没有理论看的起劲</div>2019-12-27</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLIuRQaZX70dsBg6khub2VPM1eQAP9IWRWxgOFed3ia4kXyNJInFRicWJ0ibf2YmLsOvJa1sGygGpmJg/132" width="30px"><span>胖子</span> 👍（10） 💬（1）<div>我有一个疑问：接口设计、数据库设计和业务模型设计如何对应或过渡到MVC分层？</div>2019-12-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e9/e9/1f95e422.jpg" width="30px"><span>杨陆伟</span> 👍（7） 💬（8）<div>VO、BO、Entity频繁的克隆、拷贝会不会引入性能问题，这点是怎么考虑的？谢谢</div>2020-01-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4f/13/5197f8d2.jpg" width="30px"><span>永旭</span> 👍（5） 💬（2）<div>3层架构 和 MVC 不是 2中概念吗 ? 
3层架构: 表示层, 业务层 , 数据访问层
MVC: model , view , controller 
3层架构.表示层 = MVC.controller  + MVC.view  ?? </div>2020-07-10</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/rMgAbbKiasa1qR35ht0GEfwsHXbusPZAe9JFgicDgVRy8vQET2hypuDgwtHoPVU23RUoMdK7qA7gibMlTExpYibtbw/132" width="30px"><span>YsnowLove</span> 👍（5） 💬（1）<div>这篇文章是实战篇，为啥没有说明积分余额的设计，作为一个用户，首先关心的是积分余额吧。不可能每次看积分余额都要查询所以积分明细，然后计算一遍。</div>2020-06-22</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKY0SBAOch2S7wadCRFKTT5fBtXCvsa46svoTj2MWoQ9YRrujZuq4wEHjS9dCEzPcrWHNSYgUkNVw/0" width="30px"><span>林</span> 👍（4） 💬（1）<div>为什么积分明细表没有user_id字段，如何查询用户的可用积分</div>2020-01-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/ca/82/85f6a1a2.jpg" width="30px"><span>番茄炒西红柿</span> 👍（3） 💬（1）<div>想问一个问题关于设计业务逻辑的参数校验放在那里合适，我现在都放在controller里面和非业务的参数校验放在一起，因为这种校验一般都返回错误码，错误码感觉和service的关系不大。不过其实感觉放在service也合适，老师的看法是怎么样的？</div>2020-01-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/df/1e/cea897e8.jpg" width="30px"><span>传说中的成大大</span> 👍（2） 💬（1）<div>1. 是合理的 因为虽然数据库设计包含了上层的数据，但是绝大多数都是用来进行存数据库，存记录方便以后的维护和查询，比如像游戏开发 在数据库模块中总会设计到玩家角色id啊 名字啊等等 所以我觉得是合理的
2. 并没有违背单一职责原则，因为修改或者查询的接口里面做的事情是很单一的，返回一个id，还便于去查询验证</div>2020-01-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/de/17/8c819cd7.jpg" width="30px"><span>骆永良</span> 👍（1） 💬（1）<div>目的：提高开发、维护效率。第一层原则：易维护、易扩展，第二层原则：高内聚、低耦合。第一层方法：SOLID原则。第二层方法：各种设计模式（经验）</div>2020-11-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/17/cc/e33bef77.jpg" width="30px"><span>春山</span> 👍（1） 💬（1）<div>三层架构和MVC不能说是一个东西吧，MVC更多关注的是前端。</div>2020-11-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4f/13/5197f8d2.jpg" width="30px"><span>永旭</span> 👍（1） 💬（1）<div>请问 VO 里不包含 密码, 那用户注册时 从前端获取的VO对象 转换成后端VO对象时 密码不会丢失吗 ??</div>2020-07-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/e8/e2/2bcaef68.jpg" width="30px"><span>王瑞强</span> 👍（1） 💬（1）<div>积分明细表里面是不是需要记录一下积分兑换，扣除积分的规则id</div>2020-06-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/36/ce/5c958ff9.jpg" width="30px"><span>Just do it</span> 👍（1） 💬（4）<div>消费积分接口的参数中是不是可以不需要积分过去时间？</div>2020-01-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0f/40/e838871e.jpg" width="30px"><span>zk_207</span> 👍（1） 💬（2）<div>争哥，
Vo和Bo应该分别放到Controller层、service层呢，还是统一放到domain层呢？</div>2019-12-30</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIang00R9vkklnkFCLhzRysNfocr0sLnCdoZwOT3UkulAPefk5BDvd0PfIeQSODSQg1DjKWUmJOaA/132" width="30px"><span>陈迎春</span> 👍（1） 💬（3）<div>各位大佬好，我主要是做嵌入式软件开发的，平常设计模式用的不多，所以相对差一些，最近的两偏实战，我听了好几遍，但还是云里雾里，可否给出一些实际的代码？结合代码理解，可能会更好些</div>2019-12-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/5b/ef/ab462610.jpg" width="30px"><span>thinkmore</span> 👍（0） 💬（1）<div>从下层往上层传递需要转换，那么上层往下层传递也用同样的转换吗？</div>2020-05-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/97/0b/a943bcb3.jpg" width="30px"><span>zhou</span> 👍（0） 💬（1）<div>表中的event_id是否应该还要有个类型 不同的表如果用自增是否会通过event_id无法区分</div>2020-05-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/0a/63/165b0d40.jpg" width="30px"><span>少年锦时</span> 👍（0） 💬（2）<div>如果Repository 层不写接口直接写一个实现类，Service直接使用该实现类。
这个实现类内部逻辑有改动（入参和返回值不变），Service也不会受到影响呀。
请问，这种情况为什么还要定义接口呢</div>2020-05-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/0a/dd/88fa7b52.jpg" width="30px"><span>Geek_41d472</span> 👍（0） 💬（1）<div>为何感觉理论看的很明白，反而实战看的有点一脸懵逼了</div>2020-01-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/56/cd/0add8290.jpg" width="30px"><span>刘学习来学习</span> 👍（0） 💬（1）<div>service层接口设计时有必要对每个模型拆分为读写两个接口么</div>2020-01-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/69/b5/1e1731cc.jpg" width="30px"><span>zs阿帅</span> 👍（0） 💬（3）<div>如果是创建或者是更新需要传入的Object叫什么呢？ RequestO&#47;UpdateO吗</div>2020-01-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7e/d8/92a98fb6.jpg" width="30px"><span>逍遥思</span> 👍（0） 💬（2）<div>如果是涉及到数据持久化的客户端，有一定的复杂度，是否有必要分三层呢？</div>2019-12-29</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI2icbib62icXtibTkThtyRksbuJLoTLMts7zook2S30MiaBtbz0f5JskwYicwqXkhpYfvCpuYkcvPTibEaQ/132" width="30px"><span>xuanyuan</span> 👍（0） 💬（1）<div>如果要加缓存呢？如何对数据入库前要做加解密呢？是不是在service和repostory层之间加一个代理层，这样方便在入库前做一些处理。而这些不需要也不应该在service层做</div>2019-12-29</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ5ib2OMvRrnG4bPzCTE28Ryvc0VpatV0rAoja1C6ymon0mgZPCQwFOda8ickd9Ghmk5Ik5ia57G2z3Q/132" width="30px"><span>Geek_cb0c9c</span> 👍（0） 💬（1）<div>是不是除了entity到bo，bo到vo的转换，还有vo到bo，bo到entity的转换？比如在做商品新增的时候，我经常在controller中用商品类对象作为参数映射前端的表单数据，然后service和repository中同样用对象参数去操作，大家在做类似的功能的时候是怎么处理的呢？</div>2019-12-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/2e/15/f1cd59c9.jpg" width="30px"><span>东风吹梦丶易散</span> 👍（0） 💬（2）<div>请问下老师多表联合查询时Repository返回的对象应该定义为什么</div>2019-12-28</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJcxSpNMqwqyicMvdOSr9ic0p1ABiauHnv7g7YQVSJuoHPoQbYDu3YzdpgmSAk2KricUBQ5yibWBWIq75w/132" width="30px"><span>桂城老托尼</span> 👍（205） 💬（13）<div>感谢争哥分享。
个人觉得积分系统只有流水记录不太够，设想下消费积分场景，要完成扣积分的动作，没有积分余额表容易造成多扣，特别是针对羊毛党。当然上层系统，比如活动系统也可以做好幂等。
尝试回答下课后讨论
1. 保留上层应用id和channel完全符合设计原理，冗余业务信息方便日后做数据统计，沉淀数据资产反推营销策略迭代; 一次消费或赚取积分行为可能存在多次调用情况，方便幂等，不至于多次记账;方便业务系统查询某次赚取或消费的积分明细;暂时想到这么多。
2. 尽量不要返回void或boolean，有些业务需要反向关键积分流水id做单笔流水查询。
其实这两个讨论都类似于现实生活，去便利店买东西会给你小票，支付宝扫码付款会返回交易流水。都是为了方便真是场景解决“纠纷”(查询)用的。</div>2019-12-27</li><br/>
</ul>