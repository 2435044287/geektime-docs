上一节课，我们介绍了灰度组件的一个需求场景，将公共服务平台的RPC接口，灰度替换为新的RESTful接口，通过灰度逐步放量，支持快速回滚等手段，来规避代码质量问题带来的不确定性风险。

跟前面两个框架类似，灰度组件的功能性需求也比较简单。上一节课我们做了简单分析，今天我们再介绍一下，这个组件的非功能性需求，以及如何通过合理的设计来满足这些非功能性需求。

话不多说，让我们正式开始今天的学习吧！

## 非功能性需求

上一节课中，我给你留了一个作业，参照限流框架，分析一下灰度组件的非功能性需求。对于限流框架，我们主要从易用性、扩展性、灵活性、性能、容错性这几个方面，来分析它的非功能性需求。对于灰度组件，我们同样也从这几个方面来分析。

### 易用性

在前面讲到限流框架和幂等框架的时候，我们都提到了“低侵入松耦合”的设计思想。因为框架需要集成到业务系统中使用，我们希望它尽可能低侵入，与业务代码松耦合，替换、移除起来更容易些。因为接口的限流和幂等跟具体的业务是无关的，我们可以把限流和幂等相关的逻辑，跟业务代码解耦，统一放到公共的地方来处理（比如Spring AOP切面中）。

但是，对于灰度来说，我们实现的灰度功能是代码级别的细粒度的灰度，而替代掉原来的if-else逻辑，是针对一个业务一个业务来做的，跟业务强相关，要做到跟业务代码完全解耦，是不现实的。所以，在侵入性这一点上，灰度组件只能做妥协，容忍一定程度的侵入。
<div><strong>精选留言（11）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/24/2a/33441e2b.jpg" width="30px"><span>汝林外史</span> 👍（5） 💬（4）<div>发布之前进行充分的测试不就行了吗？灰度测试是针对什么场景呢？</div>2020-07-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg" width="30px"><span>Jxin</span> 👍（30） 💬（0）<div>1.这要看系统运行日志属不属于业务逻辑的一部分。我认为是属于的。毕竟我要的是可追溯的业务代码，而不是只有功能的业务代码。可追溯我认为是业务的一部分。同理还包括主动告警。

2.所以我认为算不上侵入。至于耦合，log的实现层是可以替换的，所以也没有耦合。</div>2020-06-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/f7/eb/e7127bb8.jpg" width="30px"><span>，</span> 👍（21） 💬（0）<div>我在工作的过程中,遇到的常规业务方法大概是这样的:
1.权限校验,权限合法才能继续往下走,不合法就抛异常
2.参数校验,参数合法才能继续往下走,不合法就抛异常
3.业务处理,处理成功才能继续往下走,不成功就抛异常
4.业务附加处理(例如短信通知,记录业务日志),处理完成返回,失败则在第三方打印异常,这个部分一般不会出现异常

       如果再加上课里面讲到的幂等框架,限流框架等,想要做到零侵入,低耦合,个人感觉并不现实,应该看项目的具体安排,如果时间紧任务重,以服务调用的方式也未尝不可,也就一行代码的事,侵入性并没有想象中的那么夸张,如果时间宽裕,做一个漂亮的切面,也是不错的
       课后题:
        打印日志算不算对业务代码的侵入,个人认为完全看对&quot;业务代码&quot;范围的定义。比如一次保存稿件的功能,有的人认为只有 save(docuemnt) 这一步才算业务,其他都属于附加功能,但有的人认为权限校验,参数校验,业务处理,业务附加处理全部加起来才算一个完整的业务流程,这时,关键性的业务日志打印&#47;存储其实也属于业务范围内的事情了,权限校验和参数校验也一样。我还是倾向于认为第二种更接近&quot;业务代码&quot;范围的定义。
    简而言之,我的观点是 日志打印&#47;存储如果是为了debug,那么则不属于业务范围内,对代码有一定侵入性,如果是为了留档,方便以后的核对等工作,那么则属于业务范围内的事情,对代码没有侵入性。</div>2020-06-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/6b/27/8c964e52.jpg" width="30px"><span>不惑ing</span> 👍（4） 💬（0）<div>低侵入松耦合，不是不侵入不耦合，所以Logger符合</div>2020-07-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/86/56/509535da.jpg" width="30px"><span>守拙</span> 👍（4） 💬（0）<div>Logger框架是否符合&quot;低侵入, 松耦合&quot;要根据Logger框架的提供的功能来判定.

例如Logger框架提供全局配置的开关功能, 就体现了一定程度的低侵入. 因为不需要Log时全局关闭对业务没有丝毫影响. 

Logger框架是否做了足够的封装, 适用于多种场景: 本地log, log上传至Server, log写入db&#47;文件系统;
是否支持多种格式的log: 纯文本, json格式, xml格式等是衡量Log易用性, 灵活性, 可扩展性的量化指标.

总结: 项目只要使用Log框架, 就无法避免耦合的情况. 既然Log对于项目是必须的, 我们就应该综合参考Log框架是否低侵入松耦合, 易用性, 扩展性, 性能, 可复用性等指标, 以量化的方式做框架的选型.

</div>2020-07-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/d9/ff/b23018a6.jpg" width="30px"><span>Heaven</span> 👍（4） 💬（0）<div>从耦合的角度来看,是在业务代码之中打印的,这是和业务代码耦合在了一起,但是和业务无关,需要删去的时候,不需要修改业务代码,只移除非业务代码,我的角度来看,是不属于对于业务代码的侵入耦合的</div>2020-06-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/43/79/18073134.jpg" width="30px"><span>test</span> 👍（4） 💬（0）<div>Logger需要用户控制打什么日志，在哪里打，算是牺牲了一定耦合度</div>2020-06-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/47/31/f35367c8.jpg" width="30px"><span>小晏子</span> 👍（3） 💬（0）<div>如果使用的是log4j，logback等这种基于实现类编程的框架，那么是有侵入，有耦合性的。
如果使用的是slf4j这种日志接口框架，那么多业务代码是无侵入的，低耦合的，因为底层具体实现的log框架可以无缝替换为另外一个。</div>2020-06-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/e3/85/b52a34ea.jpg" width="30px"><span>只为更好</span> 👍（1） 💬（0）<div>老师，业务逻辑的灰度如何去做？如果业务代码写很多开关，也会降低代码的可维护性、可读性等，另外数据模型的调整，比如字段修改、删除如何做灰度呢</div>2021-09-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/f6/7b/b6abcbbe.jpg" width="30px"><span>否极泰来</span> 👍（1） 💬（0）<div>不算，因为我们需要查看日志定位问题，我觉得是属于业务的一部分。</div>2021-04-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/86/52/b92dc111.jpg" width="30px"><span>Tobias</span> 👍（1） 💬（0）<div>在开发业务需求的场景下，日志是对业务代码的入侵，但是这种入侵不大，对于开发者使用日志框架来说，可以获得细颗粒度的日志操作，很大的灵活性，并且日志框架默认是异步输出日志，降低了性能损耗。综合上述，这种入侵带来的收益要大于入侵带来的代码耦合造成的问题。</div>2020-08-04</li><br/>
</ul>