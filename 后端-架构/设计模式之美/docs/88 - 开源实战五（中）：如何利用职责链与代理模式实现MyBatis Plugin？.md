上节课，我们对MyBatis框架做了简单的背景介绍，并且通过对比各种ORM框架，学习了代码的易用性、性能、灵活性之间的关系。一般来讲，框架提供的高级功能越多，那性能损耗就会越大；框架用起来越简单，提供越简化的使用方式，那灵活性也就越低。

接下来的两节课，我们再学习一下MyBatis用到一些经典设计模式。其中，今天，我们主要讲解MyBatis Plugin。尽管名字叫Plugin（插件），但它实际上跟之前讲到的Servlet Filter（过滤器）、Spring Interceptor（拦截器）类似，设计的初衷都是为了框架的扩展性，用到的主要设计模式都是职责链模式。

不过，相对于Servlet Filter和Spring Interceptor，MyBatis Plugin中职责链模式的代码实现稍微有点复杂。它是借助动态代理模式来实现的职责链。今天我就带你看下，如何利用这两个模式实现MyBatis Plugin。

话不多说，让我们正式开始今天的学习吧！

## MyBatis Plugin功能介绍

实际上，MyBatis Plugin跟Servlet Filter、Spring Interceptor的功能是类似的，都是在不需要修改原有流程代码的情况下，拦截某些方法调用，在拦截的方法调用的前后，执行一些额外的代码逻辑。它们的唯一区别在于拦截的位置是不同的。Servlet Filter主要拦截Servlet请求，Spring Interceptor主要拦截Spring管理的Bean方法（比如Controller类的方法等），而MyBatis Plugin主要拦截的是MyBatis在执行SQL的过程中涉及的一些方法。
<div><strong>精选留言（23）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/43/79/18073134.jpg" width="30px"><span>test</span> 👍（36） 💬（0）<div>思考题：因为用mybatis就是为了使用数据库。</div>2020-05-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/16/5b/83a35681.jpg" width="30px"><span>Monday</span> 👍（31） 💬（0）<div>精彩，看了源码，Mybatis分布工具PageHelper也通过Plugin方式实现的。
@Intercepts({@Signature(
    type = Executor.class,
    method = &quot;query&quot;,
    args = {MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class}
)})
public class PageHelper implements Interceptor {...}</div>2020-05-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/3d/38/6f02a4b9.jpg" width="30px"><span>your problem？</span> 👍（20） 💬（0）<div>思考题：YAGNI，单一职责原则，MyBatis就是负责简化以及通用数据库的处理，没有必要支持过多无关的东西</div>2020-05-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/47/31/f35367c8.jpg" width="30px"><span>小晏子</span> 👍（11） 💬（0）<div>我感觉这要从mybatis的使用场景考虑，mybatis主要用于简化数据库操作，所以对于SQL语句的解析才是其本质，而不需要额外支持其他的东西，所以不需要拦截用户自定义类的方法</div>2020-05-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/64/9b/d1ab239e.jpg" width="30px"><span>J.Smile</span> 👍（10） 💬（0）<div>Springaop中的前置通知，后置通知，异常通知也是基于动态代理的职责链模式。</div>2020-05-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/76/66/cbd6013c.jpg" width="30px"><span>Lambor</span> 👍（7） 💬（2）<div>MyBatis 每次SQL执行都会创建 Executor 等对象，再通过 pluginAll 方法创建一个代理的职责链，然后递归调用每个代理对象，最后调用 Executor 对象的方法。个人认为这个代理职责链主要就是控制 Executor 的方法在最后一步执行，这种职责链+代理的实现方式虽然巧妙，但感觉得不偿失，每次SQL调用都会创建一个新的嵌套代理调用链，这本身就是有性能消耗的，而且是作为底层框架，这点性能还是要考虑的。感觉采用 ApplicationFilterChain 的那种方式会更好，固定的一个拦截器链路，不用每次创建代理。</div>2020-05-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/16/5b/83a35681.jpg" width="30px"><span>Monday</span> 👍（4） 💬（1）<div>看第一篇以为听懂了，再第二篇，发现根本没懂。如果换成是我要实现sql耗时的操作，走两步就行
1、写一个切面拦截StatementHander的某些方法，在执行sql前后加开始结束时间就行。
2、上一点中拦截哪些方法，还是需要一个类似Plugin中的getSignatureMap方法的解析，没感觉到Plugin类其他的价值。。</div>2020-05-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/25/56/86/db4c0d1c.jpg" width="30px"><span>ljx</span> 👍（3） 💬（0）<div>感觉自己变强了，一年前看这段源码觉得云里雾里，只能理解个大概，如今再看是如此清晰。。。</div>2022-03-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/27/e3/3e/f22c2bad.jpg" width="30px"><span>高乐</span> 👍（3） 💬（0）<div>请问老师，动态代理后的代理类是final的吧，应该无法再次被动态代理吧？那这个嵌套代理是怎么实现的？</div>2021-11-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/d9/ff/b23018a6.jpg" width="30px"><span>Heaven</span> 👍（3） 💬（0）<div>职责单一,我用Mybatis就是为了更快更好的处理数据库之间的关系,所以专注于这四类是必然的,之前咱自己也看过Mybatis源码,但是并没有看出来是利用代理和职责链实现的整体执行过程</div>2020-05-26</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/eLNeJNaEkwGSK7xvtamMibVLMy2MpbIqX3iaEhT7JtSnTRMRTwZ2j4HX7WAapiashbiaBDVriaXKSP0Oeic6ZAEVEXag/132" width="30px"><span>M</span> 👍（2） 💬（0）<div>pluginAll()方法的设计，有点像观察者模式，所有的观察者注册到被观察者中，被观察者必须等到所有的观察者执行完之后才能够执行</div>2021-04-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/d7/e2/5e5cc8f3.jpg" width="30px"><span>Molyt</span> 👍（1） 💬（0）<div>这一节课更看不懂了，难顶（捂脸哭.jpg）</div>2022-04-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7d/95/dd73022c.jpg" width="30px"><span>我是曾经那个少年</span> 👍（1） 💬（0）<div>数据库的执行前我们一般能做的就是：
1. 对数据库参数字段的一些处理，。
2. 对数据库响应结果的一些处理。
3. 或者动态概要SQL语句。
数据库ORM组件也就是处理这些东西，没有其他的业务扩展的需要。</div>2021-12-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/70/9f/741cd6a4.jpg" width="30px"><span>Henry</span> 👍（1） 💬（0）<div>mybatis的拦截的范围粒度比较大，针对的是特定类型的sql查询及参数和返回结果处理。拦截用户自定义的方法可以通过spring aop进行更细粒度的方法拦截。</div>2020-11-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/be/e6/7808520d.jpg" width="30px"><span>Edward Lee</span> 👍（1） 💬（0）<div>Mybatis 需要更专注于数据库操作方面的代理，而更具体的方法代理可以交由 Spring 这类 AOP 框架配置实现，Mybatis 就不必再重复造轮子了。

对于 Mybatis 以动态代理的方式实现拦截器感觉到新颖，看似使用动态代理会影响效率，实则是提升了执行效率。这是因为只有在系统启动的时候会慢一些，在实际执行的过程中就不需要额外的匹配及判断过滤规则了，当然，动态代理还需要额外的内存开销。</div>2020-06-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/85/49/585c69c4.jpg" width="30px"><span>皮特尔</span> 👍（1） 💬（0）<div>MyBatis的使用场景仅限于数据库，所以只需要拦截数据库操作相关的四个类就可以了，没有拦截用户自定义类的必要。这也符合设计原则里的“单一职责”</div>2020-06-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/3a/44/19/791d0f5e.jpg" width="30px"><span>燕姿</span> 👍（0） 💬（0）<div>这篇可以。优点干货。</div>2024-04-17</li><br/><li><img src="" width="30px"><span>Geek_f73a3e</span> 👍（0） 💬（0）<div>不需要，用框架拦截应该也可以实现吧，粒度太大，不够精细</div>2023-08-12</li><br/><li><img src="" width="30px"><span>InfoQ_9b27327d1940</span> 👍（0） 💬（0）<div>老师，您好，在文章的最后部分“就这样，一层一层地把代理对象上的 intercept() 函数执行完之后，MyBatis 才最终执行那 4 个原始类对象上的方法。”
这里应该是在intercept()函数内执行的4个原始类对象上的方法吧</div>2023-05-18</li><br/><li><img src="" width="30px"><span>Geek_7e0e83</span> 👍（0） 💬（0）<div>我觉得是mybatis 框架和spring相比会比较特殊。mybatis框架底层服务的是MYSQL数据库，和数据库相关的非功能性需求会比较集中 语句本身、执行过程、参数、结果集等等。而spring则是服务于系统开发人员的框架，内部需要提供很多扩展给到系统开发人员，保留自由和灵活性。

</div>2022-11-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/e3/d8/6462cfdb.jpg" width="30px"><span>Edison</span> 👍（0） 💬（0）<div>学习了，这部分得看好久</div>2021-06-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/55/bc/fad0090b.jpg" width="30px"><span>Yeyw</span> 👍（0） 💬（0）<div>职责单一，每个框架都做自己领域的事</div>2021-04-21</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLlxr0eX6ZPlpiaUkH8SXoNibmOK9MJz2ZDYq5y57UfFHBu6dDc5VxKic1rAPiawLBVdSMl8y1Mwtp9Yg/132" width="30px"><span>Bern</span> 👍（0） 💬（0）<div>是不是因为mybatis的版本问题，有些方法和入参是不一样的</div>2020-05-28</li><br/>
</ul>