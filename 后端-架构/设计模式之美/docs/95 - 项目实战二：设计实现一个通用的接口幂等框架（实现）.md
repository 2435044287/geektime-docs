上一节课，我们讲解了幂等框架的设计思路。在正常情况下，幂等框架的处理流程是比较简单的。调用方生成幂等号，传递给实现方，实现方记录幂等号或者用幂等号判重。但是，幂等框架要处理的异常情况很多，这也是设计的复杂之处和难点之处。比如，代码运行异常、业务系统宕机、幂等框架异常。

虽然幂等框架要处理的异常很多，但考虑到开发成本以及简单易用性，我们对某些异常的处理在工程上做了妥协，交由业务系统或者人工介入处理。这样就大大简化了幂等框架开发的复杂度和难度。

今天，我们针对幂等框架的设计思路，讲解如何编码实现。跟限流框架的讲解相同，对于幂等框架，我们也会还原它的整个开发过程，从V1版本需求、最小原型代码讲起，然后讲解如何review代码发现问题、重构代码解决问题，最终得到一份易读、易扩展、易维护、灵活、可测试的高质量代码实现。

话不多说，让我们正式开始今天的学习吧！

## V1版本功能需求

上一节课给出的设计思路比较零散，重点还是在讲设计的缘由，为什么要这么设计。今天，我们再重新整理一下，经过上一节课的分析梳理最终得到的设计思路。虽然上一节课的分析很复杂、很烧脑，但思从深而行从简，最终得到的幂等框架的设计思路是很简单的，主要包含下面这样两个主要的功能开发点：
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/01/37/12e4c9c9.jpg" width="30px"><span>高源</span> 👍（12） 💬（3）<div>老师讲的真的好后期老师把所讲课程配套代码提供上，我对着再仔细阅读一次结合实际应用到实际开发中，谢谢</div>2020-06-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/12/ce/a8c8b5e8.jpg" width="30px"><span>Jason</span> 👍（9） 💬（1）<div>RedisClusterIdempotenceStorage是不是少implements IdempotenceStorage？</div>2020-06-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/48/f3/65c7e3ef.jpg" width="30px"><span>cricket1981</span> 👍（3） 💬（1）<div>有一点不明白，框架为什么要对外提供delete接口呢？调用方乱用怎么办？如果是为了处理系统异常，我觉得可以让调用方重新生成新的幂等号再发起请求，而不是依赖调用方在重试之前正确地调用delete接口。</div>2020-06-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/de/65/51147fb6.jpg" width="30px"><span>北纬8℃</span> 👍（1） 💬（8）<div>老师，能帮菜鸟讲解下幂等咋就实现了，区分请求，是一个新的请求或者是同一个请求再次发送</div>2020-07-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/47/31/f35367c8.jpg" width="30px"><span>小晏子</span> 👍（39） 💬（6）<div>delete是否返回boolean和如果出错该如何处理这个问题，要看业务方是处理业务和幂等号的顺序，如果先存储幂等号，在做业务，那么业务没处理成功时，后续处理就要删除幂等号，然后重复业务处理，这就要保证删除幂等号一定要成功，这样就要返回boolean值；相反，如果业务处理成功后在保存幂等号，那么删除幂等号成功与否都无关，删除幂等号可以不反回值。
幂等号生成算法没必要再开个接口，因为幂等号生成算法需要稳定性全局性，否则不同业务用不同算法生成幂等号，那么幂等框架就可能无法区分不同的业务请求了。
后续版本可以让幂等框架更易用，不需要过多配置，比如提供一个注解，使用方直接在需要幂等的接口上添加上这个注解，那么这个请求就一定会保证幂等。</div>2020-06-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg" width="30px"><span>Jxin</span> 👍（20） 💬（0）<div>1.针对mvp代码，delete不该返回boolean，void即可。因为该方法只有在技术异常（网络超时，redis节点无法提供服务）时才会有失败的场景。而我的习惯，是把技术异常放在最外层处理，或则代理层处理（技术异常的处理应该尽量与业务代码分离）。如果delete里面也有业务逻辑，比如入参检验，那么我会返回boolean。因为这时候的异常是业务代码该处理的场景，同时我认为调用方无需知道delete因何失败，只需要知道delete失败，所以收敛delete内部业务异常，对外只以boolean返回值做交互。

2.因为唯一id的需求方并不只有幂等框架，抽离出来在其他场景也能用，比如流水id。我认为幂等服务方提供幂等id生成接口给调用方的方式并不合适。这样做是一种资源的浪费。在这个场景，我只是为了保证幂等id生成代码的去重，并没有动态上扩缩节点调整负载的诉求。所以幂等id生成代码以公共包的方式被调用方项目依赖，仅做代码级的复用会好些。


3.抽成公共包（去重），提供声明式接口（易用），提供配置接口（灵活）。</div>2020-06-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/25/00/3afbab43.jpg" width="30px"><span>88591</span> 👍（9） 💬（0）<div>能沉下心来把细节都做好那才是真的牛！</div>2020-07-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5e/e2/1fad3052.jpg" width="30px"><span>Jemmy</span> 👍（5） 💬（0）<div>优化：IdempotenceIdGenerator 可以面向接口编程，未来 uuid 生成方式可能会变。</div>2020-06-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/3b/47/f6c772a1.jpg" width="30px"><span>Jackey</span> 👍（5） 💬（0）<div>delete还是返回boolean好一点，对删除出错的key可以人工干预或者记录下来统一处理</div>2020-06-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/ce/99/447c33d4.jpg" width="30px"><span>lengrongfu</span> 👍（4） 💬（0）<div>作为框架功能，应该要把异常上抛给调用方，让调用方自己决定如何处理；现在通用的功能框架几乎都是这么做的。</div>2020-08-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/d9/ff/b23018a6.jpg" width="30px"><span>Heaven</span> 👍（3） 💬（0）<div>1.在框架里,使用删除操作的时候,应该是人工介入时候使用的吧,这时候返回一个boolean方便盘查,对于幂等号生成算法来说,我们是抽取出来作为一个类库去放在客户端调用的,那么客户端传递给我们的格式最好一致,所以不应该抽象出一个接口,只能有一个实现的话,接口没有甚意义
2.在新版本,支持配置文件中,配置不同的名称来选择不同的幂等读写方法,并且,利用注解来进行AOP的切面编程,让使用人员使用注解就可以进行相关的幂等性保证</div>2020-06-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/43/79/18073134.jpg" width="30px"><span>test</span> 👍（3） 💬（0）<div>delete返回boolean，这样调用方会知道是否删除成功，调用方可以自己重试。可以幂等算法抽象出一个接口，用户可以选择自己想要用的幂等算法套件。</div>2020-06-10</li><br/><li><img src="" width="30px"><span>Geek_7e0e83</span> 👍（2） 💬（1）<div>1. 返回void 删除动作就是要执行成功才叫删除。删除如果出错了，一般都是以异常的形式响应。这不属于一种约定的预期情况，就和插入一样。如果删除出错了，应该将异常抛出，这次请求失败。需要抽象出一个接口，基于接口而非实现编程原则，利于后续替换幂等号的生成算法

2.幂等框架后续可以做指标监控上报的优化，帮助业务接口及时发现幂等失败的情况。</div>2022-12-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/0b/8c/db1ee0a2.jpg" width="30px"><span>walkingonair</span> 👍（2） 💬（0）<div>这种依赖请求发起方实现的幂等不是真正的幂等。
例如：对外的api接口，没办法使调用方自行判断是否重复请求

把重点放在框架的分析、设计和实现上</div>2021-04-07</li><br/><li><img src="" width="30px"><span>Geek_3b1096</span> 👍（2） 💬（0）<div>Code Review的思维很有帮助</div>2020-07-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/70/ac/83bc14c0.jpg" width="30px"><span>面向百度编程</span> 👍（2） 💬（0）<div>我觉得delete可以根据业务的需要来判断是否需要，如果是单纯的删除那就不需要，如果还需要在删除后进行一些其它操作则可以返回结果，幂等号算法可以选择策略模式进行切换，为后续如果业务改变需要不同的生成算法的话，可以随时替换</div>2020-07-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/3b/67/c188d3bc.jpg" width="30px"><span>tingye</span> 👍（2） 💬（0）<div>delete接口还是返回boolean好，让调用方能感知到异常，虽然调用方也不好处理，但能做些业务补偿或人工补救。生成算法也应该抽象成接口，便于扩展生成算法，甚至开放给业务端定制。另外幂等号一直存储在redis数据量会越来越大，可能要考虑设置过期策略和定期持久化数据</div>2020-06-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/1e/71/54ff7b4e.jpg" width="30px"><span>3Spiders</span> 👍（2） 💬（0）<div>思考题。

问题1，可以返回boolean，删除出错，返回false，不用抛异常。删除失败最多导致redis里存储了失效的幂等号。幂等号可以抽出一个接口，后期幂等算法可能修改，各自的算法实现各自的generateId。

问题2，可以新增不同的幂等算法实现，幂等算法调用成功率与失败率监控，允许业务方扩展幂等算法等。主要还是看业务需求，代码都是服务于业务，过早的扩展也是万恶之源。</div>2020-06-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/a3/0a/c0f6d731.jpg" width="30px"><span>元哥</span> 👍（1） 💬（0）<div>@VisibleForTesting 这个标注会被sonar检查出Code smell</div>2021-12-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7d/95/dd73022c.jpg" width="30px"><span>我是曾经那个少年</span> 👍（1） 💬（0）<div>问题1：delete()方法返回值的问题，个人感觉没必要，只要没有异常调用放就会正确处理。幂等号生成算法抽象出一个接口，个人感觉抽象接口要考虑有没有扩展的必要性，这个只需要保证全局唯一就好了，没有一些业务需求导致它的变化。
问题2：迭代和优化
个人感觉调用方的重试需要框架支持，让调用方去判断是否重试，是个伪需求，因为我都考虑幂等了，我肯定希望被执行放能正常执行。让调用方执行就变成了每个调用者要写轮询处理的代码。调用发的重试机制也不好处理呀。</div>2021-12-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg" width="30px"><span>aoe</span> 👍（1） 💬（0）<div>leetcode.com题解中有很多几十行甚至几行代码解题的优秀的不能在优秀的代码。对提升编码能力很有帮助</div>2020-09-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/3a/f8/c1a939e7.jpg" width="30px"><span>君哥聊技术</span> 👍（1） 💬（0）<div>1.是否返回boolean，还是看业务场景的，大多数情况下，是不用返回的，一个业务执行成功了，返回给调用方成功，调用方就不可能再次调用了，而且过期了，也会自动删除。如果业务上有别的考虑，比如一个id可能重复用，那就必须删除，如果删除失败，可以记录下来，做补偿。
我觉得还是要个幂等号算法抽象一个接口的，不一定每个幂等号都是完全一样的生成逻辑。比如在金融借款的场景，幂等号需要加入一些业务属性，比如身份证号、银行卡、手机号等，有些的业务场景，幂等号又有别的含义。
2.生成幂等号的接口要完善，允许用户传入参数来获取幂等好；增加一些补偿机制，比如删除失败的补偿；高可用部署</div>2020-06-15</li><br/><li><img src="" width="30px"><span>中间件-云原生</span> 👍（0） 💬（0）<div>通过3节看下来，实话说，还是有点水分：
1. 没有具体分析出实例代码在业务各种场景中的真正应用，甚至连代码例子也没有拿出来
2. 没有考虑到幂等成功，业务失败的情况：redis与本地事物db天然无法做到ACID，可能会最终不一致，该怎么处理
3. 如果redis挂了，系统如何降级，按照前面所说的，都是接口返回异常，那不就导致业务真正不可用了吗</div>2023-06-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/27/a2/a3/fd8e8571.jpg" width="30px"><span>Yang</span> 👍（0） 💬（0）<div>我感觉说得不明不白，可能是看一遍不行，我再回去看一遍。</div>2022-12-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/9f/62/960eecc3.jpg" width="30px"><span>夏天</span> 👍（0） 💬（0）<div>框架和业务系统接入的功能呢？
</div>2022-04-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/77/7b/338c4617.jpg" width="30px"><span>瀚海</span> 👍（0） 💬（0）<div>老师讲的很好          分析的很详细，只是实现写的过于简单了点   看功能核心只有生成随机id和setnx         如果真想在业务中使用，需要业务方依赖随机id生成算法，大多场景不合适</div>2021-09-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/27/20/8147351d.jpg" width="30px"><span>Lowic</span> 👍（0） 💬（1）<div>老师，用链路追踪的traceId作为幂等号有可行性嘛？😁</div>2021-08-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/fe/04/bb427e47.jpg" width="30px"><span>码哥字节</span> 👍（0） 💬（0）<div>空谈架构、设计、大道理，实际上没有太多意义，对你帮助不大。能沉下心来把细节都做好那才是真的牛！深表赞同</div>2021-05-19</li><br/><li><img src="" width="30px"><span>Geek_89111a</span> 👍（0） 💬（1）<div>用uuid来处理幂等号 ，uuid是随机值，每次请求uuid都不一样，就算是重试也是不一样，uuid根本处理不了这种场景，感觉在误人子弟</div>2021-04-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/17/47/74458b77.jpg" width="30px"><span>杨少君</span> 👍（0） 💬（0）<div>老师，您好，在微服务中，这个幂等框架是独立为一个微服务，还是集成在Client端，还是Server端，是否Server端还需要对幂等接口定义幂等注解进行幂等校验，文中偏向client端的操。如果幂等框架独立为一个微服务，提供生成幂等号和入库作为resful接口，那服务端的幂等校验是否也可以集成进来，不然每个服务端需要重复编码校验，我理解作为一个sdk是不是比微服务更好。</div>2020-10-16</li><br/>
</ul>