上两节课中，我们讲了如何针对一个业务系统做需求分析、设计和实现，并且通过一个积分兑换系统的开发，实践了之前学过的一些设计原则。接下来的两节课，我们再结合一个支持各种统计规则的性能计数器项目，学习针对一个非业务的通用框架开发，如何来做需求分析、设计和实现，同时学习如何灵活应用各种设计原则。

话不多说，让我们正式开始今天的内容吧！

## 项目背景

我们希望设计开发一个小的框架，能够获取接口调用的各种统计信息，比如，响应时间的最大值（max）、最小值（min）、平均值（avg）、百分位值（percentile）、接口调用次数（count）、频率（tps） 等，并且支持将统计结果以各种显示格式（比如：JSON格式、网页格式、自定义显示格式等）输出到各种终端（Console命令行、HTTP网页、Email、日志文件、自定义输出终端等），以方便查看。

我们假设这是真实项目中的一个开发需求，如果让你来负责开发这样一个通用的框架，应用到各种业务系统中，支持实时计算、查看数据的统计信息，你会如何设计和实现呢？你可以先自己主动思考一下，然后再来看我的分析思路。

## 需求分析

性能计数器作为一个跟业务无关的功能，我们完全可以把它开发成一个独立的框架或者类库，集成到很多业务系统中。而作为可被复用的框架，除了功能性需求之外，非功能性需求也非常重要。所以，接下来，我们从这两个方面来做需求分析。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/7b/a4/24955994.jpg" width="30px"><span>progyoung</span> 👍（33） 💬（9）<div>老师，本文中的案例统计时间时对业务代码是侵入式的，有没有非侵入式的案例呀？</div>2019-12-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/77/6f/454951d2.jpg" width="30px"><span>Lyre</span> 👍（20） 💬（1）<div>复杂的系统设计，首先应该梳理出功能点，整理架构设计，画出架构设计图，有了总体的规划，做下去才更顺畅。对吗老师
</div>2020-01-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/21/30/8ecce1e1.jpg" width="30px"><span>北天魔狼</span> 👍（10） 💬（4）<div>一直没有做过关于统计和监控的项目，希望老师可以出一个小的MVP🙏🙏🙏</div>2019-12-30</li><br/><li><img src="" width="30px"><span>Flynn</span> 👍（6） 💬（1）<div>老师，后面有TDD相关的内容讲解和练习么</div>2019-12-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c7/88/a2e42dc8.jpg" width="30px"><span>波波</span> 👍（2） 💬（1）<div>老师，计算最大响应时间max应该是 响应时间减去请求时间吧，为什么代码中只用到了响应时间呢？</div>2020-04-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/99/3b/791d0f5e.jpg" width="30px"><span>王先森</span> 👍（1） 💬（1）<div>案例统计时间时对业务代码是侵入式,针对php语言是可以有定时脚本去统计,大家还有什么其他的方式么？</div>2020-05-22</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/N6yjnrLnMW4XVSkBr3f0N3F962l35b5j0kib9VSlAqqbf6iaoCPicL1WnJ9KjgT4egQ7A2G0Zx3OayaK4yuoZrUVA/132" width="30px"><span>worthto</span> 👍（1） 💬（1）<div>Metrics 类的线程是一个单线程的模型，如果线程池使用多个线程，老师能否帮我们设计一款支持多线程并发的统计模型。</div>2020-04-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4d/da/8af6f035.jpg" width="30px"><span>莫大-潇湘夜雨</span> 👍（1） 💬（2）<div>老师，案例选用hashmap来存储监控数据，因为涉及到并发访问， 是不是换成并发包更合适一些呢？</div>2020-01-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/84/75/e3e5072d.jpg" width="30px"><span>JM</span> 👍（1） 💬（1）<div>这个例子里面每个接口程序块的开头和结尾都要加上timestamp，如果要统计成百上千个接口，是不是有更高效的方式呢？每个接口可能会隶属于不同的team，那这样是不是需要和多个team沟通合作，沟通协作成本很高啊。</div>2020-01-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/eb/ea/7d00f657.jpg" width="30px"><span>liyghting</span> 👍（1） 💬（1）<div>Metrics类中List&lt;Double&gt;类型，怎么不是List&lt;Long&gt;，看使用的时候都是放的long时间。</div>2019-12-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/68/e7/ee47d0e2.jpg" width="30px"><span>淤白</span> 👍（0） 💬（1）<div>打卡：用Java实现了文中案例。</div>2020-11-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/1a/4b/98c5a1e8.jpg" width="30px"><span>码到成功</span> 👍（0） 💬（1）<div>老师可以把每期的代码放到github上吗</div>2019-12-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/50/d7/f82ed283.jpg" width="30px"><span>辣么大</span> 👍（92） 💬（5）<div>没有经历过大型系统的全过程（设计，开发，实现，维护）。自己开发一些功能时，比较喜欢“用户故事”，这样能基本能做到一次交付一个可用功能。干就是了！先有一个原型，然后再迭代优化。最后“纸上得来终觉浅”，照着争哥的代码还是自己实现了一下：https:&#47;&#47;github.com&#47;gdhucoder&#47;Algorithms4&#47;tree&#47;master&#47;designpattern&#47;u025</div>2019-12-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/29/ee/fba11edf.jpg" width="30px"><span>        </span> 👍（50） 💬（3）<div>https:&#47;&#47;github.com&#47;Aspire814&#47;DesignPattern.git
因为争哥的简单实现具有代码倾入性，简单实现了了一个基于自定义切面和注解的接口统计服务。供学习参考</div>2020-01-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/1e/8c/d9330d2b.jpg" width="30px"><span>花儿少年</span> 👍（28） 💬（4）<div>目前在维护和开发营销插件系统，对于产品思维算是有一点感悟吧。
营销插件多种多样，每个插件都有一些共性的地方，也有特性的地方。插件于插件之间还有叠加互斥关系，比如说有了满减送也可以使用优惠券等等。不同的产品定义不同的插件规则，后来就出现了在同一个点上，不同插件的理解都不一一致，商家理解使用费劲。还有针对某个插件定义一些奇怪的功能，极少商家在用，但是还不允许去掉这个功能。这就为后来的优化产生了极大的阻碍，设计和开发的人都走了，奇怪的功能还涉及好几个团队，尝试过沟通，无结果，保持现状。
还有在开发新功能的时候，产品拍脑袋说这个手机壳的颜色要随心情变化，你说这能给做吗。
技术人员一定要有产品思维，代码是你写的也是你维护，某个功能是不是屎坑一定要三思，产品拍脑袋，技术不能拍脑袋，最后掉的是自己的头发，走的也是自己。一定要把风险都给他讲明白，我们不生气，我们讲道理！！！</div>2020-01-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/7a/ba/791d0f5e.jpg" width="30px"><span>一壶浊酒</span> 👍（23） 💬（1）<div>我觉得技术人需要一些产品的思维，这样即使在做已经设计好的产品的时候，也能提出一些不同的看法和见解，而不是一味的做一个执行者，别人说啥就做啥，而且框架的设计我觉得也是一个产品，需要我们技术人自己去推敲去打磨。</div>2019-12-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/fa/ab/0d39e745.jpg" width="30px"><span>李小四</span> 👍（15） 💬（1）<div>设计模式_25:

1. 做事要避免极端，最小原型和场景，是为了避免完美主义，永远开不了头的极端。但另一方面，如果是复杂的系统，避免不了地要花很多时间去思考系统设计的问题，要有思考和记录，这样是为了避免另一个极端，过于简单的架构开发复杂系统，最终导致改不动了。

2. 如果问题是“是否应该有产品意识”，答案是不言而喻的。而且，于是技术能力强的技术人员，对于产品意识的需求就越是迫切，在真实的市场竞争中，用户只会接触到产品，技术可能会成为产品的竞争优势，也可能不会，但技术人员了解产品思维，这样能够更全面地了解自己做的事情，在真实的用户场景中，在发挥着怎样的价值；另外，在做了很久的技术后，我们可能有欲望把自己的一些idea转化成产品，并最终推向市场，面向用户。做成这样的事情，会有更强烈的成就感，离创业也更近了一部。</div>2019-12-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/16/5b/83a35681.jpg" width="30px"><span>Monday</span> 👍（8） 💬（0）<div>手机听读终觉浅，归来PC撸代码.。
GET完。代码：https:&#47;&#47;gitee.com&#47;MondayLiu&#47;geek-design.git</div>2019-12-30</li><br/><li><img src="" width="30px"><span>小畅</span> 👍（6） 💬（1）<div>打卡似懂非懂</div>2019-12-31</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/qOdqzmC507sibL6sichNSDaVmyoMKibEIqHWpic4CftgOQnoA3QKeRPwic9j1Ha8MLtzzqzfSRavR9GWMju09SMADUg/132" width="30px"><span>Ilearning99</span> 👍（5） 💬（0）<div>我发现很多时候，我想问题都很复杂，快到deadline的时候就会实现一个非常简化的版本</div>2020-10-07</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKDfO7wKibzpw4YsoqLRCHUKxX4rYRUh7m7RCdOwzWVaN9QLlhcU5ho3w2Qcpib1O69YPj65ib07xQBQ/132" width="30px"><span>努力呼吸</span> 👍（4） 💬（0）<div>个人简单实现的无侵入代码 https:&#47;&#47;github.com&#47;ghaoxiangzZ&#47;design-pattern-code&#47;tree&#47;master&#47;src&#47;main&#47;java&#47;com&#47;ghaoxiang&#47;lesson&#47;twentyfive</div>2020-02-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7f/ca/ea85bfdd.jpg" width="30px"><span>helloworld</span> 👍（3） 💬（0）<div>在设计一个系统的时候，不需要也不能100%都考虑到了才开始，要先设计一个能简单实现的系统，先编码实现了这个简单系统，然后逐步迭代完善；在这个过程中能用图示画出来的要画出来，图示能给人以十分直观的方式；在学习其他的课程的过程中，通过画系统的流程图就能让自己可以很清晰地了解系统的执行流程，尤其是自己总结流程图很重要！并且当时间长了来回顾复习的时候，流程图更直观，更容易复习</div>2020-01-16</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJcxSpNMqwqyicMvdOSr9ic0p1ABiauHnv7g7YQVSJuoHPoQbYDu3YzdpgmSAk2KricUBQ5yibWBWIq75w/132" width="30px"><span>桂城老托尼</span> 👍（3） 💬（0）<div>感谢争哥分享，先看了第一段过来作答，完了再回到文章验证想法。
统计接口各维度信息的框架设计思路如下，
1，确认框架职责，框架的用例。采集原始数据(标准埋点日志)，加工原始数据(时间窗口内)，提供外围消费(适配各种style)
2. 细分每一职责，采集原始数据，围绕框架提供能力，确定原始数据标准，甚至原始数据标准的定义也开放给业务系统，解析关键信息的规则由业务系统自己把控。框架负责制定规则的枚举，和规则解析。
3. 加工原始数据，其实就是使用规则对原始数据流进行解析和统计，这里可以给出默认时间窗口和更新周期，业务系统可配置变更。
4. 提供外围系统消费，框架给出指标数据，自己默认展示样式，自定义样式留好扩展，交给业务系统自己扩展，框架也可以管控起来，形成类似于“主题市场”的东西。
总结下来，就是确定职责边界，高内聚框架职责，低耦合业务系统，对修改关闭，对扩展开放。基于这些原则，再往上走就是各种xx设计模式了，这时候就是水到渠成的事儿了。 
-----回去再看下文章验证下猜想，不被打脸才好 。</div>2019-12-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a6/38/55483b8c.jpg" width="30px"><span>。</span> 👍（3） 💬（1）<div>像这种统计频次的功能，是通过集成框架去实现好，还是说通过mq由消费服务去实现好</div>2019-12-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/44/47/3ddb94d0.jpg" width="30px"><span>javaadu</span> 👍（3） 💬（0）<div>还没有看文章的方案，先来留个言：
运行时：框架的接口是注解；通过mq将统计的数据发出到实时计算引擎例如flink，编写udf统计各种特征数据

管理时：核心是数据存储和查询模块；渠道接入放在独立的模块</div>2019-12-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/ef/5b/ff28088f.jpg" width="30px"><span>郑大钱</span> 👍（2） 💬（2）<div>高级工程师会从易用、扩展、性能、稳定等方面设计架构，这对我来说是很难的。但我也想写出牛逼的代码，怎么办？
最小原型是我的最佳实践。
先聚焦于实现一个单一的功能点，就算实现的代码毫无设计可言，但至少要先让它跑起来。谈易用、谈扩展、谈性能、谈健壮，具体代码比抽象概念更容易。
一定要给你的代码挤出重构的时间，哪怕只有一句代码。对我来说，重构相当于在复盘，这是你学到的设计模式落地的时候，也是真正成长的时候。</div>2020-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/44/47/3ddb94d0.jpg" width="30px"><span>javaadu</span> 👍（2） 💬（0）<div>问题1：要重视设计，但是可以采取不同的方法，有的人喜欢用本文中的方法——先写一个简单的原型，在写的过程中理清楚对问题的理解和设计；也有的人喜欢将设计作为一个单独的流程，先用一些抽象的线框图推到清楚再动手。我的观点是，两者不冲突，可以两者一起使用，如果是团队项目，建议先各自有个深度的思考然后再进行碰撞合并，应该可以产出大方向没问题的设计</div>2020-01-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a5/ee/6bbac848.jpg" width="30px"><span>再见孙悟空</span> 👍（2） 💬（0）<div>使用线框图，采用最小原型模式，先做出一个模型，画出模型图，然后再迭代优化，使抽象的东西变得看得见摸得着，这确实是一个好方法，实际项目中也不知不觉用到了这种思想，做非业务类的需求如此，业务类的也一样。还有留言里说的用户故事也是很不错的方法，通俗点就是技术要有产品的思维，站在使用者的角度看问题。</div>2019-12-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/2c/c6/416bd86e.jpg" width="30px"><span>阿杰</span> 👍（1） 💬（0）<div>问题1：借鉴一些实现方案、跟框架的使用方沟通，了解他们真正的需求点，痛点，挖掘一些潜在的信息。
问题2：会写代码是基本要求，好技术是敲门砖。但是真正决定程序员发展高度的往往是一些思维上的东西，例如；产品思维，业务理解，沟通表达方式......
所以我认为程序员一定要有一定的产品思维，纯技术脑是行不通的。毕竟软件开发最开始兴起的时候，是没有所谓的产品经理、测试这些角色的。但是写代码的人一手包办（不信你去看看git、linux等产品）。</div>2024-05-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/fd/86/3610ac9c.jpg" width="30px"><span>BKA</span> 👍（1） 💬（0）<div>1.xmind，用户故事（线框图），processon、画图，最小原型
2.非常重要，技术是为产品服务的，产品有时候不会考虑异常点，开发成本以及，不清晰的业务定义 ，产品是1，技术是后面的0
</div>2023-06-25</li><br/>
</ul>