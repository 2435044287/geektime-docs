在上一节课中，我们对计数器框架做了需求分析和粗略的模块划分。今天这节课，我们利用面向对象设计、实现方法，并结合之前学过的设计思想、设计原则来看一下，如何编写灵活、可扩展的、高质量的代码实现。

话不多说，现在就让我们正式开始今天的学习吧！

## 小步快跑、逐步迭代

在上一节课中，我们将整个框架分为数据采集、存储、聚合统计、显示这四个模块。除此之外，关于统计触发方式（主动推送、被动触发统计）、统计时间区间（统计哪一个时间段内的数据）、统计时间间隔（对于主动推送方法，多久统计推送一次）我们也做了简单的设计。这里我就不重新描述了，你可以打开上一节课回顾一下。

虽然上一节课的最小原型为我们奠定了迭代开发的基础，但离我们最终期望的框架的样子还有很大的距离。我自己在写这篇文章的时候，试图去实现上面罗列的所有功能需求，希望写出一个完美的框架，发现这是件挺烧脑的事情，在写代码的过程中，一直有种“脑子不够使”的感觉。我这个有十多年工作经验的人尚且如此，对于没有太多经验的开发者来说，想一下子把所有需求都实现出来，更是一件非常有挑战的事情。一旦无法顺利完成，你可能就会有很强的挫败感，就会陷入自我否定的情绪中。

不过，即便你有能力将所有需求都实现，可能也要花费很大的设计精力和开发时间，迟迟没有产出，你的leader会因此产生很强的不可控感。对于现在的互联网项目来说，小步快跑、逐步迭代是一种更好的开发模式。所以，我们应该分多个版本逐步完善这个框架。第一个版本可以先实现一些基本功能，对于更高级、更复杂的功能，以及非功能性需求不做过高的要求，在后续的v2.0、v3.0……版本中继续迭代优化。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/f7/9d/be04b331.jpg" width="30px"><span>落叶飞逝的恋</span> 👍（5） 💬（3）<div>老师，请教个问题。类的定义里面，什么时候使用基本类型，什么时候用包装类型？</div>2020-01-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7e/bb/947c329a.jpg" width="30px"><span>程序员小跃</span> 👍（3） 💬（1）<div>把落下的实战篇学习完了，还把老师的干货总结分享给了自己的小伙伴，都说赞</div>2020-01-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/68/e7/ee47d0e2.jpg" width="30px"><span>淤白</span> 👍（1） 💬（1）<div>打卡：用Java实现了文中的完整案例。</div>2020-11-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/e6/66/fbbf0bb1.jpg" width="30px"><span>牛顿的烈焰激光剑</span> 👍（0） 💬（2）<div>Demo.java 里应该用`while(true);`包裹所有代码吧？</div>2020-01-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e0/26/4942a09e.jpg" width="30px"><span>猫头鹰爱拿铁</span> 👍（0） 💬（2）<div>可否提供下类图，整体上看着更方便。</div>2020-01-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a5/ee/6bbac848.jpg" width="30px"><span>再见孙悟空</span> 👍（0） 💬（5）<div>对于获取大量数据在内存有可能把内存撑爆的问题，有什么好的解法吗？前段时间系统也遇到这个问题了，最后扩大了内存，有没有通过代码上来解决的方案呢？欢迎小伙伴和老师的指教。</div>2020-01-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/7a/3c/87e015f8.jpg" width="30px"><span>堵车</span> 👍（63） 💬（8）<div>要写出优美的代码，首先要有一颗对丑陋代码厌恶的心</div>2020-01-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/96/31/f13e6869.jpg" width="30px"><span>李现教你学编程</span> 👍（53） 💬（9）<div>新年快乐 一起学习 一起提高 2020</div>2020-01-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/8a/19/a54761af.jpg" width="30px"><span>何沛</span> 👍（31） 💬（5）<div>Aggregator考虑到后期新增新的维度统计，可以考虑使用责任链模式。
ConsoleReporter、EmailReporter 出现了代码复用，可以用模板设计模式。</div>2020-01-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/50/d7/f82ed283.jpg" width="30px"><span>辣么大</span> 👍（25） 💬（10）<div>想了三点，希望和小伙伴们讨论一下：
1、RequestInfo save 一次写入一条。是否需要考虑通过设置参数，例如一次写入1000或10000条？好处不用频繁的与数据库建立连接。
2、聚合统计Aggregator是否可以考虑不写代码实现统计的逻辑，而是使用一条SQL查询实现同样的功能？
3、EmailReporter startDailyReport 没指定明确的统计起止时间。设置统计指定区间的request info，例如08:00~次日08:00，然后发邮件。</div>2020-01-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg" width="30px"><span>Jxin</span> 👍（18） 💬（4）<div>沙发！
1.栏主新年快乐。零点发帖，啧啧啧。
2.给出github地址吧，我们来提pr，一个学习用demo大家合力下就当练手，没必要自己死磕全实现哈。
3.关于邮件和控制台两个接入层。实现代码重了。可以把定时统计下沉到下一层来实现，然后两个接入层共用这个实现。然后收集的统计数据的类型应该可以提供差异化配置的api。在消费统计数据的消息时，做差异化分发，实现各接入层仅看到自己想看的数据。

4.spring1.x~3.x，兼容老版本做得挺好。springboot在自动装配的实现上下足了功夫（插件化，易插拔）。netty的实现也挺挺讲究，还能顺带学网络相关知识。以上其实都运用一系列设计原则。在没看栏主专栏前，我是啃这些学的场景。</div>2020-01-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/42/78/7ba89c75.jpg" width="30px"><span>RedDevil</span> 👍（17） 💬（0）<div>争哥一直在强调迭代思维，我也是最近才意识到这个，以前做事总认为第一遍就能搞定，不愿意去搞第二次甚至第N次，实际上反复迭代优化后的成果才更有深度</div>2020-10-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cd/aa/33d48789.jpg" width="30px"><span>卫江</span> 👍（15） 💬（3）<div>上面的代码设计与实现，我认为有两个重点是需要改进的：
1. 不同的统计规则，通过抽象统计规则抽象类，每一个具体的统计（最大时间，平均时间）单独实现，同时在 Aggregator 内中通过 List等容器保存所有的统计规则实现类，提供注册函数来动态添加新的统计规则，使得Aggregator否则开闭原则，各个统计规则也符合单一责任原则。
2. 显示方式很明显是一个变化点，需要抽象封装，抽象出 显示接口，在汇报类中通过依赖注入的方式来使用具体的显示类，这样一来，reporter类更加责任单一，我们也可以通过扩展新的显示类来扩展功能，符合开闭原则，每一个显示实现类更加否则单一责任。</div>2020-01-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/ef/5b/ff28088f.jpg" width="30px"><span>郑大钱</span> 👍（11） 💬（1）<div>哈哈，原来谷歌的工程师也是普通人，也不可能一上来就写出完美的代码。小步快跑、逐步迭代不仅是一种很好的产品模式，也是一种很好的开发模式，那些著名的开源库也是修修补补逐渐长大的。
最小原型也是一种给外界释放产出信号的有效手段，需求方的情绪得到安抚，写代码的时候自己也不会那么慌。</div>2020-09-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/b9/eb/6bdab896.jpg" width="30px"><span>Murrre</span> 👍（11） 💬（0）<div>https:&#47;&#47;github.com&#47;murreIsCoding&#47;learning_geek&#47;tree&#47;master&#47;src&#47;main&#47;java&#47;design_pattern&#47;demo2&#47;performance_monitoring
敲了一下，主要是实现了redis存储部分逻辑，redis命令不是很熟，可能有更好的方案</div>2020-01-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/64/9b/d1ab239e.jpg" width="30px"><span>J.Smile</span> 👍（5） 💬（0）<div>争哥这套课程确实呕心沥血，哈哈</div>2020-01-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/3d/00/7daa7403.jpg" width="30px"><span>Eden Ma</span> 👍（5） 💬（0）<div>2020新年快乐 早上醒来第一件事就是听卖🍑者和看争哥的更新</div>2020-01-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/ee/f3/a94cee23.jpg" width="30px"><span>KK</span> 👍（4） 💬（1）<div>数据聚合计算可不可以考虑和存储设计在一起呢？因为有第三方的存储本身就提供了一些聚合计算；当然我们把Aggreator注入到存储中，帮助存储类做聚合计算也是另外一种设计。不知这样设计是否合理，向各位请教，希望老师能够看到解惑。</div>2020-04-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/db/e4/a1b45d79.jpg" width="30px"><span>柳志焕</span> 👍（4） 💬（0）<div>把老师的代码做了一个整理，试着运行了一下。
小伙伴们感兴趣的可以看一下：https:&#47;&#47;github.com&#47;Aaronyu29&#47;DesignPattern&#47;tree&#47;master&#47;src&#47;u026</div>2020-01-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/ac/62/37912d51.jpg" width="30px"><span>东方奇骥</span> 👍（3） 💬（0）<div>因为我们项目统计数据较多，一般会写es，也会利用es的聚合功能。</div>2020-01-01</li><br/><li><img src="" width="30px"><span>叶成勇</span> 👍（2） 💬（1）<div>两年后才来学这个专栏，会不会很落后啊？！</div>2022-01-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/d1/29/1b1234ed.jpg" width="30px"><span>DFighting</span> 👍（2） 💬（0）<div>我觉得代码里的问题主要有两处：
1、统计类应该抽象成一个接口，相关统计函数的实现可以做依赖注入，也可以不做
2、数据的采集和存储不应该放在一起，因为这样势必会影响业务代码的响应时间，虽然存储类抽象成为了一个接口，并通过依赖注入的方式便于扩展，但从采集数据和存储应该是不同的层次的设计。前者很难做到不侵入业务代码（兼顾性能的前提下），而后者很难不做到和存储解耦，这两个放在一起，太不合适了</div>2020-02-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/99/27/47aa9dea.jpg" width="30px"><span>阿卡牛</span> 👍（2） 💬（0）<div>要想实现非侵入的框架，需要AOP的思想</div>2020-01-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/b0/29/7ab573f4.jpg" width="30px"><span>哈喽沃德</span> 👍（2） 💬（0）<div>什么时候开始讲设计模式呢</div>2020-01-02</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI2icbib62icXtibTkThtyRksbuJLoTLMts7zook2S30MiaBtbz0f5JskwYicwqXkhpYfvCpuYkcvPTibEaQ/132" width="30px"><span>xuanyuan</span> 👍（2） 💬（0）<div>赞，记录思考过程才是最真实的案例</div>2020-01-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/44/a7/171c1e86.jpg" width="30px"><span>啦啦啦</span> 👍（2） 💬（0）<div>新年快乐</div>2020-01-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/2c/c6/416bd86e.jpg" width="30px"><span>阿杰</span> 👍（1） 💬（0）<div>课后问题：
1、ConsoleReporter、EmailReporter做的事情都是数据捞取，数据统计，拼接数据显示格式，推送展示数据。感觉可以抽取一个父类出来，把公共的逻辑放到父类里边。另外，统计类的代码确实有点长了，且容易牵一发动全身，是否可以根据统计类型拆分类。</div>2024-05-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/6c/bc/f751786b.jpg" width="30px"><span>Ming</span> 👍（1） 💬（0）<div>每天面对shi山般的代码，要命</div>2023-04-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/d1/81/89ba9d81.jpg" width="30px"><span>大力</span> 👍（1） 💬（1）<div>不太明白为何 EmailReporter 与 ConsoleReporter，一个使用了 Timer，而另一个使用了 ScheduledExecutorService。实际上它们要实现的目的应该是一致的，为啥不统一用 ScheduledExecutorService？</div>2020-10-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e0/a8/4e739cf6.jpg" width="30px"><span>Sic Pavis</span> 👍（1） 💬（0）<div>业务服务部署在一起的最好只有收集储存功能。
计算和展示独立部署一个微服务来完成。这样做有两个明显的好处：
1. 不太占用业务的cpu和内存资源，减少对业务的影响
2. 计算功能要修改或扩展时也无需在业务服务上进行迭代</div>2020-07-15</li><br/>
</ul>