你好，我是郭朝斌。

前面两讲，我们一直在谈物联网云平台针对海量数据的处理和存储技术。顺着物联网的数据技术体系继续往下探索，我们自然就会面临一个问题：物联网云平台的服务器需要管理海量设备的接入，并且接收来自设备的海量数据的输入，那么服务器要怎么应对这样的挑战呢？

我们来分析一下这个问题。物联网设备是通过某种通信协议接入云平台的，比如常用的MQTT协议，那么设备接入的服务器就是MQTT Broker服务器。

从架构设计来说，负责设备接入的这一部分一般叫作**设备接入层**，也被称为**IoT Hub**。设备接入层之后，才是和互联网系统类似的**业务层**。具体的系统架构图可能是下面这样的：

![](https://static001.geekbang.org/resource/image/fd/5b/fdb74fcd872c299459bbb2f28383325b.jpg?wh=2700%2A1886)

不过，估计你也发现问题了，这样的架构根本无法支撑物联网场景中海量设备的接入和海量数据的输入。单台MQTT Broker服务器很容易面临性能瓶颈。所以前面提到的“服务器怎么应对挑战”的问题就变成了：怎么打造高性能的设备接入层？

我们再继续深入分析，把关键点定位得更具体一点。打造**高性能**的设备接入层，最重要的技术难点是，如何实现接入层的**高并发**。因为只有具备高并发的能力，才能有效地、可靠地实现数据的传输。

所以，现在问题又变成了：物联网云平台中，怎么实现高并发的设备接入层？
<div><strong>精选留言（25）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/14/6d/0d/71053329.jpg" width="30px"><span>il李li</span> 👍（27） 💬（4）<div>对于每个设备负载均衡分配连接到那个MQTT Broker，收到设备PUB消息的Broker路由转发该消息到集群的其他Broker，这需要集群中维护一个全局的主题Topic与消息路由表Route Table的对应关系，能够准确转发到其他有订阅该主题的Broker节点上。而对于Broker收到PUB消息后，查到相应的Topic，并将消息发送给订阅此 Topic 的终端设备。这个全局的Topic消息路由表是个关键的设计</div>2020-12-04</li><br/><li><img src="" width="30px"><span>Geek_9b7997</span> 👍（7） 💬（1）<div>一般的企业级平台毕竟不是大厂平台，如果有了边缘网关后，并发量是不是就没有那么多了？其实也无需集群了？</div>2020-12-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/9a/12/06863960.jpg" width="30px"><span>稳</span> 👍（2） 💬（2）<div>请教下老师，mqtt不也属于消费队列吗？那增加的rabbitmq这一层的意义大吗？</div>2020-12-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c6/7b/38100bee.jpg" width="30px"><span>fwx</span> 👍（2） 💬（3）<div>当接入 IoT 设备数量在十万以内或者万级时，能否直接选择支持MQTT协议的消息队列，将MQTT Broker服务器和消息队列系统进行合二为一？</div>2020-12-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/e6/cd/bf5e928c.jpg" width="30px"><span>小太阳</span> 👍（1） 💬（1）<div>rabbitmq的mqtt插件，在生产环境使用有什么限制么？</div>2021-05-14</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIVlib8n4JZhIomleMIyJTrbhn81kXG39DhJzrFMwmwxFsHCkicsC4CmY5Ft8icmzibWzmvibsDKDP3ORQ/132" width="30px"><span>InfoQ_Albert</span> 👍（1） 💬（1）<div>之前做个一项目需要对接物联网数据，需要用到消息队列来降低数据库的写入请求，当时对比了几个MQ；Kafka集群支持比较好，但是不支持MQTT协议；RabbitMQ支持MQTT协议但是使用的是Erlang语言编写，怕出问题了搞不了；当时项目的接入的物联网设备不多就30台，最后使用的是ActiveMQ的新一代叫Apollo，它可以提供消息队列和broker功能；但是不知如何部署集群，所以想问问郭老师？</div>2020-12-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f2/46/09c457eb.jpg" width="30px"><span>Garwen</span> 👍（1） 💬（1）<div>相同主题的数据发送到了不同的设备上，但是这些MQTT Broker里面的数据都进了消息队列的同一主题里面了吧，所以订阅消息队列里面的对应主题就能接收到所有同一Topic的数据了。</div>2020-12-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/2a/be/17c0f8ca.jpg" width="30px"><span>Dan</span> 👍（1） 💬（1）<div>方法一应该是直接从缓存那一集提取数据 然后再通过MQTT broken分发
方法二应该是每个mqtt都有有一分订阅名单，然后所有broker 都吧相关信息发给一个服务器综合处理</div>2020-12-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/d6/a2/be61c162.jpg" width="30px"><span>贤伟</span> 👍（1） 💬（1）<div>我们是用3 kafka brokers集群做消息处理的， 每个topic有多个分区，每个分区有3个副本，分在3个broker上。同时每个topic我们有一个消费者group，每个group 有多个消费者，每个消费者去处理1个或多个partition（消费者就是数据处理微服务，可以动态扩展，保证启动时订阅同一个topic，属于同一个group）。
我的理解可以把consumer group当做一个订阅者，既能利用多分区并行消费，也可以保证该group可以收到topic的所有消息。</div>2020-12-04</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/qZ3bvj9j1KibcY7zkv2XS0gDF9oUrkx7zjucHCnIwCnBM6KYUBQUjyXAO3wkNlPiawTNVicKKwNjFkQxv0feHJUdQ/132" width="30px"><span>杨磊</span> 👍（0） 💬（1）<div>HAProxy会变成整个系统的网络瓶颈吧？毕竟所有网络请求流量都要流经这里。
为什么不把网关配置为连接某固定MQTT Broker呢，这样就不去除了这个网络贷款瓶颈。

谢谢</div>2021-04-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5c/8f/551b5624.jpg" width="30px"><span>小可</span> 👍（0） 💬（1）<div>还有一种场景是设备数量多，且数据本身比较大，单条几百KB，如果数据上报走负载均衡，那么负载均衡的网卡就成了系统瓶颈，这种场景除了网卡融合还有其他方案吗？</div>2021-02-06</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/VKEoG4KibH1ajZ3PXI47dOE0SxEGQzaic7duJG38INguJpZUl8IIy7jgiavOH2fO8WEkISJZxldMPAOP6DDjR65mQ/132" width="30px"><span>Geek_73e181</span> 👍（0） 💬（2）<div>能直接用卡夫卡代替mqtt吗？</div>2021-01-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/29/39/be9d2e88.jpg" width="30px"><span>边际革命</span> 👍（0） 💬（1）<div>老师， 接入层有什么开源项目参考下吗？</div>2021-01-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/ec/93/d77a303a.jpg" width="30px"><span>孙腾蛟</span> 👍（0） 💬（2）<div>HAProxy和网卡这部分会不会成为性能瓶颈，当有百万级别以上的并发, 作者有相关的文章或书推荐吗</div>2020-12-19</li><br/><li><img src="" width="30px"><span>兢</span> 👍（0） 💬（1）<div>请教老师个问题：在加入缓存后，好像缺少一个将缓存数据落地的服务，这块有什么成熟解决方案吗？还是需要自己写一个服务去读缓存然后写入数据库？</div>2020-12-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/4f/d4/cd7ed149.jpg" width="30px"><span>Sceneryback</span> 👍（0） 💬（1）<div>系统把处理后的数据发到另一个 kafka topic, 几个 mqtt brokers 作为一个 consumer group 订阅此 topic 共同消费</div>2020-12-07</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epa9fhIhtLUNkCqR9dxZTUolBLs40YiawZ4TUtvTG90HR0OyXzwU7icjyDiaF4FZOicyzRV1bGAylhs2A/132" width="30px"><span>德慢慢</span> 👍（0） 💬（1）<div>可以利用tag吗？</div>2020-12-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/d7/a2/5f6b90a9.jpg" width="30px"><span>wuqilv</span> 👍（0） 💬（1）<div>利用kafka 的group和topic？</div>2020-12-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/cd/ba/3a348f2d.jpg" width="30px"><span>YueShi</span> 👍（3） 💬（1）<div>这个问题是 怎么保证消息准确到达消费者(订阅者), 
就是保证消息不丢失,
这个的解决是靠mq实现的, 常见的就是ack机制, 
消息确认机制: 消息在到达消费者后并被成功消费之后会向broker发送ack确认消息, broker才会认为这条消息已经消费完毕, 并进行下一条消息

一般的ack级别分为 no-ack, auto-ack, manual-ack等

但是过于严格的要求会导致新的问题产生, 就是一条消息被消费多次, 这个一般是通过代码去保证幂等性</div>2020-12-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8c/5c/3f164f66.jpg" width="30px"><span>亚林</span> 👍（1） 💬（0）<div>mqtt转Kafka有成熟的方案了么？</div>2023-10-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5b/66/ad35bc68.jpg" width="30px"><span>党</span> 👍（0） 💬（0）<div>把设备进行分组，按照设备使用的省份分组，或者大客户分组，甚至在服务器算力不够时候，在新添加服务器，所有新加入设备都是一个组。 每组单独一套mqtt加上所有的数据处理，这样搞是不是更简单点。</div>2024-10-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/36/41/62/cf9e3aaa.jpg" width="30px"><span>cheems</span> 👍（0） 💬（0）<div>网关接收到消息解析完成之后，在负载均衡到MQTT broker的吗</div>2023-08-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8c/5c/3f164f66.jpg" width="30px"><span>亚林</span> 👍（0） 💬（0）<div>mqtt broker转kafka 开源方案有点少</div>2023-07-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/20/97/84/7c1b9906.jpg" width="30px"><span>奇[爱心]一</span> 👍（0） 💬（0）<div>老师，您好。我是一个小白，文章中的数据库可以用什么数据库呢？还有流处理服务应该用什么？可以直接往数据库里这数据吗？</div>2021-12-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/55/10/33310cb9.jpg" width="30px"><span>恒</span> 👍（0） 💬（0）<div>前面讲网关的时候，北向接口里面没有提到mqtt协议支持。那么从网关到hub一般是有什么协议呢？如果还是mqtt，那网关在中间就是只做转发不做翻译？</div>2021-06-17</li><br/>
</ul>