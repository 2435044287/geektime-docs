在日常工作中，应用或者系统出现性能问题往往是不可避免的，除了在有一定规模的IT企业或者专注于特定性能领域的企业，可能大多数工程师并不会成为专职的性能工程师，但是掌握基本的性能知识和技能，往往是日常工作的需要，并且也是工程师进阶的必要条件之一，能否定位和解决性能问题也是对你知识、技能和能力的检验。

今天我要问你的问题是，后台服务出现明显“变慢”，谈谈你的诊断思路？

## 典型回答

首先，需要对这个问题进行更加清晰的定义:

- 服务是突然变慢还是长时间运行后观察到变慢？类似问题是否重复出现？
- “慢”的定义是什么，我能够理解是系统对其他方面的请求的反应延时变长吗?

第二，理清问题的症状，这更便于定位具体的原因，有以下一些思路：

- 问题可能来自于Java服务自身，也可能仅仅是受系统里其他服务的影响。初始判断可以先确认是否出现了意外的程序错误，例如检查应用本身的错误日志。  
  对于分布式系统，很多公司都会实现更加系统的日志、性能等监控系统。一些Java诊断工具也可以用于这个诊断，例如通过JFR（[Java Flight Recorder&lt;/](https://docs.oracle.com/javacomponents/jmc-5-4/jfr-runtime-guide/about.htm#JFRUH173)
<div><strong>精选留言（18）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/fa/4c/3484fe23.jpg" width="30px"><span>江南白衣Calvin</span> 👍（197） 💬（5）<div>找繁忙线程时，top -h , 再jstack， 再换算tid比较累，而且jstack会造成停顿。推荐用vjtools里的vjtop,  不断显示繁忙的javaj线程，不造成停顿。</div>2018-08-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/2b/5c/a00fef79.jpg" width="30px"><span>杨东yy</span> 👍（40） 💬（1）<div>确实不错，还有个命令，sar,主要看iowait的值，如果它比较高，也说明磁盘io写入慢，当时我们的系统是虚拟机，和别的业务共用物理机，所以当别人并发大，也影响了我们，我们有切面写日志，系统日志写的比较多，就出现整个服务慢了，后来减少不必要的日志，找运维换机器</div>2018-07-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/e8/81/0be4db59.jpg" width="30px"><span>盼盼</span> 👍（31） 💬（1）<div>profiling收集程序运行时信息的方式主要有以下三种：
事件方法：对于 Java，可以采用 JVMTI（JVM Tools Interface）API 来捕捉诸如方法调用、类载入、类卸载、进入 &#47; 离开线程等事件，然后基于这些事件进行程序行为的分析。
统计抽样方法（sampling）: 该方法每隔一段时间调用系统中断，然后收集当前的调用栈（call stack）信息，记录调用栈中出现的函数及这些函数的调用结构，基于这些信息得到函数的调用关系图及每个函数的 CPU 使用信息。由于调用栈的信息是每隔一段时间来获取的，因此不是非常精确的，但由于该方法对目标程序的干涉比较少，目标程序的运行速度几乎不受影响。
植入附加指令方法（BCI）: 该方法在目标程序中插入指令代码，这些指令代码将记录 profiling 所需的信息，包括运行时间、计数器的值等，从而给出一个较为精确的内存使用情况、函数调用关系及函数的 CPU 使用信息。该方法对程序执行速度会有一定的影响，因此给出的程序执行时间有可能不准确。但是该方法在统计程序的运行轨迹方面有一定的优势。</div>2018-07-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/b1/2a/c1432fff.jpg" width="30px"><span>Yano</span> 👍（24） 💬（4）<div>一直以来看老师的专栏没有留言过，今天特意来留言。我看了13讲（当时只出到13讲）面试就轻松通过了～老师每一篇文章，都让我非常收益，赞一个～！</div>2018-07-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ff/a5/eccc7653.jpg" width="30px"><span>clz1341521</span> 👍（23） 💬（1）<div>dstat这个命令也很有用</div>2018-08-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f3/81/42e29d40.jpg" width="30px"><span>有福</span> 👍（13） 💬（2）<div>喜欢用火焰图来辅助定位</div>2018-08-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/31/d4/3dcddc04.jpg" width="30px"><span>One day</span> 👍（1） 💬（1）<div>之前看到目录上还有讲spring和数据库等等，后面还会讲吧！</div>2018-07-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e3/cb/d13986f7.jpg" width="30px"><span>张永峰</span> 👍（10） 💬（3）<div>我都是一边看服务层，一边找DBA，80%都是DB慢SQL导致服务慢，经验之谈。</div>2020-02-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8a/5f/c60d0ffe.jpg" width="30px"><span>硅谷居士</span> 👍（7） 💬（1）<div>阿里的 arthas 不错。淘宝也有一个 profiler。</div>2019-04-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0e/a1/717e2768.jpg" width="30px"><span>磊吐槽</span> 👍（7） 💬（0）<div>百度搜索 profiling是什么</div>2018-07-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a9/90/0c5ed3d9.jpg" width="30px"><span>颇忒妥</span> 👍（6） 💬（0）<div>我们应用跑在K8S上，我一般是看thread dump和gc log 。thread dump可以通过jstack或者spring boot actuator可以得到（推荐这个办法），然后交给fastthread.io分析。gc log 则在jvm启动时增加参数，然后交给gceasy.io 分析。内存泄露则是jvm 启动时增加参数，如果oom则heap dump到某个目录，而这个目录用emptyDir 卷挂载。</div>2020-06-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/9c/53/ade0afb0.jpg" width="30px"><span>ub8</span> 👍（4） 💬（1）<div> Full GC ，Minor GC 频率是多少算是频繁呢？</div>2020-01-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/93/c8/9eb6c644.jpg" width="30px"><span>大神仙</span> 👍（3） 💬（0）<div>老师，minor gc变长的通常情况有哪些，除了young配置小以外，和系统io有关系么</div>2018-08-27</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKib804LQiawZc7KHzerDF2B4zGvPByXKTVR1h6HibRlc8sQFAujIO3M02GicOg9Qia9ibBZlbmDyJcCKyQ/132" width="30px"><span>james.h.fu</span> 👍（2） 💬（0）<div>老师，我感觉很需要高质量的面向对象分析和设计。看代码的时候，总感觉有些地方OO写不好。</div>2018-12-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/37/38/f1/7f65979c.jpg" width="30px"><span>Gen幸福旅程iuS</span> 👍（1） 💬（0）<div>vmstat -1 -10 这个命令写错了，应该为：vmstat 1 10</div>2023-05-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2c/a9/cc/1183d71f.jpg" width="30px"><span>无</span> 👍（0） 💬（0）<div>上下文切换次数，什么情况算高</div>2024-11-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/97/81/c457def1.jpg" width="30px"><span>鹤涵</span> 👍（0） 💬（1）<div>找繁忙线程时，top -h , 再jstack， 再换算tid比较累，而且jstack会造成停顿。推荐用vjtools里的vjtop,  不断显示繁忙的javaj线程，不造成停顿。</div>2022-04-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/d7/34/b67c74b8.jpg" width="30px"><span>阳春面</span> 👍（0） 💬（3）<div>老师，请问下服务器负载高但cpu使用率低可能是什么原因</div>2020-04-13</li><br/>
</ul>