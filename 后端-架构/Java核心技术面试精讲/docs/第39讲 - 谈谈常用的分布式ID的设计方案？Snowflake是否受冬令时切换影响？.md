专栏的绝大部分主题都侧重于Java语言和虚拟机，基本都是单机模式下的问题，今天我会补充一个分布式相关的问题。严格来说，分布式并不算是Java领域，而是一个单独的大主题，但确实也会在Java技术岗位面试中被涉及。在准备面试时，如果有丰富的分布式系统经验当然好；如果没有，你可以选择典型问题和基础技术进行适当准备。关于分布式，我自身的实战经验也非常有限，专栏里就谈谈从理论出发的一些思考。

今天我要问你的问题是，谈谈常用的分布式ID的设计方案？Snowflake是否受冬令时切换影响？

## 典型回答

首先，我们需要明确通常的分布式ID定义，基本的要求包括：

- 全局唯一，区别于单点系统的唯一，全局是要求分布式系统内唯一。
- 有序性，通常都需要保证生成的ID是有序递增的。例如，在数据库存储等场景中，有序ID便于确定数据位置，往往更加高效。

目前业界的方案很多，典型方案包括：

- 基于数据库自增序列的实现。这种方式优缺点都非常明显，好处是简单易用，但是在扩展性和可靠性等方面存在局限性。
- 基于Twitter早期开源的[Snowflake](https://github.com/twitter/snowflake)的实现，以及相关改动方案。这是目前应用相对比较广泛的一种方式，其结构定义你可以参考下面的示意图。

![](https://static001.geekbang.org/resource/image/ff/ad/ffd41494a39ef737b3c1151929c3c4ad.png?wh=1010%2A270)

整体长度通常是64 （1 + 41 + 10+ 12 = 64）位，适合使用Java语言中的long类型来存储。
<div><strong>精选留言（18）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/23/3a/5df9735f.jpg" width="30px"><span>董朱明</span> 👍（60） 💬（3）<div>69年的极限问题不难解决，timestamp减个常量就可以了，对于已生成的历史id，可以导表刷id，当然，这里涉及到个数据库设计原则，系统之间传递数据不应使用物理主键，这样刷id 就容易了</div>2018-08-10</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/3XbCueYYVWTiclv8T5tFpwiblOxLphvSZxL4ujMdqVMibZnOiaFK2C5nKRGv407iaAsrI0CDICYVQJtiaITzkjfjbvrQ/132" width="30px"><span>有铭</span> 👍（3） 💬（1）<div>为啥最后一段是12的长度而不是别的数</div>2018-08-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cf/5c/d4e19eb6.jpg" width="30px"><span>安小依</span> 👍（2） 💬（1）<div>老师自己有没有计划，针对分布式单独出一个专栏，一直以来自己都想研究分布式，但是很多问题依旧搞不懂: zookeeper 选举过程、hdfs 存储出现故障namenode是怎么处理、MapReduce 作业调度问题需要做哪些权衡，不同异常下应该怎么解决，是忽略错误，还是直接退出…各个方案背后是什么样的利弊在协调着这些…</div>2018-08-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/2e/8b/32a8c5a0.jpg" width="30px"><span>卡特</span> 👍（31） 💬（1）<div>因为snowflake的可预测性，可以提前生成好放到队列里，获取的时候直接获取。相当于做了一层缓存；
理论上可以解决短时间大量获取id的需求；</div>2018-09-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/45/9e/57e18908.jpg" width="30px"><span>袁伟</span> 👍（11） 💬（2）<div>一直有个疑问就是Snowflake 文中说的极限问题，目前确定它只能用69年，大家都用数据库的数字类型来存储，那么到了69年之后，后来人怎么处理，也许那个时候有更大数字来表示。但我还是想不出更合理的方式，也许我想多了，这个问题交给69年后的人来考虑，但我也想知道老师您是如何思考这个问题的</div>2018-08-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/2b/8a/b99b5a2d.jpg" width="30px"><span>大西瓜</span> 👍（8） 💬（0）<div>缩减workID长度，增加序列号长度</div>2018-08-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/30/8a/b5ca7286.jpg" width="30px"><span>业余草</span> 👍（7） 💬（0）<div>19 年写的《5 大分布式 ID 生成器优缺点简单对比》值得一看，https:&#47;&#47;mp.weixin.qq.com&#47;s&#47;OnH7Xrow5-TlkAh5gxz_XQ</div>2020-07-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/72/84/3f116ac8.jpg" width="30px"><span>大继</span> 👍（7） 💬（0）<div>非常感谢大佬的教程，面试是我进步最快的状态， 这种状态维持一年，估计我可以上天，终于看完了。 。 总结，大佬给出的教程非常有营养，也看到大家都要看几遍，我也是一边看一边百度。 受益匪浅。</div>2019-12-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/fc/38/59dda970.jpg" width="30px"><span>RoverYe</span> 👍（5） 💬（0）<div>我们这边利用zk的唯一id特性</div>2018-09-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/b4/1a/baf765a4.jpg" width="30px"><span>影子</span> 👍（3） 💬（0）<div>生成32位的自增长Id(int)老师有什么思路嘛</div>2019-01-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/22/89/5757eb43.jpg" width="30px"><span>XiaoYeGe</span> 👍（3） 💬（0）<div>前后历时半年多 终于看完了, 下面就是再回头巩固一遍!</div>2018-11-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/ef/0e/7abc67bf.jpg" width="30px"><span>三碗猪脚</span> 👍（2） 💬（1）<div>关于第二个问题，Snowflake 是否受冬令时切换影响？
冬令时不是回拨一个小时吗？那例如我10月3号3时被回拨10月3号2时，中间是走了两次的，到当前时间也会重复，不是吗？</div>2019-07-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/01/7c/836cf29e.jpg" width="30px"><span>Yang.🍭</span> 👍（2） 💬（3）<div>使用System.currentTimeMillis的话不是存在时钟回拨问题么，能不能从网络获取时间，去生成这个😂😂</div>2018-09-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f9/e3/2529c7dd.jpg" width="30px"><span>吴科🍀</span> 👍（1） 💬（0）<div>我们通常用UUID或者数据自增主键，这样的方式效率都不高。snowflake分布式全局生成的ID，效率高，设计优雅。</div>2018-12-29</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/6KJcYf8PnO0knxk6EDCETYQHc19KMiaBW2U6EVdPKYNOjObiaibm46KjbJtL5WS5cg7HVY7nEIqiakCgWEg137Okbw/132" width="30px"><span>airong</span> 👍（1） 💬（1）<div>请问大牛10集群编号怎么获取的啊</div>2018-12-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/65/9c/5c94692c.jpg" width="30px"><span>_关旭_</span> 👍（0） 💬（0）<div>一搬资源池里面都有时钟机器的，所有资源均向其同步即可，除非时钟机器发生时钟回拨，短时间内应该没事的，毕竟其他的就是运行一段时间后才会发生时钟不对。</div>2021-06-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/98/bc/6d5affd3.jpg" width="30px"><span>大风歌</span> 👍（0） 💬（1）<div>第一遍结束</div>2020-01-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/03/c9/9a9d82ab.jpg" width="30px"><span>Aaron_涛</span> 👍（0） 💬（0）<div>能讲下下时钟偏斜和时钟回拨吗，不是理解</div>2018-08-07</li><br/>
</ul>