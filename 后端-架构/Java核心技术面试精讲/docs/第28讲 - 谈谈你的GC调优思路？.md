我发现，目前不少外部资料对G1的介绍大多还停留在JDK 7或更早期的实现，很多结论已经存在较大偏差，甚至一些过去的GC选项已经不再推荐使用。所以，今天我会选取新版JDK中的默认G1 GC作为重点进行详解，并且我会从调优实践的角度，分析典型场景和调优思路。下面我们一起来更新下这方面的知识。

今天我要问你的问题是，谈谈你的GC调优思路？

## 典型回答

谈到调优，这一定是针对特定场景、特定目的的事情， 对于GC调优来说，首先就需要清楚调优的目标是什么？从性能的角度看，通常关注三个方面，内存占用（footprint）、延时（latency）和吞吐量（throughput），大多数情况下调优会侧重于其中一个或者两个方面的目标，很少有情况可以兼顾三个不同的角度。当然，除了上面通常的三个方面，也可能需要考虑其他GC相关的场景，例如，OOM也可能与不合理的GC相关参数有关；或者，应用启动速度方面的需求，GC也会是个考虑的方面。

基本的调优思路可以总结为：

- 理解应用需求和问题，确定调优目标。假设，我们开发了一个应用服务，但发现偶尔会出现性能抖动，出现较长的服务停顿。评估用户可接受的响应时间和业务量，将目标简化为，希望GC暂停尽量控制在200ms以内，并且保证一定标准的吞吐量。
- 掌握JVM和GC的状态，定位具体的问题，确定真的有GC调优的必要。具体有很多方法，比如，通过jstat等工具查看GC等相关状态，可以开启GC日志，或者是利用操作系统提供的诊断工具等。例如，通过追踪GC日志，就可以查找是不是GC在特定时间发生了长时间的暂停，进而导致了应用响应不及时。
- 这里需要思考，选择的GC类型是否符合我们的应用特征，如果是，具体问题表现在哪里，是Minor GC过长，还是Mixed GC等出现异常停顿情况；如果不是，考虑切换到什么类型，如CMS和G1都是更侧重于低延迟的GC选项。
- 通过分析确定具体调整的参数或者软硬件配置。
- 验证是否达到调优目标，如果达到目标，即可以考虑结束调优；否则，重复完成分析、调整、验证这个过程。
<div><strong>精选留言（26）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/ff/a5/eccc7653.jpg" width="30px"><span>clz1341521</span> 👍（66） 💬（2）<div>1,首先通过printgcdetail 查看fullgc频率以及时长
2,通过dump 查看内存中哪些对象多，这些可能是引起fullgc的原因，看是否能优化
3,如果堆大或者是生产环境，可以开起jmc 飞行一段时间，查看这期间的相关数据来订位问题
</div>2018-08-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/42/4f/ff1ac464.jpg" width="30px"><span>又双叒叕是一年啊</span> 👍（20） 💬（4）<div>FullGc可通过Gc日志 或者添加fullgc前后堆dump 查看引起fullgc原因  CPU飙升可以看看jstack</div>2018-07-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/aa/1e/e7ba85d9.jpg" width="30px"><span>半个西瓜</span> 👍（12） 💬（1）<div>老师，为什么 G1 对大堆非常友好。是因为运行机制也需要浪费一定的空间？</div>2019-01-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0f/bd/7a9b2a0c.jpg" width="30px"><span>潇洒的毅小峰</span> 👍（11） 💬（1）<div>老师要快点更新啊感觉到26更不完，校招马上开始了呢，学的不亦乐乎</div>2018-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/42/4f/ff1ac464.jpg" width="30px"><span>又双叒叕是一年啊</span> 👍（6） 💬（3）<div>请问Remembered Set和cardtable关系是怎么样的？他们之间是如何协作一起完成g1 gc的？</div>2018-07-16</li><br/><li><img src="" width="30px"><span>蘅</span> 👍（4） 💬（1）<div>-XX:+PrintGCDetails
-XX:+PrintGCDateStamps
这两个参数可用于CMS GC下吗？还是只能用于G1 GC?</div>2018-08-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0c/49/d71e939d.jpg" width="30px"><span>三口先生</span> 👍（3） 💬（1）<div>jmap指令加不加live，分析是否是内存泄漏或者是请求的内存处理不过来等原因。</div>2018-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/26/90/f68608f3.jpg" width="30px"><span>gwl</span> 👍（10） 💬（1）<div>遇到过线上系统卡顿的情况。业务反应系统登录不上，用top -p -h 和 jstack 发现是gc线程（数量和内核数一致且线程编号连续），排查内存中对象数量 (jmap -histo:live javaPid) 和 请求日志(elk或者log4j日志)，发现是生成excel数据太多，一下子把老年代给撑爆了，导致疯狂的full gc。
后将excel生成类临时替换成 SXSSFWorkbook 就暂时没有出现过。</div>2020-06-12</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/FmjAcibbIH7AH7Zwy5RZg6BMsjWTib8iaY6VhY7ibouZWWhpMX3RoJicgeiapUdK2iaSbatQYZFU3PdUPGjl5TqJnxTnQ/132" width="30px"><span>蓝伽图</span> 👍（9） 💬（0）<div>1.查看full gc的频率和时间，以及回收前和回收后老年代回收了多少垃圾
2.如果回收的垃圾很多，比如 80%-&gt;20% 考虑业务是否有可以优化的地方，是否有同类型对象短时间大量过期，可以在内存高位执行 dump  然后等full gc 后再dump做对比
3.如果回收的垃圾比较少，执行dump，查看哪些对象占用了大部分空间，是不是发生了内存泄露，引用都被哪些对象持有，是否应该及时释放等。</div>2020-06-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7e/bb/947c329a.jpg" width="30px"><span>程序员小跃</span> 👍（9） 💬（0）<div>前面的课程还行，接触了垃圾收集这几节课，感觉这课程真的很赞，把我很多自信都打败了，要好好学习</div>2019-04-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f1/d7/a52e390d.jpg" width="30px"><span>Pantheon</span> 👍（3） 💬（0）<div>杨老师能不能具体讲讲cms，这个垃圾回收似乎用的还挺多的，昨天上官网介绍的也不是很详细能不能说说原理以及参数优化的东西，感谢了</div>2018-07-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/42/4f/ff1ac464.jpg" width="30px"><span>又双叒叕是一年啊</span> 👍（3） 💬（0）<div>感谢了这么晚还在回复.点赞了</div>2018-07-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/7d/4d/d98865b2.jpg" width="30px"><span>老实人Honey</span> 👍（2） 💬（0）<div>这一集有难度了，平时接触得少，初步读来能吸收的真有限。:(</div>2018-07-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/f7/d4/2e8701be.jpg" width="30px"><span>ByteMan</span> 👍（1） 💬（1）<div>请问不同年代的GC会分别进行标记吗？还是说不同年代会对整个堆整体标记一次</div>2018-12-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/42/4f/ff1ac464.jpg" width="30px"><span>又双叒叕是一年啊</span> 👍（1） 💬（0）<div>如果dump堆太大.我觉得可以先通过jmap -heap看下是哪个区占用特别多.再看下对内存占用前20到30的大对象.然后结合jstat gccuase 查看下引起Gc原因 .目前想到这些思路请问还有更好的工具？jconsole jdb远程连接查看占用？</div>2018-07-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/42/4f/ff1ac464.jpg" width="30px"><span>又双叒叕是一年啊</span> 👍（1） 💬（0）<div>Remembered Set和cardtable 是什么关系什么时候使用能说明下这个过程吗</div>2018-07-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/3e/cb/a0624173.jpg" width="30px"><span>小刚</span> 👍（1） 💬（0）<div>老师讲的很到位，看得不是很明白，得多看几遍。</div>2018-07-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7b/99/4f5857a8.jpg" width="30px"><span>竹影</span> 👍（0） 💬（0）<div>堆内存使用达到InitiatingHeapOccupancyPercent的阈值，没有触发 mix gc导致堆内存达到90%，可能是什么问题呢？找了很多文章，都没有解释清楚。</div>2023-06-07</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJkKNKezgVwH4EnyLvfib2W2DaRC2U3q3kYDySK5HPPCSWicgtQgicX68UODich1I1FQaGkQ8Vk2pLpibA/132" width="30px"><span>随遇而安</span> 👍（0） 💬（0）<div>请问一下老师文中提到的“逃逸失败”能否解释一下是什么意思？万分感谢</div>2021-02-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/43/dc/95d4f2c5.jpg" width="30px"><span>林毅鑫</span> 👍（0） 💬（0）<div>一边看这个学习，一边拿这些问题提问🤭🤭🤭</div>2020-11-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/76/48/5ab89daa.jpg" width="30px"><span>护爽使者</span> 👍（0） 💬（0）<div>线上问题都怎么解决的？死锁， top 100%等</div>2020-03-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0b/34/f41d73a4.jpg" width="30px"><span>王盛武</span> 👍（0） 💬（0）<div>字符串排重的特性,  是JDK哪个版本提供的?</div>2019-11-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/23/72/70190bc1.jpg" width="30px"><span>子不语</span> 👍（0） 💬（0）<div>老师，咨询个问题，我通过jinfo -flag +PrintGC PID  jinfo -flag +PrintGCDetails PID，没办法指定路径，gc日志输出在哪里的，找不到。</div>2019-06-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/1b/18/80b4d8ae.jpg" width="30px"><span>Sunny Li</span> 👍（0） 💬（0）<div>老师，我想问一下除了dump文件和gc日志，还可以使用什么工具可以用&#39;jconsole吗，具体关注那几个参数</div>2018-09-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/18/22/e817914c.jpg" width="30px"><span>于海</span> 👍（0） 💬（0）<div>这个问题真的很难，如果没有实际的生产经验，真的很难回答，麻烦老师能给提供一些参考方案吗？谢谢您～</div>2018-07-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/42/4f/ff1ac464.jpg" width="30px"><span>又双叒叕是一年啊</span> 👍（0） 💬（1）<div>Remembered Set和cardtable的关系是什么？他们什么时候使用能说明下吗</div>2018-07-16</li><br/>
</ul>