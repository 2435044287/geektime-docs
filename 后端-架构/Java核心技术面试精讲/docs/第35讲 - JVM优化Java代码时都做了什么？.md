我在专栏上一讲介绍了微基准测试和相关的注意事项，其核心就是避免JVM运行中对Java代码的优化导致失真。所以，系统地理解Java代码运行过程，有利于在实践中进行更进一步的调优。

今天我要问你的问题是，JVM优化Java代码时都做了什么？

与以往我来给出典型回答的方式不同，今天我邀请了隔壁专栏[《深入拆解Java虚拟机》](http://time.geekbang.org/column/intro/108?utm_source=app&utm_medium=article&utm_campaign=108-presell&utm_content=java)的作者，同样是来自Oracle的郑雨迪博士，让他以JVM专家的身份去思考并回答这个问题。

## 来自JVM专栏作者郑雨迪博士的回答

JVM在对代码执行的优化可分为运行时（runtime）优化和即时编译器（JIT）优化。运行时优化主要是解释执行和动态编译通用的一些机制，比如说锁机制（如偏斜锁）、内存分配机制（如TLAB）等。除此之外，还有一些专门用于优化解释执行效率的，比如说模版解释器、内联缓存（inline cache，用于优化虚方法调用的动态绑定）。

JVM的即时编译器优化是指将热点代码以方法为单位转换成机器码，直接运行在底层硬件之上。它采用了多种优化方式，包括静态编译器可以使用的如方法内联、逃逸分析，也包括基于程序运行profile的投机性优化（speculative/optimistic optimization）。这个怎么理解呢？比如我有一条instanceof指令，在编译之前的执行过程中，测试对象的类一直是同一个，那么即时编译器可以假设编译之后的执行过程中还会是这一个类，并且根据这个类直接返回instanceof的结果。如果出现了其他类，那么就抛弃这段编译后的机器码，并且切换回解释执行。
<div><strong>精选留言（17）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/16/53/03930a6b.jpg" width="30px"><span>BY</span> 👍（14） 💬（9）<div>profile是啥意思。。。</div>2018-07-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/22/75/e17ee93a.jpg" width="30px"><span>傑</span> 👍（7） 💬（1）<div>第二个图没有看太明白</div>2018-07-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/2b/5c/a00fef79.jpg" width="30px"><span>杨东yy</span> 👍（2） 💬（1）<div>老师，请问下，整个内容有ppt么，我这快整体总结下，在做思考，如果有的话，希望可以提供下，可以节约我一些时间，感谢</div>2018-07-27</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/E1X9XzIJkqMpMZX6uicoq1WuNuibkpJXLxdMFVOF2g7hMfXrRTBfY2LYymCvfsoKgCOiaYo894qpaEyWI7libNSXOA/132" width="30px"><span>armado</span> 👍（8） 💬（1）<div>这一讲真的难啊，基本没看懂。</div>2019-03-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/07/63/a9e1ff40.jpg" width="30px"><span>Lynn</span> 👍（6） 💬（0）<div>code cache 既然不能动态调整大小 为什么还有初始大小这个参数</div>2019-05-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/7a/03/c9b43b21.jpg" width="30px"><span>BewhY</span> 👍（5） 💬（1）<div>这一章感觉没几个人能看得懂，那些平时说老师讲的很浅的人呢？</div>2019-09-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c0/6c/29be1864.jpg" width="30px"><span>随心而至</span> 👍（3） 💬（0）<div>我觉得，这个问题的涉及面非常广，不是专门做这个的，了解一下就行了，不懂其实也没关系，毕竟社会分工不同。
真的想学JVM的，可以参考R大的豆列
https:&#47;&#47;www.douban.com&#47;doulist&#47;2545443&#47;</div>2021-01-07</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/ZEUY0xPncofNx0djiaAnYRClAibkLIq4mGcx2Re7jsne2f6qLgiaByiaicxr18BpQeIXYxCrvQmsFTp5X3LQkR43micA/132" width="30px"><span>Geek_65a596</span> 👍（3） 💬（0）<div>final对性能的影响看看字节码就知道了
，也可以通过查看编译详情查看</div>2019-03-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/16/5b/83a35681.jpg" width="30px"><span>Monday</span> 👍（2） 💬（4）<div>这章看了好多遍，却还是感觉不好理解。当然郑雨迪老师的课，我也已经订阅了。会抽时间慢慢消化</div>2020-07-01</li><br/><li><img src="" width="30px"><span>achenbj</span> 👍（1） 💬（0）<div>感觉去面试了才准备有点晚啊...</div>2018-11-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/24/3e/692a93f7.jpg" width="30px"><span>茶底</span> 👍（1） 💬（0）<div>老师下一期能不能加点模块化的东西啊</div>2018-07-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ef/e8/076a6f59.jpg" width="30px"><span>张翀</span> 👍（0） 💬（0）<div>C1 C2的数值是什么意思  前面讲过  但是忘了😂</div>2022-07-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ff/d1/28adb620.jpg" width="30px"><span>蒙奇•D•273°</span> 👍（0） 💬（0）<div>这章内容不错</div>2020-11-04</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eq5rPOOXGnzcSUD7O14DEHE55gxtS09Uic5nqYEliask4nhozufHia0Ktc7xZH3B6YeTVza6ZNejAupQ/132" width="30px"><span>wt</span> 👍（0） 💬（0）<div>&quot;偏向锁的撤销会触发安全点&quot;。这句是不是有点问题，是否是&quot;偏向锁的撤销需要等待安全点&quot;？可能效果一样，因为不到安全点线程还需要等待，同样不能执行</div>2020-03-25</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/tKvmZ3Vs4t6RZ3X7cAliaW47Zatxhn1aV5PcCYT9NZ9k9WWqRrEBGHicGtRWvsG6yQqHnaWw6cGNSbicNLjZebcHA/132" width="30px"><span>柳十三</span> 👍（0） 💬（0）<div>循环有final和无final的情况，打印循环前后的时间，比较两种情况的时间差</div>2020-03-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/e3/f4/ecb33aef.jpg" width="30px"><span>流光</span> 👍（0） 💬（0）<div>方法复用,调用次数多了就可以成为热点方法了,有这方面的意思吗</div>2019-04-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/22/89/5757eb43.jpg" width="30px"><span>XiaoYeGe</span> 👍（0） 💬（3）<div>好容易学到这儿了，几个月了，我是不是有点菜。现在才看到这儿。嗯嗯，我是很菜。杨大神，后续考虑出一些视频课程吗？😂 🤓 🤓 🤓 🤓 </div>2018-09-07</li><br/>
</ul>