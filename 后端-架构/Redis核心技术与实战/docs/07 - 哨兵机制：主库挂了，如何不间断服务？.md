你好，我是蒋德钧。

上节课，我们学习了主从库集群模式。在这个模式下，如果从库发生故障了，客户端可以继续向主库或其他从库发送请求，进行相关的操作，但是如果主库发生故障了，那就直接会影响到从库的同步，因为从库没有相应的主库可以进行数据复制操作了。

而且，如果客户端发送的都是读操作请求，那还可以由从库继续提供服务，这在纯读的业务场景下还能被接受。但是，一旦有写操作请求了，按照主从库模式下的读写分离要求，需要由主库来完成写操作。此时，也没有实例可以来服务客户端的写操作请求了，如下图所示：

![](https://static001.geekbang.org/resource/image/d8/20/d828d7eee133cec690dc140e99e26f20.jpg?wh=3371%2A2250 "主库故障后从库无法服务写操作")

无论是写服务中断，还是从库无法进行数据同步，都是不能接受的。所以，如果主库挂了，我们就需要运行一个新主库，比如说把一个从库切换为主库，把它当成主库。这就涉及到三个问题：

1. 主库真的挂了吗？
2. 该选择哪个从库作为主库？
3. 怎么把新主库的相关信息通知给从库和客户端呢？

这就要提到哨兵机制了。在Redis主从集群中，哨兵机制是实现主从库自动切换的关键机制，它有效地解决了主从复制模式下故障转移的这三个问题。

接下来，我们就一起学习下哨兵机制。

## 哨兵机制的基本流程

哨兵其实就是一个运行在特殊模式下的Redis进程，主从库实例运行的同时，它也在运行。哨兵主要负责的就是三个任务：监控、选主（选择主库）和通知。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/13/16/5b/83a35681.jpg" width="30px"><span>Monday</span> 👍（102） 💬（26）<div>1、master_repl_offset是存储在主库的，但主库已经挂了，怎么获取的这个值？
可否这样理解，master_repl_offset如事物id一样单调递增，这样的话，就只要不叫从库的slave_repl_offset就行。
至于master_repl_offset真实位置可以对master_repl_offset取模就行。</div>2020-08-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7a/0a/0ce5c232.jpg" width="30px"><span>吕</span> 👍（58） 💬（3）<div>关于第二步，根据master_repl_offset和slave_repl_offset来比较，但此时master已经挂掉了，哨兵如何知道master_repl_offset的，难道哨兵也会存一份主的master_repl_offset？根据之前的学习，salve是不存储master_repl_offset的</div>2020-08-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ed/11/c296d424.jpg" width="30px"><span>Oracleblog</span> 👍（25） 💬（5）<div>主从切换选出新的主后，新的从库同步是需要做一次全量同步吗？</div>2020-08-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/dd/9b/0bc44a78.jpg" width="30px"><span>yyl</span> 👍（17） 💬（2）<div>解答：
1.1 绝大部分的读请求，可以响应。由于主库实例挂掉，肯定有小部分数据未被同步至从实例，而这部分数据的读请求是失败的。
1.2 由于主从机制实现了读写分离，主实例挂掉，无法响应写请求。

2. 暂时没想到，看了课代表的解答，蛮详细的</div>2020-08-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（10） 💬（1）<div>Redis 的实例ID是根据什么进行生成的？</div>2020-08-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a5/30/4be78ce7.jpg" width="30px"><span>徐鹏</span> 👍（9） 💬（1）<div>有两个问题想请教哈
1.每一个哨兵实例都有整个redis集群的信息，会和每一个redis实例通信吗？
2.在选主过程中，比较从库的salve_repl_offset，是把每个从库salve_repl_offset相互比较还是和master_repl_offset比较？原来的主库不是已经挂了，master_repl_offset 是如何获取到的呢？</div>2020-08-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/67/d5/1b26b725.jpg" width="30px"><span>Gopher</span> 👍（7） 💬（2）<div>读了后面的一篇文章想到在主从切换过程中如何让客户端无感知的解决方案：
业务系统也可以订阅对应的状态事件，每次进行写请求的时候，判断下状态，如果是处于切换状态可以，先写入到队列中。</div>2021-01-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/20/08/bc06bc69.jpg" width="30px"><span>Dovelol</span> 👍（7） 💬（2）<div>老师好，想问下，redis哨兵机制中，每个哨兵就是通过发布消息互相感知的吗？没有在启动时就指定对应哨兵集群的所有ip。</div>2020-08-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg" width="30px"><span>Darren</span> 👍（6） 💬（11）<div>肯定会中断的，但是这么让客户端无感知，说说可能不成熟的想法，请老师和大家指点：
	1、如果是读请求，可以直接读取从库，客户端无影响；
	2、如果是写请求，可以先把命令缓存到哨兵中（比如说哨兵内部维护一个队列等），等选主成功后，在新的主库进行执行即可。</div>2020-08-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/9f/c0/86febfff.jpg" width="30px"><span>Master</span> 👍（5） 💬（4）<div>在优先级和复制进度都相同的情况下，ID 号最小的从库得分最高，会被选为新主库。这种原则是因为啥啊？id号小，为啥得分高啊</div>2020-12-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/d1/fe/2ca6f40a.jpg" width="30px"><span>影山飞雄</span> 👍（0） 💬（3）<div>在哨兵打分的第一轮，假设用户设置了高优先级的从库，因此正常就直接选出主库了，但是如果存在第二轮打分中选出的从库的偏移量不是最大的，这样选出的主库可能就不是最优选择，这种情况存在吗？如果用户不设置优先级，感觉通过后面的判断更重要和合理</div>2020-12-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg" width="30px"><span>那时刻</span> 👍（0） 💬（1）<div>在主从切换的时候，由哨兵把新请求倒流到新的主节点？切换完成之后，需要客户端切换到新的主节点操作</div>2020-08-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg" width="30px"><span>Kaito</span> 👍（976） 💬（72）<div>哨兵在操作主从切换的过程中，客户端能否正常地进行请求操作？

如果客户端使用了读写分离，那么读请求可以在从库上正常执行，不会受到影响。但是由于此时主库已经挂了，而且哨兵还没有选出新的主库，所以在这期间写请求会失败，失败持续的时间 = 哨兵切换主从的时间 + 客户端感知到新主库 的时间。

如果不想让业务感知到异常，客户端只能把写失败的请求先缓存起来或写入消息队列中间件中，等哨兵切换完主从后，再把这些写请求发给新的主库，但这种场景只适合对写入请求返回值不敏感的业务，而且还需要业务层做适配，另外主从切换时间过长，也会导致客户端或消息队列中间件缓存写请求过多，切换完成之后重放这些请求的时间变长。

哨兵检测主库多久没有响应就提升从库为新的主库，这个时间是可以配置的（down-after-milliseconds参数）。配置的时间越短，哨兵越敏感，哨兵集群认为主库在短时间内连不上就会发起主从切换，这种配置很可能因为网络拥塞但主库正常而发生不必要的切换，当然，当主库真正故障时，因为切换得及时，对业务的影响最小。如果配置的时间比较长，哨兵越保守，这种情况可以减少哨兵误判的概率，但是主库故障发生时，业务写失败的时间也会比较久，缓存写请求数据量越多。

应用程序不感知服务的中断，还需要哨兵和客户端做些什么？当哨兵完成主从切换后，客户端需要及时感知到主库发生了变更，然后把缓存的写请求写入到新库中，保证后续写请求不会再受到影响，具体做法如下：

哨兵提升一个从库为新主库后，哨兵会把新主库的地址写入自己实例的pubsub（switch-master）中。客户端需要订阅这个pubsub，当这个pubsub有数据时，客户端就能感知到主库发生变更，同时可以拿到最新的主库地址，然后把写请求写到这个新主库即可，这种机制属于哨兵主动通知客户端。

如果客户端因为某些原因错过了哨兵的通知，或者哨兵通知后客户端处理失败了，安全起见，客户端也需要支持主动去获取最新主从的地址进行访问。

所以，客户端需要访问主从库时，不能直接写死主从库的地址了，而是需要从哨兵集群中获取最新的地址（sentinel get-master-addr-by-name命令），这样当实例异常时，哨兵切换后或者客户端断开重连，都可以从哨兵集群中拿到最新的实例地址。

一般Redis的SDK都提供了通过哨兵拿到实例地址，再访问实例的方式，我们直接使用即可，不需要自己实现这些逻辑。当然，对于只有主从实例的情况，客户端需要和哨兵配合使用，而在分片集群模式下，这些逻辑都可以做在proxy层，这样客户端也不需要关心这些逻辑了，Codis就是这么做的。

另外再简单回答下哨兵相关的问题：

1、哨兵集群中有实例挂了，怎么办，会影响主库状态判断和选主吗？

这个属于分布式系统领域的问题了，指的是在分布式系统中，如果存在故障节点，整个集群是否还可以提供服务？而且提供的服务是正确的？

这是一个分布式系统容错问题，这方面最著名的就是分布式领域中的“拜占庭将军”问题了，“拜占庭将军问题”不仅解决了容错问题，还可以解决错误节点的问题，虽然比较复杂，但还是值得研究的，有兴趣的同学可以去了解下。

简单说结论：存在故障节点时，只要集群中大多数节点状态正常，集群依旧可以对外提供服务。具体推导过程细节很多，大家去查前面的资料了解就好。

2、哨兵集群多数实例达成共识，判断出主库“客观下线”后，由哪个实例来执行主从切换呢？

哨兵集群判断出主库“主观下线”后，会选出一个“哨兵领导者”，之后整个过程由它来完成主从切换。

但是如何选出“哨兵领导者”？这个问题也是一个分布式系统中的问题，就是我们经常听说的共识算法，指的是集群中多个节点如何就一个问题达成共识。共识算法有很多种，例如Paxos、Raft，这里哨兵集群采用的类似于Raft的共识算法。

简单来说就是每个哨兵设置一个随机超时时间，超时后每个哨兵会请求其他哨兵为自己投票，其他哨兵节点对收到的第一个请求进行投票确认，一轮投票下来后，首先达到多数选票的哨兵节点成为“哨兵领导者”，如果没有达到多数选票的哨兵节点，那么会重新选举，直到能够成功选出“哨兵领导者”。</div>2020-08-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/fd/fd/326be9bb.jpg" width="30px"><span>注定非凡</span> 👍（144） 💬（8）<div>一，作者讲了什么？
Redis故障转移：主从切换机制哨兵

二，作者是怎么把这事给讲明白的？
    1，提出主从切换的三个问题：a，主机状态确认  b，新主库选举  c，新主库通知
    2，讲解了哨兵的本质是一个特殊的redis进程（实例），有三个职责：监控，选主，通知

三，为了讲明白，作者讲了哪些要点，有哪些亮点？
    1，亮点1：哨兵的本质：是一个redis实例，要做三件事：监控主库，选举新主库，通知客户端和从机（这让我对哨兵理解清晰了很多）
    2，要点1：哨兵是通过心跳检测，监控主库状态，主库下线被分为：主观下线和客观下线、
    3，要点2：哨兵监控是可能误判的，所以哨兵一般是集群部署，采取投票的形式减少误判
    4，要点3：选定新主库规则是先筛选在打分，得分高的会被选为新主库，
    5，要点4：筛选规则：从库当前的网络连接状况，以及之前的网络连接状况，筛选中断次数标准可以配置
    6，要点5：打分规则：从库的优先级，数据同步状况，Id号大小，可以分为三轮，只要有一轮出现得分高的，就能选出

四，对作者所讲，我有哪些发散性思考？
    选举机制，在分布式的场景中经常出现。我在刚开始学习这一类知识的时候，经常会想：那些大神是怎么会想到这种解决方案的？
        后来读了一些西方社会运行机制的书，我有所释然。得到一些感悟：大神思考的技术问题解决方案，和他所生活的社会环境有着莫大的关系

五，将来在哪些场景，我能够使用到它？
    
六，留言区的收获
    1，数据同步状况的判断：（感谢@Monday 同学的提问）
            a：判断哪个从库的数据同步最接近主库，不是拿从库与主库比较，而是从库之间互相比较，谁大谁就是最接近的
            b：这样做的原因有二：主库已下线无法获取主库信息，环形缓冲区的位置偏移量是单调递增的（主库的被称为：master_repl_offset，从库的被称为：slave_repl_offset，其实两者本质是相同的，叫不同的名字只是为了区分）
    2，哨兵的使用：（感谢 @Kaito 大神简洁明了，无私的分享）
            a：主库下线，可读不可写，写失败的时间=哨兵切换主从的时间+客户端感知新主库时间
            b：主库下线无感知，需要客户端与哨兵配合改造：
                      1：哨兵主动通知：哨兵需要将最新的主库地址写入自己的pubsub中，客户端需要订阅这个pubsub，当这个pubsub有数据时，客户端就能感知到
                      2：客户端主动获取：客户端不将主从库写死，而是从哨兵集群中获取，从而始终获取最新的主从地址
            c：集群分片模式的Redis集群，可以不使用哨兵机制（我们项目组就是这样的）
                                </div>2020-08-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/23/5b/983408b9.jpg" width="30px"><span>悟空聊架构</span> 👍（106） 💬（14）<div>这篇当中提到了很多分布式的理论，但没有细讲，我这里可以再补充下分布式理论相关的内容。希望对大家有所帮助：

现在很多开发同学对分布式的组件怎么使用都有一定经验，也知道 `CAP` 理论和 `BASE` 理论的大致含义。但认真去看分布式算法的真的很少，原因有三：

- 担心算法过于复杂，所以花的时间很少。
- 网上的资料能用大白话将分布式算法讲清楚的比较少。
- 学习分布式算法没有一条清晰的路线。

学习分布式协议和算法的路线可以是先学习四大基础理论，作为地基。然后再学习分布式协议和算法。就像是在地基上建房子，地基打好了，才能建更稳固的高楼大厦。

而分布式理论主要有四大块：

四大基础理论

- 拜占庭将军问题
- CAP 理论
- ACID 理论
- BASE 理论

分布式协议和算法主要有八种：

八大分布式协议和算法

- Paxos 算法
- Raft 算法
- 一致性 Hash 算法
- Gossip 协议算法
- Quorum NWR 算法
- FBFT 算法
- POW 算法
- ZAB 协议

如何高效地学习和掌握？

开发分布式系统最关键的就是根据场景特点，选择合适的算法，在一致性和可用性之间妥协折中，而如何做好折中方案，依赖于是否真正理解了各算法的特点。

讲真，如果认真学习这些理论和算法，并清楚了每个算法的特点，适合怎样的场景，当开发分布式系统时，做到知己知彼，才能旗开得胜，实际场景中的问题也能分析清楚并解决掉。

那么这些算法有哪些特点和适用场景，该从哪些方面考量？

分布式算法的四大维度

四大维度：拜占庭容错、一致性、性能、可用性。

这里我做了一个分布式算法四大维度的表格，大家可以对比下：

![分布式算法的对比](http:&#47;&#47;cdn.jayh.club&#47;blog&#47;20210317&#47;1plCsNXd82rh.png?imageslim)

拜占庭容错

拜占庭容错就是《拜占庭将军问题》中提出的一个模型，该模型描述了一个完全不可信的场景。不可信体现在：

- 故障行为。比如节点故障了。
- 恶意行为。比如恶意节点冒充正常节点，发出错误指令。

拜占庭容错的另外一面就是`非拜占庭容错`，又叫故障容错，解决了分布式系统存在故障，但是不存在恶意节点共识的问题，譬如节点所在服务器硬件故障、节点的服务进程崩溃等。

非拜占庭容错算法

在可信的环境，只需要具有故障容错能力，譬如 2PC、TCC、Paxos算法、Raft 算法、Gossip 协议、Ouorum NWR 算法、ZAB 协议。

#### 拜占庭容错算法

而在不可信的环境，需要具有拜占庭容错能力，报错 POW 算法、FBFT 算法。

一致性

一致性分为三种：

- 强一致性：保证写操作完成后，任何后续访问都能读到更新后的值。
- 弱一致性：写操作完成后，系统不能保证后续的访问都能读到更新后的值。
- 最终一致性：保证如果对某个对象没有新的写操作，最终所有后续访问都能读到相同的最近更新的值。

在数据库操作层面，我们多使用二阶段提交协议（2PC）保证强一致性。在分布式系统中，多使用 Raft 算法来保证强一致性。如果考虑可用性，则使用 Gossip 协议实现最终一致性，配合 Quorum NWR 算法的三个参数来调节容错能力。而 zookeeper 基于读性能的考虑，通过 ZAB 协议提供最终一致性。

可用性

可用性表示能得到响应数据，但不保证数据最新，强调服务可用。前提条件：访问的是非故障节点。

可用性最强的就是 Gossip 协议了，即时只有一个节点，集群可以提供服务。然后是 Paxos&#47;Raft&#47;ZAB&#47;Quorum NWR&#47;FBFT&#47;POW 算法，能够容忍部分节点故障。

而 2PC、TCC 要求所有节点都正常运行，系统才能正常工作，可用性最低。

性能

性能和可用性联系非常紧密，可用性越高，性能越强。

上面可用性的排序同样适用于性能维度。Gossip 协议可用于 AP 型分布式系统，水平扩展能力强，读写性能最强。

Paxos&#47;Raft&#47;ZAB&#47;Quorum NWR&#47;FBFT&#47;POW 算法都是领导者模型，写性能依赖领导者，读性能依赖一致性的实现。性能处于中等位置。

而 2PC、TCC 实现事务时，需要预留和锁定资源，性能较差。</div>2021-05-08</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJDaSBQoHdsOmFxbiayiaSmicpc5n55kic25xYwQIZoLJ41ucM9ib12yViapRd3O75tPiaPQ8icFXQnmVxiaPA/132" width="30px"><span>ym</span> 👍（7） 💬（9）<div>你好，老师，我有一个疑问，就是主库挂了之后，通过筛选机制选择了一个从库作为新的主库，但是不能保证这个新的主库（旧从库的slave_repl_offset）和之前的主库（旧主库的master_repl_offset）是相同的，有可能是slave_repl_offset &lt; master_repl_offset，那个即使选择了新的主库，那么数据也是丢失了一部分的，这个问题怎么解决呢。</div>2021-03-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/a4/27/15e75982.jpg" width="30px"><span>小袁</span> 👍（3） 💬（1）<div>老师，如果是主库挂了，从库被提升为主库，这我能够理解。但是你在前面某一篇文章中提到，主从同步最好是通过主从从的方式进行级联，这种拓扑结构下，如果机器或者redis出现问题，整个系统会变成怎样呢？这有点烧脑了</div>2020-08-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/fc/f3/28fe16cf.jpg" width="30px"><span>意琦行</span> 👍（2） 💬（2）<div>这个判断原则就是：少数服从多数。
按道理说主库下线了应该所有哨兵的结果都是下线才对呀，如果有一个哨兵检测为上线那主库肯定是上线状态吧，为什么这种情况也需要重新选举呢。</div>2020-10-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/ce/d7/5315f6ce.jpg" width="30px"><span>不负青春不负己🤘</span> 👍（2） 💬（1）<div>1 sentinel 集群 一般建议是3个节点 还是，多个节点， 怎么保证 sentinal 集群的高可用， 以及集群节点过多 ，会不会 导致选举时间过长，  sentinel 选举 类似于 变体raft 协议
2 能不能创建一个微信 或者QQ 群， 一些简单的问题 可以互相交流，</div>2020-08-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/1a/e4/5e2a8190.jpg" width="30px"><span>蔡欧</span> 👍（1） 💬（0）<div>如何解决Redis主库挂了，Redis依赖可以提供服务：使用哨兵，监控、切换和通知整个Redis集群
如何避免哨兵由于主观下线导致Redis切换：使用哨兵集群，采用少数服从多数的方式
哨兵选举的依据：优先级+进度+序号+网络状态监控(down-after-milliseconds时间内断链的次数)
Redis客户端如何自动切换：通过配置客户端哨兵集群配置，可以采用主读或者pubsub方式得到最新的Redis集群地址
如何百分百避免在Redis切换过程数据丢失：Redis切换导致写不可用范围为切换时间+客户端感知新Redis主的时间，这段时间导致Redis写不可用，1 把down-after-milliseconds配置改小，对Redis不可用更加敏感，但是可能导致误判  2 客户端改造成有降级措施，把不可用请求先写入消息队列中，后续等Redis可用后再进行重放</div>2022-08-21</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ8ic8eLTo5rnqIMJicUfpkVBrOUJAW4fANicKIbHdC54O9SOdwSoeK6o8icibaUbh7ZUXAkGF9zwHqo0Q/132" width="30px"><span>ivhong</span> 👍（1） 💬（0）<div>老师，我有个问题和迷惑，哨兵集群是独立于redis集群之外的一组新的服务器么？</div>2022-04-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/69/bc/c22bf219.jpg" width="30px"><span>妥妥</span> 👍（1） 💬（2）<div>老师，弱弱的问一下，主库挂了，从库与主库数据可能不一致，这个怎么处理？还是说可以允许数据不一致不做处理？</div>2022-02-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/d0/4d/91979d1a.jpg" width="30px"><span>登山看云海</span> 👍（1） 💬（1）<div>能否讲下客户端在这个过程中如何做到无感知</div>2020-10-23</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eo6waC1mF0VmQibDjnJLEgFnmEUSNJozibaUeYZkpQaqicVcXxGZ3kKtnY5XF0iblxT4oiam7ucuJ1bqgg/132" width="30px"><span>Geek_c37e49</span> 👍（1） 💬（0）<div>主从切换的时候应该是没办法响应写请求的，不过可以把请求缓存记录下来
读请求应该是可以服务的吧</div>2020-08-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/39/d7/9d/73390cc0.jpg" width="30px"><span>wild wings.Luv</span> 👍（0） 💬（0）<div>哨兵三个功能是三个线程并发实现的吗，还是单线程</div>2024-07-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/8d/d2/498cd2d1.jpg" width="30px"><span>程序员班吉</span> 👍（0） 💬（0）<div>如何判断主库挂了？
1. 哨兵机制，每个redis节点都运行了一个哨兵进程。
2. 哨兵进程会定时PING集群中的所有节点，如果在规定的时间内没有响应则主观判定为不可用
3. 最终的决策需要多个哨兵一起作出，多数服从少数。所以，最好的redis集群的数量策略应该是基数个

选举机制
1. 第一轮，先判断从库的网络状态，首先要确定从库的网络是正常的。如果是连通的，还要进一步判断网络是否稳定，而判断的依据是根据历史和主库的断连记录来判断，同一时间内，断连次数越多，说明越不稳定，评分越低。要说明的是这里的网络断连可能并不是连不上，而是通过设置一个超时时间，在这个时间内没有完成连接也会判定为断连。
2. 第二轮，判断从库的优先级，这个优先级是可以人为手动指定的，优先级越高，分数也就越高
3. 第三轮，判断从库同步的salve_backlog_offset，越大说明数据越新，得分也越高
4. 第四轮，如果前面几轮还是没有选出主库，最近通过比较从库的run ID，ID越小，得分越高

通过以上几轮的评分，最终一定会得到一个合适的主库</div>2023-07-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e0/cf/43f201f2.jpg" width="30px"><span>幼儿编程教学</span> 👍（0） 💬（1）<div>&gt;首先，哨兵会按照在线状态、网络状态，筛选过滤掉一部分不符合要求的从库，然后，依次按照优先级、复制进度、ID 号大小再对剩余的从库进行打分，只要有得分最高的从库出现，就把它选为新主库。

老师，请教下
- 最后3轮选主，一定会选出主的是吧？不会出现选不出来的，是吧？因为最后一轮id，应该所有实例都不同，总能分出大小
- 最后3轮选组，假设有3个从，第一轮按照优先级。假如优先级如下a 10，b 20，c 20。此时，bc都是20，无法选出最高。进入第二轮，复制进度。进入第二轮中，会有a么？a是否会在第一轮被淘汰了？还是只有没选出主，继续参加第二轮，第三轮选主？</div>2023-04-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ce/76/d9b8db4a.jpg" width="30px"><span>刘敏</span> 👍（0） 💬（0）<div>redis为什么不能设计成自主选主，必须借助哨兵？3.0的集群主的选举又不需要哨兵</div>2022-08-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/4c/89/82a3ee04.jpg" width="30px"><span>going</span> 👍（0） 💬（0）<div>有一个问题想要请教一下蒋老师，就是采用了哨兵集群后，对于从库下线的判定是否会采用“少数服从多数”还是之前那种由一个哨兵就可以决定？</div>2022-07-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2c/5e/43/004a52fa.jpg" width="30px"><span>樱桃汁。</span> 👍（0） 💬（0）<div>切换的时候客户端可以正常请求，但是只有读操作返回正常结果，写操作会失败，因为主库挂了，接收不到写操作，新的主库还没有到位无法进行写操作。
想要不感知中断，哨兵可以加一个功能：查询客户端写操作涉及的数据并判断是否该操作是否合法，如果合法记录该请求，并返回客户端成功，切换成功后把请求发给新主库。该操作不合法的话返回客户端失败。或者切换中直接客户端返回网络不好等失败</div>2022-06-04</li><br/>
</ul>