你好，我是蒋德钧。

上节课，我们学习了哨兵机制，它可以实现主从库的自动切换。通过部署多个实例，就形成了一个哨兵集群。哨兵集群中的多个实例共同判断，可以降低对主库下线的误判率。

但是，我们还是要考虑一个问题：如果有哨兵实例在运行时发生了故障，主从库还能正常切换吗？

实际上，一旦多个实例组成了**哨兵集群**，即使有哨兵实例出现故障挂掉了，其他哨兵还能继续协作完成主从库切换的工作，包括判定主库是不是处于下线状态，选择新主库，以及通知从库和客户端。

如果你部署过哨兵集群的话就会知道，在配置哨兵的信息时，我们只需要用到下面的这个配置项，设置**主库的IP**和**端口**，并没有配置其他哨兵的连接信息。

```
sentinel monitor <master-name> <ip> <redis-port> <quorum> 
```

这些哨兵实例既然都不知道彼此的地址，又是怎么组成集群的呢？要弄明白这个问题，我们就需要学习一下哨兵集群的组成和运行机制了。

## 基于pub/sub机制的哨兵集群组成

哨兵实例之间可以相互发现，要归功于Redis提供的pub/sub机制，也就是发布/订阅机制。

哨兵只要和主库建立起了连接，就可以在主库上发布消息了，比如说发布它自己的连接信息（IP和端口）。同时，它也可以从主库上订阅消息，获得其他哨兵发布的连接信息。当多个哨兵实例都在主库上做了发布和订阅操作后，它们之间就能知道彼此的IP地址和端口。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/36/2c/8bd4be3a.jpg" width="30px"><span>小喵喵</span> 👍（187） 💬（21）<div>老师请教下：
1、图示哨兵选举过程中，选举的结果取决于S2的投票，如果S2也投给自己，并且每轮投票都是只投给自己，岂不是无法选出“Leader”，是不是这个过程从了死循环呢？
2、投票投给谁，依据是什么？</div>2020-08-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg" width="30px"><span>Kaito</span> 👍（946） 💬（89）<div>Redis 1主4从，5个哨兵，哨兵配置quorum为2，如果3个哨兵故障，当主库宕机时，哨兵能否判断主库“客观下线”？能否自动切换？

经过实际测试，我的结论如下：

1、哨兵集群可以判定主库“主观下线”。由于quorum=2，所以当一个哨兵判断主库“主观下线”后，询问另外一个哨兵后也会得到同样的结果，2个哨兵都判定“主观下线”，达到了quorum的值，因此，哨兵集群可以判定主库为“客观下线”。

2、但哨兵不能完成主从切换。哨兵标记主库“客观下线后”，在选举“哨兵领导者”时，一个哨兵必须拿到超过多数的选票(5&#47;2+1=3票)。但目前只有2个哨兵活着，无论怎么投票，一个哨兵最多只能拿到2票，永远无法达到多数选票的结果。

但是投票选举过程的细节并不是大家认为的：每个哨兵各自1票，这个情况是不一定的。下面具体说一下：

场景a：哨兵A先判定主库“主观下线”，然后马上询问哨兵B（注意，此时哨兵B只是被动接受询问，并没有去询问哨兵A，也就是它还没有进入判定“客观下线”的流程），哨兵B回复主库已“主观下线”，达到quorum=2后哨兵A此时可以判定主库“客观下线”。此时，哨兵A马上可以向其他哨兵发起成为“哨兵领导者”的投票，哨兵B收到投票请求后，由于自己还没有询问哨兵A进入判定“客观下线”的流程，所以哨兵B是可以给哨兵A投票确认的，这样哨兵A就已经拿到2票了。等稍后哨兵B也判定“主观下线”后想成为领导者时，因为它已经给别人投过票了，所以这一轮自己就不能再成为领导者了。

场景b：哨兵A和哨兵B同时判定主库“主观下线”，然后同时询问对方后都得到可以“客观下线”的结论，此时它们各自给自己投上1票后，然后向其他哨兵发起投票请求，但是因为各自都给自己投过票了，因此各自都拒绝了对方的投票请求，这样2个哨兵各自持有1票。

场景a是1个哨兵拿到2票，场景b是2个哨兵各自有1票，这2种情况都不满足大多数选票(3票)的结果，因此无法完成主从切换。

经过测试发现，场景b发生的概率非常小，只有2个哨兵同时进入判定“主观下线”的流程时才可以发生。我测试几次后发现，都是复现的场景a。

哨兵实例是不是越多越好？

并不是，我们也看到了，哨兵在判定“主观下线”和选举“哨兵领导者”时，都需要和其他节点进行通信，交换信息，哨兵实例越多，通信的次数也就越多，而且部署多个哨兵时，会分布在不同机器上，节点越多带来的机器故障风险也会越大，这些问题都会影响到哨兵的通信和选举，出问题时也就意味着选举时间会变长，切换主从的时间变久。

调大down-after-milliseconds值，对减少误判是不是有好处？

是有好处的，适当调大down-after-milliseconds值，当哨兵与主库之间网络存在短时波动时，可以降低误判的概率。但是调大down-after-milliseconds值也意味着主从切换的时间会变长，对业务的影响时间越久，我们需要根据实际场景进行权衡，设置合理的阈值。</div>2020-08-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7a/0a/0ce5c232.jpg" width="30px"><span>吕</span> 👍（24） 💬（4）<div>这篇文章太好了，直接解决了一个困惑我很久的问题，我一直把判断下线和选主主当成了同一件事，把quorum当成是判断下线和选举leader的阀值，原来判断下线还选主是两个分开的事情</div>2020-08-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5f/e5/54325854.jpg" width="30px"><span>范闲</span> 👍（4） 💬（2）<div>哨兵判断下线分为可能下线和确定下线两种状态。
在课后的例子中，5个哨兵正常2个，异常3个，qurum为2（判断确定下线的哨兵数目）

根据主从选举要求必须半数以上的节点同意，即要求数量大于N&#47;2+1。此例中是5&#47;2+1＝3，而只有2个哨兵活着因此不可能完成主从切换。


而确定下线的数目为2，2个哨兵可以完成确定下线的判断。

</div>2020-08-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/20/3a/90/2ab62cd9.jpg" width="30px"><span>riryoutexi</span> 👍（2） 💬（5）<div>整个哨兵集群都挂了，还会主从切换吗</div>2020-08-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/fd/fd/326be9bb.jpg" width="30px"><span>注定非凡</span> 👍（106） 💬（10）<div>一，作者讲了什么？
哨兵集群的工作机制

二，作者是怎么把这事给讲明白的？
    1，哨兵之间互通机制：基于pub&#47;sub机制，在主库中有一个&quot;__sentinel__:hello&quot;的频道，哨兵之间互相发现通信
    2，哨兵与主从库互通机制：哨兵向主库发送INFO指令，可以获取所有从库的信息，实现对主库，从库的监控
    3，哨兵判定主库异常机制：哨兵集群中任意一个实例都可以发起主库异常“投票仲裁”流程

三，为了讲明白，作者都讲了哪些要点？有哪些亮点？
    1，亮点1：哨兵之间的互动是通过发布订阅机制完成的，利用自身的特性来实现。这让我联想到kafka对于日息位置偏移量的管理
    2，要点1：哨兵之间通信不是哨兵之间之间联系，而是通过订阅主库的同一频道来获取彼此的信息
    3，要点2：哨兵是通过INFO指令，从主库获取从库信息，并与每个从库建立连接，监控所有主从库状态
    4，要点3：哨兵是一个特殊的redis实例，所以客户端可以订阅哨兵的指定频道获得redis主从库的信息
    5，要点4：哨兵集群执行主从切换机制：谁发现，谁就发起投票流程，谁获得多数票，谁就是哨兵Leader，由Leader负责主从库切换
    6，要点5：哨兵集群Leader选举成功与否，依赖于网络通信状况，网络拥塞会导致选举失败，重新进行新一轮选举

四，对于作者所讲，我有哪些发散性思考？

五，在未来的哪些场景里，我可以使用它？

六，留言区的收获：（感谢 @ 小喵喵 的提问）
    1，哨兵投票机制：
            a：哨兵实例只有在自己判定主库下线时，才会给自己投票，而其他的哨兵实例会把票投给第一个来要票的请求，其后的都拒绝
            b：如果出现多个哨兵同时发现主库下线并给自己投票，导致投票选举失败，就会触发新一轮投票，直至成功

    2，哨兵Leader切换主从库的机制：（感谢 @Kaito ，@Darren   大神的解答）
            哨兵成为Leader的必要条件：a：获得半数以上的票数，b：得到的票数要达到配置的quorum阀值
            主从切换只能由Leader执行，而成为Leader有两个必要的条件，所以当哨兵集群中实例异常过多时，会导致主从库无法切换
        </div>2020-08-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg" width="30px"><span>Darren</span> 👍（25） 💬（4）<div>1、可以正确的判断主库“客观下线”，以为其中一个哨兵已经获得了“客观下线”所需要的投票数；
2、不能进行自动的主从切换，因为在主从切换的时候，必须选择出一个主哨兵，但是选择主哨兵有2个条件：
	2.1 拿到半数以上的赞成票；
	2.2 拿到的票数同时还需要大于等于哨兵配置文件中的 quorum 值。
	此时可以满足投票数，但是拿不到半数以上的投票，因此无法选出主哨兵，所以无法进行主从切换。
3、哨兵的实例不是越多越好，因为哨兵的选举使用的是Raft协议，这个协议是Paxos协议的变种，这种协议在选主时，需要所有的节点参与投票，所以节点越多，选举耗时可能就会更久，所以根据对服务SLA的要求，评估一个节点可能出现问题的概率，选择合适的哨兵数量。
4、down-after-milliseconds不是越大越好的，虽然可以减少误判的概率，但是问题真正发生时，服务的不可用状态也会更久，所以down-after-milliseconds要根据真实的业务场景，进行取舍。</div>2020-08-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/23/5b/983408b9.jpg" width="30px"><span>悟空聊架构</span> 👍（21） 💬（2）<div>选举leader的过程和分布式Raft协议很像。之前写过一篇介绍Raft机制的文章，可以看看：《用动图讲解分布式Raft》https:&#47;&#47;mp.weixin.qq.com&#47;s&#47;US12ux7osqH_L0CtQyw-9A</div>2021-05-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/6c/b5/32374f93.jpg" width="30px"><span>可怜大灰狼</span> 👍（9） 💬（0）<div>老师你好。看到“同时，哨兵又通过 INFO 命令，获得了从库连接信息，也能和从库建立连接，并进行监控了”这句话。我翻了一下代码sentinel.c&#47;sentinelSendPeriodicCommands。发现sentinelSendPeriodicCommands里有一行代码：
redisAsyncCommand(ri-&gt;cc, sentinelInfoReplyCallback, NULL, &quot;INFO&quot;);
的确哨兵也是会往从库发送INFO命令的，而从库的INFO返回值中，我发现包含以下的内容：
run_id:d7e50cc730c3851fcb9d8b4b6af425f59e5207a6
slave_repl_offset:140354728
slave_priority:100
07节里说的三轮打分，是不是根据从库INFO监控信息来进行打分的？也就是说，第一轮根据slave_priority，第二轮根据slave_repl_offset，第三轮根据run_id。感觉和前面内容串起来了。
不对的地方，麻烦老师纠错下。</div>2020-08-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（8） 💬（3）<div>在哨兵节点选取Leader 节点的时候，某个节点已经投出了 Y 票，但是该轮没有选举出来Leader, 这时候这个节点怎么知道已经到了下一轮需要继续投票了呢？ 也可以这样问：一个节点在一轮只能投出一个票，但是这个节点怎么知道一轮什么时候，什么时候结束的呢？</div>2020-08-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/73/ca/9c5d7e55.jpg" width="30px"><span>kingdompeak</span> 👍（5） 💬（3）<div>1.可以判断主库“客观下线”。比如哨兵实例1判断主库为客观下线，然后向哨兵实例2发送is-master-down-by-addr命令，如果哨兵实例2此时也判断主库为客观下线，就会返回Y，此时哨兵实例1就会有两个Y（包括自己的），满足配置项quorum，所以就可以判断主库客观下线。
2.不能进行主从进行主从切换前需要选执行切换操作的Leader。由于两个哨兵实例在选Leader的事情上都只会给自己投票，所以各自的得票数只能为1，满足不了成为Leader的两个条件（1.得票数大于哨兵实例数的一半；2.满足quorum配置项），所以选不出Leader，自然无法执行主从切换。
3.调大此参数对误判有好处，由于存活的哨兵实例只有两个，如果恰好某段时间，两个实例与主库的网络连接不好，则很容易都将其标记为主观下线，进而就标记为客观下线了，进而就产生了误判，时间长点，在哨兵实例少的情况下会减少误判情况的发生。</div>2020-08-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/3d/63/b4466457.jpg" width="30px"><span>tardis</span> 👍（4） 💬（2）<div>quorum：确认odown的最少的哨兵数量

majority：授权进行主从切换的最少的哨兵数量

每次一个哨兵要做主备切换，首先需要quorum数量的哨兵认为odown，然后选举出一个哨兵来做切换，这个哨兵还得得到majority哨兵的授权，才能正式执行切换

如果quorum &lt; majority，比如5个哨兵，majority就是3，quorum设置为2，那么就3个哨兵授权就可以执行切换，但是如果quorum &gt;= majority，那么必须quorum数量的哨兵都授权，比如5个哨兵，quorum是5，那么必须5个哨兵都同意授权，才能执行切换
查了一下，上面的就是哨兵判断客观下线，和哨兵选主的算法描述。感觉作者文中把quorum和majority这两个参数当成了一个，看的让人迷糊。想一下，本来就是两个不同的含义，如果只用一个参数来表示，也不符合常理。不过也可能是redis版本不同</div>2022-04-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f4/8a/ab9e3028.jpg" width="30px"><span>小贤</span> 👍（4） 💬（0）<div>down-after-milliseconds 这个参数一般设置多大合适呢？</div>2020-08-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/31/10/fa/8aa46d0f.jpg" width="30px"><span>柴萌</span> 👍（2） 💬（1）<div>老师您好，有个问题
文章中描述1：“从本质上说，哨兵就是一个运行在特定模式下的 Redis 实例，只不过它并不服务请求操作，只是完成监控、选主和通知的任务。所以，每个哨兵实例也提供 pub&#47;sub 机制，客户端可以从哨兵订阅消息”，
文章中描述2：“知道了这些频道之后，你就可以让客户端从哨兵这里订阅消息了。具体的操作步骤是，客户端读取哨兵的配置文件后，可以获得哨兵的地址和端口，和哨兵建立网络连接”
我的问题是：存在多个哨兵且每个哨兵都能提供事件的pub&#47;sub，那么客户端如何知道从哪个哨兵里订阅消息呢？文中说的是客户端读取哨兵的配置文件后，可以获得哨兵的地址和端口，和哨兵建立网络连接,那么配置文件是写死的还是动态生成的？
望老师解答，谢谢</div>2023-01-08</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ8ic8eLTo5rnqIMJicUfpkVBrOUJAW4fANicKIbHdC54O9SOdwSoeK6o8icibaUbh7ZUXAkGF9zwHqo0Q/132" width="30px"><span>ivhong</span> 👍（2） 💬（1）<div>我有另一个问题很困惑，如课后问题，一个1主4从的redis集群，5个哨兵集群，是不是得需要10台服务器？那么维护redis集群的成本是不是有些太高了，比如说我们小公司控制成本很严格，redis集群1主2从，至少3个哨兵做哨兵集群，那么就需要6台服务器了～公司可能申请不下来这么多的钱</div>2022-04-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/22/c8/f2892022.jpg" width="30px"><span>科科</span> 👍（2） 💬（1）<div>好像理解了为什么redis除了要满足大多数的判定条件，还要加一个quorom这个条件，因为如果哨兵挂的特别多的话，剩下的那些哨兵，如果小于等于一半的数量，就永远也无法让redis客观下线。所以还要加一个quorom值。
因为这两个哨兵已经都判断了主观下线，两个已经到达了设置的quorom值，所以该数据库可以被判定为主观下线。
但是，选主需要大多数哨兵得票数，起码得是总数除以二加上一这么大，也就是说最少也得拿到三票才可以。
今天在看mongo的副本集相关内容，发现不管是mango也好还是redis也好，在做冗余的时候都要涉及到“大多数”的概念。
mongo这边的解释是说，在网络不好的情况下，副本1，2，3部署在A集群，副本4，5部署在B集群。 AB集群现在连不上，在123的角度上来看是45挂了，在45的角度上来看是123挂了。如果他们两个都有机会进行选主的话，就会产生两个主。所以只有123才有机会选主，45不可能完成选主。也是防止出现多个主。
我就联想到redis的哨兵选主大多数的限制应该也是类似的思路，而且在实际的经验上来看，基本上都部署奇数个实例。
不知道我这个理解对不对？</div>2021-08-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/fb/7f/746a6f5e.jpg" width="30px"><span>Q</span> 👍（2） 💬（2）<div>干货满满。。 最近一直在测试哨兵集群，get 到一个点: 自己还要给自己投一票！也就是每个哨兵只有一次投票权，投自己或别人！</div>2020-08-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/4c/89/82a3ee04.jpg" width="30px"><span>going</span> 👍（1） 💬（0）<div>蒋老师，请教一个问题，由于哨兵下线导致所剩在线哨兵数量少于quorum这时候如何进行选举？
</div>2022-07-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ee/c6/bebcbcf0.jpg" width="30px"><span>俯瞰风景.</span> 👍（1） 💬（0）<div>为了解决主库宕机问题，需要进行监控和重新选主并执行切换，所以引入哨兵机制，而为了减小哨兵误判主库下线的概率，引入了哨兵集群。

哨兵通过redis的发布&#47;订阅模式可以通过“**sentinel**:hello”频道获取其他哨兵的连接信息，从而和其他哨兵建立哨兵集群，也可以通过info命令从主库获取从库列表，从而实现对从库的监控，另外，客户端也可以订阅哨兵提供的频道，实时获取redis集群中发生的事件，以做出反应。

哨兵判定主库客观下线后，需要选举出一个Leader来执行切换操作。成为Leader的条件是：
  1、拿到半数以上的赞成票；
  2、拿到的票数同时还需要大于等于哨兵配置文件中的 quorum 值。</div>2021-09-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/2f/6b/27b50c5e.jpg" width="30px"><span>蚂蚁</span> 👍（1） 💬（3）<div>第二个问题：哨兵如果没有给自己投票，就会把票投给第一个给它发送投票请求的哨兵。后续再有投票请求来，哨兵就拒接投票了。
————
老师请问下，你说的后续再有投票就拒绝投票，那哨兵怎么知道是同一轮的投票呢？怎么判断又是一轮新的投票，可以把这个投票的报文贴上来看看吗</div>2020-12-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/18/49/b1d864e5.jpg" width="30px"><span>Hinimix</span> 👍（1） 💬（4）<div>请问：如果3个哨兵节点有1个宕机了，剩下俩有一个判定主库宕了发起投票，另一个收到选举leader回复了Y，这时候这个节点是有2个票的，为什么不能当leader进行主从切换呢</div>2020-10-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/e9/86/d34800a4.jpg" width="30px"><span>heyman</span> 👍（1） 💬（2）<div>老师，请教一下：哨兵和主库建立连接后，通过info来获取从库信息。那么，后续从库有新增或摘除，哨兵是怎样知道的呢？</div>2020-08-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/43/79/18073134.jpg" width="30px"><span>test</span> 👍（1） 💬（0）<div>可以判断客观下线，但是无法进行选主。调大参数对误判有好处。</div>2020-08-21</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqwcSnSDBq6QNW4k9cAoOtjTpFhuTiaqiadwvicJWUdfH2m7gQRJ9gsqU1T0mjNpUE2hVA4qcfKwZ5sA/132" width="30px"><span>Geek_433ce1</span> 👍（0） 💬（0）<div>主节点挂掉，哨兵设置新领导， 重启原来的主节点， 哨兵还能把这个节点加到主从中去吗</div>2024-10-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/39/d7/9d/73390cc0.jpg" width="30px"><span>wild wings.Luv</span> 👍（0） 💬（0）<div>什么时候会算作没有产生leader</div>2024-07-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/39/d7/9d/73390cc0.jpg" width="30px"><span>wild wings.Luv</span> 👍（0） 💬（0）<div>具体来说，在主库被标为下线节点后，什么时候哨兵会去竞选leader</div>2024-07-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/39/d7/9d/73390cc0.jpg" width="30px"><span>wild wings.Luv</span> 👍（0） 💬（0）<div>问：选举Leader和选择新主库的先后顺序？哨兵进行换主需要什么步骤，为什么需要一个Leader？主要是通知客户端和从库新的主库地址吧。在Pub和Sub模式下也需要Leader吗？</div>2024-07-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/39/d7/9d/73390cc0.jpg" width="30px"><span>wild wings.Luv</span> 👍（0） 💬（0）<div>客户端使用Pub和Sub机制探查实例下线和换主过程，若是为了及时将缓存中的写请求发送出去，为什么这个机制就可以及时发送，而哨兵对客户端的通知（例如通过连接发送报文）就有可能丢包而没有到达客户端？</div>2024-07-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/39/d7/9d/73390cc0.jpg" width="30px"><span>wild wings.Luv</span> 👍（0） 💬（0）<div>请问客户端是怎么动态配置主库的IP和端口的？也就是说在使用Redis服务的时候是怎么切换主库的？另外，哨兵的配置信息是固定的吗？</div>2024-07-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/69/bf/58f70a2a.jpg" width="30px"><span>程序员花卷</span> 👍（0） 💬（0）<div>当一个主库被判断为主观下线时，监视这个下线主库的各个哨兵会进行协调，选举出一个 Leader 来负责主从切换这个工作。

选举规则：
1. 所有的哨兵都有被选举成为 Leader 的资格，意思也就是监视同一个主库的所有哨兵都有可能成为 Leader
2. 所有哨兵有且仅有一次选举的机会，比如哨兵 B 选举哨兵 A 成为 Leader，那么对于其他哨兵的选举请求，哨兵 B 都会拒绝。
3. 只有当某个哨兵被半数以上的哨兵选举为 Leader，这个哨兵才能成为 Leader ，比如有 10 个哨兵，那么只有大于等于 10&#47;2 + 1 个哨兵将某个哨兵选为 Leader，这个哨兵才能成为 Leader 。
4. 如果在给定的时间内，没有选举出合适的 Leader，那么各个 哨兵将在一段时间后开启下一轮的选举，直到选出 Leader 为止。

选举流程：
假设有三个哨兵 A 、B 、C 
1. 当哨兵 A 向哨兵 B 和 哨兵 C 发送 is-master-down-by-addr 命令，并且参数 runid 不是*而是自己的运行 ID 时，这表示哨兵 A 要求哨兵 B 和哨兵 C 将自己选为 Leader 
2. 哨兵 B 和哨兵 C 接收到哨兵 A 的命令之后，将向哨兵 A 返回一条命令，回复命令中有个参数是 leader_runid ，如果哨兵 B 支持哨兵 A 成为 Leader ，那么哨兵 B 就会把 leader_runid 设置为哨兵 A 的 runid ，哨兵 C 亦是如此。
3. 哨兵 A 接收到哨兵 B 和哨兵 C 的回复命令之后，取出哨兵 B 和哨兵 C 的 leader_runid 和自己的 runid  进行对比，如果相同，则说明这条回复命令对应的哨兵支持哨兵 A 成为 Leader 
4. 如果哨兵 A 被半数以上的哨兵选举为了 Leader（包括自己本身），那么哨兵 A 就会成为 Leader 负责主从切换的工作，在我们的例子中只需要哨兵 B 或者 C 任意一个支持哨兵 A 成为 Leader，那么哨兵 A 就会成为 Leader 。
5. 哨兵 B 和 哨兵 C 在这个过程中也会给其他哨兵发送选举命令，走的都是一样的流程，但是需要注意，选举是先到先得，比如哨兵 A 和哨兵 B 同时给哨兵 C 发送选举命令，但是哨兵 C 先接收到了哨兵 A 的选举命令，那么哨兵 C 就会选举哨兵 A 为 Leader，而哨兵 B 将被哨兵 C 拒绝成为 Leader ，相当于哨兵 A 胜出了。 命令几乎不太可能同时到达和处理，所以不用太担心死循环的问题。
6. 至此选举工作完毕。</div>2023-11-26</li><br/>
</ul>