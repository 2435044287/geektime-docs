你好，我是蒋德钧。

上节课，我们学习了缓存和数据库的数据不一致问题和应对方法。除了数据不一致问题，我们常常还会面临缓存异常的三个问题，分别是缓存雪崩、缓存击穿和缓存穿透。这三个问题一旦发生，会导致大量的请求积压到数据库层。如果请求的并发量很大，就会导致数据库宕机或是故障，这就是很严重的生产事故了。

这节课，我就来和你聊聊这三个问题的表现、诱发原因以及解决方法。俗话说，知己知彼，百战不殆。了解了问题的成因，我们就能够在应用Redis缓存时，进行合理的缓存设置，以及相应的业务应用前端设置，提前做好准备。

接下来，我们就先看下缓存雪崩的问题和应对方案。

## 缓存雪崩

缓存雪崩是指大量的应用请求无法在Redis缓存中进行处理，紧接着，应用将大量请求发送到数据库层，导致数据库层的压力激增。

缓存雪崩一般是由两个原因导致的，应对方案也有所不同，我们一个个来看。

第一个原因是：缓存中有大量数据同时过期，导致大量请求无法得到处理。

具体来说，当数据保存在缓存中，并且设置了过期时间时，如果在某一个时刻，大量数据同时过期，此时，应用再访问这些数据的话，就会发生缓存缺失。紧接着，应用就会把请求发送给数据库，从数据库中读取数据。如果应用的并发请求量很大，那么数据库的压力也就很大，这会进一步影响到数据库的其他正常业务请求处理。我们来看一个简单的例子，如下图所示：
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/13/8d/c8/3ffed92b.jpg" width="30px"><span>徐培</span> 👍（164） 💬（11）<div>        我觉得并没有必要：采用服务熔断、服务降级、请求限流的方法来应对缓存穿透的场景；
        因为缓存穿透的场景实质上是因为查询到了Redis和数据库中没有的数据。
        熔断、降级、限流，本质上是为了解决Redis实例没有起到缓存层作用这种情况；在损失业务吞吐量的代价下，在时间的作用下，随着过期key慢慢填充，Redis实例可以自行恢复缓存层作用。
        而缓存穿透的场景，是因为用户要让Redis和数据库提供一个它没有的东西。这种场景下，如果没有人工介入，不论时间过去多久，都不太可能会自然恢复。
        采用这种有损业务吞吐量的行为，会拖慢系统响应、降低用户体验、给公司一种系统“勉强能用”的错觉；但对问题的解决没有帮助。
        最好的办法是事前拦截，降低这种类型的请求打到系统上的可能。布隆过滤器虽然判别数据存在可能有误判的情况，但判别数据不存在不会误判。可以降低数据库无效的访问。</div>2020-10-18</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ersGSic8ib7OguJv6CJiaXY0s4n9C7Z51sWxTTljklFpq3ZAIWXoFTPV5oLo0GMTkqW5sYJRRnibNqOJQ/132" width="30px"><span>walle斌</span> 👍（61） 💬（5）<div>1）、缓存雪崩还有一个场景，是一致性hash环的集群特性导致的。集群中 某个主从节点挂掉了，请求分散到其他集群，但是量极大，把其他集群也都冲垮了。
解决办法，如果场景是热的极热 冷的极冷，不建议使用 一致性hash环的集群玩法，直接使用逻辑分组，挂掉的就暂时挂掉，后续人工恢复。  总比打垮整个系统的好

2）、缓存击穿  不只有不写过期时间，也可以对读数据做预判，例如主动给某些热的数据做 过期时间延期操作。

3）、布隆过滤器介绍  最后一部分 关于命中这部分缺少了，如果都是1 那么结果返回 存在，但是真正存在吗？ 不一定，可能是由于其他value的hash函数填充的，所以  对于 布隆过滤器 返回存在的，我们要穿透到缓存与db中查询。
像一个极端情况，如果 整个bit数组 都是1 或者大部分都是1的场景，这说明什么？ 说明布隆过期已经基本被填满了，也说明超出了布隆过滤器 一开始预期的大小，没错 布隆过滤器是需要事先预知 总容量大小与误判率预期的，否则就会出现 误判率极高 基本等于 没有作用的情况</div>2020-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/77/2a/4f72941e.jpg" width="30px"><span>cpzhao</span> 👍（8） 💬（1）<div>关于穿透和雪崩，可以理解为数据的缓存命中率的不同程度的表现。雪崩代表此时命中率很低或者为0，已经到了影响DB的程度了。
同理，发生了缓存穿透，我觉得要看穿透的严重程度，可以统计命中率，在db还能抗住的情况下，可以不用熔断、降级、和限流，否则影响体验。假设命中率已经到了极限值，那这时候穿透问题上升为雪崩级别了，则可以按需要选择熔断、降级或者限流等策略</div>2020-12-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/ff/9a/f7d84a69.jpg" width="30px"><span>Andrew.Fang</span> 👍（2） 💬（2）<div>布隆过滤器怎么用你，Redis有没有命令</div>2020-12-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg" width="30px"><span>Kaito</span> 👍（367） 💬（27）<div>是否可以采用服务熔断、服务降级、请求限流的方法来应对缓存穿透问题？

我觉得需要区分场景来看。

如果缓存穿透的原因是恶意攻击，攻击者故意访问数据库中不存在的数据。这种情况可以先使用服务熔断、服务降级、请求限流的方式，对缓存和数据库层增加保护，防止大量恶意请求把缓存和数据库压垮。在这期间可以对攻击者进行防护，例如封禁IP等操作。

如果缓存穿透的原因是，业务层误操作把数据从缓存和数据库都删除了，如果误删除的数据很少，不会导致大量请求压到数据库的情况，那么快速恢复误删的数据就好了，不需要使用服务熔断、服务降级、请求限流。如果误操作删除的数据范围比较广，导致大量请求压到数据库层，此时使用服务熔断、服务降级、请求限流的方法来应对是有帮助的，使用这些方法先把缓存和数据库保护起来，然后使用备份库快速恢复数据，在数据恢复期间，这些保护方法可以为数据库恢复提供保障。

还有一种缓存穿透的场景，我们平时会遇到的，和大家分享一下。

对于一个刚上线的新业务模块，如果还没有用户在这个模块内产生业务数据，当用户需要查询这个业务模块自己的数据时，由于缓存和数据库都没有这个用户的数据，此时也会产生缓存穿透，但这种场景不像误删数据和恶意攻击那样，而是属于正常的用户行为。

这种场景采用服务熔断、服务降级、请求限流的方式就没有任何意义了，反而会影响正常用户的访问。这种场景只能使用缓存回种空值、布隆过滤器来解决。

可见，服务熔断、服务降级、请求限流的作用是，当系统内部发生故障或潜在问题时，为了防止系统内部的问题进一步恶化，所以会采用这些方式对系统增加保护，待系统内部故障恢复后，可以依旧继续对外提供服务，这些方法属于服务治理的范畴，在任何可能导致系统故障的场景下，都可以选择性配合使用。

另外，关于文章所讲的由于“Redis缓存实例发生故障宕机”导致缓存雪崩的问题，我觉得一个可以优化的方案是，当Redis实例故障宕机后，业务请求可以直接返回错误，没必要再去请求数据库了，这样就不会导致数据库层压力变大。当然，最好的方式还是Redis部署主从集群+哨兵，主节点宕机后，哨兵可以及时把从节点提升为主，继续提供服务。

关于布隆过滤器的使用，还有几点和大家分享。

1、布隆过滤器会有误判：由于采用固定bit的数组，使用多个哈希函数映射到多个bit上，有可能会导致两个不同的值都映射到相同的一组bit上。虽然有误判，但对于业务没有影响，无非就是还存在一些穿透而已，但整体上已经过滤了大多数无效穿透请求。

2、布隆过滤器误判率和空间使用的计算：误判本质是因为哈希冲突，降低误判的方法是增加哈希函数 + 扩大整个bit数组的长度，但增加哈希函数意味着影响性能，扩大数组长度意味着空间占用变大，所以使用布隆过滤器，需要在误判率和性能、空间作一个平衡，具体的误判率是有一个计算公式可以推导出来的（比较复杂）。但我们在使用开源的布隆过滤器时比较简单，通常会提供2个参数：预估存入的数据量大小、要求的误判率，输入这些参数后，布隆过滤器会有自动计算出最佳的哈希函数数量和数组占用的空间大小，直接使用即可。

3、布隆过滤器可以放在缓存和数据库的最前面：把Redis当作布隆过滤器时（4.0提供了布隆过滤器模块，4.0以下需要引入第三方库），当用户产生业务数据写入缓存和数据库后，同时也写入布隆过滤器，之后当用户访问自己的业务数据时，先检查布隆过滤器，如果过滤器不存在，就不需要查询缓存和数据库了，可以同时降低缓存和数据库的压力。

4、Redis实现的布隆过滤器bigkey问题：Redis布隆过滤器是使用String类型实现的，存储的方式是一个bigkey，建议使用时单独部署一个实例，专门存放布隆过滤器的数据，不要和业务数据混用，否则在集群环境下，数据迁移时会导致Redis阻塞问题。</div>2020-10-16</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTITcwicqBDYzXtLibUtian172tPs7rJpqG1Vab4oGjnguA9ziaYjDCILSGaS6qRiakvRdUEhdmSG0BGPKw/132" width="30px"><span>大饶Raysir</span> 👍（17） 💬（0）<div>可以记录ip和穿透访问的次数，频率超过阈值的ip直接拉黑</div>2020-10-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/49/5a/67b5f0b1.jpg" width="30px"><span>单小灰</span> 👍（14） 💬（2）<div>老师，我有个疑问，使用布隆过滤器来应对缓存穿透，那当应用刚启动的时候，布隆过滤器全是0，这样不是所有请求都会被判断为数据不存在就都直接返回了？难不成要预加载，把数据库的数据都来过滤器这边设置一遍？</div>2020-11-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/97/1a/389eab84.jpg" width="30px"><span>而立斋</span> 👍（11） 💬（0）<div>先来自己理解一下这四个问题的表现吧: 
1，缓存数据与数据库数据不一致，这个就很容易理解了，就是数据出现偏差了，导致的原因是在数据变动时只更新了其中一个
 2，缓存雪崩呢？缓存挂了，或者大部分key都失效了，这一下请求都打到数据库，它累了
 3，缓存击穿:热点数据的失效，就像针一样同样的请求一下子刺穿了数据库的心脏
 4，缓存穿透，key根本就存在无论是缓存还是数据库，但是请求一直来，这就很恶心 为什么要起
其实明白这些，一些常用的手段也就呼之欲出了。真不明白起这么多装逼的名字干嘛，不就是因为流量大了，缓存因自身限制而导致的一些现象吗？</div>2021-04-16</li><br/><li><img src="" width="30px"><span>Geek3113</span> 👍（4） 💬（4）<div>布隆过滤器保护的数据只能加不能删，如果用来保护的业务数据会有删除的情况怎么办呢？</div>2020-10-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/43/79/18073134.jpg" width="30px"><span>test</span> 👍（3） 💬（0）<div>思考题：服务熔断、服务降级、请求限流，相当于减少了数据库的压力，对于缓存穿透也是可用的。

雪崩：一批次的key同一时间失效或者redis宕机，导致同一时间有大量请求打到数据库，造成数据库很大的压力。解决方案是设置key过期时间的时候加一个随机值，或者服务熔断、服务降级、请求限流等方案；
击穿：访问非常频繁的热点数据失效，解决方案是热点数据不设置过期时间；
穿透：数据库里面没有目标数据，解决方案是布隆过滤器或者前端做验证。</div>2020-10-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/00/94/91bd7001.jpg" width="30px"><span>寒三石</span> 👍（2） 💬（2）<div>作者提到解决缓存击穿使用手段是不给热点数据设置过期时间，但确定哪些数据是热点数据本身也是个问题，热点数据后续也有可能不再是热点数据，一直占着内存也不好</div>2021-02-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/4f/c9/9f51fd27.jpg" width="30px"><span>编程界的小学生</span> 👍（2） 💬（1）<div>我有个缓存击穿的解决方案二，靠谱吗？如下：
分布式锁。来个请求后先锁住，然后去db查，查到后再将数据set到redis里。只有当redis里getKey没拿到数据需要请求db的时候才加锁。不影响Redis里有数据的时候处理高并发请求，也能保证db不会被打垮。

</div>2020-12-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/f6/79/43fc66d3.jpg" width="30px"><span>wesley</span> 👍（2） 💬（0）<div>个人理解，缓存穿透即相当于没有缓存，所有的压力都放在了数据库上。
服务熔断、服务降级、请求限流都能保证数据库的访问变少，如果是从表面上也能解决数据库的访问问题
这三种处理都是在缓存之前的、有损的且不是能自主恢复的(比如雪崩，在限流一段时间后缓存正常了就可以放开)，并且降级和限流都无法避免重复且无效的查询，最后的结果可能还是服务基本不可用
所以综合来讲，个人的看法是可以用来应对，但绝对不是很好的方案</div>2020-10-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0d/5a/e60f4125.jpg" width="30px"><span>camel</span> 👍（1） 💬（0）<div>缓存雪崩和缓存击穿有点像，都是大量请求的数据缓存里没有，对数据库造成压力。不同的是雪崩的原因是缓存大量失效，而穿透的原因是热点缓存失效。</div>2021-10-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/d9/ff/b23018a6.jpg" width="30px"><span>Heaven</span> 👍（1） 💬（2）<div>这几种方案本身就是饮鸩止渴,对于缓存穿透中可能出现的恶意攻击,是可以利用限流和熔断,降级避免应用崩溃,但是也对正常的用户体验下降了,所以还是考虑从客户请求校验这一层次考虑更好</div>2021-08-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/23/5b/983408b9.jpg" width="30px"><span>悟空聊架构</span> 👍（1） 💬（0）<div>课后题：在讲到缓存雪崩时，我提到，可以采用服务熔断、服务降级、请求限流的方法来应对。请你思考下，这三个机制可以用来应对缓存穿透问题吗？

我觉得有必要。
但是这是一种治标不治本的方案。
因为缓存穿透本质上是因为缓存和数据库都没有这个key，导致每次都要去查数据库而且还做了无效的查询，还把性能拖慢了。如果没有人工介入是没有办法恢复的。

所以要找到是哪个数据没有还被访问，然后缓存和数据库增加这个key，value为空值或缺省值。

另外还可以用布隆过滤器来判断是否没有。布隆过滤器虽然对数据“存在”有误判，对数据“不存在”是没有误判的，快速返回判断结果，就不用到数据库查询了。
还有种方案就是改前端代码了，请求这些没有的数据时做合法性校验。比如数据库中只有key=1-1000的数据，如果前端访问超过1000的key的请求，前端直接拦截这些请求。</div>2021-06-04</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/FmwWpyD4ym73Kbrhlgl1wXZHPgyDS7DxRlaTibbT8oQyvibnJ1SD6nDxxuFIUqFlElxxIU8FZfiamDGX3YYSYrrZQ/132" width="30px"><span>InfoQ_52198370e321</span> 👍（1） 💬（0）<div>如果加到了布隆过滤器里面以后，如果此时有新数据进来，怎么去更新过滤器呢？</div>2020-12-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/3c/fa/e2990931.jpg" width="30px"><span>文敦复</span> 👍（0） 💬（0）<div>针对缓存穿透问题，部分Java缓存库已在单个应用程序层面实现了优化：当多个线程并发请求相同的缓存键时，这些库能够使后续请求暂时阻塞，直至首次请求完成并返回结果，从而确保所有线程能够共享首次加载的数据。该机制显著提升了资源利用效率并减少了不必要的多次远程数据获取。
Caffeine与Jetcache，都内置了对该特性的支持。
Caffeine库中的相关实现代码，可参见com.github.benmanes.caffeine.cache.LocalAsyncCache.AbstractCacheView#get方法。
Jetcache库，则在其com.alicp.jetcache.AbstractCache#synchronizedLoad方法内部，实现了类似的同步加载逻辑，确保了并发请求的高效处理。</div>2024-06-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/3c/fa/e2990931.jpg" width="30px"><span>文敦复</span> 👍（0） 💬（0）<div>对于布隆过滤器，建议：1.提前评估好用量，避免bit数组大部分都被写满为1。2.定期重建，因为其不支持删除。3.注意假阳性问题，存在可能是假的，不存在肯定是真的。4. 针对不同的业务子集，分散到不同的布隆过滤器，不要无脑往1个里面扔。5.大数据量下布隆过滤器也是会费内存的，提前做好评估和测试，选择合适的场景来使用。</div>2024-06-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/9a/ab/fd201314.jpg" width="30px"><span>小耿</span> 👍（0） 💬（0）<div>熔断、降级、限流可以给雪崩和击穿问题提供恢复的时间，在缓存服务恢复正常后，可以重新对外提供服务。而缓存穿透的情况下，熔断降级限流机制虽然也可以保护数据库服务器不崩溃，但缓存服务无法自行恢复正常，因此无法单独作为穿透的应对机制。</div>2023-08-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/31/7c/91/791d0f5e.jpg" width="30px"><span>想想大牛怎么做。</span> 👍（0） 💬（0）<div>缓存穿透影响较小： 缓存穿透通常发生在恶意查询或错误的查询请求上，导致缓存和数据库都无法命中需要的数据。尽管每次请求都需要访问数据库，但通常不会对后端系统造成剧烈压力。此外，现代数据库系统通常会对频繁查询进行优化，以减轻缓存穿透带来的负担。

缓存雪崩危害较大： 缓存雪崩会导致大量缓存项在短时间内过期或失效，从而导致大量请求直接访问后端存储。这可能会在短时间内产生巨大的流量，对后端系统造成严重的负载压力，甚至可能导致系统崩溃。缓存雪崩的影响范围更广，恢复也更为困难。

缓存击穿的影响相对： 缓存击穿在某种程度上介于缓存穿透和缓存雪崩之间。当一个热门缓存项过期时，只有这个特定的缓存项会受到影响，而不会像缓存雪崩那样影响整个缓存。但在高流量情况下，缓存击穿仍然可能对系统性能造成严重影响。</div>2023-08-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/43/79/18073134.jpg" width="30px"><span>test</span> 👍（0） 💬（0）<div>缓存雪崩：大量数据同时过期获取缓存宕机导致请求都打到数据库。应对方法：对key设置不同的过期时间；限流降级；Redis主从，把读打到从节点。
缓存击穿：热点数据过期；应对方法：热点数据不过期
缓存穿透：请求数据库中没有的数据。应对方法：布隆过滤器、不存在则保存为孔结构。
</div>2023-04-22</li><br/><li><img src="" width="30px"><span>孙长平  </span> 👍（0） 💬（1）<div>老师前面讲缓存类型时候提到只读缓存，查询缓存是否存在不存在查询数据库，然后数据库存在更新到缓存。如果有数据变更或者删除动作会要求删除数据库和缓存中的数据。在缓存穿透动讲到布隆过滤器，那么只读缓存类型可以使用布隆过滤器吗，如何避免数据在缓存中不存在，在数据库中存在的情况？</div>2022-10-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/3a/32/d1a3ed4d.jpg" width="30px"><span>人如墨</span> 👍（0） 💬（0）<div>恶意攻击的请求是不是也可以进行黑白名单校验，判断是否让其进行查询</div>2022-09-12</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/MOuCWWOnoQjOr8KjicQ84R7xu6DRcfDv3VAuHseGJ1gxXicKJboA24vOcrcJickTJPwFAU38VuwCGGkGq7f8WkTIg/132" width="30px"><span>Geek_b14c55</span> 👍（0） 💬（0）<div>请求限流是可以实现解决缓存穿透的，服务降级和熔断也可以解决，但是服务降级和熔断更多指的是服务不可用，缓存穿透在没有打挂掉数据库时，是没有这个问题的。</div>2022-09-06</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK28icgzo9R0rT9h0Q7iaYkJQtCPa0oriaDfFdaQMUibnnH7BW2CU9yKwDUvou63AmoGGIPgZJDyjMRJA/132" width="30px"><span>菜鸟葫芦娃</span> 👍（0） 💬（0）<div>随着时间点推移，布隆过滤器会有短暂的浪费空间，哪些空间如何再利用呢？</div>2022-07-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d6/76/be6fc02e.jpg" width="30px"><span>笑地</span> 👍（0） 💬（0）<div>建议更新数据库和缓存时加个分布式锁，更新前设置缓存N秒后过期，再更新数据库</div>2022-06-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/74/aa/178a6797.jpg" width="30px"><span>阿昕</span> 👍（0） 💬（0）<div>对于缓存穿透的场景，熔断、降级、限流只是兜底手段</div>2022-04-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c9/87/17053a50.jpg" width="30px"><span>Yusan、</span> 👍（0） 💬（1）<div>这一节满满的干货</div>2022-03-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/4f/ac/80439ba7.jpg" width="30px"><span>Aprelude</span> 👍（0） 💬（0）<div>用roraingbitmap也行吧</div>2021-12-23</li><br/>
</ul>