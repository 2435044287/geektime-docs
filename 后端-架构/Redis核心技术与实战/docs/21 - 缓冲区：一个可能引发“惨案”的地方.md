你好，我是蒋德钧。今天，我们一起来学习下Redis中缓冲区的用法。

缓冲区的功能其实很简单，主要就是用一块内存空间来暂时存放命令数据，以免出现因为数据和命令的处理速度慢于发送速度而导致的数据丢失和性能问题。但因为缓冲区的内存空间有限，如果往里面写入数据的速度持续地大于从里面读取数据的速度，就会导致缓冲区需要越来越多的内存来暂存数据。当缓冲区占用的内存超出了设定的上限阈值时，就会出现缓冲区溢出。

如果发生了溢出，就会丢数据了。那是不是不给缓冲区的大小设置上限，就可以了呢？显然不是，随着累积的数据越来越多，缓冲区占用内存空间越来越大，一旦耗尽了Redis实例所在机器的可用内存，就会导致Redis实例崩溃。

所以毫不夸张地说，缓冲区是用来避免请求或数据丢失的惨案的，但也只有用对了，才能真正起到“避免”的作用。

我们知道，Redis是典型的client-server架构，所有的操作命令都需要通过客户端发送给服务器端。所以，缓冲区在Redis中的一个主要应用场景，就是在客户端和服务器端之间进行通信时，用来暂存客户端发送的命令数据，或者是服务器端返回给客户端的数据结果。此外，缓冲区的另一个主要应用场景，是在主从节点间进行数据同步时，用来暂存主节点接收的写命令和数据。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg" width="30px"><span>Kaito</span> 👍（340） 💬（42）<div>应用程序和Redis实例交互时，应用程序中使用的客户端需要使用缓冲区吗？如果使用的话，对Redis的性能和内存使用有什么影响？

客户端需要使用缓冲区，好处如下。

1、客户端和服务端交互，一般都会制定一个交互协议，客户端给服务端发数据时，都会按照这个协议把数据拼装好，然后写到客户端buffer中，客户端再一次性把buffer数据写到操作系统的网络缓冲区中，最后由操作系统发送给服务端。这样服务端就能从网络缓冲区中读取到一整块数据，然后按照协议解析数据即可。使用buffer发送数据会比一个个发送数据到服务端效率要高很多。

2、客户端还可以使用Pipeline批量发送命令到服务端，以提高访问性能。不使用Pipeline时，客户端是发送一个命令、读取一次结果。而使用Pipeline时，客户端先把一批命令暂存到buffer中，然后一次性把buffer中的命令发送到服务端，服务端处理多个命令后批量返回结果，这样做的好处是可以减少来回网络IO的次数，降低延迟，提高访问性能。当然，Redis服务端的buffer内存也会相应增长，可以控制好Pipeline命令的数量防止buffer超限。

缓冲区其实无处不在，客户端缓冲区、服务端缓冲区、操作系统网络缓冲区等等，凡是进行数据交互的两端，一般都会利用缓冲区来降低两端速度不匹配的影响。没有缓冲区，就好比一个个工人搬运货物到目的地，每个工人不仅成本高，而且运输效率低。而有了缓冲区后，相当于把这些货物先装到一个集装箱里，然后以集装箱为单位，开车运送到目的地，这样既降低了成本，又提高了运输效率。缓冲区相当于把需要运送的零散数据，进行一块块规整化，然后分批运输。

另外，关于Redis服务端为客户端分配的输出缓冲区，我想补充一点：主库上的从库输出缓冲区（slave client-output-buffer）是不计算在Redis使用的总内存中的，也就是说主从同步延迟，数据积压在主库上的从库输出缓冲区中，这个缓冲区内存占用变大，不会超过maxmemory导致淘汰数据。只有普通客户端和订阅客户端的输出缓冲区内存增长，超过maxmemory时，才会淘汰数据。</div>2020-09-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/bf/99/0681e343.jpg" width="30px"><span>馒头超人</span> 👍（14） 💬（9）<div>有几个问题希望老师帮忙解答一下
1、TCP已经有读写缓冲区，redis为何还要单独维护读写缓冲区，两者的作用看起来是一致的
2、缓冲区类似队列，读写变成异步，主线程跟缓冲区交互，是什么线程负责缓冲区跟tcp的数据同步
</div>2020-10-21</li><br/><li><img src="" width="30px"><span>Geek_aa296b</span> 👍（7） 💬（3）<div>各位大牛，是有额外的线程来处理 输入输出缓冲区吗，否则，是主线程处理的话，主线程阻塞的时候，客户端的数据是如何到输入缓冲区的？</div>2020-12-15</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJL41FPvibMjjENzN6Ek2DIDGXibribd9YO9XS5Lu5bsia8icSzWwYDwyseibX4rdmK3wDicHSCLMw8B4x8w/132" width="30px"><span>Geek_72b9a7</span> 👍（5） 💬（0）<div>这个坑踩得很深，分享一个计算repl大小的脚本。https:&#47;&#47;blog.csdn.net&#47;MyySophia&#47;article&#47;details&#47;107126459</div>2021-08-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/56/7e/64730c47.jpg" width="30px"><span>张凯</span> 👍（3） 💬（0）<div>qbuf=0 qbuf-free=0 这是什么情况导致的？</div>2021-03-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/2c/82/98e2b82a.jpg" width="30px"><span>Reborn 2.0</span> 👍（2） 💬（2）<div>老师, 我想问一下复制缓冲区(replication_buffer)在全量复制完成之后命令也同步完了还会存在么?</div>2020-11-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/65/b7/058276dc.jpg" width="30px"><span>i_chase</span> 👍（1） 💬（0）<div>大佬，文章里客户端输入缓冲区是个什么概念？程序客户端有redis连接池，每个连接对于redis server都是一个客户端，每个连接都在redis server里有一个输入缓冲区吗？</div>2022-11-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg" width="30px"><span>escray</span> 👍（1） 💬（0）<div>Redis 原本就是当做缓存在用，然后它又有自己的缓冲区，果然是应了那句话，在计算机领域，没有什么问题是加一层缓存解决不了的。

直接跳到课后问题，应用程序和 Redis 实例交互时，应用程序客户端应该也会使用缓冲区，对于 Redis 的性能和内存同样会有影响。如果不想造成缓冲区溢出那么也需要设置合理的缓冲区参数，以及设置合理的读写速率。

课后题的解答主要靠课代表 @Kaito</div>2021-03-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/bf/99/0681e343.jpg" width="30px"><span>馒头超人</span> 👍（1） 💬（3）<div>有几个疑问希望老师帮忙解答：
1、tcp已经有读写缓冲区， redis 为何还要再单独维护读写缓冲区，两者的作用看起来是一样的</div>2020-10-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/92/d5/699384a0.jpg" width="30px"><span>yeek</span> 👍（1） 💬（5）<div>服务器端处理请求的速度过慢，例如，Redis 主线程出现了间歇性阻塞，无法及时处理正常发送的请求，导致客户端发送的请求在缓冲区越积越多。


这句话有点没理解，redis大部分请求是阻塞的，对客户端来说需要等待服务器的相应结果，虽然相应结果不一定有用，但这样的情况，redis服务端如果处理请求较慢，那么客户端输入缓冲区应该是当前请求一直在hold吧？服务器处理慢会导致等待的客户端变多，整体积压的输入缓冲变多，但对单个缓冲区来说，溢出应该不是主要的吧？

不知道上述理解是否正确……</div>2020-09-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/31/3e/de/c830c0c1.jpg" width="30px"><span>。。。。。</span> 👍（0） 💬（0）<div>&quot;当多个客户端连接占用的内存总量，超过了 Redis 的 maxmemory 配置项时（例如 4GB）&quot;  感觉讲的不对client-output-buffer-limit 这个buffer 内存占用不会计算在maxmemory中，而是计算在redis-server 进程使用的</div>2024-10-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/1a/9a/836fca1a.jpg" width="30px"><span>bobo</span> 👍（0） 💬（1）<div>我们先看看，到底有没有办法通过参数调整输入缓冲区的大小呢？答案是没有。
-- 老师，关于客户端输入缓冲区，不是可以通过 client-query-buffer-limit 值去设置吗，这个是对应咱们 输入缓冲区的大小吗，实测可以设置大于1GB</div>2024-03-03</li><br/><li><img src="" width="30px"><span>Wang Yifei</span> 👍（0） 💬（0）<div>输入缓冲区，给每个客户端分配的缓存大小默认是32K？默认能缓冲多少条记录？</div>2023-08-04</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eptSDsykxSicnicBibUOOmC9FOuuFWRaDkJqK69LOe10yQpIibYURwBgDrdqOTSlWPiaNbQ9Y8cMAhaENA/132" width="30px"><span>唐家岭大盗</span> 👍（0） 💬（0）<div>这门课有群吗？</div>2022-11-30</li><br/><li><img src="" width="30px"><span>Geek_0bba55</span> 👍（0） 💬（2）<div>既然有了复制缓冲区，为什么要加一个复制积压缓冲区？
为什么复制积压缓冲区溢出，要重新全量同步，不从AOF增加读取，或者用磁盘保存增量命令</div>2022-04-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/27/1d/10/a73d63ba.jpg" width="30px"><span>欢少の不忘初心</span> 👍（0） 💬（1）<div>Redis的 输入输出缓冲区  在客户端还是服务端啊</div>2021-12-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/d9/ff/b23018a6.jpg" width="30px"><span>Heaven</span> 👍（0） 💬（0）<div>可以模仿Kafka那样,攒一波发送,减少交互,但如果需要即使消息处理的数据的话,缓冲可能误了大事</div>2021-08-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/21/14/423a821f.jpg" width="30px"><span>Steven</span> 👍（0） 💬（0）<div>老师这里“全量复制、增量复制”，“复制”容易造成误解，改为“同步”就好了。而且官方文档里就是”synchronization “。</div>2021-07-27</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJkeOAC8k7aPMfQZ4ickiavpfR9mTQs1wGhGtIicotzAoszE5qkLfFTabkDU2E39ovSgoibJ1IiaLXtGicg/132" width="30px"><span>bigben</span> 👍（0） 💬（0）<div>客户端lettuce就有缓冲区吧</div>2021-07-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/37/29/b3af57a7.jpg" width="30px"><span>凯文小猪</span> 👍（0） 💬（0）<div>应用程序的客户端通常是不需要缓冲区 因为往往我们会用池化技术来缓存连接。我们通常更关注请求的延迟 而不是命令的缓冲。因为redis使用场景大多数是低时延而不是高吞吐。
看了下jedis处理 ：
1. 普通连接是当场生成一个outputstream 这显然是阻塞型的
2.clusterPool 这一步取的是池里的连接 也没有缓存
3.只有显式使用pipelined才会缓存命令</div>2021-06-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/23/5b/983408b9.jpg" width="30px"><span>悟空聊架构</span> 👍（0） 💬（0）<div>这篇讲解得很清晰，赞！</div>2021-05-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/01/d3/5cbaeb95.jpg" width="30px"><span>HUNTER</span> 👍（0） 💬（0）<div>AOF缓冲区和AOF重写缓冲区会溢出吗，可以调整大小吗</div>2021-05-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/8f/3a/b15e7392.jpg" width="30px"><span>呼啦啦~</span> 👍（0） 💬（1）<div>redis负责IO和业务处理的线程，是同一个线程。怎么会有缓冲区的存在呢？

如果有缓冲区的存在，那么放数据进入缓冲区的，是一个线程，从缓冲区读取数据执行的，又是另一个线程了。不符合redis单线程的设计。
对redis缓冲区不是很理解，请指教。</div>2021-04-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/8b/ec/dc03f5ad.jpg" width="30px"><span>张天屹</span> 👍（0） 💬（1）<div>文中提到缓冲区溢出会丢失数据，真的会吗，redis应该是会直接断连客户端返回失败吧</div>2021-01-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（0） 💬（0）<div>对于每个客户端连接的输入缓冲区的大小是在链接建立的时候就分配好的吗？ 还是可以后面动态调节的？</div>2020-10-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/36/b9/3b28f67c.jpg" width="30px"><span>xueyuan</span> 👍（0） 💬（0）<div>使用pipline，减少client数目。</div>2020-10-12</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eovyv4gkXvhZdQuP5ibAibAuia1GxDJjImvq5qjSGtO7sfcK4uX9arwAMIZmOHAaHIMFdOJDjE9LZrtw/132" width="30px"><span>无名小卒</span> 👍（0） 💬（0）<div>蒋老师的课程很深入，学到了很多底层redis知识，迫不及待的想看下面的章节，如果能更新快一点就更好了。催更啦😂！</div>2020-09-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/92/d5/699384a0.jpg" width="30px"><span>yeek</span> 👍（0） 💬（0）<div>从节点客户端输出缓冲区会用来传输rdb文件吗？如果会的话，该设置项的大小，是参考rdb文件大小吧？这可能是所有缓冲区中实际可能使用的最大缓冲区了</div>2020-09-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/92/d5/699384a0.jpg" width="30px"><span>yeek</span> 👍（0） 💬（0）<div>输出缓冲区，动态增加的部分，会产生内存碎片吗？何时回收呢？增加后会有机会缩小吗？</div>2020-09-28</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/WtHCCMoLJ2DvzqQwPYZyj2RlN7eibTLMHDMTSO4xIKjfKR1Eh9L98AMkkZY7FmegWyGLahRQJ5ibPzeeFtfpeSow/132" width="30px"><span>脱缰的野马__</span> 👍（0） 💬（0）<div>老师你好，在讲主从全量复制的时候，如果发生复制缓冲区溢出会导致全量复制失败，这个失败是指全部失败还是指rdb文件剩余部分同步复制失败，因为我知道的是每次从节点连接上主节点时会把当前对rdb复制偏移量给到主节点，主节点再判断是否重新全量复制还是从收到的偏移量位置开始复制</div>2020-09-28</li><br/>
</ul>