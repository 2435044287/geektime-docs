你好，我是陈现麟。

通过上一节课的介绍，你已经了解了分布式系统出现的原因和引入的新问题，并且我们一起讨论了这些新问题的处理思路。你对分布式系统的全局已经有了一个初步的认识，这就为后面的学习打下了良好的基础。

下一步，我们要从根本上理解分布式系统的设计方法和原则，这就需要你时刻谨记单体系统和分布式系统之间的差别。从本质上来说，单体系统是以单进程的形式运行在一个计算机节点上，而分布式系统是以多进程的形式运行在多个计算机节点上，**二者的本质差别就导致了分布式系统面临着四个方面的新问题，分别是：故障处理、异步网络、时钟同步和共识协同**。

所以，在这节课中，我们会从上述的四个方面来比较单体系统和分布式系统的差别，一起来探讨分布式系统会面临哪些新的挑战，而这些挑战又是怎么影响分布式系统的架构和设计的。

## 全部失败与部分失败

故障处理是所有系统都必须考虑的关键问题，所以我们从故障处理的角度开始分析。

单体服务系统中，在硬件正常的时候，对于一个确定的输入，总会得到一个确定的输出。就算是在内存、磁盘损坏等硬件异常的时候，对于一个确定的输入，计算机也会直接出现无法启动或崩溃的情况，而不是给出一个模棱两可或不正确的结果。

**这种全部失败的处理逻辑，会大大减轻用户使用计算机的心智负担，让我们明确地知道，如果系统内部发生了故障，计算机不会给出错误的结果，而是会全部崩溃**。那么处理计算机系统崩溃的方法就非常明确和简单了，重启计算机，重新运行程序即可。
<div><strong>精选留言（12）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/0c/f7/d6547adb.jpg" width="30px"><span>努力努力再努力</span> 👍（23） 💬（1）<div>分布式系统面临的4个方面的新问题 （分布式系统就是因为要解决这些问题 才会变成现在这样）
1. 故障处理 （全部失败 &#47; 部分失败）通过软件来容错 
       1.1 节点宕机
       1.2 网络分区
2. 异步网络 （本地调用和远程调用）采用超时机制
       1.1 远程调用模型面临的网络排队
       1.2 丢包
       1.3 请求服务崩溃
响应超时： 要进行重试
3. 时钟同步 （全局时钟 和 多个时钟）
       3.1 计算机中 时间的作用
              3.1.1 记录事件发生的时间
              3.1.2 事件之间发生的顺序
       3.2 谨记 系统中各个节点的本地时钟是存在误差的，不能依赖各自的时钟对事件进行排序
                 3.2.1 去请求同一个时间服务器获得事件对发生时间
                 3.2.2 Google 在 Spanner 中使用的，通过 GPS 和原子钟实现 TrueTime API 来解决
4. 共识协同 （一言堂 和 共识） （跨机器的多线程同步问题）
      4.1 选一个服务来做同步操作的管理者
      4.2 管理者 肯定也要高可用 -》 同步服务的选主问题
               4.2.1 Paxos 和 Raft 共识算法解决

思考题
CAP 一致性（Consistency）、可用性（Availability）和分区容错性（Partition tolerance）
1. 故障处理 AP 
2. 异步网络 AP 超时机制保证可用性
3. 时钟同步 CP 保证了一致性 和 事件发生的顺序
4. 共识协调 CP 强一致性 共识算法

Raft 协议 成熟的工业算法实现，比如蚂蚁金服的 JRaft、Zookeeper 的 ZAB、Consul 的 Raft、 百度的 braft、Apache Ratis; 
</div>2022-01-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c5/1f/8e9ee163.jpg" width="30px"><span>良记</span> 👍（7） 💬（1）<div>是不是可以简单理解为：分布式系统面临发挑战是“点→线→面”？ 
“点”是每个服务自己本身的故障&#47;异常处理，“线”是服务与服务之间的网络&#47;时钟异常处理，“面”是整个服务体现出来的异常结果处理，包括幂等性，协同等问题。</div>2022-02-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/78/15/a8b7315c.jpg" width="30px"><span>兔子先生</span> 👍（4） 💬（2）<div>老师，上一节也提到分布式系统引入新问题，这一节也是引入的新问题，为啥要分开讲呢？</div>2022-02-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/b8/bc/5f4c9cb2.jpg" width="30px"><span>掂过碌蔗</span> 👍（3） 💬（1）<div>分布式系统面临故障处理（部分失败）、异步网络、时钟同步和共识协调是手段；CAP 是目的。</div>2022-01-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f8/ba/d28174a9.jpg" width="30px"><span>Geek_zbvt62</span> 👍（1） 💬（1）<div>有一点需要纠正，单机时钟也可能漂移，所以不能说后面的一定比前面的单调递增</div>2022-04-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/a0/59/86073794.jpg" width="30px"><span>Hello,Tomrrow</span> 👍（1） 💬（1）<div>C（一致性）A（可用性）P（分区容错）
故障处理（部分失败），会影响系统的可用性、分区容错
异步网络，会影响系统的可用性，分区容错
时钟同步，会影响系统的一致性和可用性
共识协调，会影响系统的一致性
</div>2022-04-01</li><br/><li><img src="" width="30px"><span>愚人码头</span> 👍（1） 💬（1）<div>分布式面临的4个问题是必须要解决的，  是在分布式系统实现 cap 的前提和基础</div>2022-03-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg" width="30px"><span>peter</span> 👍（1） 💬（3）<div>请教老师两个问题：
Q1：退避策略是指什么？
   “并且对重试机制增加退避策略”，这句话中的退避策略是指什么？
Q2：故障处理在微服务中(SpringCloud)是哪个组件完成的？
   采用SpringCloud搭建微服务系统，在此系统中，“故障处理”是哪个组件完成的？
   还是说需要应用层软件来完成？
</div>2022-01-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/0a/e2/aa8c2de2.jpg" width="30px"><span>...</span> 👍（0） 💬（1）<div>单机拆开为多机协作，性能上来了，不可靠性也增多了，如网络通信、机器故障，这还是需要妥协的方案做理论支撑。</div>2022-04-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/23/bb/a1a61f7c.jpg" width="30px"><span>GAC·DU</span> 👍（0） 💬（1）<div>请问老师退避策略如何设计的？</div>2022-01-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/59/91/fa2d8bb2.jpg" width="30px"><span>不吃辣👾</span> 👍（3） 💬（0）<div>
CAP 中的P引起的这四个挑战。A和C是 指引者大家挑战成功的明灯。🤡</div>2022-04-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d4/f3/129d6dfe.jpg" width="30px"><span>李二木</span> 👍（0） 💬（0）<div>“而分布式系统是以多进程的形式运行在多个计算机节点上”，这句话表达有歧义，多进程一般都是描述在单个计算机节点上。我明白你的表达意思，但是觉得不太严谨。</div>2022-04-16</li><br/>
</ul>