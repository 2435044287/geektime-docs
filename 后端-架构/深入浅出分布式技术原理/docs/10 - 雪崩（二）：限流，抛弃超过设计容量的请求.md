你好，我是陈现麟。

通过上一节课的学习，我们了解了因为局部故障的正反馈循环而导致的雪崩，可以通过熔断来阻断，这样我们就为极客时间的后端系统，加上了熔断这一根保险丝，再也不用担心小故障被放大成一个全局的故障了，这让极客时间的后端系统，在稳定性上又向前跨进了一大步。

但是有的时候，我们明明知道一个服务的最高处理能力为 10 w QPS ，并且我们也知道这一次活动，这个服务的请求会超过 10 w QPS 。这个时候，如果只有熔断机制，我们就需要等待服务由于过载出现故障后触发熔断，然后再恢复正常，那么系统就是在被动地应对服务请求过载的问题。

其实这是一个典型的限流场景，那么，我们应该如何优雅地处理这个问题呢？在这节课中，我们将一起讨论，保障分布式系统稳定性的另一个方法——限流，从限流的原因入手，分析如何实现限流，再一起讨论限流机制要注意的关键问题，从这三个方面来分析，如何通过限流机制主动处理服务流程过载。

## 为什么需要限流

限流和熔断是经常一起出现的两个概念，都是用来解决服务过载问题的，那么在有了熔断机制后，为什么还需要限流呢？我认为主要有以下几个方面的原因。

**首先，熔断的处理方式不够优雅**。回到课程开始的例子，虽然在服务过载的时候，熔断可以避免雪崩的发生，但是熔断机制是被动感知故障，然后再进行处理的，它需要先让过载发生，等系统出现故障后，才会介入处理，让系统恢复到正常。
<div><strong>精选留言（7）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/2c/6b/6c/3e80afaf.jpg" width="30px"><span>HappyHasson</span> 👍（5） 💬（2）<div>Q：令牌桶和漏桶在使用上有没有很明显的区别（除了上游流量的抖动可能会扩散到下游服务 ）？我们业务每次在使用选择时都会犹豫比对很久，最后都选了令牌桶。</div>2022-02-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/d9/bd/d65fa667.jpg" width="30px"><span>宇智波鼬</span> 👍（3） 💬（1）<div>有个小建议：能否在每节课开始或结束时讲解下上节课的问题的参考答案</div>2022-03-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/3b/ad/31193b83.jpg" width="30px"><span>孙志强</span> 👍（1） 💬（1）<div>关于抗抖动能力，令牌桶和漏桶实现层面是如何防抖动的，比如60QPS，是把时间切分到Ms级别来处理吗</div>2022-04-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/59/91/fa2d8bb2.jpg" width="30px"><span>不吃辣👾</span> 👍（1） 💬（1）<div>老师 前面讲的固定窗口和滑动窗口给人的感觉就是不如令牌桶和漏桶。难道固定窗口和滑动窗口就没有应用场景了吗？这两个窗口可以被两个桶替代？</div>2022-04-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/96/47/93838ff7.jpg" width="30px"><span>青鸟飞鱼</span> 👍（1） 💬（2）<div>老师，觉得检测cpu和内存情况，来实现限流阈值的根据，会不会更好呢？</div>2022-03-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg" width="30px"><span>peter</span> 👍（0） 💬（2）<div>Q1：令牌桶部分：“也就是当请求流量突增的时候，上游流量的抖动可能会扩散到下游服务”
     有限流，怎么会扩散到下游？什么情况下会扩散到下游？
Q2：单节点限流，是说服务端只有一个节点吗？
      还是说服务端有多个节点但只在一个节点上进行限流？
      从后面看，应该是说某一个服务只有一个实例，即该服务只有一个节点，对吗？</div>2022-02-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg" width="30px"><span>Jxin</span> 👍（3） 💬（1）<div>1.限流限的是请求数，但哪怕是同接口的每个请求对资源的占用都是不相同的。在一个服务内多个接口的资源是共享的，所以限制单接口并无法阻止其他接口的请求占用导致的服务不可用。你根本没办法把服务的资源平分给每个接口的每个请求，所以限流的值准不了，仅能用来防止特殊时段特殊接口的激增场景导致的服务不可用。所以面向的是服务中可能有激争抢占大量资源的接口，与是否核心链路并没必要因果关系。核心链路上的限流，是在我们限掉了比如供应商拉单这些非核心链路的请求，让出全部资源后，还撑不住时追加的，比如下单。但不是所有核心链路都时常有这种激增场景，比如注册用户。

2.工作中都是eda 用mq，等于都是漏斗。</div>2022-02-25</li><br/>
</ul>