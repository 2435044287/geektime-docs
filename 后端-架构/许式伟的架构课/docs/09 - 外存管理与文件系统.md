你好，我是七牛云许式伟。

在 “[07 | 软件运行机制及内存管理](https://time.geekbang.org/column/article/93802)”中，我们已经聊了内存管理，这一讲我们聊聊外置存储设备的管理。

## 外存的分类

计算机有非常多样化的外置存储设备，比如：磁带、光盘、硬盘、U盘、SSD 等等。外置存储设备的种类是不可穷尽的。随着科技的发展，新的存储设备会不断涌现，有着更低的单位能耗（存储量/每日能源消耗成本），更低的单位存储成本（存储量/可存储的时间/设备价格），或者更高的访问性能。

但不管这些存储设备内部如何存储数据的原理怎么变，改变的主要是质量，而不是它的功能。对操作系统来说，管理它们的方式是非常一致的。这些外置存储设备依据其功能特性不同，简单可以分为如下三类。

- 顺序读写型。如：磁带。
- 随机只读型。更准确说是单次完整写入多次读取型，也就是每次写数据都是整个存储介质一次性完整写入数据。如：光盘（含可擦写光盘）。
- 随机读写型。如：软盘、硬盘、U盘、SSD 等等。

顺序读写型的外置存储（如磁带）我们日常并不常见，它的主要应用场景是归档，也就是数据备份。今天我们略过不提。

随机只读型的外置存储（如光盘）我们日常有较多应用，常见的应用场景是资料分发和归档。资料发布的内容很广泛，比如：软件、娱乐媒体包括电影、MTV、音乐等等。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/16/f6/08/ecf5d724.jpg" width="30px"><span>Enthusiasm</span> 👍（17） 💬（9）<div>关于外存管理，有个问题从之前就困扰我：磁盘的IO是由CPU完成的吗？但之前见到的说法是“CPU只能操作内存”。既然今天又提到了这个问题，文中提到“大量的磁盘 IO 操作，非常占用 CPU 时间”，那这两种说法是否矛盾？还想知道磁盘中的数据是怎么被加载到内存上来的呢？另外，更多的文章是说，“CPU的速度远远大于磁盘IO，CPU经常需要‘等待’磁盘IO”，这明显也是一种将CPU和外存割舍开的一种说法，而且按这种说法，CPU不光无需分配很多时间片给IO，而且还有很多“等待”时间。这也和本文中“非常占用CPU时间”相矛盾吧？</div>2019-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/f5/78/f495890c.jpg" width="30px"><span>开放(深度学习学者)</span> 👍（14） 💬（4）<div>太简单了感觉，基本没有怎么说清楚，第一硬盘存储其中一个文件他是怎么存放的数据块和元数据是怎么结构，inode是什么，还有数据和元数据的索引表，甚至作为文件系统ext3的多层表索引和12个直接链接，一个单层，和多层索引等等都没说，文件系统的整体架构，特别是到底怎么优化等等也没说，还有虚拟内存，具体程序段怎么映射到物理内存，空余内存怎么管理，虚链表，对应的两难性能问题怎么解决？
</div>2019-05-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/60/45/c6302327.jpg" width="30px"><span>陈光</span> 👍（12） 💬（1）<div>老师，能否简单介绍一下基于内存的数据结构和基于外存的数据结构有何不同？我们平时所说的“数据结构和算法”是不是偏向于内存？另外，“路径冲突”是不是指多个进程同时访问同一个文件？</div>2019-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/fc/47/a4be64d8.jpg" width="30px"><span>Liber</span> 👍（10） 💬（1）<div>许老师，把你的知识掌握了去七牛应聘会不会so easy？</div>2019-09-28</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK9Ijx19rLDhOrF9TicDeaq1lUr2vyTiajWIQiaNoWs9JLQqtiacyx0ffuib4qvaVdvk7WLvLib1oqRfAlA/132" width="30px"><span>大糖果</span> 👍（9） 💬（3）<div>老师好，有个问题，就是关于Windows自带的文件搜索，我们都知道那东西很慢，但是有一款everything的软件却可以做到很快，微软的技术是不用质疑的，他们为什么不把这个文件搜索做快点呢？还是这样的软件会有别的损耗？</div>2019-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f7/20/e2dfa9c2.jpg" width="30px"><span>花儿与少年</span> 👍（5） 💬（2）<div>怎么越来越像计算机组成原理了。希望更多的软件架构知识</div>2019-05-17</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJSmAhbvPia1msvk91m5rQLTpicY85f2moFMCcAibictL3OeiaaVREadpHN2O3FwicmylwiclTUJJa1peS1Q/132" width="30px"><span>张sir</span> 👍（4） 💬（2）<div>许老师，我有两个疑问， 1.如果操作系统的swap占用过高，会直接影响cpu性能吗。2.路径的冲突检查机制，是不是就是像mysql服务那样，当服务运行起来后，就会创建xxx.pid文件保存进程的pid，来保证进程的互斥</div>2019-07-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/b4/63/59bb487d.jpg" width="30px"><span>eletarior</span> 👍（4） 💬（2）<div>看回复 ,很多人和我一样,对&quot;Unix的一切皆是文件不是最佳实践&quot;这个论点,有困惑.如果在图形界面时代的一切皆文件这样的架构设计不再适宜,为何类unix的设计者不改变这种设计,或者说,从架构的角度说,这样的设计定型了,是不是就不好改了?本课的主题其实是外设的统一接口是文件系统,那么把外设都当做文件进行抽象化处理,不出很合适么?</div>2019-05-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a5/5f/05d97868.jpg" width="30px"><span>DaDo Wang</span> 👍（4） 💬（1）<div>想到了HDFS(Hadoop Distributed File System )，文中说的文件系统和HDFS应该不属于一个层吧？个人理解，HDFS应该全是更上层的应用软件层文件系统，它在外置存储的文件系统上，做了对分布式的文件进行管理的功能还请老师解答～😁</div>2019-05-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/cf/97/fcd8957d.jpg" width="30px"><span>82</span> 👍（4） 💬（1）<div>多个进程去访问修改相同的外存地址文件时，谁来控制并发修改是操作系统还是外设驱动程序？
如果提高外存的访问速度是否可以减少缺页的处理时间，进而一定程度缓解卡顿的情况？
</div>2019-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/96/b4/040110ac.jpg" width="30px"><span>ༀ醉里挑灯看剑༄</span> 👍（4） 💬（1）<div>缺页产生是因为长时间没有用的内存地址淘汰所以需要写入swap中进行保存，频繁的产生是说很多内存地址长时间没有用么？那这是怎么产生的呀
</div>2019-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/cb/a2/5e7c557e.jpg" width="30px"><span>傲娇的小宝</span> 👍（3） 💬（1）<div>因为很多东西没学过，或者没这么深入，感觉自己要学习的还很多很多。</div>2019-05-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/45/50/5e016fa7.jpg" width="30px"><span>庆增</span> 👍（3） 💬（1）<div>再深入一点就好了，比如文件系统是如何恢复数据的。</div>2019-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/58/0f/8ed4be99.jpg" width="30px"><span>零度</span> 👍（2） 💬（1）<div>老师，swap用来保存缺页中断时内存中最早没使用的内存数据，linux分区时一般将swap大小设置为物理内存的2倍，但频繁缺页中断肯定会有很多内存数据保存到swap，如果swap也满了，请问接下来swap是怎么处理？</div>2019-12-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/20/b7/bdb3bcf0.jpg" width="30px"><span>Eternal</span> 👍（2） 💬（1）<div>老师可以在整篇文章的开头加上一个简单的目录吗？</div>2019-07-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/be/b9/f2481c2c.jpg" width="30px"><span>诗泽</span> 👍（2） 💬（1）<div>请问，分区的格式化是由操作系统的文件系统管理程序完成的吗？比如Linux 支持ext3和ext4两种格式那么操作系统会内置两种文件系统管理程序吗？文件系统管理程序从某种角度可以理解为是一种“驱动”吗？谢谢！</div>2019-05-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/db/26/54f2c164.jpg" width="30px"><span>靠人品去赢</span> 👍（2） 💬（2）<div>这个外存的数据格式NTFS我也是装系统的时候见到过，没有去考虑过这是一个什么东西。这个格式是有日志的，想问一下数据恢复可不可以借助日志，可以的话为什么数据恢复，机械盘可以固态盘就很大概率凉凉？</div>2019-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/69/44/1588e8b6.jpg" width="30px"><span>刘文坛</span> 👍（2） 💬（1）<div>老师您好，对于“一切皆文件”很多时候不是最佳实践，能举个例子吗？不是很理解</div>2019-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/aa/4d/c7df89bf.jpg" width="30px"><span>宝宝疯</span> 👍（2） 💬（1）<div>简单明了，如果能再深入些就更好了👍🏼</div>2019-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/1d/7d/368df396.jpg" width="30px"><span>somenzz</span> 👍（1） 💬（1）<div>一切皆文件是多么优雅的设计，正如对CPU来讲一切皆数据，为什么不是最佳实践，能讲讲吗？</div>2021-09-01</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK8o3aJz4NdqOCWvTjIPGmRWHt5xicwKGGGRd5icCoiauvvtnEtST0ljsuM23wiaYbZLknASvXmmqfg1w/132" width="30px"><span>茅延安</span> 👍（1） 💬（1）<div>见过《程序员的数学基础》，本课程某种意义上可以称为《架构师的计算机基础》，将你和那些面向抽象、面向中间件的架构师区分开来。
</div>2019-10-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/16/ed/f70c4020.jpg" width="30px"><span>Sam.Ye</span> 👍（1） 💬（1）<div>“检查文件是否存在，不存在就创建它”，这个语义在保证原子性的前提下，就可以用于做进程间的互斥。例如，我们希望一个软件不要运行多个进程实例，就可以基于这个机制来实现。
不是很理解这句话，怎么做进程间的互斥？又是怎么基于这个机制来避免运行多个进城实例？</div>2019-05-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/d0/a0/22a43b5b.jpg" width="30px"><span>cnanlnanc</span> 👍（1） 💬（1）<div>迫不及待地想听听有关架构重构的知识，毕竟这些才是几乎每个程序员每天都会面临的问题吧</div>2019-05-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/28/fe/fa12b300.jpg" width="30px"><span>Ryan</span> 👍（1） 💬（1）<div>对外置存储进行分区和格式化，是操作系统落实的吗？</div>2019-05-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/69/44/1588e8b6.jpg" width="30px"><span>刘文坛</span> 👍（1） 💬（1）<div>linux把键盘、显示器看做设备文件，虽然不使用stdin stdout，仍然是以文件方式来操作硬件设备，还是没理解“一切皆文件”为什么很多时候不是最佳实践，或者说“一切皆文件”有什么显著弊端？</div>2019-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/d9/b8/2d8900d5.jpg" width="30px"><span>史鹏飞</span> 👍（1） 💬（1）<div>许老师，共享内存的机制，是在内存上开辟的空间吗？服务器断电重启共享内存的数据是不是就丢失了？</div>2019-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c7/73/744a2212.jpg" width="30px"><span>SA</span> 👍（1） 💬（3）<div>许老师您好，有个疑问请教一下，就是各类不同的存储数据格式底层肯定是需要操作系统支持才行吧？比如现在七牛云如果研制了一款新的存储设备，使用了新的文件系统，要Windows10支持的话，Windows10必须适配才行。</div>2019-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/f5/ce/7d8807d5.jpg" width="30px"><span>WadeYu</span> 👍（1） 💬（1）<div>这里说的虚拟内存跟前面讲解内存管理时说的虚拟内存不是同一个概念吧</div>2019-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/21/63/f47576e1.jpg" width="30px"><span>永钱</span> 👍（1） 💬（2）<div>但事实证明 UNIX 错了。输入输出设备太多样化了，所谓的 “一切皆文件” 不过是象牙塔式的理想。就拿键盘和显示器来说，图形界面时代到来，所谓标准输入和标准输出就被推翻了，编程接口产生颠覆性的变化。  
老师，这句话怎么理解，现在unix不是一切皆文件么？</div>2019-05-14</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJkeOAC8k7aPMfQZ4ickiavpfR9mTQs1wGhGtIicotzAoszE5qkLfFTabkDU2E39ovSgoibJ1IiaLXtGicg/132" width="30px"><span>bigben</span> 👍（0） 💬（1）<div>先有文件系统还是先有操作系统？</div>2022-11-01</li><br/>
</ul>