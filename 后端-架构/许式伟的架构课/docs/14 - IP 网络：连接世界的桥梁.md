你好，我是七牛云许式伟。

到目前为止，我们介绍了操作系统的六大子系统中的四项：进程、存储、输入、输出。当你理解了这些东西背后的道理，基本上做一款单机软件就游刃有余了。

但是，如果仅仅局限于单机，一台计算机并不见得比计算器高明太多，网络对整个信息科技的重要性不言而喻。它让计算机连接在了一起，这一连接就发生了巨大的变化。

没有了网络，我们只能用 Office 软件，玩玩扫雷。没有网络，就没有 QQ 和微信，不会有淘宝和支付宝，也不会有 BAT。

网络连接一切。它连接了人（个人和企业）、服务（由软件系统构建的服务接口）和物（大自然产物和智能终端），构建了多姿多彩的互联网。

它让地球上的任何两个人都可以随时随地进行沟通，远程做生意。在互联网出现之前，旧的商业文明我们可以一言以蔽之：一手交钱，一手交货。而建立在互联网之上的新商业文明，我们一手下单付款，一手收钱发货，足不出户，货物就通过便捷的物流服务送到了你手上。

这是多么巨大的效率变革，但这一切是怎么做到的呢？

## 数据的封包过程

网络和其他所有的输入输出设备一样，只能交换数据。无论你要对方做什么，你首先需要发送对方理解得了的数据给它。所以双方要就沟通的语言达成共识，这就是网络协议。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/15/5b/79/d55044ac.jpg" width="30px"><span>coder</span> 👍（44） 💬（7）<div>许老师觉得，从架构设计的角度去看，我们可以学到什么呢？</div>2019-05-31</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIiaXxkpSSZP2oWhPGYFJ9icGcfKt5kHNxLfdpFibNjIU8L3ky3MASMiaP6swkMePj9tcbG3A8ficlN1TQ/132" width="30px"><span>kirajun</span> 👍（19） 💬（1）<div>老许，现代的交换机和路由器的概念已经发生了变化了，不再是 L2&#47;L3 的差异了。个人理解，交换机是服务于以太网的 L2&#47;L3 网络设备，而路由器是服务于以太网和非以太网之间的网络设备。</div>2019-06-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/cf/97/fcd8957d.jpg" width="30px"><span>82</span> 👍（13） 💬（3）<div>老师好
 1，网络传递最根本是通过mac地址来投递的,所以mac地址必须全球唯一，那么在生产网卡时如何保证地址不重复？
2，交换机中缓存mac与端口的映射关系，那如果将设备从北京搬到上海，原有的交换设备缓存是否有问题，它是如何刷新映射关系的？
3，如何解释不同局域网ip可以重复的问题？
4，交换机是否会缓存所有路过他的映射关系，由于互联网链接巨多设备，那么每台交换机是否有最小内存限制？</div>2019-05-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/6a/58/f2c6d65b.jpg" width="30px"><span>王棕生</span> 👍（6） 💬（2）<div>什么是 Full cone NAT？它是指 NAT 网关临时建立了 iAddr:port1 &lt;=&gt; eAddr:port2 双向映射后，任何主机给 eAddr:port2 发送数据包，都会被转给 iAddr:port1，并不局限于构建这个映射时数据包发送的目标主机是谁。
许老师，这段文字中【并不局限于构建这个映射时数据包发送的目标主机是谁】这句话不是很明白，既然 iAddr:port1 确定了，目标主机肯定就是确定的了</div>2020-05-12</li><br/><li><img src="" width="30px"><span>Geek_88604f</span> 👍（4） 💬（1）<div>从网络分层架构中可以学到很多，其分层架构与系统架构和业务架构本质上是一致的，所谓大道至简，优秀的架构设计其内在基因是相似的。
        从网络分层的整体上看，最底层是物理连线，传递的是电平信号。这是网络的原生能力---相当于云服务架构中的各种物理的CPU、内存、磁盘和网络。
        上一层是数据链路层，这一层基于物理能力进行逻辑增强，包括将数据转换成帧、添加校验信息，帧定界与同步，发送前的链路冲突检测，链路层流量控制（收不下不回复确认）---提供的是同一条链路上两点之间的传输能力。
        注意这里是两点之间的连线，是线，还没有组成网络。由于物理上的限制，根本无法达到更远的地方，需要由链路组成网络来完成，这是一次巨大的能力跃升，而组成网络的链路的种类多种多样。因此这张由链路组成的网络需要解决两台主机之间采用标准协议进行通信的问题:分组和路由，涉及的主要设备是路由器---这一层就是IP层。这个IP层相当于云服务的IaaS层，对下封装各类虚拟化资源的差异，向上提供统一的资源访问接口。
       由于IP层提供的逻辑通信能力还比较弱---尽力而为。不保证是否到达、顺序是否正确、数据是否完整，即是一种不可靠的发送方式。同时IP层通信是面向主机的，需要IP地址，两台网络主机上不同的进程之间通信不适合都用IP。因此，需要更上层的协议来提供两个能力:将主机之间的通信服务扩大到进程之间（传输层的多路复用）；提供网络层传输控制能力。 这就是TCP&#47;UDP层（这一层涉及的主要设备是网关）。让人联想到云服务的容器化PaaS层，对资源分配进一步细粒度控制，同时提供了可扩展性、容灾、备份、故障恢复等能力。
        在整个网络架构中，还有一些协议提供了网络运维与管理、故障诊断的能力，如ICMP、IGMP协议。这些协议就好比云服务分层架构中左右两侧上顶天下扎根的运维运营、告警监控、日志审计等能力。这个网络分层架构相当优雅，它是如何形成的呢?是从下而上还是从上而下，亦或兼而有之。</div>2022-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg" width="30px"><span>Jxin</span> 👍（4） 💬（1）<div>请收下我的膝盖。如果不是看完趣谈网络协议。这一章我怕是完全看不懂。</div>2019-06-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e7/cd/08088f14.jpg" width="30px"><span>马哲富</span> 👍（4） 💬（3）<div>文中所指的“端口”可以理解为“一台物理的计算机”吗?</div>2019-06-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/6a/58/f2c6d65b.jpg" width="30px"><span>王棕生</span> 👍（2） 💬（1）<div>非 Full one NAT 场景下，我觉得 NAT网关可以对应该局域网中的多个目标主机，也就是，这些目标主机虽然没有公网IP，但可以通过 非 Full one NAT对外提供多个公网的服务。
麻烦许老师点评一下！</div>2020-05-12</li><br/><li><img src="" width="30px"><span>Geek_88604f</span> 👍（2） 💬（1）<div>源主机和目标主机在不同的局域网内，且都没有公网 IP。在这种情况下，他们也无法发送数据到中间人服务器</div>2019-06-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a1/cd/2c513481.jpg" width="30px"><span>瀚海星尘</span> 👍（1） 💬（3）<div>老师，如果路由器能通过端口来做内网转发，那为什么一般都说它是网络层设备？不是应该是传输层设备了吗？</div>2019-06-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6c/ea/ce9854a5.jpg" width="30px"><span>坤</span> 👍（0） 💬（2）<div>小区宽带一般会给每户提供一个私有IP，即WAN口的IP地址，请问是这样的吗？</div>2019-07-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/af/00/9b49f42b.jpg" width="30px"><span>skye</span> 👍（0） 💬（1）<div>老师好！情形二下，公网ip发的包到路由器后为什么还要拆包重组，拆包重组是干什么？</div>2019-06-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/48/f3/65c7e3ef.jpg" width="30px"><span>cricket1981</span> 👍（0） 💬（1）<div>情形一下若发包过程中目标机端口变了，交换机仍按原端口发的话，如何发现发送失败？若能发现失败，是否又要全员广播重新获取新的端口？</div>2019-06-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/50/4a/04fef27f.jpg" width="30px"><span>kdb_reboot</span> 👍（20） 💬（0）<div>更新了 赞一下作者写作的态度</div>2019-06-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7e/bb/947c329a.jpg" width="30px"><span>程序员小跃</span> 👍（10） 💬（0）<div>大学的计算机网络和这个比起来，这个详细多了。比如那个七层网络协议，5层网络协议，以前都是死记硬背的。我可能是个假科班出身</div>2019-06-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/b3/c5/7fc124e2.jpg" width="30px"><span>Liam</span> 👍（9） 💬（0）<div>wan数据传输，ARP解析的是LAN路由器的mac地址，而不是目标主机的mac地址</div>2019-05-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/41/27/3ff1a1d6.jpg" width="30px"><span>hua168</span> 👍（7） 💬（0）<div>CCNA的内容，鉴定完毕</div>2019-06-02</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLluwfFjxlCmg9p2rJVicBdBo6OYpN0EAotUguias8wc78WtAEPHsWic0880CqGwyNypy2KZqVpYhGiag/132" width="30px"><span>Geek_gooy</span> 👍（6） 💬（0）<div>想一种办法来消化网络通讯。
两台电脑用网线直连，相当于在一起的两个人直接交流，不用叫名字(无mac)也能沟通。
村子里的两个人交流，告诉村子里的某个负责传话的人，说姓名就行(有mac)，不用地址(无ip)。
要联系村以外的人，得用地址和姓名(有mac有ip)。
</div>2019-06-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/d6/13/d365cecb.jpg" width="30px"><span>M.K</span> 👍（5） 💬（0）<div>很清楚的从架构的角度诠释了网络分层的意义，以及从宏观角度介绍了每一层的职责。前人智慧的结晶在我们做框架设计时，非常有参考价值。</div>2019-05-31</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83eop9WylZJicLQ5wib49kcMPqCTRT1aThh6mMAVl6qseLwbVOLhicVLjZCxCoyQd5CrrHHibs2CVPaoK3g/132" width="30px"><span>ljf10000</span> 👍（4） 💬（0）<div>arp是用于查下一跳的mac地址，不是查目的ip的mac地址。</div>2019-05-31</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83eop9WylZJicLQ5wib49kcMPqCTRT1aThh6mMAVl6qseLwbVOLhicVLjZCxCoyQd5CrrHHibs2CVPaoK3g/132" width="30px"><span>ljf10000</span> 👍（3） 💬（0）<div>网络是个大而复杂的领域，我们能在这里面学到思维的主要是分治，水平分，垂直分。建议无需多讲，感兴趣去看tcpip详解即可。</div>2019-06-04</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLwSoTjHPX5tuvQ44WvwibibVoAdUSia3EdXP4fR3nyJUhLWUmVxl3jibMuVb8uZViaRsy5nAyzicBN06VA/132" width="30px"><span>小豆角</span> 👍（2） 💬（0）<div>非常赞，干货，许总功底深厚。同时买了几个课，看了开头之后，就对这个课爱不释手了，最值的。</div>2020-02-21</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIWTnR1vgM3f7matwO0VvXQfA1nkgfS7PWiaYIa9h9NbuUUxQSO4KPDqPopSZiarBxFHIdwFDeG0kQg/132" width="30px"><span>zzx10</span> 👍（2） 💬（0）<div>好长一篇,内容很充实，基础太差没法一口气看完。mac-&gt;ip-&gt;域名，中间有各种协议转换，通过交换机和路由传输，找寻目标主机通信。</div>2019-06-05</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIicbH65wBhSCWa5eBF4gFaia5ngkttTzprdicJaDcOMgwAYrFbpQfJ0z6OichE6qphpicqsq87Lam0X5A/132" width="30px"><span>Sylh</span> 👍（2） 💬（0）<div>公网传输一样也会依赖mac地址的，比如两个路由器之间的转发。隧道之类的可能不依赖mac地址</div>2019-06-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/af/27/76489618.jpg" width="30px"><span>sunsweet</span> 👍（2） 💬（2）<div>保证Mac地址全球唯一，我的老师说过，各个网卡厂商都有自己固定的几位，在Mac地址上，厂商只要保证剩余那些位不重复就好了</div>2019-05-31</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKx6EdicYYuYKibnUiajL1ba1cmzXpK6RmvAoIX4mTgdzVELf6Ljzk2chQIBhk37xRuOAnAwtOjkaRMA/132" width="30px"><span>stern</span> 👍（2） 💬（0）<div>源主机和目标主机不在同一个局域网内，源主机的信息：IP:192.168.0.1&#47;MAC:C01，源主机所在网络路由器信息：IP:10.20.12.2&#47;MAC:R01，目标主机的信息：IP:192.168.0.1&#47;MAC:C02，目标主机所在网络路由器信息：IP:20.20.16.2&#47;MAC:R02，源主机往目标主机发送数据，数据包中源IP、目标IP、源MAC地址、目标MAC地址的变化是什么样子的？</div>2019-05-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e0/99/5d603697.jpg" width="30px"><span>MJ</span> 👍（2） 💬（0）<div>说的明明白白了，也听的明明白白。谢谢老师</div>2019-05-31</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLDOKcx20XxmrRrLkelN8yAsBk0ZcuremVN7lZp4U2kdABFULtEVmCgaFlJLh1TYia0kicPbvxeZQNg/132" width="30px"><span>Geek007</span> 👍（1） 💬（0）<div>第一次看到把网络协议和物流协议类比，精彩！</div>2019-12-30</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ermRibwXSt1icBvH3IO1JfiaqakIcxxAP4zSkicewogKVWCFicb0NVc7tF3xSVMJwE3lBg2gH4r7u6sGtw/132" width="30px"><span>pawhrmyki</span> 👍（1） 💬（0）<div>太好了，终于把基本的广域网和局域网之前的数据交换模式厘清了</div>2019-05-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/7a/08/4d3e47dd.jpg" width="30px"><span>Aaron Cheung</span> 👍（1） 💬（0）<div>打卡04 学习了</div>2019-05-31</li><br/>
</ul>