你好，我是七牛云许式伟。

存储系统从其与生俱来的使命来说，就难以摆脱复杂系统的魔咒。无论是从单机时代的文件系统，还是后来 C/S 或 B/S 结构下数据库这样的存储中间件兴起，还是如今炙手可热的云存储服务来说，存储都很复杂，而且是越来越复杂。

## 异常处理才是存储的业务逻辑

存储为什么会复杂，要从什么是存储谈起。

让我们简单回顾一下 “[36 | 业务状态与存储中间件](http://time.geekbang.org/column/article/127490)” 的核心逻辑。

存储这个词非常平凡，存储 + 计算（操作）就构成了一个朴素的计算机模型。简单来说，存储就是负责维持计算系统的状态的单元。从维持状态的角度，我们会有最朴素的可靠性要求。

比如单机时代的文件系统，机器断电、程序故障、系统重启等常规的异常，文件系统必须可以正确地应对，甚至对于磁盘扇区损坏，文件系统也需要考虑尽量将损失降到最低。

到了互联网时代，有了 C/S 或 B/S 结构，存储系统又有了新指标：可用性。为了保证服务质量，那些用户看不见的服务器程序必须时时保持在线，最好做到逻辑上是不宕机的（可用性100%）。

服务器程序怎么才能做到高可靠、高可用？

答案是存储中间件。没有存储中间件，意味着所有的业务程序，都必须考虑每做一步就对状态进行持久化，以便自己挂掉后另一台服务器（或者自己重启后），知道之前工作到哪里了，接下去应该做些什么。
<div><strong>精选留言（27）</strong></div><ul>
<li><img src="" width="30px"><span>Geek_88604f</span> 👍（33） 💬（1）<div>        说到hdfs的文件块，首先看看为什么用块来管理而不用文件。因为块有如下优势:单文件的大小不会受到单节点容量的限制，文件的不同的部分可以存储到不同的节点上；容易对数据进行备份提高容错能力，可以按快来备份；可以按照块来并发处理提高吞吐量。从整体上来看简化了存储系统的设计，一是按照块来设计可以很容易地估算出一个节点可以存出多少文件块；二是方便元数据管理，元数据可以和文件块分开存储，我理解桌面存储系统下的树形结构是做不到的。
        那么块设置过小有什么不良影响呢？大概有以下几个影响:文件过小导致磁盘随机寻址操作变多，从而影响磁盘效率；网络开销也随之增大；元数据增多Namenode很快达到瓶颈；处理任务的task不断的启动、销毁，效率低下。
        但是也不能一味的往大里设置，过大也会带来不良影响:数据块越大数据加载时间越长，系统恢复过程也越长；监控方面的预设时间间隔和数据量有关；数据块越大对算法也是一个挑战。
        需要特别说明的是当文件大小小于块大小时，它占用的空间是小文件的实际大小，并非快的大小。hdfs对小文件是做了一些优化的，例如:hadoop archive、sequence file、combinefileinportformate。</div>2019-09-05</li><br/><li><img src="" width="30px"><span>Geek_88604f</span> 👍（12） 💬（1）<div>非结构化和结构化数据的键值存储，实现机制上往往有极大的差异。主要体现在哪些方面，许老师？</div>2019-09-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/20/2d/dfa5bec8.jpg" width="30px"><span>Han</span> 👍（9） 💬（1）<div>老师，mysql等关系数据库的索引都是基于文件，那这种数据库底层实现都是基于操作系统的文件系统吗？ </div>2020-06-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg" width="30px"><span>安排</span> 👍（6） 💬（1）<div>对象存储底层实现时还会经过操作系统自带的文件系统吗？还是说对象存储操作的直接是裸盘？相当于自己重新实现了文件系统功能？</div>2019-09-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/18/03/ef0efcc4.jpg" width="30px"><span>EidLeung</span> 👍（4） 💬（1）<div>“第一，HDFS 的 block 大小为 64M，如果文件不足 64M 也会占用 64M。”这句话有问题吧，HDFS的问题是文件的元数据存储在内存中，因此不适合小文件。不足64M（现在好像是128M了吧）的小文件在HDFS中存储只是在磁盘多了一些元数据信息而已，文件大小还是原来的大小啊。</div>2019-09-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/dc/f8/9bc56db2.jpg" width="30px"><span>yga</span> 👍（3） 💬（1）<div>假设集群总的容量规模不变，但我们不是增加单台机器的磁盘数量，而是增加磁盘的密度。比如，我们把单盘容量增加一倍，那么我们集群的磁盘数也减少一半。这样我们的修复时长 T0 会变成 4T0（修复时间和要修复的数据量成正比，和集群可用的磁盘数成反比）——
T0怎么变成4T0？修复时间和数据量成正比，和集群可用磁盘数成反比。为什么呢，希望老师能解答</div>2019-09-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c7/d6/32d7bd4e.jpg" width="30px"><span>zhuyc</span> 👍（2） 💬（1）<div>对象存储消除了结构化的关系和影响，那么对象间的关系，例如 原图与缩略图 的关系，是维护在另一个系统中吗？</div>2019-09-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg" width="30px"><span>安排</span> 👍（2） 💬（1）<div>结构化数据和非结构化数据啥区别啊？表结构就是结构化数据吗？</div>2019-09-06</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/3XbCueYYVWTiclv8T5tFpwiblOxLphvSZxL4ujMdqVMibZnOiaFK2C5nKRGv407iaAsrI0CDICYVQJtiaITzkjfjbvrQ/132" width="30px"><span>有铭</span> 👍（2） 💬（3）<div>老师，你提到七牛云的对象存储是没有目录这个概念的；我记得阿里的oss是有的，也就是说，两者的实现原理并不一样？</div>2019-09-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a3/25/5da16c25.jpg" width="30px"><span>coyang</span> 👍（1） 💬（1）<div>在分布式系统中维护文件系统的目录树结构，会遭遇诸多难题。所以 HDFS 想把 Master 扩展为分布式的元数据集群并不容易。-&gt;GlusterFS就是分布式的元数据集群，没有master，active&#47;standby的概念。实现也很复杂。许老师能不能说一下未来分布式存储的趋势？个人感觉分布式文件系统还会长期保留来适应老的application迁移到分布式系统不用做任何改变。</div>2019-09-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/db/26/54f2c164.jpg" width="30px"><span>靠人品去赢</span> 👍（1） 💬（1）<div>对象存储学到了，但是文件系统，路径，文档这些概念已经习惯有时候转不过来，突然你说这是个对象可能理解不了，觉得这不就是一个IO流写入的文件吗。
还有提高磁盘密度对持久化有影响，是不是我可以理解像机械硬盘叠瓦式（支持磁道可重叠，提高单盘容量），固态（一个单元储存的byte越来越多，QLC，PLC都要出来了）是不是都是，不仅修复难而且掉盘率搞，读写速度感人，这些硬件的影响。</div>2019-09-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e1/f7/33a69a0f.jpg" width="30px"><span>JACK</span> 👍（1） 💬（2）<div>36.5是怎么算出来的?麻烦再讲解一下，谢谢！</div>2019-09-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg" width="30px"><span>ifelse</span> 👍（0） 💬（1）<div>Gfs3副本3块盘可以坏2块，七牛云32盘可以坏4块，算起来可靠性还是2&#47;3大于4&#47;32吧？</div>2023-09-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg" width="30px"><span>neohope</span> 👍（0） 💬（1）<div>海量小文件（LOSF，lots of small files）的存储是很多公司都遇到的难题，很多互联网公司都有自己的解决方案，比如Facebook的Haystack、淘宝的TFS等。想问下许老师，七牛云在应对LOSF问题上，做了哪些优化呢？感谢！</div>2021-10-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/60/36/1848c2b7.jpg" width="30px"><span>dovefi</span> 👍（0） 💬（1）<div>“也就是说，集群规模越大，存储的可靠性越高。当然，这一点的前提是前面我们的假设，修复速度和集群规模成正比成立” 如果规模越大发生了故障，影响面也会越大，从这个角度看，规模越大也并不是越好？</div>2020-06-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/20/2d/dfa5bec8.jpg" width="30px"><span>Han</span> 👍（0） 💬（1）<div>请问对象存储和键值存储有何区别，是指同一回事吗？ 看您之前对存储中间件做过分类，有数据库，键值存储，对象存储等</div>2020-06-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/12/f9/7e6e3ac6.jpg" width="30px"><span>Geek_04e22a</span> 👍（0） 💬（1）<div>纠删码是什么原理呢？</div>2020-02-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ac/96/46b13896.jpg" width="30px"><span>williamcai</span> 👍（0） 💬（1）<div>mc冗余码，数据切成28片➕4份冗余，这4分冗余那些数据</div>2019-09-04</li><br/><li><img src="" width="30px"><span>Geek_88604f</span> 👍（0） 💬（1）<div>假设集群总的容量规模不变，我们把单台机器的磁盘数量增加一倍，那么我们需要的机器数量减少一半。但由于磁盘数量不变，我们的修复时长 T0 也不变（假设网络和 CPU 计算力都不是瓶颈）。假设原本丢失数据的概率是 p，那么现在丢失数据的概率还是 p。——这个描述是不是有些小问题？前半段说磁盘数量增加一倍，后半段又说磁盘数量不变。</div>2019-09-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/36/f7/177d77d7.jpg" width="30px"><span>ch</span> 👍（10） 💬（0）<div>gfs和ec那部分对比计算出38%应该是ec(28+4)&#47;gfs(28*3)=32&#47;84。感觉这样表述直观点。</div>2019-09-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/be/b9/f2481c2c.jpg" width="30px"><span>诗泽</span> 👍（6） 💬（2）<div>想到了Facebook 那篇关于小图片存储的论文🤣</div>2019-09-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/7a/08/4d3e47dd.jpg" width="30px"><span>Aaron Cheung</span> 👍（5） 💬（0）<div>存储这块是七牛的业务强项 从许老师这里学习了 38</div>2019-09-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/b9/8d/00bded19.jpg" width="30px"><span>不温暖啊不纯良</span> 👍（0） 💬（0）<div>关于异常的理解。

存储系统和业务系统中的异常，都是在满足业务时出现的异常，只不过每个存储系统天生都会面临两个异常情况，数据安全和存储服务可靠性。关于数据安全，我记得密码学中有一段历史，如古时候的人为了把自己的知识传递给后人，在一块石碑上用三种不同的文字写了同一段内容，就是为了防止在未来石碑会出现损坏，这就像现在我们把，同一份数据备份在不同的服务器上，就算某一两个服务器故障，在可靠性上还是能够得到保证。

关于持久性的两个指标。

一个是修复损坏磁盘的时长，通过老师的描述可以得知，我们在使用磁盘存储的时候，磁盘是有磨损的，当时把磨损到一定程度，数据就会损失，于是每个磁盘自带修复功能，就是在闲的时候来修复磁盘的磨损保证它的耐用性，修复的时长会因为磁盘的数据密度增大而变长。二是容错能力，容错能力就是同时允许几块硬盘损坏且不影响正常使用的能力ec算法是将数据切片，分别存储到32个磁盘或存储节点，为什么说他最多能够支持4个磁盘损坏呢，因为其中28份数据是一份数据的切割，剩余4份全是备份，</div>2021-04-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ee/d2/7024431c.jpg" width="30px"><span>探索无止境</span> 👍（0） 💬（0）<div>老师你好，像淘宝开源的FastDFS本身也是支持水平扩展，但其存放的文件，也是有path路径，而且从store节点来看，是确实以目录的方式来存放的，那么FastDFS从本质来说依然是采用文件系统的方式来存储，而不是我们现在讨论的对象存储，不知道这样理解是否正确？请老师指正</div>2020-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/f1/12/7dac30d6.jpg" width="30px"><span>你为啥那么牛</span> 👍（0） 💬（0）<div>成本与持久性这块，还挺烧脑的！</div>2019-11-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/d6/ae/46ae526f.jpg" width="30px"><span>醉雪飘痕</span> 👍（0） 💬（0）<div>许老师好，
假设 RAID5 的数据修复时间是 1 天（实际上往往做不到，尤其是业务系统本身压力比较大的情况下，留给 RAID 修复用的磁盘读写带宽很有限），这种方案单机的可靠性大概是 100 年丢失一次数据（即可靠性是 2 个 9）。
请问这个100年是怎么算出来的？</div>2019-09-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f0/de/ef564e67.jpg" width="30px"><span>歌在云端</span> 👍（0） 💬（0）<div>像老师请教一个问题，对象存储是怎么持久化到硬盘的？也是序列化之后存吗？请问一下跟文档型数据库类似MongoDB有什么区别</div>2019-09-06</li><br/>
</ul>