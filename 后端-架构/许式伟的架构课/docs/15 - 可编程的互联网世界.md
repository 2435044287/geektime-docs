你好，我是七牛云许式伟。

前面我们讨论架构思维的时候说过，架构的第一步是做需求分析。需求分析之后呢？是概要设计。概要设计做什么？是做子系统的划分。它包括这样一些内容：

- 子系统职责范围的定义；
- 子系统的规格（接口），子系统与子系统之间的边界；
- 需求分解与组合的过程，系统如何满足需求、需求适用性（变化点）的应对策略。

对于我们理解这个精彩的互联网世界来说，理解它的子系统的划分思路是非常非常重要的。

## 网络应用程序的全视图

在上一讲 “[14 | IP 网络：连接世界的桥梁](https://time.geekbang.org/column/article/98406)” 中我们介绍了 IP 网络的工作原理。我们还画了一幅与数据传输这件事本身有关的网络协议图，如下：

![](https://static001.geekbang.org/resource/image/8d/23/8d3d2147685359357e78c8715e5edf23.png?wh=1920%2A731)

那么，从一个典型的网络应用程序角度来说，它的完整视图又是什么样子的呢？

![](https://static001.geekbang.org/resource/image/27/35/272a1a5319c226fc6472bb4f5f256c35.png?wh=1920%2A956)

上图是我给出的答案。当然，它并不代表所有的网络应用程序，但这不影响我们借它的结构来解释网络世界是怎么划分子系统的，每个子系统都负责了些什么。

**第一层是物理层。**你可以理解为网络设备的原生能力，它定义了硬件层次来看的基础网络协议。

**第二层是数据链路层。**它负责解决的是局部网络世界的数据传输能力。网络数据传输技术会层出不穷，今天主流有固网、WiFi、3G/4G，明天有 5G/6G，未来也必然还会出现更快速的网络新技术。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/16/d0/d6/f335954b.jpg" width="30px"><span>一笔一画</span> 👍（19） 💬（1）<div>老师，请教一下，我可否这样认为，越往上层的协议其效率越低，到HTTＰ这样高阶的协议，它的性能会不会是一个瓶颈？</div>2019-06-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/78/02/abb7bfe3.jpg" width="30px"><span>Peiel</span> 👍（10） 💬（2）<div>Nginx 可以用作应用层网关，那么应用层网关怎么理解？可以理解成我们通常在 Nginx 中对 HTTP 请求根据不同的api做相关的反向代理、负载均衡等相关配置，也就是所谓的api网关？</div>2019-06-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d0/f1/432e0476.jpg" width="30px"><span>X</span> 👍（7） 💬（2）<div>你好老师，网关这个词一开始是在传输层接触到的，路由器起到的就是网关的作用，本质上是一个关口，数据包通过关口之后去寻找自己的目的地。现在谈的应用层的网关，是不是就是HTTP的请求的关口，根据不同的URL映射到不同的服务端接口，可以把负载均衡器理解为应用层的网关吗？</div>2019-06-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/df/6e/267bd6ee.jpg" width="30px"><span>1900</span> 👍（6） 💬（1）<div>对象存储作为目前新颖的一种存储类型，它相对于传统网络存储类型的优势在哪里呢？另外它也有什么不足或者局限么？</div>2019-06-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/06/fa/3d15ad73.jpg" width="30px"><span>s</span> 👍（5） 💬（2）<div>许老师，我是一个黑客情结很重的人，我对黑客的看法和大部分人都不同，多数人认为黑客就是做安全研究的，可我觉得不是这样的，我心中的黑客是创造计算机的一切。你想，假设计算机协议，编程语言，系统等等你都能驾轻就熟，安全那不就是手到擒来。看了你讲的计算机架构设计，我更是感觉这种思想正是我想要的。可周围人都说让我不要白日做梦，好好写好业务代码就行，别想其他的。我很迷茫，岁数也不小26了，可这是我的梦想，我该坚持吗？想听听您的意见</div>2019-08-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/52/2b/3e42686d.jpg" width="30px"><span>斯图尔特</span> 👍（3） 💬（2）<div>许老师，有个问题。对外使用restful api，如果对内部使用也是这种协议，会造成内部大量的http调用，如果是内部系统，是不是使用grpc更合适？</div>2019-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e7/cd/08088f14.jpg" width="30px"><span>马哲富</span> 👍（3） 💬（2）<div>许老师好! 
    &quot;由于TCP基于连接，所以每Accept一个连接后，我们可以有一个独立的执行体去处理它；但是UDP是无连接的，需要我们手工根据来源IP+Port来判断如何分派&quot;，是否可以理解为基于TCP的协议，服务端每接收一个数据包就处理一个，而基于UDP的协议，服务端接收到数据包之后是先分派后处理？而这个分派的条件是IP+Port，1.为啥要分派？2.为啥是根据IP+Port来分派？</div>2019-06-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/b1/8d/7769f96d.jpg" width="30px"><span>Hui</span> 👍（2） 💬（1）<div>老师你好，现代软件逐渐云端化，TCP能否满足云环境更高带宽，更低的延迟的需要，是否有更好的协议?</div>2019-06-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/15/25/1d3d616f.jpg" width="30px"><span>虎哥</span> 👍（2） 💬（1）<div>相对应地，在 HTTP 协议中以 “资源路径” 表达资源，以 PUT-POST-GET-DELETE 表达 CURD 操作（也有一些服务以 POST 而不是用 PUT 请求来创建资源）。这段写错了吧，post 是 C put 是U吧</div>2019-06-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/df/6e/267bd6ee.jpg" width="30px"><span>1900</span> 👍（2） 💬（1）<div>“如果我们限定传输的数据包一定是某种应用层协议时，就会出现所谓的应用层网关”，这句话很费解，为什么“传输的数据包”会是“某种应用层协议”？数据包和协议是两个东西吧？</div>2019-06-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/da/99/80222c2a.jpg" width="30px"><span>立耳</span> 👍（1） 💬（1）<div>请教许老师一个技术细节的问题，假如服务端向客户端回复了一个超大的包，或者通过responseWriter的write方法写一个大文件，这个文件大小可能超过网卡的连接缓存大小，实际上客户端的Client.Do返回的response对象是在TCP链接结束后产生的，还是由HTTP协议来控制呢？</div>2019-06-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/d5/d2/3e65e3dc.jpg" width="30px"><span>王克</span> 👍（1） 💬（1）<div>近几年来HTTPS协议发展的很好，老师能简单的介绍下优缺点吗？</div>2019-06-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/ee/16/742956ac.jpg" width="30px"><span>涵</span> 👍（1） 💬（1）<div>老师好，请问使用socket编程是不是就是在TCP&#47;UDP层面的?您觉得未来Restful api会占据垄断地位，成为PaaS上的SaaS服务间的标准调用协议吗？谢谢。</div>2019-06-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/9c/0e/16c4e59b.jpg" width="30px"><span>vincent</span> 👍（0） 💬（2）<div>许老师您好，此讲“NAT 网关本质上是一个透明代理（中间人），工作在网络协议的第四层，即传输层”，按照我对前一讲的理解，NAT应该是IP地址的转换，感觉应该是工作在网络层更加合适一些，网上有说工作在传输层和网络层，还请解惑。谢谢。</div>2021-09-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/dd/43/93f04f89.jpg" width="30px"><span>函数方程(弘宇)</span> 👍（0） 💬（1）<div>许老师，如果想了解通过封装TCP&#47;IP协议，而实现的http协议的细节(比如说一个GET或者POST请求，发生了丢包的情况，tcp协议在其中所起到的作用是？再比如GET方法与POST方法的区别是？)，有没有推荐的参考资料...</div>2020-12-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/09/d6/5f366427.jpg" width="30px"><span>码农Kevin亮</span> 👍（0） 💬（1）<div>请问老师，开放协议与封闭协议是怎么理解呢</div>2019-10-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/b4/63/59bb487d.jpg" width="30px"><span>eletarior</span> 👍（32） 💬（1）<div>最近对网络协议很感兴趣，也订阅了极客的其他网络专栏，所以相比而言，对上一节的内容不是很
满意，觉得没有讲到架构的点上，今天发现许老师把前一节内容又更新了下，还是很有心的。看了今天的内容，觉得老师还是理性的，上一节是本节的引入点，现代系统如果没有网络，谈架构可能都是多余的，所以网络基础至关重要。还记得大学时基于传统的tcp写服务器的日子，那真是刀耕火种了，现在任何一种语言都有封装的特别好的网络库直接用，但是这并不代表我们不需要理解网络协议栈的底层原理。网络协议栈的划分本就是架构设计的现成模板。期待下一节的安全方案的讲解。</div>2019-06-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/97/48/550271b0.jpg" width="30px"><span>陶辉</span> 👍（27） 💬（1）<div>”如果说有谁能够打败微信，那么我个人一个基本的思考是：用微信的的方式打败微信恐怕很难，但微信是封闭协议，开放也许是一个打败微信的方式！“，赞！</div>2019-07-11</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ61zTDmLk7IhLJn6seBPOwsVaKIWUWaxk5YmsdYBZUOYMQCsyl9iaQVSg9U5qJVLLOCFUoLUuYnRA/132" width="30px"><span>fjpcode</span> 👍（8） 💬（0）<div>老师的洞察力总能深入到事务的本质，对网络协议来龙去脉的分析，让人感觉非常顺畅。应用平台层网络协议的选择，对一个网络应用项目来说是至关重要的，这方面也踩过不少坑。感谢老师的梳理，对网络协议的认知又深入了一步。</div>2019-06-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/00/4e/be2b206b.jpg" width="30px"><span>吴小智</span> 👍（4） 💬（0）<div>打卡，再次被老师的高纬思想折服</div>2019-06-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/b9/8d/00bded19.jpg" width="30px"><span>不温暖啊不纯良</span> 👍（1） 💬（0）<div>可以把所有的网络协议理解成网络系统的子系统。

每个不同层级的子系统解决的问题不同，这相当于是横向拆封需求，将这个需求拆分成一节节可执行的小任务，比如链路层，网络层，传输层，应用层，这样便完成了跨空间信息传送的需求。

然而在同一个层次上，又为了更好的满足个性化的需求，于是纵向拆分，每一层都有各具特色的协议，但是在我们面对的需求中，总有一些属于大众需求一些，像TCP。属于小众需求，总有一些设计是为了满足小众需求而生的，像UDP。</div>2021-04-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/8d/c5/898b13b4.jpg" width="30px"><span>亢（知行合一的路上）</span> 👍（1） 💬（0）<div>再次感受分层带来的巨大好处，每一层专注自己的事情，把整体的复杂度分解了。</div>2020-06-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f6/ba/09ab72d2.jpg" width="30px"><span>幻灰龙</span> 👍（1） 💬（0）<div>网络协议的分层形成的栈，在应用层的状态管理中，底层状态机，中间层状态机，上层状态机，也存在这样的栈的结构。</div>2020-02-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/b8/3c/1a294619.jpg" width="30px"><span>Panda</span> 👍（1） 💬（0）<div>大道至简</div>2019-06-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/f1/70/bca09d2d.jpg" width="30px"><span>觉</span> 👍（1） 💬（0）<div>感恩大佬分享 随喜大佬</div>2019-06-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ca/15/e3f9fb4e.jpg" width="30px"><span>宋文杰</span> 👍（1） 💬（0）<div>许老师看问题的角度 高屋建瓴 满满的收获 </div>2019-06-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/7a/08/4d3e47dd.jpg" width="30px"><span>Aaron Cheung</span> 👍（1） 💬（0）<div>打卡15 HTTP编程逻辑</div>2019-06-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg" width="30px"><span>ifelse</span> 👍（0） 💬（0）<div>一个 HTTP 服务器最基础的就是需要有根据 “资源路径” 的路由能力。
--记下来</div>2023-08-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg" width="30px"><span>ifelse</span> 👍（0） 💬（0）<div>学习打卡</div>2023-08-16</li><br/><li><img src="" width="30px"><span>Geek_88604f</span> 👍（0） 💬（0）<div>TCP是面向连接的而UDP是无连接的，TCP在通信之前需要通过握手建立逻辑连接，就像打电话要先拨号---可以想象，你要给山上送东西，但并没有一条实际存在的物理缆车，你必须使劲丢上去。为了保证你丢上去的东西不出差错，同时山上一定能拿到，你必须先吼一嗓子，保证对方也准备好了。每丢一件东西，对方收到了再丢下一件。快了慢了都要协调好。这个对收发协调的工作就可以理解为建立连接，具体来说，就是TCP的差错控制、重传、序号标识、滑动窗口、确认应答、三次握手四次挥手等机制）。UDP在发送数据之前不需要建立连接---还是以你要给山上送东西为例，你只管丢，山上只管接，快了慢了，多了少了，都不保证，完全没有协调。UDP也有其长处---效率高、实时性好、支持一对一、一对多、多对一和多对多的交互通信。</div>2022-12-25</li><br/>
</ul>