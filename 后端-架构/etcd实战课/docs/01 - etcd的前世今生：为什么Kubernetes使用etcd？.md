你好，我是唐聪。

今天是专栏课程的第一讲，我们就从etcd的前世今生讲起。让我们一起穿越回2013年，看看etcd最初是在什么业务场景下被设计出来的？

2013年，有一个叫CoreOS的创业团队，他们构建了一个产品，Container Linux，它是一个开源、轻量级的操作系统，侧重自动化、快速部署应用服务，并要求应用程序都在容器中运行，同时提供集群化的管理方案，用户管理服务就像单机一样方便。

他们希望在重启任意一节点的时候，用户的服务不会因此而宕机，导致无法提供服务，因此需要运行多个副本。但是多个副本之间如何协调，如何避免变更的时候所有副本不可用呢？

为了解决这个问题，CoreOS团队需要一个协调服务来存储服务配置信息、提供分布式锁等能力。怎么办呢？当然是分析业务场景、痛点、核心目标，然后是基于目标进行方案选型，评估是选择社区开源方案还是自己造轮子。这其实就是我们遇到棘手问题时的通用解决思路，CoreOS团队同样如此。

假设你是CoreOS团队成员，你认为在这样的业务场景下，理想中的解决方案应满足哪些目标呢？

如果你有过一些开发经验，应该能想到一些关键点了，我根据自己的经验来总结一下，一个协调服务，理想状态下大概需要满足以下五个目标：
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/9d/84/171b2221.jpg" width="30px"><span>jeffery</span> 👍（56） 💬（4）<div>1.6版本默认自带v3版本，etcd 云原生的数据首选存储产品，老师能说下etcd 和reids 的区别吗？谢谢</div>2021-01-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e0/4e/c266bdb4.jpg" width="30px"><span>[小狗]</span> 👍（27） 💬（4）<div>大佬，可以1周4期吗？ 等着面试用呢</div>2021-02-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/0d/29/18272af9.jpg" width="30px"><span>hxy</span> 👍（22） 💬（1）<div>zookeeper的rpc api是thrift，这个感觉说错了吧，zk用的应该是jute</div>2021-01-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/3f/86/4e2d599b.jpg" width="30px"><span>NICE</span> 👍（10） 💬（3）<div>目前在使用etcd v3, 高可用，强一致性键值存储。关于etcd集群异地容灾同步目前用的make mirror，有更好的方案吗？ 哈哈😃</div>2021-01-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/46/0f/f6cfc659.jpg" width="30px"><span>mckee</span> 👍（7） 💬（2）<div>k8s list pod不带rev情况下，etcdserver key range会造成cpu和mem瞬间飙高，需要读取所有kv并排序</div>2021-01-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/7f/17/6da0b387.jpg" width="30px"><span>SecKiki</span> 👍（4） 💬（1）<div>学习了，etcd与k8s 绝配</div>2021-01-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5f/e5/54325854.jpg" width="30px"><span>范闲</span> 👍（3） 💬（1）<div>etcd用来做服务发现，治理，分布式锁，还有配置信息存储很好用。
缺点是异地多活不好用，延迟有点大。</div>2021-01-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/23/bb/a1a61f7c.jpg" width="30px"><span>GAC·DU</span> 👍（2） 💬（1）<div>读了两遍还是感觉很吃力，需要去恶补一下不懂的知识。有个疑问想让老师解惑一下，etcdV1和V2版本并没有ZK社区成熟功能也没有ZK强大，为什么K8S选择了和etcd一起成长，而不是等着etcd各方面完善和强大起来再从ZK切换到etcd？</div>2021-01-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/59/c9/f44cb7f3.jpg" width="30px"><span>爪哇夜未眠</span> 👍（2） 💬（1）<div>挺好的文章</div>2021-01-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/b2/91/cf0de36e.jpg" width="30px"><span>saltedfish</span> 👍（1） 💬（1）<div>爽啊，这种从诞生背景顺着发展路线讲下来的思路能让人真正理解为什么现在的etcd是这个样子的，感谢作者！</div>2022-04-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/46/80/45d989e5.jpg" width="30px"><span>ZHU～JM</span> 👍（1） 💬（0）<div>老师，我们在使用K8s和etcd的时候经常出现注册和发现超时的情况，这是为什么啊</div>2021-01-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/84/c1/dfcad82a.jpg" width="30px"><span>Acter</span> 👍（1） 💬（1）<div>请问老师，k8s场景etcd v3.3.10版本。由于业务的workflow yaml对象很大，近期已把etcd的max-request-bytes从1.5MiB提高到了5MiB，这对k8s master组件稳定性有何风险吗？该怎么压测呢？</div>2021-01-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/2d/18/918eaecf.jpg" width="30px"><span>后端进阶</span> 👍（1） 💬（1）<div>给唐大佬疯狂打Call，以后学习ETCD就跟着唐大佬的课程走就完了！</div>2021-01-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/be/35/dd79037e.jpg" width="30px"><span>a...Z</span> 👍（1） 💬（1）<div>等真美久  终于有了etcd的讲解,期待</div>2021-01-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/20/2d/d9/8b993f5e.jpg" width="30px"><span>曼施坦因</span> 👍（0） 💬（1）<div>请问这个是没有视频的吗？</div>2021-12-17</li><br/><li><img src="" width="30px"><span>Geek6392</span> 👍（0） 💬（1）<div>老师，etcd本来就是分布式存储了，还有必要对其数据进行定期备份么？</div>2021-11-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/13/c9/68839e9b.jpg" width="30px"><span>过客</span> 👍（0） 💬（1）<div>唐老师，问您个问题，多个key关联一个lease，那么一个key续约了，所有关联到这个lease的key就都不能删除了吧，即使这些key没有任何关联</div>2021-10-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/eb/bc/6ccac4bb.jpg" width="30px"><span>武文文武</span> 👍（0） 💬（1）<div>
老师您好，learner的功能目前来看只能作为数据同步节点，对外提供读服务，无法对集群的可用性起到明显作用，比如: 上海和北京两地，希望当多数派的上海整体不可用了，北京能通过learner自动晋升为follower，从而达到异地多活的效果，如何能实现此效果呢？
</div>2021-09-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/21/b8/aca814dd.jpg" width="30px"><span>江山如画</span> 👍（0） 💬（1）<div>主要用的 v3，使用 watch 机制保证不同节点执行相同的任务，使用过程中遇到的主要问题是害怕 watch 事件丢失</div>2021-09-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/ee/1c/e4a82c25.jpg" width="30px"><span>大大很二</span> 👍（0） 💬（1）<div>看了第一讲，感觉写的很有趣且不枯燥，请问老师某些片段可以引用到个人的博客吗</div>2021-05-17</li><br/><li><img src="" width="30px"><span>K菌无惨</span> 👍（0） 💬（3）<div>老师, 请问&quot;相同的 TTL 的 key 关联一个 Lease&quot;这句话是不是说错了,按我的理解是&quot;持有相同Lease的key关联一个TTL&quot;</div>2021-02-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/9f/a1/d75219ee.jpg" width="30px"><span>po</span> 👍（0） 💬（1）<div>etcd v2是没有对数据持久化只在内存？那么etcd重启数据就没了？之前在极客时间张磊的kubernetes上面他说因为raft不需要对etcd持久化，提问了没解答，疑惑中。</div>2021-01-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/46/0f/f6cfc659.jpg" width="30px"><span>mckee</span> 👍（0） 💬（1）<div>老版本的etcd client只维护一个etcd member连接，对于heavy usage会造成负载不均衡</div>2021-01-25</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLz44WGtTHNfB7GGTQgZGJqPDzhfqiaUkmSRtZUkgjuQ7dqJibx5HBp6icOfWLicCUvMTC7ltq5DzTLxw/132" width="30px"><span>Geek_1337</span> 👍（0） 💬（1）<div>老师好！想知道在没有像etcd这样watch机制以前，一般数据库是怎么获取数据的更新的，除了不断的轮询还有其他解决思路吗？谢谢。</div>2021-01-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/66/1c/b154a90f.jpg" width="30px"><span>🌈</span> 👍（0） 💬（3）<div>为什么k8s里默认的etcd API版本还是2?</div>2021-01-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/3b/46/3701e908.jpg" width="30px"><span>Coder</span> 👍（6） 💬（0）<div>精彩，读起来生动有趣，一文就让我了解了etcd的发展历史与k8s关系，为老师打call！</div>2021-01-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/53/c4/dea5d7f3.jpg" width="30px"><span>chapin</span> 👍（2） 💬（0）<div>头排看戏。</div>2021-01-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/b1/54/6d663b95.jpg" width="30px"><span>瓜牛</span> 👍（1） 💬（4）<div>多路复用为啥能减少连接数？多路复用只是提高了socket监听效率，支持更大的连接数，何来的减少连接数，连接数取决于client数啊。不能理解，请老师回复。</div>2021-11-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/ac/de/68f35320.jpg" width="30px"><span>小来子</span> 👍（1） 💬（1）<div>其次使用 Lease 优化 TTL 机制，每个 Lease 具有一个 TTL，相同的 TTL 的 key 关联一个 Lease，Lease 过期的时候自动删除相关联的所有 key，不再需要为每个 key 单独续期。
老师,请问下, Lease过期后, 通过什么手段删除关联的所有Key呢?</div>2021-02-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/6b/e2/f02e45df.jpg" width="30px"><span>恰同学少年。</span> 👍（1） 💬（0）<div>1. etcd 3.4 + v3API
2. 主要遇到以下问题：
    - 在使用k8s部署集群时，如何应对多数派、少数派、数据备份与恢复、数据搬迁的运维问题。
    - 如何测试watch可靠性
    - db size为8GB，项目需要更大运行会存在哪些风险？</div>2021-02-20</li><br/>
</ul>