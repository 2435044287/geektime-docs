你好，我是唐聪。

在Kubernetes中，各种各样的控制器实现了Deployment、StatefulSet、Job等功能强大的Workload。控制器的核心思想是监听、比较资源实际状态与期望状态是否一致，若不一致则进行协调工作，使其最终一致。

那么当你修改一个Deployment的镜像时，Deployment控制器是如何高效的感知到期望状态发生了变化呢？

要回答这个问题，得从etcd的Watch特性说起，它是Kubernetes控制器的工作基础。今天我和你分享的主题就是etcd的核心特性Watch机制设计实现，通过分析Watch机制的四大核心问题，让你了解一个变化数据是如何从0到1推送给client，并给你介绍Watch特性从etcd v2到etcd v3演进、优化过程。

希望通过这节课，你能在实际业务中应用Watch特性，快速获取数据变更通知，而不是使用可能导致大量expensive request的轮询模式。更进一步，我将帮助你掌握Watch过程中，可能会出现的各种异常错误和原因，并知道在业务中如何优雅处理，让你的服务更稳地运行。

## Watch特性初体验

在详细介绍Watch特性实现原理之前，我先通过几个简单命令，带你初体验下Watch特性。
<div><strong>精选留言（22）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（17） 💬（2）<div>当某个 key 发生变化的一定要去 key 的 watcher 区间树去查询是否对应的 watcher 吗？ 这样会不会有很大的浪费，当一个系统 监听了一些不经常变的 key, 另一些经常变化的 key 没有对应的 watcher ,这样经常变化的key就会一直去查询key 的 watcher 区间树。  难道 key 不能直接知道是否有对应的 watcher 呢？ （比如 key 的结构体记录一个 watcher Id 的数组）</div>2021-02-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/e8/ac/7324d5ca.jpg" width="30px"><span>七里</span> 👍（16） 💬（1）<div>如何保证WatchableKV 模块启动的syncVictimsLoop是可靠的呢？机器重启了怎么办？</div>2021-02-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/41/38/4f89095b.jpg" width="30px"><span>写点啥呢</span> 👍（8） 💬（1）<div>请问下老师，如果etcd集群某个节点崩溃或者网络问题导致client&#47;server间连接断开，etcd是如何处理watch重新连接？如果是在另外一个节点重连后，etcd如何确定哪些event已经发送来避免event重复发送呢？

谢谢老师</div>2021-02-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（1） 💬（1）<div>带 --rev 版本号的监听，不是从需要监听某个 key 的某个指定的版本开始吗？ 文章中怎么写的是集群的版本号</div>2021-02-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/3a/27/5d218272.jpg" width="30px"><span>八台上</span> 👍（0） 💬（1）<div>想问一下  每个key  有没有时间戳呢 想看真实的创建时间</div>2021-08-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/9a/fd/30c425f9.jpg" width="30px"><span>BeanNan</span> 👍（3） 💬（0）<div>想问下老师，思考题的答案在哪有解惑？</div>2022-01-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/cb/38/4c9cfdf4.jpg" width="30px"><span>谢小路</span> 👍（3） 💬（1）<div>学 etcd 还是需要些功底的，基础薄弱应该看不懂这些。</div>2021-04-07</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIVvyFCLRcfoWfiaJt99K0wiabvicWtQaJdSseVA6QqWyxcvN5nd2TgZqiaUACc94bBvPHZTibnfnZfdtQ/132" width="30px"><span>Geek_7d539e</span> 👍（1） 💬（4）<div>有一个地方没有写明：
watch 通过 raft 通讯模块，传播到各个节点，也就是给个节点都有这个 watch(id) ，key 的 put 更新操作，给个节点自然都能监听到该 key 的变化，那么是各个节点都会去通知这个变化吗？还是就只有一个节点会去通知 client ？我本人猜测是，每个节点都会去通知，但是并不是每个节点都有 client watch steam ，没有连接 stream 就自然丢弃通知，有 stream 才会去落实通知。请老师释疑下，多谢。还有顺道多问一个问题，put 请求是单 key 的事务操作吗？</div>2021-07-27</li><br/><li><img src="" width="30px"><span>Geek_539c73</span> 👍（0） 💬（0）<div>越底层，越是数据结构</div>2023-07-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/78/80/938c0434.jpg" width="30px"><span>踏雪无痕</span> 👍（0） 💬（0）<div>“同时当 watch 连接的节点故障，clientv3 库支持自动重连到健康节点，并使用之前已接收的最大版本号创建新的 watcher，避免旧事件回放等。”  作者你好，请问这一段话有没有对应的官网文档相关内容，我找了下没找到。</div>2023-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/fa/64/457325e6.jpg" width="30px"><span>Sam Fu</span> 👍（0） 💬（0）<div>老师 unsynced group是怎么推送消息给client端的 unsynced group在状态机中不会转化为victimed suycgroup吗</div>2023-04-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/fa/64/457325e6.jpg" width="30px"><span>Sam Fu</span> 👍（0） 💬（0）<div>老师 这个区间树保存key前缀保存到哪一级啊 比如key为abcde, 那么区间数会咋保存呢？a，ab，abc，abcd都会保存吗</div>2023-04-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/3b/ba/3b30dcde.jpg" width="30px"><span>窝窝头</span> 👍（0） 💬（0）<div>不一定能监听到所有任务，有可能历史变更数据已丢失，返回个ErrCompacted</div>2023-03-03</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLDRPejHodutia9Ud8UZLY8g5lTkKXgf3J104c0jM9aFfAGNoUdxkRLnnWRc5Kd3jIeN3EqXxKFT0g/132" width="30px"><span>蓝莓侠</span> 👍（0） 💬（0）<div>同时当 watch 连接的节点故障，clientv3 库支持自动重连到健康节点，并使用之前已接收的最大版本号创建新的 watcher，避免旧事件回放等。
如果是watch的etcd某个node节点网络和另外两个隔离了，watch会重连到其他健康节点吗？</div>2022-08-23</li><br/><li><img src="" width="30px"><span>woJA1wCgAAduicW8WCYUooKMsgw232aA</span> 👍（0） 💬（0）<div>老师，我想问一下没有设置集群的情况下。一台服务器能够在本机监听另外一台服务器的etcd服务的key的修改吗。即跨服务器监听key？</div>2022-05-25</li><br/><li><img src="" width="30px"><span>Geek_af1847</span> 👍（0） 💬（0）<div>在获取key的最新值到watch期间，监听的key可能会发生变化，这段时间内的事件就会丢失，所以watch的时候需要带上rev。</div>2022-03-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/42/9d/c36b7ef7.jpg" width="30px"><span>顾骨</span> 👍（0） 💬（0）<div>老师，你好

我看区间树的示意图，其中一个节点[&#47;a,&#47;b]，那么：
问题1：是否还有两个叶子节点[&#47;a]和[&#47;b]，那么 abc，abcd，abcde 是否存在叶子节点 [&#47;a]，bc，bcde，bcdef 是否存在叶子节点[&#47;b]上。
      1.1：如果是，叶子节点（比如 [&#47;a]）上的数据要求有序吗？如果大量的节点落在叶子节点 [&#47;a] 上，查找性能如何。
      1.2：如果不是，那么数据又是如何存储在区间树里面呢。

问题2：如果 key 为汉字，如何存储在区间树上？</div>2021-11-12</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLDUJyeq54fiaXAgF62tNeocO3lHsKT4mygEcNoZLnibg6ONKicMgCgUHSfgW8hrMUXlwpNSzR8MHZwg/132" width="30px"><span>types</span> 👍（0） 💬（0）<div>watcher 的最小版本号，会随着事件的推送，而更新吗？</div>2021-09-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/25/83/7e/e8d1771e.jpg" width="30px"><span>白</span> 👍（0） 💬（1）<div>如果客户端不需要订阅了，创建的watcher怎么删除呢？</div>2021-03-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/88/03/805c8e0e.jpg" width="30px"><span>追忆似水年华</span> 👍（0） 💬（2）<div>“client 与 server 网络出现波动等异常时，很容易导致事件丢失，client 不得不触发大量的 expensive 查询操作，以获取最新的数据及版本号，才能持续监听数据”这段话不是很明白，事件丢失为什么出发大量的昂贵查询，还要获取最新数据和版本号</div>2021-03-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（0） 💬（1）<div>watcher key的区间树创建过程是怎么样的？</div>2021-02-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/92/be/8de4e1fe.jpg" width="30px"><span>kaizen</span> 👍（0） 💬（2）<div>老师，什么应用场景需要使用这种key有多个版本value 的机制呢</div>2021-02-06</li><br/>
</ul>