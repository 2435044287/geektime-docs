你好，我是唐聪。

在上一节课里，我通过分析etcd的一个读请求执行流程，给你介绍了etcd的基础架构，让你初步了解了在etcd的读请求流程中，各个模块是如何紧密协作，执行查询语句，返回数据给client。

那么etcd一个写请求执行流程又是怎样的呢？在执行写请求过程中，如果进程crash了，如何保证数据不丢、命令不重复执行呢？

今天我就和你聊聊etcd写过程中是如何解决这些问题的。希望通过这节课，让你了解一个key-value写入的原理，对etcd的基础架构中涉及写请求相关的模块有一定的理解，同时能触类旁通，当你在软件项目开发过程中遇到类似数据安全、幂等性等问题时，能设计出良好的方案解决它。

## 整体架构

![](https://static001.geekbang.org/resource/image/8b/72/8b6dfa84bf8291369ea1803387906c72.png?wh=1920%2A1265)

为了让你能够更直观地理解etcd的写请求流程，我在如上的架构图中，用序号标识了下面的一个put hello为world的写请求的简要执行流程，帮助你从整体上快速了解一个写请求的全貌。

```
etcdctl put hello world --endpoints http://127.0.0.1:2379
OK

```

首先client端通过负载均衡算法选择一个etcd节点，发起gRPC调用。然后etcd节点收到请求后经过gRPC拦截器、Quota模块后，进入KVServer模块，KVServer模块向Raft模块提交一个提案，提案内容为“大家好，请使用put方法执行一个key为hello，value为world的命令”。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/76/7d/04c95885.jpg" width="30px"><span>Index</span> 👍（14） 💬（1）<div>之前研究一段时间的etcd的源码，看的七七八八，现在再看这篇文章把之前的很多疑问都解答了，太棒了，etcd是个很优秀的项目，能把这么多的技术点融合在一起，实在是一个很好的开源学习项目。老师有空可以开直播，多聊聊etcd中涉及的技术点的一些学习，从源头上把知识融汇贯通，这样的学习真是酣畅淋漓</div>2021-01-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/78/df/424bdc4a.jpg" width="30px"><span>于途</span> 👍（13） 💬（1）<div>1）首先 boltdb key 是版本号，put&#47;delete 操作时，都会基于当前版本号递增生成新的版本号，因此属于顺序写入，可以调整 boltdb 的 bucket.FillPercent 参数，使每个 page 填充更多数据，减少 page 的分裂次数并降低db空间。   此处的page 和 降低db空间不是很理解，劳烦老师解惑！

2）关于版本号(revision)的理解：假定全局版本号currentRevision=2，第一次执行 put hello world1，那么版本号为：hello:revision{2,0};第二次执行 put hello world2，此时版本号为：hello:revision{3,1};第3次执行 put hello world3，此时版本号为：hello:revision{4,2}。  不知理解是否有偏差？</div>2021-01-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/e8/ac/7324d5ca.jpg" width="30px"><span>七里</span> 👍（7） 💬（2）<div>幂等部分的“原子性事务”如何实现的？</div>2021-01-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/ed/b9/510fb3e2.jpg" width="30px"><span>TS.乔</span> 👍（7） 💬（2）<div>希望在后面多加一下具体设计思路，以及特性取舍的东西</div>2021-01-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/9d/84/171b2221.jpg" width="30px"><span>jeffery</span> 👍（7） 💬（1）<div>原理讲的透彻、为啥applied index超过了 5000，返回一个&quot;etcdserver: too many requests&quot;错误给 client。raft源码定义的最大值吗？谢谢老师</div>2021-01-26</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/rPaT2MzkXFmlmMTicGCRk5yVKqibPlloh66ibGJfoLQbgb6ficD3TkPmngR8UCEkrKZf5UbzvLlIglyYXBZibUINQ9Q/132" width="30px"><span>Geek_5a8405</span> 👍（5） 💬（1）<div>从节点收到Propose请求后会写wal日志吗？那如果最终并没有一半的节点成功响应，那已经写入wal的从节点怎么处理呢？</div>2021-02-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/f3/a7/15ee1f00.jpg" width="30px"><span>憨憨</span> 👍（4） 💬（1）<div>讲的真好，干货十足</div>2021-02-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c4/eb/2285a345.jpg" width="30px"><span>花晨少年</span> 👍（3） 💬（1）<div>etcd 通过引入一个 consistent index 的字段，来存储系统当前已经执行过的日志条目索引，实现幂等性。
-----
consistent index 是一个全局的值吗，单调递增的?还是主要有raft日志应用到状态机，就会存储当前consistent index值吗，判断日志使用已经执行过，是需要进行key查找所有存储的consistent index值吗</div>2021-04-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/86/39/d12aaabf.jpg" width="30px"><span>kingstone</span> 👍（3） 💬（1）<div>请问revision如果超出了上限，revision会如何接着生成？</div>2021-01-26</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLDUJyeq54fiaXAgF62tNeocO3lHsKT4mygEcNoZLnibg6ONKicMgCgUHSfgW8hrMUXlwpNSzR8MHZwg/132" width="30px"><span>types</span> 👍（2） 💬（1）<div>Apply模块针对写请求，是串行执行的还是并发执行的？</div>2021-09-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（2） 💬（1）<div>这里 db 配额（Quota）的限制哪个地方的大小的？ 为什么会有这样的限制呢？ 这个限制是  boltdb 全部数据 持久化后的文件大小吗？</div>2021-01-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/46/0f/f6cfc659.jpg" width="30px"><span>mckee</span> 👍（2） 💬（1）<div>compact后没有defrag的话对性能有影响吗</div>2021-01-25</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIVvyFCLRcfoWfiaJt99K0wiabvicWtQaJdSseVA6QqWyxcvN5nd2TgZqiaUACc94bBvPHZTibnfnZfdtQ/132" width="30px"><span>Geek_7d539e</span> 👍（1） 💬（1）<div>说到幂等性时，提到了一个原子操作。执行命令的请求更新成功了，同时更新 index ，两个操作作为一个原子操作。在 boltdb 环节里面提到异步批量提交操作，这个原子操作是在异步提交时同时完成对应日志条目的入库后一起完成的吗？请教下</div>2021-07-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/b9/37/87755dd8.jpg" width="30px"><span>撸起袖子加油干</span> 👍（1） 💬（1）<div>请问老师次版本号怎么查看？我用 etcdctl get key -w=fileds 只能看到主版本号。</div>2021-07-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c4/eb/2285a345.jpg" width="30px"><span>花晨少年</span> 👍（1） 💬（1）<div>因为 boltdb 中的 key 就包含此信息，所以 etcd 并不需要再去持久化一个全局版本号。我们只需要在启动的时候，从最小值 1 开始枚举到最大值，未读到数据的时候则结束，最后读出来的版本号即是当前 etcd 的最大版本号 currentRevision。
------
为了取得一个最大的版本号，要扫描整个db的key吗？ 这开销太大了吧？</div>2021-04-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e1/4f/00476b4c.jpg" width="30px"><span>Remember九离</span> 👍（1） 💬（2）<div>有个问题：文中的状态机到底是啥？代表图中的哪个流程？它是干啥用的？活着谁在用它？</div>2021-04-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/cd/56/dca89081.jpg" width="30px"><span>lucasun</span> 👍（1） 💬（1）<div>请问限制ETCD DB max size的瓶颈在哪，我看B+树 db size可以支持到很大，boltdb应该没有这个限制</div>2021-02-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/d5/a1/9800de2f.jpg" width="30px"><span>大远</span> 👍（1） 💬（3）<div>幂等性是啥</div>2021-02-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/99/ea/0d7b8cdc.jpg" width="30px"><span>Vincent</span> 👍（0） 💬（1）<div>唐老师好，文中有提到 compact 之后只是将空间标记为 free，还需要 defrag 才能释放空间，如果我此时直接 disalarm 不defrag 是不是可以先将集群恢复？ 先保证集群可用。</div>2021-09-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/20/c3/94/e89ebc50.jpg" width="30px"><span>神毓逍遥</span> 👍（0） 💬（1）<div>很不错，本章节主要掌握写流程，然后可以跟读流程对比分析与学习，主要在于 Quota,WAL,APPLY 三块，由于是后两者细节比较多</div>2021-09-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c4/eb/2285a345.jpg" width="30px"><span>花晨少年</span> 👍（0） 💬（1）<div>版本号（revision）在 etcd 里面发挥着重大作用，它是 etcd 的逻辑时钟。etcd 启动的时候默认版本号是 1，随着你对 key 的增、删、改操作而全局单调递增。
----------
理解应该是第一次启动的时候，默认版本号才是1把，后续重启服务版本号应该不会重置为0吧？</div>2021-04-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c4/eb/2285a345.jpg" width="30px"><span>花晨少年</span> 👍（0） 💬（1）<div>这里提到很多种类的index值，都是单调递增的，比如说这个值如果是uint32，超过值范围后，是怎么处理，从0开始吗。</div>2021-04-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/aa/9a/92d2df36.jpg" width="30px"><span>tianfeiyu</span> 👍（0） 💬（1）<div>老师，问一下，boltdb 的数据存储在哪，只看了 etcd 保存的数据在 member 目录下有 snap 和 wal 两个目录，没有看到 boltdb 数据的存储目录</div>2021-02-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/cd/2c/a02a8372.jpg" width="30px"><span>巅</span> 👍（0） 💬（1）<div>【然后写入记录内容，调用 fsync 持久化到磁盘】，wal有buffer吗，不然每个日志都要半数节点写盘，这个消耗是不是太大了</div>2021-02-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（0） 💬（1）<div>boltdb 会保存 key 的所有修改版本信息吗？</div>2021-01-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/ae/37b492db.jpg" width="30px"><span>唐聪</span> 👍（53） 💬（1）<div>之前修复的存在3年多的不一致bug就是跟本节介绍的写请求幂等性有关，在每讲中，我提及的bug，特性缺点，大部分都是我之前踩过的坑，这些经验希望能帮助大家提前避免不必要的线上问题</div>2021-01-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e1/da/d7f591a7.jpg" width="30px"><span>励研冰</span> 👍（4） 💬（2）<div>这篇仔细读了好几遍每次都有不一样的收获跟理解，被很多设计细节跟思路所折服，最后整理了下发现etcd的写流程居然跟mysql中的设计有异曲同工之妙，比如mysql中的redolog，binlog，changebuff，内存缓存，事物合并提交等…….，最后有一个不明白的点是为什么在boltdb提交事物的时候不是用key的mod_revision而是要重新生成新的版本号</div>2021-11-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5f/e5/54325854.jpg" width="30px"><span>范闲</span> 👍（4） 💬（4）<div>会有影响。
1.如果读写请求都落到bucket buffer上，bucketbuffer需要做锁处理。
2.如果读写请求都落到boltdb上，db上的数据是从磁盘加载，同bucket buffer相比性能会下降一个数量级。
3.如果既落了bucket buffer，又落到了boltdb上。那么性能受到的影响介于1-2之间。</div>2021-01-25</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLDUJyeq54fiaXAgF62tNeocO3lHsKT4mygEcNoZLnibg6ONKicMgCgUHSfgW8hrMUXlwpNSzR8MHZwg/132" width="30px"><span>types</span> 👍（3） 💬（0）<div>1. consistent index具体是如何保存的，如何实现跟具体操作实现原子性提交的
2. readIndex跟consistent index儒者WAL index什么关系？ ReadIndex一定要处于commited吗？</div>2021-03-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/3a/de/e5c30589.jpg" width="30px"><span>云原生工程师</span> 👍（3） 💬（0）<div>文章有点长，但读起来层层递进，有很大收获，发现之前自己所了解的还真不全面，填补了之前的一些空白面，期待后面的精彩内容</div>2021-01-26</li><br/>
</ul>