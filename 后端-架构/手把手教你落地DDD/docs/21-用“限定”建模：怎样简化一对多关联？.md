你好，我是钟敬。

在前几节课我们讲完了值对象。今天咱们学习另外一种建模技术——限定。

在《DDD》原书里讲关联的时候，专门强调了这个方法，因为**限定**可以起到丰富模型语义和简化关联的作用。

然而我发现，即便是一些UML老手，会用这个技术的也不多。这个技术掌握起来没有想象中那么难，而用起来的效果很好。如果你能掌握，那么就向建模专家的目标又迈进一步了。

## 什么是“限定”

我们可以先回忆一下[上节课](https://time.geekbang.org/column/article/623969)完成的模型图。

![](https://static001.geekbang.org/resource/image/11/a4/1190e02281e9dcb1daef2ca60eef31a4.jpg?wh=3733x2260)

为了说明“限定”的概念我们可以从**员工**和**工作经验**的关系开始。  
![](https://static001.geekbang.org/resource/image/0e/f4/0e3411339e8a65f0e92e3681acaa82f4.jpg?wh=2705x2556)

一个**员工**可以拥有多份**工作经验**，而各个**工作经验**的**时间段**不能相互重叠。那么，我们可以得出一个推论：对于一个**员工**而言，每个**时间段**只能有一条**工作经验**。

虽然这种关系在“时间段不能重叠”这个约束里已经隐含了，但是UML里还有一种专门的方式，可以表达这个规则中的部分含义。我先画出来给你看看。  
![](https://static001.geekbang.org/resource/image/76/78/76b9d54368bc10535567e5c565983678.jpg?wh=2705x2556)

之前，**员工**和**工作经验**之间有一个一对多关联。现在，在员工那一端加了一个小方框，里面写了“: 时间段”，而另一端的多重性，由原来的“0..\*”神奇地变成了“0..1”。

这种方式所表达的意思是说，对于一个**员工**而言，任何一个**时间段**，要么没有**工作经验**，要么有一条**工作经验**，但不能有多条**工作经验**。换句话说，总体上看，一个**员工**可以有多条**工作经验**，但限定在一个**时间段**的话，那么最多就只能有一条**工作经验**了。
<div><strong>精选留言（7）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/19/fd/58/1af629c7.jpg" width="30px"><span>6点无痛早起学习的和尚</span> 👍（1） 💬（3）<div>在工作有这样一个业务场景，拿捏不定是否可以使用这节课的限定：
1. 业务需求，1 个用户可以有多个户类型（一类户、二类户、三类户）的户，约束：但是同户类型只能有一个是正常的户（户可以注销变为不正常）。
解读：1 个用户只能有一个正常的一类户（户类型还有二类户、三类户等等），一类户可以注销（就变为了不正常）

如果我用状态做限定，设置数据库唯一索引（用户 id、户类型、状态），这样就不能存在多个注销状态的一类户，因为会唯一冲突
所以不知道我这个到底能不能做限定了？望老师解答</div>2023-02-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/bc/25/1c92a90c.jpg" width="30px"><span>tt</span> 👍（1） 💬（2）<div>小结，限定使用的属性：

	- 在数据库实现中，对应组成（复合）唯一索引的某一个列；
	- 在代码实现中，对应Map的键
	- 那么由上面两条结论可以有如下推论：数据库的唯一索引对应代码中的Map
	- 这个属性是非聚合根的局部标识
限定将一对多形式上转换成一对一，在代码里实际上就是把“多”放入Map中，让聚合根和代表这个Map属性“一对一”</div>2023-01-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/e7/8e/318cfde0.jpg" width="30px"><span>Spoon</span> 👍（0） 💬（1）<div>为什么要在DDD中使用限定？使用限定的优劣是什么？希望在后面的课程可以找到答案</div>2024-02-26</li><br/><li><img src="" width="30px"><span>public</span> 👍（0） 💬（4）<div>老师， 租户 ID、员工 ID、开始日期和结束日期 作为唯一约束，那删除只能做物理删除吧，</div>2024-01-04</li><br/><li><img src="" width="30px"><span>邓西</span> 👍（0） 💬（1）<div>1. 同一个员工不同工时记录中的时间段不能重叠；
2. 结合之前的课程，将一个n:n的关联关系，通过引入一个表示关联的实体，拆解成两个1：n的关联，然后就可以通过两个Map结构实现限定了。</div>2023-02-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg" width="30px"><span>escray</span> 👍（0） 💬（1）<div>之前确实没有注意到限定 qualification 的建模技术，因为不太熟悉，感觉在 UML 图中增加限定的标记（小方框）并不太明显。

使用唯一索引可以在数据库中表达”限定“。
使用 Map 取代 List 可以在代码中实现”限定“。

写代码的时候打开模型图，然后看到模型图（领域设计）可以与自然语言双向转换。

思考题：

1. 项目中一般会有限定，但是可能并没有重视，能想到的就是文档的编辑历史，在一个时间段只能有一个人编辑并提交。
2. 多对多如果采用限定来表达，中间需要有一个表或者对象来转换，似乎更复杂了。

限定是否仅用于值对象？</div>2023-01-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg" width="30px"><span>aoe</span> 👍（2） 💬（2）<div>“总体上看，一个员工可以有多条工作经验”，这个不看上文，直接看“时间段限定”的图还真难一眼看出。</div>2023-01-25</li><br/>
</ul>