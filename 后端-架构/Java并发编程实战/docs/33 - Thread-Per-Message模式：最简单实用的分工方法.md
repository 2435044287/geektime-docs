我们曾经把并发编程领域的问题总结为三个核心问题：分工、同步和互斥。其中，同步和互斥相关问题更多地源自微观，而分工问题则是源自宏观。我们解决问题，往往都是从宏观入手，在编程领域，软件的设计过程也是先从概要设计开始，而后才进行详细设计。同样，**解决并发编程问题，首要问题也是解决宏观的分工问题**。

并发编程领域里，解决分工问题也有一系列的设计模式，比较常用的主要有Thread-Per-Message模式、Worker Thread模式、生产者-消费者模式等等。今天我们重点介绍Thread-Per-Message模式。

## 如何理解Thread-Per-Message模式

现实世界里，很多事情我们都需要委托他人办理，一方面受限于我们的能力，总有很多搞不定的事，比如教育小朋友，搞不定怎么办呢？只能委托学校老师了；另一方面受限于我们的时间，比如忙着写Bug，哪有时间买别墅呢？只能委托房产中介了。委托他人代办有一个非常大的好处，那就是可以专心做自己的事了。

在编程领域也有很多类似的需求，比如写一个HTTP Server，很显然只能在主线程中接收请求，而不能处理HTTP请求，因为如果在主线程中处理HTTP请求的话，那同一时间只能处理一个请求，太慢了！怎么办呢？可以利用代办的思路，创建一个子线程，委托子线程去处理HTTP请求。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/13/47/46/61f16147.jpg" width="30px"><span>唯美</span> 👍（95） 💬（3）<div>快速解决，就只能改jvm内存配置，增大jvm新生代的大小，长期解决，引入NIO或AIO，netty 就是这么干的</div>2019-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg" width="30px"><span>QQ怪</span> 👍（38） 💬（3）<div>之前一直听别人说go语言很容易抗并发，原来是有个这么牛逼的轻量级线程在啊，并且理解了基本原理，感谢老师分享，为自己扩充了眼界了，为老师打call👍</div>2019-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/92/a4/9eeb686d.jpg" width="30px"><span>韦</span> 👍（32） 💬（1）<div>每次创建一个线程高并发肯定OOM，1引入线程池控制创建线程的大小，通过压测得到比较合理的线程数量配置，2 需要在请求端增加一个限流模块，自我保护</div>2019-05-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e5/d5/680402fd.jpg" width="30px"><span>245864982</span> 👍（16） 💬（1）<div>老师，那tomcat也是一个请求一个线程的吧？它是怎么解决的。是用线程池吗？</div>2019-11-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e8/fd/035f4c94.jpg" width="30px"><span>欢乐小熊</span> 👍（13） 💬（2）<div>Kotlin 支持协程, 并且实现了完善的调度策略, 可以考虑使用 Kotlin 作为替代方案</div>2019-09-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/48/f3/65c7e3ef.jpg" width="30px"><span>cricket1981</span> 👍（13） 💬（3）<div>网上查资料说java中的线程是内核空间的，轻量级线程属于用户空间的，是这样吗？另外轻量级线程是如何调度的？</div>2019-05-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/15/03/c0fe1dbf.jpg" width="30px"><span>考休</span> 👍（4） 💬（1）<div>go中的轻量级线程就是协程吧？</div>2019-11-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0d/bd/57ab02f5.jpg" width="30px"><span>Sam</span> 👍（3） 💬（1）<div>老师，请问Java不支持轻量级线程，但是有Fibe，那是不是就可以用Fibe在实际项目中，然后相当于Java也支持轻量级线程了？</div>2019-08-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/81/e6/6cafed37.jpg" width="30px"><span>旅途</span> 👍（2） 💬（1）<div>老师 问一下 fiber并发这么牛 为什么tomcat不使用fiber呢</div>2020-03-01</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/6LaITPQ4Lk5fZn8ib1tfsPW8vI9icTuSwAddiajVfibPDiaDvMU2br6ZT7K0LWCKibSQuicT7sIEVmY4K7ibXY0T7UQEiag/132" width="30px"><span>尔东橙</span> 👍（1） 💬（1）<div>老师，轻量级线程语言层次实现的，该怎么理解</div>2019-07-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/9c/c6/05a6798f.jpg" width="30px"><span>苗</span> 👍（0） 💬（1）<div>用个队列限流是不是通用思路？</div>2020-06-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a3/fc/379387a4.jpg" width="30px"><span>ly</span> 👍（0） 💬（1）<div>老师，能不能提供一个编译openjdk的方法，我在网上搜索了好多博客，按照他们说的步骤，都出现各种各样的问题，难道编译openjdk这么难？主要是长期用window系统，搞起好麻烦！</div>2019-10-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/17/c8/ca17d37e.jpg" width="30px"><span>夕夕熊</span> 👍（0） 💬（1）<div>tomcat 、webLogic 用的是这种模式吗</div>2019-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/b7/ae/a25fcb73.jpg" width="30px"><span>colin</span> 👍（0） 💬（1）<div>我想试试Fiber，这个是不是要使用OpenJDK</div>2019-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/20/45/3c5548bb.jpg" width="30px"><span>~Wade</span> 👍（25） 💬（1）<div>有一个java库叫Quasar Fiber ，通过javaagent技术可以实现轻量级线程  
官网：http:&#47;&#47;www.paralleluniverse.co&#47;quasar&#47;</div>2019-06-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/7d/da/780f149e.jpg" width="30px"><span>echo＿陈</span> 👍（12） 💬（4）<div>go语言的协程是语言级别的支持……java写个库就能支持轻量级线程了，很好奇库级别是如何支持的，原理是什么</div>2019-05-14</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/6LaITPQ4Lk5fZn8ib1tfsPW8vI9icTuSwAddiajVfibPDiaDvMU2br6ZT7K0LWCKibSQuicT7sIEVmY4K7ibXY0T7UQEiag/132" width="30px"><span>尔东橙</span> 👍（7） 💬（1）<div>宝令老师的买别墅比喻简直了</div>2019-07-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/98/3b/5af90c80.jpg" width="30px"><span>右耳听海</span> 👍（6） 💬（3）<div>不清楚老师讲这个模式的意义在什么地方，既然目前普遍的方案是使用基于nio的netty，并没发现这个模式在具体应用场景中的普遍应用，除了你说的调度场景，在高并发的情况下也没使用fiber，使用的是netty，为何不讲讲netty的思路</div>2019-05-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/5f/73/bb3dc468.jpg" width="30px"><span>拒绝</span> 👍（3） 💬（0）<div>这节课涨知识的</div>2019-05-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/16/5b/83a35681.jpg" width="30px"><span>Monday</span> 👍（1） 💬（0）<div>这篇文章老师的思路只是为了把专栏的补完整，让我们知悉java有这种东东</div>2020-12-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/0a/dd/88fa7b52.jpg" width="30px"><span>Geek_41d472</span> 👍（1） 💬（0）<div>虽然看懂了Fiber怎么用,但是Fiber是怎么实现轻量级的呢?</div>2020-07-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg" width="30px"><span>曾轼麟</span> 👍（1） 💬（0）<div>我目前想到两个方法，一个就是自行实现线程池加阻塞队列实现线程对象的复用，另一个就是更改jvm年轻代的空间大小，和回收方式，方便快速释放出空间</div>2019-05-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/52/3c/d6fcb93a.jpg" width="30px"><span>张三</span> 👍（1） 💬（0）<div>打卡</div>2019-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/5e/81/82709d6e.jpg" width="30px"><span>码小呆</span> 👍（0） 💬（0）<div>Thread-Per-Message 模式实现的分布式调度框架 请问有哪些框架呢?</div>2022-07-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/01/b9/73435279.jpg" width="30px"><span>学习学个屁</span> 👍（0） 💬（0）<div>1 线程池+ 队列
2 限流
3 nio
</div>2022-05-21</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/LqGZd83zp1y9fpbliaSgGh5qib5eGzU41xibTzib06ZAlaiaJibkJB89JuVEozCScUsVK90jpq7Na30AHDngQzI7YwiaA/132" width="30px"><span>星朝</span> 👍（0） 💬（0）<div>确实简单可靠</div>2021-04-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/a0/3d/b6379573.jpg" width="30px"><span>Zicheng</span> 👍（0） 💬（0）<div>请问下老师课程中所有的code有没有一个repo可以直接看呢 尤其是自己想试着都run一run, 谢谢老师了！</div>2021-04-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/aa/b6/46a5bbf3.jpg" width="30px"><span>俺能学个啥</span> 👍（0） 💬（0）<div>高并发场景为了避免oom只能做限流策略</div>2021-03-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/a9/ea/5bfce6c5.jpg" width="30px"><span>mgs2002</span> 👍（0） 💬（0）<div>临时解决方案就是改JVM内存大小，后续修改代码使用线程池来创建线程</div>2020-10-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/f4/c7/037235c9.jpg" width="30px"><span>kimoti</span> 👍（0） 💬（0）<div>我的想法就是每个线程尽可能多的多处理请求</div>2020-05-25</li><br/>
</ul>