你好，我是徐逸。

在前面两节课里，我们已经深入探讨了多种解决分布式缓存问题的策略。然而，在面对高并发、低延迟的场景，特别是在抖音、快手这类短视频应用的推荐与搜索功能场景，我们发现Redis作为缓存解决方案存在一定的局限性。

这是因为Redis主要支持基本的GET操作，对于复杂的业务逻辑处理能力有限。为了达成个性化推荐的效果，单个请求通常都得从 Redis 中调取大量数据，然后在服务本地开展个性化的过滤与排序等工作。即便我们能够借助增加本地缓存来减少延时，可本地缓存从 Redis 回源的这个过程，还是会使响应时间变长，导致延时无法达到性能要求。

对于这类场景，我们更倾向于采用服务本地主动缓存全量数据的策略，由于服务所有实例缓存了全量数据，这一方式还天然规避了Redis的热 Key 和大 Key 问题。

今天我们就来聊聊，在本地缓存全量数据时，如何处理缓存加载、更新以及数据量过大的问题。

## 启动：如何解决加载慢的问题？

如果采用本地缓存全量数据的方案，那么当程序启动时，我们就需要加载所有数据。对于数据的加载，**最简单的方法就是当程序启动时，轮询从数据库拉取所有数据，并写入本地缓存**。

![](https://static001.geekbang.org/resource/image/b0/47/b0e32cb435580170a2e8e6b3c9356947.jpg?wh=2056x1308 "图1 轮询 poll 加载")

对于数据量较小的场景，这种方法是可行的。然而，随着数据量的增加，这种从数据库拉取全量数据的方式，会导致程序的启动时间显著变长。一旦服务出现问题，很难快速完成发布与回滚操作。
<div><strong>精选留言（4）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/27/19/fe/d31344db.jpg" width="30px"><span>lJ</span> 👍（0） 💬（1）<div>《启动：如何解决加载慢的问题》优化后的效果如何呢，有数据量化就好了；这套方案从数据导入到最后的服务发布启动需要多长时间呢；可能需要结合数据量、带宽、服务数量等因素。整个系统构建感觉挺复杂的。</div>2025-01-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/7f/d3/b5896293.jpg" width="30px"><span>Realm</span> 👍（0） 💬（1）<div>使用logstash，把需要的数据，定时增量从mysql中拉到es中，然后通过es来查，大并发时也有数据不一致的情况.</div>2025-01-08</li><br/><li><img src="" width="30px"><span>Geek_f39c45</span> 👍（0） 💬（1）<div>感谢老师的干货，非常实用！请问老师这种缓存到本地然后定期从数据库拉去一定时间范围内增量数据的方式，是不是要求自己对本地数据和拉去回来的数据做比较更新呀，这种逐条对比会影响效率吗？此外，会发生这种情况吗：如果数据库删除了数据然后查询查不出来这些记录，我们本地也不知这条数据被删除了就没更新</div>2025-01-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/00/f0/fe94061e.jpg" width="30px"><span>假装在养🐷</span> 👍（0） 💬（0）<div>本地缓存全量数据的方案，预处理的文件如果变的很大，处理大文件肯定有耗时问题，如何解决？ 是否有成熟的解决方案</div>2025-01-09</li><br/>
</ul>