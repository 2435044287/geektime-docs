你好，我是欧创新。今天我们来学习聚合（Aggregate）和聚合根（AggregateRoot）。

我们先回顾下上一讲，在事件风暴中，我们会根据一些业务操作和行为找出实体（Entity）或值对象（ValueObject），进而将业务关联紧密的实体和值对象进行组合，构成聚合，再根据业务语义将多个聚合划定到同一个限界上下文（Bounded Context）中，并在限界上下文内完成领域建模。

那你知道为什么要在限界上下文和实体之间增加聚合和聚合根这两个概念吗？它们的作用是什么？怎么设计聚合？这就是我们这一讲重点要关注的问题。

## 聚合

在DDD中，实体和值对象是很基础的领域对象。实体一般对应业务对象，它具有业务属性和业务行为；而值对象主要是属性集合，对实体的状态和特征进行描述。但实体和值对象都只是个体化的对象，它们的行为表现出来的是个体的能力。

**那聚合在其中起什么作用呢？**

举个例子。社会是由一个个的个体组成的，象征着我们每一个人。随着社会的发展，慢慢出现了社团、机构、部门等组织，我们开始从个人变成了组织的一员，大家可以协同一致的工作，朝着一个最大的目标前进，发挥出更大的力量。

领域模型内的实体和值对象就好比个体，而能让实体和值对象协同工作的组织就是聚合，它用来确保这些领域对象在实现共同的业务逻辑时，能保证数据的一致性。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/15/69/187b9968.jpg" width="30px"><span>南山</span> 👍（134） 💬（6）<div>老师，麻烦有空帮忙看一下
场景：电销
根据任务类型的属性创建具体的定期执行任务，调度器把到点的任务放到执行器里去执行。执行完了等待下一次执行，对任务生成的明细可以填写沟通记录（第三方服务）但是本服务要提供此字段查询
过程中记录统计日志。每个任务类型在查询他的任务时查询和列表展示字段集合都不一样
任务执行过程：从数据源获取数据 -&gt; 根据任务配置的过滤规则过滤 -&gt; 生成任务明细（有过期时间） -&gt; 1.自动分配给销售&#47;2.销售主动去领单，过程中生成任务执行日志，统计日志

领域对象：任务类型、任务、任务明细、日志、过滤规则、字段、销售、
聚合A：聚合根-任务，任务明细-实体，值对象：日志、任务类型、销售
聚合B：聚合根-过滤规则，
聚合C：聚合根-字段，值对象，展示字段属性定义集合、查询字段属性定义集合

问题：
  1.一个聚合中，允不允许只有一个实体和一些属性值？
  2.是否合理？不合理该怎么设计呢？
  3.任务是根据任务类型创建出来的，聚合A是不是不合理？或者实体的初始化可不可以依赖它的值对象呢？
  4.任务类型决定它可以进行哪些过滤，实际创建任务时才会真正选择使用哪些过滤规则，过滤规则算什么呢？能作为一个独立的聚合吗？
  5.字段也是同样的，并且字段是没有一个生命周期的，这种情况下是不是作为值对象更合理？ 但是聚合A和B都用到了字段，值对象能在多个聚合公用吗？</div>2019-10-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/26/fb/5a19b53e.jpg" width="30px"><span>胖虎</span> 👍（42） 💬（8）<div>老师，能用电商的例子说一下聚合根的使用场景嘛</div>2019-10-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5f/81/1c614f4a.jpg" width="30px"><span>stg609</span> 👍（25） 💬（1）<div>首先，几乎每个留言都会评论！必须给个大大的赞！

其次，我有3个疑问，
1. 聚合中可能会有实体，那允不允许直接把实体类型作为属性的类型或返回值暴露给外界？
2. 如果允许，那外界就可以直接获取其中的实体，然后调用者可以直接使用实体中的一些相关方法？这样似乎就违反了聚合很的设计？
3. 如果不允许，那外界如果需要得到某个实体的数据，要怎么操作？封装成 DTO 吗？

比如: Aggregate a 中包含一个b属性，b是一个实体。b 中包含操作该实体的方法 M。那外界调用a.b 就会直接获取到 b 这个实体，然后可以直接调用 M 方法。</div>2019-10-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/45/93/6ad60b12.jpg" width="30px"><span>渊虹</span> 👍（24） 💬（14）<div>老师，有个问题不明白，麻烦解惑。投保聚合和客户聚合中，投保人和被保人跨聚合引用到客户的id，需求是查询以客户s为被保人的保单。就需要跨过聚合根，直接访问被保人这个值对象。这个是不是和只能通过聚合根访问聚合内其他对象的理论不一致</div>2019-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/30/c1/2dde6700.jpg" width="30px"><span>密码123456</span> 👍（15） 💬（1）<div>聚合。用界限上下文把细粒度的实体圈起来当做一个组织，选出组织的董事长。一个组织和另外一个组织交流的时候，只需要通过一个董事长，能够了解该组织的全部非隐私信息</div>2019-10-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d4/f3/129d6dfe.jpg" width="30px"><span>李二木</span> 👍（13） 💬（5）<div>什么是充血模型</div>2019-10-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/86/06/72b01bb7.jpg" width="30px"><span>美美</span> 👍（12） 💬（2）<div>老师，想请教一下
我们的场景是：商家后台上，商家可以进行门店管理，收银pos机相关的设置，营业相关的设置
背景：商家后台已经存在，且商家基础系统、门店基础信息、pos相关信息，数据模型已经存在，各调用方是直接访问数据库的
目标：将商家、门店的基础信息，经营设置信息，抽象出来形成商家域   统一对外提供能力

想通过DDD的思想来进行建模，感觉无从下手，麻烦老师提供点思路</div>2019-11-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/db/c3/e11adfe8.jpg" width="30px"><span>hunter</span> 👍（12） 💬（1）<div>跨多个实体的业务逻辑通过领域服务来实现。
其次它作为聚合的管理者，在聚合内部负责协调实体和值对象按照固定的业务规则协同完成共同的业务逻辑。
怎么感觉 聚合根做的事情和领域服务一样？</div>2019-10-29</li><br/><li><img src="" width="30px"><span>Geek_7c4953</span> 👍（9） 💬（3）<div>老师，对于关联两个聚合根的一种关系，应该划分到哪个聚合？
比如：
用户聚合根和课程聚合根。
用户收藏了一门课程，收藏这个操作关联了用户和课程，同时生成了一条收藏记录。
那么收藏记录是值对象还是实体，应该归于哪个聚合根？
如果作为实体，它似乎不需要ID去标识，因为一个用户ID，一个课程ID就可以标识这样一条记录。
如果作为值对象，又感觉不合适，因为我的感觉（仅仅是感觉）多值的值对象不应该能无限增长，但收藏这个操作是不可能限制数量的。</div>2020-08-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/6c/2f/8086c22a.jpg" width="30px"><span>蜗牛慢慢爬</span> 👍（8） 💬（2）<div>听了这么多节课，总结一下还是太抽象了</div>2019-10-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/60/a1/45ffdca3.jpg" width="30px"><span>静心</span> 👍（5） 💬（2）<div>关于聚合和聚合根还是没完全理解，请教老师：
既然聚合和聚合根都是实体且具有全局唯一ID，那么聚合和聚合根应该在代码层放置在domain的entity目录下，且应该对应一个class。
按照聚合与聚合根的规则，那么聚合与聚合内实体的关系应该是一种组合关系。
但现实中还会有一种实体间的关系，这种集合与集合中的实体不是组合关系，而是一种列表和列表中元素的关系，如，文章列表与文章的关系，这种关系下，文章列表是没有唯一ID的。那么，想请教老师，对于这种关系，DDD中是如何表述的？文章列表是作为一个实体类存在好呢？还是把列表做成一个文章实体的方法好呢？
</div>2020-08-26</li><br/><li><img src="" width="30px"><span>moming</span> 👍（5） 💬（1）<div>欧老师的课程，都是高级工程师和架构师级别的人购买，受众少，讲这么好，销量却不高，可惜了。</div>2020-06-23</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJaPyAQvQx7BpTFjmEyDkQXLEcL2lEGjsoookic3Z25SJY0omzNUA3xCKt2F0hBqbxZMmrXX9v4TWQ/132" width="30px"><span>winzheng</span> 👍（5） 💬（5）<div>老师，投保人和被保人为什么被识别为值对象？他们是客户，具备实体的特征。</div>2020-03-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f2/56/c39046c0.jpg" width="30px"><span>Jie</span> 👍（5） 💬（1）<div>2天里一口气把01-05都看了，不仅仅是文字本身，留言回复都大大补充了专利内容，必须给这么认真的老师点个赞</div>2020-01-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/64/50/a54f0907.jpg" width="30px"><span>祥敏</span> 👍（4） 💬（3）<div>您好，第四讲和第五讲都在讲述微服务内部的拆分与设计，是关系紧密的两讲，反复听了有三四遍略有收获和疑问。

从业务顺延的角度拆分，聚合、聚合根、实体、值对象这四个概念很好的模拟了业务的世界，就像面向对象所讲的一切皆对象，对象与对象之间的关系（聚合）。

疑惑有两点：持久化和实体之间关系的灵活性。

持久化（以关系型数据库为例）：聚合内部强一致性，聚合之间最终一致性。聚合是由多个遵循一定规则的实体组成，实体的描述由值对象组成，这样的问题在于聚合、实体、值对象和数据库之间的对应关系不够直接，同时事务管理也比非DDD的方式复杂，如果严格遵循DDD的原则去做，可能会在对象-&gt;数据库这个关节会有较多的问题要解决。

实体之间的关系：跨聚合之间实体不能直接发生关系，这个是否会不够灵活，实践中是否会引发一些问题？
</div>2019-11-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ff/67/6ffe3a52.jpg" width="30px"><span>马里奥的马里奥</span> 👍（3） 💬（2）<div>文中提到“聚合之间通过聚合根 ID 关联引用，如果需要访问其它聚合的实体，就要先访问聚合根，再导航到聚合内部实体，外部对象不能直接访问聚合内实体。”，但是在画的图中，投保单聚合根依赖报价单实体，那不就违反了只能通过聚合根访问实体吗？我想知道投保单是通过什么方式来访问报价单实体的。</div>2020-11-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/65/0d/eab13441.jpg" width="30px"><span>迎波扬帆</span> 👍（3） 💬（1）<div>想起曾经的坑，为某个微服务业务划分数据库后，业务逻辑发现要跨数据库去join另一个表</div>2020-03-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/61/f9/c94bb871.jpg" width="30px"><span>勤快的懒洋洋</span> 👍（3） 💬（3）<div>聚合里直接调用仓储吗，还是由应用服务层调用，为什么</div>2020-03-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/68/74/461b202d.jpg" width="30px"><span>睁眼看世界</span> 👍（3） 💬（2）<div>老师，就基础篇。我的理解是基于事件风暴（头脑风暴）定义出实体与值对象，并能识别出根对象，进而得到聚合，并清晰领域边界、松耦合。从而达到服务化确定服务的边界！但是这其中事件风暴如何组织进行是否有策略或者说工具技术。如果团队成员就事件风暴无法达成共识，如何进一步推进？</div>2019-10-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/48/de/b5833dc6.jpg" width="30px"><span>Skye</span> 👍（2） 💬（1）<div>聚合的设计步骤和设计原则特别有指导价值，在设计聚合时，不是将有关系的实体和值对象作简单的组合，最好能够找到实体和值对象运行的业务规则；换种说话，在判断聚合设计是否合理时，看看能否在聚合中找到这样一套业务业务规则。作者在评论中给了一个很简单的例子：「关于订单和商品的不变性，其实里面是有一个重要的规则，也就是订单总金额一定会是所有商品数量乘以价格后的总和，商品是依附于订单存在的。」

在实际操作过程中，有特别多的人关注聚合根中的值对象到底要不要冗余多余的属性信息，比如保单中的投保人和被保人，是只指存储客户编号呢，还是存储一个客户对象，如果是前一种，如何根据投保人名称来查询保单呢？其实这两种方式都可以，解决查询问题的方法也很多，只要你不只是盯着数据库来思考。比如，只存储了客户编号如何解决查询问题？只要在前端用下拉控件选择客户来代替输入客户名称即可；如果保存了客户名称如何在客户信息更新后同步到其他对象中呢？既可以使用定时任务刷新，也可以使用消息广播的方式来同步更新客户信息。</div>2021-02-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/30/f1/62f0388c.jpg" width="30px"><span>波锅</span> 👍（2） 💬（1）<div>老师，聚合根与聚合根之间通过 ID 关联的方式实现聚合之间的协同， 这个如何理解？ 这里的聚合根ID是不是就是实体ID？
聚合根与聚合根之间的协同，不应该是在聚合根A的应用层调用聚合根B的接口吗？根据ID关联协同具体是？</div>2020-12-04</li><br/><li><img src="" width="30px"><span>瀚囧</span> 👍（2） 💬（1）<div>老师，订单和退款，订单作为一个领域，退款作为一个领域，他们都有支付人值对象，这个支付人值对象是共用的吗，还是不同领域有各自不同定义，这样同一个值对象会被定义两次。</div>2020-11-17</li><br/><li><img src="" width="30px"><span>Geek_7c4953</span> 👍（2） 💬（3）<div>比如有的业务场景需要同一个聚合的 A 和 B 两个实体来共同完成，我们就可以将这段业务逻辑用领域服务来实现。
这句话有点不理解。
如果是一个聚合内的两个实体，那么他们应该都是直接或间接被聚合根引用，那么对于这两个实体共同参与的业务，为什么不是作为这个聚合根实体的行为，而是在外部又建立领域服务呢？</div>2020-08-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/8d/4f/29e96220.jpg" width="30px"><span>wall.e</span> 👍（2） 💬（1）<div>聚合根提供的方法是不是就是领域服务呢？</div>2020-08-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/18/75/68487e89.jpg" width="30px"><span>川川</span> 👍（2） 💬（1）<div>老师请问一下
1. 既然一个微服务包含了多个聚合，   那会不会导致微服务过多解决数据一致性的难度加大； 之前在看限界上下文的时候有讲到一个限界上下文就对应一个微服务，那是不是应该以限界上下文作为微服务拆分的标准

2.老师在文章里面提到了应用服务是用来处理聚合的业务逻辑，   想问下应用服务和这里讲的微服务的的关系是什么</div>2020-07-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/3c/01/29008d6a.jpg" width="30px"><span>千城</span> 👍（2） 💬（3）<div>老师，你这一节讲得有些抽象。聚合和聚合根举例能否对应到代码层和数据库层？我的理解是聚合是一种组织关系，将不同的实体和值对象聚合到领域内或者更细的子域内。但是聚合根作为实体，是不是对应有个数据库表？代码上有个类？然后它是什么样子的？  老师能否再举例详说一下？ 谢谢！</div>2020-03-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/1b/70/547042ee.jpg" width="30px"><span>谭方敏</span> 👍（2） 💬（1）<div>聚合是实体和值对象的集合，聚合根则是聚合内部的管理者，实体就是最基础的业务逻辑单元，而值是业务属性集合。
它们在领域事件中按照实体&#47;值对象-聚合根-聚合的先后顺序抽茧剥丝出来的，
聚合之间访问要借助聚合根，并且聚合对应于唯一的持久化对象。</div>2020-02-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c9/20/e4f1b17c.jpg" width="30px"><span>zj</span> 👍（2） 💬（1）<div>一个聚合可能对应一堆实体及值对象，一个聚合对应一个仓储也即数据持久化单元。那如何实现聚合到持久化单元呢</div>2019-11-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/12/e5/592d9324.jpg" width="30px"><span>TH</span> 👍（2） 💬（1）<div>在别处看到，持久化只能由聚合根来进行，并且由于聚合是用来保持聚合内部的数据一致性，因此持久化时应当持久化整个聚合。

另外还有一个疑问，在与外部聚合协同时只能通过外部聚合根的ID，这个具体是怎么实现的呢？如果当前聚合不持有外部聚合根实体，要怎么使用它的业务功能呢？通过外部聚合根暴露REST API吗？如果是一个单体应用怎么做到不直接调用外部聚合根呢？</div>2019-10-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/a0/47/36207f72.jpg" width="30px"><span>cash</span> 👍（1） 💬（1）<div>欧老师好
我们现在有一个场景是会员注册，会员会通过不同的电商平台账号进行注册，在会员注册内部会对不同平台账号注册进行处理。在这个场景中我是否可以以会员，平台账号分别做为聚合根呢</div>2020-12-18</li><br/>
</ul>