你好，我是欧创新。

前面我们重点讲述了领域建模、微服务设计和前端设计方法，它们组合在一起就可以形成中台建设的整体解决方案。而中台大多基于分布式微服务架构，这种企业级的数字化转型有很多地方值得我们关注和思考。

我们不仅要关注企业商业模式、业务边界以及前中台的融合，还要关注数据技术体系、微服务设计、多活等多领域的设计和协同。结合实施经验和思考，今天我们就来聊聊分布式架构下的几个关键问题。

## 一、选择什么样的分布式数据库？

分布式架构下的数据应用场景远比集中式架构复杂，会产生很多数据相关的问题。谈到数据，首先就是要选择合适的分布式数据库。

分布式数据库大多采用数据多副本的方式，实现数据访问的高性能、多活和容灾。目前主要有三种不同的分布式数据库解决方案。它们的主要差异是数据多副本的处理方式和数据库中间件。

### 1. 一体化分布式数据库方案

它支持数据多副本、高可用。多采用Paxos协议，一次写入多数据副本，多数副本写入成功即算成功。代表产品是OceanBase和高斯数据库。

### 2. 集中式数据库+数据库中间件方案

它是集中式数据库与数据库中间件结合的方案，通过数据库中间件实现数据路由和全局数据管理。数据库中间件和数据库独立部署，采用数据库自身的同步机制实现主副本数据的一致性。集中式数据库主要有MySQL和PostgreSQL数据库，基于这两种数据库衍生出了很多的解决方案，比如开源数据库中间件MyCat+MySQL方案，TBase（基于PostgreSQL，但做了比较大的封装和改动）等方案。
<div><strong>精选留言（25）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/25/24/4d1b5f64.jpg" width="30px"><span>OpenMind</span> 👍（9） 💬（1）<div>请问小表广播是什么意思？是把分布在不同库中需要连表的叫小的表在每个与他关联查询表所在的库中冗余一份吗？比如订单表和客户信息表分布在不同库内需要连表查询，客户信息表数据少，小表广播就是在订单表所在的库中冗余一份客户信息表？</div>2020-03-12</li><br/><li><img src="" width="30px"><span>Geek_88604f</span> 👍（8） 💬（1）<div>老师，单元化架构中，发生故障的那个单元是如何做故障恢复的？</div>2020-03-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/2c/0b/ad939ef7.jpg" width="30px"><span>钱晟龙🐲龍🐉</span> 👍（4） 💬（2）<div>领域事件驱动的异步方式是分布式架构常用的设计方法，它可以解决非实时场景的数据最终一致性问题。基于消息中间件的领域事件发布和订阅，可以很好地解耦微服务。通过削峰填谷，可以减轻数据库实时访问压力，提高业务吞吐量和处理能力。你还可以通过事件驱动实现读写分离，提高数据库访问性能。对最终一致性的场景，我建议你采用领域事件驱动的设计方法。

你还可以通过事件驱动实现读写分离，提高数据库访问性能，老师这个是啥意思？？没看懂。。</div>2020-02-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/15/69/187b9968.jpg" width="30px"><span>南山</span> 👍（2） 💬（1）<div>一直尝试着建立自己的知识体系，分布式的经典问题是很重要的一环，今天看老师的这篇也有些新的收获补充进去，比如OceanBase，听过大名，但是不知道是多副本机制实现的分布式数据库。</div>2019-11-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/79/29/a90cf777.jpg" width="30px"><span>深山小书童</span> 👍（2） 💬（1）<div>这么课程就只看这两篇总结就值回票价了！前两天刚刚碰到老师说的前后序实体关联问题，也是按照领域事件来冗余实体的。</div>2019-11-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/20/b7/bdb3bcf0.jpg" width="30px"><span>Eternal</span> 👍（1） 💬（1）<div>BFF感觉和微前端得抽象一样，不知对不对？
</div>2020-11-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/33/e2/4893dc25.jpg" width="30px"><span>Hello.World.唐 </span> 👍（0） 💬（3）<div>老师好，在实际的环境中，当多个服务共享数据（非数据字典类的数据）时，目前采用的是冗余表，即将共享数据信息冗余到部分业务数据里面，避免过渡查询和服务调用。这样会有一个问题，当共享的源数据发生改变后，如何更好的通知更改其他服务中冗余的数据。或者有没有更好的方式来处理谢谢业务上的冗余数据</div>2020-09-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/84/69/abb7bfe3.jpg" width="30px"><span>熊猫大侠</span> 👍（0） 💬（3）<div>前提：BFF层调用多个微服务，BFF主要职责是做服务聚合，流程的编排给前端 页面提供服务。像一些前端的页面逻辑，比如文案的处理，数据的筛选，BFF是否应该有领域服务层在处理这些逻辑，BFF是否应该有领域服务？这些逻辑通常在微服务不愿意做的 。</div>2020-02-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/33/74/d9d143fa.jpg" width="30px"><span>silentyears</span> 👍（0） 💬（1）<div>老师好，请问：
1、第四点“在业务库中增加冗余的代码副表，当主表数据变化，通过消息发布和事件驱动，异步刷新所有副表数据”具体怎么理解，难道要在微服务业务库A中增加B的冗余数据存储，比方说订单库中增加冗余副表存储客户库中的客户信息？
2、第四点介绍的两种场景的解决方式和CORS这种技术方案有何关系?
谢谢</div>2020-02-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/31/10/4e2617dd.jpg" width="30px"><span>YEROM</span> 👍（0） 💬（2）<div>BFF有没有更深入的一些资料可以参考的？</div>2020-01-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/3d/77/45e5e06d.jpg" width="30px"><span>胡鹏</span> 👍（0） 💬（1）<div>实战篇还得一边实践一遍反复观看才行,   直接看的话,    容易一眼就过去了而不知所云</div>2020-01-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f5/0a/077b9922.jpg" width="30px"><span>krugle</span> 👍（0） 💬（4）<div>微服务 服务要做拆分 我们做电商saas的  比如商品服务 要不要区分商城和管理后台的商品服务</div>2019-11-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/db/c3/e11adfe8.jpg" width="30px"><span>hunter</span> 👍（0） 💬（1）<div>分库类库实际上是一个基础 JAR 包，与应用软件部署在一起。。这个 JAR 包是啥？</div>2019-11-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/45/2f/b0b0dd74.jpg" width="30px"><span>杨杰</span> 👍（0） 💬（3）<div>通过事件驱动实现读写分离，提高数据库访问性能。具体实现上是指：每次写数据有变化的时候，把相关的数据变更（或捕获的SQL语句）异步发生给读数据库？如果采用这种模式那如果数据结构变化较频繁该如何处理？</div>2019-11-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/1e/f9/bfb54326.jpg" width="30px"><span>狮锅艺</span> 👍（32） 💬（8）<div>学完欧老师的DDD实战，在具体项目中战略设计和战术设计完成后，可以看看 https:&#47;&#47;microservices.io&#47; 这个网站，很多微服务开发部署的细节都有讲解。</div>2020-03-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/58/45/721545cc.jpg" width="30px"><span>Q</span> 👍（0） 💬（0）<div>之前在公司实施过BFF 层 接入的微服务非常多 导致后来这个服务变得越来臃肿  在业务上做了数据的透传和流程调用 既有业务 又不是核心业务 感觉花人员时间维护 有点浪费资源 不维护又不行 这种怎么解决  希望老师回复</div>2023-11-14</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI5oPqDPiaSY0rtOWLeXgiaAKhq1dicTiaqjib3qw8vOpRqTPA3Iv1JKybpWpyiama0OE1sDkicpuIu3FRMQ/132" width="30px"><span>李亮亮</span> 👍（0） 💬（0）<div>上tidb</div>2022-12-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/69/2c/7fcca7d1.jpg" width="30px"><span>killer</span> 👍（0） 💬（0）<div>BFF层和新增一个微服务聚合层有什么区别？</div>2022-09-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/83/8d/03cac826.jpg" width="30px"><span>徐李</span> 👍（0） 💬（0）<div>这里的分布式架构设计也是中大型公司才有机会遇到的吧，小公司不管是业务体量还是数据都没有这个必要。老师罗列的这10点，每一点单列出来都是很大的一个工程。

就算不用DDD，只要你是微服务的架构设计，当然前提是集群环境，那么肯定就会遇到这些一致性的问题，事务的问题，性能的问题。</div>2021-12-22</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eq6dppX1EPFeGvkUXVLHnxBBIkbz72kicGRwCW1avtccPyMj1JVR3vPFb3FBlZcgVUuSkMmnSHel0Q/132" width="30px"><span>小邦plus</span> 👍（0） 💬（0）<div>你可以在货物运输微服务，一次获取前序订单的清单数据和货物运输单数据，将所有数据一次反馈给前端应用，降低跨微服务的调用。如果前序数据被设计为实体，你还可以将前序数据作为查询条件，在本地微服务完成多维度的综合数据查询。
老师还在看留言吗？前序实体关联这段不是很理解，可以解答一下吗</div>2021-12-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/53/ca/44088dd0.jpg" width="30px"><span>花生</span> 👍（0） 💬（0）<div>老师，有两个问题，一、对于第二类场景，对于不在同一个数据库的表与表之间的关联查询场景，你可以采用小表广播。您的意思是在每个数据库都建机构和业务表，有变化就异步更新吗。二、这一章分布式架构的问题，能否推荐一些书籍。</div>2021-08-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/9c/cc/085b9740.jpg" width="30px"><span>王志</span> 👍（0） 💬（0）<div>老师：我看你直接在foreach里面调用数据库查询操作，有什么原因吗？这样会导致查询很慢</div>2020-12-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/19/35/be8372be.jpg" width="30px"><span>quietwater</span> 👍（0） 💬（0）<div>干货满满，任重道远。</div>2020-01-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg" width="30px"><span>Jxin</span> 👍（0） 💬（0）<div>回答问题：

1.职位不够，很遗憾没实操过。但个人test，臆想啥的挺多。不过这里要补充就太多了。极客现在也有很多课程说这些，就不多赘述了。

2.除了这十个问题。其实还得补充点。springboot官方文档多次提到“生产就绪”的概念。这也意味着，除了ops，dev也是架构需要高度关注的重点。所以，指标收集，健康检查，外化配置管理等等应该也要算入当下架构的核心问题。</div>2019-11-30</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKZ16iaIia0029oI1Qh5NicibpbTiaBAaCOPYXoLplKHr6uQ2rSVxPZanBvpMcL2NuhwKQYCFnaHP5tedQ/132" width="30px"><span>FIGNT</span> 👍（0） 💬（0）<div>虽然很对不懂，但我知道是干货</div>2019-11-30</li><br/>
</ul>