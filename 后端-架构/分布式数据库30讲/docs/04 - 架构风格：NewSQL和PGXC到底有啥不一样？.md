你好，我是王磊，你也可以叫我Ivan。

分布式数据库已经是技术新潮流了，所以产品也越来越多，如果你要做技术选型或者想要学习，该如何下手呢？怎么能更高效地了解不同产品的特点呢？这就需要你把它们分分类，有些差不多的产品，熟悉了其中的一个，剩下的我们只要记下差异点就可以了。那下面的问题就是如何分类了，这个其实很简单，因为业界已经有共识，把产品按照架构风格划分到不同的阵营。

总的来说，分布式数据库大多可以分为两种架构风格，一种是NewSQL，它的代表系统是Google Spanner；另一种是从单体数据库中间件基础上演进出来的，被称为Prxoy风格，没有公认的代表系统。我觉得Prxoy这个名字太笼统，没有反映架构的全貌，还是要有一个具体的架构模板，才能便于你理解，所以我选了一个出现较早的产品来指代这种风格，这就是PostgreSQL-XC（下文简称PGXC）。

我在后面的课程中讲述分布式数据库的特性和原理的时候，也会沿着这两种架构风格的思路，帮助你去迅速抓住不同产品的要点。因此，我们今天就先用一讲来学习下这两种架构风格。

## 数据库的基本架构

要搞清楚分布式数据库的架构风格，就要先了解“数据库”的架构。当然，我们这里说的数据库仍然默认是关系型数据库。我们先通过一张架构图看看数据库的全貌。
<div><strong>精选留言（27）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/71/3d/da8dc880.jpg" width="30px"><span>游弋云端</span> 👍（6） 💬（3）<div>在传统数据库之上，不做分片和分表等逻辑，基于共识协议达成多个节点的数据一致性，这类产品怎么算归属？</div>2020-08-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/88/23/a0966b4d.jpg" width="30px"><span>Tim Zhang</span> 👍（5） 💬（4）<div>想学习下分布式数据库源码，newsql有没有java实现的分布式数据库，golang看起来比较累</div>2020-08-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/fa/fd/3a6d013a.jpg" width="30px"><span>朱海昆</span> 👍（3） 💬（1）<div>感觉老师的讲解会让我对分布式的理解更上一个台阶，谢谢老师</div>2020-08-18</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJqUkoCXOxRraVNVg1fTm4O892WFVCjeL9pS8kUX2nEeTEcaS6k0kP25h3rRKtUCwSoUrY6dvP43w/132" width="30px"><span>赵见跃</span> 👍（3） 💬（2）<div>老师好，腾讯的TBase 属于PGXC 架构，那腾讯的TDSQL 属于哪个架构呢？它们的架构不一样是吧。谢谢老师。</div>2020-08-18</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJqUkoCXOxRraVNVg1fTm4O892WFVCjeL9pS8kUX2nEeTEcaS6k0kP25h3rRKtUCwSoUrY6dvP43w/132" width="30px"><span>赵见跃</span> 👍（3） 💬（2）<div>老师好，NewSQL是在nosql基础上进化的，那NewSQL就是比nosql 多了事务功能吗？还是有更多的变化？像mongodb也提供了事务功能，它不属于NewSQL是吧。谢谢！</div>2020-08-18</li><br/><li><img src="" width="30px"><span>Geek6713</span> 👍（2） 💬（1）<div>有一点不太理解，为了实现分布式事务为什么一定要有全局时钟呢？两阶段提交协议就可以实现分布式事务啊。</div>2020-12-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/1e/b7/b20ab184.jpg" width="30px"><span>麋鹿在泛舟</span> 👍（1） 💬（1）<div>请教一个疑问，PG-XC架构数据库如果讲底层的存储替换成分布式存储，是不是也可以说数据库也具备了NewSQL的能力？ NewSQL也在逐步支持分布式事务，随着以后的技术演进，是不是两者界限会逐渐模糊?</div>2021-02-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/3e/e9/116f1dee.jpg" width="30px"><span>wy</span> 👍（1） 💬（1）<div>ivan老师，hbase这种 nosql的kv数据库是不是完全可以用pgxc架构的数据库替代，因为在pgxc不仅可以存储海量数据而且支持更复杂的计算，使用场景多。hbase在我看来它的优势在于可以通过region的分裂达到更好负载平衡，但是这个pgxc实现起来应该也不难。</div>2020-09-27</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Pu41KPIhAp72l0N7kOFL738owSAIT5EyH0oUUMacQRWzeFV77QDjSDNTSFNvjNZib1myibvxAfQAsAY5KzsIia73w/132" width="30px"><span>王鹏</span> 👍（1） 💬（1）<div>最近用了Clickhouse，感觉是真的快，也能解决一些OLAP和OLTP混合的场景</div>2020-08-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/71/97/f1a3d398.jpg" width="30px"><span>张永志</span> 👍（1） 💬（1）<div>全局时钟的话，还能调整系统时间吗？往回调整时间允许吗？</div>2020-08-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/b5/36/d444d19e.jpg" width="30px"><span>xy🥝</span> 👍（1） 💬（2）<div>老师讲的特别好，又拓展了视野。
腾讯的TDSQL应该也是属于PGXC类的，也是比较依赖于proxy</div>2020-08-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e6/1c/9d3744ee.jpg" width="30px"><span>程序员俊达</span> 👍（0） 💬（2）<div>现在NewSQL有新出一个StarRocks，现在公司的项目需要从TiDB迁移到StarRocks上。</div>2021-11-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/75/dd/9ead6e69.jpg" width="30px"><span>黄海峰</span> 👍（0） 💬（1）<div>greenplum是不是也是pgxc风格</div>2020-09-23</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK0Qwib3PcoRRxTZSoxAdJ1hELibJeoEqSKP6Ksyu0e7MrGickk1COuv6oQ1w9W2kqM8gUg0Oj057UBw/132" width="30px"><span>UTC+00:00</span> 👍（0） 💬（2）<div>感谢老师的精妙讲解， 让我对分布式数据库有了更近一步的理解。
日前，TiDB中PD转移至TiKV项目，不知是否能算作&quot;NewSQL 朝 PGXC 的方向做了一点回拨&quot;，亦或是通讯链路边长、网络通讯“代价”过大。
PS: 吹了很久的微服务的风，问题也逐渐暴露。现在有种“分布式”向“单体”回拨的趋势，例如，Istio。</div>2020-08-23</li><br/><li><img src="" width="30px"><span>vage</span> 👍（10） 💬（4）<div>有一种数据库，计算与存储分离架构，数据在存储层分片存储，而且实现了计算下沉。另外，数据还可以缓存在计算层，以提升读写性能，最牛B的是，还可以在多个计算层节点的缓存中保持一致。上面还实现了标准的SQL接口，兼容SQL99等标准。如果实现了上面这些功能，从技术来说，这个数据库强大吗？有市场需求吗？金融行业有需要吗？</div>2020-10-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ff/24/abb7bfe3.jpg" width="30px"><span>Geek_7ixbah</span> 👍（6） 💬（0）<div>想知道老师都是怎么学习这些经典论文的呢，比如文中的 “Architecture of a Database System”，一百多页的论文真的全读通读吗</div>2021-09-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/83/ce/d52344f4.jpg" width="30px"><span>张海鹏</span> 👍（5） 💬（0）<div>PGXC 最后面的是单体数据库，后面的集群依然是通过类似 Binlog 的方式来同步的，所以结构也是主从或主备。而 NewSQL，底层是分布式存储，各节点通过 Paxos 或者 Raft 来同步。这是两者的大差别。另外，NewSQL 对待架构上的每个组件都是可以独立且分布式部署的。</div>2020-12-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/34/df/64e3d533.jpg" width="30px"><span>leslie</span> 👍（2） 💬（0）<div>用过GOLDENDB，给我的感觉就是和PG和MYSQL的使用思路近似，至少在cording和index方面。
Tidb只知道开发者中有一大批当年国内顶级的MYSQL牛人，文档和部署方面给人的感觉和GOLDENDB也是大相径庭，总体感觉思路应当受MONGODB影响更深；只是没有想到OCEAN也是同理。
国内TIDB类似的应当还有热濮科技：金官丁十余年前就是mysql的神人，感觉现在的分布式是在早年mysql和mongodb基础上出来的；至少前段时间和一些DB圈子退役边缘的老混混沟通时大家有此认可。</div>2021-07-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/0f/70/f59db672.jpg" width="30px"><span>槑·先生</span> 👍（0） 💬（0）<div>所以 Aurora 也是属于pgxc架构咯？</div>2024-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2b/b8/81/a0afe928.jpg" width="30px"><span>杜思奇</span> 👍（0） 💬（0）<div>老师，在GaussDB(DWS)出现前有不少企业在使用Teradata。这种硬件一体机的TD属于哪种类别呀，也是PGXC么</div>2021-12-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c4/eb/2285a345.jpg" width="30px"><span>花晨少年</span> 👍（0） 💬（0）<div>学习到了，讲的真的很好，我准备先从分布式nosql学起，看看源码，然后有时间再研究关系型的</div>2021-06-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/8d/0e/1f49ade9.jpg" width="30px"><span>海鲨数据库架构师_曾院士</span> 👍（0） 💬（0）<div>应该有第三种风格
基于数据库中间件简单路由
对跨库事再新增的主库。表在主库是完整数据。
分片库只是表的部分数据。
对分片库事务除了在分片库执行外，还在主库执行。
跨库事务在主库执行，通过日志ROW放式再路由到方片库</div>2021-04-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/a2/55/1092ebb8.jpg" width="30px"><span>边城路远</span> 👍（0） 💬（0）<div>vitess也属于PGXC吧？</div>2021-04-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/74/67/46bb05de.jpg" width="30px"><span>怀刚</span> 👍（0） 💬（1）<div>巨杉数据库在存储引擎层实现了分布式的能力，数据库实例层兼容MySQL、PostgreSQL等协议，但是SQL实例、协调节点、数据节点物理上部署在一起组成一个node，严格来说并不是完全的计算存储分离，因为一个协调节点有可能将用户请求分发到多个数据节点（包含协调节点本身所在的数据节点），然后对数据节点返回处理后返回客户端，跟NewSQL和PGXC两种架构风格上都有所不同，不知道理解上对不对，疑问应该归属到哪一类？</div>2020-12-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/fa/fd/3a6d013a.jpg" width="30px"><span>朱海昆</span> 👍（0） 💬（0）<div>巨杉在金融的案例相对较多，宣传也是金融级分布式关系型数据库。不知道老师对巨杉有什么看法？</div>2020-09-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/04/b9/153b6088.jpg" width="30px"><span>王昊</span> 👍（0） 💬（0）<div>老师您好，能简单说一下citus吗？</div>2020-08-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/f2/66/b16f9ca9.jpg" width="30px"><span>南国</span> 👍（0） 💬（0）<div>首先回答问题：因为还是学生，没啥熟悉的分布式数据库，就直接回答第二个问题啦。当然newsql支持的是结构化数据，nosql半结构化数据偏多，本身都有存在的意义，只是对比架构。熟悉的nosql是Redis，因为Redis集群不支持集群的跨节点事务（单线程支持单机事务很容易，lua脚本即可），所以使得redis的集群的架构简单且高效，哈希槽分片，gossip传递集群信息，当然分片的键值也不必支持全局时钟，这使得redis做单纯的key&#47;value服务非常高效。而对比Newsql，因为我们下的定义是关系型数据库，所以需要支持分布式事务，这是很复杂且昂贵的操作（spanner使用的两阶段提交本身还有单点故障，数据不一致的问题），因为数据的更改顺序很重要，所以也需要全局时钟，更不必说单机关系型数据库本身逻辑的复杂性，所以不但读写都非常昂贵，也会使得架构很复杂（spanner为了物理时钟而引入time master和每台机器上的timeslave daemon，分布式事务要映入事务管理者，此时也要锁表）。当然它们都有适合的场景，还是取决于数据类型与具体业务的取舍。

学了这节课程后确实从一个新的角度看待了这个问题，但是有一个小小的问题，就是觉得PGXC与Newsql的界限很模糊，因为它们需要支持分片，事务，全局时钟等，分片需要分机器（newsql粒度更小，spanner以一个Tablet组为粒度），大家都一样，分布式事务则需要协调者，大家也一样，全局时钟也都是依靠外界，那么是否可以理解为它们的差别就是单个机器上是运行仅进行存储（当然还有各种日志）的程序还是一个完整DBMS呢？</div>2020-08-19</li><br/>
</ul>