你好，我是王磊，你也可以叫我Ivan。今天，我们要学习的是数据复制。

数据复制是一个老生常谈的话题了，典型的算法就是Paxos和Raft。只要你接触过分布式，就不会对它们感到陌生。经过从业者这些年的探索和科普，网上关于Paxos和Raft算法的高质量文章也是一搜一大把了。

所以，今天这一讲我不打算全面展开数据复制的方方面面，而是会聚焦在与分布式数据库相关的，比较重要也比较有意思的两个知识点上，这就是分片元数据的存储和数据复制的效率。

## 分片元数据的存储

我们知道，在任何一个分布式存储系统中，收到客户端请求后，承担路由功能的节点首先要访问分片元数据（简称元数据），确定分片对应的节点，然后才能访问真正的数据。这里说的元数据，一般会包括分片的数据范围、数据量、读写流量和分片副本处于哪些物理节点，以及副本状态等信息。

从存储的角度看，元数据也是数据，但特别之处在于每一个请求都要访问它，所以元数据的存储很容易成为整个系统的性能瓶颈和高可靠性的短板。如果系统支持动态分片，那么分片要自动地分拆、合并，还会在节点间来回移动。这样，元数据就处在不断变化中，又带来了多副本一致性（Consensus）的问题。

下面，让我们看看，不同的产品具体是如何存储元数据的。
<div><strong>精选留言（23）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/ea/32/1fd102ec.jpg" width="30px"><span>真名不叫黄金</span> 👍（26） 💬（1）<div>我认为分布式数据库的瓶颈可能在于两个方面:
1. 元数据，元数据过多的情况下，可能需要多层查找，才能找到数据的节点，由此降低了性能。
2. 心跳包，如果网络中太多节点，那么心跳包也会占用相当多的带宽，影响IO性能</div>2020-08-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/bc/25/1c92a90c.jpg" width="30px"><span>tt</span> 👍（12） 💬（3）<div>我觉得容量上限主要受制于业务场景，为了提高性能需要增加分片，但是分片多了以后，为了达到一致性的要求，节点太多影响通讯和数据复制的成本，这两个方面权衡一下就决定了容量的上限</div>2020-08-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/12/13/e103a6e3.jpg" width="30px"><span>扩散性百万咸面包</span> 👍（5） 💬（2）<div>老师看看我对Multi Raft的理解对不对。
一个Raft Group存储一个Region的多副本。例如TiDB默认副本数是３，那么一个Raft Group就是３个副本。同时一个节点可能有上千个Region（一般这些Region都不互为副本），每一个Region都属于一个Raft Group，那么也就是说这个节点可能参与上千个Raft Group。每个Raft Group又会选举出一个节点作为Raft Leader，负责写入数据。</div>2020-08-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/00/d3/ef5d2af0.jpg" width="30px"><span>Geek_81c7c9</span> 👍（4） 💬（3）<div>引用一下王老师对PGXC和NEWSQL的观点：
PGXC（raft）有稳定的工程实现；
NEWSQL（paxos）有更先进的设计思想；
从更容易落地的角度出发，raft确实更适合；
从更长远、更能有效规避潜在风险的角度出发，还是得上paxos，毕竟两大国民APP（支付宝ob、微信PhxPaxos）背后都是它对吧~</div>2020-10-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/12/13/e103a6e3.jpg" width="30px"><span>扩散性百万咸面包</span> 👍（4） 💬（2）<div>老师，看到你的文章中对比了Gossip和Raft&#47;Paxos这种算法，能说明一下如果Gossip共识时间更短，为什么TiDB等数据库不选择呢？为什么它更适合多节点？是因为它把网络I&#47;O分散到多个节点上吗？可是这也带来了一定的串行性呀！
BTW, Gossip达成共识要比Raft和Paxos要快么？</div>2020-09-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/65/32/36c16c89.jpg" width="30px"><span>Geek_osqiyw</span> 👍（4） 💬（1）<div>佩服这些协议的理论提出者，更佩服协议的工程实现者</div>2020-08-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/03/ce/ec3b8de9.jpg" width="30px"><span>淡漠落寞</span> 👍（1） 💬（1）<div>老师，想请教一下关于cockroachdb里的gossip相关的问题：
1 客户端是如何知道要往哪个节点发送请求的呢？
2 range的分裂场景下，节点的分片元数据信息的变更和节点的实际数据的迁移的先后顺序是怎么样的呢？</div>2021-06-27</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK0Qwib3PcoRRxTZSoxAdJ1hELibJeoEqSKP6Ksyu0e7MrGickk1COuv6oQ1w9W2kqM8gUg0Oj057UBw/132" width="30px"><span>UTC+00:00</span> 👍（1） 💬（1）<div>老师，咨询下，CockroachDB是如何判断R1分片的元数据过期的呢？全局时间戳吗？</div>2020-08-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5c/3e/a9c91e9f.jpg" width="30px"><span>武功不高</span> 👍（1） 💬（1）<div>额，全是新知识，有点懵懵，需要好好消化消化……
</div>2020-08-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg" width="30px"><span>piboye</span> 👍（0） 💬（1）<div>hbase 的 root 表位置放到zk上，root 表找到meta表， 再找到region表，这种方式好像和老师说的不同哦。 hbase不是分布式数据库，所以可以不一样的实现？</div>2020-08-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/3e/e9/116f1dee.jpg" width="30px"><span>wy</span> 👍（2） 💬（1）<div>使用gossip协议的话，必须保证至少存在一个节点有正确的元数据</div>2020-09-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/55/82/985411a8.jpg" width="30px"><span>xyx</span> 👍（1） 💬（1）<div>&quot;Leader 等待 Follower 的结果，如果大多数节点提交了这个 Log，那么这个 Log Entry 就是 Committed Entry，Leader 就可以将它应用（Apply）到本地的状态机。&quot;

这里表述有点小问题: 应该是leader等大多数节点append了这个log, leader才能commit(commit日志可以任何时候再apply). leader先commit, 下一个心跳中follower才会commit.</div>2021-02-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4d/54/9c214885.jpg" width="30px"><span>kylexy_0817</span> 👍（1） 💬（3）<div>Paxos不是有一个工业级实现，ZAB么？</div>2020-08-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/f2/66/b16f9ca9.jpg" width="30px"><span>南国</span> 👍（1） 💬（1）<div>如果分片信息由单节点管理的话这个分布式数据库是会有瓶颈的，但不是存储瓶颈（像bigtable那样，就像个多级页表一样，最大存储2^61字节数据），是访问瓶颈（当然是不是还需要测试），但也就是因为访问瓶颈就可能导致数据存储是有上限的，但是如果像spanner一样，把每个分布式数据库看做一个spannerserver，再建立一层，就像zone去管理spannerserver，然后再有一层去管理zone，这样貌似就可以无限扩展了，当然说着简单，做起来就太难了。还有对于无主架构中gossip传播集群分片信息，就像redis cluster一样，我觉得瓶颈在于每台机器要存储全部的分片信息，当机器多了以后单机光存储这个就是一个巨大的开销，这也是一个限制的因素吧。</div>2020-08-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg" width="30px"><span>piboye</span> 👍（1） 💬（1）<div>分片信息不需要强一致性，更强调ap吧？所以paxos不一定是最好的选择，就像服务发现也是ap型。</div>2020-08-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/29/44/3c/8bb9e8b4.jpg" width="30px"><span>Mr.Tree</span> 👍（0） 💬（0）<div>Gossip协议类似于流言传播，如果副本很多前一秒a节点的数据是最新的，广播同步出去，其他节点这一刻最终会指向a，此时另一个节点发生更新，还未同步到a节点，客户端读到a节点的副本，a节点如果不指向其他节点就不是最新的此时数据一致性是不是有问题呢？思考题：理论上从分布式架构的存储来讲，分布式存储就像是一棵树，一个中心管理元数据，下面可以有无限分支，存储将不受限制，感觉有点b＋tree，层数高了或者分布式的元数据庞大之后数据检索速度将会受限制，最好的方式就是找到时间和空间的一个平衡点，该平衡点会限制存储上限，但根据摩尔定律，这个平衡点的又会不断被打破，上限到底有没有限可能只有站在现在对过去说2023年这个海量存储的理论上限是x了</div>2023-07-29</li><br/><li><img src="" width="30px"><span>Geek5267</span> 👍（0） 💬（0）<div>mgr就是基于Paxos的实现。</div>2023-04-24</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEJia90ErsTQtNDNeyTWNwWjicERicXj72b4xgbvru2IkUdrLxrgJb5lCrTaiaW2iaX3mOYiaV8vYo3voWlg/132" width="30px"><span>家乐</span> 👍（0） 💬（0）<div>即客订阅了很多门课程，印象最深或者说体验感，学习理解度最好的就是王磊老师的分布式数据库，林晓斌老师的MySQL45讲。受益匪浅。不仅是技术好，而且都很谦虚。回复同学也很多。再次感谢老师的分享。</div>2022-03-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/fd/c3/565f0c57.jpg" width="30px"><span>kafka</span> 👍（0） 💬（1）<div>为什么PD要做无状态的设计呢？把分片信息持久化，不需要数据节点向元数据发心跳包不是更稳定性的选择吗？</div>2021-01-22</li><br/><li><img src="" width="30px"><span>Geek_6krw94</span> 👍（0） 💬（0）<div>关于数据复制，需要保证副本节点数据一致问题：

raft算法可以应用到业务数据层面吗？非分片规则数据？如果不行，有什么更好的方案吗？业务数据量比较大</div>2021-01-12</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKkkzHH7lKmxHdJmZW4niaUNicmZwVr8usAxDp93RgicDSicoVpict2ezIexpnTEs5dZQibQdt1V0UMlCUg/132" width="30px"><span>Geek_d560e0</span> 👍（0） 💬（0）<div>老师，mgr算不算是一个比较好的Paxos工程实现呢?</div>2020-11-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/96/47/93838ff7.jpg" width="30px"><span>青鸟飞鱼</span> 👍（0） 💬（0）<div>收获满满</div>2020-11-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/d5/b1/1007b5d2.jpg" width="30px"><span>星之柱</span> 👍（0） 💬（0）<div>tidb的分片的的分裂等复杂的逻辑还是pd来管理的吧，tikv的心跳只是为了汇报每个分片的状态</div>2020-11-02</li><br/>
</ul>