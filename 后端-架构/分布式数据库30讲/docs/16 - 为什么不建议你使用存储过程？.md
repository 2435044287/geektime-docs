你好，我是王磊，你也可以叫我Ivan。

今天，我们一起来到了这门课的第16讲。如果你学习并理解了前面的所有课程，那么我要恭喜你，这不仅是因为你学完了一半的课程，还意味着你已经征服了“数据库事务”这座高峰。当然，如果你有困惑的地方，也不必沮丧，因为接下来会是一小段平缓地带，我们会探讨一些相对独立的问题。比如我们今天的话题，为什么不建议你使用存储过程？

有些资深的数据库开发同学可能不同意这个观点，我猜他们大概会说：“存储过程很好呀，那些用不好的人就是自己水平烂，不接受反驳！”其实，我就有过这样的念头，但是现在的我面对分布式数据库，会更倾向于少用或者不用存储过程。下面，我就来和你分享下这个心路历程吧。

## 我从C/S时代走来

当我刚成为一个名程序员时，正好是C/S架构时代的末期。那时最流行的开发套件是PowerBuilder和Sybase数据库。PowerBuilder是一款可视化开发工具，有点像VB，开发好的程序运行在用户的PC终端上，通过驱动程序连接远端的数据库。而Sybase当时正与Oracle争夺数据库的头把交椅，它和SQL Server有很深的渊源，两者在架构和语言上都很像。

![](https://static001.geekbang.org/resource/image/4c/69/4c5bc32eeaffdd633e0429a2a52db269.jpg?wh=2700%2A1567 "C/S架构")

在这个C/S架构中，数据库不仅承担了数据存储、计算功能，还要运行很重的业务逻辑，相当于数据库同时承担了应用服务器（Application Server）的大多数功能。而这些业务逻辑的技术载体就是存储过程。所以，不管是Sybase还是Oracle，它们存储过程的功能都非常强大。
<div><strong>精选留言（15）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg" width="30px"><span>Jxin</span> 👍（18） 💬（4）<div>对本章的理解:
1.业务代码跟技术代码应该要分离，我们需要保证业务逻辑到业务代码的翻译简单而纯粹。这既是在实现阶段，降低对具体技术的耦合，也是在保证业务代码的可测试性以及业务代码的简单和内聚。
2.具体技术的特性(比如存储过程)往往能起到杰出的性能。但这也增加了实现阶段的复杂性，而复杂意味着难维护，意味着成本和风险。虽然实现了软件行为价值，但架构质量上的健康却受到了伤害。所以在性能要求严格的场景，使用具体技术的一些特性无可厚非，但要保持警惕，认清这是把双刃剑。不可仗着自己&quot;功力深厚&quot;而肆意妄为。
3.没经历过c&#47;s的时代。但从数据模型驱动设计的相关书籍中,可以看到存储过程在当初是如何的大行其道。可是放在现在，当存储过程等一系列手段成过去式后，数据模型驱动设计就开始变得很&quot;贫血&quot;。基本只剩实体关系模型和数据项这点单薄的信息承载能力,已经不适合再驱动复杂的业务软件的设计。
4.放上自己对数据模型驱动的实现，以做交流: https:&#47;&#47;github.com&#47;Jxin-Cai&#47;mdd&#47;tree&#47;master&#47;data-model&#47;mini-faas

课后题: 
VoltDB的这个分片复制和rocketMq的nameserver有异曲同工之妙。通过并行对所有副本执行操作，规避副本间达成共识的复杂性。</div>2020-09-16</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJoiar0OoeEdc1l1UiaKKLjKblibqda3fxzibXibiahMqsvAanS3Gzu1CF4xupc6wPzmbpQqr2MMWkGeXeA/132" width="30px"><span>vkingnew</span> 👍（4） 💬（1）<div>1.“《阿里巴巴 Java 开发手册》中也赫然写着“禁止使用存储过程，存储过程难以调试和扩展，更没有移植性。” 这个有误导的嫌疑，这里的存储过程针对的是MySQL，确实难以调试难以复制。在同等时代的产品产品中以oracle的PL&#47;SQL,SQL server 的T-SQL编写的存储过程还是很有优势的，DB2和Oracle都支持PL&#47;SQL的，这里PL&#47;SQL是具有移植性的，并且这个存储过程在SQL标准中叫做（SQL&#47;PSM (SQL&#47;Persistent Stored Modules) https:&#47;&#47;en.wikipedia.org&#47;wiki&#47;SQL&#47;PSM）。
2.纵贯SQL标准的发展以及oracle的发展，存储过程的支持也是有发展历程的，存储过程在性能和开发效率上还是蛮高的。在大数据时代人们讲存储分离，存储归存储，计算归计算，在硬件和成本平衡的基础上，通过水平扩展来增加算力，把存储过程功能暂时不开发或者说难以开发，但是Apache hive是支持的存储过程的叫做hpsql。
3.在分布式数据库中的典型的代表 TiDB和CockroachDB 二者在语法兼容以及对存储过程的支持上有些不同，CockroachDB是支持pg语法的存储过程的（pg类似于PL&#47;SQL）。</div>2020-09-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/83/e2/297518ab.jpg" width="30px"><span>佳佳的爸</span> 👍（1） 💬（3）<div>存储过程是单机数据库时代的不可替代的产物，当年我当程序员的时候，存储过程是最好的解决前后端代码分离的利器。一个10万条订单批量审核的操作，调用存储过程几分钟搞定，前端vb代码执行，一个小时都出不了结果</div>2020-09-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/df/70/52f2ab90.jpg" width="30px"><span>Andy Huang</span> 👍（0） 💬（1）<div>互联网的sql不用存储过程 也不用显式事务，都是单独SQL语句的隐式事务么？那应该是互联网的业务比较简单 如果复杂业务的Erp可不流行这样，否则业务代码非常复杂，这样无法真正利用数据库的事务功能，不可惜么。？</div>2022-07-10</li><br/><li><img src="" width="30px"><span>ifxdba</span> 👍（0） 💬（1）<div>存储过程就是一个死穴，一旦上路，便没有看了回头路</div>2020-09-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/83/e2/297518ab.jpg" width="30px"><span>佳佳的爸</span> 👍（9） 💬（1）<div>OceanBase支持Oracle的存储过程是迫不得已的事情，因为这决定着 它是否能 &quot;侵入&quot; Oracle的传统客户阵营-大企业和金融领域，是一种纯粹的商业行为。举个例子来说，Oracle 的ERP产品中大量采用了存储过程来实现业务逻辑，最复杂的业务逻辑的源码打印出来几十页，这么复杂的存储过程 我相信 OceanBase的工具是无法完美处理(移植到OB)的，但是为了竞标之类的商业行为，你如果不支持Oracle的很多特性 你就根本没有参与的机会。 这就是中国的现实情况。</div>2020-09-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/83/e2/297518ab.jpg" width="30px"><span>佳佳的爸</span> 👍（2） 💬（0）<div>VoltDB用K-safety机制解决数据复制的问题，其实就是N+1的副本机制，VoltDB在写数据操作的时候，会在每个副本中执行该语句，这样就可以保证数据被正确插入每个副本。这N+1的副本都可以同时提供访问，同时允许最多N个副本丢失(分区故障), 当N+1个副本都不可用的时候，VoltDB就会停止服务进行修复。</div>2020-09-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4f/bd/6d825f68.jpg" width="30px"><span>一想再想N</span> 👍（0） 💬（0）<div>MySQL不允许开发使用存储过程，但是dba自己可以用。</div>2022-10-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/df/70/52f2ab90.jpg" width="30px"><span>Andy Huang</span> 👍（0） 💬（0）<div>如果应用使用存储过程 当前主流的中间件 是否支持读写分离?</div>2022-07-10</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/AoXC8Dwxrs9cia2MFhHjvnrxEO1e77f7FBgTVZP83aLOynq8KjcxLmkibiauUMgsHPf0WUtNgE4fpHxlCeNmHxp0A/132" width="30px"><span>Sai</span> 👍（0） 💬（1）<div>王老师，请问你的那个存储过程移植问题最后怎么解决的，最后是不用存储过程了吗？</div>2022-06-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg" width="30px"><span>piboye</span> 👍（0） 💬（0）<div>udf + webassebly + python 机器学习库 这样的方式是不是可以打开 sql 的应用范围？</div>2022-01-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/34/df/64e3d533.jpg" width="30px"><span>leslie</span> 👍（0） 💬（0）<div>存储过程确实如同触发器Tigger，早年的历史产物，针对DML操作；针对查询其实还有一个产物叫视图-view。
之前的一些视图现在大量被数据库厂商自己写好了倒是少了用户操作，另外一部分由于涉及量过大的则从OLTP转到噢OLAP中，近年来各种OLAP中都是大量的SQL-这就是典型的说明。
视图可以替代过去存储做的事情在OLAP中，触发器做的事情在这个年代可以通过程序+MQ去控制，从而避免了代码运行次数突然运行次数的变化导致RMDB宕机。生产中碰到过，一个正常运行3-5次的在某次业务高峰突然数千次运行-直接导致宕机。</div>2021-07-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/c4/f3/92f654f1.jpg" width="30px"><span>Bug? Feature!</span> 👍（0） 💬（0）<div>外企最喜欢用存储过程了，可能老项目比较多吧，不好整改。</div>2020-10-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/bc/25/1c92a90c.jpg" width="30px"><span>tt</span> 👍（0） 💬（0）<div>我觉得既然存储过程都支持用JAVA了，那数据复制应该就可以借鉴TCC，直接在代码层也就相当于是“服务层”实现，而且又是基于内存的，重试的成本还是比较低的，直接用代码往节点里写得了。

都是基于内存，但与REDIS不同，应该不会要求那么高的性能，直接用线程池同时往数据节点里写数据</div>2020-09-14</li><br/><li><img src="" width="30px"><span>地下城勇士</span> 👍（0） 💬（0）<div>clickhouse的物化视图其实是个触发器，这种应该从什么角度分析？</div>2020-09-14</li><br/>
</ul>