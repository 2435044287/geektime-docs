高性能程序就是高效的利用CPU、内存、网络和磁盘等资源，在短时间内处理大量的请求。那如何衡量“短时间和大量”呢？其实就是两个关键指标：响应时间和每秒事务处理量（TPS）。

那什么是资源的高效利用呢？ 我觉得有两个原则：

1. **减少资源浪费**。比如尽量避免线程阻塞，因为一阻塞就会发生线程上下文切换，就需要耗费CPU资源；再比如网络通信时数据从内核空间拷贝到Java堆内存，需要通过本地内存中转。
2. **当某种资源成为瓶颈时，用另一种资源来换取**。比如缓存和对象池技术就是用内存换CPU；数据压缩后再传输就是用CPU换网络。

Tomcat和Jetty中用到了大量的高性能、高并发的设计，我总结了几点：I/O和线程模型、减少系统调用、池化、零拷贝、高效的并发编程。下面我会详细介绍这些设计，希望你也可以将这些技术用到实际的工作中去。

## I/O和线程模型

I/O模型的本质就是为了缓解CPU和外设之间的速度差。当线程发起I/O请求时，比如读写网络数据，网卡数据还没准备好，这个线程就会被阻塞，让出CPU，也就是说发生了线程切换。而线程切换是无用功，并且线程被阻塞后，它持有内存资源并没有释放，阻塞的线程越多，消耗的内存就越大，因此I/O模型的目标就是尽量减少线程阻塞。Tomcat和Jetty都已经抛弃了传统的同步阻塞I/O，采用了非阻塞I/O或者异步I/O，目的是业务线程不需要阻塞在I/O等待上。
<div><strong>精选留言（22）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg" width="30px"><span>QQ怪</span> 👍（41） 💬（2）<div>@正是那朵玫瑰同学，我认为老师所说的耗费cpu资源指的是线程阻塞和等待进行额外的上下文切换，要理解其，先要知道上下文是什么，具体来说，一个线程被剥夺处理器的使用权而被暂停运行，就是“切出”；一个线程被选中占用处理器开始或者继续运行，就是“切入”。在这种切出切入的过程中，操作系统需要保存和恢复相应的进度信息，这个进度信息就是“上下文”了。至于系统开销具体发生在切换过程中的哪些具体环节，总结如下：
操作系统保存和恢复上下文；
调度器进行线程调度；
处理器高速缓存重新加载；
上下文切换也可能导致整个高速缓存区被冲刷，从而带来时间开销。以上情况过多都会耗费cpu资源，而你看到cpu资源利用率下降了是因为cpu已经做完了上下文切换，把线程的上下文保存到内存或者硬盘上去了，但是当你的线程重新唤醒，其cpu是不是又要多一次不必要的上下文切换?</div>2019-06-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/79/4b/740f91ca.jpg" width="30px"><span>-W.LI-</span> 👍（17） 💬（4）<div>老师好!那就是get请求没有body。使用get请求把参数放url上少一次系统调用?</div>2019-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/6d/8f/81e282e2.jpg" width="30px"><span>802.11</span> 👍（14） 💬（2）<div>standservice这个例子中，虽然没有加在方法上，在方法里面加是解决了粒度的问题，但是加了3次和只在方法上加1次，系统调用层面上哪个更少哪个更多呢</div>2019-06-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/68/d7/714c3d89.jpg" width="30px"><span>不二</span> 👍（10） 💬（1）<div>Acceptor 线程组在等待连接建立的过程中，线程还是会阻塞吧？在跟客户端建立连接的这个阻塞有没有优化的方式</div>2019-07-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/6d/8f/81e282e2.jpg" width="30px"><span>802.11</span> 👍（8） 💬（5）<div>刚才看copyonwrite的相关代码，很多地方用了数组拷贝，想问老师，是不是java api中所有带native关键字的方法都走了系统调用</div>2019-06-29</li><br/><li><img src="" width="30px"><span>ty_young</span> 👍（6） 💬（3）<div>老师，请问tomcat的http body延迟解析只是延迟解析或者不用到不解析，但是http的head和body是同时一次都读到内存的吧，能减少一次系统io调用么</div>2019-07-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/e9/0b/1171ac71.jpg" width="30px"><span>WL</span> 👍（5） 💬（1）<div>老师能不能指点一下在Http11Processor的service()中调用的Http11InputBuffer的parseHeaders()方法是怎么解析header的, 我今天看晕了, 没看懂是怎么将buffer中数据取出解析成header的</div>2019-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/5d/91/a9365c01.jpg" width="30px"><span>锟铻</span> 👍（2） 💬（1）<div>Runtime.exec(&quot;shell&quot;)，这个是不是系统调用</div>2019-07-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f3/08/66541a84.jpg" width="30px"><span>Visual C++</span> 👍（1） 💬（2）<div>Tomcat类加载机制触发的Too many open files问题

如何解决?</div>2019-07-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/1e/3a/5b21c01c.jpg" width="30px"><span>nightmare</span> 👍（7） 💬（0）<div>文件读写，socket网络编程，HeapByteBuffer，JNI都会涉及到系统调用</div>2019-06-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/78/c7/083a3a0b.jpg" width="30px"><span>新世界</span> 👍（3） 💬（0）<div>文件和网络操作会调用系统API导致在内核和用户态切换</div>2019-06-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/08/d1/3c7747ef.jpg" width="30px"><span>Grubby🐑</span> 👍（3） 💬（1）<div>tomcat的startInternal方法，理论上不是应该只有一个线程去调用吗？为什么要加synchronized ？</div>2019-06-29</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI4akcIyIOXB2OqibTe7FF90hwsBicxkjdicUNTMorGeIictdr3OoMxhc20yznmZWwAvQVThKPFWgOyMw/132" width="30px"><span>Chuan</span> 👍（2） 💬（3）<div>老师，您说http header和body是分开读的，那是先从网卡统一读到内核，然后再分开读到用户空间？还是一开始从网卡时就是分开读的？是怎么分别哪些数据是header哪些是body呢？我认为应该是先加载到内核，解析成http报文格式后，再分开读到用户空间的吧？</div>2020-02-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ea/05/c0d8014d.jpg" width="30px"><span>一道阳光</span> 👍（1） 💬（0）<div>网络编程socket,输入输出流，创建线程thread,这些属于吧。</div>2019-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/fe/c5/3467cf94.jpg" width="30px"><span>正是那朵玫瑰</span> 👍（1） 💬（1）<div>老师有点疑问：
1、线程阻塞或者等待会发生上下文切换，耗费cpu资源，线程阻塞或者等待不是会让出cpu吗，应该是浪费cpu资源才对啊？我在压测的时候发现当有大量的线程在await状态时，cpu的利用率立马下降，应该是浪费cpu资源的！老师说会耗费cpu资源 怎么理解呢？
2、无锁固然是好的、但是无限重试是不是也会耗掉cpu资源，因为很多时候重试都是无用功！</div>2019-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c5/6a/7f858f1f.jpg" width="30px"><span>白不吃</span> 👍（0） 💬（0）<div>学以致用啊</div>2022-02-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/1d/cd/3819726f.jpg" width="30px"><span>徐同学呀</span> 👍（0） 💬（0）<div>经查看Tomcat10.0.6源码，首先http协议在网络中是以文本格式传输的，其次如果文本比较大，会分多次传输，可能会发送粘包和半包问题，但是http协议有一定的格式，先请求行，再请求头，空行，最后是请求体，就根据这个格式，来一步步分割出请求行、请求头、请求体，以字节数组ASCII码存储到jvm内存，后面有使用到某个部位就转换成字符串，这个过程是比较消耗资源，所以延迟解析应该说的是：从字节ASCII码转为字符串的过程是延迟的。推荐本人写的Tomcat源码博客，请持续关注：https:&#47;&#47;stefan.blog.csdn.net&#47;article&#47;details&#47;119549767</div>2021-08-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/83/c8/5ce842f6.jpg" width="30px"><span>maybe</span> 👍（0） 💬（0）<div>tomcat和jetty如何提高性能：1、使用非阻塞或异步io。2、减少或避免系统调用3、高效并发编程，使用多线程、尽量使用无锁方式、缩小锁范围、使用原自变量cas、使用并发容器4、使用池化技术，减少频繁对象创建和销毁开销</div>2020-08-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/f7/88/da243c77.jpg" width="30px"><span>大魔王</span> 👍（0） 💬（2）<div>老师，apache tomcat 既然可以异步非阻塞了，那为什么在大并发下还是不如nginx强？网上说tomcat 是一个请求就创建一个进程是这样吗？</div>2020-01-04</li><br/><li><img src="" width="30px"><span>ty_young</span> 👍（0） 💬（0）<div>老师，tomcat的io和线程模型跟netty的是不是很像</div>2019-12-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/8f/eb/0a7ba382.jpg" width="30px"><span>不想输，就别懒</span> 👍（0） 💬（0）<div>比如可以用细粒度的对象锁或者低强度的读写锁:对于这个问题，我想问下老师，如何从维度更好的把控它？需要多考虑哪些方面？</div>2019-12-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f3/08/66541a84.jpg" width="30px"><span>Visual C++</span> 👍（0） 💬（0）<div>有其它优化方式吗</div>2019-07-07</li><br/>
</ul>