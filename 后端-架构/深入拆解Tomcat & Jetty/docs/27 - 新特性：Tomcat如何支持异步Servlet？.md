通过专栏前面的学习我们知道，当一个新的请求到达时，Tomcat和Jetty会从线程池里拿出一个线程来处理请求，这个线程会调用你的Web应用，Web应用在处理请求的过程中，Tomcat线程会一直阻塞，直到Web应用处理完毕才能再输出响应，最后Tomcat才回收这个线程。

我们来思考这样一个问题，假如你的Web应用需要较长的时间来处理请求（比如数据库查询或者等待下游的服务调用返回），那么Tomcat线程一直不回收，会占用系统资源，在极端情况下会导致“线程饥饿”，也就是说Tomcat和Jetty没有更多的线程来处理新的请求。

那该如何解决这个问题呢？方案是Servlet 3.0中引入的异步Servlet。主要是在Web应用里启动一个单独的线程来执行这些比较耗时的请求，而Tomcat线程立即返回，不再等待Web应用将请求处理完，这样Tomcat线程可以立即被回收到线程池，用来响应其他请求，降低了系统的资源消耗，同时还能提高系统的吞吐量。

今天我们就来学习一下如何开发一个异步Servlet，以及异步Servlet的工作原理，也就是Tomcat是如何支持异步Servlet的，让你彻底理解它的来龙去脉。

## 异步Servlet示例
<div><strong>精选留言（18）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/7d/da/780f149e.jpg" width="30px"><span>echo＿陈</span> 👍（26） 💬（6）<div>我感觉，异步servlet只能说让tomcat有机会接受更多的请求，但并不能提升服务的并发吞吐量，因为如果业务操作本身还是慢的话，业务线程池仍然会被占满，后面提交的任务会等待。</div>2019-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/68/d5/567bf8ad.jpg" width="30px"><span>非想</span> 👍（15） 💬（1）<div>老师您好，请问下怎么理解tomcat线程和servlet线程，它们有什么区别，又是怎么关联的呢？</div>2019-07-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5c/c5/1231d633.jpg" width="30px"><span>梁中华</span> 👍（10） 💬（1）<div>异步sevlet内部的业务应用中的IO也需要异步IO支持吧，就像vertx的异步模式，否则都堵塞在业务线程上就没意义了</div>2019-07-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/04/0d/3dc5683a.jpg" width="30px"><span>柯察金</span> 👍（5） 💬（2）<div>老师，开启了异步，感觉还是不够啊。有大量请求的时候，socket 链接都有问题。有什么进一步提升的方法吗</div>2019-07-24</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoRiaKX0ulEibbbwM4xhjyMeza0Pyp7KO1mqvfJceiaM6ZNtGpXJibI6P2qHGwBP9GKwOt9LgHicHflBXw/132" width="30px"><span>Geek_ebda96</span> 👍（4） 💬（2）<div> 老师，请问一个请求进来之后，如果采用异步servlet来处理，原来的请求tomcat线程被回收，那本身这个请求要再相应给客户端，怎么知道是哪个客户端请求过来的，是根据servlet力的request信息，获取客户端地址，相应给客户端吗？这个根你后面讲的complete有关系吗，具体是怎么相应给正确的目的地客户端？</div>2019-07-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/a5/51/7773d421.jpg" width="30px"><span>FengX</span> 👍（0） 💬（1）<div>老师， 请问对Map&lt;S,Processor&gt; connections里的Processor的取出操作是在SocketWrapper的processSocket 方法里吗？</div>2019-07-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ba/80/2b427c9c.jpg" width="30px"><span>libocz</span> 👍（3） 💬（0）<div>老师，文章里边说ctx.complete方法不能直接把响应数据发送到浏览器，因为这件事情应该由Tomcat线程来做。这个是为什么呢？在应用线程里边的reponse直接调用write把数据写到输出流然后刷新这样不行吗？</div>2020-08-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/17/ba/c56aa720.jpg" width="30px"><span>new life</span> 👍（2） 💬（1）<div>感觉 异步 servlet 只是释放了一个连接器分配的线程，并没有立刻给web响应，在web上感受到的还是同步，老师 我的理解对吗</div>2019-08-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/63/85/1dc41622.jpg" width="30px"><span>姑射仙人</span> 👍（1） 💬（0）<div>老师，LongPolling的实现与Servlet异步支持有什么关系吗，还有Spring中的DeferredResult。</div>2021-04-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/07/d2/0d7ee298.jpg" width="30px"><span>惘 闻</span> 👍（1） 💬（2）<div>看晕了... SocketProcessor 到底在一个异步请求中创建了多少个啊.
1. 我们知道，连接器中的 Endpoint 组件检测到有请求数据达到时，会创建一个 SocketProcessor 对象交给线程池去处理
2. 在异步 Servlet 的场景里，Web 应用通过调用ctx.complete方法时，也可以生成一个新的 SocketProcessor 任务类，交给线程池处理。
3.而 SocketWrapper 的 processSocket 方法会创建 SocketProcessor 任务类
这是三句原话..所以是一个请求+响应一共使用了三个SocketProcessor 吗?</div>2021-01-26</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoeNMibYsgHBsbhIwf9YR4Shy6psfqiblneVHA5CYrBRoqJwkw1ZUbVAPRGAfFfWjia7MZlDZzddeE2w/132" width="30px"><span>wfatec</span> 👍（1） 💬（0）<div>老师您好，我这里有一个疑惑，对于异步 servlet 来说，如果我在 filter 中执行 chain.doFilter() 之后，还需要执行 methodAfterChain() 方法，由于 servlet 是异步的，那么这个时候 methodAfterChain() 方法会等到这个异步 servlet 执行完 complete() 之后才执行，还是会立即执行呢？如果是立即执行，那么应该如何实现对返回结果的包装呢？如果不是立即执行，那原理是什么呢？</div>2019-08-16</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/AkA08CQYiaIFu6QMAvun9ibyick8qv9bkO8rIQD0MIe6qq2mhLoibuM4WNJ9DBFYvmvnxgNRfPWKiaNiaIeBw6m2tTicA/132" width="30px"><span>Geek_103c22</span> 👍（0） 💬（0）<div>异步servlet 和ajax 请求是一回事吗？</div>2024-09-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ca/07/22dd76bf.jpg" width="30px"><span>kobe</span> 👍（0） 💬（0）<div>这个调用Request对象的startAsync()方法应该是Tomcat调用的 而不是Web应用程序调用的吧？
</div>2022-08-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0c/86/8e52afb8.jpg" width="30px"><span>花花大脸猫</span> 👍（0） 💬（0）<div>这个异步的servlet只是缓解了tomcat的connection压力，对于整个应用来说这样处理问题会更大，因为对于长时间处理的业务会不断创建线程去处理，当然也可以使用线程池去处理，对于整个服务而言，感觉有点画蛇添足！！</div>2022-07-06</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/rMgAbbKiasa1qR35ht0GEfwsHXbusPZAe9JFgicDgVRy8vQET2hypuDgwtHoPVU23RUoMdK7qA7gibMlTExpYibtbw/132" width="30px"><span>YsnowLove</span> 👍（0） 💬（0）<div>1. 当一个新的请求到达时，Tomcat 和 Jetty 会从线程池里拿出一个线程来处理请求，这个线程会调用你的 Web 应用，Web 应用在处理请求的过程中，Tomcat 线程会一直阻塞，直到 Web 应用处理完毕才能再输出响应，最后 Tomcat 才回收这个线程。
2. Servlet 3.0 中引入的异步 Servlet。主要是在 Web 应用里启动一个单独的线程来执行这些比较耗时的请求，而 Tomcat 线程立即返回，不再等待 Web 应用将请求处理完....
老师：按我的理解，无论是异步还是同步，web应用都是独立一个线程处理。区别是异步，tomcat会回收线程。 这样理解对吗？  </div>2020-07-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/47/39/0ce1aa62.jpg" width="30px"><span>罗洲</span> 👍（0） 💬（2）<div>“请你注意 createSocketProcessor 函数的第二个参数是 SocketEvent，这里我们传入的是 OPEN_READ。通过这个参数，我们就能控制 SocketProcessor 的行为”,请问这里是如何通过OPEN_READ来控制的呢？</div>2019-10-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/a1/46/3136ac25.jpg" width="30px"><span>是男人就开巴巴托斯</span> 👍（0） 💬（0）<div>印象中有个典型应用  spring的sockjs handler
通过异步sevlet向client主动推心跳</div>2019-09-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/1e/3a/5b21c01c.jpg" width="30px"><span>nightmare</span> 👍（0） 💬（0）<div>异步servlet相当于用户控制开启和完成，在protohandler通过类似future的机制来完成异步操作</div>2019-07-11</li><br/>
</ul>