我们知道，Servlet容器最重要的任务就是创建Servlet的实例并且调用Servlet，在前面两期我谈到了Tomcat如何定义自己的类加载器来加载Servlet，但加载Servlet的类不等于创建Servlet的实例，类加载只是第一步，类加载好了才能创建类的实例，也就是说Tomcat先加载Servlet的类，然后在Java堆上创建了一个Servlet实例。

一个Web应用里往往有多个Servlet，而在Tomcat中一个Web应用对应一个Context容器，也就是说一个Context容器需要管理多个Servlet实例。但Context容器并不直接持有Servlet实例，而是通过子容器Wrapper来管理Servlet，你可以把Wrapper容器看作是Servlet的包装。

那为什么需要Wrapper呢？Context容器直接维护一个Servlet数组不就行了吗？这是因为Servlet不仅仅是一个类实例，它还有相关的配置信息，比如它的URL映射、它的初始化参数，因此设计出了一个包装器，把Servlet本身和它相关的数据包起来，没错，这就是面向对象的思想。

那管理好Servlet就完事大吉了吗？别忘了Servlet还有两个兄弟：Listener和Filter，它们也是Servlet规范中的重要成员，因此Tomcat也需要创建它们的实例，也需要在合适的时机去调用它们的方法。
<div><strong>精选留言（19）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/79/4b/740f91ca.jpg" width="30px"><span>-W.LI-</span> 👍（32） 💬（2）<div>属性值变化listener能动态配置，所以用CopyOnWriteArray。生命周期事件listener，不能动态改变没有线程安全问题?
</div>2019-07-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/64/86/f5a9403a.jpg" width="30px"><span>yang</span> 👍（9） 💬（3）<div>啊啊啊 老师再写一个深入拆解spring 或者springboot 的专栏吧 和tomcat形成兄弟专栏 定价比这个贵2～3倍 您负责写 我们和极客时间的平台负责大卖</div>2019-08-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4e/1b/f4b786b9.jpg" width="30px"><span>飞翔</span> 👍（6） 💬（1）<div>老师我需要手动加一个filter，不能用annotation或是xml、我是不是需要调用standardcontext里边的addfilterdef和addfiltermap这两个函数就行了？</div>2019-07-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/f7/ee/6eeb58a3.jpg" width="30px"><span>calljson</span> 👍（5） 💬（1）<div>请教下老师，serverlet的service方法作用是什么？仅仅是分发请求吗？</div>2019-07-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/f8/ca/1a1e190a.jpg" width="30px"><span>Nu11PointerEx</span> 👍（4） 💬（1）<div>老师我想问一下，对应的filter是怎么注册到servlet中去的</div>2019-07-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/68/d5/567bf8ad.jpg" width="30px"><span>非想</span> 👍（4） 💬（5）<div>老师您好，看你的文章servlet容器中的三个组件servlet，filter，linstener都是由context容器管理的对吗？</div>2019-07-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4e/1b/f4b786b9.jpg" width="30px"><span>飞翔</span> 👍（2） 💬（1）<div>private Map&lt;String, FilterDef&gt; filterDefs = new HashMap&lt;&gt;();
老师 您说 filter放在map里边，由context管理，然后我看 您后边永硕 filter是wrapper管理的 这个不是矛盾嘛</div>2019-07-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4e/1b/f4b786b9.jpg" width="30px"><span>飞翔</span> 👍（2） 💬（1）<div>话说 host engine 和context 都有pipline实现的责任链，wrapper没有pipline 而是用filter 实现的责任链是吧</div>2019-07-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/16/5b/83a35681.jpg" width="30px"><span>Monday</span> 👍（3） 💬（0）<div>思考题两种数据结构我能区分开来，但是还是回答不上来。。。</div>2019-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/1e/3a/5b21c01c.jpg" width="30px"><span>nightmare</span> 👍（2） 💬（0）<div>生命周期相关的类比如session一个用户分配一个，用完了就会销毁，用对象数组，可以适应增删改操作，而属性变化，写不会那么频繁，读取比较频繁</div>2019-07-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2b/7b/a0/791d0f5e.jpg" width="30px"><span>翁文彬</span> 👍（1） 💬（0）<div>最后一个问题, 一开始两种Listener都是使用Object[]装着的,
我去翻了一下github的提交记录, Sep 15, 2015, @markt-asf提交了一次修改, 将applicationEventListenersList改成了CopyOnWriteArrayList

原因是下面这个Bug, https:&#47;&#47;bz.apache.org&#47;bugzilla&#47;show_bug.cgi?id=58373, 贴上来以供大家参考

ApplicationContext#addListener方法中也有修改applicationLifecycleListenersObjects的代码, 所以我认为&quot;生命周期事件listener不能动态改变&quot;是错误的, 这里修改成CopyOnWriteArrayList或许更好?</div>2023-02-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/05/7f/a7df049a.jpg" width="30px"><span>Standly</span> 👍（1） 💬（0）<div>反向推导猜下，生命状态变化都在单线程中，没有并发问题。属性变化有线程安全问题，但又不频繁。</div>2019-07-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/51/0d/fc1652fe.jpg" width="30px"><span>James</span> 👍（0） 💬（0）<div>问答题的数据结构能区分。。但是最终答案是什么？</div>2021-03-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/99/d7/dd21d6e4.jpg" width="30px"><span>pj</span> 👍（0） 💬（3）<div>FilterChain执行完毕，所有的filter执行完以后才执行service方法，而真正的response在service返回后才能拿到。filter没有起到过滤response的作用啊。没有想明白。</div>2020-06-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/db/26/54f2c164.jpg" width="30px"><span>靠人品去赢</span> 👍（0） 💬（0）<div>想问一下Tomcat会给每一个请求都生成一个Filter链，比如说很多请求的Filter链都差不多，Tomcat会不会对这些一样的链有一个处理，还是一个请求一条链调用完Servlet就把这个链上的Filter都释放掉？</div>2019-11-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/c5/f2/fccf87bb.jpg" width="30px"><span>石妖</span> 👍（0） 💬（1）<div>李老师好，有个问题不太明白：每个Filter的doFilter调用Filter链的doFilter方法，那么这个调用是如何保证调用按照Filter链的顺序调用的？</div>2019-10-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/24/5d/65e61dcb.jpg" width="30px"><span>学无涯</span> 👍（0） 💬（1）<div>这里感觉Filter是递归调用呀，网上为什么说是基于函数回调呢</div>2019-08-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ee/ea/c8136dfd.jpg" width="30px"><span>草戊</span> 👍（0） 💬（1）<div>filter是有wrapper管理的？servlet吧，是不是手误回答错了？</div>2019-07-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/b3/c5/7fc124e2.jpg" width="30px"><span>Liam</span> 👍（0） 💬（0）<div>我记得pip-val是用单向链表实现的，filters chain是用数组实现的；另外，pipe节点自己负责调用下一个节点，而filter则是委派chain来调度</div>2019-07-09</li><br/>
</ul>