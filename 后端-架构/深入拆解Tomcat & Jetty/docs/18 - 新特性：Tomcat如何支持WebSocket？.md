我们知道HTTP协议是“请求-响应”模式，浏览器必须先发请求给服务器，服务器才会响应这个请求。也就是说，服务器不会主动发送数据给浏览器。

对于实时性要求比较的高的应用，比如在线游戏、股票基金实时报价和在线协同编辑等，浏览器需要实时显示服务器上最新的数据，因此出现了Ajax和Comet技术。Ajax本质上还是轮询，而Comet是在HTTP长连接的基础上做了一些hack，但是它们的实时性不高，另外频繁的请求会给服务器带来压力，也会浪费网络流量和带宽。于是HTML5推出了WebSocket标准，使得浏览器和服务器之间任何一方都可以主动发消息给对方，这样服务器有新数据时可以主动推送给浏览器。

今天我会介绍WebSocket的工作原理，以及作为服务器端的Tomcat是如何支持WebSocket的。更重要的是，希望你在学完之后可以灵活地选用WebSocket技术来解决实际工作中的问题。

## WebSocket工作原理

WebSocket的名字里带有Socket，那Socket是什么呢？网络上的两个程序通过一个双向链路进行通信，这个双向链路的一端称为一个Socket。一个Socket对应一个IP地址和端口号，应用程序通常通过Socket向网络发出请求或者应答网络请求。Socket不是协议，它其实是对TCP/IP协议层抽象出来的API。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/ca/bd/a51ae4b2.jpg" width="30px"><span>吃饭饭</span> 👍（26） 💬（1）<div>为了跟现有的 HTTP 协议保持兼容，它通过 HTTP 协议进行一次握手，这里不应该是三次握手吗老师？不太明白这里，求讲解</div>2019-06-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg" width="30px"><span>QQ怪</span> 👍（11） 💬（1）<div>之前做过相关websocket服务的相关设计，只要把登陆对象用户标识作为key，websocketsessionid作为value缓存成map集合，通过key找到websocketsessionId发送即可，利用的是spring websocket，但我有一点不太清楚的是：我听说单机tomcat能容纳5万客户端，我不知道为啥会是这个数，为啥不是更多呢？我在开发过程中其实压根就没到过这么大，我想知道是什么因素影响着最大容量数？还有就是想问websocket会不会存在并发问题？希望老师能够解答我的困惑，感谢！！！</div>2019-06-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/e9/0b/1171ac71.jpg" width="30px"><span>WL</span> 👍（9） 💬（1）<div>老师能否讲一下tomcat在https中如何实现与客户端协商密钥的, 我感觉这个过程比较复杂, 涉及到两边的交互比较多,还有TrustManager的机制也没太看懂.</div>2019-06-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/b3/c5/7fc124e2.jpg" width="30px"><span>Liam</span> 👍（5） 💬（1）<div>维护一个全局用户连接字典，建立连接时，将用户连接加入字典，发送消息时，从字典获取特定用户的连接并发送 ？</div>2019-06-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c3/83/aa81c112.jpg" width="30px"><span>andy</span> 👍（1） 💬（1）<div>老师您好，我有个tomcat spring mvc应用，需要提供一个接口供socket连接，我可以直接在应用服务层用netty编写一个监听端口来实现吗</div>2019-06-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/f3/13/fe73007f.jpg" width="30px"><span>小满爹</span> 👍（1） 💬（1）<div>老师，请问下对于插拔网线导致连接断开，websocket的服务端或客户端，可以监听到这个事件吗？是不是还需要程序做一些补偿机制？</div>2019-06-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/83/b3/45e71a7c.jpg" width="30px"><span>Focused</span> 👍（1） 💬（2）<div>老师，一直不太理解注解的作用及原理，在网上查到注解的目的是标识源代码元素的元数据，是否是源码中通过反射检测到注解后，实现了此注解的实际动作？如何查看此注解的实际动作呢？（描述有点乱，见谅）</div>2019-06-20</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/IgjIXs9jjpODTPaOLrms0XOhJ8pxMcaZgtgBrPG6deqsKXv1sPIqkg0faL6X0rtFicJn5Wf7QXTickjYWpmF0V8A/132" width="30px"><span>Geek_28b75e</span> 👍（0） 💬（1）<div>老师，测试环境遇到一个问题，本项目使用springcloud，网管使用zuul。我在网关路由之前的过滤器添加了一个请求头，添加之后对于一般接口的路由转发是正常的，其中对于文件上传接口，我断点查看，需要好几秒才转发过去，并且报异常，org.apache.tomcat.util.http.fileupload.FileUploadException: Unexpected EOF read on the socket] with root cause 
java.io.EOFException: Unexpected EOF read on the socket
去掉那个请求头又是正常的，麻烦老师给解惑一下</div>2019-06-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/14/98/0251b8fd.jpg" width="30px"><span>Cy190622</span> 👍（0） 💬（1）<div>老师，晚上好。
请教一下，
1.每节都有课后思考题，老师能否在下一节安排解答一下，或者是安排统一的解答章节嘛？
2.netty现在使用很流行。常用在生产上，咱们的课程是否会安排一节，讲一下；如果没有安排的，老师有没有推荐的书籍或者帖子。</div>2019-06-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ac/46/7e24bad6.jpg" width="30px"><span>杨俊</span> 👍（0） 💬（1）<div>tomcat nodejs在websocket性能上哪个好呢</div>2019-06-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ac/ef/494f56c3.jpg" width="30px"><span>crazypokerk</span> 👍（0） 💬（1）<div>请问下老师，WebSocket和Servlet容器中处理请求的Servlet算是同一等级的组件吗？</div>2019-06-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/05/7f/a7df049a.jpg" width="30px"><span>Standly</span> 👍（19） 💬（0）<div>希望下一本能出《深入拆解netty》😄</div>2019-06-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/3b/ad/31193b83.jpg" width="30px"><span>孙志强</span> 👍（3） 💬（2）<div>如果服务端的websocket服务在多个tomcat里都有，有什么好的办法可以共享建立的session对象。</div>2020-04-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/fa/84/f01d203a.jpg" width="30px"><span>Simple life</span> 👍（1） 💬（0）<div>这个比较复杂了，如果是多机情况下，就涉及到session管理，就要把session抽取出来，涉及到服务注册发布，session路由，消息发布机制等</div>2020-08-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/79/4b/740f91ca.jpg" width="30px"><span>-W.LI-</span> 👍（1） 💬（2）<div>老师好!我有个问题可能有点蠢。spring对websocket有支持，还有STOMP这种。文中说websocket不是运行在severlet容器上的。spring上下文不是servlet容易下的一个子容器么？没有servlet容器的话，这个spring上下文注册去哪了啊?</div>2019-06-23</li><br/><li><img src="" width="30px"><span>Geek_9d8c59</span> 👍（1） 💬（1）<div>java版本的websocket客户端，websocket如果是分frame传输，不在意数据大小，为什么我把图片转换成base64，使用同步发送方法，会触发连接关闭。而把session的string消息类型的缓冲区设置的足够大之后，问题才消失。而后面在我加入了心跳包，重连机制后，当重连次数多了，为什么有时服务端会有大量tcp处于close-wait状态，然后日志开始报java heap内存不足的错误</div>2019-06-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/7d/ec/ccd30c1d.jpg" width="30px"><span>WangBo</span> 👍（0） 💬（0）<div>想了解一下，Tomcat在设计Endpoint时，为什么会设计为 多实例的模型？为每一个客户端维持一个实例？为什么不设计为单例模型呢？
我理解Session是socket、clinet等信息的封装，是需要设计为多实例的。但Endpoint设计为多实例明显存在多耗费资源等情况。</div>2022-11-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/88/ec/9229419d.jpg" width="30px"><span>.</span> 👍（0） 💬（1）<div>Tomcat 将 HTTP 协议升级成 WebSocket 协议之后，这个Web服务就不再能处理http请求了吧？因为应用层协议已经不再是http了，也就是说同一个web服务不能同时支持http和websocket通信吧？</div>2022-07-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/01/b9/73435279.jpg" width="30px"><span>学习学个屁</span> 👍（0） 💬（0）<div>项目中有用到了，也是定义一个copyonwirtelist 保存建立连接的客户端session 然后指定推送订单信息。</div>2022-05-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/ee/f0/f2577e45.jpg" width="30px"><span>额。</span> 👍（0） 💬（0）<div>课后练习
1: 单机情况，很简单，直接一个数据结构存所有的session，找到session进行发送
2:多机情况，这里需要根据路由算法找到指定的机器，再由机器发送消息到用户。这里是否要存所有的session是值得讨论的</div>2022-03-01</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqWrmRibkib0s3icDlq8IFNXIpb993TNttmmjmCciaGWXISy2xIf8ZDFFn1LsAwDzorNIZeE8lG1T1oNA/132" width="30px"><span>Jasper</span> 👍（0） 💬（0）<div>老师，怎么理解spring的websocket连接数远不如netty的websocket连接数呀？不是很理解上面说的websocket屏蔽了I&#47;O模型细节，但是netty正是由于使用了多路复用I&#47;O模型才得以支持更多的连接数，这不是相矛盾了么？</div>2022-02-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/83/c8/5ce842f6.jpg" width="30px"><span>maybe</span> 👍（0） 💬（1）<div>课后思考题：通过nickname匹配相应的session然后发送即可</div>2020-08-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/83/c8/5ce842f6.jpg" width="30px"><span>maybe</span> 👍（0） 💬（0）<div>1、websocket和http一样是一个应用层协议。为了和http协议保持兼容，它通过http协议进行一次握手、握手之后数据就直接通过Tcp层的socket传输，就和http无关了。浏览器发给服务端请求头会带上跟websocket相关的请求头，比如Conection：upgrade 和upgrade：websocket。服务端如果也支持websocket就在响应头中加上websocket相关的头Conection：upgrade 和upgrade：websocket。这样websoket连接就建立好了，接着数据传输通过frame形式传输，将一条消息分为多个frame，按照先后顺序发送。这样大数据就可以分片传输，不用考虑数据大小问题。和http的chunk一样可以边生成数据边传输，提升效率。
2、tomcat如何支持websocket的呢？首先理解java的websocket规范。java websocket应用由一系列websocket Endpoint组成，endpoint是一个java对象，代表websocket的一端，就像http请求的servlet一样，你可以把它看成处理websocket消息的接口。和servlet不同的地方在于，tomcat会给每个websocket连接创建一个endpoint对象。
	如何定义endpoint呢？可以通过继承javax.websocket.Endpoint类并实现它的onOpen、onColse、onError生命周期方法，tomcat会负责调用。当浏览器连接到一个endpoint的时候，tomcat会给这个endpoint创建一个session（握手成功后创建的）并在关闭连接是销毁。这个session是对socket的封装，endpoint通过它与浏览器通信。
	第二种通过注解形式声明，和继承方式差不多，都需要实现声明周期方法。那么tomcat如何加载这些endpoint的呢？tomcat通过sci（ServletContainerInitializer），是servlet 3.0规范中定义的用来接收web应用启动事件的接口。tomcat启动阶段就扫描ServerEndpoint.class、ServerApplicationConfig.class和Endpoint.class类，并把这些来传递给WsSci的OnStar方法，最终构造一个WebSocketContainer实例，WebSocketContainer是用来处理websocket的endpoint容器，这个容器维护了url和endpoint对应关系，这样就能通过url找到响应的endpoint进行处理。
3、tomcat处理websoket请求：当一个websocket请求到达的时候，tomcat将http协议升级为websocket协议，并将socket连接processor替换为upgradeprocessor，这个socket不会立即关闭，对于接下来的请求，tomcat通过upgradeprocessor直接调用相应的endpoint处理。
</div>2020-08-06</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/oJiao7ZSm1eicvM61PaIYqTF3qz0b00Wiciag5iaP2JD1AUx8Xg0ABavbbOPbxXeL2Veep8Tr6AoAXSqLnZybeicjILQ/132" width="30px"><span>我在线</span> 👍（0） 💬（0）<div>请问老师，是不是一个链接就要一直开启一起线程为之服务，还是有一个线程池，有事件来了就从线程池里面拿一个线程来处理</div>2020-07-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/5b/69/15237720.jpg" width="30px"><span>空白格</span> 👍（0） 💬（0）<div>老师的课程很精彩，之前的我只会打个war包放到Tomcat里面然后启动Tomcat。不知道Tomcat是怎么处理与运作的。看了老师的课程，对Tomcat的了解更深了，也阅读了源码 对于ThreadPoolExecutor 还有Queue的扩展都有了新的认知，太感谢老师了！！</div>2020-05-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/dc/c3/e4ba51d5.jpg" width="30px"><span>Flash</span> 👍（0） 💬（0）<div>老师，websocket这个聊天室的例子可以出一个完整的示例代码吗？</div>2020-03-13</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI4akcIyIOXB2OqibTe7FF90hwsBicxkjdicUNTMorGeIictdr3OoMxhc20yznmZWwAvQVThKPFWgOyMw/132" width="30px"><span>Chuan</span> 👍（0） 💬（0）<div>老师，请问下在tomcat哪里能找到websocket相关的实现，我只在jdk 11的net包下看到了一些实现，tomcat是怎么用的？我在tomcat中只找到一个UpgradeProtocol接口，但是只有http2Protocol这一个实现，同理也没有找到和websocket相关的UpgradeProcessor，我用的是tomcat-embeded 9.0.21，忘老师指点一下具体tomcat具体实现类是哪些，谢谢！</div>2020-02-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/fa/7c/f8f38ad0.jpg" width="30px"><span>可爱的小奶狗</span> 👍（0） 💬（0）<div>老师，客户端websocket是怎么保持长连接的？是通过心跳机制(比如每隔60s，客户端向服务器发送一个报文，然后服务端就保持连接，否则就断开连接)吗？</div>2019-12-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/8a/76/4abc8ac1.jpg" width="30px"><span>完美世界</span> 👍（0） 💬（0）<div>特别的用户，需要知道用户和IP的映射关系吧。</div>2019-09-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/21/20/1299e137.jpg" width="30px"><span>秋天</span> 👍（0） 💬（0）<div>向特定的用户发送消息 就在 endpoint 这段持有一个对应用户的一个 map结构，这样可以对于自己关心的用户就可以直接发送消息了</div>2019-07-23</li><br/>
</ul>