在面试时我们可能经常被问到：你做的XX项目的架构是如何设计的，请讲一下实现的思路。对于面试官来说，可以通过你对复杂系统设计的理解，了解你的技术水平以及处理复杂问题的思路。

今天咱们就来一步一步分析Tomcat的设计思路，看看Tomcat的设计者们当时是怎么回答这个问题的。一方面我们可以学到Tomcat的总体架构，学会从宏观上怎么去设计一个复杂系统，怎么设计顶层模块，以及模块之间的关系；另一方面也为我们深入学习Tomcat的工作原理打下基础。

## Tomcat总体架构

我们知道如果要设计一个系统，首先是要了解需求。通过专栏前面的文章，我们已经了解了Tomcat要实现2个核心功能：

- 处理Socket连接，负责网络字节流与Request和Response对象的转化。
- 加载和管理Servlet，以及具体处理Request请求。

**因此Tomcat设计了两个核心组件连接器（Connector）和容器（Container）来分别做这两件事情。连接器负责对外交流，容器负责内部处理。**

所以连接器和容器可以说是Tomcat架构里最重要的两部分，需要你花些精力理解清楚。这两部分内容我会分成两期，今天我来分析连接器是如何设计的，下一期我会介绍容器的设计。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/75/a8/dfe4cade.jpg" width="30px"><span>电光火石</span> 👍（173） 💬（9）<div>对Tomcat的结构有个清晰的了解，其中有两个问题：
1. PorotocolHandler的继承关系是不是太重了，看起来像典型的多维度扩展，nio2在apj和1HTTP11都要做一遍，用组合会不会更好
2. 为什么要多一层adapter，在processor直接转换为容器的servletrequest和servletresponse不是更好，为什么要先转化Tomcat的request和response，再用adapter做一层转换消耗性能？
谢谢了！</div>2019-05-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/67/8a/babd74dc.jpg" width="30px"><span>锦</span> 👍（115） 💬（12）<div>两个问题请教一下老师
第一，如何debug源码呢？
第二，tomcat和netty有什么区别呢？为什么netty常常用做底层通讯模块，而tomcat作为web容器呢？</div>2019-05-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/96/d9/a252585b.jpg" width="30px"><span>喆</span> 👍（63） 💬（3）<div>“EndPoint 是通信端点，即通信监听的接口，是具体的 Socket 接收和发送处理器，是对传输层的抽象，因此 EndPoint 是用来实现 TCP&#47;IP 协议的。”，【EndPoint是用来实现TCP&#47;IP协议的】这个没有太明白，据我有限的知识所知，TCP&#47;IP协议是【由操作系统实现】的，而socket只是在TCP&#47;IP之上展现给用户层的一个接口，而EndPoint又用到了socket接口（我瞎猜的）。所以，我是否可以把这句话理解为，EndPoint利用Socket接口来将底层传来的数据转化成为HTTP格式的数据，这种行为就可以看作是对TCP&#47;IP协议的一种间接实现。</div>2019-05-22</li><br/><li><img src="" width="30px"><span>ty_young</span> 👍（49） 💬（3）<div>老师，我看您说socket = endpoint.serverSocketAccept()这个是阻塞式accept;但是连接器使用的IO模型是NIO或者AIO啊，都是非阻塞的吧，只是同步或者非同步的区别吧</div>2019-06-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/37/8e/cf0b4575.jpg" width="30px"><span>郑晨Cc</span> 👍（45） 💬（3）<div>老师有个问题想请教： tomcat既然已经使用了java的nio模型 而nio模型在linx上是基于epoll 实现的 那为什么和同样的使用epoll的nginx相比 他对于http请求处理的性能远不如nginx呢</div>2019-05-31</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK4biaeBuuqvR3SB4H8atcmreszjIPRZgNeVXFMMPbVZht7yqx01PE0CJPOmyL4jLAiaCdib9lAkPpjw/132" width="30px"><span>zhycareer</span> 👍（31） 💬（3）<div>老师，源码如何阅读效果好啊？现在源码一大堆，不知从何下手。谢谢</div>2019-05-21</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqLcWH3mSPmhjrs1aGL4b3TqI7xDqWWibM4nYFrRlp0z7FNSWaJz0mqovrgIA7ibmrPt8zRScSfRaqQ/132" width="30px"><span>易儿易</span> 👍（24） 💬（1）<div>这个专栏期待已久，一出立马就订阅了，但是因为其他课程没结束，导致这个课程没有跟上老师的节奏，目前正在努力追赶，我订阅了不少课程，李号双老师是回答问题最详细最用心的一个没有之一，虽然我还没来得及提一个问题，但是已经从老师给其他学生的回复中学习了不少……给老师点赞!!!</div>2019-06-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c5/e6/50c5b805.jpg" width="30px"><span>欠债太多</span> 👍（24） 💬（1）<div>io是盲区啊，老师有什么建议呢</div>2019-05-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/fe/7c/626f3351.jpg" width="30px"><span>鱼乐</span> 👍（20） 💬（3）<div>老师，有个问题，根据网络协议分层模型，请求不应该是先经过Http协议，然后才经过TCP协议处理的吗，上面的图处理顺序感觉反了</div>2019-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/24/5d/65e61dcb.jpg" width="30px"><span>学无涯</span> 👍（19） 💬（3）<div>一个service对应tomcat中部署的一个项目，一个连接器对应一个请求，这样理解对吗</div>2019-05-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/f6/26/bfd6d48a.jpg" width="30px"><span>面白i小黄毛</span> 👍（14） 💬（4）<div>老师您好，&quot;通过在 Tomcat 中配置多个 Service，可以实现通过不同的端口号来访问同一台机器上部署的不同应用。&quot;这句话应该怎样理解？如果仅仅针对http来说的话，同一个tomcat可以设置多个端口号来启动多个应用吗？</div>2019-05-27</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoRiaKX0ulEibbbwM4xhjyMeza0Pyp7KO1mqvfJceiaM6ZNtGpXJibI6P2qHGwBP9GKwOt9LgHicHflBXw/132" width="30px"><span>Geek_ebda96</span> 👍（14） 💬（1）<div>老师请教两个问题
1.应用层的i&#47;o模型和http1，ajp等协议是指在endpoint接受网络请求后，对请求内容解析才会用到吧，就是在processor里面，这里面就是根据请求的协议类型，采用指定i&#47;o读取网络流，是不是这样？
2.ajp也是指一种网络协议么，类似于http这种，processor里面是根据什么来判定请求的协议类型，比如浏览器里面请求的header里面的内容吗
3.endpoint里面的aceptor本身是监听和获取网络请求没有用多线程，这里会成为高并发的瓶颈点不</div>2019-05-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d3/6e/281b85aa.jpg" width="30px"><span>永光</span> 👍（13） 💬（2）<div>老师，你看这样理解对不，
采用何种I&#47;O模式（NIO、NIO2、ARP），以及采用何种应用协议（HTTP1.1、AJP、HTTP&#47;2)都是在processor这一层决定的。EndPoint只负责接收连接，并读取网络字节流但是不对字节流本身就进行任何解析。</div>2019-06-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/16/5b/83a35681.jpg" width="30px"><span>Monday</span> 👍（10） 💬（2）<div>从上一节突然跳转到本节，感觉跳跃性很大。突然进入整体架构后，即使我花了大量时间多次阅读本节，也很难消化。真的捉急！
不知道老师上面提到的类名，是基于Tomcat的哪个版本。
今天我刻意花时间把tomcat7.0.94的源码下载下来，导入IDEA。发现org.apache.tomcat.util.net.AbstractEndpoint是一个抽象类，既没有实现EndPoint，也没有声明内部类SocketProcessor。和老师讲上面提到的有出入，难道我下了一个假的Tomato源码。&gt;大哭&lt;</div>2019-05-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/78/c7/083a3a0b.jpg" width="30px"><span>新世界</span> 👍（10） 💬（2）<div>对tomcat的结构的连接器部分收获不少，有一问题，tomcat的endpoint的功能和netty的实现功能很多方面一样，tomcat为什么没有用netty作为底层通讯框架？</div>2019-05-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f9/5f/b0a125a9.jpg" width="30px"><span>chp</span> 👍（9） 💬（2）<div>老师，请求来的时候，源码入口在哪里？</div>2019-05-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/77/61/adf1c799.jpg" width="30px"><span>KL3</span> 👍（9） 💬（1）<div>您好，我不太理解io模型，是指若干个请求的网络字节流经过网络适配器，由连接器通过一个什么样的方式读到吗？
我对io理解的不深，表达会有问题。</div>2019-05-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/36/d2/c7357723.jpg" width="30px"><span>发条橙子 。</span> 👍（8） 💬（2）<div>老师 ，我有个疑问 ：
层次结构是 一个server表示一个应用实例（java进程）。 一个server中可以有多个service , service中又有多个连接器和容器 。 并且每个service可以监听一个不同的端口号 。

但是我们的一个应用一般不都是一个端口号么 ， url地址：端口号 。 为什么会有多个端口号。是我哪个点理解的有偏差么老师</div>2019-05-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/05/7f/a7df049a.jpg" width="30px"><span>Standly</span> 👍（8） 💬（1）<div>“如果说 EndPoint 是用来实现 TCP&#47;IP 协议的，那么 Processor 用来实现 HTTP 协议”，这句话不太理解，TCP&#47;IP协议不是由linux系统内核实现的么？</div>2019-05-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/79/4b/740f91ca.jpg" width="30px"><span>-W.LI-</span> 👍（8） 💬（1）<div>老师好!Tomcat配置的并发数是文中endpoint里那个线程池么?IO方面知识比较薄弱，希望老师后期讲解时多花点心思。</div>2019-05-21</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/xYQgB3IEFRAVQTDHEI1NpQBialaNGyrUibLPpUoXByVeKibNZicdMLP7Vaahc1sHTNdtMqpGfct2ichwpia98qbjGWrQ/132" width="30px"><span>？？？</span> 👍（7） 💬（1）<div>老师，连接器就是前面章节说的http服务器吗</div>2019-06-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0b/4e/fd946cb2.jpg" width="30px"><span>allean</span> 👍（7） 💬（1）<div>可以理解为一个连接器对应一个应用吗</div>2019-05-22</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/6LaITPQ4Lk5fZn8ib1tfsPW8vI9icTuSwAddiajVfibPDiaDvMU2br6ZT7K0LWCKibSQuicT7sIEVmY4K7ibXY0T7UQEiag/132" width="30px"><span>尔东橙</span> 👍（6） 💬（1）<div>老师，有两个问题，第一个是您常说的servletrequest 是不是只是个抽象概念，实际上并没有这个对象（类），具体到代码里是Httprequest和Httpresponse或者具体其他协议类？第二个问题，您文章最后提到的系统架构面试题，最近也是我头疼的一个问题。对于应届生来说，没有参与 过具体的项目，如何回答才能达到面试官的要求？从文章中和评论中看来，是不是抓住需求中的变与不变，然后使用一些设计模式实现高内聚低耦合，这样回答可行？</div>2019-05-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/79/69/5960a2af.jpg" width="30px"><span>王智</span> 👍（6） 💬（1）<div>老师您好,我有两个问题,
一个是上面说到一个容器对接多个连接器,也就是service,这个具体是不是可以在tomcat的conf目录下的server.xml中发现呢? 但是一般情况下,也就是默认的,tomcat的一个server下只会有一个service组件,而connector就是在service组件中配置的呢?  
另一个是一个server中有一个或多个service,一个service中有多个连接器和一个容器,这里的容器到底是什么?我并没有在server.xml中找到相关的配置等呀.</div>2019-05-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/24/5d/65e61dcb.jpg" width="30px"><span>学无涯</span> 👍（5） 💬（1）<div>老师，我可以这么理解吗：一个service里面多个连接器，每个连接器监听一个协议的端口，如果需要监听某个协议的多个端口，就需要多个service。比如我在一个service中不能有多个监听http协议的端口，如果需要开放多个http协议的端口，就需要多个service</div>2019-06-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0b/4e/fd946cb2.jpg" width="30px"><span>allean</span> 👍（5） 💬（1）<div>一个service有多个连接器和一个容器，多个Service就可能有n个连接器和n个容器吗？还是有且只有一个容器，所有的连接器都指向这个容器，请老师解答，谢谢！</div>2019-05-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/97/1a/389eab84.jpg" width="30px"><span>而立斋</span> 👍（5） 💬（1）<div>看懂了，但是没有一个形象化的记忆点。</div>2019-05-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/8a/76/4abc8ac1.jpg" width="30px"><span>完美世界</span> 👍（4） 💬（1）<div>select，accept，read，send，是标准的网络标准API。

这几个应该都在protocolhandler里吧( •̥́</div>2019-05-28</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eofKOpMHg2BzjrZHuadMG1UB6Mpz47XmTqtX6JqArPWh21T4rFgSibOicYf5picvhMawYzGIWszVKxMg/132" width="30px"><span>Aaron</span> 👍（3） 💬（1）<div>老师，你好，请问下连接器和容器是多对多的关系么，就是多个连接器可以对应一个容器，多个容器也能对应一个连接器？</div>2019-05-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/76/12/8dd9bfa6.jpg" width="30px"><span>泉清</span> 👍（3） 💬（1）<div>一、课后题：刚好最近独立设计开发过一个以第三方为标准的项目，其实无论谁为标准，要做的事情非自己系统与别人系统高度耦合的定制项目，都可以进行抽离。
1、自己先把流程分析，确定那些是固定的，哪些是变的；
2、定义自己标准版的数据结构，对于任何来自第三方的数据都可以用适配器模式转化为自己标准版的。
二、关于老师的课件版本代码是否是在github上获取的对应源码，我获取的tomcat源码中AbstractEndpoint并未包含任何内部类。</div>2019-05-21</li><br/>
</ul>