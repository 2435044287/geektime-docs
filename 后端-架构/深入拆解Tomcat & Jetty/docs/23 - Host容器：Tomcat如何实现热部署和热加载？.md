从这一期我们开始学习Tomcat的容器模块，来聊一聊各容器组件实现的功能，主要有热部署热加载、类加载机制以及Servlet规范的实现。最后还会谈到Spring Boot是如何与Web容器进行交互的。

今天我们首先来看热部署和热加载。要在运行的过程中升级Web应用，如果你不想重启系统，实现的方式有两种：热加载和热部署。

那如何实现热部署和热加载呢？它们跟类加载机制有关，具体来说就是：

- 热加载的实现方式是Web容器启动一个后台线程，定期检测类文件的变化，如果有变化，就重新加载类，在这个过程中不会清空Session ，一般用在开发环境。
- 热部署原理类似，也是由后台线程定时检测Web应用的变化，但它会重新加载整个Web应用。这种方式会清空Session，比热加载更加干净、彻底，一般用在生产环境。

今天我们来学习一下Tomcat是如何用后台线程来实现热加载和热部署的。Tomcat通过开启后台线程，使得各个层次的容器组件都有机会完成一些周期性任务。我们在实际工作中，往往也需要执行一些周期性的任务，比如监控程序周期性拉取系统的健康状态，就可以借鉴这种设计。

## Tomcat的后台线程

要说开启后台线程做周期性的任务，有经验的同学马上会想到线程池中的ScheduledThreadPoolExecutor，它除了具有线程池的功能，还能够执行周期性的任务。Tomcat就是通过它来开启后台线程的：
<div><strong>精选留言（29）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/53/3d/1189e48a.jpg" width="30px"><span>微思</span> 👍（24） 💬（5）<div>文章读完有两点疑惑：
1、文章提到热部署和热加载的本质是热部署的Context对象整个会被销毁掉，会重新创建一个Context对象；而前文讲热加载时提到WebLoader会调用Context的reload方法，也会销毁Context对象，是否前后矛盾了？
2、整个设计自顶向下，父容器调用子容器中的backgroundProcess方法，但是到了Context容器的此方法中最后一行supper.backgroundProcess又反过来调用了父类该方法，有些不解？
还请老师指教……</div>2019-07-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/79/4b/740f91ca.jpg" width="30px"><span>-W.LI-</span> 👍（11） 💬（1）<div>老师好!是因为基于事件，可以解耦么?</div>2019-07-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/5d/91/a9365c01.jpg" width="30px"><span>锟铻</span> 👍（7） 💬（1）<div>请教一个疑问，文中讲的在热部署过程中：停止和销毁 Context 容器及其所有子容器，这个跟热加载一样都销毁了context容器，只是在销毁session有区别，对不，

</div>2019-07-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg" width="30px"><span>QQ怪</span> 👍（7） 💬（1）<div>老师，问个问题，我们平常在开发中，在已经运行的应用上改了代码之后然后编译，是不是就是主动热加载?</div>2019-07-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/b3/c5/7fc124e2.jpg" width="30px"><span>Liam</span> 👍（7） 💬（1）<div>热部署也会导致系统短暂地不可用吧？我理解它只不过是通过后台线程周期性任务实现了一下自动重启功能？</div>2019-07-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4e/1b/f4b786b9.jpg" width="30px"><span>飞翔</span> 👍（4） 💬（1）<div>老师 求问 我们生成一个类 可以用反射 也可以用 new， 那么你说在热部署的时候很多类都被销毁了，那销毁调用的是哪个函数呀</div>2019-07-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/24/5d/65e61dcb.jpg" width="30px"><span>学无涯</span> 👍（3） 💬（1）<div>老师讲的web应用目录级别的变化是指人为的删除或者添加web应用吗这种情况吗</div>2019-08-13</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/6LaITPQ4Lk5fZn8ib1tfsPW8vI9icTuSwAddiajVfibPDiaDvMU2br6ZT7K0LWCKibSQuicT7sIEVmY4K7ibXY0T7UQEiag/132" width="30px"><span>尔东橙</span> 👍（2） 💬（1）<div>老师，您文中提到的Session是http中的Session么</div>2019-08-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/1e/3a/5b21c01c.jpg" width="30px"><span>nightmare</span> 👍（4） 💬（0）<div>热加载的定位是某些文件更新，热部署是通过用户手动加了一个项目，热部署没有必要定时执行，只需要监听用户的热部署事件就行</div>2019-07-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/be/e6/7808520d.jpg" width="30px"><span>Edward Lee</span> 👍（2） 💬（0）<div>课后习题

因为 Host 位于容器的最顶层，已经没有可以调用 Host backgroundProcess 方法的更顶层容器了，再上一层就是重启</div>2020-11-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4c/06/2f8d2085.jpg" width="30px"><span>nate</span> 👍（2） 💬（0）<div>scheduleWithFixedDelayd的第二个和第三个传参应该是：backgroundProcessorInitialDelay和backgroundProcessorDelay</div>2019-07-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/65/16/24d6921d.jpg" width="30px"><span>LTL</span> 👍（1） 💬（1）<div>tomcat9代码中，context容器reload时，会调用manager的stop方法，在manager的stopInternal方法中有使所有session失效的方法，好像和老师讲的不一样</div>2021-10-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/83/c8/5ce842f6.jpg" width="30px"><span>maybe</span> 👍（1） 💬（0）<div>热部署和热加载区别是热部署会销毁整个context然后重建，热部署session会被删除，而热加载只是重新加载了变化的类，不会对原来的对象gc，session也会保留。tomcat如何实现热部署和热加载的，热加载是通过后台周期性框架实现的，具体是containerbase基类实现了周期性任务backgroudprocess，会依次调用子容器的backgroundprocess方法，只需要实现它就会被定期执行，热加载就是context容器重写了backgroundprocess方法完成的热加载。热部署是通过事件来完成的，host容器监听事件，然后处理变化。</div>2020-08-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/1e/3a/5b21c01c.jpg" width="30px"><span>nightmare</span> 👍（1） 💬（0）<div>Host热部署是父容器，如果也采用定时任务，那么context都重新加载了，也就没有热加载什么事情了</div>2019-07-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ea/05/c0d8014d.jpg" width="30px"><span>一道阳光</span> 👍（1） 💬（0）<div>backgroundProcess 方法主要用在加载粒度比较小，加载具体的资源、文件。而热部署是直接销毁Context,然后重新部署，所以不适合。</div>2019-07-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/28/e8/7734b8d3.jpg" width="30px"><span>P</span> 👍（0） 💬（0）<div>请教个问题：现在基本都是一个Tomcat对应一个Web应用，是不是没必要热部署了，直接重启。</div>2023-02-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/88/ec/9229419d.jpg" width="30px"><span>.</span> 👍（0） 💬（0）<div>热部署在生产环境中用的多吗？一般都是怎么用的？</div>2022-07-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/9b/a7/440aff07.jpg" width="30px"><span>风翱</span> 👍（0） 💬（0）<div>热部署感觉和关闭再启动好像差不多。 热部署主要的应用场景是什么呢？</div>2021-06-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/1d/cd/3819726f.jpg" width="30px"><span>徐同学呀</span> 👍（0） 💬（0）<div>1、WebappLoader周期性的检查WEB-INF&#47;classes和WEB-INF&#47;lib目录下的类文件
我看源码热加载只包括这两个目录下的jar和.class ，这两个目录路径是否可以改变？
2、周期性的检查静态资源是否有变化
静态资源的路径 是哪里，是否可以改变，源码看不太懂
</div>2021-05-12</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELxA3FzZX2aQezw2FohiarFJknlv8DgicP1lG2RrVtG2iaWQaYnhrpCICbDm4ZfDkkPBanYOCpg6MOlQ/132" width="30px"><span>Geek_d47377</span> 👍（0） 💬（0）<div>老师，文中说到&lt;Context reloadable=&quot;true&quot;&gt;启用重载后监测 classes和lib中的类文件变化，但classes中还有template,static下面的静态文件变化，这个也会触发重载？如何做到只有class或jar变化时才触发重载，静态文件不触发呢？</div>2020-12-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/67/8a/babd74dc.jpg" width="30px"><span>锦</span> 👍（0） 💬（0）<div>所以热加载机制是把类销毁掉，然后重新调用相同的类加载器加载吗？也就是说，如果需要实现热更，需要先销毁旧有的类加载器，然后创建一个新的类加载器，意味着不能使用系统提供的应用类加载器吗？</div>2020-05-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/2d/d7/74fc8f38.jpg" width="30px"><span>灿烂明天</span> 👍（0） 💬（0）<div>也就是说热加载会触发热部署？</div>2020-03-07</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI4akcIyIOXB2OqibTe7FF90hwsBicxkjdicUNTMorGeIictdr3OoMxhc20yznmZWwAvQVThKPFWgOyMw/132" width="30px"><span>Chuan</span> 👍（0） 💬（1）<div>老师，在使用嵌入式的tomcat时，怎么实现热部署和热加载啊，因为比如spring boot应用本身是一个jar包，怎么去修改里面的应用目录和class文件呢，这种场景是不是直接重启应用更方便？</div>2020-02-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/5d/d4/e5ea1c25.jpg" width="30px"><span>sun留白</span> 👍（0） 💬（0）<div>关于课后题，host容器是整个应用层级的，当确定web下目录有更新，就直接整个清理，然后按启动顺序，整个启动web应用就好（），这个启动逻辑已有，没必要通过重写 backgroundProcess 方法来实现，也不需要逐层的递归查找变化。当前启动前，得先销毁Context 对象。</div>2020-01-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/5d/d4/e5ea1c25.jpg" width="30px"><span>sun留白</span> 👍（0） 💬（0）<div>老师看完了整个，我有两点疑问：
1.是否热加载和热部署都会有短暂的停机，只是相对来说热加载粒度小，停机时间短。而这两个技术可以做到，自动检测，不用手动启，减少人工重启的中间停顿时间。
2.热加载时候，session没有被干掉，是为了保存context容器的数据吗？
</div>2020-01-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cf/2f/4f89f22a.jpg" width="30px"><span>李鑫磊</span> 👍（0） 💬（0）<div>我的Sevlet编译后的.class文件在Tomcat启动之前放进class目录下，Tomcat启动后都是可以访问的；但Tomcat启动后，再把我的.class文件放进class目录下，就访问不到，报404；context.xml已经配置了reloadable=&quot;true&quot;了；</div>2020-01-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cf/2f/4f89f22a.jpg" width="30px"><span>李鑫磊</span> 👍（0） 💬（1）<div>请问老师，有什么方式可以把一个正在运行的Tomcat的流量旁路出来？</div>2020-01-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cf/2f/4f89f22a.jpg" width="30px"><span>李鑫磊</span> 👍（0） 💬（0）<div>老师这个Tomcat的版本是什么？</div>2020-01-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/65/32/36c16c89.jpg" width="30px"><span>Geek_osqiyw</span> 👍（0） 💬（0）<div>热加载这种设计感觉就是一个树结构，从根开始遍历执行到所有叶，学习了。</div>2019-07-02</li><br/>
</ul>