你好，我是李玥。今天我们来讲讲为什么需要消息队列，消息队列主要解决的是什么问题。

消息队列是最古老的中间件之一，从系统之间有通信需求开始，就自然产生了消息队列。但是给消息队列下一个准确的定义却不太容易。我们知道，消息队列的主要功能就是收发消息，但是它的作用不仅仅只是解决应用之间的通信问题这么简单。

我们举个例子说明一下消息队列的作用。话说小袁是一家巧克力作坊的老板，生产出美味的巧克力需要三道工序：首先将可可豆磨成可可粉，然后将可可粉加热并加入糖变成巧克力浆，最后将巧克力浆灌入模具，撒上坚果碎，冷却后就是成品巧克力了。

最开始的时候，每次研磨出一桶可可粉后，工人就会把这桶可可粉送到加工巧克力浆的工人手上，然后再回来加工下一桶可可粉。小袁很快就发现，其实工人可以不用自己运送半成品，于是他在每道工序之间都增加了一组传送带，研磨工人只要把研磨好的可可粉放到传送带上，就可以去加工下一桶可可粉了。 传送带解决了上下游工序之间的“通信”问题。

传送带上线后确实提高了生产效率，但也带来了新的问题：每道工序的生产速度并不相同。在巧克力浆车间，一桶可可粉传送过来时，工人可能正在加工上一批可可粉，没有时间接收。不同工序的工人们必须协调好什么时间往传送带上放置半成品，如果出现上下游工序加工速度不一致的情况，上下游工人之间必须互相等待，确保不会出现传送带上的半成品无人接收的情况。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/14/bf/55/198c6104.jpg" width="30px"><span>小伟</span> 👍（212） 💬（19）<div>个人的体会，消息队列的本质是将同步处理转成异步处理，异步会带来相应的好处，但也有弊端。
Pros: 
1.可在模块、服务、接口等不同粒度上实现解耦
2.订阅&#47;消费模式也可在数据粒度上解耦
3.可提高系统的并发能力，集中力量办大事(同步部分)，碎片时间做小事(异步部分)
4.可提高系统可用性，因为缓冲了系统负载

Cons:
1.降低了数据一致性，如要保持强一致性，需要高代价的补偿(如分布式事务、对账)
2.有数据丢失风险，如宕机重启，如要保证队列数据可用，需要额外机制保证(如双活容灾)

总体来说，消息队列的适用场景还是很多的，如秒杀、发邮件、发短信、高并发订单等，不适合的场景如银行转账、电信开户、第三方支付等。关键还是要意识到消息队列的优劣点，然后分析场景是否适用则会水到渠成。</div>2019-07-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/34/1d/169cd800.jpg" width="30px"><span>beiler</span> 👍（91） 💬（8）<div>还有个问题，如果消息量特别大的时候，消息是适合存在到redis中还是适合存到rabbitmq中？必定您在文中提到一个词，小仓库，如果货量大了怎么办？</div>2019-07-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/71/3d/da8dc880.jpg" width="30px"><span>游弋云端</span> 👍（60） 💬（8）<div>是否可以利用共享内存、RDMA加速消息队列的性能，老师在这块有没有实践经验？</div>2019-07-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/34/1d/169cd800.jpg" width="30px"><span>beiler</span> 👍（52） 💬（4）<div>令牌桶给了我很大的启发，我们可以在策略中心设置令牌桶，然后通过令牌桶控制整个job的产出和数量。这样就不会经常有几百万个job了，缓存的压力也会大幅度减小。但是有一个很诡异的问题，就以秒杀系统为例（我们的系统要比秒杀复杂点），我发现这种异步系统如果需要统计任务数量的时候经常会计数不准，尽管在计数的时候我选择了原子操作，但是计数还是会出现不准的现象。这个让我很苦恼，而且往往是运行很久的任务会出现不准，往往只有在任务结束的时候发现任务不准，这个问题很难查，请问老师有什么好建议吗</div>2019-07-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0a/c0/401c240e.jpg" width="30px"><span>撒旦的堕落</span> 👍（39） 💬（16）<div>我懵的地方就是用队列 将同步改成了异步  那么原来同步的request 和response是一对 那么改成异步后  怎么通知用户 难道还用原来的那个response ？ 还是当秒杀成功后  根据用户的id 查询到信息 比如手机号码 然后发短信给他  或者是向用户推消息什么的  </div>2019-07-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/4e/3a/86196508.jpg" width="30px"><span>linqw</span> 👍（31） 💬（14）<div>APP⇆网关--生产--&gt;消息队列--消费--&gt;秒杀服务，有几点疑惑，老师有空帮忙解答下哦
1、海量的请求都放在消息队列中，消息队列的整体容量如何衡量了？消息队列不可能能存放无限的消息，消息队列满应该也会有拒绝策略，比如线程池的任务队列，任务队列满，并且超过最大的线程池数，四种的拒绝策略。
2、APP响应超时，即网关超过一定的时间没有返回，消息还在任务队列中，还是会被秒杀服务处理，这样的话，返回给APP秒杀失败，但是秒杀服务已经消费了消息？难道是在网关做补偿么？如果连接已经断开，将秒杀服务对此消息的处理做回滚操作么？
3、网关和秒杀服务是通过消息队列进行通信，那响应消息也通过队列进行返回么？队列中会有APP对应的地址比如IP之类的？那这样的话，APP的海量连接都同时连接着网关，不是会有问题么？
4、消息队列应该也会做多备的策略？比如队列消息的服务挂了，那些消息全部不见，这样不是也会存在问题么？</div>2019-07-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/5e/60/1c13626b.jpg" width="30px"><span>白小白</span> 👍（30） 💬（3）<div>现在用的消息队列主要是做数据异步传输用的，之前也做过多个系统之间的解耦。看到用消息队列做秒杀系统，忽然想到之前只想过用redis去做，利用redis去做了流量的把控。不过细想想，这种情况下的redis和文章中的令牌桶很像……</div>2019-07-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/f9/9b/dc074a7e.jpg" width="30px"><span>小趴菜～</span> 👍（25） 💬（1）<div>生产项目中用到了kafka，
1 异部的处理交易：提高用户请求的响应速度，同时也提升了用户的体验感。
2 削峰 ：保护服务器的一种方式，用户的请求放到kafka中，交易服务根据自己服务器的消费能力来消费交易数据。
3 项目的解耦：交易服务和后续的服务之间是通过Kafka进行交付，当一个服务为多个服务提供数据的时候，可以通过MQ进行交换来解耦服务间的耦合。</div>2019-07-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/aa/49/51790edb.jpg" width="30px"><span>落尘kira</span> 👍（23） 💬（4）<div>看了下评论，我就简单补充一下实际用过的场景：
1.数据同步：包括业务服务之间的业务数据同步（主要是状态）、DB间的数据同步等等
2.异步通知：包括发送IM消息、异步日志、异步短信&#47;邮件（尤其是批量数据）或注册&#47;开启任务等等
3.信息收集：主要用于数据统计、监控、搜索引擎等等
4.服务解耦：主要用于重构和新设计时，对频繁变动的接口服务进行解耦（通常是被需求给逼的）
5.分布式事务消息：尤其是对数据一致性有要求的异步处理场景
6.主动性防御：秒杀、限流</div>2019-07-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a3/fc/379387a4.jpg" width="30px"><span>ly</span> 👍（22） 💬（9）<div>老师，关于第二点的流控有点疑问：网关将request信息放入mq中，然后后端服务去mq中消费这个请求，我通常晓得的mq储存文本消息，那这样的场景下，后端处理完秒杀以后，是如何得到response响应客户端的请求呢？</div>2019-07-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/8f/35/f1839bb2.jpg" width="30px"><span>风中花</span> 👍（18） 💬（3）<div>要不要继续买，继续买要不要！老师讲得这么好！纠结</div>2019-07-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/a5/e7/ed0a0131.jpg" width="30px"><span>大白先生</span> 👍（15） 💬（2）<div>那秒杀时后端请求没处理完，app返回超时后，后续服务处理之前请求时会不会进行库存扣减，还是说，后端能识别出哪些请求超时，不进行处理</div>2019-07-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/14/17/8763dced.jpg" width="30px"><span>微微一笑</span> 👍（13） 💬（6）<div>看到消息队列的专栏很兴奋，能学到底层源码、设计思想一直是我的梦，哈哈哈。目前在一家互金公司负责一个资金平台的项目，负责对接车贷、消费金融两个系统，同时与第三方资金渠道进行对接。在于车贷、消费金融这俩系统对接中，使用了rocketMQ进行系统间的解耦，系统间升级优化上线互不影响。由于对接的第三方渠道越来越多渠道间耦合较严重，下一步准备进行系统拆分，系统与系统间经过消息队列进行解耦。</div>2019-07-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/bb/23/64fc8f96.jpg" width="30px"><span>x.l</span> 👍（11） 💬（2）<div>老师，你好！工作中有按业务优先处理的需求，想实现个优先队列，问下老师有没有常规的解决方案?</div>2019-09-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg" width="30px"><span>Jxin</span> 👍（11） 💬（1）<div>1.拆单失败的延时重拆，死信告警。2.消峰和解耦也用到。

问题：控制topic消费线程也能限流，不一定要引入令牌桶，要弄令牌桶，其实走redis更好一点。</div>2019-07-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/64/5d/c8e2663b.jpg" width="30px"><span>Geek_bbe9ea</span> 👍（9） 💬（6）<div>修改数据库做数据同步也可以用</div>2019-07-23</li><br/><li><img src="" width="30px"><span>Geek_e7834d</span> 👍（8） 💬（1）<div>使用消息队列怎么保证实现节点时效时候能够切换到异地节点 然后还要保证不丢失消息呢或者尽量少丢失消息？异地冗余都有什么好方案呢？</div>2019-07-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/fc/18/8e69f7cf.jpg" width="30px"><span>一记妙蛙直拳</span> 👍（8） 💬（4）<div>收获总结：
1. 消息队列可以理解为一个暂存消息（可以是一条数据或者一个请求等等）的地方，有生产者有消费者
2.消息队列的主要三个用处：
a. 实现异步处理，利用消息队列可以将串行化的功能，在非必要串行的地方实现并行化，从而提升系统性能，缩短响应时间
b. 实现流量控制  在高并发的情况下，为了避免大量的请求冲击后台服务，可以使用消息队列暂存请求，后台服务以最大处理能力消费请求，保证后台的安全性，其缺点拉长系统调用链，响应时间变长，增加系统复杂度；另外一种不改变系统调用链的实现方式，引入令牌桶的概念，单位时间内生成一定量的令牌放到令牌桶（即消息队列）中，令牌的数量要依据后台系统的处理能力，网关接受到请求后取到令牌才能调用后台服务，取不到则请求失败
c. 系统间解耦  多个下游系统会频繁调用上游系统的接口获取数据的情况下，若上游系统将消息放到指定queue中，多个下游系统订阅消息，就可以避免上游为对接多个下游时频繁地修改接口，降低系统间的耦合度
思考题：
目前erp项目中，订单数据需要同时发给工程去评估以及企划去进行物料核算，现在的实现方式则是系统之间通过接口进行拉去或者推送，这就可以使用消息队列，将订单放到消息队列中，供下游订阅使用，降低系统间解耦
</div>2019-07-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（7） 💬（3）<div>老师的比喻很棒，通俗易懂。

1：消息队列的核心作用？
1-1：服务解藕
1-2：削峰填谷
1-3：异步处理

2：消息队列带来的问题？
2-1：增加系统的复杂度
2-2：延迟了请求的响应时间
2-3：可能会丢消息、可能会重复消费消息、可能导致数据不一致、消息可能是无序的

3：消息队列的适用场景？
3-1：秒杀
3-2：发送邮件
3-3：日志收集
3-4：离线数据持久化
3-5：其他不担心数据不是强一致性的大流量高并发场景

4：消息队列不适合的场景？
4-1：要求实时响应
4-2：要求数据强一致性
4-3：不能容忍消息丢失
4-5：直接和钱相关的系统，比如：支付系统

MQ能干啥？啥时候适合使用？这些还是比较容易理解的，痛点在于自己设计并实现一个MQ能否扛住亿级流量，并且具有各种其他优良特性。

李老师，请教几个：
1：消息的全生命轨迹，会描述嘛？
2：producer发送消息是通过TCP连接的，broker什么时候响应客户端？
3：使用JMQ几乎天天报超时异常？这个超时异常有哪些场景会发生？为什么总也解决不了？
4：consumer拉取消息的时机是什么时候？
5：broker怎么实现高性能的消息落盘的？
</div>2019-08-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/74/d5/56b3a879.jpg" width="30px"><span>poettian</span> 👍（6） 💬（13）<div>老师您好，请教一个问题。关于秒杀这种场景我想的是用redis的list不就完全可以实现吗。活动开始前，先把要抢的N个商品push到list中。活动开始后，每来一个请求就从list中pop一个商品出去，当list为空后直接返回“已抢光”的响应，由于可秒杀的商品数量并不多，能通过的请求也可以采用同步的方式进行，这样不是既简单又快速。可是我搜了一下网上的方案，都特别的复杂，请问这种方式有什么问题吗？</div>2019-09-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/1e/8c/d9330d2b.jpg" width="30px"><span>花儿少年</span> 👍（5） 💬（3）<div>好像还有个用go语言写的开源的消息队列</div>2019-07-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/09/42/1f762b72.jpg" width="30px"><span>Hurt</span> 👍（4） 💬（1）<div>老师 这里的风险控制是指的什么啊</div>2019-10-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/a8/b8/73ef30ed.jpg" width="30px"><span>Mark Yao</span> 👍（4） 💬（1）<div>打卡，打卡，我们系统目前使用rabbitmq，有些业务实时数据对接第三方厂家，有些数据是TCP接入，有些HTTP过来，为解决和我们业务耦合。在使用遇到因特殊情况出现异常，消息大量堆积，最后导致爆掉。</div>2019-07-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/34/df/64e3d533.jpg" width="30px"><span>leslie</span> 👍（4） 💬（1）<div>      服务解耦：其实就是后续将要面对的问题。
      数据库压力偏大：虽然性能已经通过之前的丁奇的课获得了不少思路和处理方式，确实让数据库的查询时间提升到之前的20-30%。
        数据量进一步再次增长后期压力太大了：redis已经用了，可是还是不够，希望能够通过消息队列预先为6-12个月后的大数据量做些准备，以应当后期。</div>2019-07-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg" width="30px"><span>QQ怪</span> 👍（4） 💬（1）<div>滴滴滴，打卡</div>2019-07-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/7a/90/dc3537e7.jpg" width="30px"><span>神经蛙</span> 👍（3） 💬（1）<div>有一个小问题：为什么令牌发生器要“匀速”产生令牌，一次性产出足够的令牌到放入到令牌队列会有什么问题呢？</div>2019-08-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/5f/27/a6873bc9.jpg" width="30px"><span>我知道了嗯</span> 👍（3） 💬（1）<div>打卡，滴滴滴</div>2019-07-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/f5/63/53639bb7.jpg" width="30px"><span>Tulane</span> 👍（2） 💬（1）<div>买了20多门课, 老师这门课是我最喜欢的, 真的是带着我一步步真正弄懂消息队列的原理, 老师有开下一门课的打算吗</div>2019-11-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/6a/d0/af2e16f1.jpg" width="30px"><span>军交博文兄</span> 👍（2） 💬（1）<div>老师，第二种方式有个疑问，在网关后加入消息队列，如果买不同种类的产品，前面队列都被A产品占用光了，那B产品岂不是在秒杀时刻，一件也卖不出去</div>2019-10-18</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJbh5FQajwKhNlMrkoSklPpOXBtEYXCLvuWibhfWIS9QxHWDqzhEHJzEdmtUiaiaqFjfpsr2LwgNGpbQ/132" width="30px"><span>Geek_q29f6t</span> 👍（2） 💬（2）<div>问题：哪些问题可以通过引入消息队列来解决？
我们系统中存在着大量的报表计算，虽然做了负载均衡，但是数据库的计算压力还是比较大。后来就用了消息队列来控制“同时进行计算的最大数量”，效果还可以。 不过长远来看，还得要解决数据库压力大的问题。</div>2019-08-12</li><br/>
</ul>