你好，我是李玥。

上节课我带你一起学习了RocketMQ NameServer的源代码，RocketMQ的NameServer虽然设计非常简洁，但很好地解决了路由寻址的问题。

而Kafka却采用了完全不同的设计思路，它选择使用ZooKeeper这样一个分布式协调服务来实现和RocketMQ的NameServer差不多的功能。

这节课我先带大家简单了解一下ZooKeeper，然后再来一起学习一下Kafka是如何借助ZooKeeper来构建集群，实现路由寻址的。

## ZooKeeper的作用是什么？

Apache ZooKeeper它是一个非常特殊的中间件，为什么这么说呢？一般来说，像中间件类的开源产品，大多遵循“做一件事，并做好它。”这样的UNIX哲学，每个软件都专注于一种功能上。而ZooKeeper更像是一个“瑞士军刀”，它提供了很多基本的操作，能实现什么样的功能更多取决于使用者如何来使用它。

ZooKeeper 作为一个分布式的协调服务框架，主要用来解决分布式集群中，应用系统需要面对的各种通用的一致性问题。ZooKeeper本身可以部署为一个集群，集群的各个节点之间可以通过选举来产生一个Leader，选举遵循半数以上的原则，所以一般集群需要部署奇数个节点。
<div><strong>精选留言（19）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/99/af/d29273e2.jpg" width="30px"><span>饭粒</span> 👍（17） 💬（1）<div>ZooKeeper 集群宕机后 Kafka 不可以依靠客户端自身的元数据缓存或者 Broker 的元数据缓存工作吗？</div>2019-11-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/9b/46/ad3194bd.jpg" width="30px"><span>jack</span> 👍（10） 💬（1）<div>老师，有两个问题：1、hadoop集群的高可用也是用zookeeper保证的，是不是也要拆分成小集群，2、那么提供服务的时候是否需要路由，将不同的业务分发到不同的集群上呢？</div>2019-10-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c1/b9/9aca27d4.jpg" width="30px"><span>老杨</span> 👍（6） 💬（1）<div>老师能否讲讲RocketMQ或Kafka是如何做高可用，落地过程中有哪些坑，已经最佳实践有哪些？</div>2019-09-23</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/kQ0NueqD3LTRravKIH2DgtqFKLqgjZQicDZtibdTqJ8pBRjNwlKornibGj2qibPdsgLXh2xQ3MesQ7q2JyATIEBphVHpcS2iaboZqATms4IDUibes/132" width="30px"><span>山头</span> 👍（5） 💬（1）<div>老师，每个分区节点下面是一个名为 state 的临时节点，节点中保存着分区当前的 leader 和所有的 ISR 的 BrokerID。，这里的leader是指的一个分区的master,isr指的是从？</div>2019-09-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/40/07/050a63ee.jpg" width="30px"><span>slam</span> 👍（3） 💬（2）<div>最后说到kafka严重依赖zk集群的可用性，有计划搞个服务替换，这里搞一套服务跟zk有什么区别？kafka的可用性不是也会依赖这个新服务吗？</div>2019-09-20</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/GEsrR5BvcKoiaFEdmhNz17deia0efzhibrWevbVy0jY3mhI7XMrtTNpnAZp5BGzg5ia6OT4BTGcWlEnrOz1SwAgPUw/132" width="30px"><span>海神名</span> 👍（3） 💬（2）<div>老师，听说kafka对部署环境资源要求较低，请问具体体现在哪些方面呢？有没有具体的推荐配置表？</div>2019-09-19</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/kQ0NueqD3LTRravKIH2DgtqFKLqgjZQicDZtibdTqJ8pBRjNwlKornibGj2qibPdsgLXh2xQ3MesQ7q2JyATIEBphVHpcS2iaboZqATms4IDUibes/132" width="30px"><span>山头</span> 👍（2） 💬（1）<div>老师，你讲的很好，通过这节课懂了很多，能否说说一个消息发出去，我是如何路由到文件里去的呢？比如通过hash取模会对应到一个broke,又通过一个操作选择了一个队列，接着又怎么去选择写队列里的一个文件，思路模糊是没法造轮子的，请老师指正</div>2019-09-26</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/kQ0NueqD3LTRravKIH2DgtqFKLqgjZQicDZtibdTqJ8pBRjNwlKornibGj2qibPdsgLXh2xQ3MesQ7q2JyATIEBphVHpcS2iaboZqATms4IDUibes/132" width="30px"><span>山头</span> 👍（2） 💬（2）<div>老师，consumergroup和主题或者队列是什么关系，几对几的关系？还是consumergroup和分区有关系？是几对几</div>2019-09-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f1/d7/a52e390d.jpg" width="30px"><span>Pantheon</span> 👍（0） 💬（1）<div>既然客户端是和borker进行通信获取元数据信息,为啥客户端在连kafka的时候还要指定zk的地址</div>2019-09-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d4/a2/fa41c8a8.jpg" width="30px"><span>书中迷梦</span> 👍（31） 💬（8）<div>个人感觉使用ZK不太适合做注册中心，因为作为注册中心首先要保证的是AP而不是CP，因为注册中心不是数据库</div>2019-11-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/71/3d/da8dc880.jpg" width="30px"><span>游弋云端</span> 👍（11） 💬（2）<div>这里就出现了一个矛盾，ZK理论上抽象了分布式协调服务的核心功能，让各个分布式组件不在单独去关注协调服务本身，但大家似乎又在努力的避免去依赖ZK，从而需要自己去实现这套逻辑。哎，分久必合，合久必分。</div>2019-09-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/30/8a/b5ca7286.jpg" width="30px"><span>业余草</span> 👍（2） 💬（0）<div>kafka的优缺点都很明显，在架构平衡方便可以为我们借鉴！</div>2019-09-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/9c/7d/774e07f9.jpg" width="30px"><span>study的程序员</span> 👍（0） 💬（0）<div>某个分区的leader挂了，state节点消失，zk如何知道分区副本所在的broker是哪些？这个信息不是保存在state节点上的吗？难道在ids下的broker节点也会保存自身有哪些副本分区？zk是这样冗余保存的吗？</div>2021-05-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/9e/bd/617c3546.jpg" width="30px"><span>挖掘机</span> 👍（0） 💬（0）<div>老师你好，既然kafka不会主动请求zk，那么客户端在本地没有元数据缓存的情况下写数据时是随便选一个broker进行连接，根据返回的元数据信息再连接对应的broker是吗？</div>2020-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/cf/60/9100ad4f.jpg" width="30px"><span>周星平</span> 👍（0） 💬（0）<div>ZooKeeper 中的元数据修改通过Watcher通知broker删除缓存，下次查询时先访问ZooKeeper 中的元数据再缓存到broker本地；broker应该还需要心跳检测zookeeper是否存活吧</div>2020-10-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/07/ca/abb7bfe3.jpg" width="30px"><span>Geek_ejy2ar</span> 👍（0） 💬（0）<div>学到良多, 谢谢老师讲解!</div>2020-04-17</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLnQfCfmXCPI1icrD2mVlIkY5AVY6MT3VMAYKjDXZYlBgUk6wxBj61vpK1Om3aRlj27R0RYbVoALGw/132" width="30px"><span>张瑞浩</span> 👍（0） 💬（2）<div>kafka初始化阶段怎么得知broker的信息的？</div>2020-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/9c/53/ade0afb0.jpg" width="30px"><span>ub8</span> 👍（0） 💬（0）<div>使用临时节点来做动态扩容</div>2019-12-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4d/fd/0aa0e39f.jpg" width="30px"><span>许童童</span> 👍（0） 💬（0）<div>感谢老师的分享。</div>2019-09-19</li><br/>
</ul>