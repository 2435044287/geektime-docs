你好，我是李玥。

我看到有不少留言是关于“如何实现消息保序”的问题。关于这个问题，我在答疑中做了简单的回复，但限于篇幅并没有很深入。借助这次加餐的机会，我来深入地、一次性地把各种场景下如何实现消息保序的方法梳理清楚。

我们也会讨论在工程实践中，这些实现消息保序方法存在哪些限制、可能会遇到哪些问题，以及如何应对上面这些限制和问题，如何根据实际的业务场景，权衡一致性、可用性，做出取舍，实现相对的最优解。

## 哪些场景需要消息保序？

消息保序问题指的是，在通过消息中间件传递消息过程中，我们希望消费者收到消息的顺序，和发送者发送消息的顺序保持一致。或者说，消息中间件在传递消息时，不要改变消息之间的顺序。

不过在工程实践中，我们面临的保序问题不一定只是局限在消息保序这一个环节，更常见的场景是，事件经过包含消息队列等多个环节的处理和传递后，在某个服务内能够按照事件发生的顺序来逐个处理这些事件，不发生乱序。比如：

- 在证券、股票交易撮合场景中，对于出价相同的交易单，需要坚持按照先出价先交易的原则，下游处理订单的系统需要严格按照出价顺序来处理订单。
- 在数据库变更增量同步场景中，上游源端数据库按需执行增删改操作，将 BINLOG 作为消息，通过消息队列传输到下游系统，下游系统按顺序还原消息数据，实现状态数据有序更新。
- 在电商系统中，订单创建、支付、退款、物流等消息需要按照顺序处理，才能保证订单状态的正确更新。
- 在交易支付场景中，需要确保消息的顺序性和一致性，以满足金融领域对数据准确性的严苛要求。
<div><strong>精选留言（3）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/11/66/ac631a36.jpg" width="30px"><span>Geralt</span> 👍（1） 💬（0）<div>思考题的一些想法：
1.  需要有一个发号器确保消息序号的连续递增
2. 存在单点限制，同一时间只能由一个进程进行排序
3. 排序操作的时间间隔如何确定？间隔太长会影响消息的时效性，太短会频繁执行排序操作
4. 进行排序时，缓存中的消息序号不一定是全部连续的，可能存在断层，会导致部分消息无法被及时消费
5. 消费消息前，需要检查之前的消息是否已经消费成功，确保消费消费的顺序是正确的，但是会增加性能消耗
6. 缓存可能出现故障，导致无法进行排序
</div>2024-12-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ae/b7/a4309ba1.jpg" width="30px"><span>蝴蝶落于指尖</span> 👍（1） 💬（0）<div>老师要不要补充一下，Kafka 的默认设置下其实不能百分百保证分区保序，在 Kafka 的文档中对 max.in.flight.requests.per.connection 的参数说明了默认配置在发生 retry 的时候可能乱序。</div>2024-12-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg" width="30px"><span>木几丶</span> 👍（0） 💬（1）<div>老师你好，如果在消费者升级过程中，造成消费者重平衡，是否会造成乱序？这种应该比较常见，如何解决呢？</div>2024-12-12</li><br/>
</ul>