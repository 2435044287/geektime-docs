你好，我是李玥。

之前我在《[05 | 如何确保消息不会丢失？](https://time.geekbang.org/column/article/111488)》那节课中讲过，消息队列在收发两端，主要是依靠业务代码，配合请求确认的机制，来保证消息不会丢失的。而在服务端，一般采用持久化和复制的方式来保证不丢消息。

把消息复制到多个节点上，不仅可以解决丢消息的问题，还可以保证消息服务的高可用。即使某一个节点宕机了，还可以继续使用其他节点来收发消息。所以大部分生产系统，都会把消息队列配置成集群模式，并开启消息复制，来保证系统的高可用和数据可靠性。

这节课我们来讲一下，消息复制需要解决的一些问题，以及RocketMQ和Kafka都是如何应对这些问题来实现复制的。

## 消息复制面临什么问题？

我们希望消息队列最好能兼具高性能、高可用并且还能提供数据一致性的保证。虽然很多消息队列产品宣称三个特性全都支持，但你需要知道，这都是有前置条件的。

首先来说性能。任何的复制实现方式，数据的写入性能一定是不如单节点的。这个很好理解，因为无论采用哪种复制实现方式，都需要数据被写入到多个节点之后再返回，性能一定是不如只写入一个节点的。

**需要写入的节点数量越多，可用性和数据可靠性就越好，但是写入性能就越低，这是一个天然的矛盾。**不过，复制对消费的性能影响不大，不管采用哪种复制方式，消费消息的时候，都只是选择多副本中一个节点去读数据而已，这和单节点消费并没有差别。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEIvUlicgrWtibbDzwhLw5cQrDSy2JuE1mVvmXq11KQIwpLicgDuWfpp9asE0VCN6HhibPDWn7wBc2lfmA/132" width="30px"><span>a、</span> 👍（35） 💬（5）<div>5副本，10个分区，至少保持isr集合中有三个broker

bin&#47;kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 5 --partitions 10 --topic test 

min.insync.replicas=3</div>2019-09-26</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqj0HqmCbKPaW84jZaru1xa0icAEcDHgCszTO4tPwZBalXkib5CsISnAUAlO2hwDadoYPGUjIw0xBwg/132" width="30px"><span>kiddkidd</span> 👍（23） 💬（2）<div>老师，对于文中“由于消息要至少复制到 2 个节点上才会返回写入成功，即使主节点宕机了，也至少有一个节点上的消息是和主节点一样的”我有个疑问：
假如1主2从3副本条件下，主收到msg1，并复制到从1，之后主又收到msg2，并复制到从2. 然后主节点宕机了，此时从1和从2都跟主不一样啊。请问如何理解？</div>2020-01-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/e9/0b/1171ac71.jpg" width="30px"><span>WL</span> 👍（16） 💬（1）<div>请问一下老师，kafka消息复制中，“Broker只是副本分区的容器，Broker不分主从” 这句话具体怎么理解？ 是指一个Broker上可能有Topic1的partition2的从副本和Topic2的partition1的主副本，所以在Broker上不分主从，是这样吗？</div>2019-10-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/b7/6d/48c6c9b8.jpg" width="30px"><span>Martin</span> 👍（12） 💬（1）<div>请问老师～可用于消息中间性能测试的工具有哪些～</div>2019-09-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/6d/46/e16291f8.jpg" width="30px"><span>丁小明</span> 👍（11） 💬（1）<div>看起来好像新的rocktmq复制方式，就是内置了类似zk一样的一致性协调器。</div>2020-05-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/e4/39/a06ade33.jpg" width="30px"><span>极客雷</span> 👍（4） 💬（2）<div>RocketMQ不满足京东的使用场景吗？</div>2020-03-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/15/1b/448b2775.jpg" width="30px"><span>二货</span> 👍（2） 💬（2）<div>所有的 ISR 节点都宕机了，分区就无法提供服务了。你也可以选择配置成让分区继续提供服务，这样只要有一个节点还活着，就可以提供服务
老师，这里ISR节点都宕机了，分区为啥还是正常的，ISR不就是分区副本吗</div>2020-05-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/81/4e/d71092f4.jpg" width="30px"><span>夏目</span> 👍（2） 💬（1）<div>老师，这种不是同步方式吗？-- Kafka 在写入消息的时候，采用的也是异步复制的方式。消息在写入到主节点之后，并不会马上返回写入成功，而是等待足够多的节点都复制成功后再返回。</div>2020-01-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/99/af/d29273e2.jpg" width="30px"><span>饭粒</span> 👍（2） 💬（1）<div>请教下老师，kafka 使用时是一个节点对应一个 broker 吗?然后 broker 作为分区副本容器存放不同主题-分区的主&#47;从副本。</div>2019-11-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e2/6e/0a300829.jpg" width="30px"><span>李先生</span> 👍（1） 💬（1）<div>

玥哥，有两个问题：
1: 比如kafka，1个主节点2个从节点，一个topic有3个分区。为什么3个主分区会均匀的分布在3个节点上，而不是3个主分区都在主节点上，副本分区在从节点上。或者说这两者有什么区别？
2: kafka是主从模式，读写都在主节点，如果是生产者生产一个消息到主分区1，假如主节点上的分区1是副本分区，这时候这个消息是先写入主节点的副本分区1上吗？</div>2020-03-26</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKUcSLVV6ia3dibe7qvTu8Vic1PVs2EibxoUdx930MC7j2Q9A6s4eibMDZlcicMFY0D0icd3RrDorMChu0zw/132" width="30px"><span>Tesla</span> 👍（1） 💬（1）<div>老师好，请问旧的复制模式中，无法保证消息的严格顺序，是因为用了异步的方式同步消息，从节点接收到的顺序会收到网络影响不一定是哪个消息先到达吗？那可不可以给每个消息一个序号，从节点用一个队列来保存严格顺序的消息，用一个排序的数组来保存乱序的消息，只有当sortArrary的一部分能与队列合并为严格顺序的消息时，再把sortArrary的消息取出push到队列呢？</div>2020-03-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/43/50/abb4ca1e.jpg" width="30px"><span>凡</span> 👍（1） 💬（3）<div>RockerMQ传统方式的的异步复制会出现数据丢失啊，比如当消息写入到主节点，返回成功，但是这时候还未复制到从节点，主机挂掉，消费者切换到从节点后读不到这些消息</div>2020-02-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/a7/e4/5a4515e9.jpg" width="30px"><span>成立-Charlie</span> 👍（1） 💬（1）<div>老师, 关于Kafka的高可用性我有一点迷惑。因为kafka是使用zookeeper作为其集群服务的协调服务器，Zookeeper采用超过半数可用的原则，3台Zookeeper集群只允许一台宕机。那Kafka却可以实现只有一台存活，仍然可以提供服务，这是如何实现的呢，Kafka可以脱离Zookeeper工作吗。谢谢！</div>2019-11-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/e9/0b/1171ac71.jpg" width="30px"><span>WL</span> 👍（1） 💬（1）<div>请问一下老师，我看RocketMQ官微上说DLedger只做一件事就是Commitlog，上面用Etcd对Raft协议的实现做对比，说Etcd对于Raft的实现时StateMachine+CommitLog的方式，CommitLog记录日志和操作记录，StateMachine通过操作记录构建出来的系统状态，请问一下在DLedger中的系统状态是怎样判定的？</div>2019-10-13</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKUcSLVV6ia3dibe7qvTu8Vic1PVs2EibxoUdx930MC7j2Q9A6s4eibMDZlcicMFY0D0icd3RrDorMChu0zw/132" width="30px"><span>Tesla</span> 👍（0） 💬（1）<div>老师好，请问关于“ RocketMQ Dledger由于至少要复制到半数以上的节点才返回写入成功，性能上也不如主从异步复制的方式快 ”  这一点，我的理解是：异步复制也需要主节点先刷盘才能返回结果（硬件IO操作），Dledger是在内网发起的tcp连接传输数据然后返回（两次网络IO操作），这两种方式的速度会差很多吗？</div>2020-03-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a1/e6/50da1b2d.jpg" width="30px"><span>旭东(Frank)</span> 👍（0） 💬（1）<div>如果只记住一句话，那就是“目前并没有一种完美的实现方案能够兼顾高性能、高可用和一致性”。

世界本无完美，只有追求完美的人

</div>2019-10-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f6/9c/b457a937.jpg" width="30px"><span>不能扮演天使</span> 👍（5） 💬（0）<div>采用RocketMQ Dledger 5副本复制方式，那就是最多允许宕机两台，因为要求半数以上；broker的设置我觉得一样就行，所以：kafka 配置5台broker,一个主题50个分区，ISR算上leader副本至少是3；</div>2019-09-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/30/8a/b5ca7286.jpg" width="30px"><span>业余草</span> 👍（4） 💬（0）<div>没有完美的方案，我相信JMQ也是这样。高性能，高可用本身和一致性就是一个矛盾体。</div>2019-09-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/03/2f/0a5e0751.jpg" width="30px"><span>再见理想</span> 👍（2） 💬（0）<div>集群模式下，需要通过节点间的消息复制保证消息的一致性。
生产者将消息发送到主节点后，主节点需要将消息复制到从节点后，返回生产者发送成功。
极端情况下，主节点将消息复制到所有从节点后，才返回，这样保证了集群的可用性和数据一致性，但是却大大的降低了性能。而主节点不复制消息自己将消息保存成功后就返回，那么就会得到高性能，降低了数据一致性和可用性。
rocketmq提供了两种方式，1，异步复制，主节点保存消息后，返回成功，异步将消息复制到从节点，如果主节点宕机，集群将无法收到消息，但消费者可以自动转移消费从节点的消息。这样保证了系统的高性能和数据一致性，但丢失了一部分可用性。 这个方案的改进版本是，部署多对主从节点，主题队列均匀分布在多个主节点上，当一个主节点宕机时，生产者可以更换主节点继续发送消息，但是消息顺序无法保证。Dleger方案集群可以自动选举主节点，消息复制半数以上节点时，返回成功。当集群节点不足半数时，无法提供服务。</div>2022-04-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/68/34/25c0d678.jpg" width="30px"><span>Ric</span> 👍（1） 💬（0）<div>可以画几张图的，一图胜千言</div>2023-03-27</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoRBodNGH637QAEpw9Kao8OkSbCXpic85RicffLfZULe1896WXBr2s57gIhoktQ80utm8bgokyVwibFw/132" width="30px"><span>Geek_66be20</span> 👍（0） 💬（0）<div>玥哥，我理解rocketMQ的老版本消息复制类似于JMQ2的方式，kafka的消息复制更像是JMQ4的方式。思考题，是brokerA上面有队列1的主、队列2的从、队列3的从。brokerB上面有队列1的从、队列2的主、队列3的从，brokerC上面有队列1的从、队列2的从、队列3的主。这种架构对吗？</div>2021-07-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/87/23/f6835d17.jpg" width="30px"><span>语法糖不甜</span> 👍（0） 💬（0）<div>老师您好，我想问一下消息复制是把队列复制过去还是把队列里的消息复制过去。如果是把消息从队列a复制到队列b，队列a所在的节点宕机了，顺序消息是怎么去队列b找消息的那？</div>2021-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/ea/71/ad433980.jpg" width="30px"><span>Warder</span> 👍（0） 💬（0）<div>&quot;在需要保证消息严格顺序的场景下，由于在主题层面无法保证严格顺序，所以必须指定队列来发送消息，对于任何一个队列，它一定是落在一组特定的主从节点上，如果这个主节点宕机，其他的主节点是无法替代这个主节点的，否则就无法保证严格顺序&quot;，这里是指当写入消息的时候只能往指定的一个主节点写入，因为还没写完也就没有开始复制，所以其他主节点的内容和当前主节点内容不一样？所以不能替换？</div>2021-02-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/b2/e0/d856f5a4.jpg" width="30px"><span>余松</span> 👍（0） 💬（0）<div>&quot;在 RocketMQ 中，复制的基本单位是 Broker&quot;,后面提到RocketMQ为了可用性，将一个topic的数据分到多个队列中，分布在多个broker上。采用这种方案后，复制的基本单位是不是变成了队列(类似于Kafka中的分区)？还是依旧保持为Broker?</div>2021-01-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/20/9a/3b1c65fd.jpg" width="30px"><span>八百</span> 👍（0） 💬（1）<div>没看出来rocketmq新复制原理和kafka复制原理的本质上区别</div>2020-12-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/e0/6b/f61d7466.jpg" width="30px"><span>prader26</span> 👍（0） 💬（0）<div>消息复制面对的问题：
1  高性能， 高可用， 消息的一致性 

 RocketMq 的消息的复制方式有主从模式， 之后又引入了Dledgy模式，即保证了性能，又有较高的可用性。

  kafaka 使用使用zookeeper 管理主节点。。。。数据管理的单元是，分区。</div>2020-12-07</li><br/><li><img src="" width="30px"><span>Geek_be0aff</span> 👍（0） 💬（0）<div>rocketmq异步复制时，主节点每次写入都刷盘再返回写入成功吗？？如果是这样性能太差了吧，如果不是，rocketmq主节点挂了，消息仍然可能丢失呢？
采用主从同步多写的方式，一般是从节点收到消息就返回成功？还是刷盘后返回成功？主节点回复客户端成功前，是刷盘还是不刷盘？</div>2020-11-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4a/80/9c038b01.jpg" width="30px"><span>AidenLiang</span> 👍（0） 💬（0）<div>老师，从节点和副本节点有什么区别，有时分不清楚</div>2020-08-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/e7/7a/5ab55e24.jpg" width="30px"><span>虫子💯</span> 👍（0） 💬（0）<div>老师你好，两个问题想深入了解一下，
1.kafka的broker没有主从，而是以分区为单位，一个broker有多个副本，这个意义何在？多副本不就是为了防止节点挂掉吗？一个broker的所有分区副本不就一直共存亡？
2.多副本对消费性能几乎无影响。对于exactly one模式来说应该影响较大？因为他要多数副本准确记录消费offset到哪了，所以这种情况下，多副本对生产和消费的性能都比较大对吗？</div>2020-08-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e2/21/840410d8.jpg" width="30px"><span>No ver</span> 👍（0） 💬（0）<div>确保数据一致性，必须采用“主 - 从”的复制方式，这个结论是有严格的数学论证的。
老师，我对这个数学论证很感兴趣，网上没有搜到相关的资料，老师可以提供一些论文资料之类的吗～</div>2020-07-08</li><br/>
</ul>