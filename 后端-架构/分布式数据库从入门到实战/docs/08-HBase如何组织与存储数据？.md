你好，我是彭旭。

上节课，我们分析了云服务的数据存储需求，了解了之前基于MySQL的分库分表支撑海量数据的存储与读写的过程。但是，因为硬件与运维上的巨大成本，我们不得不谋求一个新的存储方案。

这两节课，我们就一起学习HBase的架构和原理，看看HBase是怎么解决之前的问题的。

今天我们会聚焦在HBase组织数据的方式上，解决上节课提到的运维成本问题。希望通过这节课的学习，你能了解两个关键知识点。

1. HBase如何存储数据，给数据分区。在集群扩容的过程中，HBase自动迁移分区从而实现负载均衡的过程。
2. HBase物理上存储数据的方法，HBase集群包含的组件以及组件之间的协作方式。

## HBase数据组织的逻辑模型

使用一个数据库，第一步可以去理解它的数据模型，还有它的数据是怎么组织的。

HBase和关系型数据库一样，以数据表的形式组织数据。一张表包含多行数据，每行数据都由一个唯一的行键来标识。

数据在表中以行键的字典序排序，像这张图一样。

![图片](https://static001.geekbang.org/resource/image/13/18/1365a088c0a20dd9f863ff3b7fa31c18.png?wh=1280x361)

1. 行键类似关系型数据库主键，通过行键可以定位到一行数据。对HBase来说，通过行键来读取单行或者多行数据最高效。当然，它也支持基于行键区间的扫描。
2. HBase是一个宽列族存储数据库，数据按列族聚簇存储在一起。虽然HBase是列式存储数据库，但不建议一个表有多个列族。所以，在单个列族的情况下，基本上就跟行式存储类似了。
3. HBase建表的时候需要至少指定一个列族，但是不需要声明列。每一行数据都可以定义属于自己的列，也就是支持动态的Schema。但是每行的列不一定有值，所以HBase是一个稀疏表。
<div><strong>精选留言（4）</strong></div><ul>
<li><img src="" width="30px"><span>Geek_03c08d</span> 👍（2） 💬（1）<div>有个疑问，不建议多个列族，为什么还要设计多个列族这个东西？</div>2024-06-29</li><br/><li><img src="" width="30px"><span>Geek_03c08d</span> 👍（2） 💬（1）<div>在HBase中，列族（Column Family）是一个重要的概念，但通常建议一个HBase表尽量少使用多个列族，甚至只使用一个列族。原因如下：
存储效率和性能：
HBase中的列族是以HFile的形式存储在HDFS上的，不同的列族会被存储在不同的HFile中。每个HFile都有一定的存储开销，包括元数据、索引等。
当一个表有多个列族时，写入和读取操作会涉及多个HFile，增加了I&#47;O开销和复杂性，影响整体性能。
Compaction（合并）开销：
HBase定期执行合并操作，将多个小的HFile合并成一个大的HFile。多个列族意味着需要对每个列族分别执行合并操作，这会增加系统的负担和延迟。
内存使用：
每个列族都需要维护独立的MemStore（内存存储），这会增加内存的使用量。如果表中有多个列族，每个列族的MemStore都需要占用内存，导致内存资源的分配更加复杂和紧张。
一致性和原子性：
HBase的写操作是以行级别为原子单位的，但这仅限于同一个列族内的操作。如果表中有多个列族，跨列族的写操作无法保证原子性和一致性，这可能导致数据的不一致性。
Schema设计复杂性：
多个列族的Schema设计和管理会更加复杂。维护多个列族的定义、配置和优化需要更多的工作量，增加了开发和运维的复杂度。

基于以上原因，通常建议HBase表尽量使用单一列族，除非有非常明确的需求和理由需要使用多个列族。在设计Schema时，应尽量简化列族的使用，以提升性能和简化管理。


以上回答来自gpt4-o</div>2024-06-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/30/c1/2dde6700.jpg" width="30px"><span>密码123456</span> 👍（1） 💬（1）<div>由于不同的列族存储在不同的文件，是不是担心跨文件读取数据？</div>2024-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/31/1e/0a/159b2129.jpg" width="30px"><span>lufofire</span> 👍（0） 💬（1）<div>思考题感觉本身有点奇怪了。先说疑问：
本文中说过，HBase 的数据模型非常灵活，你可以按需为每行数据定义不同的字段，即使定义了较多的列，只要列没有实际存储数据，就不会占用存储空间， 所以HBase使用的稀疏表， 这个表结构适合存储那些列数非常多但每行只有少数几个列实际有值的场景。而为什么会有列族的概念呢？这是因为列族内的列通常具有相似的访问模式和存储需求。列族在创建表时就需要定义，并且在物理上存储在一起。 这样就会有一个实际场景的矛盾，假如我们业务有很多列， 但是其访问模式差异很大，这该如何处理呢？

回到这个问题，为什么HBase表不建议多列族？ 因为列族创建可能是存储需求的不同，所以通常列族存储在不同的HFiles中， 如果有多个列族，那么对于每一次读取操作，HBase可能需要打开多个文件来获取数据，这会增加磁盘I&#47;O，降低读取性能。另外就是不同HFiles本身意味着每个列族有不同的Memstore， 这个也就意味着更耗内存。最后就是因为HBase本身就存在写放大的问题， 多个列族的合并操作，势必带来更复杂的管理。</div>2024-06-28</li><br/>
</ul>