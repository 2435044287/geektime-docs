你好，我是彭旭。

当前数据库都使用硬盘来持久化存储数据。市面上的硬盘主要分为SSD固态硬盘和HHD机械硬盘。其中，SSD固态硬盘读写性能高，但是价格贵，传统关系型数据库用得比较多。

大数据、分布式存储由于数据量大，使用SSD硬盘会导致存储成本过高。所以，大多数分布式存储引擎，比如HDFS都使用HDD机械硬盘作为数据节点的存储设备。

那么问题来了，HHD的读写性能可不像SSD那么高。数据如果排序后存储在数据文件里，直接更新的时候，可能会涉及磁盘的随机IO，使用HDD硬盘会导致性能问题。

那么，这些存储引擎怎么才能在使用机械硬盘存储的情况下，解决更新数据可能需要随机写入，导致性能不好的情况呢？

在大数据领域，针对数据存储出现了很多用来优化随机读写或者说平衡读写性能的技术，从文件的组织形式来说可以分为两种。

第一种，**Copy-On-Write。**这个类似Java并发编程里面的CopyOnWriteArrayList，数据新增、更新、删除的时候，会去找到数据应该归属的文件，将这个文件用最新的内容覆盖后重写一个新的文件。

这种模式对读非常友好，读取的时候只需要读取最新的文件即可得到最新的内容。但是写入的时候成本很高。因此，它适合写入不多，读取频繁的场景。
<div><strong>精选留言（6）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/15/6f/65/26f998b2.jpg" width="30px"><span>zheng</span> 👍（7） 💬（1）<div>朋友圈存储可能以看的人为key，也可以以发的人为key。A发的B看。
把A发的一起存在文件a的话，B刷的时候就需要查询所有朋友（ABCDE）发的在以时间线合并。这样肯定是随机读。好处是写的性能高。
如果把B能看的存一起的话，那看的时候就拿自己的文件就行，顺序读。但是如果A删除了或者更改权限，那就复杂一些，但这是低频操作</div>2024-06-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4a/6f/e36b3908.jpg" width="30px"><span>xzy</span> 👍（3） 💬（1）<div>思考题：当一个人发朋友圈时，这个朋友圈的信息会被写入其每个好友的收件箱中；然后每个人读取自己的收件箱就可以看到自己好友发的所有的朋友圈内容了。

老师有没有兴趣讲讲timeline数据库的设计。</div>2024-06-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/4a/35/66caeed9.jpg" width="30px"><span>完美坚持</span> 👍（1） 💬（1）<div>### 微信朋友圈的写扩散模型

在微信朋友圈的设计中，写扩散模型被广泛应用以提升读取性能。这种模型的核心思想是，当一个用户发布朋友圈时，系统会将这条朋友圈的信息写入每个好友的收件箱（或时间线）。这样，每个用户在查看朋友圈时，只需读取自己的收件箱，避免了大量的随机读操作。以下是详细解释：

#### 基本思路

- **以发的人为主**：
  当用户A发布一条朋友圈时，这条信息会被写入一个存储单元，该单元以A为key。这种方法写入效率高，但读取时需要合并多个用户（朋友们）的数据，导致大量的随机读。

- **以看的人为主**：
  当用户A发布一条朋友圈时，这条信息会被写入每个好友B、C、D等的收件箱中。这样，当B查看朋友圈时，只需顺序读取自己的收件箱即可。这种方法优化了读操作，减少了随机读。

#### 实现细节

1. **发布时写扩散**：
   - 用户A发布一条朋友圈，系统将这条信息异步写入每个好友的收件箱。
   - 由于朋友圈不需要实时呈现，异步写入可以减少发布操作的延迟。

2. **读取时顺序读**：
   - 用户B查看朋友圈时，只需顺序读取自己的收件箱，获取好友们发布的所有朋友圈内容。
   - 这种方式优化了读性能，因为顺序读比随机读更快。

3. **删除和权限变更**：
   - 如果用户A删除了一条朋友圈或修改了其权限，系统需要更新每个好友的收件箱。
   - 由于删除和权限变更是低频操作，虽然这种操作复杂，但整体影响较小。

### 优缺点分析

#### 优点

1. **提升读性能**：
   - 通过将发布的朋友圈信息写入每个好友的收件箱，用户在读取时只需顺序读取自己的数据，从而大大提升了读取性能。
   
2. **简化读操作**：
   - 每个用户只需读取自己的收件箱即可看到所有好友的朋友圈，避免了从多个存储单元中读取数据并合并的复杂过程。

3. **减少随机读**：
   - 顺序读取用户的收件箱可以显著减少磁盘的随机读操作，提高读取速度和系统性能。

#### 缺点

1. **写放大**：
   - 每次发布一条朋友圈，都需要将信息写入多个好友的收件箱，导致写操作的放大。这会增加系统的写入压力，并可能影响存储介质的寿命。
   
2. **数据一致性复杂**：
   - 删除或修改朋友圈信息时，需要同步更新每个好友的收件箱，增加了数据一致性的复杂性和维护成本。

3. **存储空间**：
   - 由于每条朋友圈信息需要在多个好友的收件箱中保存副本，存储空间需求较大。

</div>2024-07-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/30/77/2a/0cd4c373.jpg" width="30px"><span>-Hedon🍭</span> 👍（1） 💬（1）<div>Copy On Write 读取的是旧数据还是新数据？</div>2024-06-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/2e/c5/231114ed.jpg" width="30px"><span>Hadesu</span> 👍（2） 💬（1）<div>lsm提升读性能的做法比本文介绍的更加复杂。</div>2024-06-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/4a/35/66caeed9.jpg" width="30px"><span>完美坚持</span> 👍（0） 💬（0）<div>总结
微信朋友圈的写扩散模型通过在发布时将数据写入每个好友的收件箱，优化了读取性能。这种设计在读取操作频繁的社交网络场景中非常有效，但也带来了写放大和数据一致性管理的挑战。整体上，这种模型在提升用户体验和系统性能方面表现出色，尽管需要在存储空间和写入压力方面进行平衡。</div>2024-07-07</li><br/>
</ul>