你好，我是任杰。今天我们进入第一个模块：金融业务及系统。

通过这个模块，我会带你了解常见的金融业务有哪些，盈利模式又是怎样的。了解了业务端的规律，我们就可以沿着这个线索推导出相应的系统核心需求以及具体组件，推测出相对应的系统设计要点。有了这些铺垫，后面我们动手去设计金融架构的时候，你的思路就会更加清晰。

金融业务有很多种，按业务模式划分，包括交易类业务和信贷类业务两种。今天是课程的第一讲，我想带你了解一个标志性的交易类业务，也就是扫码支付。

虽然扫码支付非常普遍，但是它并不简单。把这个内容安排在第一讲，我有这样三点考量：

第一，是扫码支付最具有代表性，扫码支付是现在最常见的金融场景。

第二，传统银行业务的标志性机构大多都参与到了扫码支付的过程当中，你可以通过扫码支付来了解国家金融系统的运作原理。

第三，是扫码业务同时具有互联网应用和机构应用的技术特点。扫码支付既要对接互联网用户，也要对接金融机构。你可以了解不同的架构设计思想和他们之间沟通的方式。

**总之，一旦你理解了扫码支付，也就在金融技术这个领域入了门。**现在就让我们从第三方支付出发，一起来探索扫了二维码之后发生了什么吧。

## 情景假设

扫码支付其实也分很多场景。但我们是不可能把所有的场景都讲一遍，我们在这里需要做更进一步的选择。一方面要典型，另一方面又要能给你多介绍一些参与机构。综合考虑后，我选择了与跨境电商相关的扫码跨境支付场景，具体的假设有这些：
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/13/05/bc/4fbab441.jpg" width="30px"><span>飞翔的企鹅</span> 👍（14） 💬（1）<div>我想知道银行的备付金不够会怎样？</div>2020-12-25</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/FoE5JTn2hmicRVXiatP2ibbe10CTbiassOskjkqDWaWZ4dDIw4Z9KMrALLPIkVfdIbLYB5ro4U7AQ0elPtVDibt31sA/132" width="30px"><span>Geek_74107b</span> 👍（11） 💬（1）<div>您好任老师，第一章就非常烧脑，但是让我更好的理解了比特币xrp之类的虚拟币跨国转账的价值，因为流程要简化太多了，交易即清算！
另外在这个场景里，我理解第三方支付可以看成一个银行间的中介，清算机构属于银行间的会计负责记账，央行作为一个完全中心化的背书机构，负责银行间的最终转账清算。
那我的疑问是，清算机构存在意义是什么呢？ 为什么不能让央行去兼容它的记账职责呢？ 是因为它是央行的“缓存”，为了减轻央行的压力？</div>2020-12-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/16/5b/83a35681.jpg" width="30px"><span>Monday</span> 👍（5） 💬（2）<div>小小的二维码支付，金融业务还真多。牵涉多个银行用户账户，多家银行。本节学到了不少的金融名词。</div>2020-12-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/db/ae/41b6c60b.jpg" width="30px"><span>三产</span> 👍（4） 💬（1）<div>老师，一般网上支付都会有每日限额，并且不同银行限额不同，这个是不是和存款准备金有关呢？
转账有手续费，是否也是因为转账会涉及清算机构，清算机构会收取一部分费用，而转账业务并不会为发起转账机构产生利益所以这部分费用需要用户自行支付呢？</div>2021-01-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/41/87/46d7e1c2.jpg" width="30px"><span>Better me</span> 👍（0） 💬（1）<div>老师您好，以下几个问题还不太清楚，希望老师解惑
1、一笔跨境交易中在本币代收的央行准备金调拨之前就发起了外汇交易会有什么影响吗？
按道理来说是会先用上第三方公司在汇兑提供行的人民币账户余额，但这里人民币账户的资金来源是买家账户。
2、央行准备金轧差的交易方式、外汇交易的时间成本对整个交易流程周期会有什么影响吗</div>2021-01-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/5d/6f/42494dcf.jpg" width="30px"><span>Jerry Wu</span> 👍（24） 💬（3）<div>虽然整个过程经过简化，但我还是有些懵。好在回答完思考题，思路清晰了些，请老师指教。

作为第三方支付公司，该怎么降低汇兑成本？

首先，第三方支付公司的业务仅限于一个国家，那只能在现有的交易流程优化。

比如，你的支付服务只在中国能用，中国客户转账到国外，却没有国外客户转帐进来。那么，你只能老老实实走外汇交易的流程，但也是能降低汇兑成本的。

你可以低价买一大笔外汇，降低汇率、时间、交易等风险；又或者找投资银行，让他们用掉期合约规避你的汇率、交易、库存等风险；再或者，转账机制能不能优化，像是最低金额、到账时间之类的。

然后，第三方支付公司有多国业务，那自建资金池能进一步降低成本。

比如，你的支付服务中美两开花，中国客户转账到美国，美国客户转账到中国。那么，你可以建两个资金池，一个装人民币，一个装美元。如果发生转账，你划上两笔，一笔划在中国资金池上，一笔划在美国资金池上。

如果走到这一步，原有的交易流程就被简化了，你可以看看这个例子。

假设汇率是 7，有 A 客户转 700 人民币到美国，那么你只需要在 A 客户的账上减去 700 人民币，你的人民币-资金池增加 700，美元-资金池减少 100。与此同时，有个 B 客户要转 100 美元到中国，那么 B 客户的账上减去 100 美元，你的美元-资金池增加 100，人民币资金池减少 700。

在这个例子中，你把这两笔交易结合起来看，会发现一个有趣的现象。人民币-资金池先增加 700，然后又减少 700；美元-资金池先减少 100，然后又增加 100。换句话说，你两个资金池里的钱不增不减。

这样一来，你相当于踢开了外汇市场，自己就能走完中美转账的流程。当然，资金池的花样很多，现实也没这么理想，你还是离不开外汇市场，但也够你省下一大笔，给员工买辣条了。

综上所述，如果第三方支付公司的业务仅限于一国，要降低汇兑成本，可以买一大笔外汇，找投资银行，优化用户转账机制；如果第三方支付公司的业务遍布多国，要进一步降低汇兑成本，可以自建资金池。</div>2020-12-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/be/03/404edf37.jpg" width="30px"><span>小动物</span> 👍（7） 💬（0）<div>尽可能自建资金池，不在用户交易时进行兑换，直接使用池子中的资金。同时资金池在满足业务的情况下尽可能的最大化，，，类似股票里的高抛低吸。</div>2020-12-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7b/98/8f1aecf4.jpg" width="30px"><span>楼下小黑哥</span> 👍（2） 💬（0）<div>因为限定了交易费用跟交易数量有关，所以为了减少费用就需要减少汇兑次数。
第一，发生汇兑的时候 ，仅记录信息流，日终的时候计算需要汇总总金额，再去真正汇兑。
第二，既然存在两个方向的互相汇兑，那么两边账户都有相应的资金。
那如果里面资金足够代付，那其实无需汇兑。举个例子
假设当前人民币账户余额100w，美元账户100w。而当天如果仅需要美元账户代付50w，那么这个时候都无需购汇，直接使用账户内余额即可
</div>2020-12-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4f/19/05834ca2.jpg" width="30px"><span>aderm</span> 👍（2） 💬（0）<div>第三方支付公司可以无限建立外汇资金池，只有当发生外汇资金池钱不够时，才和外汇提供商进行一次大额交易。同时存在双向外汇交易，也就能保证外汇资金池波动变小</div>2020-12-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8e/bb/c039dc11.jpg" width="30px"><span>garlic</span> 👍（2） 💬（0）<div>参考日间交易，日终轧差模式， 轧差后再进行外汇交易。 </div>2020-12-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/4f/3b/e1f67cc2.jpg" width="30px"><span>wulab</span> 👍（1） 💬（0）<div>降低汇兑成本的想法不知是否可行
  1.  敞口管理风险管控
  2. 传统的建模往往需要专业的算法人员进行业务理解，可以基于预测智能化的形式来做交易量预测、资金流动性管控，降低外汇购汇成本
</div>2021-02-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/7b/26/67157c40.jpg" width="30px"><span>Ellie</span> 👍（1） 💬（0）<div>首先在本币和外币账户上储备足够的资金，进行本、外币内部流动，并在两个账户设定触发汇兑的阈值，当外币账户余额低于阈值时购买一定数额外币，当本币账户余额低于阈值时卖出一定数额外币，可以监控外汇买卖交易频率，优化本、外币账户的汇兑阈值。</div>2021-01-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/4c/c0/73d52c05.jpg" width="30px"><span>落落彩虹</span> 👍（0） 💬（0）<div>第一节课，知识点就这么丰富嘛。。</div>2024-06-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/f5/97/9a7ee7b3.jpg" width="30px"><span>Geek4329</span> 👍（0） 💬（1）<div>老师，现在有一点比较迷惑。我从体验上来看，现在用支付宝支付好像都不需要验证码，验证码比较多的是用在银行自己的app。</div>2023-11-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/ef/4d/83a56dad.jpg" width="30px"><span>Z.</span> 👍（0） 💬（1）<div>我有一个问题,比如秒杀之类的问题,如果需要不断轮询查询状态的话,那如果同一时间多个用户支付,多个用户不断轮询,最后超卖了,那是以支付时间为准,还是以最后轮询得到的支付成功的时间为准来匹配用户的订单,假如是因为银行方或者是第三方的原因导致的很晚才收到这个结果,那这笔秒杀还算成功吗 </div>2023-07-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/18/5e/abb7bfe3.jpg" width="30px"><span>哈哈哈哈哈哈哈哈</span> 👍（0） 💬（0）<div>有什么相关偏业务的书推荐吗老师</div>2022-08-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/84/19/7ed2ffa6.jpg" width="30px"><span>风</span> 👍（0） 💬（1）<div>老师，每天晚上才进行储备金转账，但是我看实际生活中，跨行转账可以当天完成的呀，麻烦老师帮忙解惑</div>2022-07-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/84/19/7ed2ffa6.jpg" width="30px"><span>风</span> 👍（0） 💬（0）<div>最后通过央行进行一笔跨行转账就可以了。这种计算交易差额的方式叫做轧差。
每天跨行转账的业务很多吧，每天晚上把这些支付汇总成一笔支付指令，是只需要汇总总额从买方开户行备用金账户打款到第三方开户行，第三方开户行根据记录将总额打到第三方公司的账户吗？</div>2022-07-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/84/19/7ed2ffa6.jpg" width="30px"><span>风</span> 👍（0） 💬（1）<div>然后是第五步，第三方开户行记录的结果是对第三方支付公司的账号进行打款。打款结束后第三方支付公司可以通过银行网页看到对公账户金额发生变化。白天的工作到此结束。此时买家开户行的账面上的资金虽然减少，但是减少的钱并没有实质性到达第三方开户行。
1、这个打款结束只是扣减买方账户的余额吗？这个时候第三方通过银行网页是可以看到自己的账户金额增加，但是钱还没有实际到第三方的账户吗？
2、第三方开户行准备金收到钱之后，再从准备金账户将款打给第三方支付公司的账户？</div>2022-07-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/6a/3d/0529b877.jpg" width="30px"><span>stonejianbu</span> 👍（0） 💬（0）<div>解：
既然汇兑提供商的收费只和交易数量有关，明显的解决方案是少次多兑，管理多种币的资金池
但是考虑到汇率是变动的，各种币的资金池积压而没能资金最大化使用
所以还要权衡市场汇率变动的因素以及自身汇兑业务量
如果有政策限制原因还得做相应调整等等
最后根据自己情况来决定每次汇兑量以进一步降低汇兑成本。</div>2022-05-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6b/1b/4b397b80.jpg" width="30px"><span>蛮野</span> 👍（0） 💬（-1）<div>清算机构作为第三方负责记录这些信息，并通知买家开户行和第三方开户行记录这笔转账。
这个操作非原子性，中间需要分布式事务处理机制吗</div>2021-12-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ba/ce/fd45714f.jpg" width="30px"><span>bearlu</span> 👍（0） 💬（0）<div>老师。会不会存在第三方机构。存在多个银行账户，交易的时候就不需要跨行转账？</div>2021-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/9c/6e/01b4d5d2.jpg" width="30px"><span>liupan</span> 👍（0） 💬（0）<div>目前在银行做金融，和转账也经常有关联，但更多的是关注银行内部的处理逻辑。感觉目前接触的扫码和刚刚读到的有一定差异，扫码很少外币场景，主要是做银行自身内部逻辑，因此流程上有所差异，银行与银行之间还有通道没有体现</div>2021-08-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/51/8b/e3b827b7.jpg" width="30px"><span>笨蛋小孩</span> 👍（0） 💬（0）<div>老师,这个情景中商户接受美元,买家如何确定该支付多少人民币啊?汇率转换的过程在哪一步完成?实在二维码生成之前就已经完成了吗</div>2021-07-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/90/67/106306e7.jpg" width="30px"><span>搞起来</span> 👍（0） 💬（0）<div>有没有课代表做个笔记分享出来</div>2021-06-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/90/67/106306e7.jpg" width="30px"><span>搞起来</span> 👍（0） 💬（0）<div>老师图用什么软件画的</div>2021-06-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/15/87/d22d8c3e.jpg" width="30px"><span>_你说了不算</span> 👍（0） 💬（0）<div>每天都在用扫码支付，原来每笔交易后藏着这么东西，这篇文章需要反复读一下啊。</div>2021-01-06</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erObO6EFRxGTiaJBt2RPf1Q7qveic9pQVAUuHX2jAia1eBtszk9ZHlXDibRMspkolacZ9A29YZ6Ga6jBg/132" width="30px"><span>Geek_fd2f7c</span> 👍（0） 💬（0）<div>汇兑提供行自己轧差成一笔然后进行</div>2021-01-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/50/5f/d10a39c4.jpg" width="30px"><span>glutton</span> 👍（0） 💬（1）<div>节省成本的话，是不是这样:
支付的人民币和外币也做一个日终轧差
最终只需要支付一笔人民币或者是外币，这样行不？</div>2020-12-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/50/5f/d10a39c4.jpg" width="30px"><span>glutton</span> 👍（0） 💬（0）<div>老师好，有个问题想讨论下:
备付金集中存管后，已经没有支付机构备付金银行了吧？
情景假设的第三点，是不是有点儿问题？</div>2020-12-28</li><br/>
</ul>