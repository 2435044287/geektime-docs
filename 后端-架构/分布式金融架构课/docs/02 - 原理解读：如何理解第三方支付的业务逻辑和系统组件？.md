你好，我是任杰。这节课我们聊一聊如何理解支付业务逻辑和系统组件。

在[上一节课](https://time.geekbang.org/column/article/323701)中，我已经从宏观角度带你梳理了扫码支付从前到后的整个流程。我们发现，虽然扫码支付是一个非常便捷的用户产品，但是它后面涉及到了很多的机构和业务流程。

你有没有好奇过，第三方支付公司是怎么解决这些复杂业务问题的呢？如果你在金融行业呆过一段时间，就会发现不只是扫码支付，其他的金融业务都很复杂。那我们有没有可能复用第三方支付的这些经验，来解决其他的金融业务问题呢？

和我们解数学应用题一样，要应对第三方支付这类复杂的业务问题，我们**首先要分析它里面的核心原理是什么。接下来尝试通过核心原理来推算出可能的规律。这些规律就决定了系统架构的演进规律**。如果你掌握了这些分析问题的方法，碰到其他复杂的金融业务问题时就能游刃有余地解决了。

所以，接下来我们先搞懂支付涉及的核心金融原理，然后按照架构由简到难的顺序，逐步学习点券系统、支付系统和第三方支付公司的支付系统。这样你就能理解支付系统是如何遵循核心金融原理，一步一步从简单的几个组件发展到全面的系统架构了。

## 信息流与资金流分离

我们都知道，作为架构师，我们在做架构设计的时候，需要确保架构原理和业务原理一致。每一行都有自己独有的业务原理，支付业务也不例外。
<div><strong>精选留言（27）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/19/bf/81/4c45a87b.jpg" width="30px"><span>LeeR</span> 👍（13） 💬（2）<div>之后能否详细讲下记账系统的记账方式和对账流程？</div>2020-12-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/5d/6f/42494dcf.jpg" width="30px"><span>Jerry Wu</span> 👍（10） 💬（5）<div>老师，文章里提到了两种支付系统，一种是点券，一种是第三方支付，但我前东家的支付系统有点奇葩，这该怎么划分呢？

前东家的支付系统只包含：业务系统，支付网关。业务系统负责生成交易订单；支付网关负责生成支付订单，转发给不同的第三方支付公司。至于内部资产管理、外部资产管理、金融网关之类的，则统统没有。

整个流程是这样的：业务系统，生成交易订单—&gt;支付网关，生成支付订单—&gt;第三方支付公司，接收支付订单—&gt;支付网关，接收第三方支付公司的回调—&gt;业务系统，接收支付网关的回调。

这整个过程中，业务系统、支付网关作用类似，就是发订单、接收回调确认订单状态，什么对账都没有。这种系统又算是什么呢？</div>2020-12-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/6b/b9/9b0630b1.jpg" width="30px"><span>Geek_9c3134</span> 👍（10） 💬（5）<div>热点账户怎么解决呢</div>2020-12-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/75/dd/9ead6e69.jpg" width="30px"><span>黄海峰</span> 👍（9） 💬（3）<div>支付宝就算是第三方支付公司吗？</div>2020-12-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/49/85/3f161d95.jpg" width="30px"><span>Alpha</span> 👍（8） 💬（1）<div>这一讲通俗易懂地讲解了支付系统的主要系统组件，获益匪浅。
比较好奇这些组件对应的官方英文翻译是什么？例如账务系统、清算中心、核算系统；网上找到些支付系统术语翻译 感觉差点意思。</div>2020-12-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7b/98/8f1aecf4.jpg" width="30px"><span>楼下小黑哥</span> 👍（6） 💬（1）<div>另外，第三方公司提供的 API 接口都是异步的。

老师，我觉得这点说的太绝对了。

我对接下来，一般来说收单支付，银行卡类接口都是同步返回支付结果。 像网银，支付宝&#47;微信支付这类网需要使用app&#47;网页跳转支付方式，这类都是异步。 
出金类接口，那都是异步的</div>2020-12-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/38/4c/5426e2e0.jpg" width="30px"><span>CJJ</span> 👍（4） 💬（1）<div>老师我有个地方不明白，跨行转账需要多家银行之间配合，还可能需要支付一定的跨行交易费用。但是如果第三方支付公司在每家银行都有资金池，为什么就可以直接在两家银行内部完成用户资金和资金池资金之间的操作了？在每家银行的资金池不是独立的么？两家银行资金的操作不也是跨行交易吗？</div>2021-02-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/24/b5/c62b9027.jpg" width="30px"><span>夜猫~_~</span> 👍（2） 💬（1）<div>老师，外汇汇率是实时变动的，那跨境结算时付款金额也是实时计算的吗？</div>2020-12-24</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/VTPuhJb5xxuRwH1iblqrAe3De4PoETgNWibZRkLlhvszysdtpAvSPZFuYtsJfWJmoXOFFWnpR02W9NGIiammU8UPg/132" width="30px"><span>Info_E</span> 👍（1） 💬（1）<div>花了一下午的时间，连读两篇，对支付相关名词和支付系统包含组件有了初步认识，感谢大佬！</div>2021-02-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/5d/6f/42494dcf.jpg" width="30px"><span>Jerry Wu</span> 👍（1） 💬（1）<div>老师，一个转账系统，如果用户要先打钱到我们的公司账户获得余额，然后才能用余额转账，这样算不算是资金池呢？

我碰到过的一些小公司就是这么做的，他们解释说这和充Q币差不多，不算非法资金池。但我总觉得其中有问题，希望老师解答。</div>2020-12-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/50/5f/d10a39c4.jpg" width="30px"><span>glutton</span> 👍（1） 💬（1）<div>老师好，还是备付金的问题，备付金集中存管后，第三方支付机构已经不允许有资金池了，建议说明</div>2020-12-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/6b/b9/9b0630b1.jpg" width="30px"><span>Geek_9c3134</span> 👍（1） 💬（2）<div>老师 有什么书可以推荐吗</div>2020-12-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/bc/25/1c92a90c.jpg" width="30px"><span>tt</span> 👍（49） 💬（3）<div>所有的商业模式都是由三种基本的“流”组成的：信息流、资金流和物流。金融系统或者说支付系统主要处理前两者，直接对应支付订单；对于物流，间接地通过交易订单体现出来。对于普通机构，比如电商，物流就是真实的商品或者服务；而对于金融机构，物流蜕变成了资金。普通机构或者说C端的资金流动由背后的商品或服务交易做支撑；金融机构或者说B端的资金流动也是由各种交易——金融交易做支撑，进行这种交易的权利体现成各种牌照，在义务上体现为接受强制的监管，从而达成权利和义务的平衡。下面只谈对于信息流和资金流的思考。信息和资金本是一一对应的，但由于具有不同的特点，在流动的过程中开始分离，就像不同密度的流体，在流动的过程中形成了分层那样。信息流和资金流，都体现成数字流。在这里的语境下：l信息流可以体现为一笔一笔的流水，是一个增量的数据，就像顺序读写文件那样，速度比较快；“一笔”信息流天生就是不可分割的，即原子的，要不记录成功了，要不记录失败了，不可能有中间状态。l资金流是在两个实体之间流动，造成的结果是双方账户余额的变更，本质上是对存量数据的修改。资金流动完成的前提是先修改一方的状态，再修改另外一方的状态，天生就不是原子的，需要事务系统进行保证，尤其是在系统规模十分庞大的情况下，十分容易碰触到分布式事务。l上述两点的本质是信息流和资金流的影响范围不同，造成了资金流和信息流的分离。此外，还有外部约束也造成了二者的分离，比如处理资金业务需要特定的资质。l既然资金流也是数字流，所以在一定的范围内，也可以转变成信息流，由信息系统进行处理。或者说一个“很长的”资金流可以在一定的前提条件下被分割成一个一个较短的资金流（这样在小系统内就可以比较容易的对应信息流），然后由某种设施将这些“子资金流”衔接起来，这个特殊的设施就是“网关”：可以是支付网关、也可以是金融网关。就像计算机网络那样，网关用来处理不同的协议转换、安全校验或者路由；金融网关也实现了二进制协议的对接，比如证书签名、加解密、协议传输、数据校验等，还有路由过程。l根据局部性原理，范围越小，效率越高、性能越好。金融系统也不例外，把“长资金流”打散成“子资金流”后，链条上的某个节点中信息流和资金流更容易保持一致，这样提高了效率，体验自然就好了，比如资金池就可以把更多的资金流限制在自己的系统内，省去了调用网关的开销。从技术上将，就是将跨越多个节点的事务变成本地事务。同时，资金流的成本大于信息流的成本，局部性使得资金可以减少流动，只需要记一笔账就可以了，即用低成本去代替高成本。其实系统的架构就可以按照上述的视角进行分类分析。支付架构的核心原理，是处理内部信息流与外部资金流系统的异步交互，我的理解，是在保证正确性的前提下，尽量将两者的影响范围做局部化的处理。1、点券系统，资金流和信息流是一致的，本质上是因为涉及到的资产具有某种“同质性”，所以可以放在一个池子里，由点券系统统一操作。这样二者具有了一致性。从技术的角度看，在规模小的情况下，甚至只用一个数据库就搞定了。2、支付系统。资金流涉及的银行卡是一种“异质资产”——它属于银行，无法将其放在自己的“势力范围”内了，所以必须调用金融网关。金融机构为了应对用户操作的峰值，用异步消息处理架构，所以网关上调用的API接口往往是异步的。如果银行做的是行内转账，它仍然是一个“点券”系统，只是点券变成了这个银行内部的资金。此时信息流和资金流一进出现了分离，所以还需要保证它们状态的一致性（最终一致性），这就是对账，这时引进了核算系统。3、第三方支付系统。第三方支付系统本质上就是一个大网关，这里网关从一个“组成部件”变成了独立部件，对接外部系统从手段变成了目的本身。它处理的是纯粹的信息流，但衔接的是纯粹的资金流，资金通过它从一方流动到另一方。为了提高效率、降低成本，第三方支付公司建立了资金池，尽量减少资金的流转，增加信息的流转。本地消息的流转，用本地事务就可以解决。在降低成本的同时，也提高了用户的体验。4、跨行转账也是利用了资金池，这样资金的流转在结算结构本地就可以完成。在必要时，做一笔大的转账对备付金账户进行调整就可以了，相当于“少量大笔资金流转+大量信息流转=大量小笔资金流转”。5、资金的流动一定会触发信息的流动，但是反过来则不一定了。信息局部流动，对外部来说就变成了一个黑盒子，对于监管是不利的。思考题。此时可以建成资金池。目的是降低成本、提高效率和客户体验。那么买家用人民币支付的资金可以直接放入跨行的虚拟人民币资金池。此时相当于是买方向第三方支付机构购买了美元，这笔费用也进入资金池。再三方支付公司购买外汇时，利率可能不一样了，有一个时间窗口，可以充分利用它。有了美元资金池以后，需要增加国际清洁算的金融网关。</div>2020-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c4/a8/f2685e1b.jpg" width="30px"><span>华仔</span> 👍（43） 💬（1）<div>这篇解读的真好，我第一次接触支付业务的时候，被这一大堆概念绕晕了，也没有好的资料来介绍（蚂蚁内部都没找到[捂脸]），花了好大劲才逐步理清。所以说既能干活又能讲课的牛人太难得了👍👍</div>2021-01-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/a0/a3/8da99bb0.jpg" width="30px"><span>业余爱好者</span> 👍（13） 💬（1）<div>我发现，赌场里的筹码也是信息流与资金流的分离。</div>2021-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8e/bb/c039dc11.jpg" width="30px"><span>garlic</span> 👍（3） 💬（0）<div>支付宝的余额宝，微信的钱包类似点券的系统，处理简单快捷， 支付机构给的电商提供支付系统，内部通过金融网关连接银行（国内网联，银联）实现资金划转。支持外汇业务的话， 增加境外支付网关，接入支持境外收单机构，卡组。境外业务金融网关，连接境外发卡行；清算服务，对接汇率查询机构，新增处理外汇业务相关业务。  </div>2020-12-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/d4/df/10e2c4d3.jpg" width="30px"><span>月半纟氏</span> 👍（1） 💬（0）<div>请问第三方支付系统是第三方支付公司的支付系统吗</div>2021-10-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/b2/e0/d856f5a4.jpg" width="30px"><span>余松</span> 👍（1） 💬（0）<div>1.资金流和信息流的分离就是最终一致性的典型实现。
2.券系统虽然不用与外部系统交互，但是由于大部分时候业务场景有混合支付的需求（部分使用快捷支付、银行卡支付，部分使用点券），为了保持与支付系统的一致性。通常使用TCC来保持一致性。
3.备付金账户有点类似于类似于write back中的缓存：银行相当于磁盘，第三方支付公司的虚拟账户相当于页缓存PageCache。</div>2021-05-19</li><br/><li><img src="" width="30px"><span>sotondolphin</span> 👍（1） 💬（0）<div>对账这个步骤是每个支付系统必须有的，不仅和第三方要对账，和金融管理系统也要对账</div>2020-12-25</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoWfXendN7czHpsyaWKLPK6Na9P5czquJ7Wdre4TibZQ5SQib88edyuib3LpCVFkp0gII2wyvvR8tEIA/132" width="30px"><span>OM</span> 👍（0） 💬（0）<div>老师，跨境银行之间是有一个公共的支付系统进行管理，核心模块有哪些?</div>2025-01-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/4c/c0/73d52c05.jpg" width="30px"><span>落落彩虹</span> 👍（0） 💬（0）<div>mark，值得多次阅读。</div>2024-06-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/20/52/23/b3551be1.jpg" width="30px"><span>通天白鼠</span> 👍（0） 💬（0）<div>最终那张图中，清算中心的上游是账务系统，下游是支付网关。可不可以这样理解，涉及到第三方支付中心自由资金池和清算系统，那么初始从网关发给外部资产管理系统的信息，并不会先走金融网关，而是当作支付成功，发送给账务系统，然后清算系统根据账务系统的结果进行结算，最终的结果应该是发送给外部资产管理系统，或者也可以直接发送给金融网关吧，为何图示里清算系统的下游是支付网关呢。按照理解支付网关应该是和具体的支付业务关联的。</div>2021-10-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/9c/6e/01b4d5d2.jpg" width="30px"><span>liupan</span> 👍（0） 💬（0）<div>感觉目前看到只是一些比较粗的概念，可能是目前工作实际接触的分类比较细化吧，另外也可能是站到行外的角度和行内的角度本来也就是不一样的视角</div>2021-08-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/bb/11/28d86278.jpg" width="30px"><span>人月聊IT</span> 👍（0） 💬（0）<div>问题：
业务解决：资金池（参考国家外汇储备）
实际落地：外汇中心</div>2021-04-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/16/5b/83a35681.jpg" width="30px"><span>Monday</span> 👍（0） 💬（1）<div>感觉最终还是理解了多个资金池怎么避免跨行的手续费。
因为变成两个同行转账，只是涉及的2个资金池里的钱一个增加一个减少</div>2021-01-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/16/5b/83a35681.jpg" width="30px"><span>Monday</span> 👍（0） 💬（0）<div>如果流量再高，还可以选择熔断降流等手段来进行服务降级。

老师，这里的“降流”可以理解成“限流”吗</div>2021-01-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/be/03/404edf37.jpg" width="30px"><span>小动物</span> 👍（0） 💬（0）<div>能想到增加的动作为汇率计算。但这动作应该外部资产管理就已经可以处理了，或者说属于这个系统的子模块处理。</div>2020-12-23</li><br/>
</ul>