你好，我是任杰。这一讲我想和你聊一聊如何在运行时进行数据系统分库。

如果你需要进行数据系统分库，那么恭喜你，你的业务量又上了一个新的台阶。但是随之而来也有一个坏消息，那就是分库的过程想做得好的话会很困难。如果做得不好，可能你在每次集群的扩容前，都需要暂停业务，这样会带来一定的经济损失。

所以，为了解决这个问题，我们今天就来学习一下怎么做动态扩容。

## 支持分库功能的架构目标分析

在我们学习如何实现动态分库之前，先来看看我们的设计目标是什么。

最原始的分库方法是先将业务暂停，这样就不会有人修改数据系统。接着要完成数据系统备份，以防出错后回滚所有操作。然后按照预定的逻辑将数据切分到不同的机器上。如果测试结果没问题，那么就重启业务。

虽然这个方法清晰简单，但是带来的问题是业务需要暂停很久的时间。这个过程的示意图如下：

![](https://static001.geekbang.org/resource/image/02/e0/027a86710ecc6c79691yy6f91c8a01e0.jpg?wh=2520%2A365)

所以，分库并不是一个不能解决的问题，只是我们希望分库的时间越短越好。那前面说的这几个步骤在时间上还能不能再优化一下呢？其实也是可以的。

数据系统一般都会提供一个异步备份的容灾配置，你可以多备份一台机器。虽然这台备份机并没有所有数据，但是大部分数据都在，所以当你把业务系统停掉之后，只需要把备份机和主机之间的差别补全就可以了。
<div><strong>精选留言（3）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/16/bc/25/1c92a90c.jpg" width="30px"><span>tt</span> 👍（3） 💬（0）<div>集群A接收并执行分库命令的结果是改变集群 A 能处理的消息类别，也就是改变集群 A 的内部配置。从此以后集群 A 将不能再处理今后属于集群 B 处理的事情。

这个改变内部配置的操作是幂等的，收到多次这样的指令，只要和自己内部维护的状态比较一下，如果已经处于这样的状态，跳过应该就行了。</div>2021-02-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/3d/39/b8cb3f44.jpg" width="30px"><span>悠然。</span> 👍（0） 💬（0）<div>可以分两种情况来分析
1. 假设集群 A 在收到开始分库的消息之后，所执行的改变内部配置操作是幂等的，此时两次操作对集群A和集群B来说，两次操作后所能处理的事件还是一样的，不会影响正确性
2. 假设集群 A 在收到开始分库的消息之后，所执行的改变内部配置操作不是幂等的，此时两次操作之后集群A和集群B所能处理的事件不一样了。
  a. 对集群A来说，在第一次处理分库消息和第二次处理分库消息之间的消息，集群A可以正常处理，在第二次收到分库消息之后的消息，可能会被重定向到B
  b. 对集群B来说，在第一次处理分库消息和第二次处理分库消息之间的消息，可能会存在正常集群B收到的消息和集群A在处理完第二次分库消息之后重定向过来的消息，此时集群B正常收到的消息可以正常处理，但是集群A重定向过来的消息会被再次重定向回集群A（集群A由于也无法处理，还是会被重定向回B）。在第二次收到分库消息之后的消息，集群B可以正常处理被集群A重定过来的消息，同时集群B原本收到的消息可能会被重定向到集群A

综上分析，在两次分库消息幂等的情况下，一定可以保定正确性；在两次分库消息非幂等的情况下，消息可能会被多重定向几次，但是在集群B也处理完第二次分库消息之后，消息可以被正确处理，此时也可以保证正确性</div>2021-02-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f9/e6/47742988.jpg" width="30px"><span>webmin</span> 👍（0） 💬（0）<div>集群A在处理命令时有幂等性机制来保证，所以不会影响分库过程的正确性。</div>2021-02-05</li><br/>
</ul>