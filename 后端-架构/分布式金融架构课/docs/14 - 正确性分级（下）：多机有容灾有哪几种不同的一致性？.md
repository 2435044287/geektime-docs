你好，我是任杰。这一讲我想和你聊一聊，在多机有容灾的情况下怎么保证一致性。

在前面两节课里，我们已经学习了在没有容灾的情况下，如何在单机和多机的情况下保证数据一致性。由于没有容灾，每一份数据只会出现在一个地方，因此我们可以集中对所有数据访问进行控制。

但是，我们在搭建架构的时候一定会对数据进行容灾，会将数据复制到多个地方，这时候就会出现数据访问不一致的问题。

这种情况下前面两节课的内容就不适用了，我们需要用新的理论来分析所有会出现的问题。首先让我们来看一下我们“看起来熟悉”的CAP的理论。

## 为什么不要用CAP来描述一致性的选择？

CAP由三个性质组成：一致性（Consistency）、可用性（Availability）、分区容错性（Partition tolerance）。其中，分区容错性指的是网络出现了问题，把原本通过网络连接在一起的机器分成了几个独立的部分，也叫作**脑裂**。

首先我来说说CAP第一个容易让人误解的问题。我们会觉得CAP这三个性质不能同时拥有，最多只能有两个，那么三选二之后，排列组合一共有三种选择，分别是CA、CP和AP，其实这个理解是错误的。

CAP真正的假设是当出现了脑裂后，你只能在一致性和可用性当中选择一个，从而放弃另一个。也就是说你只能选择CP或者AP。在一些早期的文章中你还能看到这个常见的错误。所以CAP并不是像下面这幅图左边展示的三选二，而是像右边展示的那样二选一：
<div><strong>精选留言（5）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/16/bc/25/1c92a90c.jpg" width="30px"><span>tt</span> 👍（2） 💬（2）<div>严格可串行化，包括线性一致性和可串行化，那是不是要从这两个方面出发进行考虑。

可线性化非常依赖各个并发操作发生的时间点，所以它的实现是不是需要一个单一的时钟源，用于比较各个操作的顺序。

可串行化就是按照课程里讲的，依赖于单体的数据库的锁来实现？
</div>2021-01-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/16/48/01567df1.jpg" width="30px"><span>郑泽洲</span> 👍（4） 💬（0）<div>在极客上几年下来学了20多门了，正巧王磊老师的《分布式数据库30讲》有课也是讲同样的知识点。不得不说，还是王磊老师说的比较清楚：
1. 举了小明和小红发朋友圈这样生动的例子，比干啃理论效果要好点。
2. 五个一致性讲解排列地好，是层层递进的关系，是路线图。
3. 极客时间的典型学习场景是什么？是996的职场人士利用有限业务时间的学习。建立他们头脑中大场景和路线图，比深挖某个知识点要更重要，通俗地说，就是给张地图，扫清迷雾，引起兴趣，至于某个点上有没有深挖三尺，显示老师深厚功力，我觉得只能是第二重要，感兴趣的学生自己会去深挖的。
就事论事。任杰老师这课的领域驱动设计和时序数据库等还是非常值得一读的。感谢极客时间各个老师的努力。希望学习能更生动有效。</div>2021-12-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/b2/e0/d856f5a4.jpg" width="30px"><span>余松</span> 👍（2） 💬（0）<div>感觉老是对于可串行化和可线性的概念没有说得特别清楚。
可线性化与可串行化，两者可以重叠
* 可线性化：让分布式系统看起来只有一个数据副本，所有的操作都是原子的
* 可串行化：事物虽然在并发运行，但是结果单串行单独运行一样</div>2021-03-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/81/b9/7113d4c9.jpg" width="30px"><span>听风</span> 👍（0） 💬（0）<div>依赖一个统一的逻辑时钟，才能做到了可串行化。具体实现的话，比如分布式锁都是可能的实现手段</div>2021-02-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f9/e6/47742988.jpg" width="30px"><span>webmin</span> 👍（0） 💬（0）<div>分布式环境下的严格可串行化，需要所有节点保持无间隙单调递增操作序号，各节点间通过消息广播同步操作，每个消息中包含操作序号，例如：A节点当前完成消息序号为14，这时收到序号16的消息，那么在回复16消息之前必须等到消息15。</div>2021-01-26</li><br/>
</ul>