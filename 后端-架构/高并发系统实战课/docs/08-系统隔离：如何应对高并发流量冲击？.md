你好，我是徐长龙，今天我想跟你聊聊如何做好系统隔离。

我曾经在一家教育培训公司做架构师，在一次续报活动中，我们的系统出现了大规模崩溃。在活动开始有五万左右的学员同时操作，大量请求瞬间冲击我们的服务器，导致服务端有大量请求堆积，最终系统资源耗尽停止响应。我们不得不重启服务，并对接口做了限流，服务才恢复正常。

究其原因，我们习惯性地将公用的功能和数据做成了内网服务，这种方式虽然可以提高服务的复用性，但也让我们的服务非常依赖内网服务。当外网受到流量冲击时，内网也会受到放大流量的冲击，过高的流量很容易导致内网服务崩溃，进而最终导致整个网站无法响应。

事故后我们经过详细复盘，最终一致认为这次系统大规模崩溃，核心还是在于系统隔离性做得不好，业务极易相互影响。

![图片](https://static001.geekbang.org/resource/image/68/5e/681126bc525bd8e42334396911fb655e.jpg?wh=1920x1293 "改造前的系统部署结构")

如果系统隔离性做得好，在受到大流量冲击时，只会影响被冲击的应用服务，即使某个业务因此崩溃，也不会影响到其他业务的正常运转。这就要求我们的架构要有能力隔离多个应用，并且能够隔离内外网流量，只有如此才能够保证系统的稳定。

## 拆分部署和物理隔离

为了提高系统的稳定性，我们决定对系统做隔离改造，具体如下图：

![](https://static001.geekbang.org/resource/image/f3/2a/f3febbcef999929421d075b2be59082a.jpg?wh=3988x2685)  
也就是说，每个内、外网服务都会部署在独立的集群内，同时每个项目都拥有自己的网关和数据库。而外网服务和内网必须通过网关才能访问，外网向内网同步数据是用Kafka来实现的。
<div><strong>精选留言（11）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/17/0d/f8/3e1d5765.jpg" width="30px"><span>LecKey</span> 👍（3） 💬（2）<div>外网与没网的区别：
外网是一般是针对用户端，直接对接用户使用，需要做公网解析；
内网一般是公司技术服务节点，不需要公网解析且不对外服务，都是外网服务上做单独解析才能访问内网服务，访问内网会比公网获取数据速度更快，减少了一层解析。

一般大点的公司都会做外网和内网隔离，以保障服务安全和稳定。</div>2022-11-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2c/d5/e0/addca785.jpg" width="30px"><span>dk.wu</span> 👍（1） 💬（1）<div>“不同步”是否应该调整为“没同步”？
这块可以理解为数据同步场景的一个警示牌，如何做到数据同步完整性的检测机制和补偿机制？
没同步的数据可以识别为三种情况：（1）外网服务端推送异常（2）内网服务消费异常（3）还在队列排队（4）其他。
从隔离性出发，可以独立一个审计检测服务，对比内外网已同步服务，识别到的未同步数据，可以触发重新走kafka同步。至于识别的方法，是traceId还是其他业务Id，还得看抽象通用性。
</div>2023-02-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/e7/8e/318cfde0.jpg" width="30px"><span>Spoon</span> 👍（0） 💬（1）<div>用户在外网业务系统下单购买一个商品时，外网服务会扣减本地缓存中的库存。库存扣减成功后，外网会创建一个订单并发送创建订单消息到消息队列中
针对这段有以下疑问
1.库存扣减+订单创建应该是一个事务操作，创建订单消息并发送是在事务内还是在事务外？
2.针对问题1，如果在事务内，因为消息发完，下游收到这个消息（此时事务未提交），下游并没有查到该订单，此时的解决方案有哪些？
3.针对问题1，如果在事务外，消息发送失败怎么办（事务已经提交，怎么回滚）？
</div>2023-03-29</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ersGSic8ib7OguJv6CJiaXY0s4n9C7Z51sWxTTljklFpq3ZAIWXoFTPV5oLo0GMTkqW5sYJRRnibNqOJQ/132" width="30px"><span>walle斌</span> 👍（0） 💬（2）<div>这里边的kafka换成rocketmq 没有任何问题还多了更多的特性。。</div>2023-03-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/71/05/db554eba.jpg" width="30px"><span>👽</span> 👍（0） 💬（1）<div>“同时，我们在开发期间要时刻注意，内网网关在流量增大的时候要做熔断，这样可以避免外网服务强依赖内网接口，保证外网服务的独立性，确保内网不受外网流量冲击。并且外网服务要保证内网网关断开后，仍旧能正常独立运转一小时以上。”

内网断网后，仍然可访问一小时，解决方案，是把所有的操作记录缓存到外网服务内部，然后等着内网服务上线后，再推送给内网服务么？这部分细节本文没有体现，有点疑惑。</div>2023-03-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/4f/b5/bd6140a5.jpg" width="30px"><span>ARM</span> 👍（0） 💬（1）<div>“这个特性让我们可以做很多灵活的操作，甚至可以在流量高峰期，暂时停掉内网消费服务，待系统稳定后再开启，落地用户的交易”  那订单的状态流转会不会出问题，因为消息都在kafka没落库。比如我买东西，创建订单，我支付的时候，怎么显示已支付？退费怎么退费？</div>2023-01-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/94/fe/5fbf1bdc.jpg" width="30px"><span>Layne</span> 👍（0） 💬（5）<div>老师，在上面说到数据指定到Kafka某个分区上，这样会出现数据倾斜问题吧，导致Kafka的集群性能出问题吧？</div>2022-12-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/31/e6/3fae5e6f.jpg" width="30px"><span>RiseL</span> 👍（0） 💬（3）<div>外网服务要保证内网网关断开后，仍旧能正常独立运转一小时以上，数据都是内网来的，内网挂了，外网功能还怎么正常运行呢</div>2022-11-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0c/86/8e52afb8.jpg" width="30px"><span>花花大脸猫</span> 👍（0） 💬（1）<div>可以通过给数据打tag或者版本号，然后周期性的对比同一笔数据的tag或者版本号是否一致，如果不一致，以tag或者版本号新的那一条为准</div>2022-11-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/0d/f8/3e1d5765.jpg" width="30px"><span>LecKey</span> 👍（0） 💬（5）<div>课后思考：每条数据都有唯一的数据标识(一般是自增id，或者有规律一串数字唯一id)，而且一般都是小到大，根据这个最大值应该就能判断出来。

如果数据不同步应该找到对应数据节点做补偿操作</div>2022-11-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg" width="30px"><span>peter</span> 👍（0） 💬（1）<div>请问：内外网这种划分方法是通用的还是你们公司自己独有的？
我读了一些专栏和书（数量不是很多），都没有提到内外网这种划分，所以对于本讲中提到的内外网非常不理解。请问，这种划分方法是互联网通用的方法吗？还是作者的培训公司自己的一种做法？
</div>2022-11-09</li><br/>
</ul>