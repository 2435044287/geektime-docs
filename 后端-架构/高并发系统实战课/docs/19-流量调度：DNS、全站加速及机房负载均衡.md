你好，我是徐长龙。

上节课我们学习了如何从架构设计上应对流量压力，像直播这类的服务不容易预估用户流量，当用户流量增大到一个机房无法承受的时候，就需要动态调度一部分用户到多个机房中。

同时，流量大了网络不稳定的可能性也随之增加，只有让用户能访问就近的机房，才能让他们的体验更好。

综合上述考量，这节课我们就重点聊聊流量调度和数据分发的关键技术，帮你弄明白怎么做好多个机房的流量切换。

直播服务主要分为两种流量，一个是静态文件访问，一个是直播流，这些都可以通过CDN分发降低我们的服务端压力。

对于直播这类读多写多的服务来说，动态流量调度和数据缓存分发是解决大量用户在线互动的基础，但是它们都和DNS在功能上有重合，需要一起配合实现，所以在讲解中也会穿插CDN的介绍。

## DNS域名解析及缓存

服务流量切换并没有想象中那么简单，因为我们会碰到一个很大的问题，那就是DNS缓存。DNS是我们发起请求的第一步，如果DNS缓慢或错误解析的话，会严重影响读多写多系统的交互效果。

那DNS为什么会有刷新缓慢的情况呢？这需要我们先了解DNS的解析过程，你可以对照下图听我分析：

![图片](https://static001.geekbang.org/resource/image/a4/23/a40cfbf0e9ef60f16e75b273dd111823.jpg?wh=1920x1028 "DNS 查找过程")

客户端或浏览器发起请求时，第一个要请求的服务就是DNS，域名解析过程可以分成下面三个步骤：
<div><strong>精选留言（4）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/49/18/0fdc49d7.jpg" width="30px"><span>txjlrk</span> 👍（1） 💬（1）<div>大佬的文章适合每天看一点 温故知新</div>2023-03-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/49/18/0fdc49d7.jpg" width="30px"><span>txjlrk</span> 👍（1） 💬（1）<div>刚看阿里云dns ttl最低是10分钟嘞了</div>2023-03-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c6/20/124ae6d4.jpg" width="30px"><span>若水清菡</span> 👍（1） 💬（1）<div>视频、WebSocket 这一类长链接如何动态切换机房？
APP端最好具备长链接实时监测，在发起连接时监测与server段的网络连接有效性，和server端具备心跳监测，这样nginx入口层的切换不会对业务造成太大的影响，APP会重新发起连接；如果切的机房与旧机房原有的server不通，需要先切dns记录到机房，待dns全网生效后，旧机房的server 对长链接下发断开通知，通知APP重新进行链接。</div>2023-01-07</li><br/><li><img src="" width="30px"><span>Geek_8e2a28</span> 👍（0） 💬（1）<div>大佬您好。看好多大公司既有GTM又有LVS。想问下GTM的负载均衡能力与LVS这种四层负载均衡的能力有什么区别呢？只做一个不够用吗？</div>2024-10-30</li><br/>
</ul>