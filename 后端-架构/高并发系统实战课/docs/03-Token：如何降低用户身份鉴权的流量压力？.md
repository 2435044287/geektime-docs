你好，我是徐长龙，这节课我们来看看如何用token算法降低用户中心的身份鉴权流量压力。

很多网站初期通常会用Session方式实现登录用户的用户鉴权，也就是在用户登录成功后，将这个用户的具体信息写在服务端的Session缓存中，并分配一个session\_id保存在用户的Cookie中。该用户的每次请求时候都会带上这个ID，通过ID可以获取到登录时写入服务端Session缓存中的记录。

流程图如下所示：

![](https://static001.geekbang.org/resource/image/58/72/589d13f1d758a44a1af37efaf9dbdc72.jpg?wh=3330x2141 "Session Cache实现的用户鉴权")

这种方式的好处在于信息都在服务端储存，对客户端不暴露任何用户敏感的数据信息，并且每个登录用户都有共享的缓存空间（Session Cache）。

但是随着流量的增长，这个设计也暴露出很大的问题——用户中心的身份鉴权在大流量下很不稳定。因为用户中心需要维护的Session Cache空间很大，并且被各个业务频繁访问，那么缓存一旦出现故障，就会导致所有的子系统无法确认用户身份，进而无法正常对外服务。

这主要是由于Session Cache和各个子系统的耦合极高，**全站的请求都会对这个缓存至少访问一次**，这就导致缓存的内容长度和响应速度，直接决定了全站的QPS上限，让整个系统的隔离性很差，各子系统间极易相互影响。

那么，如何降低用户中心与各个子系统间的耦合度，提高系统的性能呢？我们一起来看看。
<div><strong>精选留言（28）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/ce/6d/530df0dd.jpg" width="30px"><span>徐石头</span> 👍（4） 💬（11）<div>Q1：在token过期很短的时候，通过refresh_token频繁更新token，怎么实现对用户实时管理？是不是还是跟用户人数相关，一般这种场景是后台系统，删除一个用户后该用户账号立刻不能登录，后台人数比C端人数少很多，所以管理起来代价比较小，更看重权限安全，放在缓存中进行管理。
A: 如果我来做快速更换昵称的功能，两种方式，
a.在用户修改昵称后，内存中加入个用户标识，解析token后读取该标识，有则返回特定code，让客户端重新拿token。甚至可以不用客户端参与，返回301重定向到获取新token的路由。
b. token里面不存用户信息，只存用户ID，需要用户信息的时候从缓存读。
</div>2022-10-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/03/77/3f6a76a9.jpg" width="30px"><span>极客</span> 👍（10） 💬（1）<div>客户端可以缓存修改后的昵称，直到更换了access token再清除缓存，类似弹幕本地先发送让用户自己认为发送成功了</div>2022-10-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/4d/25/0920057c.jpg" width="30px"><span>7S</span> 👍（5） 💬（3）<div>access_token由于安全问题设置过期的时间非常短，但是refresh_token有效时间非常长，如果refresh_token被泄漏掉，是不是能一直刷新access_token呢。。</div>2022-10-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/e2/aa/9ddc6469.jpg" width="30px"><span>小林coding</span> 👍（4） 💬（1）<div>PAYLOAD 中定义的 token 发放时间 iat 字段的值是绝对时间戳，如果服务端的系统时间被往前修改了，这时在校验token是否过期的时候，是不是还需要增加一个处理：如果「当前时间戳 &lt; token 发放时间戳 」，就认为 token 过期了。</div>2022-11-15</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/uoPcB6q9VZmyV1IYrnBiaYneyrTeibjSbo981QYQK7O968w1ticehtGmNJ8Kx9EdKFwoiczuUT3blkNn1EBO3PXWgA/132" width="30px"><span>林晓威</span> 👍（3） 💬（1）<div>老师好，请问光使用base64加密是不是不太安全？这样别人不是很容易知道你用什么加密算法了</div>2022-11-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/49/bf/4936c58b.jpg" width="30px"><span>吴晨辉</span> 👍（3） 💬（2）<div>很高兴第二次回答问题
传统sessoion会导致用户中心缓存大，耦合度高，但实时性强
jwt加密策略耦合度低，但是实时性不高
那么可以结合两个方式，优先读取token 加密字段，然后利用用户id关联session cache覆盖
考虑到session缓存成本，可以只缓存实时性强的字段，或者用vip制度，用户充钱越多，缓存的东西越多
核心思想就是成本增效</div>2022-10-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/71/05/db554eba.jpg" width="30px"><span>👽</span> 👍（2） 💬（1）<div>我的理解是，token中应该只存放和session生命周期同步的操作。比如：用户Id和权限。这两个东西，在用户session的生命周期内一般来说是不会变的。翻译一下，token代表着：你是谁，你能做什么。能做到这两个事情就够了。而不应该去单独关注用户的扩展信息。

至于昵称，我觉得应该单独放缓存中。通过用户ID获取。因为昵称当前token下修改还好说，如果跨token呢？比如web端修改了昵称web端端token可以立马换一个新的，移动端怎么办呢？所以我认为，昵称，头像，这种会修改的信息不应该放到token体里。</div>2022-12-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/8e/2a/448b2177.jpg" width="30px"><span>xin</span> 👍（1） 💬（1）<div>徐老师，请问如何实现登出的时候，让token失效呢</div>2024-02-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/cb/73/9eb7c992.jpg" width="30px"><span>Eason Lau</span> 👍（0） 💬（1）<div>这个jwt token不鸡肋吗？ 别的系统严重token有效性的时候还得知道秘钥啊，这不解耦😄</div>2024-04-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/1e/f2/453d5f88.jpg" width="30px"><span>seker</span> 👍（0） 💬（1）<div>徐老师，请问，用于token加密头中的常用加密算法有哪些呢？</div>2023-08-16</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/qEBMWMbciakcMuz1IdPN9bMKLnJfAoCibKFJYwPyQtCv48efTNFvUicrjBicp3Q1h5hDU3OQibh3yqtvJxEx0HeNwFA/132" width="30px"><span>无问西东</span> 👍（0） 💬（1）<div>你好，客户端保存token如何保证不被其他应用窃取呢</div>2023-07-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/fa/a9/306c657e.jpg" width="30px"><span>李坤鹏</span> 👍（0） 💬（1）<div>如果用户中心和周边服务不属于一个信任域，需要将 JWT 签发能力限定在用户中心，但是和周边服务的关系又没有疏远到需要使用 OAuth 授权的程度，那么是否可以使用 RS256算法替代 HS256 算法呢？这样子周边服务无法自己颁发 token，但又可以自己独立验签，相当于牺牲一部分性能换取安全性。这种做法在业界是可接受的方案吗？</div>2023-07-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/74/aa/178a6797.jpg" width="30px"><span>阿昕</span> 👍（0） 💬（1）<div>思考题：由客户端发起刷新token操作</div>2023-04-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/e7/8e/318cfde0.jpg" width="30px"><span>Spoon</span> 👍（0） 💬（1）<div>使用token这种方式，怎么统计在线用户呢？</div>2023-03-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg" width="30px"><span>piboye</span> 👍（0） 💬（1）<div>有消息系统的话，发消息给用户所有终端切换token</div>2023-02-15</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJPZN07CicHGCjVPtWK0WQjAglXTZWDUYlCVXdJhrWIWKicl49LF0ezPq3HmGibzicBicvBC8NpkR4NhoA/132" width="30px"><span>zmlmagic</span> 👍（0） 💬（1）<div>更新用户昵称，一般客户端修改自己资料接口调度成功后，直接调用token刷新更新掉本地token。如果用户编辑其他用户信息，要不就是易变更信息不走接口，要不就是鉴权那缓存用户token直接服务端刷新，根据需求平衡吧。</div>2023-02-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/fb/50/04071be6.jpg" width="30px"><span>DZ</span> 👍（0） 💬（1）<div>老师您好，请教下，如果只是用户中心出现故障，导致客户端更换 access_token失败，APP没有离线，但是refresh_token没有过期。这个时候会怎么处理？客户端不会提示用户重新登陆，依旧拿着旧的 access_token请求其他业务接口，其他业务接口由于token过期返回登录超时？</div>2023-01-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/97/0b/a943bcb3.jpg" width="30px"><span>zhou</span> 👍（0） 💬（3）<div>把用户信息放在服务器外做传递和维护，子系统通过签名算法对token进行验证，是否会存在子系统可以拿到签名的密钥，从而可以自行签发token的能力，会不安全。</div>2023-01-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/d0/de/5eb5ffb0.jpg" width="30px"><span>严程序</span> 👍（0） 💬（3）<div>在修改后昵称直接颁发新token给客户端，或者让access_token过期用户重新用获取新token</div>2023-01-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/94/fe/5fbf1bdc.jpg" width="30px"><span>Layne</span> 👍（0） 💬（1）<div>老师，这个双token机制中，re fresh_token的有效期是固定的，没办法刷新，那是不是意味着用户端只要超过30天，就必须重新都登陆一次了，因为没办法刷新access_token了。就算用户是活跃的</div>2022-11-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/0f/e8/a3c08232.jpg" width="30px"><span>连腾宇</span> 👍（0） 💬（1）<div>有点没太理解， access token过期客户端有，那服务端怎么知道这个token是否还在有效期内呢？（是根据客户端传过来的时间为准，根据解密信息判断时间有没有被篡改吗？）</div>2022-11-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4c/a0/6cfdefa6.jpg" width="30px"><span>特修斯之船</span> 👍（0） 💬（1）<div>关于用户中心里，服务器端对access_token和refresh_token的管理，有没详细的设计？

一直不清楚，刷新这一块的细节逻辑</div>2022-11-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/25/1f/34/0a611d8a.jpg" width="30px"><span>邱一二</span> 👍（0） 💬（2）<div>老师好，请问一下token自动更新是客户端在过期前请求服务端重新获取新的token吗？还是客户端自己完成？那如果是客户端自己生成会不会有法外狂徒利用逆向工程破解app获得对应生成token的SecretString然后伪造token呢</div>2022-11-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg" width="30px"><span>peter</span> 👍（0） 💬（1）<div>请问：Token的自动更新是系统自动完成的吗？
文中有“过期后客户端会自动更换 token。”，那么，token的更新需要开发人员写代码吗？（如果是框架自动完成，或者是TCP&#47;UDP协议栈完成，就不需要用户写代码了）
</div>2022-11-01</li><br/><li><img src="" width="30px"><span>frag007</span> 👍（0） 💬（2）<div>更新昵称一般是用户自己发起的，更新昵称的同时，业务后台重新生成token就可以了。</div>2022-11-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0a/a4/828a431f.jpg" width="30px"><span>张申傲</span> 👍（0） 💬（1）<div>老师对于 JWT 的原理和最佳实践讲得很清楚👍🏻</div>2022-10-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/3f/c9/1ccefb9a.jpg" width="30px"><span>Sky</span> 👍（0） 💬（6）<div>token的方式是怎么处理多终端登录以及“踢下线”类似的功能的呢？</div>2022-10-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2d/f6/36/a71438d8.jpg" width="30px"><span>Geek_00乐</span> 👍（0） 💬（1）<div>用户如果被拉黑，客户端最快也要在 token 过期后才能退出登陆，这让我们的管理存在一定的延迟。</div>2022-10-29</li><br/>
</ul>