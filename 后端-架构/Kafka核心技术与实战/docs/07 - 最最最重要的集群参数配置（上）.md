你好，我是胡夕。今天我想和你聊聊最最最重要的Kafka集群配置。我这里用了3个“最”字并非哗众取宠，而是因为有些配置的重要性并未体现在官方文档中，并且从实际表现看，很多参数对系统的影响要比从文档上看更加明显，因此很有必要集中讨论一下。

我希望通过两期内容把这些重要的配置讲清楚。严格来说这些配置并不单单指Kafka服务器端的配置，其中既有Broker端参数，也有主题（后面我用我们更熟悉的Topic表示）级别的参数、JVM端参数和操作系统级别的参数。

需要你注意的是，这里所说的Broker端参数也被称为静态参数（Static Configs）。我会在专栏后面介绍与静态参数相对应的动态参数。所谓静态参数，是指你必须在Kafka的配置文件server.properties中进行设置的参数，不管你是新增、修改还是删除。同时，你必须重启Broker进程才能令它们生效。而主题级别参数的设置则有所不同，Kafka提供了专门的kafka-configs命令来修改它们。至于JVM和操作系统级别参数，它们的设置方法比较通用化，我介绍的也都是标准的配置参数，因此，你应该很容易就能够对它们进行设置。

下面我先从Broker端参数说起。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/14/3a/6e/e39e90ca.jpg" width="30px"><span>大坏狐狸</span> 👍（279） 💬（18）<div>auto.create.topics.enable： 不能自立为王

unclean.leader.election.enable： 宁缺毋滥

auto.leader.rebalance.enable：江山不易改

log.retention.{hours|minutes|ms} ：数据寿命  hours=168
log.rentention.bytes: 祖宅大小  -1 表示没限制
message.max.bytes: 祖宅大门宽度，默认 1000012=976KB</div>2020-03-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/63/85/9ccf1b19.jpg" width="30px"><span>草帽路飞</span> 👍（108） 💬（8）<div>老师 advertised.listeners 这个配置能否再解释一下。感觉配置了 listeners之后就不用配置这个了呀？</div>2019-06-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/ab/9b/b12c223d.jpg" width="30px"><span>第一片心意</span> 👍（46） 💬（2）<div>       auto.leader.rebalance.enable
       关于这个参数的设置，我有一点不同的意见，官网说的是如果某个broker挂了，那分布在他上的leader副本就会自动切换到其他活着的broker上，但是挂掉的broker重启之后，集群并不会将他之前的leader副本再切换回来，这样就会使其他broker上leader副本数较多，而该broker上无leader副本（无新主题创建），从而造成负载不均衡的情况。
       这时我们可以通过 kafka-preferred-replica-election.sh 脚本来重新平衡集群中的leader副本。但是我们配置这个参数为true的话，controller角色就会每五分钟（默认）检查一下集群不平衡的状态，进而重新平衡leader副本。</div>2019-12-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg" width="30px"><span>QQ怪</span> 👍（39） 💬（1）<div>老师帮我们讲讲这个参数吧auto.offset.reset，我有时候删除一个topic时会导致offset异常，出现重复消费问题，不知道跟这个参数有没有关系？？</div>2019-06-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/9c/5e/76c3c339.jpg" width="30px"><span>🇭   🇴  🇱 🇮  🇸</span> 👍（33） 💬（3）<div>老师 我把message.max.bytes设置地挺大，但是java生产者发送1M以上数据就失败，集群也重启过，版本0.10左右 是否有其他参数需要调？</div>2020-04-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e9/e9/1f95e422.jpg" width="30px"><span>杨陆伟</span> 👍（29） 💬（5）<div>你好，log.retention.bytes这个参数是针对主题的吧？比如设置为100M，Kafka定期会把每个主题的日志数据留存到100M以下？</div>2019-12-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/b6/48/1275e0ce.jpg" width="30px"><span>小头针</span> 👍（27） 💬（3）<div>胡老师，我在kafka升级过程中遇到过这样的问题，就是升级后的Kafka与之前的Kafka 的配置完全一样，就是版本不一样了。但是5个Broker后，Kafka Manager工具中，只有1个Broker有数据进入进出。后来同时添加了以下4个参数：
rebalance.max.retries=4
auto.leader.rebalance.enable=true
leader.imbalance.check.interval.seconds=300
leader.imbalance.per.broker.percentage=10
再重启Kafka，5个Broker都有数据进入进出，但是我不清楚这到底是哪个参数起到了决定性的作用。其中就有老师讲的auto.leader.rebalance.enable这个参数，但是我这里设置的是true？</div>2019-06-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/9c/35/9dc79371.jpg" width="30px"><span>你好旅行者</span> 👍（16） 💬（1）<div>老师好！关于Unclean这个参数，将其设置为false之后，就意味着如果ISR内的所有broker都宕机，那么这个分区就不可用了。
刚好我前几天看到饶军在2013年的一次报告上讲到Kafka在CAP问题上的取舍，他说，因为Kafka是部署在一个DataCenter中的，而一个DataCenter很少会出现Partitioning的情况，所以Kafka放弃了分区容忍性。
我想问的是，Kafka舍弃了分区容忍性这一点是否可以体现在社区默认将Unclean设置为false上呢？
附上报告的地址：https:&#47;&#47;www.youtube.com&#47;watch?v=XcvHmqmh16g
关于CAP的取舍出现在21:50左右的地方。谢谢老师！
</div>2019-06-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/76/b0/14fec62f.jpg" width="30px"><span>不了峰</span> 👍（15） 💬（1）<div>请教老师
gg.handler.kafkahandler.Mode = tx
gg.handler.kafkahandler.Mode = op
这两个的差别。我们遇到时 dml 数据会丢失的情况。用的是 op 。
谢谢</div>2019-06-18</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLl9nj9b6RydKADq82ZwOad0fQcvXWyQKk5U5RFC2kzHGI4GjIQsIZvHsEm7mFELgMiaGx3lGq9vag/132" width="30px"><span>咸淡一首诗</span> 👍（12） 💬（1）<div>老师，对于failover机制，kafka会新建副本，从leader处同步最新的数据给新建副本。如果坏掉的盘是leader持久化的盘并且其他副本没有来的及从坏掉的leader分区同步最新数据，重新选举leader后岂不是也会丢失数据？？？</div>2020-02-14</li><br/><li><img src="http://thirdqq.qlogo.cn/qqapp/101418266/D6DD8CB1004D442B48914656340277F3/100" width="30px"><span>henry</span> 👍（11） 💬（4）<div>老师，最近别人问我一个问题，假如现有集群已经有3个分区，动态添加两个分区,  原有的分区会迁移数据到新增的分区吗？ </div>2019-06-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/52/bb/225e70a6.jpg" width="30px"><span>hunterlodge</span> 👍（10） 💬（1）<div>“坚决不能让那些落后太多的副本竞选 Leader”，请问落后多少算是太多呢？谢谢</div>2019-11-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/b3/c5/7fc124e2.jpg" width="30px"><span>Liam</span> 👍（8） 💬（1）<div>请问老师，坏掉的数据是怎么自动转移到其他磁盘上的呢？</div>2019-06-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/0c/69/3d2f3a58.jpg" width="30px"><span>李 P</span> 👍（7） 💬（3）<div>和本节无关，消息队列重复消费问题有什么太好的办法吗？我们现在的做法是把offset和消费后的计算结果一并保存在业务系统中，有没有更好的做法</div>2019-06-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/23/f6/1ef70cab.jpg" width="30px"><span>你看起来很好吃</span> 👍（6） 💬（1）<div>&#39;如果设置成 false，那么就坚持之前的原则，坚决不能让那些落后太多的副本竞选 Leader。&#39;想问一下老师，每个partition的副本保存的数据不是应该和leader是一模一样的吗？为什么会有丢失的？</div>2019-06-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d2/31/f1bec7fc.jpg" width="30px"><span>汉斯·冯·拉特</span> 👍（5） 💬（1）<div>老师，可以这样设置吗，listeners设置协议用PLAINTEXT，advertised.listeners设置协议为SASL_PLAINTEXT，让broker之间走plaintext，这样内部相互传输快些，但是外部访问则需要认证</div>2020-07-10</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoPY23R9RRSfBeTJUlyc612VlodjAaWWBNiay9tPydkrd6b9NA8GNibdibnFibTsx94ItHE4jvQwprNzA/132" width="30px"><span>Geek_b809ff</span> 👍（5） 💬（1）<div>[2019-08-21 20:25:24,619] WARN [Producer clientId=console-producer] Error while fetching metadata with correlation id 57 : {test=LEADER_NOT_AVAILABLE} (org.apache.kafka.clients.NetworkClient)

老师，请教一下，这个错误是什么参数配置错了导致的呢？</div>2019-08-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4d/49/28e73b9c.jpg" width="30px"><span>明翼</span> 👍（5） 💬（1）<div>老师你好，message.max.bytes设置后是不是影响了kafka的内存占用大小？谢谢</div>2019-06-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/55/fe/ab541300.jpg" width="30px"><span>小猪</span> 👍（5） 💬（1）<div>请教老师，kafka可以部署到kubernetes云平台吗？效能如何？和直接部署在物理机上有什么区别？例如物理机可以选择分布在不同物理磁盘存数据提高速度等</div>2019-06-18</li><br/><li><img src="" width="30px"><span>Geek_jacky</span> 👍（5） 💬（1）<div>老师好，如果磁盘坏掉了，这些数据是什么机制读取到其他磁盘上的呢？不是都坏了吗？不应该读取其他副本中的数据了吗？这个磁盘上的数据就算是丢失了吗？</div>2019-06-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/4c/6d/c20f2d5a.jpg" width="30px"><span>LJK</span> 👍（4） 💬（1）<div>老师好，请问unclean.leader.election.enable设置为false之后，如果leader副本挂掉了那这个分区就无法使用了，是不是意味数据会丢失呢？</div>2019-09-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/8b/4b/15ab499a.jpg" width="30px"><span>风轻扬</span> 👍（4） 💬（1）<div>老师，对于failover机制，kafka会新建副本，从leader处同步最新的数据给新建副本。如果坏掉的盘是leader持久化的盘呢？</div>2019-07-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/f9/b5/850ddda1.jpg" width="30px"><span>王纪娟</span> 👍（4） 💬（1）<div>你好，我目前在用0.10.2版本，实际用下来log.retention.bytes限定的是每个topic的每个分区的最大存储，但其实还可能超，因为还跟reflush 的间隔有关，同时我观察到kafka在写的时候会单独再开一个segment。所以某个时间点topic的实际存储可能大过配置值</div>2019-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c7/dc/9408c8c2.jpg" width="30px"><span>ban</span> 👍（4） 💬（3）<div>kafka保存偏移量好像是在zookeeper，不是在kafka</div>2019-06-22</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJUJKviaecwxpAZCAnHWap86kXUichv5JwUoAtrUNy4ugC0kMMmssFDdyayKFgAoA9Z62sqMZaibbvUg/132" width="30px"><span>Geek_edc612</span> 👍（4） 💬（4）<div>胡老师您好，我对这两个参数有些疑问：
（1）auto.leader.rebalance.enable 这个值设置为true，那么您说的定期重新选举，应该有个触发的条件吧？我刚才跟同事沟通过，他说是跟每台broker的leader数量有关，如果leader分布不均衡就会触发重新选举leader，但是感觉说的还是不够具体，您能给解答下吗，感谢
（2）log.retention.bytes这个参数，您说的对于总磁盘容量来说，那我这样理解您看正确不（极端情况）---这个值我设置为100G，我机器有3个磁盘，每个磁盘大小1T，每个磁盘有不同topic的partition且，如果一个租户恶意写数据到自己的topic，造成某块磁盘的partition大小为100G，那么这台broker是不是所有topic都无法继续写入数据了？劳烦您解答下，感谢

</div>2019-06-19</li><br/><li><img src="" width="30px"><span>Geek_jacky</span> 👍（4） 💬（1）<div>老师好：如果unclean.leader.election.enable这个参数设置为false，一个partition挂了，不让数据少的副本参与选举，那么不就会一直没有副本了吗？我还有个问题，在磁盘满的情况我的一个topic其中的一个partition-0对应的brokerid变成了-1，本来是100的（手动设置的100,-1不知道怎么变的），那么这个partition-0就就找不到这个broker，导致无法进行消费。</div>2019-06-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/1b/4a/f9df2d06.jpg" width="30px"><span>蒙开强</span> 👍（4） 💬（1）<div>老师，你好，kafka的log存储目录可以指定为hdfs上么，如果可以，那就不用给分区指定副本了，因为hdfs默认就是三个副本</div>2019-06-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/9c/f9/2a2be193.jpg" width="30px"><span>GL€</span> 👍（3） 💬（2）<div>&#39;能够实现故障转移：即 Failover。但是自 1.1 开始，这种情况被修正了，坏掉的磁盘上的数据会自动地转移到其他正常的磁盘上，而且 Broker 还能正常工作&#39;kafka如何做到坏掉的磁盘上的数据自动转移到其他正常的磁盘上的？</div>2020-04-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/3d/03/b2d9a084.jpg" width="30px"><span>Hale</span> 👍（3） 💬（1）<div>能够实现故障转移：即 Failover。这是 Kafka 1.1 版本新引入的强大功能。要知道在以前，只要 Kafka Broker 使用的任何一块磁盘挂掉了，整个 Broker 进程都会关闭。但是自 1.1 开始，这种情况被修正了，坏掉的磁盘上的数据会自动地转移到其他正常的磁盘上，而且 Broker 还能正常工作。还记得上一期我们关于 Kafka 是否需要使用 RAID 的讨论吗？这个改进正是我们舍弃 RAID 方案的基础：没有这种 Failover 的话，我们只能依靠 RAID 来提供保障。这段话不太理解</div>2020-01-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/e9/de/0d632855.jpg" width="30px"><span>无情剃刀</span> 👍（3） 💬（1）<div>“坏掉的磁盘上的数据会自动地转移到其他正常的磁盘上，而且 Broker 还能正常工作。”磁盘都坏啦，还能转移？</div>2019-08-18</li><br/>
</ul>