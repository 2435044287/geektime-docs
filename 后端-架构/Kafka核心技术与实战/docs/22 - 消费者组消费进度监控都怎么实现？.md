你好，我是胡夕。今天我要跟你分享的主题是：消费者组消费进度监控如何实现。

对于Kafka消费者来说，最重要的事情就是监控它们的消费进度了，或者说是监控它们消费的滞后程度。这个滞后程度有个专门的名称：消费者Lag或Consumer Lag。

**所谓滞后程度，就是指消费者当前落后于生产者的程度**。比方说，Kafka生产者向某主题成功生产了100万条消息，你的消费者当前消费了80万条消息，那么我们就说你的消费者滞后了20万条消息，即Lag等于20万。

通常来说，Lag的单位是消息数，而且我们一般是在主题这个级别上讨论Lag的，但实际上，Kafka监控Lag的层级是在分区上的。如果要计算主题级别的，你需要手动汇总所有主题分区的Lag，将它们累加起来，合并成最终的Lag值。

我们刚刚说过，对消费者而言，Lag应该算是最最重要的监控指标了。它直接反映了一个消费者的运行情况。一个正常工作的消费者，它的Lag值应该很小，甚至是接近于0的，这表示该消费者能够及时地消费生产者生产出来的消息，滞后程度很小。反之，如果一个消费者Lag值很大，通常就表明它无法跟上生产者的速度，最终Lag会越来越大，从而拖慢下游消息的处理速度。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/82/42/8b04d489.jpg" width="30px"><span>刘丹</span> 👍（40） 💬（8）<div>对lead这个指标的含义还是不能理解。既然Lead 值是指消费者最新消费消息的位移与分区当前第一条消息的差值。好像这个值应该是越小越好，越小的话就意味着分区里未被消费的消息越少？</div>2019-07-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/73/51/5668a02c.jpg" width="30px"><span>zander</span> 👍（25） 💬（5）<div>在公司的kafka消费者监控上，经常可以看到lag 为一个负数，比如-3，-109等，想咨询一下，为什么会出现负数呢？</div>2019-08-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/31/22/6c2677ec.jpg" width="30px"><span>Guard-God</span> 👍（21） 💬（5）<div>老师您好，jmx 监控的lead我认为很重要，但是，我使用JConsole连接后怎么就没有kafka.consumer，这块呢？我测了好多版本，我想问一下，这个是如何配置的
</div>2019-09-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/8b/4b/15ab499a.jpg" width="30px"><span>风轻扬</span> 👍（11） 💬（2）<div>老师，我理解的lead会变小的原因是：kafka的消息会定期清除。所以分区第一条消息的offset值会变大。如果消费的速度慢，则current-offset的值会增长很难。此时lead的值就越来越小。是这样吗？</div>2020-05-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg" width="30px"><span>曾轼麟</span> 👍（8） 💬（1）<div>老师，请问你的这个消费者堆积监控代码，是否会触发消费者组的rebalance呢？</div>2019-12-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7f/ca/ea85bfdd.jpg" width="30px"><span>helloworld</span> 👍（6） 💬（1）<div>若该消费者消费了一个主题中的多个分区，那通过JMX方式的第一个JMX指标kafka.consumer:type=consumer-fetch-manager-metrics,client-id=“{client-id}”角度如何理解，此时的两个监控项records-lag-max和records-lead-min分别代表什么含义？</div>2020-03-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ff/bc/368b9f80.jpg" width="30px"><span>灰机</span> 👍（5） 💬（1）<div>老师您好 理想情况下是不是lead值要等于offset-1？</div>2019-12-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/52/bb/225e70a6.jpg" width="30px"><span>hunterlodge</span> 👍（5） 💬（1）<div>老师，您的那段获取消费组的lag代码，是会导致新的consumer加入到消费组里，从而引起rebalance的吧？</div>2019-12-12</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoCl6Nxf9oW9sDOoibA7p8lKf0jqjPeDszqI4e7iavicQHtbtyibHIhLibyXYAaT02l7GRQvM9BJUxh6yQ/132" width="30px"><span>昀溪</span> 👍（5） 💬（3）<div>老师 怎么能够获取生产者 消费者和主题的关系呢。 我们想要梳理目前线上的 哪些生产者往哪些主题发消息以及哪些消费者消费某些主题。希望能快速获取并梳理出来 老师能不能给一些思路 谢谢</div>2019-10-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0a/22/fed393e9.jpg" width="30px"><span>陆攀</span> 👍（4） 💬（1）<div>老师，除了监控lag外，我还想监控消费的延迟时间。比如我想知道消费的当条数据的产生时间和当前最后一条数据的产生时间的差。这种有什么办法吗？</div>2019-08-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/20/36/b3e2f1d5.jpg" width="30px"><span>wykkx</span> 👍（4） 💬（2）<div>老师请教下，使用bin&#47;kafka-consumer-groups.sh这个方法，如果是独立的消费者，groupid那个地方要怎么填，刚才文章里还是没有说啊，谢谢。</div>2019-07-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/68/c2/b112da90.jpg" width="30px"><span>小源哥</span> 👍（3） 💬（1）<div>leed指的是消费者的位移距离当前还没被删除的第一条消息的差值，可以这么理解吗</div>2020-07-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7f/ca/ea85bfdd.jpg" width="30px"><span>helloworld</span> 👍（3） 💬（2）<div>我用的Kafka版本为kafka_2.11-2.1.1，Kafka Java 客户端版本为1.0.0发现只有kafka.consumer中的records-lag-max，没有records-lead-min；并且也没有分区相关的jmx信息</div>2020-03-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/04/0d/3dc5683a.jpg" width="30px"><span>柯察金</span> 👍（3） 💬（1）<div>感觉通过 javaAPI 的方式有问题啊。第一，引入 consumer 只是获取位移，可能会引起 rebalance。而且 consumer.endOffsets(consumedOffsets.keySet()); 这个方法，consumer 能获取到所有分区的位移信息吗？我一直以为是这样的：consumer 只能获取这个 consumer 所分配到的分区的位移</div>2019-11-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/1e/3a/5b21c01c.jpg" width="30px"><span>nightmare</span> 👍（3） 💬（2）<div>Lead的越小就代表可能会丢消息了吗？</div>2019-07-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/0d/ac/09678490.jpg" width="30px"><span>谢特</span> 👍（2） 💬（1）<div>为什么lag值大，lead值就小呢</div>2019-09-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f9/5f/b0a125a9.jpg" width="30px"><span>chp</span> 👍（2） 💬（1）<div>老师，发现消息滞后后，应该怎么办？重启消费者？</div>2019-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/de/32/509d6b10.jpg" width="30px"><span>老邢</span> 👍（2） 💬（1）<div>老师，请教下: 是否有方法可以直接监控某个topic的各个消费组的消费进度？</div>2019-08-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/20/36/b3e2f1d5.jpg" width="30px"><span>wykkx</span> 👍（2） 💬（3）<div>老师 我三个节点的kafka集群，当min.insync.replicas=1设置为1的时候消费者可以正常消费数据，但是当这个值改为2的时候，消费者就收不到数据了。这是什么问题啊？
其他主要参数：
replica.fetch.max.bytes=10020000
message.max.bytes=10000000
auto.leader.rebalance.enable=false
unclean.leader.election.enable=false
request.required.acks=-1
default.replication.factor=3
message.send.max.retries=5
auto.create.topics.enable=false
这个问题搞了好几天了，也没搞明白，麻烦老师给看下，谢谢</div>2019-07-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a8/e2/f8e51df2.jpg" width="30px"><span>Li Shunduo</span> 👍（2） 💬（1）<div>假设Kafka集群有3台broker，如果想要监控整个集群的指标，应该连接哪个broker，还是任何一个broker都可以？</div>2019-07-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/4d/5e/c5c62933.jpg" width="30px"><span>lmtoo</span> 👍（2） 💬（3）<div>如果消费者慢到消费的数据被删除，会出现两个后果，1消费者从头消费一遍数据，2从最新消息位移开始消费；这个从头消费一遍数据，也会导致消费的消息丢失？导致这两个后果的条件分别是什么？为什么同样的情况会导致不同的后果</div>2019-07-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d5/68/2201b6b9.jpg" width="30px"><span>归零</span> 👍（1） 💬（1）<div>看到这里，kafka学习了一半，懵懵懂懂吧，打算回去梳理一下。再继续深入。
主要是看一下官方的文档。搭建一下集群和代码实操下(在公司主要是只用运维和中间件的同学搭好的架子实现相关的业务逻辑)</div>2021-01-09</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKVIjh4T1akib5iav5IIGjXB9x98p9Y80STRcwpMDqxfGLrMvHamxlxEqLMTpiayWFWSNpBcbGwkRjRw/132" width="30px"><span>马吉辉</span> 👍（1） 💬（1）<div>Kafka 消费者还在分区级别提供了额外的 JMX 指标，用于单独监控分区级别的 Lag 和 Lead 值。JMX 名称为：kafka.consumer:type=consumer-fetch-manager-metrics,partition=“{partition}”,topic=“{topic}”,client-id=“{client-id}”。
--------
这个具体应该如何去实现呢？小白，望请教</div>2020-04-29</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKVIjh4T1akib5iav5IIGjXB9x98p9Y80STRcwpMDqxfGLrMvHamxlxEqLMTpiayWFWSNpBcbGwkRjRw/132" width="30px"><span>马吉辉</span> 👍（1） 💬（2）<div>consumer端的jmx的端口是什么呢？比如我是用Python clickhouse 去消费kafka的数据的
----
我可能就是连接的broker端的jmx端口 9999 但是 consumer端的jmx有是多少呢？</div>2020-04-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4d/49/28e73b9c.jpg" width="30px"><span>明翼</span> 👍（1） 💬（1）<div>老师，我有个问题啊，我们生成环境用用kafka0.10.2.0这个版本，我们有一个程序从kafka中消费数据入到es中，我们一直在监控lag的情况，发现一个规律就是生产者生成的越快，消费端越快，开始以为是因为数据在系统缓存中，所以消费快，后面一看不对，理由是数据延迟比较大，数据无论如何是没办法用到缓存的都需要从磁盘读的；；另外我查看了分区的均衡性，很均衡；此外，我们也分析了日志，从kafka的消费的速度一直很快，延迟卡在入es的速度；
我的问题是：
1）对kafka来讲，消费端和生成端的速度是否相互影响，比如我消费的快了，生产才可以快？
2）还有什么可能原因造成消费端的消费速度和生成速度又这种正相关？</div>2019-07-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/02/78/23c56bce.jpg" width="30px"><span>james</span> 👍（1） 💬（2）<div>start 是 1，生产到了 10，消费到6，那么lag 是 4，head 是 3，如果消费足够慢慢到删除老的消息后，start 变成 5，那 head 就变成 1，此时还没丢消息，当继续慢，start 变为 8，head 变为 -2，因此只有当变为负数，才代表要丢消息，老师对吗？</div>2019-07-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/e4/f4/96fa9deb.jpg" width="30px"><span>李勇</span> 👍（0） 💬（1）<div>老师，分享中有句话如下：更可怕的是，由于消费者的速度无法匹及生产者的速度，极有可能导致它消费的数据已经不在操作系统的页缓存中了。 这句话应该如何理解呢？</div>2020-12-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/df/e5/65e37812.jpg" width="30px"><span>快跑</span> 👍（0） 💬（1）<div>真实环境中，如果遇到Lead趋近于0的情况，应该紧急处理下？</div>2020-11-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/df/e5/65e37812.jpg" width="30px"><span>快跑</span> 👍（0） 💬（1）<div>kafka-consumer-groups.sh这个脚本工具是不是只能获取到offset保存在__consumer_offsets的情况下？</div>2020-11-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c7/eb/50a4842a.jpg" width="30px"><span>翟岳辉</span> 👍（0） 💬（1）<div>请问老师，什么叫窗口时间，怎么计算的</div>2020-11-10</li><br/>
</ul>