你好，我是胡夕。今天我要和你分享的内容是：消费者组重平衡能避免吗?

其实在专栏[第15期](https://time.geekbang.org/column/article/105112)中，我们讲过重平衡，也就是Rebalance，现在先来回顾一下这个概念的原理和用途。Rebalance就是让一个Consumer Group下所有的Consumer实例就如何消费订阅主题的所有分区达成共识的过程。在Rebalance过程中，所有Consumer实例共同参与，在协调者组件的帮助下，完成订阅主题分区的分配。但是，在整个过程中，所有实例都不能消费任何消息，因此它对Consumer的TPS影响很大。

你可能会对这里提到的“协调者”有些陌生，我来简单介绍下。所谓协调者，在Kafka中对应的术语是Coordinator，它专门为Consumer Group服务，负责为Group执行Rebalance以及提供位移管理和组成员管理等。

具体来讲，Consumer端应用程序在提交位移时，其实是向Coordinator所在的Broker提交位移。同样地，当Consumer应用启动时，也是向Coordinator所在的Broker发送各种请求，然后由Coordinator负责执行消费者组的注册、成员管理记录等元数据管理操作。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/d9/75/3598e0de.jpg" width="30px"><span>Icedmaze</span> 👍（61） 💬（10）<div>在 Rebalance 过程中，所有 Consumer 实例都会停止消费，等待Rebalance的完成。
这里想问的是，如果我有一个长耗时的业务逻辑需要处理，并且offset还未提交，这时候系统发生了Rebalance的话，是等待所有消费端当前消息都处理完成，再进行停止消费，并进行重新分配分区，还是说强制停止消费。
如果强制停止消费的话，那么那些已经处理完成一半的数据并offset未提交的数据，势必会导致Rebalance后重新进行消费，导致数据产生重复消费。</div>2019-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/b3/c5/7fc124e2.jpg" width="30px"><span>Liam</span> 👍（50） 💬（7）<div>问个小白问题，如何排查得知broker rebalance 过多，通过broker日志吗？什么日志呢</div>2019-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d9/75/3598e0de.jpg" width="30px"><span>Icedmaze</span> 👍（37） 💬（1）<div>那可否认为，之前poll的数据还是会被继续进行业务逻辑处理，若在rebalance停止消费期间offset并未进行提交，可能会造成该partition里面的同一批消息被重新分配给其他消费实例，造成重复消费问题。</div>2019-07-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/23/ed/a4a774a8.jpg" width="30px"><span>What for</span> 👍（34） 💬（3）<div>老师您好！
请问如果使用 Standalone Consumer，是不是也不会发生 rebalance 了？
感觉专栏里对 Standalone Consumer 就是提了两句，没有太多的介绍，相较于订阅模式它们有什么特点嘛？</div>2020-02-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/53/6d/c3828950.jpg" width="30px"><span>李奕慧</span> 👍（26） 💬（4）<div>“每个 Consumer 实例都会定期地向 Coordinator 发送心跳请求，表明它还存活着。”这个是后台自动触发的还是每次主动poll消息触发的啊？</div>2019-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/be/b9/f2481c2c.jpg" width="30px"><span>诗泽</span> 👍（21） 💬（3）<div>如果同一个group 的不同consumer 设置的session.timeout.ms 的不一样怎么办？协调者以最后一个consumer 为准吗？</div>2019-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f8/89/7431e82e.jpg" width="30px"><span>墨渊战神01</span> 👍（19） 💬（2）<div>Consumer 消费时间过长为啥会导致rebalance？是不能及时发心跳 导致coordinator认为该consumer挂了吗？</div>2019-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6c/0d/c0735400.jpg" width="30px"><span>Berk</span> 👍（14） 💬（2）<div>老师您好, 我们在生产环境中有一个90个分区的主题。部署了三十台机器的consumer group. 每个consumer理论上消费三个分区。我们发现有时rebalance发生后，分区不能平均的分配到consumer group中。极端情况下有的consumer被分到三十个分区。请问老师这种情况应该如何排查？</div>2020-04-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/6e/82/b058eca5.jpg" width="30px"><span>千屿</span> 👍（14） 💬（4）<div>我遇到一个很奇怪的问题，我消费者单线程使用订阅模式消费主题，主题下有三个分区，但是每次启动消费者，只能消费到一个分区的数据，在启动的日志里已经显示了该group已经分配到了三个分区，可是只会poll一个分区的数据。当我用多线程启动三个消费者实例是正常的，启动两个实例只能消费到两个分区数据，求各位大神指点下，谢谢了!</div>2019-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0f/fb/68196d4c.jpg" width="30px"><span>丘壑</span> 👍（14） 💬（1）<div>根据公式计算记过：partitionId=Math.abs(groupId.hashCode() % offsetsTopicPartitionCount)只可能是一个分区值，该分区值对于的leader副本的broker也只可能是集群中的一台，那么一个group进行位移提交的时候，只能是与集群中的一台broker进行交互了？这样是不是就会有性能瓶颈啊，没有充分利用集群中的broker啊，</div>2019-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/21/8c/489792fd.jpg" width="30px"><span>Z</span> 👍（12） 💬（1）<div>1. 缩短单条消息处理的时间：这个涉及业务流程的优化或者改造，得具体问题具体分析，在 bps 这个场景，暂时没有优化的空间
2. 增加消费者端允许下游系统消费一批消息的最大时长：当消费者组完成重平衡之后，每个消费者实例都会定期地向协调者发送心跳请求，表明它还存活着。如果某个消费者实例不能及时地发送这些心跳请求，协调者就会认为该消费者已经“死”了，从而将其从组中移除，然后开启新一轮重平衡。消费者端有个参数，叫 session.timeout.ms，就是被用来表征此事的。该参数的默认值是 10 秒，即如果协调者在 10 秒之内没有收到组内某个消费者实例的心跳，它就会认为这个消费者实例已经挂了。可以这么说，session.timeout.ms 决定了消费者存活性的时间间隔
3. 控制发送心跳请求频率：消费者还提供了一个允许你控制发送心跳请求频率的参数，就是 heartbeat.interval.ms。这个值设置得越小，消费者实例发送心跳请求的频率就越高。频繁地发送心跳请求会额外消耗带宽资源，但好处是能够更加快速地知晓当前是否开启重平衡
4. 减少下游系统一次性消费的消息总数：这取决于消费者端参数 max.poll.records 的值。当前该参数的默认值是 500 条，表明调用一次 KafkaConsumer.poll 方法，最多返回 500 条消息。可以说，该参数规定了单次 poll 方法能够返回的消息总数的上限。如果前两种方法对你都不适用的话，降低此参数值是避免 CommitFailedException 异常最简单的手段
5. 调整两次调用 poll 方法的最大时间间隔：消费者端还有一个参数，用于控制消费者实际消费能力对重平衡的影响，即 max.poll.interval.ms 参数。它限定了消费者端应用程序两次调用 poll 方法的最大时间间隔。它的默认值是 5 分钟，表示你的消费者程序如果在 5 分钟之内无法消费完 poll 方法返回的消息，那么消费者会主动发起“离开组”的请求，协调者也会开启新一轮重平衡
6. 下游系统使用多线程来加速消费：具体的思路就是，让下游系统手动创建多个消费线程处理 poll 方法返回的一批消息。之前你使用 Kafka 消费者消费数据更多是单线程的，所以当消费速度无法匹及 Kafka 消费者消息返回的速度时，它就会抛出 CommitFailedException 异常。如果是多线程，你就可以灵活地控制线程数量，随时调整消费承载能力，再配以目前多核的硬件条件，该方法可谓是防止 CommitFailedException 最高档的解决之道。事实上，很多主流的大数据流处理框架使用的都是这个方法，比如 Apache Flink 在集成 Kafka 时，就是创建了多个 KafkaConsumerThread 线程，自行处理多线程间的数据消费。不过，凡事有利就有弊，这个方法实现起来并不容易，特别是在多个线程间如何处理位移提交这个问题上，更是极容易出错。</div>2021-01-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f6/9c/b457a937.jpg" width="30px"><span>不能扮演天使</span> 👍（12） 💬（7）<div>老师问个问题，max.poll.interval.ms是拉取的时间间隔，如果过了这个时间没有拉取则会发生重平衡，但是什么情况consumer会不拉取呢？上面mongodb的例子那是业务逻辑处理重，但是对于kafka来说poll()之后就已经算是消费完了，为啥这个参数的设置还要依赖消费的后序业务处理？</div>2019-09-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/47/b0/a9b77a1e.jpg" width="30px"><span>冬风向左吹</span> 👍（11） 💬（2）<div>如果代码升级，进程要重启，岂不是每次升级都会导致rebalance???</div>2020-03-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/81/a8/559afe8b.jpg" width="30px"><span>Sruby</span> 👍（10） 💬（3）<div>将consumer端的业务逻辑放到另外一个线程中处理，是不是可以避免Consumer 消费时间过长的问题，同时提高消费速率？</div>2020-03-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/05/7f/a7df049a.jpg" width="30px"><span>Standly</span> 👍（9） 💬（1）<div>”0.10.1之前是在调用poll方法时发送心跳的的，0.10.1之后consumer使用单独的心跳线程来发送“，是否意味着0.10.1之前如果一批消息的消费时间超过了session.timeout.ms，也会触发rebalabce?此时是不是应该保证max.poll.records个消息的消费时间必须小于session.timeout.ms？</div>2019-07-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/3d/5d/ac666969.jpg" width="30px"><span>miwucc</span> 👍（8） 💬（4）<div>从0.10.1.x开始，客户端貌似已经把心跳线程和业务线程分开了，这样的话max.poll.interval.ms还是会影响心跳导致rebanlance吗？另外加入某个broker主分区挂掉，broker重新选组是不是也要引发reblance？</div>2019-09-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e9/e9/1f95e422.jpg" width="30px"><span>杨陆伟</span> 👍（7） 💬（1）<div>消费者给协调者踢出后，还会继续保持心跳并重新连上吗？</div>2019-12-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/01/46/faf75ba6.jpg" width="30px"><span>花开成海</span> 👍（7） 💬（1）<div>请问，内部topic可以增加分区数量吗？有实践过吗？有一个很大集群，内部topic某个分区的副备偶发的被剔除isr然后再加入，观察发现这个分区的写入较大，所以希望增加分区数量。</div>2019-07-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/60/22/92284df2.jpg" width="30px"><span>TeamCC</span> 👍（6） 💬（1）<div>老师你好，问下，一个group.id内所有topic和分区的消费信息都是放在offset topic的一个分区里吗？</div>2019-07-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/6d/1c/d9746372.jpg" width="30px"><span>EricJones</span> 👍（5） 💬（2）<div>查找 Coordinator 的第二步算法，如何查看 12 分区 的 Leader 副本呢？我有一个kafka集群 三个实例，结果我查看的时候只有第一个实例的数据目录下有 __consumer_offsets 目录有五十个。其他的两个实例下面并没有。我要怎么查看 12 分区 的 Leader 副本呢？</div>2019-07-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/1e/3a/5b21c01c.jpg" width="30px"><span>nightmare</span> 👍（5） 💬（1）<div>rebalance的时候必须等所有消费者都提交offset吗？如果没有提交，reblance这么保证精准一次的语义</div>2019-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/dc/ce/a144dea1.jpg" width="30px"><span>yhh</span> 👍（5） 💬（1）<div>想问下，如果消费者的业务处理时间不可控，比较难预知，，为避免Rebalance和消息重复消费，这种有什么好的解决办法吗？max.poll.interval.ms设得非常大？</div>2019-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/4d/5e/c5c62933.jpg" width="30px"><span>lmtoo</span> 👍（5） 💬（3）<div>这个Rebalance是针对ConsumerGroup消费的某一个主题的，还是针对所有消费主题的？如果给消费者组增加了一个新的topic，会对该ConsumerGroup在其他已经消费的主题再平衡吗？</div>2019-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d9/83/7c3ba3dc.jpg" width="30px"><span>曹操</span> 👍（5） 💬（1）<div>将 session.timeout.ms 设置成 6s 主要是为了让 Coordinator 能够更快地定位已经挂掉的 Consumer。

尽快发现已经挂掉的consumer好像不能避免rebalance
kafka默认时间10s，这个时间间隔设置长一点是不是能避免由于网络不稳导致的心跳发送不及时问题，这样是不是能更好的避免rebalance？</div>2019-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/aa/30/acc91f01.jpg" width="30px"><span>honnkyou</span> 👍（5） 💬（1）<div>session.timeout.ms为什么设置在customer端而不是coordinator端？</div>2019-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/de/32/509d6b10.jpg" width="30px"><span>老邢</span> 👍（4） 💬（1）<div>老师，有配置可以关闭reblance吗</div>2020-05-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/1a/3d/0b38d5bc.jpg" width="30px"><span>RouGE</span> 👍（4） 💬（4）<div>假设这样的场景：开始groupa下只有一个consumer1，只注册在topic1下面。后来groupa下来了另一个consumer2，只注册在topic2下面。会发生rebalance吗？</div>2019-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/e7/69/0c426b52.jpg" width="30px"><span>刘易宁</span> 👍（4） 💬（1）<div>在官方文档上面看到：heartbeat.interval.ms必须设置为session.timeout.ms以下，通常应设置不高于session.timeout.ms的1&#47;3。请问这样设置的原因是什么呢？</div>2019-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/30/bd/00cc9f72.jpg" width="30px"><span>Lvjsky</span> 👍（3） 💬（1）<div>老师，作为小白用户，我想问一下，以Spark Streaming为例，在集群上实时消费Kafka的数据。假如这个任务给的资源是--num-executors 20，--executor-cores 4，一共有80个cores，也就是80个并行的Task。是不是表示当前在同一个Consumer Group中，有80个Consumer实例呢</div>2020-12-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/84/19/7ed2ffa6.jpg" width="30px"><span>风</span> 👍（3） 💬（2）<div>老师,我看您回复问题是说 broker挂了，分区数不会变,这是为什么,假设一个topic有8个分区,均匀分布在8个broker上,其中一个挂了,实际上可访问到的分区不就只有7个了吗？还是说这个分区数就是看topic配置了多少个分区？</div>2020-11-18</li><br/>
</ul>