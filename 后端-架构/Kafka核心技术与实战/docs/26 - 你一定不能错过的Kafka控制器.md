你好，我是胡夕。今天我要和你分享的主题是：Kafka中的控制器组件。

**控制器组件（Controller），是Apache Kafka的核心组件。它的主要作用是在Apache ZooKeeper的帮助下管理和协调整个Kafka集群**。集群中任意一台Broker都能充当控制器的角色，但是，在运行过程中，只能有一个Broker成为控制器，行使其管理和协调的职责。换句话说，每个正常运转的Kafka集群，在任意时刻都有且只有一个控制器。官网上有个名为activeController的JMX指标，可以帮助我们实时监控控制器的存活状态。这个JMX指标非常关键，你在实际运维操作过程中，一定要实时查看这个指标的值。下面，我们就来详细说说控制器的原理和内部运行机制。

在开始之前，我先简单介绍一下Apache ZooKeeper框架。要知道，**控制器是重度依赖ZooKeeper的**，因此，我们有必要花一些时间学习下ZooKeeper是做什么的。

**Apache ZooKeeper是一个提供高可靠性的分布式协调服务框架**。它使用的数据模型类似于文件系统的树形结构，根目录也是以“/”开始。该结构上的每个节点被称为znode，用来保存一些元数据协调信息。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg" width="30px"><span>曾轼麟</span> 👍（69） 💬（7）<div>老师控制器选举是不是漏了一个环节，重新选出的controller会增加epoch的值，避免旧的controller复活导致出现两个控制器</div>2019-08-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8d/56/2a04dd88.jpg" width="30px"><span>icejoywoo</span> 👍（18） 💬（3）<div>基于raft搞一套来替代zookeeper？</div>2019-08-09</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/diaGeaLuw3oTAcyFMnkiaVur33RXdUZL8z1LtfHibIyh4r629YSexJQz5JXYjBH7v9rwHH7ham5CzqDZF75QnGIwg/132" width="30px"><span>野性力量</span> 👍（14） 💬（3）<div>epoch这个词我经常看到，查了是纪元的意思，不过用在这里应该怎么理解呢。（在图里）</div>2019-08-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/31/9d/daad92d2.jpg" width="30px"><span>Stony.修行僧</span> 👍（12） 💬（3）<div>KIP-500: Replace ZooKeeper with a Self-Managed Metadata Quorum
了解一下</div>2019-08-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/9c/35/9dc79371.jpg" width="30px"><span>你好旅行者</span> 👍（12） 💬（1）<div>老师好，关于线程的优化，我能否这样理解:之前是为每一个事件分配一个线程，线程本身的切换以及锁会带来繁重的开销。在后续的版本中，讲请求封装成了一个个的事件，采用异步串行化的方式，放入到队列中，由统一的一个线程来轮询这个队列，从而避免了锁的开销。不知道这样的理解是否准确？

此外，老师说的多个线程之间共享Broker缓内存区域，可否举个例子，在什么情况下他们需要共享内存区域呢？

谢谢老师！</div>2019-08-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/83/c9/5d03981a.jpg" width="30px"><span>thomas</span> 👍（8） 💬（2）<div>老师，请问：
1. 当控制器发生故障时，其他broker是如何感知到的？是ZK watch controller没有节点，然后广播通知其他的broker, 来争抢新建一个控制器节点吗？ 还是其他broker没定时收到控制器发送的元数据同步请求？
2. ZK不是可以确保节点的唯一性，为什么还会出现控制器大于1的情况？</div>2020-05-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/0d/ac/09678490.jpg" width="30px"><span>谢特</span> 👍（7） 💬（1）<div>多个节点之间内存一般怎么共享</div>2019-10-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/75/a8/dfe4cade.jpg" width="30px"><span>电光火石</span> 👍（6） 💬（3）<div>老师好，想问一下：
1.如何看出重分区被hang住了，是长时间没有响应就被hang住，还是有一些jmx的参数可以观察？
2.当我们删除&#47;controller的时候，是否会有数据丢失的可能，比如重分区的请求，是否会先存储在zk，然后controler从中读取请求进行处理，这个时候发生重failover，是否新的controller会重新读到这个请求？
谢谢了</div>2019-09-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/63/c6/0167415c.jpg" width="30px"><span>林肯</span> 👍（5） 💬（2）<div>各个broker之间怎样保证元数据的一致性？controller挂了后重新选举的机制是怎样的？</div>2019-10-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/83/c9/5d03981a.jpg" width="30px"><span>thomas</span> 👍（4） 💬（1）<div>老师，若给kafka-server配置文件中的zookeeper.connect参数写了3个zk的节点，他们是如何交换？kafka-server先尝试和第一个zk节点开始建立tcp socket连接，若成功，那么后面两个就不用建立连接, 待异常情况下，做备用吗？</div>2020-05-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/e5/39/951f89c8.jpg" width="30px"><span>信信</span> 👍（4） 💬（1）<div>修改主题分区的broker_host是随便指定一个吗？最后由zk通知到控制器？
作者: 其实如果指定的是broker host，后面是不走ZooKeeper的

追问：
前面文章提到增加分区是控制器完成的。  
那如果随机在一个broker上执行增加分区的命令，再由这个broker通知控制器去做吗？</div>2019-08-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6b/1b/4b397b80.jpg" width="30px"><span>蛮野</span> 👍（3） 💬（1）<div>社区改造单线程加队列的方式，有没有数据或者图标对比下改造前后性能的差异？</div>2019-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/86/fa/4bcd7365.jpg" width="30px"><span>玉剑冰锋</span> 👍（3） 💬（3）<div>如何区分临时znode和永久znode？</div>2019-08-01</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKlllSKrpQkhSxAUhpcFk7oJicA50fBQPSmF0Knicd1LN4SVMwbmuFmXRhB9TARHyaNlG1XL0t470uw/132" width="30px"><span>Geek_b98e35</span> 👍（2） 💬（1）<div>分区重分配和rebalance的区别是啥呀！都是将分区重新分配给消费者？</div>2021-05-28</li><br/><li><img src="" width="30px"><span>Geek_03</span> 👍（2） 💬（1）<div>老师，consumer频繁打印Marking the coorinator dead for group日志是什么原因呢？网上很多答案都是说要配置host，但是我们这边consumer端的服务器上已经配置了host，而且感觉这个信息的打印跟consumer的拉取速度有很大关系</div>2020-07-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d2/c7/14d235bb.jpg" width="30px"><span>猕猴桃 盛哥</span> 👍（2） 💬（1）<div>为何在2.2.1版本的zk的controller和consumer节点下没有任何数据和子节点呢？(单机环境)</div>2020-04-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/06/ac/604de2e8.jpg" width="30px"><span>张庆</span> 👍（2） 💬（1）<div>胡夕大拿，您好，zookeeper中保存了一份kafka的元数据信息，控制器中也会保存一份。当控制器初始化的时候会从zookeeper中拉一份数据，那么之后zookeeper和controller中的数据怎么保持一致啊？</div>2019-08-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0e/61/ae68f8eb.jpg" width="30px"><span>dream</span> 👍（2） 💬（2）<div>老师，突然想到一个与本节无关的问题：如果一台机器系统彻底坏了，不能恢复了，这时候副本肯定会丢一个，kafka 会直接把其它机器中的 一个 Follower 副本提升为 Leader 副本，对外提供服务，但是kafka会自动为其创建新的副本吗？</div>2019-08-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/e9/0b/1171ac71.jpg" width="30px"><span>WL</span> 👍（2） 💬（1）<div>请问控制器也会像其他的broker一样提供消息的读写服务吗? 还是只做Broker的控制和协调工作?</div>2019-08-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/86/fa/4bcd7365.jpg" width="30px"><span>玉剑冰锋</span> 👍（2） 💬（1）<div>文章中说的重分区hang住，指的是failed还是一直处于in progress还是两种情况都可以？</div>2019-08-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/f7/ee/6eeb58a3.jpg" width="30px"><span>calljson</span> 👍（2） 💬（2）<div>手动删除 &#47;controller 节点在找到新的controller节点前，这个时间窗口期kafka集群是不是无法提供服务？比如：删除topic操作、消费消息等，请老师帮忙解惑，谢谢您</div>2019-08-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/86/fa/4bcd7365.jpg" width="30px"><span>玉剑冰锋</span> 👍（2） 💬（1）<div>如何在测试环境模拟一个重分区hang住的现象？</div>2019-08-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d5/68/2201b6b9.jpg" width="30px"><span>归零</span> 👍（1） 💬（2）<div>老师，controller和Coordinator二者有关系吗？看到文章中有一句话控制器是起协调作用的组件。谢谢！</div>2021-02-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/c3/b9/5cd84471.jpg" width="30px"><span>长青</span> 👍（1） 💬（1）<div>老师好，请问控制器其实也是一个broker，正常一个broker宕机，被controller监听到，会触发以宕机broker为leader的主题分区的重新选举，那如果是controller宕机了呢? 那么以这台controller为leader的主题分区的重新选举是在什么时候进行的呢？</div>2020-11-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0e/61/ae68f8eb.jpg" width="30px"><span>dream</span> 👍（1） 💬（2）<div>怎么zookeeper的那张图里面还有consumer的offset呢？
不是consumer的offset都保存在kafka内部位移主题 __consumer_offsets中吗？</div>2019-08-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/f2/26/8d42ea6f.jpg" width="30px"><span>never leave</span> 👍（1） 💬（1）<div>老师   我自己在虚拟机中搭建的kafka集群   为什么zookeeper的&#47;controller是空的？</div>2019-08-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/64/86/f5a9403a.jpg" width="30px"><span>yang</span> 👍（0） 💬（2）<div>去掉zk的依赖，也是要去掉 zk 保存元数据 的功能，将元数据交给controller 节点们来做吗？</div>2021-04-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/47/1b/64262861.jpg" width="30px"><span>胡小禾</span> 👍（0） 💬（1）<div>为什么需要有controller？假如没有controller 直接从ZK 拿数据，会有什么实质性的问题？</div>2021-03-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/55/09/73f24874.jpg" width="30px"><span>建华</span> 👍（0） 💬（1）<div>老师好，你说的zk上也会保存kafka的元数据信息，这些信息是不是存在不同的节点上，比如，&#47;broker,&#47;config等下面呀</div>2021-01-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/cf/81/96f656ef.jpg" width="30px"><span>杨逸林</span> 👍（0） 💬（2）<div>我只知道装RabbitMQ的时候根本不用装其他的，当然除了erlang包，应该会借鉴这个？</div>2020-07-22</li><br/>
</ul>