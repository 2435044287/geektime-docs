你好，我是胡夕。今天我要和你分享的主题是：如何调优Kafka。

## 调优目标

在做调优之前，我们必须明确优化Kafka的目标是什么。通常来说，调优是为了满足系统常见的非功能性需求。在众多的非功能性需求中，性能绝对是我们最关心的那一个。不同的系统对性能有不同的诉求，比如对于数据库用户而言，性能意味着请求的响应时间，用户总是希望查询或更新请求能够被更快地处理完并返回。

对Kafka而言，性能一般是指吞吐量和延时。

吞吐量，也就是TPS，是指Broker端进程或Client端应用程序每秒能处理的字节数或消息数，这个值自然是越大越好。

延时和我们刚才说的响应时间类似，它表示从Producer端发送消息到Broker端持久化完成之间的时间间隔。这个指标也可以代表端到端的延时（End-to-End，E2E），也就是从Producer发送消息到Consumer成功消费该消息的总时长。和TPS相反，我们通常希望延时越短越好。

总之，高吞吐量、低延时是我们调优Kafka集群的主要目标，一会儿我们会详细讨论如何达成这些目标。在此之前，我想先谈一谈优化漏斗的问题。

## 优化漏斗

优化漏斗是一个调优过程中的分层漏斗，我们可以在每一层上执行相应的优化调整。总体来说，层级越靠上，其调优的效果越明显，整体优化效果是自上而下衰减的，如下图所示：
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/be/b9/f2481c2c.jpg" width="30px"><span>诗泽</span> 👍（25） 💬（5）<div>请问最后这个例子中的测试 Console Consume是怎样污染缓存页的？是因为它读取了比较老的数据，使得新数据被写入磁盘导致的吗？</div>2019-08-29</li><br/><li><img src="" width="30px"><span>diyun</span> 👍（11） 💬（1）<div>老师你好，我们生产遇到一个问题，一个kafka broker集群升级到1.0.0后，consumer 客户端版本还是老的0.10.0.1，这样没法使用zero copy特性了导致有大量数据写入后kafka broker OOM了。请问我如果把consumer 客户端版本升级到1.0.0后，他连接的另一个老的broker集群（还是0.10.0.1版本）是否还能使用zero copy？kafka版本是向下兼容的吗，还是consumer和broker版本必须一致才能使用zero copy这样的特性。</div>2020-01-12</li><br/><li><img src="" width="30px"><span>wgcris</span> 👍（9） 💬（2）<div>你好，请教您一个问题，关于leader均衡，如果集群规模比较大，一次leader均衡会有上千个partition要进行leader切换，这会导致客户端很长时间不可用，目前针对这个场景有没有一些比较成熟的解决方案？</div>2019-11-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/49/3d/4ac37cc2.jpg" width="30px"><span>外星人</span> 👍（7） 💬（3）<div>你好，一个broker建议最多存放多少个topic partition啊？这个个数和broker 的性能有啥关系吗？</div>2019-09-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/4d/5e/c5c62933.jpg" width="30px"><span>lmtoo</span> 👍（7） 💬（2）<div>怎么查询linux是否开启了atime</div>2019-08-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/df/79/2ef99993.jpg" width="30px"><span>小鱼</span> 👍（6） 💬（1）<div>关于zero copy那块，是不是仅针对consumer端而言呢？还是说，producer版本与broker不一致时，也会降低性能？</div>2019-08-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c7/dc/9408c8c2.jpg" width="30px"><span>ban</span> 👍（5） 💬（2）<div>老师，为什么测试 Console Consume读取比较老的数据，新的数据为什么会写入磁盘？这里不懂，Consume只是读取怎么会影响到写入</div>2019-09-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/62/59/a01a5ddd.jpg" width="30px"><span>ProgramGeek</span> 👍（4） 💬（1）<div>老师，最近遇到一个问题，在kafka加入SASL  ACL中，生产的时候出现需要给事务ID赋权，那有个问题在有多生产者的情况下，同一主题下的事务ID能一样吗？如果ID不能一样，那我在加入kafka的时候每次都需要赋权怎么办</div>2019-08-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/40/c3/e545ba80.jpg" width="30px"><span>张振宇</span> 👍（3） 💬（2）<div>老师，发现kafka的log文件比较大，执行rm删除log后df- h还未释放空间。
然后lsof -n &#47;data |grep deleted  发现查出来的进程是kafka的进程号，也不敢直接kill
想咨询下老师这种情况如何处理，有没更优雅的方式来优化。</div>2020-04-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/d5/79/3d711fed.jpg" width="30px"><span>SAM(陈嘉奇)</span> 👍（3） 💬（1）<div>老师你好我查到的swappiness的解释是这样的:
This control is used to define how aggressive (sic) the kernel will swap memory pages. Higher values will increase aggressiveness, lower values decrease the amount of swap. A value of 0 instructs the kernel not to initiate swap until the amount of free and file-backed pages is less than the high water mark in a zone. 
按这个意思swap = 0的意思应该不是不交换。</div>2020-03-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e2/6e/0a300829.jpg" width="30px"><span>李先生</span> 👍（2） 💬（1）<div>胡哥：
消费者避免重复消费消息，比如kafka中的一条消息包含10个子消息，是针对kafka中的一条消息做幂等呢，还是针对kafka的每个子消息做幂等呢？</div>2020-04-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/89/aa/eb4c37db.jpg" width="30px"><span>John</span> 👍（1） 💬（1）<div>请问老师，swappiness越小越不积极swap内存，不是更容易oom吗？</div>2021-02-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/6a/fe/446c0282.jpg" width="30px"><span>Minze</span> 👍（1） 💬（1）<div>老师你好，我最近发现有时候consumergroup的current offset经常会几秒钟不动，而这是log end offset是不断增加的。我该从哪些方向着手检查呢？已经检查过了consumer端，消费的方法并没有阻塞的情况，执行时间都是毫秒级的，手动commit offset</div>2020-07-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/3a/6e/e39e90ca.jpg" width="30px"><span>大坏狐狸</span> 👍（1） 💬（1）<div>优化tps和优化延迟 参数都是相反的啊，这个要根据需求来优化么。
那么tps如果增加了 延迟不是高了么，总的时间消耗 跟优化延迟哪个更可取呢? </div>2020-03-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/da/d9/f051962f.jpg" width="30px"><span>浩仔是程序员</span> 👍（0） 💬（1）<div>老师你好，Producer与broker之间有用到zero copy吗？看之前的课程有说到broker端会做一层的数据校验</div>2021-10-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/af/7c/6d90b40a.jpg" width="30px"><span>毛怪</span> 👍（0） 💬（1）<div>最近线上碰到一个问题spark指定分区消费Kafka，出现一个分区间歇性拉取消息失败，其他分区都正常。这个分区所在的brake有其他分区的leader。</div>2021-04-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/df/e5/65e37812.jpg" width="30px"><span>快跑</span> 👍（0） 💬（1）<div>请教老师，Kafka删除数据的逻辑怎样的？
之前了解到删除数据最小单元是segment，是要segment中的所有数据都过期的再进行清理么

</div>2020-11-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/58/42/abb7bfe3.jpg" width="30px"><span>eric-xin</span> 👍（0） 💬（2）<div>老师 你好，我们生产环境碰到一个问题，broker有5个节点，单节点8核16G内存，有170多个topic，qps不高，堆内存设置6Gb，每隔3周左右机会fullgc一次，目前只能通过重启临时解决，课程中提到的gc分析方法都尝试过了，一直定位不到原因，您这边有没有排查思路？</div>2020-09-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/51/0d/fc1652fe.jpg" width="30px"><span>James</span> 👍（0） 💬（1）<div>请问下,零拷贝这块,要是客户端生产者版本与Broker版本不一致,会失去这个特性吗&#47;</div>2020-07-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/51/0d/fc1652fe.jpg" width="30px"><span>James</span> 👍（0） 💬（1）<div>请问老师,客户端使用的版本是不是从官网上找到服务端版本对应的客户端版本吧</div>2020-07-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/7a/93/c9302518.jpg" width="30px"><span>高志强</span> 👍（0） 💬（1）<div>fetch.min.bytes=1  ，设置这个参数后，就会加快consumer消费速度么</div>2020-06-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/9a/54/5d51fda4.jpg" width="30px"><span>婷</span> 👍（0） 💬（2）<div>老师，您好。有个问题请教一下:集群中某个主题的消费很慢，于是对该主题加了分区，结果还是很慢。老师有没有好的解决办法？或者查找问题的思路。谢谢</div>2020-02-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/49/3d/4ac37cc2.jpg" width="30px"><span>外星人</span> 👍（0） 💬（2）<div>怎么知道是读物理盘？还是读页缓存呢？</div>2019-08-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/be/b9/f2481c2c.jpg" width="30px"><span>诗泽</span> 👍（14） 💬（0）<div>如果将kafka 部署到k8s 中，因为k8s 的节点都是禁用swap 的，所以文中提到的swappiness 设置也就失效了</div>2019-08-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（4） 💬（0）<div>没有kafka性能调优的经验，不过性能调优的思路是一致的。优化漏斗很形象，大部分调优主要在应用层，再深一点会到框架层，此时就需要对框架有很好的掌握啦！再深一点就到JVM了，这里主要是看内存空间分配是否合理，垃圾收集器是否正确选择。系统层调优，貌似没做过，这一层就必须对操作系统非常了解了。
万变不离其宗，提高性能的思路就那么几种：
1：使用更快的硬件，比如：内存
2：使用合适的数据结构
3：异步化
4：并行化
5：异步化和并行化，其实是在出现速度差的情况下，充分利用更快的组件的思路。</div>2019-09-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/ba/33/2d83d174.jpg" width="30px"><span>时光守护者-基兰</span> 👍（1） 💬（0）<div>老师给的调优经验真的很实用（虽然我是调优后才看的），我们服务最近就有遇到多线程producer数据，通过jstack发现线程是在申请buffer.memory时阻塞，调大了该值吞吐量翻了好多倍，光增加bitch.size是不够的，buffer.memory也要同步的增加，成功通过技术手段来了一波降本增: )。</div>2023-07-26</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/j24oyxHcpB5AMR9pMO6fITqnOFVOncnk2T1vdu1rYLfq1cN6Sj7xVrBVbCvHXUad2MpfyBcE4neBguxmjIxyiaQ/132" width="30px"><span>vcjmhg</span> 👍（1） 💬（0）<div>这个优化思路感觉超级好！！</div>2021-07-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/91/b4/d5d9e4fb.jpg" width="30px"><span>爱学习的小学生</span> 👍（0） 💬（0）<div>processing fetch with max size 30720000 from consumer on partition  PartitionData(fetchOffset=12297049, logStartOffset=-1, maxBytes=30720000, currentLeaderEpoch=Optional.empty, lastFetchedEpoch=Optional.empty) (kafka.server.ReplicaManager)
org.apache.kafka.common.errors.CorruptRecordException: Found record size -1554710528 smaller than minimum record overhead (14) in file 老师我的kafka有这个报错，并且这个分区的isr只有一个，这是什么问题呢</div>2022-11-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/35/9c/4ed5ae0a.jpg" width="30px"><span>小铁จุ๊บMia</span> 👍（0） 💬（0）<div>既然讲到调优，怎么对kafka进行性能压测呢？</div>2022-09-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/2d/4c/983ce1b9.jpg" width="30px"><span>海水</span> 👍（0） 💬（0）<div>单一broker cpu 和带宽过高 感觉像是__consumer_offsets 相关的原因 老师 需要怎么排查问题呢</div>2022-02-21</li><br/>
</ul>