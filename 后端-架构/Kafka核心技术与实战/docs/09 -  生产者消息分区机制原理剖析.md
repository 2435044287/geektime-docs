我们在使用Apache Kafka生产和消费消息的时候，肯定是希望能够将数据均匀地分配到所有服务器上。比如很多公司使用Kafka收集应用服务器的日志数据，这种数据都是很多的，特别是对于那种大批量机器组成的集群环境，每分钟产生的日志量都能以GB数，因此如何将这么大的数据量均匀地分配到Kafka的各个Broker上，就成为一个非常重要的问题。

今天我就来和你说说Kafka生产者如何实现这个需求，我会以Java API为例进行分析，但实际上其他语言的实现逻辑也是类似的。

## 为什么分区？

如果你对Kafka分区（Partition）的概念还不熟悉，可以先返回专栏[第2期](https://time.geekbang.org/column/article/99318)回顾一下。专栏前面我说过Kafka有主题（Topic）的概念，它是承载真实数据的逻辑容器，而在主题之下还分为若干个分区，也就是说Kafka的消息组织方式实际上是三级结构：主题-分区-消息。主题下的每条消息只会保存在某一个分区中，而不会在多个分区中被保存多份。官网上的这张图非常清晰地展示了Kafka的三级结构，如下所示：

![](https://static001.geekbang.org/resource/image/a9/51/a9fde3dd19a6ea5dc7e7e3d1f42ffa51.jpg?wh=4000%2A1911)

现在我抛出一个问题你可以先思考一下：你觉得为什么Kafka要做这样的设计？为什么使用分区的概念而不是直接使用多个主题呢？

其实分区的作用就是提供负载均衡的能力，或者说对数据进行分区的主要原因，就是为了实现系统的高伸缩性（Scalability）。不同的分区能够被放置到不同节点的机器上，而数据的读写操作也都是针对分区这个粒度而进行的，这样每个节点的机器都能独立地执行各自分区的读写请求处理。并且，我们还可以通过添加新的节点机器来增加整体系统的吞吐量。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg" width="30px"><span>QQ怪</span> 👍（50） 💬（5）<div>我们公司一直使用单个分区保持消息顺序性，看了老师分享的东西收益很多啊，准备回去好好分析改造下</div>2019-06-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/da/4f/ddfc55fb.jpg" width="30px"><span>Adol</span> 👍（46） 💬（4）<div>老师好，在消息重试的时候，分区策略会重新再计算一次吗？比如一开始选择到5号分区，但是5号分区有问题导致重试，重试的时候可以重试发送到别的分区上吗？</div>2019-06-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/6d/cf/ec335526.jpg" width="30px"><span>jc9090kkk</span> 👍（39） 💬（3）<div>感谢老师的分享，对于按消息键保序策略有一个疑问，假如我现在的业务数据定义了三个key，但是这三个key对应的消息生产速率不一致，按照老师上面的示意图展示的是，特定的key只会存储在特定的一个分区中，那岂不是牺牲了拓展性么，如果其中一个key的生产速率非常大，而另外2个key没那么大，却会一直占用分区，不会造成分区的空间浪费吗？还是我理解的有问题吗？希望老师解答一下，谢谢</div>2019-09-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/8f/71/29fb7bc2.jpg" width="30px"><span>hgf</span> 👍（34） 💬（1）<div>老师您好，跨地区的kafka集群，创建的两个partition都在一个地方怎么办呢？创建topic时可以选择在哪些节点上创建partition吗？默认是随机选择节点创建partition吗？</div>2019-07-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/8b/4b/15ab499a.jpg" width="30px"><span>风轻扬</span> 👍（27） 💬（7）<div>老师，我见到有网友提问，说是消费者出现reblance的情况时。key-ordering策略可能会导致消费了“因“，reblance之后，无法消费 “果“。您给出的建议是，显示设置consumer端参数partition.assignment.strategy。这个设置。是不是只要使用了key保序策略，就一定要设置上呢？消费过程中出现reblance是很正常的啊</div>2019-07-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/e9/0b/1171ac71.jpg" width="30px"><span>WL</span> 👍（20） 💬（2）<div>老师能不能有空能不能讲讲kafka和rocketMQ的对比, 我用下来感觉整体挺像的但是具体使用场景和性能优劣方面还是有点不知道该使用选择, 谢谢.</div>2019-06-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/2b/bb/5cf70df8.jpg" width="30px"><span>嘉嘉☕</span> 👍（18） 💬（1）<div>老师好, 关于生产消息, 我有个问题请教一下老师.
生产者生产消息, 采用轮询策略, 
假如轮询到分区A了, 分区A的leader所在的broker有些异常(比如不能及时给出响应), 
此时, kafka的重试机制是怎样的 ?
谢谢 </div>2019-11-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/d0/42/6fd01fb9.jpg" width="30px"><span>我已经设置了昵称</span> 👍（16） 💬（1）<div>广州机房怎么消费广州partition的数据，consumer如何指定消费的partition。这个能讲下吗</div>2019-06-22</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/T2WIS5gJVKoeQHPohZ0SkCZRjChjyqRJ7v0Urw2UTuWrUX3mBb3Om0PGGRFosb6Avibyab4661jCqrTsFrnPC6A/132" width="30px"><span>海贼王</span> 👍（15） 💬（8）<div>感觉这篇文章没有回答怎么保证分区里数据和生产者消息顺序是一致这个问题。
这里有两个例子：1是，一个生产者，发两次消息，但是网络原因，消息到达的顺序和消息发送的顺序不一致，2是两个生产者，这时候消息如何确定消息的顺序呢。

场景1在做CDC，同步数据库数据到异构数据系统很常见
场景2对某些业务很重要

对于第一种，我的一个思路是保证只有一个生产者，且设置生产者的ack为all级别
对于场景2就不知道kafka能怎么做了。

希望老师能解惑</div>2019-07-07</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoPY23R9RRSfBeTJUlyc612VlodjAaWWBNiay9tPydkrd6b9NA8GNibdibnFibTsx94ItHE4jvQwprNzA/132" width="30px"><span>Geek_b809ff</span> 👍（14） 💬（2）<div>老师，想请教几个问题：
1、key是不是必须得完全一样，才能保证会发送到同一个分区？
2、如果kafka搭了集群，有三个broker，分别是broker1、broker2、broker3。这时候我对名称为test的topic发送消息，key设置为A，消息会随机发送到三个broker上去吗？那这样的话顺序不就乱了吗？如果我想保证所有的消息都顺序，是不是需要指定发送到其中一个broker？</div>2019-08-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c0/6c/29be1864.jpg" width="30px"><span>随心而至</span> 👍（11） 💬（1）<div>看了《数据库系统概念》，感觉基本上逃不开里面讲的，只是不同框架有自己的叫法罢了</div>2020-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/8f/71/29fb7bc2.jpg" width="30px"><span>hgf</span> 👍（11） 💬（2）<div>如果消费过程中出现rebalance，那么可能造成因果关系之消费了因后rebalance，然后不处理之前的partition了，后面的消费者也无法处理该partition的“果”，请问，您对这种情况怎么处理的呢？</div>2019-07-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/ee/70/0d2ff8a9.jpg" width="30px"><span>余生尽是归途</span> 👍（7） 💬（2）<div>胡老师，我们这边的场景是，解析上游推送的数据文件（xml格式文件达成的GZ数据压缩包，每个30M-、100M不等），我们采用的方式是，将数据包的路径作为消息发送至kafka（50个分区），然后sparkstreaming并行消费（手动提交的方式消费，数据包解析完成才视为消息消费成功）50个分区的消息（spark通过路径信息去解压解析数据包）。由于数据包大小差异较大，如果按照轮询的方式，在运气不好的情况下，某个分许存放了大量较大数据包，那么这个分区就会成为这一批次数据的瓶颈，后续的处理流程智能等待该分区消费完后才能处理。所以我采用了每次将生产者发送的消息发送至lag最小的分区，在一定程度上避免这个问题。但是这样每次投递消息之前我需要首先查询所有分区的lag值，然后选择lag值较小的分区进行投递，还好，我们的数据包个数不算使特别大（一个小时就几万个，并且消费逻辑重，主要时间消耗为数据消费时间）。这种情况下，分区的策略有没有什么更好的选择呢</div>2019-10-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/8f/35/f1839bb2.jpg" width="30px"><span>风中花</span> 👍（7） 💬（3）<div>打卡继续。老师我有个小白问题  按消息键保序策略 实现方法 return Math.abs(key.hashCode()) % partitions.size(); 如果key 不变，增加分区数(partitions.size();)。那么这个算法，是不是就变成原来key1的消息在1区，增加分区后会不会变成ke1的消息放到其他区呢？ 我的理解是不是不对啊？

</div>2019-06-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/61/67/c4ceb86f.jpg" width="30px"><span>狼暴暴</span> 👍（6） 💬（1）<div>老师，分区里消息有序是指可以根据生产者生成消息数据的时间保证有序还是根据发送到分区的时间保证有序？</div>2020-02-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/e6/95/3ed2fe9c.jpg" width="30px"><span>从零开始</span> 👍（6） 💬（1）<div>老师，key在哪指定，怎么指定啊</div>2019-10-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/68/d5/567bf8ad.jpg" width="30px"><span>非想</span> 👍（6） 💬（1）<div>老师您好，Kafka支持事务消息吗？</div>2019-07-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/6d/1c/d9746372.jpg" width="30px"><span>EricJones</span> 👍（6） 💬（3）<div>分区实现负载均衡提高吞吐量，一台机器多个分区也会有负载均衡效果？也会提高吞吐量？如果会那我一台机器一个kafka 分多少分区合适？我看有人一台机器一个kafka也分了五六个分区。这样做有什么好处？</div>2019-06-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/5c/d7/e4673fde.jpg" width="30px"><span>October</span> 👍（5） 💬（1）<div>老师，在看kafka-client生产者默认分区源码时，看到了cluster.partitionsForTopic和cluster.availablePartitionsForTopic，请问什么时候分区是available，什么时候是不unavailable的？</div>2019-06-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/53/01/05a07cc2.jpg" width="30px"><span>Ranger</span> 👍（4） 💬（1）<div>老师，对于消息时序性，kafka能保证单个分区的时序性，但是不能保证主题内消息的时序性，所以业务场景中，需要保证强时序性的消息，我们只能把它放在一个分区中。这样的理解对不对</div>2020-02-05</li><br/><li><img src="" width="30px"><span>Geek_e2a822</span> 👍（4） 💬（2）<div>老是我有个疑问:消息在同一个分区是能保证消息的顺序性，现在多个produce向  broker 发送消息，是怎么保证先发送的消息是被broker优先接收并优先存储的？有没有可能后发的消息被优先存储呢？</div>2019-11-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/23/b5/332afd51.jpg" width="30px"><span>thicktao</span> 👍（4） 💬（1）<div>老师，我想问一下，消费者要获取分区号是不是只能从zookeeper中获取呢，还有没有其他方式？</div>2019-06-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/f5/a8/9b3fa9af.jpg" width="30px"><span>没啥好看的</span> 👍（4） 💬（6）<div>如果我用key保序这种方式，key有2w个，搞2w个分区，这么做合适吗</div>2019-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/b8/a2/8726ea7b.jpg" width="30px"><span>城墙</span> 👍（4） 💬（1）<div>老师，请问一个Broker中分到多少个分区合适，分区多对性能会有什么影响？</div>2019-06-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/51/0d/fc1652fe.jpg" width="30px"><span>James</span> 👍（3） 💬（1）<div>请问老师kafka-clients与kafka_2.10有什么区别,
好像都是一样的.</div>2020-05-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/8b/ec/dc03f5ad.jpg" width="30px"><span>张天屹</span> 👍（3） 💬（1）<div>老师，我见到有网友提问，说是消费者出现reblance的情况时。key-ordering策略可能会导致消费了“因“，reblance之后，无法消费 “果“。

比如A1&#47;B1&#47;C1消息发送到A&#47;B&#47;C分区，现在新加了一个分区D（以及对应的一个消费者），那么这个时候A2消息发送到了新建分区D，怎么保证A2在A1之后消费呢？尤其是存在消息堆积的情况下，A2先于A1消费是大概率事件。</div>2019-11-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8a/ce/f5e42fbd.jpg" width="30px"><span>Kun3375</span> 👍（3） 💬（1）<div>有几个疑惑…
1.请问对于事务消息的幂等，broker 端的实现和也和普通消息一样吗？
2.如果这样的话是如何做到多分区多会话幂等的呢？
3.对于实践来说，事务的幂等是否还需要手动开启 enable.idempotence？</div>2019-06-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/0d/29/18272af9.jpg" width="30px"><span>hxy</span> 👍（3） 💬（2）<div>老师你好，如果后面增加了分区的数目，按key保序还能生效吗？</div>2019-06-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/f7/ee/6eeb58a3.jpg" width="30px"><span>calljson</span> 👍（3） 💬（2）<div>kafka的主题只有一级、像mq可以进行主题分层：一级主题、二级主题。kafka为何这样设计？</div>2019-06-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/5c/d7/e4673fde.jpg" width="30px"><span>October</span> 👍（3） 💬（2）<div>看到老师的留言中说到，可以通过consumer的assign指定消费者消费哪个分区的。如果一个消费者组的多个消费者订阅了同一分区，会出现什么情况呢？</div>2019-06-24</li><br/>
</ul>