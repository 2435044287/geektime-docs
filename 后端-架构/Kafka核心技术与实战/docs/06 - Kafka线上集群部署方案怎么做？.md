专栏前面几期内容，我分别从Kafka的定位、版本的变迁以及功能的演进等几个方面循序渐进地梳理了Apache Kafka的发展脉络。通过这些内容，我希望你能清晰地了解Kafka是用来做什么的，以及在实际生产环境中该如何选择Kafka版本，更快地帮助你入门Kafka。

现在我们就来看看在生产环境中的Kafka集群方案该怎么做。既然是集群，那必然就要有多个Kafka节点机器，因为只有单台机器构成的Kafka伪集群只能用于日常测试之用，根本无法满足实际的线上生产需求。而真正的线上环境需要仔细地考量各种因素，结合自身的业务需求而制定。下面我就分别从操作系统、磁盘、磁盘容量和带宽等方面来讨论一下。

## 操作系统

首先我们先看看要把Kafka安装到什么操作系统上。说起操作系统，可能你会问Kafka不是JVM系的大数据框架吗？Java又是跨平台的语言，把Kafka安装到不同的操作系统上会有什么区别吗？其实区别相当大！

的确，如你所知，Kafka由Scala语言和Java语言编写而成，编译之后的源代码就是普通的“.class”文件。本来部署到哪个操作系统应该都是一样的，但是不同操作系统的差异还是给Kafka集群带来了相当大的影响。目前常见的操作系统有3种：Linux、Windows和macOS。应该说部署在Linux上的生产环境是最多的，也有一些Kafka集群部署在Windows服务器上。Mac虽然也有macOS Server，但是我怀疑是否有人（特别是国内用户）真的把生产环境部署在Mac服务器上。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/55/55/19ec7b0e.jpg" width="30px"><span>mickle</span> 👍（109） 💬（10）<div>1000*1000&#47;(60*60)=277,这个2336MB是怎么换算来的，还有什么要考虑的吗?</div>2019-06-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c9/90/c7fbf39e.jpg" width="30px"><span>A_NATE_👻</span> 👍（68） 💬（9）<div>我们曾经也认为用普通硬盘就行，换成普通硬盘导致生产者堵塞写入负载偏高，换成SSD就没事了，我们每天消息数大概50亿。</div>2019-06-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/1b/4a/f9df2d06.jpg" width="30px"><span>蒙开强</span> 👍（52） 💬（4）<div>老师，你好，你讲的这几个纬度很好，之前我们搭建一套kafka集群就不知道怎么去衡量，我再问一个相关问题，我个人觉得kafka会出现丢数据情况，比如某个分区的leader挂了，在切换选举到另外副本为leader时，这个副本还没同步之前的leader数据，这样数据就丢了</div>2019-06-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/90/d0/48037ba6.jpg" width="30px"><span>李跃爱学习</span> 👍（34） 💬（16）<div>老师希望解答一下，之前也说明了Kafka 机器上没有混布其他服务，为什么常规需要预留2&#47;3，只能跑240Mbps，</div>2019-07-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/e9/0b/1171ac71.jpg" width="30px"><span>WL</span> 👍（33） 💬（0）<div>有三个问题请教一下老师:
1. 上文提到对于千兆网卡kafka服务器最多使用700M的带宽资源, 这700M的资源是单机使用的还是集群共用的, 为什么不能作为常规使用呢?
2. 文章举例是1小时1T的数据处理目标, 那一秒中是不是1024&#47;3600 = 0.284G = 285M, 请问下文章中的2336M是咋算出来的.
3. 文章中的例子kafka单机要达到240M的读写能力, CPU应该配几核的?</div>2019-06-15</li><br/><li><img src="" width="30px"><span>墙角儿的花</span> 👍（21） 💬（4）<div>弱弱的问一句老师，“根据这个目标，我们每秒需要处理 2336Mb 的数据，除以 240，约等于 10 台服务器”，机房入口带宽1Gbps,怎么能做到1秒处理2336Mb的数据的</div>2019-06-15</li><br/><li><img src="" width="30px"><span>Geek_Sue</span> 👍（19） 💬（2）<div>胡老师，您好，我想请问下，我们公司的环境是基于Docker这种微服务架构，那么kafka部署在Docker容器中部署方案是否会有一些不同呢？</div>2019-06-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c6/73/abb7bfe3.jpg" width="30px"><span>疯琴</span> 👍（16） 💬（3）<div>老师，partitons的数量和硬盘的数量有匹配关系么？一块盘一个partiton比一块盘多个partiton要快么？是线性的关系么？</div>2019-06-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/88/26/b8c53cee.jpg" width="30px"><span>南辕北辙</span> 👍（11） 💬（1）<div>这个假设是：follower与leader处于不同的broker而实际环境中不推荐单机多broker的架构  摘自老师回复其他同学。
老师这个的意思是不是生产上的架构通常一台服务器上只会有leader或者follow的分区，而不会二者存在一台服务器上，所以根据带宽计算服务器数量时，根据备份数为2，所以就直接✖️3了。</div>2019-06-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/85/3b/cfdc8bf2.jpg" width="30px"><span>Royal</span> 👍（11） 💬（2）<div>您好，我想请教下kafka metric相关的知识，比如kafka produce速率获取等</div>2019-06-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ae/ef/cbb8d881.jpg" width="30px"><span>黄智荣</span> 👍（8） 💬（2）<div>老师您好,我们现在用的网络是10Gb,的万兆网.这样主要性能瓶性可会在硬盘IO上,我们配置了24坏的sas 机械盘。
刚才老师主要从容量跟网络性能,评估集群的规模。
我想问一下,怎么从硬盘的IO性能,去评估集群的规模?
还有做6个盘组成一个raid5,比直接用裸盘,性能会有多大的损失?</div>2019-06-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/07/2e/f6a2dc27.jpg" width="30px"><span>Eagles</span> 👍（8） 💬（1）<div>老师你好，Leader Follower 之间的数据冗余复制会不会占带宽？如果占带宽且有两个以上的follows，岂不是把预留的2&#47;3的带宽全部用掉了。</div>2019-06-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ee/27/5b15fa63.jpg" width="30px"><span>Nero</span> 👍（7） 💬（4）<div>好了，有了 240Mbps，我们就可以计算 1 小时内处理 1TB 数据所需的服务器数量了。根据这个目标，我们每秒需要处理 2336Mb 的数据，         老师这一段中2334Mb是怎么算出来的，没看懂，能否解释一下，谢谢。</div>2019-06-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c6/73/abb7bfe3.jpg" width="30px"><span>疯琴</span> 👍（6） 💬（1）<div>老师，如果单机起多个broker是否有可能造成同一个partition的多个副本在一台机器上，损失了容灾能力？</div>2019-06-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/9c/7c/c92f8a53.jpg" width="30px"><span>坤蛰</span> 👍（5） 💬（1）<div>您好！我在使用Kafka中，出现消息阻塞不消费的问题，换了消费组之后过段时间又不消费了，不知什么原因，望老师解惑。谢谢！</div>2019-06-15</li><br/><li><img src="" width="30px"><span>nextforevershit</span> 👍（4） 💬（1）<div>看了下大家的评论，好多都在纠结2336Mb，作为开发人员而且是要学习Kafka的开发人员，竟然连bit和byte都没搞清楚，唉.....，难道大家都没注意你们家里的实际宽带速度和购买的套餐速度差异很大嘛，就是计算单位不同呀！！！
最后，还是膜拜胡老师！</div>2021-01-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0f/70/cdef7a3d.jpg" width="30px"><span>Joe Black</span> 👍（4） 💬（1）<div>发现问的最多的竟然是Byte和Bit的问题...我们用的40Gb的网络，服务器内存290多G，24块万转SAS盘，按老师说的，几十台这样的服务器可以处理很大规模的数据量了吧，都不用怎么规划…</div>2020-05-01</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/mvxl1xzYcAfJERgGHBCswnbeibZJmS1IlP1z9P7KsSh2EPuM78DqPKPicAmHXPYUib6RPcjGcf5vrXkQXAiaLorB2w/132" width="30px"><span>漩涡鸣人</span> 👍（3） 💬（4）<div>老师您好，我遇到一个场景 kafka数据 网络丢包会不会 导致json 字段丢失。比如 {姓名，年龄，生日，{其他信息}  }  嵌套的其他信息数据丢失变成null </div>2020-03-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/84/d3/ccaea6aa.jpg" width="30px"><span>夜影如歌</span> 👍（3） 💬（1）<div>1亿条消息保存两份，是指一个leader一个副本吧
</div>2019-10-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/b6/48/1275e0ce.jpg" width="30px"><span>小头针</span> 👍（3） 💬（3）<div>在生产环境，实时推送过来的数据一份是直接存储到oracle，一份是接收后写入到kafka 对应的topic，storm程序消费后写入到kafka和elasticsearch ，经常会出现当天的oracle存储数据和elasticsearch存储的数据量有差异，有时候能差异率达到15%，胡老师这里面是否有带宽的原因呢？</div>2019-06-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/dd/e0/034ce26f.jpg" width="30px"><span>Fouy_飞虎</span> 👍（3） 💬（3）<div>您好，对于“带宽是 1Gbps，即每秒处理 1Gb 的数据”。1Gbps传输的是byte，我们通常说的存储是字节为单位的。8byte=1字节，所以我认为应该是“带宽是 1Gbps，即每秒处理 1&#47;8 Gb 的数据”</div>2019-06-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/2c/c2/b365bb96.jpg" width="30px"><span>megachilles</span> 👍（2） 💬（1）<div>故通常要再额外预留出 2&#47;3 的资源
——————为什么要额外预留出呢？</div>2019-09-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ac/ce/a1939421.jpg" width="30px"><span>Giant</span> 👍（2） 💬（1）<div>磁盘不做raid如果后面某台broker挂了，重新上线rebalance过程会消耗很多带宽，虽然可以减少topic保留时间来减少rebalance同步的数据量，但个人感觉还是做raid10比较靠谱，故障率低一些。不知道是否有关于这部分更好的解决方案？</div>2019-08-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a6/59/1689ea0c.jpg" width="30px"><span>金hb.Ryan 冷空氣駕到</span> 👍（2） 💬（1）<div>请问对线上内存会有要求么
</div>2019-07-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/4d/76/d47a65d8.jpg" width="30px"><span>曹飞</span> 👍（2） 💬（1）<div>老师您好，您文章中讲到磁盘方面可以抛弃RAID,直接使用普通磁盘上去。那么一旦这块磁盘出问题了，数据不就丢失了吗。如果raid的话，还有其他磁盘有相应的冗余数据的。麻烦帮忙解答下，谢谢！！！</div>2019-06-15</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoPY23R9RRSfBeTJUlyc612VlodjAaWWBNiay9tPydkrd6b9NA8GNibdibnFibTsx94ItHE4jvQwprNzA/132" width="30px"><span>Geek_b809ff</span> 👍（1） 💬（3）<div>老师，请问一直报这个错是因为什么：
 Error while fetching metadata with correlation id 101 : {test=LEADER_NOT_AVAILABLE} (org.apache.kafka.clients.NetworkClient)

另外，server.properties里面下面这几个参数应该怎么配置：
listeners=PLAINTEXT:&#47;&#47;:9092
advertised.listeners=PLAINTEXT:&#47;&#47;:9092
istener.security.protocol.map

老师看到帮忙回复下，困扰一天了</div>2019-08-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/cf/76/9e413c61.jpg" width="30px"><span>Bin滨</span> 👍（1） 💬（1）<div>“根据这个目标，我们每秒需要处理 2336Mb 的数据，除以 240，约等于 10 台服务器， 如果消息还需要额外复制两份，那么总的服务器台数还要乘以 3，即 30 台。

请问一下， 这里说的30台服务器是指 10 个kafka cluster， 每个cluster 有3 brokers? 消息写道leader broker 的topic partition 上， 然后用参数 replication.factor 去做topic的消息备份吗? 多谢！


</div>2019-06-19</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJGMphabeneYXs9otkAtr67RvxJClDa7jPe7w8yExg4YaS2FGJruDKMj5yN1E90o6MFibnicH8gM0ibg/132" width="30px"><span>hadoop_admin</span> 👍（0） 💬（2）<div>胡老师，kafka 现在支持ipv6的部署么？</div>2021-09-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/d1/b0/e8db9565.jpg" width="30px"><span>钟</span> 👍（0） 💬（1）<div>“如果消息还需要额外复制两份，那么总的服务器台数还要乘以 3，即 30 台”，不太明白这句话的意思，意思是如果分区是3副本，副本拉取数据需要占用带宽，所以要乘以3吗？</div>2021-07-09</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJIIibocUHNRgafeNUvibW0YI2v1qDaiaZCVQ37FcrMs0ettIDD0snhsy4Ac2ADnLmjM7KGNeznj2hrg/132" width="30px"><span>一十六夜</span> 👍（0） 💬（1）<div>请教一下，生产环境如果部署3台服务器的kafka集群，那么zk可以和kafka部署在同一台服务器作为集群么？PS：使用kafka自带的zk</div>2021-04-10</li><br/>
</ul>