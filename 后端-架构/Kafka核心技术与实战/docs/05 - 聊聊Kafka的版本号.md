你好，我是胡夕。今天我想和你聊聊如何选择Kafka版本号这个话题。今天要讨论的内容实在是太重要了，我觉得它甚至是你日后能否用好Kafka的关键。

上一期我介绍了目前流行的几种Kafka发行版，其实不论是哪种Kafka，本质上都内嵌了最核心的Apache Kafka，也就是社区版Kafka，那今天我们就来说说Apache Kafka版本号的问题。在开始之前，我想强调一下后面出现的所有“版本”这个词均表示Kafka具体的版本号，而非上一篇中的Kafka种类，这一点切记切记！

那么现在你可能会有这样的疑问：我为什么需要关心版本号的问题呢？直接使用最新版本不就好了吗？当然了，这的确是一种有效的选择版本的策略，但我想强调的是这种策略并非在任何场景下都适用。如果你不了解各个版本之间的差异和功能变化，你怎么能够准确地评判某Kafka版本是不是满足你的业务需求呢？因此在深入学习Kafka之前，花些时间搞明白版本演进，实际上是非常划算的一件事。

## Kafka版本命名

当前Apache Kafka已经迭代到2.2版本，社区正在为2.3.0发版日期进行投票，相信2.3.0也会马上发布。但是稍微有些令人吃惊的是，很多人对于Kafka的版本命名理解存在歧义。比如我们在官网上下载Kafka时，会看到这样的版本：
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/8f/35/f1839bb2.jpg" width="30px"><span>风中花</span> 👍（16） 💬（2）<div>每次看完就想打卡，以表示我还在坚持学习，如此看来，这个版本真不能忽视</div>2019-06-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/52/eb/eec719f3.jpg" width="30px"><span>开水</span> 👍（12） 💬（1）<div>目前用的是hdp2.4.2内嵌版本。应该是apache版本的0.8.2.0。遇到很多问题都很难找到解决方法。比如前几天遇到了replicaFetcherThread oom的问题，网上根本找不到什么正经的解释。但又不能一味的调高jvm参数。老大说现在生产稳定就行了，暂时不要升级了，改代码耗时切面对的问题未知。期待老大能看到这篇文章，升级到0.11.0.3。</div>2019-06-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ab/82/b6af9f94.jpg" width="30px"><span>King Yao</span> 👍（11） 💬（3）<div>我是一名运维，在维护工作环境维护几十台Kafka。最近打算扩容。我有三个问题请教：
1.kafka如何做压力测试，它的参考主要指标是什么，比如QPS,最大连接数，延迟等等。
2.扩容如何做到平滑扩容，不影响原业务
3.kafka有什么好的监控软件。</div>2019-06-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/8d/6f/c21eff20.jpg" width="30px"><span>平叔叔</span> 👍（7） 💬（2）<div>不论你用的是哪个版本，都请尽量保持服务器端版本和客户端版本一致  另外即使你升到了 0.8.2.2，也不要使用新版本 Producer api 不是互相矛盾吗？

</div>2019-09-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/88/26/b8c53cee.jpg" width="30px"><span>南辕北辙</span> 👍（6） 💬（1）<div>记得在刚开始学kafka写demo时，找到了kafka.producer.Producer,以及apache.kafka...KafkaProducer，还以为只是2种不同的实现方式，后来在老师的书上才得知这完全是2个版本。针对今天讨论的版本差异，书上也做了很好了总结。
现在看来比较难理解的就是客户端的版本与服务端版本的兼容问题，与之前的各种技术还是有点差异的，并不是一味的较新客户端就完事，kafka中还有一种请求版本号的存在。
图片为书中版本对比
https:&#47;&#47;raw.githubusercontent.com&#47;DarkerPWQ&#47;picgo&#47;master&#47;img&#47;Kafka%E7%89%88%E6%9C%AC%E5%8F%98%E8%BF%81.png</div>2019-06-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c6/73/abb7bfe3.jpg" width="30px"><span>疯琴</span> 👍（6） 💬（2）<div>美音最正的老师没有之一。有两个问题：1 文章前面说某些旧版本的服务端不适用新版本的客户端，文末又说二者应该保持一致，感觉是矛盾的，应该是我没理解清楚，还请说明 2 服务端版本靠编号就可以识别，而客户端是怎么定义新旧版本的呢？谢谢。</div>2019-06-13</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEIaTvOKvUt4WnuSjkBp0tjd6O6vvVyw5fcib3UgZibE8tz2ICbTfkwbzs8MHNMJjV6W2mLjywLsvBibg/132" width="30px"><span>火力全开</span> 👍（4） 💬（2）<div>“最后还有个建议，不论你用的是哪个版本，都请尽量保持服务器端版本和客户端版本一致，否则你将损失很多 Kafka 为你提供的性能优化收益。”  ——  KIP-35 - Retrieving protocol version 这个特性不是可以让支持的client适配多个不同版本的broker吗？</div>2020-02-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/05/b2/2ff81f75.jpg" width="30px"><span>bee</span> 👍（4） 💬（2）<div>请问胡老师， RESTful的幂等性是无论调用多少次都不会有不同结果的HTTP 方法。也就是说不会去改变资源。这里的幂等性虽然是确保了单个partition的数据不会重复，但是更改了资源。这样说会有冲突吗？</div>2019-06-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/b7/f9/a8f26b10.jpg" width="30px"><span>jacke</span> 👍（3） 💬（1）<div>胡老师，问下：
&quot;如果你不能升级大版本，我也建议你至少要升级到0.8.2.2+这个版本，因为该版本中老版本消费者API是比较稳定的。另外即使你升到了0.8.2.2，也不要使用新版本+Producer+API，此时它的Bug还非常多&quot; == 不是很明白
这段话的意思升级到0.8.2.2，使用0.8.2.2的consumer api, 但是不要0.8.2.2的 producer api? 使用0.8大版本号下的producer api 是这个意思吗</div>2019-06-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/cf/ad/c639270f.jpg" width="30px"><span>云＆龙</span> 👍（3） 💬（1）<div>既然新版本的老功能更加完善，而老版本又没有新版本的新功能，那为什么不无脑用最新的版本呢？？？反正用老版本也没有新功能。</div>2019-06-13</li><br/><li><img src="" width="30px"><span>顾君</span> 👍（2） 💬（1）<div>以前觉得软件哪个版本不都一样的么？就算选jar包的时候 偶尔也只看看使用数的情况，经过讲解之后，发现版本的选择确实相当重要，不要盲目的去选择版本，盲目的选择只会给以后的开发埋下祸根。</div>2020-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/53/5d/46d369e5.jpg" width="30px"><span>yellowcloud</span> 👍（2） 💬（1）<div>老师，请教一下，有没有好的kafka版本升级的方案呢，现在kafka已经部署到生产环境了，升级的话，需要直接推倒重做吗？</div>2019-06-17</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKerOHGs8VAMWj0ysxZpTPcARHEITiaH8YDJR7aoDNYhRpbLsZ0pJdJXIfzvR7u06iaKPBUoWfic5Zww/132" width="30px"><span>Geek_qsftko</span> 👍（1） 💬（1）<div>胡老师，如果使用kafka 0.11, Flink 1.10版本的前提下， kafka -&gt; Flink -&gt; kafka stream -&gt; HBase 这样的一个数据流向，是不是可以实现 exactly once ??</div>2020-09-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/83/19/0a3fe8c1.jpg" width="30px"><span>Evan</span> 👍（1） 💬（1）<div>不要成为最新版本的小白鼠， 如果确实想升级，也建议小范围可控制之内再升级。</div>2020-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0d/6f/6af1d734.jpg" width="30px"><span>Geek_sky</span> 👍（1） 💬（2）<div>看到版本号命名这，有一个问题想问一下，小版本号和修订版本号有什么区别呢？小版本号是新增小的功能，而修订版本号是修改发现的bug，是这个区别吗？</div>2019-08-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/43/e3/abb7bfe3.jpg" width="30px"><span>focusOn</span> 👍（1） 💬（1）<div>使用 kafka 2.0.0版本   在整个应用中只创建了一个 Kafka Producer   , 每次调用 包装过的同步静态方法插入消息，其中插入静态方法调用了 Kafka Producer 的 send  方法，应用 OOM 情况下，Kafka 的 Producer  发送消息的  IoThread 线程被关闭，导致消息不能正常写入，这个是一个 bug 吗？老师？</div>2019-06-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/fb/58/6c422e70.jpg" width="30px"><span>清晨吼于林</span> 👍（1） 💬（1）<div>老师您好，打扰您了，不过还是想问一下您：
kafka的时间轮里面，第一层的时间轮，默认tick一次是1ms，轮长度为20，一个轮子转下来也就20ms，那为什么ExpiredOperationReaper的时间间隔是200ms啊？</div>2019-06-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/48/f3/65c7e3ef.jpg" width="30px"><span>cricket1981</span> 👍（1） 💬（1）<div>老师觉得kafka发展方向是什么？继续完善流处理还是消息引擎？</div>2019-06-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/04/0d/3dc5683a.jpg" width="30px"><span>柯察金</span> 👍（0） 💬（1）<div>老师只是提到 server 端的版本，那 client 端的版本呢。。。</div>2021-09-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/55/09/73f24874.jpg" width="30px"><span>建华</span> 👍（0） 💬（1）<div>老师好，您说的服务器端版本号与客户端版本号要保持一致，是说kafka集群和开发的应用程序中两者的版本一致吗</div>2021-02-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/7d/a5/84662e0e.jpg" width="30px"><span>桃梦依然</span> 👍（0） 💬（1）<div>hi，胡老师，请问一个kafka的版本问题，我cdh集群，下载了一个kafka的parcel包，kafka-4.1.0-1.4.1.0.p0.4。
这个kafka是什么版本来的，是1.4.1.0版本吗</div>2020-07-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/64/9b/d1ab239e.jpg" width="30px"><span>J.Smile</span> 👍（0） 💬（1）<div>版本列表整理:
0.7 基础消息队列功能
0.8 引入副本功能
0.8.2.0 引入新版本 Producer API
0.9.0.0 增加了基础的安全认证 &#47; 权限功能，同时使用 Java 重写了新版本消费者 API，另外还引入了 Kafka Connect 组件用于实现高性能的数据抽取.
0.10.0.0 引入了 Kafka Streams。
0.10.1 和 0.10.2  主要功能变更都是在 Kafka Streams 组件上.
0.11.0.0 引入了两个重量级的功能变更：
一.提供幂等性 Producer API 以及事务（Transaction） API；
0.11.0.3  这个版本的消息引擎功能已经非常完善了。
二.对 Kafka 消息格式做了重构。
 1.0 和 2.0 这两个大版本主要还是 Kafka Streams 的各种改进，在消息引擎方面并未引入太多的重大功能特性。</div>2020-06-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/51/0d/fc1652fe.jpg" width="30px"><span>James</span> 👍（0） 💬（2）<div>请问下老师:
客户端服务端保持一致
服务端kafka为0.9版本,又因为0.8producer API不稳定,0.9consumer API不稳定;
那是不是客户端得使用0.10版本得api是吧?</div>2020-05-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d9/59/54692189.jpg" width="30px"><span>柳晓峰</span> 👍（0） 💬（1）<div>如果是消息队列服务 就用0.11.0.3
如果是流处理 至少使用kafka 2.0这个版本
客户端和服务端统一版本号，规避格式不统一，不好处理等问题</div>2020-05-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/7a/93/c9302518.jpg" width="30px"><span>高志强</span> 👍（0） 💬（1）<div>老师kafka的版本号，可以用程序代码输出么？怎么写的呢</div>2019-12-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/46/5b/07858c33.jpg" width="30px"><span>Pixar</span> 👍（0） 💬（1）<div>&quot;如果你依然在使用 0.10 大版本，我强烈建议你至少升级到 0.10.2.2 然后使用新版本 Consumer API。&quot;, 关于这句话有点疑问，如何使用新版本 consumer api呢？ 比如 golang版的kafka 客户端库， 是我只需要更改一下调用方式就好了？ 还是说我需要 更新这个golang 客户端库使其里面支持 新版consumer api呢？</div>2019-10-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ae/fc/d647a3e4.jpg" width="30px"><span>尘枫</span> 👍（0） 💬（1）<div>胡老师，我们最近在使用命令行查询消费组消费信息时，报Scheme 异常，说是SchemaException Error read field &#39;user_data&#39;怀疑是版本兼容性问题，请问胡老师这个怎样排查， 有验证方法或者思路吗？</div>2019-08-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/43/e3/abb7bfe3.jpg" width="30px"><span>focusOn</span> 👍（0） 💬（1）<div>未开启Kafka  Security ，  全局一个 Producer实例， OOM 是业务代码导致非 Kafka 插入消息导致 </div>2019-06-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/ec/fb/019b8b31.jpg" width="30px"><span>黑色</span> 👍（0） 💬（1）<div>我们目前用的是kafka1.0x, 用的spark版本号是2.1.3,spark-kafka依赖jar目前最新的是0.10.x,这样是不是服务端与客户端的版本不一样了？</div>2019-06-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/48/f3/65c7e3ef.jpg" width="30px"><span>cricket1981</span> 👍（0） 💬（1）<div>我们用的是confluent 5.0，使用了ksql，若要升级大版本的话要注意哪些？</div>2019-06-13</li><br/>
</ul>