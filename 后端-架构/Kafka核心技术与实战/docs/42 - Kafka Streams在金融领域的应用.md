你好，我是胡夕。今天我要和你分享的主题是：Kafka Streams在金融领域的应用。

## 背景

金融领域囊括的内容有很多，我今天分享的主要是，如何利用大数据技术，特别是Kafka Streams实时计算框架，来帮助我们更好地做企业用户洞察。

众所周知，金融领域内的获客成本是相当高的，一线城市高净值白领的获客成本通常可达上千元。面对如此巨大的成本压力，金融企业一方面要降低广告投放的获客成本，另一方面要做好精细化运营，实现客户生命周期内价值（Custom Lifecycle Value, CLV）的最大化。

**实现价值最大化的一个重要途径就是做好用户洞察，而用户洞察要求你要更深度地了解你的客户**，即所谓的Know Your Customer（KYC），真正做到以客户为中心，不断地满足客户需求。

为了实现KYC，传统的做法是花费大量的时间与客户见面，做面对面的沟通以了解客户的情况。但是，用这种方式得到的数据往往是不真实的，毕竟客户内心是有潜在的自我保护意识的，短时间内的面对面交流很难真正洞察到客户的真实诉求。

相反地，渗透到每个人日常生活方方面面的大数据信息则代表了客户的实际需求。比如客户经常浏览哪些网站、都买过什么东西、最喜欢的视频类型是什么。这些数据看似很随意，但都表征了客户最真实的想法。将这些数据汇总在一起，我们就能完整地构造出客户的画像，这就是所谓的用户画像（User Profile）技术。
<div><strong>精选留言（12）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/ed/4c/8674b6ad.jpg" width="30px"><span>timmy21</span> 👍（2） 💬（1）<div>KTable是全部保存在内存吗？具体实现是怎么样的？</div>2020-10-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/6a/fe/446c0282.jpg" width="30px"><span>Minze</span> 👍（1） 💬（1）<div>胡老师您好，最近我在学习使用Kafka streams，有一点让我困惑的是在使用join的时候，生成的topology中会有一些名字包含KSTREAM–JOINTHIS和KSTREAM–OUTEROTHER的processor和store创建出来，这些本地的store应该是用来存储join要用到的数据，这我能理解，但是这些processor的作用和JOINTHIS、OUTEROTHER的命名含义却百思不得其解，老师可否给些建议或者提示？</div>2021-04-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ef/0c/e2169f41.jpg" width="30px"><span>King</span> 👍（1） 💬（1）<div>最后写入outputTopic是以append还是update？可以保证用户在outputTopic中只有一条记录吗？</div>2020-03-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d2/6a/a9039139.jpg" width="30px"><span>IT小僧</span> 👍（1） 💬（3）<div>老师好，这个构造IDMapping中的KTable对象肯定会越来越大吧，这个怎么处理呢</div>2020-02-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/64/9b/d1ab239e.jpg" width="30px"><span>J.Smile</span> 👍（0） 💬（1）<div>老师，我看到有使用stream加迭代器的方式去消费消息的，貌似建立连接时传入了一个topicCount的map，也就是说这个stream其实可以消费到多个topic的数据，总觉得有点奇怪，因为跟老师之前课程里那种poll的方式差别很大。我不太能明白这种形式消费数据，到底消费者对应是某一个stream？还是topicCount的每个topic？是哪个决定了consumer的数量？</div>2020-07-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/bd/18/2af6bf4b.jpg" width="30px"><span>兔2🐰🍃</span> 👍（11） 💬（4）<div>App上发现该栏目更新了最后一节，目前才学到22节，完成了前三章的了解。我从上个月20日开始的，有20天时间了，也算是从0开始的，对Kafka有了很多了解，每听完一节，遍跟着写笔记，结构化文章内容，感觉有点慢，实践还没开始。明天起换个方式试试效果，搭个环境，实践下前22节内容，接着后面的章节先每章节内容听一遍后梳理整个章节的内容，再到实践。
感谢胡老师的教课，节日快乐~</div>2019-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg" width="30px"><span>曾轼麟</span> 👍（5） 💬（0）<div>left join 可以关联上不存在的数据行，而join其实是inner join 需要两张表数据都匹配上结果才会有，left join的好处就是，如果其中有一张表没有匹配数据，也不会导致结果集没有这条记录</div>2019-09-11</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/2giaUb5iczia7HciagrnDoo4hSSZKFQT0VXKyjE9eBb2FzBGvD2qoU0icS3WYRvN15BM6iaicW9cOTmewDHrDvFPIIcLQ/132" width="30px"><span>Shopman</span> 👍（1） 💬（0）<div>希望再出一个streams课程！！！</div>2023-06-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2a/b9/40/e350862c.jpg" width="30px"><span>Kaine</span> 👍（0） 💬（0）<div>老师在&lt;VT, VR&gt; KStream&lt;K, VR&gt; leftJoin(final KTable&lt;K, VT&gt; table,
                                     final ValueJoiner&lt;? super V, ? super VT, ? extends VR&gt; joiner);
有这么一段注释，上面说输入流的分区数必须与Ktable对应的topic的分区数一致这是为什么呢
Both input streams (or to be more precise, their underlying source topics) need to have the same number of partitions. If this is not the case, you would need to call through(String) for this KStream before doing the join, using a pre-created topic with the same number of partitions as the given KTable. Furthermore, both input streams need to be co-partitioned on the join key (i.e., use the same partitioner); cf. join(GlobalKTable, KeyValueMapper, ValueJoiner). If this requirement is not met, Kafka Streams will automatically repartition the data, i.e., it will create an internal repartitioning topic in Kafka and write and re-read the data via this topic before the actual join. The repartitioning topic will be named &quot;${applicationId}-&lt;name&gt;-repartition&quot;, where &quot;applicationId&quot; is user-specified in StreamsConfig via parameter APPLICATION_ID_CONFIG, &quot;&lt;name&gt;&quot; is an internally generated name, and &quot;-repartition&quot; is a fixed suffix.</div>2022-02-23</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eq6pWvKsV4rzQ62z5MDEjaEU5MbDfmzbA62kUgoqia2tgKIIxw4ibkDhF7W48iat5dT8UB9Adky2NuzQ/132" width="30px"><span>小仙</span> 👍（0） 💬（0）<div>这里用到的 4 个 topic 就是普通的 topic 吗？也是默认 7 天消息过期等等设定，并非永久保存</div>2022-01-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/19/df/5486f00d.jpg" width="30px"><span>朝花西落</span> 👍（0） 💬（0）<div>代码的99行是不是没有必要呢，我感觉既然是按手机号key来做join的，那不管value2是否为null，最终都应该是value1的值。因为如果不为null，value1和value2也是相等的吧。</div>2020-11-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/bb/c2/cbd652ab.jpg" width="30px"><span>布吉岛上的不科学君</span> 👍（0） 💬（0）<div>老师你好，我有一个疑惑：
首先，假设用户注册的时候只有【手机号】信息，那么KTable里是没有【DeviceId】和【IdCard】的。
然后用户发生的第一次操作，携带了【DeviceId】，第二次操作携带了【IdCard】，这些数据从代码上看是不会更新【KTable】的，那么【outputTopic】两次输出的内容都是不全面，也就是说【outputTopic】没法同时输出携带了【DeviceId和IdCard】信息的吧？希望胡老师能够抽空解答一下，谢谢。
</div>2020-07-09</li><br/>
</ul>