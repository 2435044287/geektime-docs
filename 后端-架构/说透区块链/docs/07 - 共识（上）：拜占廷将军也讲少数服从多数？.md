你好，我是自游。

在上一讲中，我提到交易扩散的时候，说过交易自连接节点开始逐步向外扩散，最终会有一个时刻，所有的节点都可以收到该交易。这也就意味着去中心化网络中，想要实时保证每个节点数据状态一致比较困难，网络越分散，数据扩散的时间也越久，一致性也越难以达成。更不要说还存在专门搞破坏的作恶者，故意阻碍一致性的达成。

因此，就需要专门有一种机制去协调，使其在一定程度上约束节点的行为，来保证整个区块链网络保持状态的一致性，而这也就是这一讲要学习的共识算法。**共识算法可以说是区块链技术的核心思想，是区块链运行的行为准则。**

我会通过两讲的内容，带你快速理解区块链里的共识算法。为了让你轻松理解共识算法，这节课我会用一个故事为你解析共识背后的基础知识点，而下一节课再将知识点融入到区块链中，为你详细剖析区块链中是如何解决共识问题的。

## 拜占庭将军问题

话说在拜占庭帝国，9位将军分别率领一支军队要共同围困一座城市。但是这座城市军事实力很强大，如果不协调统一将军们的行动策略，部分军队进攻、部分军队撤退会造成围困失败。

因此，各位将军必须通过投票达成一致策略，少数服从多数，要么一起进攻，要么一起撤退。

因为各位将军分别占据城市的一角，他们只能通过信使互相联系。在协调过程中，每位将军都将自己想“进攻”还是“撤退”的消息通过信使分别通知其他所有将军，这样一来每位将军根据自己的投票和其他将军送过来的投票，就可以知道投票结果，然后决定是进攻还是撤退。
<div><strong>精选留言（14）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/16/c4/7c/cd040ab6.jpg" width="30px"><span>三儿</span> 👍（3） 💬（3）<div>可不可以用图示来表示一下三个将军情况下，B将军想做恶而导致达不成一致的情况呀</div>2021-08-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a7/b2/274a4192.jpg" width="30px"><span>漂泊的小飘</span> 👍（1） 💬（1）<div>是不是为了防止发起者作恶的可能性呢？</div>2021-08-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/f7/62/947004d0.jpg" width="30px"><span>www</span> 👍（1） 💬（2）<div>为什么还要再有一个“确定 A 要进攻”的阶段呢？之前只是各位将军自己知道，说出来才能让A确定，大家都收到了自己要进攻的信息。</div>2021-08-04</li><br/><li><img src="" width="30px"><span>InfoQ_095d09facfde</span> 👍（0） 💬（1）<div>为什么不是1&#47;2 按这样分析A第一轮信息扩散完第二轮信息其他所有的信息到达另外几位将军，综合所有的信息输入，只要超过1&#47;2就能确定A此次进攻还是撤退吧。</div>2023-02-28</li><br/><li><img src="" width="30px"><span>Geek_3d623d</span> 👍（0） 💬（1）<div>哪里进群啊？</div>2023-02-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/c0/0a/312ad74f.jpg" width="30px"><span>姚莉莉</span> 👍（0） 💬（1）<div>在4个节点，B节点是坏人的情况下，有一个推演进行不下去了，请指教。假设是A发起投票。A向B、C、D发出了yes信号。B向A回复了yes，但是故意搞破坏，来给C，D转发出no信号。
到此刻，A完成了对所连三个节点的交易&#47;消息扩散；B也完成了根据收到的信息再对它所连三个节点的消息扩散。
接下来C节点也想参与扩散，可是发现自己收到的是一个来自A的yes信号，一个来自B转发的no信号。它就不知道自己应该向外，向它所连的A、B、D发出什么信号了啊？是发yes，还是发no。那么接下去，C该怎么继续下去呢？不然，难道这一轮投票就卡在这里了吗？</div>2021-10-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/e3/01/a254f22d.jpg" width="30px"><span>童言</span> 👍（3） 💬（1）<div>拜占庭问题引出了分布式系统中一个重点：共识。</div>2021-08-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a8/35/85033228.jpg" width="30px"><span>亚东</span> 👍（1） 💬（0）<div>确认A要进攻我觉得是一个非常重要的环节，如果所有节点能达成一致，说明系统是可信的，叛徒数没有拆过1&#47;3，相反如果大家就A是否要有歧义，说明系统是不可信的。区块链在尝试在一个真实且紊乱的场景下，构建共识，这是一个系统层面的事情，而不是单一判断真假的问题。</div>2022-04-22</li><br/><li><img src="" width="30px"><span>Geek_3d623d</span> 👍（0） 💬（0）<div>能不能加我下进群 wucs_dd</div>2023-02-21</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/gIE15oOl1IicE8hicpPzuoARricgaL3y4nHDXaFCPX0U3UX3szgtrKCa4zCPc5GkdpceP0mftbJg3MdKHOLJOKJww/132" width="30px"><span>Geek_66a431</span> 👍（0） 💬（0）<div>打包成区块应该是为了效率, 当前全网所有的节点 只对某一区块进行确认, 而不是对每笔都确认,扩大区块会显著降低网络拥堵, 但是会造成全节点过大, 介入成本太高, btc和bth分叉就为了这事</div>2022-04-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/56/60/fb5ca9e5.jpg" width="30px"><span>黄矢</span> 👍（0） 💬（0）<div>达到A要进攻的共识了，返回确认A，是为了找到叛徒 ，共识是要进攻，A也是说要进攻，那么传递过程中说A不进攻的是叛徒，如果A说的是不进攻，共识是进攻，要么A是叛徒，要么叛徒很多</div>2022-02-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/fa/eb/84d4de33.jpg" width="30px"><span>HF</span> 👍（0） 💬（0）<div>在 A 将军共识示意图中，在“A 要进攻”这个阶段之后，各位将军已经能够得出“A 要进攻”这个共识结果了，为什么还要再有一个“确定 A 要进攻”的阶段呢？

我是这样理解的不知道对不对： 因为所有的节点都是平等的，A要发起进攻的消息不一定是A发起的，但是又想达到共识，B是破坏者，但是他并不知道是A发起的A要发起进攻了，那么B要搞破坏，会向ABC发出A不进攻，那样信息的发起者会发现有叛徒，可以将叛徒识别出来。</div>2022-02-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/a7/6a/b1bd0097.jpg" width="30px"><span>Harry</span> 👍（0） 💬（2）<div>在分布式系统中，经常会有一些选主的场景，也是经常围绕拜占庭将军问题展开的</div>2021-11-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ef/a2/62b73e2a.jpg" width="30px"><span>二两</span> 👍（0） 💬（0）<div>讨论：多一层确认的目的是看看其他节点收到的信息是否与自己一致，避免单节点作恶，这样从一方面体现了，作恶节点数如果大于 1&#47;3 那么在确认阶段，也可以作恶的事实。</div>2021-08-19</li><br/>
</ul>