你好，我是袁武林。

今天，我要带你了解的是一项在IM系统中相对比较通用的、使用比较高频的，而且对系统性能提升非常明显的技术：缓存。

说到缓存，你应该不陌生。相对于磁盘操作，基于内存的缓存对耗时敏感的高并发应用来说，在性能方面的提升是非常明显的。

下面是谷歌的技术奠基人杰夫·狄恩（Jeff Dean）给出的一些[计算机相关的硬件指标](http://highscalability.com/numbers-everyone-should-know)，虽然有些数据可能由于时间太久不够准确，但大致的量级基本还是一致的。

- L1 cache reference 0.5 ns
- Branch mispredict 5 ns
- L2 cache reference 7 ns
- Mutex lock/unlock 100 ns
- Main memory reference 100 ns
- Compress 1K bytes with Zippy 10,000 ns
- Send 2K bytes over 1 Gbps network 20,000 ns
- Read 1 MB sequentially from memory 250,000 ns
- Round trip within same datacenter 500,000 ns
- Disk seek 10,000,000 ns
- Read 1 MB sequentially from network 10,000,000 ns
- Read 1 MB sequentially from disk 30,000,000 ns
- Send packet CA-&gt;Netherlands-&gt;CA 150,000,000 ns
<div><strong>精选留言（29）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg" width="30px"><span>那时刻</span> 👍（10） 💬（2）<div>请问怎么保证local cache到cache master的数据一致性呢？毕竟local cache在分布式的服务器集群，会有同一个文档发到不同服务器local cache的情形。从图中看出，是某一个local cache负责同步数据到cache master么？或者我有什么误解？烦请指正</div>2019-10-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/f5/98/45374bb9.jpg" width="30px"><span>小小小丶盘子</span> 👍（9） 💬（1）<div>开线程定时访问热点数据，保证不被淘汰。</div>2019-10-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/dc/b9/946b181d.jpg" width="30px"><span>好运连连</span> 👍（5） 💬（2）<div>为什么把master也当作L1可以解决热度问题？难道每一次master过期也会主动把从库的对应缓存删除？</div>2019-11-12</li><br/><li><img src="" width="30px"><span>Geek_37e993</span> 👍（4） 💬（5）<div>请教一下，L1缓存和slave以及后端存储的数据一致性如何保证呢？</div>2019-10-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8d/6c/0c2a26c7.jpg" width="30px"><span>clip</span> 👍（4） 💬（1）<div>主从以及那边有点不明白。
为什么从库节点中有全部的数据？
某个节点有全量的数据却只有部分对象的查询分配到自己。
我理解的如果有全量数据那就直接循环着去不同节点中取不就行了吗，也就不需要缓存分布式算法了吧。</div>2019-10-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6b/f8/b4da7936.jpg" width="30px"><span>大魔王汪汪</span> 👍（3） 💬（1）<div>老师L1缓存具体是实现和缓存层究竟有什么区别呢？还是说技术实现上本身没有区别，只不过存储目的不同？比如L1就是为了解决热数据的</div>2019-10-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/10/53/2230bf9d.jpg" width="30px"><span>王蒙</span> 👍（2） 💬（1）<div>举个例子，单台机器 120MB 带宽，对于 1MB 大小的文章来说，如果 QPS 到 1000 的话，至少需要 8 个实例才可以抗住。

请问，8是怎么算的，有什么公式吗？
8个实例是指单台物理机，上面8个虚拟机，还是一台机器上部8个相同应用?
还有平时手机的流量是指http请求的request的请求头和body的大小吗，response的算吗?</div>2019-11-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/63/0b/ad56aeb4.jpg" width="30px"><span>AI</span> 👍（2） 💬（1）<div>对于L1解决带宽问题，感觉文中没讲太清楚。机器带宽和网卡有关系，相同配置的机器带宽一样。从库和L1如果机器数量一样，同样带宽是没问题的。也就是说L1在存储成本上有优势，带宽上没优势吧？</div>2019-10-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/55/a9/5282a560.jpg" width="30px"><span>yic</span> 👍（1） 💬（2）<div>老师，有两个问题请教一下：
1. L1缓存业界一般是如何实现的？
2. 关于课后问题的解答，老师提供的思路是：“另外可以考虑把master也加入到L1缓存层中，这样能保持数据热度“。我想问一下，如果发生了主从关系变化呢？这时如何把master加入到L1缓存层呢？</div>2019-11-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/3b/7c/a977d9a9.jpg" width="30px"><span>独酌相思解千愁</span> 👍（1） 💬（1）<div>对于思考题，将各级缓存的存活时间分级设定，L1最小，每当L1重新拉取数据时同时更新其他缓存层的相应热点数据。同时对于一段时间类使用比较频繁的数据可以按照一定规则增加其存活时间（或者权重） 不知道这样有可行性不</div>2019-11-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cd/aa/33d48789.jpg" width="30px"><span>卫江</span> 👍（1） 💬（2）<div>思考题，我感觉可以在L1层，根据访问的特定数据的频率，比如qps超过100就去后面缓存拉一下，这样一来实现简单，频率不高又能保证热数据不被淘汰，同时也可以作为L1缓存的数据更新保证数据一致性的实现方式。</div>2019-10-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/77/d5/1441f02c.jpg" width="30px"><span>孙凯</span> 👍（1） 💬（1）<div>老师能详细讲下L1级缓存怎么用么？</div>2019-10-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/dd/48/e875e2bf.jpg" width="30px"><span>老船长</span> 👍（0） 💬（1）<div>本地缓存结合广播通知缓存失效，这个方式怎么样？</div>2020-03-03</li><br/><li><img src="" width="30px"><span>Geek_e986e3</span> 👍（0） 💬（1）<div>老师 我看你说将master节点当作l1来用保证不过期。这样的话我能理解成l1实际上也就是容量缩小版的从节点吗？</div>2019-10-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/82/42/8b04d489.jpg" width="30px"><span>刘丹</span> 👍（0） 💬（1）<div>请问L1缓存是指redis、memcached这种网络缓存吗？</div>2019-10-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/3d/02/ecdb4e66.jpg" width="30px"><span>东东🎈</span> 👍（0） 💬（2）<div>老师，hash(uid)%10和uid%10这两个有啥区别？然后L1空间很小，一般存放哪些类型的数据呢？</div>2019-10-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg" width="30px"><span>piboye</span> 👍（1） 💬（0）<div>可以用一个随机数，如果命中某个值就异步放量到master上。这样就有一定比例的访问到master了</div>2020-05-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/b4/94/2796de72.jpg" width="30px"><span>追风筝的人</span> 👍（0） 💬（0）<div>取模求余算法在实现上非常简单，但存在的问题是，取模求余算法在节点扩容和宕机后会出现震荡，缓存命中率会严重降低。
一致性哈希算法解决了节点增删时震荡的问题，并通过虚拟节点的引入，缓解了“数据倾斜”的情况。</div>2022-09-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/18/3e/f8632713.jpg" width="30px"><span>EveryDayIsNew</span> 👍（0） 💬（0）<div>这种要是放弃L1缓存，然后检测出来热点key，之后把热点key加个几个随机数再散列给集群呢，这样集群的每个节点都理论上会有一份，加上一层L1缓存是不是复杂性高了呢</div>2020-09-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/13/71/3762b089.jpg" width="30px"><span>stevensafin</span> 👍（0） 💬（0）<div>L1Cache表示什么？用什么实现？和主从Cache的区别是什么？概念本身还是希望老师能够先解释清楚哈</div>2020-08-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/b6/74/c63449b1.jpg" width="30px"><span>问题究竟系边度</span> 👍（0） 💬（0）<div>L1缓存可以参考知乎的已读服务架构，两层缓存的维度会不一样</div>2020-08-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/84/4b/e4738ba8.jpg" width="30px"><span>delete is create</span> 👍（0） 💬（0）<div>长轮训在集群中会不会出问题  比如你的长轮训是挂在了a节点  但是你要请求的数据是对方在b节点返回的</div>2020-06-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/84/4b/e4738ba8.jpg" width="30px"><span>delete is create</span> 👍（0） 💬（0）<div>如果分布式缓冲用的是redis，是否可以使用redis的发布订阅模式 通知客户端去更新缓冲？ 因为多级缓冲还有一种场景是存放配置，这些配置一般都不咋变，没必要每次都访问redis，可以保存在本地缓冲中，这些配置一般都不咋变，如果时间设置的太短，那多级缓冲的意义就不明显了。</div>2020-06-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg" width="30px"><span>piboye</span> 👍（0） 💬（0）<div>一致性hash不讲谷歌的jumphash吗？我发现市面上的课程，都是老一套的环状的。</div>2020-05-10</li><br/><li><img src="" width="30px"><span>tm1234</span> 👍（0） 💬（0）<div>请问老师l1是只存热点文章吗，还是说他就是主从缓存的一个副本，存储所有数据？如果是只存热点的话是怎么实现的呢？</div>2020-04-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/8f/3a/49d38340.jpg" width="30px"><span>天雨</span> 👍（0） 💬（0）<div>“在主从模式下，一篇文章只会映射到一个从库节点上。虽然能够通过增加从库副本数来提升服务端对一篇文章的读取能力”。想问一下老师，具体是怎么增加从库的副本数呢？如何能让新加的机子正好能落在这篇文章映射的节点上？谢谢</div>2020-03-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/9a/0f/da7ed75a.jpg" width="30px"><span>芒果少侠</span> 👍（0） 💬（0）<div>请问下老师 L1缓存层怎么解决的带宽问题？如果请求量不变，那出网依然会占据带宽，不存在带宽消耗减少的优势吧？</div>2020-03-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7c/16/4d1e5cc1.jpg" width="30px"><span>mgxian</span> 👍（0） 💬（0）<div>主从缓存层不使用lru算法淘汰数据 保存全量数据 内存不够 就使用SSD存储数据 比如 ssdb rocksdb leveldb</div>2019-10-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ee/d2/7024431c.jpg" width="30px"><span>探索无止境</span> 👍（0） 💬（0）<div>老师理论都已经清楚了，能否提供一个可落地的具体实现，比如L1缓存具体要怎么做？</div>2019-10-05</li><br/>
</ul>