你好，我是袁武林。

在开始之前，我们先回顾一下前面几篇的内容。我们陆续讲到了消息实时性、消息投递的可靠性、消息时序一致性在即时系统业务场景中的重要性和难点，以及相应的实现方案。

如果说消息的“实时性”“投递可靠性”“时序一致性”是评价一个即时消息服务可用性和先进性的重要指标；那么另一个重要的特性：安全性，就是一个IM服务能否存在的底线和立命之本。

对于依托即时消息技术之上的各种私密聊天App、轨迹位置服务、远程工控系统等业务，对于安全性的需要远高于一般业务。

毕竟，没有人能接受私密的聊天内容被第三方窥探，实时位置的暴露甚至可能带来人身方面的安全风险，而涉及了重要的远程工控操作，如果操作被截获或者篡改，可能会导致严重的工程事故。

那么今天，我们就来聊一聊IM系统中会有哪些常见的安全问题，针对这些不同安全问题，我们分别采用了哪些技术方案来进行应对。限于篇幅，对于每个技术点的具体实现过程，我们不做深入讨论，你只需要了解到具体方案的适用场景就可以了。

## 消息安全性的三个维度

既然对于即时消息服务来说，安全性是如此的重要和不可妥协，那么到底都有哪些环节可能导致消息安全方面的问题呢？

一般来说，从消息的产生和流转的细分上，我们大概从三个维度来描述消息的安全性：消息传输安全性、消息存储安全性、消息内容安全性。
<div><strong>精选留言（27）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/14/34/df/64e3d533.jpg" width="30px"><span>leslie</span> 👍（17） 💬（2）<div>     消息安全性问题我记得大规模爆发的经典案例应当是当年的QQ尾巴吧？QQ使用近20年，手机端这块可能因为工作相关特性基本不太接触，不过我个人认为其实其一定程度上还是和PC类类似吧。毕竟手机就是一台Mimi的computer.对于老师说的我还是整体谈一下个人的见解吧；
    其实近15年爆发的安全问题无非出自几方面：
     一类是：客户端；主要表现形式1）弱密码 如简单设置数字就OK，结果被人破解了 2）非安全网络环境下上网 如蹭网、网吧上网时中毒 3）链接非安全，QQ尾巴就是经典案例，此三种是最普遍的；
     一类是服务器端： 1）连接数不限：其实这是个问题；造成QPS过高且不能确定是否是本人登录；故而像QQ或者某些在线教育的基本上都有严格的限制 2）网络安全：这个应当算是个老问题，举个例子吧：例如很多人家里东西被偷无非还是自己没有把门锁好、或者用了个最普通的门或者锁；不然为何为了安全现在会用防盗门 3）系统安全：各种补丁和问题爆发时你不注意不去强化，造成出问题。4）实时监控：网络异常、数据包异常时其实就说明有问题了 这就像现在商店商城都用监控一样。
      一个是应用程序：最经典的案例就是SQL注入，其实追其本源无非就是几个因素吧；1）省事完成了再说，没想到结果就被人利用了，其实老师所说的加密我印象里数据库端国内真正开始做是那次事件爆发之后再有的 2）数据传输时的安全性：举个个人觉得比较好的方式吧，消息中间件kafka这块我认为做的就还算不错，3）敏感过滤：其实不只是敏感词、甚至敏感链接吧。
       其实这些年尤其是2000后网络开始普及后：各种问题层出不穷，这也是为何监管越来越严格；DNS之类的其实真正挖下去肯定是有问题的，我们只能尽力避免一些常规问题，做好防患未然；这就像谷歌的 SRE有句很经典的话“没有问题是有问题的特殊形态”。网络这块深聊下去老师的课程就改成网络安全了 。
     谢谢老师的辛勤付出：期待老师的下节课的分享。</div>2019-09-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/6a/58/f2c6d65b.jpg" width="30px"><span>王棕生</span> 👍（14） 💬（1）<div>TLS 能识别客户端模拟器仿冒用户真实访问的问题吗？如果不能有什么其他更好的办法？
答：  TLS 是传输层的加密协议，是用来保证消息传输过程中不被截获、篡改和伪造的，但是无法识别仿冒的真实用户。
         客户端模拟器如果像真实用户一样来访问服务端，其实是没有必要去识别的，因为此时模拟器一般是为了帮助真实用户做一些事情，没有恶意行为；如果存在恶意行为，进行识别的办法是通过机器学习的方式进行识别，例如：客户端模拟器会频繁发送消息，针对这一特征，可以对线上访问流量进行甄别。


</div>2019-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/3d/02/ecdb4e66.jpg" width="30px"><span>东东🎈</span> 👍（8） 💬（3）<div>老师，问个im问题，服务端采用读扩散，比如A用户在群里面撤回了一条消息，B用户离线上线怎么收到这条已经撤回的消息，还有个问题群消息是异步mq入库成功后再推送吗，也就是推送的代码要放到mq里面，插入数据库成功后再推送吗？谢谢</div>2019-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e2/34/0c2c1200.jpg" width="30px"><span>L</span> 👍（4） 💬（1）<div>你好，对于账号密码存储那块有个问题，如果每个账号密码拥有一个单独的盐（随机的？）那如何验证登录呢？</div>2019-11-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/59/78/4f384f93.jpg" width="30px"><span>龙</span> 👍（3） 💬（1）<div>老师，对消息内容（主要考虑文本），进行加解密的话，综合考虑性能，一般用什么技术来加解密比较好呢？</div>2019-10-31</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/6LaITPQ4Lk5fZn8ib1tfsPW8vI9icTuSwAddiajVfibPDiaDvMU2br6ZT7K0LWCKibSQuicT7sIEVmY4K7ibXY0T7UQEiag/132" width="30px"><span>尔东橙</span> 👍（2） 💬（1）<div>请问如果走localDns，应用层还走http协议么？一般IM消息系统会用到http协议么</div>2020-02-16</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/6LaITPQ4Lk5fZn8ib1tfsPW8vI9icTuSwAddiajVfibPDiaDvMU2br6ZT7K0LWCKibSQuicT7sIEVmY4K7ibXY0T7UQEiag/132" width="30px"><span>尔东橙</span> 👍（1） 💬（1）<div>同时只允许一个账户在一台机器上在线是否可以解决问题</div>2020-02-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/48/bd/6c7d4230.jpg" width="30px"><span>Tony Du</span> 👍（1） 💬（1）<div>老师，请问“消息内容不在服务端存储”，对离线消息存在哪里？</div>2020-02-12</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132" width="30px"><span>null</span> 👍（1） 💬（1）<div>老师，如果需要在服务端存储消息内容，是加密后存储，下推离线消息时，解密之后再推送给用户？
不知道微博消息内容，是使用对称还是非对称加密？</div>2019-10-03</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJlvHOFaCicVAZGiaLibNKe4aIjkHc3fk6ibGjgcLtcAUzDibbNepUO2qUoeINANKotsfiaD6PMibCUCI5lA/132" width="30px"><span>Geek_62a1d1</span> 👍（1） 💬（1）<div>老师，问个问题，您上面说的保证传输链路安全（中断、截获、篡改、伪造）是如何去发现这些问题呢？</div>2019-09-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7a/fe/abb7bfe3.jpg" width="30px"><span>胡波 allenhu</span> 👍（1） 💬（1）<div>老师你好，请问端到端的加密方式，总不可能每一条消息的发送和接收都采用公私钥做加解密吧？是不是也要通过密钥交换算法来协商一个对称密钥？如果这样，因为连接不是直接建立在用户A和用户B之间，他们是如何做密钥交换的？</div>2019-09-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/97/18/a5218104.jpg" width="30px"><span>🐾</span> 👍（1） 💬（1）<div>老师节日快乐</div>2019-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/01/8e/48e7c474.jpg" width="30px"><span>一路向北</span> 👍（1） 💬（8）<div>我有个疑问，关于HttpDNS。原理我懂，在进行DNS解析时，直接向自建服务器或第三方服务器去请求。但是进行域名解析的过程，是浏览器的行为，不是开发者的行为，我们怎么去控制DNS解析向自己的服务器发请求呢？</div>2019-09-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ce/c0/81a96344.jpg" width="30px"><span>墨子</span> 👍（0） 💬（2）<div>大佬，问一个问题，wns与dns区别</div>2019-11-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/9b/a8/6a391c66.jpg" width="30px"><span>geraltlaush</span> 👍（0） 💬（1）<div>老师，问一个客户端认证的问题，服务器怎么鉴定跟自己通讯的是授权的app，而不是其他非法app </div>2019-09-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e1/08/3dc76043.jpg" width="30px"><span>钢</span> 👍（0） 💬（2）<div>tls是保证传输安全，源头有问题，tls无法识别，解决：服务器对客户端进行筛选，短时间对服务器做大量请求，可做限制处理或要求重新登录</div>2019-09-09</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/3XbCueYYVWTiclv8T5tFpwiblOxLphvSZxL4ujMdqVMibZnOiaFK2C5nKRGv407iaAsrI0CDICYVQJtiaITzkjfjbvrQ/132" width="30px"><span>有铭</span> 👍（0） 💬（1）<div>模拟器不是TLS能识别出来的，本质上模拟器就是外挂，还是脱机挂，要想识别外挂，基本都是靠在客户端内置一些隐藏的检测机制，由服务器激发，因为外挂一般都是“够用就好”，不会在内部实现这些机制，所以对这些被激活的机制没有回应的，就可以判断为模拟器了</div>2019-09-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/30/61/50e24e09.jpg" width="30px"><span>煜</span> 👍（0） 💬（1）<div>老师，请教一个额外的问题。nio所说的的异步非阻塞是体现在接收请求和处理请求，还是体现在对请求的读写？或者是是指底层调用了epoll？</div>2019-09-09</li><br/><li><img src="" width="30px"><span>墙角儿的花</span> 👍（0） 💬（1）<div>不让用端到端加密，支持浏览器的话最合适的是json+wss了吧。
老师，上篇文章我又留了个问题，辛苦老师再看下帮忙答疑
多谢</div>2019-09-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/49/a9/d6ec336d.jpg" width="30px"><span>Geek_d18bea</span> 👍（1） 💬（1）<div>老师我是新手，请教一下如果采用了端到端加密，那么服务器如何处理敏感词的过滤呢？还是说要在发送前进行过滤。</div>2023-03-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/7b/bd/ccb37425.jpg" width="30px"><span>进化菌</span> 👍（0） 💬（0）<div>安全无小事！
通过这篇内容，了解到 dns 的劫持起因和手段，以及 httpdns 这样的方式。
端到端加密，是针对服务器级别的。但是如果内容存储在本地，读取的时候岂不是还是涉及到了解密的过程吗？</div>2023-06-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a3/e2/5cb4f43f.jpg" width="30px"><span>laolinshi</span> 👍（0） 💬（0）<div>老师，文中提到的httpDNS服务是自己实现的，还是使用的第三方服务的？</div>2022-03-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/13/71/3762b089.jpg" width="30px"><span>stevensafin</span> 👍（0） 💬（0）<div>httpdns这个图是不是有点问题呢？httpdns的服务器还会向权威DNS请求吗</div>2020-08-13</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/fBOybgVTWXYXxaicaVEysXCjkKT13dX7icAj96KibJ815mia1FvYro9KcbA3xtwnIxmPJ38Vt6rmg6vp0auGKel93A/132" width="30px"><span>Geek_d26e63</span> 👍（0） 💬（0）<div>md5现在已经不适用了吧：https:&#47;&#47;wenjie.store&#47;archives&#47;salted-password-hashing-doing-it-right</div>2020-06-14</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoro1y5n7l1Gq1vpzCRP9RJyNn5MuUz23PjYgSRbZ0aW0acUPufet09Pd5PFknB6ibtjXVZ3cQibevQ/132" width="30px"><span>怪物老爷</span> 👍（0） 💬（0）<div>讲的真好！</div>2019-11-02</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKRn8Mcfib1laX6wddDlKRaSH8BjJESVNt1RD6iay3icbcyCcZib214Q93A8vZI9zarcuBianLUe06bwoQ/132" width="30px"><span>wuhaka</span> 👍（0） 💬（0）<div>不仅TLS，任何加密措施都不能解决模拟器伪造请求，这个是个无解的问题，本质上客户端安全攻防的问题，解决办法的实质是windows，android，ios等常用平台客户端如何防止反编译破解，常用字符串常量级加密、汇编花指令、反调试、动态加载吐出二进制文件等手段，道高一尺魔高一丈的问题；服务端机器学习识别为辅，核心是客户端反破解问题</div>2019-10-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/2b/6f/c99d739d.jpg" width="30px"><span>刘小兔bunny</span> 👍（0） 💬（0）<div>本节DNS块的LocalDNS问题和信息安全问题学习起来有些吃力</div>2019-09-09</li><br/>
</ul>