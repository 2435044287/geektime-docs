你好，我是袁武林。

在前面的章节里，我讲到了在即时消息场景中非常重要的两个特性：“可靠投递”和“实时性”。

为了让消息能更加实时、可靠、快速地触达到接收方，大部分IM系统会通过“长连接”的方式来建立收发双方的通信通道，这些基于TCP长连接的通信协议，在用户上线连接时，会在服务端维护好连接到服务器的用户设备和具体TCP连接的映射关系，通过这种方式服务端也能通过这个映射关系随时找到对应在线的用户的客户端，而且这个长连接一旦建立，就一直存在，除非网络被中断。

因为“长连接”方式相比“短连接轮询”，不仅能节约不必要的资源开销，最重要的是能够通过“服务端推送”，提供更加实时的消息下发。

同样，对于发送方来说，如果发送消息也能通过“长连接”通道把消息给到IM服务端，相对于短连接方式，也能省略TCP握手和TLS握手的几个RTT的时间开销，在用户体验和实时性上也会更好。

## 为什么需要心跳机制

“长连接”方式给我们带来了众多好处，那么要让消息通过“长连接”实现可靠投递，最重要的环节就在于如何维护好这个“长连接”。

由于这个“长连接”底层使用的TCP连接并不是一个真正存在的物理连接，实际上只是一个无感知的虚拟连接，中间链路的断开连接的两端不会感知到，因此维护好这个“长连接”一个关键的问题在于能够让这个“长连接”能够在中间链路出现问题时，让连接的两端能快速得到通知，然后通过“重连”来重新建立新的可用连接，从而让我们这个“长连接”一直保持“高可用”状态。
<div><strong>精选留言（29）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/14/6a/58/f2c6d65b.jpg" width="30px"><span>王棕生</span> 👍（47） 💬（2）<div>解答问题：如果从实现功能角度看，传输层和应用层的心跳机制没有结合的必要，因为传输层的心跳探测连接可用性，应用层的心跳机制也可以完成探测; 但从debug角度看，应用层的心跳探测机制无法定位是网络的问题还是系统的问题，此时由传输层辅助就非常好，但实现会相对复杂！</div>2019-09-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/11/a3/7a2405ca.jpg" width="30px"><span>rfyiamcool</span> 👍（11） 💬（2）<div>能简单说下 二分法来进行心跳探测 的逻辑么？ </div>2019-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/b8/78/2828195b.jpg" width="30px"><span>隰有荷</span> 👍（9） 💬（1）<div>看了老师的讲解，在理论上是明白了，但是具体实践上该如何操作？比如：tcp的keepalive该如何通过具体的代码语言去实现。这些具体操作性的知识，不知道本课程后面是否有涉及到？</div>2019-09-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d2/1f/2ef2514b.jpg" width="30px"><span>newzai</span> 👍（5） 💬（1）<div>智能心跳，采用什么算法逼近或者选择心跳周期？如何感知当前的心跳周期是否太小？因为一旦太大就会导致连接断开</div>2019-09-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（4） 💬（1）<div>我看上图 心跳处理流程，只有客户端当判断连接无效的时候才会进行 连接重连，重连的这个动作服务端不会进行吗？ 如果这样的话服务端还要发送心跳消息进行心跳检测做什么呢？服务端是不是可以这样处理，当一段时间没有收到客户端的心跳包的时候就判断与该客户端的心跳连接断开了，直接释放对应的资源不就可以了吗？</div>2019-09-14</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/UqxY58hlwdaypDeLwsjSBfBe2Q7YhZyJniaPEf7Ws7tneSzgQ6js6Uh0KT5FjCBIRUCGyVZ0zsvBUPVz2bK2YWQ/132" width="30px"><span>dongdong</span> 👍（3） 💬（1）<div>请问老师，我这里使用应用层发心跳包，很奇怪在内网测试环境，网页一直不操作都不会断线，但在外网同套代码，不操作1，2个小时后，网页的长链接就会断线，WS脚本重连也连不上，但只要重新刷新页面就可以连上了，这是什么原因？</div>2019-09-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6b/1b/4b397b80.jpg" width="30px"><span>蛮野</span> 👍（3） 💬（1）<div>服务端在进行推送时候，假设判断用户连接有效，即用户在线，此时推送是同时推与客户端应用保持的长连接和apns等多条通道吗？然后在客户端去重？还是每次只会选择一条通道？</div>2019-09-13</li><br/><li><img src="" width="30px"><span>Geek_e7834d</span> 👍（2） 💬（1）<div>看流程图，服务器检查心跳并不是定时的， 而只是推送的时候检测？</div>2019-10-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f0/ec/5e147cbf.jpg" width="30px"><span>花指令</span> 👍（2） 💬（5）<div>老师好，我用go的tcpsocket，有一端异常退出时，另一端会触发掉线通知。所以我不明白的是，socket是不是不需要心跳？还是是因为我是在局域网测试，和公网情况不一样？</div>2019-09-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6b/f8/b4da7936.jpg" width="30px"><span>大魔王汪汪</span> 👍（2） 💬（1）<div>老师 客户端或服务端心跳实现是在客户端维持一个轮训服务吗？这样会不会有浪费客户端资源的问题，有没有什么好方法解决轮训定时器这种资源浪费问题</div>2019-09-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/10/2f/cdd0b5d1.jpg" width="30px"><span>Geek_a2849d</span> 👍（1） 💬（1）<div>老师您好，希望您能帮我解答下，公司开发的移动端IM，服务端设置心跳超时时间120秒，客户端30秒发送心跳包，但是安卓端还是会频繁掉线，有的时候停留在app聊天页面也会断线，请问下这个是什么原因呢？</div>2020-03-05</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKRn8Mcfib1laX6wddDlKRaSH8BjJESVNt1RD6iay3icbcyCcZib214Q93A8vZI9zarcuBianLUe06bwoQ/132" width="30px"><span>wuhaka</span> 👍（1） 💬（1）<div>老师您好，您这节只讲了tcp的心跳机制，我觉得可以采用类似QUIC协议，自定义connection id判断逻辑连接状态，无需通过通信五元组来判断是否为同一连接，这样可以避免各种NAT设备，或nginx代理等出现的映射失效问题，在复杂网络环境中不用在频繁断线重连节省开销</div>2019-10-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/5a/33/9a66d0b8.jpg" width="30px"><span>Csquare</span> 👍（1） 💬（1）<div>如果用了长连接，怎么支持显示用户在线状态的功能了，保活机制会让用户一直在线吧？</div>2019-10-24</li><br/><li><img src="" width="30px"><span>Geek_e986e3</span> 👍（1） 💬（1）<div>智能心跳的算法是咋样的</div>2019-09-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d8/71/d6f79534.jpg" width="30px"><span>一个工匠</span> 👍（0） 💬（1）<div>防火墙也是心跳设计中需要考虑的一个重要因素。</div>2020-02-26</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/6LaITPQ4Lk5fZn8ib1tfsPW8vI9icTuSwAddiajVfibPDiaDvMU2br6ZT7K0LWCKibSQuicT7sIEVmY4K7ibXY0T7UQEiag/132" width="30px"><span>尔东橙</span> 👍（0） 💬（1）<div>中间链路出问题会导致服务端客户端链接假死，那老师中间链路出问题一般是什么情况，比如断网是吧</div>2020-02-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/34/df/64e3d533.jpg" width="30px"><span>leslie</span> 👍（0） 💬（1）<div>         我觉得可以：毕竟不是完全基于同一层；TCP Keepalive是基于传输层，应用层心跳是基于应用层的，关键在于如何合理组合使用，中间如何去处理。
       昨天某个完课的课程老师告诉我一定要注意知识的关联性：这门课程看了一遍其实是反向再来看的-觉得自己当时没注意一些知识，根据七层网络协议各层分别相互交付而言我认为是可以的；其实关键问题就在于TCP Keepalive的部分事情如何和应用层心跳合理结合-这才是问题处理的难点。
      这个就像早期我们做软件直接CS或BS架构：现在数据系统层往往会多一个No sql DB，用的合理是能解决很多问题-关键难点就在如何合理使用；这是我的个人理解。任何架构做不好完美，不过使用合理可以增强效果&#47;正确率。
</div>2019-09-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/00/bf/a44cde46.jpg" width="30px"><span>lorancechen</span> 👍（0） 💬（1）<div>文章中指出的心跳监测的时间间隔是发送</div>2019-09-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e1/08/3dc76043.jpg" width="30px"><span>钢</span> 👍（0） 💬（1）<div>老师，有没有应用层心跳包的设计规范及要求的文章推荐的</div>2019-09-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e1/08/3dc76043.jpg" width="30px"><span>钢</span> 👍（25） 💬（0）<div>tcp keepalive解决网络可用性，应用层keepalive解决网络和服务可用性，应用层无法区别网络还是服务问题，加上tcp心跳包可以进一步区分，有助于客户端做动态调整</div>2019-09-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8f/0b/a438de52.jpg" width="30px"><span>0xTang</span> 👍（1） 💬（0）<div>心跳一般只需端到服，这样端检测超时可以发起重连。</div>2020-03-28</li><br/><li><img src="" width="30px"><span>Geek_bdb618</span> 👍（0） 💬（0）<div>清晰</div>2023-10-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/7b/bd/ccb37425.jpg" width="30px"><span>进化菌</span> 👍（0） 💬（0）<div>比较简单的心跳检测，就是指定时间比如 10 秒发一次http请求检测服务是否正常响应。这，应该是应用层的心跳检测实践。
TCP Keepalive 主要是检测链接的存活，但是没办法判断应用层的状态。所以，TCP Keepalive 和应用层心跳一起使用的话，目的是不是降低应用层心跳的频率呢？</div>2023-06-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/2b/fe/7925eb7e.jpg" width="30px"><span>pdf</span> 👍（0） 💬（0）<div>老师，各位同学
如果服务端检测心跳超时之前，链接处于假死状态，服务端认为该链接可用，发送push消息，此时写tcp buffer是会成功还是失败呢？</div>2022-02-15</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIS21HKSj9TdawwbySGgzdGiaBwWBub80ibxhYesZXlKkr5zIQU3Cfiab5ZsunETb9s973X1dTX3EvHg/132" width="30px"><span>极客—月</span> 👍（0） 💬（0）<div>老师，有个疑问望解答下，大量用户在心跳检测下线后，服务端应该采用怎样的方式清理用户好呢？(我们使用LRU清理，但是Go中List是非线程安全的，所以只能单线程清理，大量用户下线时，往往清理不过来)</div>2021-07-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/04/d4/7173785e.jpg" width="30px"><span>倔强小德普</span> 👍（0） 💬（0）<div>客户端是发送心跳包检测 长链状态的。服务端一般通过什么机制，来识别长链是否健康。根据最后一次消息的时间吗 </div>2020-05-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/2e/8c/75936ae2.jpg" width="30px"><span>lin yu</span> 👍（0） 💬（1）<div>看着是很明白了，但是写不出来，应用层心跳怎么通过具体代码实现</div>2020-04-17</li><br/><li><img src="" width="30px"><span>tm1234</span> 👍（0） 💬（0）<div>请问老师 如果IM需要显示用户在线&#47;idle&#47;路线 状态，在keep alive的情况下，服务端是怎么发现用户离线了呢？用户在线是可以通过用户上线时注册发现，但是由于一直keep alive，是不是就没法检测到用户实际已经下线了呢？</div>2020-04-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cd/aa/33d48789.jpg" width="30px"><span>卫江</span> 👍（0） 💬（0）<div>问题：心跳机制是不是可以结合tcp的keepalive和应用层的心跳协议？当然可以，不过只使用应用层的心跳协议就可以了，因为一旦应用层的心跳出现问题意味着连接出问题或服务处理不过来，不论什么问题，它更能反应应用真实的整体情况，比如负载均衡与后端服务器之间的应用心跳就能更客观的反应应用情况而便于进一步处理，比如摘除这个后端服务器并报警，而如果只是使用tcp的keepalive的反应的问题就比较片面，只是针对于网络的，而不能反应应用整体的情况，而如果应用整体出问题，连接没有问题也没有什么意义。不过从实现角度来说，tcp的keepalive和使用tcp的应用心跳一起使用并不会增加应用处理网络事件的复杂度，因为基于tcp，我们都是通过read和write来获取连接状态的，所以一起开启也无所谓。</div>2019-09-13</li><br/>
</ul>