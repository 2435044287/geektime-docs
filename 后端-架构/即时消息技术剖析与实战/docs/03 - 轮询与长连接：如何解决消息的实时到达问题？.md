你好，我是袁武林。

我在前面第一篇文章中，从使用场景的需求方面，讲到了IM系统的几个比较重要的特性。其中之一就是“消息到达的实时性”。

实时性场景是所有的IM系统绕不开的话题，为了支持互联网的“实时互联”的概念，大部分的App都需要实时技术的支持。

我们现在使用的聊天类App、直播互动类App都已经在实时性方面做得很好了，消息收发延迟基本都能控制在毫秒级别。

当然这一方面得益于快速发展的移动网络，让网络延迟越来越低、网络带宽越来越高；另一个重要原因是：社交网络App在实时性提升方面的技术，也在不断升级迭代。

实时性主要解决的问题是：当一条消息发出后，我们的系统如何确保这条消息最快被接收人感知并获取到，并且尽量让耗费的资源较少。这里关键的几个点是：最快触达，且耗费资源少。

想好了吗？下面我们来看一看，IM在追求“消息实时性”的架构上，所经历过的几个代表性阶段。

## 短轮询场景

在PC Web的早期时代，对于数据的获取，大部分应用采用一问一答的“请求响应”式模式，实际上，像现在我们浏览大部分门户网站的新闻，以及刷微博其实都是采用的“请求响应”模式。

但这种依赖“手动”触发的模式，在即时消息系统中当有新消息产生时并不能很好地感知并获取到，所以明显不适用于对实时性要求高的场景。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/14/6a/58/f2c6d65b.jpg" width="30px"><span>王棕生</span> 👍（88） 💬（11）<div>TCP 长连接的方式是怎么实现“当有消息需要发送给某个用户时，能够准确找到这个用户对应的网络连接”？
答： 首先用户有一个登陆的过程： (1)tcp客户端与服务端通过三次握手建立tcp连接；(2)基于该连接客户端发送登陆请求；(3)服务端对登陆请求进行解析和判断，如果合法，就将当前用户的uid和标识当前tcp连接的socket描述符(也就是fd)建立映射关系； (4)这个映射关系一般是保存在本地缓存或分布式缓存中。
         然后，当服务端收到要发送给这个用户的消息时，先从缓存中根据uid查找fd，如果找到，就基于fd将消息推送出去。</div>2019-09-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/11/8a/65a7a63d.jpg" width="30px"><span>菜菜菜菜菜鸟</span> 👍（34） 💬（8）<div>TCP不是可靠的吗，为什么还需要在应用层实现ack，不应该是消息发出对方就一定可以收到的吗</div>2019-09-02</li><br/><li><img src="" width="30px"><span>技术带头</span> 👍（26） 💬（1）<div>老师你好，我们也落地了一套im，服务端和本地都有存储，和用websoket。现在存在一个问题。群聊离线推送是将离线后产生的所有消息再用户上线的时候推送，还是客户端分页拉取</div>2019-09-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/55/a9/5282a560.jpg" width="30px"><span>yic</span> 👍（21） 💬（2）<div>客户端发送心跳包，一般多久一次比较合适？ 我看老师有回复国内不超过5分钟，微信用的是4分半。这个时间有什么依据吗？</div>2019-09-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/2e/94/68ebd69f.jpg" width="30px"><span>魏巍</span> 👍（18） 💬（2）<div>服务器端如果突然进程被kill掉，客户端如何及时得到通知并下线？</div>2019-09-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4e/1b/f4b786b9.jpg" width="30px"><span>飞翔</span> 👍（18） 💬（13）<div>服务器维护一个hashmap   key是 userid，value 是socket instance， 这样 用户A 发给用户B的信息里边含有用户B 的id， 用usedBid 到hashmap 里边查到 用户B的socket 就可以用socket 发送信息给用户B了，老师我还有一个问题 就是如果一台机器连接数有限， 如果需要多台机器，如果用户A的socker 和用户B的socket 不在一台机器上，这样怎么解决呀</div>2019-09-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ee/d2/7024431c.jpg" width="30px"><span>探索无止境</span> 👍（15） 💬（1）<div>老师你好，为什么说一台服务器可以最多可以支持1000万的连接请求，这个数值是怎么推算出来的？</div>2019-10-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/2e/94/68ebd69f.jpg" width="30px"><span>魏巍</span> 👍（10） 💬（1）<div>一个linux服务器可以接受多少tcp连接，如何量化这个数字？当业务层对持久化层操作响应慢时，为何客户端会频繁掉线？聊天数据的持久化与下发操作查库对数据库的读写压力如何缓解？实时聊天的数据库如果宕机，能否做自动切换数据库服务器的操作？</div>2019-09-03</li><br/><li><img src="" width="30px"><span>zombo</span> 👍（9） 💬（1）<div>老师请教一个区分，长连接是不是 &quot;header: keep-alive&quot; 的连接? 英文对应 persistent HTTP connection，但大家用得不多。而 webSocket 是HTML5才出来的，类似的机制，但各种浏览器支持得比较多。
因为机制和实现上，我好像看不出它们有太大的区别? 还是说 persistent HTTP 仍然是3次握手，websocket是一次?</div>2020-03-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/43/e1/b7be5560.jpg" width="30px"><span>sam</span> 👍（9） 💬（2）<div>轮询就是前段定时请求，这个比较了解。但长轮询第一次听说，实际开发也没用过，特别是服务器的“悬挂（hang）”怎么理解？ 是HTTP协议的机制吗？</div>2019-09-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/2e/94/68ebd69f.jpg" width="30px"><span>魏巍</span> 👍（8） 💬（3）<div>客户端发送心跳包，一般多久一次比较合适？</div>2019-09-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/34/eb/d00aedb0.jpg" width="30px"><span>lecy_L</span> 👍（6） 💬（2）<div>老师你好，请问如果维护一个全局在线状态的情况下，精确定位通知的方案怎么做呢？</div>2019-10-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/13/35/45391914.jpg" width="30px"><span>冷笑的花猫</span> 👍（6） 💬（1）<div>请问老师，假设mqtt有两个缺点，不支持离线和群组功能，但可以修改源码增加这两类功能，而且mqtt已基本成熟，在mqtt之上开发不更方便和快捷吗？为啥要在tcp基础上自己开发呢？如果仅仅因为这些选择了了基于tcp自己开发，感觉说服力没那么强啊。
所以请老师能详细说下这些的优缺点吗？晚上搜索到的感觉不太靠谱，谢谢。</div>2019-09-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5c/8f/551b5624.jpg" width="30px"><span>小可</span> 👍（6） 💬（2）<div>用户使用客户端与服务器建立连接时携带了userid与clientid，连接建立成功后，服务器端记录用户、客户端及连接之间的关系。一个可以用户使用多个客户端建立连接，一般是不同类型的客户端(网页、APP），后续有消息可根据此关系进行多端推送。</div>2019-09-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/11/0e/23d6a88f.jpg" width="30px"><span>Shuai</span> 👍（5） 💬（1）<div>请问，XMPP是基于 XML 格式的协议，那像微信这种成熟的IM软件的私有通信协议是基于什么格式的呢？二进制吗？</div>2019-09-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/14/dd/17892edc.jpg" width="30px"><span>Geek_发现</span> 👍（5） 💬（3）<div>说一下我的猜想吧:不管是websocket全双工还是tcp有状态链接，都是应用了ack机制，用户访问服务器，ack会保存用户的信息，服务器收到ack后会开辟一块专有内存来保存所有的客户的ack信息；同理，服务器发送信息至客户，客户端也会保存服务器的ack信息。
总的来说，客户端和服务器应该都是采用异步方式来提升效率和客户体验，并且降低服务器连接压力</div>2019-09-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/04/51/da465a93.jpg" width="30px"><span>超威丶</span> 👍（5） 💬（4）<div>请问websocket为什么能实现实时通信</div>2019-09-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/74/c3/5c3d7a4d.jpg" width="30px"><span>来自清真寺的圣诞树</span> 👍（4） 💬（1）<div>如果是websocket可以使用stomp协议解决？</div>2019-10-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/38/69/864569a4.jpg" width="30px"><span>devil</span> 👍（4） 💬（1）<div>海量用户场景如QQ，微信，除了加机器以外，还有些什么方式可以处理海量的tcp连接吗？</div>2019-09-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f3/a0/a693e561.jpg" width="30px"><span>魔曦</span> 👍（4） 💬（3）<div>有新的消息是全部推送给客户端吗？那么瞬间服务器压力飙高？如何解决？每个服务器能维护多少长链接？如果数量有限那么微博抖音需要多大的集群支撑？</div>2019-09-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/b0/ba/4bbc709a.jpg" width="30px"><span>潇洒哥</span> 👍（3） 💬（1）<div>这种客户端发送心跳需要服务端响应吗?毕竟连接数较多</div>2019-11-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/4b/14/1494bb21.jpg" width="30px"><span>张磊</span> 👍（3） 💬（1）<div>如果同时需要支持移动APP和Web端，选用websocket协议是否可以？</div>2019-09-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/dc/b6/01e0a253.jpg" width="30px"><span>飘洋过海的鱼</span> 👍（3） 💬（1）<div>抛开使用通讯协议本身，现在面临的一个挑战是Android程序保活。现在国内Android手机的系统都是各大厂商自己定制修改的。为了保证使用电量，杀程序，杀后台服务情况严重，包括一些第三方的推送也会被杀死。这样消息的及时推送就是一个很大的问题。请问有什么好的应对策略么？</div>2019-09-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/b2/60/ae8240aa.jpg" width="30px"><span></span> 👍（3） 💬（1）<div>请问老师。断网后，我们可以在浏览器断网后，触发offline之前，在做一些什么行动去链接么</div>2019-09-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6b/1b/4b397b80.jpg" width="30px"><span>蛮野</span> 👍（3） 💬（1）<div>多终端场景下，用户维度上的应该是一个socket列表。网关接入层是否是有状态的？在进行推送时候需要定位到某台机器？多终端要定位多台机器？</div>2019-09-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/1d/64/52a5863b.jpg" width="30px"><span>大土豆</span> 👍（2） 💬（1）<div>一直有一个疑问，为什么web端不能像客户端一样，用tcp呢</div>2019-11-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/80/98/5591d99d.jpg" width="30px"><span>唯我天棋</span> 👍（2） 💬（1）<div>TCP 长连接的方式是怎么实现“当有消息需要发送给某个用户时，能够准确找到这个用户对应的网络连接”？

会在连接服务器维护一个用户id到连接id映射关系。
在分布式场景下，需要维护用户id到 连接服务唯一标识 + connid</div>2019-11-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a3/fc/379387a4.jpg" width="30px"><span>ly</span> 👍（2） 💬（1）<div>在IM领域，我一直非常好奇微信、微博这些社交类软件的表设计，例如朋友关系、明星发微博等。不知道这些数据表如何设计的。</div>2019-10-28</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKe2HwTYcQ0hwoicaa9rlwIicoaI4BD1cS424x2icPfbUIbox2TrbpMC6MYuQ1Miaf1xHNxqatLD9DBrQ/132" width="30px"><span>Gavin</span> 👍（2） 💬（1）<div>有个疑问：为什么不选用UDP呢？

1. 用户基于UDP登录注册到服务侧以后，服务侧也可以根据用户IP+Port找到用户。
2. 即使基于TCP，也需要有应用层可靠性机制，来保证可靠投递；那基于UDP也可以通过应用层保证可靠性。
3. TCP还容易拥塞，产生较大时延。
</div>2019-09-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ba/d3/dd25a96f.jpg" width="30px"><span>瞬间</span> 👍（2） 💬（1）<div>有两个问题想请教一下
1.及时率的统计方案是什么样的呢？业界各个的及时率大概是什么样的标准？
2.从移动客户端的角度如果想优化及时率的话，有什么切入点可以分享么？
多谢！</div>2019-09-03</li><br/>
</ul>