你好，我是袁武林。

前面几节课，我们较为系统地介绍了如何解决消息实时到达的问题，也对保证消息可靠投递实战中常用的方式进行了一一讲解。

那么，今天的课程我们继续一起聊一聊，IM系统设计中另一个比较复杂，但又非常重要的话题：消息收发的一致性。需要提醒的是，我们这里的讲到的一致性，一般来说是指消息的时序一致性。

## 为什么消息的时序一致性很重要？

对于聊天、直播互动等业务来说，消息的时序代表的是发送方的意见表述和接收方的语义逻辑理解，如果时序一致性不能保证，可能就会造成聊天语义不连贯、容易出现曲解和误会。

你可以想象一下，一个人说话颠三倒四，前言不搭后语的样子，就理解我们为什么要尤其注重消息的时序一致性了。

对于点对点的聊天场景，时序一致性需要保证接收方的接收顺序和发送方的发出顺序一致；而对于群组聊天，时序一致性保证的是群里所有接收人看到的消息展现顺序都一样。

## 为什么保证消息的时序一致性很困难？

从理论上来说，保持消息的时序一致性貌似并不难。理论上，我们想象的消息收发场景中，只有单一的发送方、单一的接收方。

如果发送方和接收方的消息收发都是单线程操作，并且和IM服务端都只有唯一的一个TCP连接，来进行消息传输，IM服务端也只有一个线程来处理消息接收和消息推送。这种场景下，消息的时序一致性是比较容易能得到保障的。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/bd/c0/57b06721.jpg" width="30px"><span>深藏Blue</span> 👍（44） 💬（5）<div>最近遇到IM相关需求，好像是第一个收下这个专栏的极客er。请教栏主：能否指导下具体的技术选型？跪急！服务端主要由spring cloud系列开发，终端应用有  win  pc、安卓以及ios</div>2019-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/1c/cd/8d552516.jpg" width="30px"><span>Gojustforfun</span> 👍（37） 💬（8）<div>希望老师多补充一些流程图或代码来帮助理解，光看文字因经验不足，有时很难想象理解，甚至会引发歧义。谢谢</div>2019-09-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/6a/58/f2c6d65b.jpg" width="30px"><span>王棕生</span> 👍（24） 💬（1）<div>问题： 在即时消息收发场景中，用于保证消息接收时序的序号生成器为什么可以不是全局递增的？
答： 这是由业务场景决定的，这个群的消息和另一个群的消息在逻辑上是完全隔离的，只要保证消息的序号在群这样的一个局部范围内是递增的即可； 当然如果可以做到全局递增最好，但是会浪费很多的资源，却没有带来更多的收益。

</div>2019-09-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/1d/d1/f427b83e.jpg" width="30px"><span>javaworker</span> 👍（14） 💬（1）<div>老师，请教几个问题
1.您文中说消息通过网关后，IM后台都是并发处理，所以先发的消息有可能后到达。
我想问如果同时发给一个人的消息，也要IM后台并发处理吗？如果这样路由如何控制？比如其中一条消息丢了，我需要查问题，我如何能知道这条消息是路由到哪台机器哪个线程处理的？

2.您文中说IM时序基准以IM服务器的时间为准也不行，因为是集群部署。我公司现有IM系统，就是按照IM服务器的时间做的时序基准，比如A和B两个用户都给C发送消息，系统会按照C的userid按照一定路由规则，最终路由到一台消息服务器（比如叫msgserver.1），我们会拿msgserver.1的本地时间作为时序基准，客户端接收到消息后显示就按照msgserver.1的这个时间顺序显示。
我个人理解公司的IM系统从宏观上看多人的消息是并发处理的，但是针对到某个人其实是单线程处理的，这样好处就是系统设计简单一些，不会遇到您文中说的某台机器GC导致某条消息慢，自然也不会有服务端客户端整流的问题，因为单线程中某条消息慢，后面的消息也别想发出去，呵呵。
我想问公司这个处理消息的逻辑会有什么问题吗？还想问一下如果针对个人消息也并发处理，一般这个服务端整流的时间设置成多长合适？如果服务端整流收到9条消息，但是还有1条消息由于GC慢了点，整流服务器怎么知道少收了一条消息？从而在这个整流的时间周期中选择不发送？这种情况下IM系统处理消息的服务器又是怎么处理（它怎么知道整流失败，它又怎么知道要重新发送哪些消息）？</div>2019-09-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/1d/d1/f427b83e.jpg" width="30px"><span>javaworker</span> 👍（9） 💬（2）<div>老师，关于服务员消息整流和消息接收端整流
还有些不明白？
1.文中说的服务员消息整流是不是只能在网关整流吗？

2.在网关启动后订阅一个本IP的Topic，文中一直在说对离线消息整流，请问如果是在线消息需要服务端整流吗？

3.文中说每个消息包生成一个 packageID，意思是可以多条消息用一个包发送吗？packageID就是这个包的ID？您能简述下用户A给用户B发送一条消息，和用户A给用户B发送多条消息时，服务端和接收端都是怎么整流的吗？我理解当发送一条消息时，服务端当接收到一条消息后，会有个超时时间，比如2秒，2秒内没收到新消息的话，就把当前的消息发送出去，这时这个消息包中只有一条消息。当发送多条消息时，2秒内有新消息，就一直自增seqID，直到2秒内没收到消息，然后一起把这个消息包发出去，这时消息包可能有比如7条消息，每一条都按照seqID自增。  
当发送给接收端，接收端在按照每个消息包中seqID顺序显示消息。
按照我上面的理解，每个消息包之间的顺序怎么保证？是每个消息包packageID也有顺序吗？感觉如果按照我的理解在线发送多条消息会有延时啊，因为服务端一直在整流啊，整完在发送一个大包出去</div>2019-09-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cd/aa/33d48789.jpg" width="30px"><span>卫江</span> 👍（8） 💬（2）<div>问题：为什么不需要全局自增id？原因：因为没有全局排序的需求。而且全局自增id肯定有单点和性能问题。我们目前的需求有两点：单聊和群聊。单聊我们可以通过针对于会话id的自增id解决，群聊通过基于群id的自增id解决，这样就拥有了不错的扩展性，避免单点和性能问题，当然了如果群很大也许也有问题，同时这种方式也可以控制某个id生成服务出问题影响的范围。</div>2019-09-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/49/85/3f161d95.jpg" width="30px"><span>Alpha</span> 👍（5） 💬（2）<div>生产者为每个消息包生成一个 packageID。
——请问这里的消息包是什么概念，是指多个消息的集合吗？如果是的话，什么场景下会将多个消息作为一个包一起发送呢？
或者指的是包含 一条消息 + 一条指令 的集合吗？</div>2019-09-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/63/95/43f5cc54.jpg" width="30px"><span>一个爱编程的胖子</span> 👍（3） 💬（1）<div>可不可以适当添加一些代码示例。单纯的文字描述比较干</div>2019-09-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/37/f9/f4428000.jpg" width="30px"><span>北北、Pepper</span> 👍（3） 💬（1）<div>对老师提的问题，提出一下自己的想法。
因为实时通信里是会存在多个会话的，如果用于保证消息接收时序的序号生成器是全局递增的，即用于保证所有会话的接收时序，那么会存在可用性和性能瓶颈问题。
其次，正如老师提到的，从业务层面考虑，对用户来说，只要保证单个会话里消息的时序是正确的即可，因为不同的会话相关性一般不强，不需要保证严格的时序同步，所以针对不同的会话，单独维护一个时钟序号生成器即可。</div>2019-09-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/47/d2/024e8f0a.jpg" width="30px"><span>忘</span> 👍（2） 💬（1）<div>袁老师，在课程的最后是不是有实战的项目？我对这个IM几乎是一点不会，能听懂大概的意思，具体的代码我一点没有接触过，听着和看着您和同学们讨论，我很希望我以后也可以能有提问能力，我现在是想提问不知道问什😂 😂 😂 ，希望可以在您这里能入门！😁 😁 😁 </div>2019-09-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6f/3c/abb7bfe3.jpg" width="30px"><span>Cap</span> 👍（2） 💬（3）<div>对本文中提到的几个技术点有点其他不同的意见：
1. 关于一致性：文中提到时序一致性，是指的『顺序一致性 Sequential Consistency』？实际上消息场景中数据的一致性可以为更低要求的『因果一致性 Causal Consistency』。
2. 文中给的方案是以『时序基准』ID为主，『顺序ID』为辅来修正小范围的乱序。而消息场景中，应该是有三个不同的ID用于两个不同场景的消息处理：
    a. 消息ID：唯一性保证，主要用于去重。
    b. 同步顺序ID：本文还没提到消息的同步，对于读扩散或写扩散的消息同步，每次新消息拉取都是从最近一条消息的同步顺序ID往后拉取新消息；对于这个ID要求是在收件箱内自增的，任何依赖服务端时间戳来生成ID的规则都是错的。这个ID可以简单理解为队列中的位点。
    c. 会话顺序ID：这个是本文提到的顺序ID，这个ID不是辅助『时序基准』用的，而是用于保证会话中消息的『因果一致性』，为了让客户端能够对乱序接收的消息进行重排。</div>2019-09-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/62/dc/8876c73b.jpg" width="30px"><span>moooofly</span> 👍（2） 💬（1）<div>老师能够提供一个示意图，在途中标明 packageID，seqID 和 xxxID 等都用在什么位置，感觉看过文章和留言问答后，都搞不清楚哪些 ID 用哪里了，多谢~</div>2019-09-09</li><br/><li><img src="" width="30px"><span>墙角儿的花</span> 👍（2） 💬（1）<div>多谢老师，受益良多。希望和老师多交流。
老师讲的防止业务执行错乱的整流方案，是通过package打包，类似逻辑集装箱，将包内消息有序处理，原理上很清晰，但落地实现比较困难，不太好掌握package的边界。究竟从哪个时机到哪个时机范围的消息归为一个包呢？也希望老师赐教个方法。

针对需要在业务上整流的问题，提出了三个自己可落地的方案，希望得到老师的指点，不知道究竟哪个可行。

方案一、客户端单线程单tcp连接保证消息有序到达，服务端采用GO协程对连接一对一服务，保证单客户端发来的消息被服务端有序执行，这个不采用java的线程池技术就是为了防止线程和socket建多对多交替并行处理导致无序问题，但是GO协程这样一对一服务的方式不知道并发能力如何，需要指点。这个我会试验下。

方案二、

对于IM，业务执行顺序应该着重关注成员变动（删除好友或取消关注也是一个聊天窗口的成员变动）操作之间的顺序，以及成员变动操作和聊天消息之间的有序处理，前者影响成员变动结果，后者影响聊天消息接收范围，其他的业务错误倒不是&#39;&#39;致命&#39;&#39;的，产品定位弱一些可以不关注。

因此，将消息分为聊天消息和信令消息

信令消息是包括群里加人、离群、删除好友，这种影响聊天消息接收范围的命令，产生信令消息的操作必须在线同步操作，直到服务端明确返回执行结果信息。但也真的可能出现服务端执行了，但客户端恰巧断线，这应该通过网络重连获取最新状态，以保证客户端的信息和服务端同步。

发信令消息时，消息体附带客户端当前需要服务端给ACK应答的聊天消息id列表，服务端处理信令消息时必须处理完所有前置聊天消息列表里的消息，否者算处理失败。

这样保证信令消息一定会在合适的顺序得到服务端的处理。

方案三 严格的链表式消息链

在发送消息时都要附带其上次向服务端发送的消息id，服务端必须按着链表顺序整流并按序处理，但是，网络上会随时丢消息，一个消息丢失导致后置消息全链无法处理，毕竟不是金融软件没必要这么做，体验不好。


</div>2019-09-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4e/1b/f4b786b9.jpg" width="30px"><span>飞翔</span> 👍（1） 💬（1）<div>老师 不仅每个群要有一个全局序号生成器 每个点对点的聊天 比如a和b聊天也需要一个生成器 也就是每对聊天对象都有一个属于他俩的全局生成器</div>2019-09-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/20/1e/23e6109f.jpg" width="30px"><span>小袁</span> 👍（1） 💬（1）<div>1.一般业界是做是每个消息都ack还是像tcp一样的批量ack？每个都ack会不会消息太多影响性能？
2.客户端整流，如果我希望客户端严格按照顺序处理消息，那就必须排序且保证排序后的消息连续，那雪花id是不连续的，我怎么判断整流后的消息是否连续呢？难道这种情况下就必须用自增id？</div>2019-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8d/6c/0c2a26c7.jpg" width="30px"><span>clip</span> 👍（1） 💬（1）<div>如果我们应用场景就是 IM，消息接收端整流是不是可能导致收到消息之后也能又往上面插入了新消息？感觉这种体验可能不是很好。
是不是要采取另外的措施？
能想到的有：必须保证消息顺序下发，如果中间有比较耗时的消息可能先用一个占位符代替。自己发送的消息要等服务端确认后才真正进入消息流排序。</div>2019-09-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8d/6c/0c2a26c7.jpg" width="30px"><span>clip</span> 👍（1） 💬（2）<div>服务端包内整流那块儿有点不理解。
这个 pkg 指的是类似举例的“最后一条消息和取关操作”那种打包在一起的事件吗？还是群纬度的那种一个群的算一个 pkg？</div>2019-09-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/36/4c/46c43cce.jpg" width="30px"><span>小祺</span> 👍（1） 💬（1）<div>感觉消息接收端整流是必做的，那服务端的整流是不是就显得多余了？</div>2019-09-06</li><br/><li><img src="" width="30px"><span>墙角儿的花</span> 👍（1） 💬（3）<div>对于&quot;分手&quot;、&quot;取关&quot;的严格业务顺序场景，通过单线程单tcp连接能保证消息一定按着发送顺序到达服务器吗？socket.send有序发送两条消息A 和 B，由于链路故障是否可能导致服务器先接收到B后接收到A，我一直保持着业务层消息即使同一tcp连接上有序发送也有可能出现乱序到达，所以需要接收端在业务层重排的认知，但好像也确实没有证明。</div>2019-09-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/89/46/ff27e90f.jpg" width="30px"><span>Geek_gthxw2</span> 👍（0） 💬（1）<div>这样序号生成都是从服务端产生，那么每次发送消息时都需要先从服务端获取到序号，这个操作是不是会影响性能。</div>2020-03-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/0c/60/7f3b9f97.jpg" width="30px"><span>atom</span> 👍（0） 💬（1）<div>对于客户端发送失败的消息，是没有服务端的序号的，如何和接受到的消息进行排序</div>2019-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/37/73/df7adf32.jpg" width="30px"><span>Kippa</span> 👍（0） 💬（1）<div>老师您好，请教一个有关消息 ID 的问题。如果采用秒间有序的分布式消息 ID 生成器，一个会话中同一秒的消息可能是乱序的。那么如果同一秒内 A 和 B 对话产生了三条消息，A 向 B 发送消息 1，B 回复 A 消息 2，A 看完 2 后回复消息 3, 可能会出现消息 3 的 id 在消息 2 前面，请问应当如何避免这种情况呢？</div>2019-11-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/c8/8f/e13a6552.jpg" width="30px"><span>polk</span> 👍（0） 💬（1）<div>离线消息通过包内整流，对于在线的消息，整流会增加耗时，就不需要做整流了吧？</div>2019-11-19</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKRn8Mcfib1laX6wddDlKRaSH8BjJESVNt1RD6iay3icbcyCcZib214Q93A8vZI9zarcuBianLUe06bwoQ/132" width="30px"><span>wuhaka</span> 👍（0） 💬（3）<div>老师您好，我也正在做im业务针对您这节讲的时序性问题问两个问题：
1.既然在网关层做了整流，传输协议又基于tcp的话，客户端为什么会出现乱序？
2.假如您所说客户端出现乱序，那把后到达的消息插入到前面展示，在UI界面中间突然崩出一条消息，用户也可能无感知的，这在产品层面是很不好的设计，市面上主流IM没发现出现过这种场景。
</div>2019-10-30</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKsBRgibKxD2M0ibmgPqfcoaZOxmUrwCCGlex8xehyYeeTOEN2ibtQ5S6t30LoOKFvMR5KDm5gnU99PQ/132" width="30px"><span>Michael</span> 👍（0） 💬（1）<div>举手提问：消息表主键msgId是这个序号生成器生成的Id么？如果是，序号生成器生成的ID虽然可以不是全局递增的，是不是至少要保证全局唯一呢？</div>2019-09-26</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKsBRgibKxD2M0ibmgPqfcoaZOxmUrwCCGlex8xehyYeeTOEN2ibtQ5S6t30LoOKFvMR5KDm5gnU99PQ/132" width="30px"><span>Michael</span> 👍（0） 💬（2）<div>举手发问：发送方先后分别发送msg1和msg2，但是因为网络和服务器端处理效率不同，msg1后到达并且后处理。造成了msg1的全局唯一序号比msg2的全局唯一序号大。如果接收端按照全局唯一序号排序的话，那么msg2会排在msg1前面，导致了发送端消息顺序跟接受端顺序不一致。请问一下老师怎么解决呢？</div>2019-09-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/0d/00/ed8ce979.jpg" width="30px"><span>Bolor</span> 👍（0） 💬（3）<div>有两个问题咨询，希望老师给个答复
1、a用户发b用户消息，a到im服务器时由于多个服务接收，发送的消息被不同的服务接收，导致第一条在第二条消息或第三条消息后面，获得的序号错误，这种问题怎么避免呢？
2、离线消息能否在用户登录后用户主动拉取离线消息，有多少拉多少或分批拉取，并且所拿到的消息是有时序的，这样是不是避免了做服务端和接受端的整流呢？
谢谢！</div>2019-09-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/67/dd/55aa6e07.jpg" width="30px"><span>罗帮奎</span> 👍（0） 💬（1）<div>后续会有IM相关代码么，如果有代码结合前面的课程内容，会有更深刻的理解</div>2019-09-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/5d/6b/3d42593f.jpg" width="30px"><span>聪少</span> 👍（0） 💬（1）<div>移动端推送一条消息是否需要带着这个ID，如果要带的话这个ID从哪里申请？ 远端申请也是有时间损耗的，本地申请时间可能被修改，期待大佬回复</div>2019-09-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/45/38/0f948866.jpg" width="30px"><span>鹿小6</span> 👍（0） 💬（1）<div>packageID和seqID老师用的是离线推送为例，那如果没有离线呢？是不是这个包ID就没有必要了，只需要seqID，消费者根据seqID整流排序即可？</div>2019-09-11</li><br/>
</ul>