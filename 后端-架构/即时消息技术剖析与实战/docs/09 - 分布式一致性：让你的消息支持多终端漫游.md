你好，我是袁武林。今天我们开始进入场景篇的部分，在这个部分中，我会介绍在几种典型的垂直业务场景下，IM系统具体是如何实现的。

在即时消息的场景里，消息的多终端漫游是一个相对比较高级的功能，所谓的**“多终端漫游”是指：用户在任意一个设备登录后，都能获取到历史的聊天记录。**

这个功能对于有多个手机的用户来说是一个非常有用的功能，试想一下用户在交叉使用多个手机进行聊天后，如果不能在多个终端间自动同步所有的聊天记录，使用体验也不会太好。

但并不是所有的即时消息App都支持这个特性，比如微信虽然支持多端登录，但不知道出于什么考虑并不能在多端同步历史消息，这可能也是微信为数不多被诟病的一个小问题吧。

而Telegram和QQ却很好地支持了“多终端漫游”，使得用户在任意端登录都能获取到所有最近收发的消息。

## 如何实现多终端消息漫游

那接下来我们看一下，怎么才能让收发的消息能在多个终端漫游。要支持消息多终端漫游一般来说需要两个前置条件：一种是通过设备维度的在线状态来实现，一种是通过离线消息存储来实现。

### 设备维度的在线状态

对于在多个终端同时登录并在线的用户，可以让IM服务端在收到消息后推给接收方的多台设备，也推给发送方的其他登录设备。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/14/6a/58/f2c6d65b.jpg" width="30px"><span>王棕生</span> 👍（18） 💬（2）<div>如果用户的离线消息比较多，有没有办法来减少用户上线时离线消息的数据传输量？
答： 用户所有的离线消息对用户来说，并不都是关心和感兴趣的，用户可能只是看了与某个最近联系人的最近的几条消息后，之前的都不想看了，所以这个时候如果将之前的离线消息都拉到本地是非常浪费资源的。通常的做法是：
1  将用户的所有离线消息，按联系人进行分开；
2  用户登录后进入与联系人的聊天窗口时，首先加载与该联系人的最近的10条离线消息；
3  当用户用手滑动手机屏幕的时候，再分页拉取10条。</div>2019-09-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/6a/58/f2c6d65b.jpg" width="30px"><span>王棕生</span> 👍（14） 💬（2）<div>老师，对消息的终端漫游，我这边还有一个云消息的实现方案，望点评！
1  所有的消息，全部持久化存储；
2  用户在任意一个终端设备登陆后，通过用户的uid、联系人uid去服务端拉取云消息；
3  拉取云消息的时候，是按每条消息的时间戳倒序拉取，首次拉取可以取当前时间戳。</div>2019-09-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（7） 💬（1）<div>离线消息什么情况下进行存储呢？当用户A给用户B发送一条消息，发现没有用户B的连接信息，这个时候才进行离线消息的存储吗，还是只要有消息发送给B都会进行离线消息的存储，因为这些消息对于用户B的其他设备来说属于离线消息？</div>2019-09-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/60/71/895ee6cf.jpg" width="30px"><span>分清云淡</span> 👍（3） 💬（1）<div>最后的发送方设备同步的问题，没太明白。怎么确定发送设备呢？服务端还有一份设备消息的关系表么？</div>2019-12-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/1d/d1/f427b83e.jpg" width="30px"><span>javaworker</span> 👍（3） 💬（2）<div>有几个问题没想明白，望老师帮解答下，谢谢
1.文中说如果离线消息存储容量超过限制，部分增量消息被淘汰掉了，会导致根据客户端最新版本号获取增量消息失败。
这个问题有些不明白，如果部分增量消息被淘汰，个人觉得也没关系吧，服务端每次把比客户端版本号大的消息都发给客户端就行了啊，怎么会失败呐？

2.文中说的离线消息表中该怎么存？比如A用户和B用户各有两个终端，但都只登陆了一个终端，这时A用户给B发送了一条消息，是按照A的userid存一条消息，按照B的userid也存一条一样的消息，A端上线拉取A的离线，B端上线拉取B的离线，也就是说A的离线消息有自己发出去的，也有别人发给A的消息，统一按照版本号存下来，A上线后都一起会拉走？</div>2019-09-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8f/d5/bab4332a.jpg" width="30px"><span>K.Zhou</span> 👍（3） 💬（4）<div>微信不能多端同步消息是因为消息没存在服务端吧？</div>2019-09-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/40/03/525a1e78.jpg" width="30px"><span>yangzi</span> 👍（0） 💬（1）<div>老师好，看了您的课程，有个问题：多终端消息同步和离线消息机制该如何搭配使用？这两个的功能类似。感觉离线消息更靠谱一些，因为它有ack，而多终端同步一旦客户端收到的消息不全，比如发送1、2、3，接收端收到1、3，拿3同步消息，同步也就会遗漏消息。</div>2020-03-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5c/0a/1bd98d4b.jpg" width="30px"><span>vearne</span> 👍（0） 💬（1）<div>延迟加载也是一个办法吧</div>2019-11-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/55/e6/87197b10.jpg" width="30px"><span>GeekAmI</span> 👍（0） 💬（1）<div>多端漫游，感觉是为了解决一个问题，而引入很多问题的解决方案。
让不用手动端到端同步聊天记录，岂不是更好吗[Facepalm][Facepalm][Facepalm]</div>2019-11-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/55/e6/87197b10.jpg" width="30px"><span>GeekAmI</span> 👍（0） 💬（5）<div>&quot;但并不是所有的即时消息 App 都支持这个特性，比如微信虽然支持多端登录，但不知道出于什么考虑并不能在多端同步历史消息，这可能也是微信为数不多被诟病的一个小问题吧。&quot;
1. 如果2台设备(mac和手机)都登录的情况下，消息会同步的；
2. 支持从一台设备上把历史聊天消息无损的同步到另一台设备。
我认为微信的方案即不复杂，也完美的解决了问题，很好啊
希望老师解答下，微信的这种方案缺陷是？不太明白</div>2019-11-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/3d/02/ecdb4e66.jpg" width="30px"><span>东东🎈</span> 👍（0） 💬（2）<div>老师，关于服务端消息打包压缩，用的是啥方法呢，比如从api拉取离线消息20条，这个怎么进行打包压缩返回给客户端，客户端怎么处理？</div>2019-09-20</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/sqVKmfHJyWKeCCWfOIoeKWvrX9DLIKc910YntKoGXbmgr20CP2ZTFC1S9dR2XYPZxiaP2uANBTm84a9BvU42Zzg/132" width="30px"><span>Geek_rango</span> 👍（0） 💬（1）<div>老师，用户上线时，离线消息的推送是一次性的，还是分批次下发到客户端的？如果是分批次推送的话，该用户在接收离线消息的过程中收到了其他用户发来的新消息，是否需要更新当前最新版本号，或者还是等到离线消息都推送完了，再判断是否需要更新。</div>2019-09-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6b/f8/b4da7936.jpg" width="30px"><span>大魔王汪汪</span> 👍（0） 💬（1）<div>老师我们im采用账号纬度的消息存储，对于离线消息同步采用设备纬度推拉结合方式，当设备上线时，客户端会收到服务端推送的一条消息，里面携带了最新的消息版本号，之后客户端采用拉的方式入参为这个版本号获取版本号之前的消息，实现增量同步，消息保留一周，历史消息只能通过主动查询了，请问下我们这种实现方式还有什么需要完善考量的吗。🙏</div>2019-09-19</li><br/><li><img src="" width="30px"><span>墙角儿的花</span> 👍（0） 💬（1）<div>老师 离线库是包含了一个人所有的消息吧 包括自己发的聊天消息 应收的聊天消息 和 应收的信令消息 上线时从这个库拉取就好 好像这时就不用利用收发箱的数据了啊</div>2019-09-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/10/2f/cdd0b5d1.jpg" width="30px"><span>Geek_a2849d</span> 👍（0） 💬（1）<div>老师你好，我们在拉取离线消息的时候并没有单独的版本号服务去维护版本号，而是直接通过递增的消息id去替代这个版本号 然后比对消息id去获取离线消息 这样设计是否合理呢？</div>2019-09-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/4c/f1/8dc266ee.jpg" width="30px"><span>儿戏</span> 👍（0） 💬（1）<div>老师，我想问下客户端与服务端的通信用哪种方式比较好,http轮询还是websocket,还是有别的更好的方式？</div>2019-09-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/97/18/a5218104.jpg" width="30px"><span>🐾</span> 👍（0） 💬（3）<div>袁老师好，这里有个疑问，不明白为什么需要离线消息表？即时通讯系统里会有哪些操作信令是无法在索引表中标记的？像常见的删除和撤回两个信令，其实都是可以通过索引表来实现：

1、如果用户A只是删除了与某一联系人B的某一条聊天消息，程序的流程是，先在本地客户端删除该消息，再把该消息的删除状态发送回服务端，服务端收到后，在消息索引表找到这条消息，并标记该消息为删除状态，同时修改该消息对应的版本号，然后返回给客户端这个新版本号，客户端同步修改被删除消息的版本号。
后来用户A在另一设备登陆，打开与联系人B的会话界面，会触发拉取消息记录的操作（目的是同步消息），因为此时用户A与联系人B的消息版本号在新登陆设备要比服务端的小（被删除的消息的版本号是最后更新的），所以拉取的消息记录包含了被删除的消息，客户端检测到该消息被删除，同步消息状态和版本号至本地客户端，然后聊天界面控制不显示被删除的消息。

2、对于撤回消息信令，其流程跟删除消息信令差不多，只是除了要标记该消息的撤回状态和修改版本号外，还需要同步修改该消息的接收方对应的消息索引表记录，修改撤回状态和版本号。消息发送方和接收方拉取消息记录是和删除信令的判断一样。</div>2019-09-17</li><br/><li><img src="" width="30px"><span>墙角儿的花</span> 👍（0） 💬（1）<div>老师 我们做im时没有专门设置一个离线数据库 是直接根据客户端的时间戳从收发索引表里查的 当然 这会漏掉您说的信令消息 但是 并没有觉得漏掉信令消息是问题 因为 信令消息一般都是改群成员和个人信息 我们在登录时做一次整体同步就好了。其他的信令消息也就只有删除消息这个场景，如果要做的好的话确实需要做离线消息，但是这个对一些产品定位低点的好像不太重要。另外，我们以前做过一个版本，是把聊天消息和信令消息都作为普通消息记到消息索引表里，这样不需要离线消息库了。</div>2019-09-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e1/08/3dc76043.jpg" width="30px"><span>钢</span> 👍（0） 💬（1）<div>老师，我有个想法，如果是多个终端在同一局域网，是不是只要同步一个终端，别外终端就在这个已经同步的终端设备进行数据的获取。这样流量就大大节省，当然，这种实现在业务不值得推荐哈😄</div>2019-09-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/01/8e/48e7c474.jpg" width="30px"><span>一路向北</span> 👍（0） 💬（3）<div>多终端漫游可不可以这样呢？
在前面提到，为了保证消息的时序，采用全局自增序列，我建议把这个序列号存入服务端和客户端的消息表中。当用户上线时，将本设备最新的序列号发送给服务端，服务端将这个序列号与自己表中的数据比较，大于这个序列号的所有消息都是此设备需要接收的消息，这样也不需要单独维护离线消息</div>2019-09-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/1b/03/1199ed5a.jpg" width="30px"><span>寒窗剪月</span> 👍（0） 💬（1）<div>解决用户的离线消息比过多上线时消息推送数据量太大的问题，我们可以采用离线消息分页功能，默认只返回一定数目的未读消息。客户端同时做好消息的缝隙记录。用户滑动到消息缝隙的位置的时候再拉取相应位置的内容。</div>2019-09-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/34/df/64e3d533.jpg" width="30px"><span>leslie</span> 👍（0） 💬（1）<div>      阐述一下我学完后的个人观点吧：大家探讨交流一下-毕竟这块其实没有唯一的答案，老师记得分享老师自己觉得合适的方案就好^_^
      这就像查购物订单一样：FIFO其实蛮合适的，我们最关心的都是最新的数据；点击历史的时候再做传输，内存中只保留最新的部分，点击历史再传输历史数据，这应当是目前最主流的方式且使用最多的方式吧：只显示最新的几条，翻阅的时候再显示历史-减少一次性的数据传输率。
       其实不同客户端一次性传输的量是不同的：我们很少会在移动端做大量的历史查询，这个度的把握其实是需要在实际场景摸索的；屏幕不一样，一次性看到的量不一样，使用的数据系统不同策略可能同样有所不同，这个学生的一点薄见。</div>2019-09-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c4/c9/90c8a53e.jpg" width="30px"><span>missa</span> 👍（4） 💬（0）<div>离线消息的表怎么设计还是不太明白，它和消息的索引表有什么不同？</div>2020-03-31</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/edMMg8wmu2RRIFVw2UgAytIx7Yjmx3z2sX1Apc3DfX423dIpyKO6Kg2y65bjPF2jRZVt16AbfYS74A6BAWDJGQ/132" width="30px"><span>Geek_LeonSZ</span> 👍（3） 💬（1）<div>可以稍微讲一下离线消息是怎么存储的么? 上面讲到&quot;没必要按会话来存，只需要按 UID 来存储即可&quot;。 这个地方可以展开讲讲么? 因为的确是经常会运用到. 可以像第2节课一样, 用一张表来解释下么?</div>2021-11-05</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erZCyXaP2gbxwFHxvtnyaaF2Pyy5KkSMsk9kh7SJl8icp1CD6wicb6VJibiblGibbpDo6IuHrdST6AnWQg/132" width="30px"><span>Geek_1cc6d1</span> 👍（2） 💬（1）<div>离线消息和拉取历史消息有什么区别？</div>2021-04-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/81/4e/d71092f4.jpg" width="30px"><span>夏目</span> 👍（2） 💬（0）<div>上线时只推送最近的n条消息，等到用户主动刷新是主动拉取</div>2020-05-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/1e/4c/10174727.jpg" width="30px"><span>xinHAOr</span> 👍（1） 💬（0）<div>老师，离线消息是不是可以只保存信令类消息，非信令类消息通过 用时主动拉取 方式获取？</div>2021-06-07</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Ikib5hH6AA9v1kJWp14ImL8AUcSd75Lorf1lJ0Vpk1bHyrHkjp4IuKa0BWM9pmwSP4Py5qOibCVGaNY5J7iaLt5mQ/132" width="30px"><span>璟琛</span> 👍（1） 💬（0）<div>我看评论里面有很多提到推拉结合，按需拉取离线消息的做法，但是当离线设备重新上线的时候一般是在会话列表页，这个时候虽然不用把所有的离线消息都同步下来，但是需要展示每个会话的消息数和最后一条消息吧？这个问题通过按需拉取貌似解决不了？</div>2020-09-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/04/d4/7173785e.jpg" width="30px"><span>倔强小德普</span> 👍（1） 💬（0）<div>请教两个问题，多设备的情况下，这个版本号是每个账号下面设备的维度记录的吗？

那个离线表模型大致是怎样的？服务端是如何存储每个同一个账号下面多端设备的版本号信息的</div>2020-05-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg" width="30px"><span>piboye</span> 👍（1） 💬（0）<div>消息还有一个问题比较严重，就是因为并发引起的乱序，导致客户端用大序列号去取消息的时候，低序列号的消息可能还没写入，导致丢消息</div>2020-05-07</li><br/>
</ul>