你好，我是朱晔，贝壳金服的资深架构师。

我先和你说说我这15年的工作经历吧，以加深彼此的了解。前7年，我专注于.NET领域，负责业务项目的同时，也做了很多社区工作。在CSDN做版主期间，我因为回答了大量有关.NET的问题，并把很多问题的答案总结成了博客，获得了3次微软MVP的称号。

后来，我转到了Java领域，也从程序员变为了架构师，更关注开源项目和互联网架构设计。在空中网，我整体负责了百万人在线的大型MMO网游《激战》技术平台的架构设计，期间和团队开发了许多性能和稳定性都不错的Java框架；在饿了么，我负责过日千万订单量的物流平台的开发管理和架构工作，遇到了许多只有高并发下才会出现的问题，积累了大量的架构经验；现在，我在贝壳金服的基础架构团队，负责基础组件、中间件、基础服务开发规划，制定一些流程和规范，带领团队自研Java后端开发框架、微服务治理平台等，在落地Spring Cloud结合Kubernetes容器云平台技术体系的过程中，摸索出了很多适合公司项目的基础组件和最佳实践。

这15年来，我一直没有脱离编码工作，接触过大大小小的项目不下400个，自己亲身经历的、见别人踩过的坑不计其数。我感触很深的一点是，业务代码中真的有太多的坑：有些是看似非常简单的知识点反而容易屡次踩坑，比如Spring声明式事务不生效的问题；而有些坑因为“潜伏期”长，引发的线上事故造成了大量的人力和资金损失。因此，我系统梳理了这些案例和坑点，最终筛选出100个案例，涉及130多个坑点，组成了这个课程。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/15/14/e9/ec2b5a0e.jpg" width="30px"><span>老三</span> 👍（62） 💬（2）<div>分享一个我在菊花厂踩过的最大的坑, Android的. APP总是莫名其妙的报小概率IOException. 进一步分析是文件句柄被关闭了. 好好的为什么会被关闭呢? 原来是有人在别的位置将文件句柄传到JNI层(C语言)并close了, 原Java层也close了一遍.    话句话说, 有一个地方存在将文件句柄close过两次, 正常来讲也问题不大. 但是会存在小概率情况, 第一次关闭文件句柄之后, 系统将文件句柄指向的内存区域快速分配给第二个IO操作位置(同进程的, 但是代码完全不在一个位置), 而第二次关闭文件句柄, 会将重新分配后的close掉. 导致IOException</div>2020-03-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/50/2b/2344cdaa.jpg" width="30px"><span>第一装甲集群司令克莱斯特</span> 👍（26） 💬（4）<div>Executors.线程池工具类的几种创建线程池的方法，都不适合在生产高并发场景下使用，这是坑。</div>2020-03-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/9c/ed/1369d4b6.jpg" width="30px"><span>李磊磊</span> 👍（20） 💬（1）<div>全是干货啊，比起“高大上”的架构，这些点滴问题的深入分析、应对，才真正考验 开发者的基本功</div>2020-03-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/1c/6e/6c5f5734.jpg" width="30px"><span>终结者999号</span> 👍（18） 💬（1）<div>踩过的坑，老是忘记java中引用传递或值传递导致参数根本就没有被修改。。</div>2020-03-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/2c/0b/ad939ef7.jpg" width="30px"><span>钱晟龙🐲龍🐉</span> 👍（14） 💬（2）<div>使用rabbitmq消费消息，正常业务逻辑正常跑着，使用了ack机制。。  prefetch每台instance有一定的数量，测试环境测不出来都被消费了，
然而代码没有ack，线上去查，看到unack 几百条，队列积压几w。。。</div>2020-03-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/6d/ac/6128225f.jpg" width="30px"><span>jjn0703</span> 👍（11） 💬（5）<div>踩过SimpleDateFormat的坑，当时企图用一个static的SimpleDateFormat对象通吃，结果再format之后，出现各种莫名其妙的时间</div>2020-03-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7b/98/8f1aecf4.jpg" width="30px"><span>楼下小黑哥</span> 👍（10） 💬（3）<div>原本想在发生异常的时候再次重试、然后写了一个while（true）。
写好上线确实也没问题，知道有一天，依赖出现问题，重试多少次都不行，这段代码就变成死循环了。就这样把 dubbo 调用者线程池耗尽。
原来老师以前是激战背后支撑者，以前开服抽奖的时候，还中过奖品，哈哈哈。</div>2020-03-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/7b/ea/a64f7822.jpg" width="30px"><span>yc</span> 👍（9） 💬（1）<div>同事踩过的坑：spring里通过配置文件注入了一个bean，配置是缺省，单线程下测试正常，多线程下各种异常，后来发现默认的bean是单例的，多线程调用线程不安全</div>2020-03-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/2c/0b/ad939ef7.jpg" width="30px"><span>钱晟龙🐲龍🐉</span> 👍（8） 💬（1）<div>使用SaaS存储，比如OSS，上传走的内部服务器，流量一起来，自家的流量被占满，全线崩溃，还以为受到了攻击。。</div>2020-03-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/2c/0b/ad939ef7.jpg" width="30px"><span>钱晟龙🐲龍🐉</span> 👍（8） 💬（1）<div>int batchSelectSize = 1000;
List&lt;Payment&gt; payments =
     paymentMapper.findSpecificPayments(0,batchSelectSize);
while (CollectionUtils.isNotEmpty(payments)) {
 List&lt;OrderPayVo&gt; orders = Lists.newArrayList();
 buildData(payments, orders);
 orderPayBiz.syncSaveAuditOrder(orders);
 payments = paymentMapper.findSpecificPayments(
         payments.size(), batchSelectSize);
}
批量处理分页条件有问题，只有被批量处理数据大于batchSelectSize的时候才会触发的坑
无限死循环调用syncSaveAuditOrder，内存疯狂增加。。</div>2020-03-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/fd/58/1af629c7.jpg" width="30px"><span>6点无痛早起学习的和尚</span> 👍（7） 💬（3）<div>最近遇到一个坑，多线程情况下 log 日志部分丢失，用的 log4j2，本来想采用AsyncAppender，但是因为用的是封装的日志格式，AsyncAppender不行，最终也没有找到解决办法，就另辟蹊径把需求问题解决了，但是 log 日志部分丢失还是没有解决，Google 上 log4j2 log miss lose 都找了，没有找到解决办法，Stack Overflow 上说可能是因为 os&#47;jvm 问题，频繁往一个 log 文件写东西</div>2020-03-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/71/05/db554eba.jpg" width="30px"><span>👽</span> 👍（7） 💬（1）<div>坑
第一名：空指针异常。各种场景，各种业务下的空指针异常。
其余不分先后：
Listener无法注入Bean；
异常处理不当；
死循环；</div>2020-03-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/61/11/85386508.jpg" width="30px"><span>じJRisenづジ</span> 👍（5） 💬（1）<div>老师、接口调用需要加密吗？需要话提点思路啊</div>2020-03-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d0/a1/07027529.jpg" width="30px"><span>偏偏喜欢你</span> 👍（4） 💬（3）<div>我们项目每天下午准时卡3到5分钟，很奇怪，一直没有找到原因，估计是垃圾收集造成系统整体停顿</div>2020-03-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/d1/3e/77c6ba5e.jpg" width="30px"><span>梁铁山</span> 👍（3） 💬（1）<div>项目中上了个新功能，在一周时间内服务挂了三四次。检查物理内存和CPU都正常，JVM看起来也没有多大问题，Tomcat看起来也跟好好似的，但就是无法访问。认为是项目本身的问题，但是就是找不到原因！！</div>2020-03-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/27/d5/fa654422.jpg" width="30px"><span>BigSpinach</span> 👍（2） 💬（3）<div>一开始看了专栏作者的名字就在想是否跟我之前学习.net时候看的图书的译者是一个人，后来想了想应该不是，毕竟一个是.net领域，一个是java领域。看了这篇文章，发现真的是一个人。之前跟着老师一起学习过《C#图解教程》和《精通C#》，算是入了C#的门。这次想通过本专栏的学习，跟着老师提升自己的Java能力。建议老师可以介绍介绍跨语言（转语言）这方面的经验</div>2020-03-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ae/31/7d6cd317.jpg" width="30px"><span>Geek_sa5dup</span> 👍（2） 💬（1）<div>我好像还真是服务器不稳定，重启一下就好了......尴尬</div>2020-03-09</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/bvj76PmeUvW8kokyu91IZWuRATKmabibDWbzAj2TajeEic7WvKCJOLaOh6jibEmdQ36EO3sBUZ0HibAiapsrZo64U8w/132" width="30px"><span>梦倚栏杆</span> 👍（2） 💬（1）<div>spring cloud 的refresh，配置无法删除。
具体：配置项list，更新前是三项，删除一项，调用refresh，会发现配置还是三项。最后一项是刷新前的最后一项</div>2020-03-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/20/26/e7/1c2c341d.jpg" width="30px"><span>棒棒糖</span> 👍（1） 💬（1）<div>按照，如下流程，吃透每一篇文章：
1.对于每一个坑点，实际运行调试一下源码，使用文中提到的工具和方法重现问题，眼见为实。
2.对于每一个坑点，再思考下除了文内的解决方案和思路外，是否还有其他修正方式。
3.对于坑点根因中涉及的 JDK 或框架源码分析，可以找到相关类再系统阅读一下源码。
4.实践课后思考题。这些思考题，有的是对文章内容的补充，有的是额外容易踩的坑
我来啦，加油！</div>2022-02-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/7a/9c/a4bc748d.jpg" width="30px"><span>Janenesome</span> 👍（1） 💬（1）<div>一说起业务开发，身边大多数人都会觉得就是CURD，没前途什么的。其实业务开发里面也有很多大学问，这门课感觉会很干，谢谢老师系统性的分享。

遇到过的坑：Integer128判等问题；消息队列消费者的并发问题；价格的float精度问题等等</div>2020-10-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7e/bb/947c329a.jpg" width="30px"><span>程序员小跃</span> 👍（1） 💬（1）<div>职业生涯一直在Android和Java上死磕，也经历过一些坑，但是肯定比不上老师的经历丰富，待着这一次神奇之旅</div>2020-03-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/1c/f9/098bb525.jpg" width="30px"><span>美多丽可</span> 👍（1） 💬（2）<div>学习到了很多，很棒的课程 </div>2020-03-13</li><br/><li><img src="" width="30px"><span>Huodefa_0426</span> 👍（1） 💬（1）<div>老师课程很实用，期待尽快更新。</div>2020-03-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/70/36/197927f5.jpg" width="30px"><span>傲宇</span> 👍（1） 💬（1）<div>踩过String的坑，由于对String的一知半解，认为同样字符的String地址应该是相等的，所以用==判断，然后才知道new的String是一个新的对象，intern返回的字符串才会和字符常量地址相等</div>2020-03-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/a2/c7/0b2ed143.jpg" width="30px"><span>嘲风</span> 👍（0） 💬（1）<div>说一个坑，需要的技术能力值为0，我们总喜欢强调命名规范，哪怕长点也要维护可读性。发布时候才发现app名字取得太长，而部署的集群机器的全名不一致导致有些机器加app名后的name string超长。</div>2022-05-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/9c/c6/05a6798f.jpg" width="30px"><span>苗</span> 👍（0） 💬（1）<div>老师，理解了这个专栏的内容，职位至少是什么级别？</div>2020-08-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4c/de/b56c2906.jpg" width="30px"><span>Geek_ytz16u</span> 👍（0） 💬（1）<div>例子代码启动报错。需要influxDB? 
[23:03:28.750] [influx-metrics-publisher] [ERROR] [io.micrometer.influx.InfluxMeterRegistry:106 ] - unable to create database &#39;mydb&#39;
java.net.SocketTimeoutException: connect timed out
	at java.net.DualStackPlainSocketImpl.waitForConnect(Native Method)
	at java.net.DualStackPlainSocketImpl.socketConnect(Unknown Source)</div>2020-07-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4c/de/b56c2906.jpg" width="30px"><span>Geek_ytz16u</span> 👍（0） 💬（1）<div>代码docker得mysql 数据库没有数据，能否发一下建库脚本？</div>2020-07-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/80/82/3c21b30c.jpg" width="30px"><span>梅子黄时雨</span> 👍（0） 💬（1）<div>都是细节，都是干货啊</div>2020-05-22</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Ff70ZuQbiaP0aUkNPasRkHfyIEyGLsMBd1EYQgQYZRoH85c4SsibWHJgA3u0X4Z8QyxHs17ausF2V4oN9hdYyfRg/132" width="30px"><span>郑卫林</span> 👍（0） 💬（1）<div>老师那个docker是怎么搞的</div>2020-05-13</li><br/>
</ul>