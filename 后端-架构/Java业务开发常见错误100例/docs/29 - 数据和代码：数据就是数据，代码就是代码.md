你好，我是朱晔。今天，我来和你聊聊数据和代码的问题。

正如这一讲标题“数据就是数据，代码就是代码”所说，Web安全方面的很多漏洞，都是源自把数据当成了代码来执行，也就是注入类问题，比如：

- 客户端提供给服务端的查询值，是一个数据，会成为SQL查询的一部分。黑客通过修改这个值注入一些SQL，来达到在服务端运行SQL的目的，相当于把查询条件的数据变为了查询代码。这种攻击方式，叫做SQL注入。
- 对于规则引擎，我们可能会用动态语言做一些计算，和SQL注入一样外部传入的数据只能当做数据使用，如果被黑客利用传入了代码，那么代码可能就会被动态执行。这种攻击方式，叫做代码注入。
- 对于用户注册、留言评论等功能，服务端会从客户端收集一些信息，本来用户名、邮箱这类信息是纯文本信息，但是黑客把信息替换为了JavaScript代码。那么，这些信息在页面呈现时，可能就相当于执行了JavaScript代码。甚至是，服务端可能把这样的代码，当作普通信息保存到了数据库。黑客通过构建JavaScript代码来实现修改页面呈现、盗取信息，甚至蠕虫攻击的方式，叫做XSS（跨站脚本）攻击。

今天，我们就通过案例来看一下这三个问题，并了解下应对方式。
<div><strong>精选留言（11）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/14/67/3a/0dd9ea02.jpg" width="30px"><span>Summer  空城</span> 👍（28） 💬（1）<div>老师，您好，请教一个问题，微服务中一个模块跟多个模块rpc交互的时候，参数比较多的情况下是把其他模块的pojo复制过来，还是提供一个jar存放多个模块交互的pojo，供多个模块引用么？这两种方式感觉都不太好，老师您遇到这种问题是怎样处理的呢，麻烦老师指点下，谢谢老师o(^o^)o</div>2020-05-23</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/cfNtHoAbHvia1O0jIopiafYbnppEPiawgicKa8vdI2FxMMEdqORB4VLzkYTuGJGA7HibustnU0hDTOD7YSDAWuxhmrg/132" width="30px"><span>Geek_299a34</span> 👍（5） 💬（3）<div>老师，对于mybatis，有没有只能使用${}而不能使用#{}的情况？由于#{}会给参数内容自动加上引号，会在有些需要表示字段名、表名的场景下，SQL将无法正常执行。如查询user表信息，根据id或age排序SELECT * FROM USER ORDER BY #{value} desc，value为id时，id会被错误添加引号而无法排序，这种情况可以把#{}换成${}吗？谢谢老师</div>2020-08-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/54/91/0d4647d9.jpg" width="30px"><span>我叫郭小黑</span> 👍（2） 💬（2）<div> new FilePermission(Shell.class.getProtectionDomain().getPermissions().elements().nextElement().getName(),&quot;read&quot;),  这个Shell 引入不进来呢？</div>2020-09-25</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKl06gDibQ7aO1g1jgH9Koy2jcxpLCiavoia14REXotyVUsUvT0wkv9Oqk6wbyjK03SVt8MgFfsibe51g/132" width="30px"><span>13963865700</span> 👍（2） 💬（1）<div>对于xss攻击防范，ESAPI的建议是在前端根据变量所处的位置（html、js）采用不同的编码方式进行转义，前端的开发成本较高；文中提到的方式是在后端采用过滤器统一转义存储，可以一劳永逸。老师在实际生产项目中采用的是哪种方式，转义存储对输入内容进行了修改，会不会产生什么副作用？</div>2020-05-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/9c/c6/05a6798f.jpg" width="30px"><span>苗</span> 👍（5） 💬（0）<div>老师，这些经验你是怎么积累起来的呀？上面的代码可以直接用于生产环境吗？</div>2020-09-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/80/13/df2a0ced.jpg" width="30px"><span>郑思雨</span> 👍（3） 💬（0）<div>找到一篇文章对于联合查询注入，讲的很明白
https:&#47;&#47;blog.csdn.net&#47;weixin_42277564&#47;article&#47;details&#47;80583959

关于FreeMarker  HTML 转义处理可以参考这篇文章：
https:&#47;&#47;www.iteye.com&#47;blog&#47;yshjava-1870320

感谢老师讲解了这么多实用的技巧，学到了很多。</div>2020-12-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/da/ec/779c1a78.jpg" width="30px"><span>往事随风，顺其自然</span> 👍（2） 💬（0）<div>沙箱环境目的是啥，为啥有检查权限？</div>2020-08-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/99/af/d29273e2.jpg" width="30px"><span>饭粒</span> 👍（1） 💬（0）<div>收获颇多👍</div>2021-10-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/4a/45/e048531a.jpg" width="30px"><span>迪米乌格斯</span> 👍（1） 💬（2）<div>老师您好,想请教一下, 目前的架构不都是前后端分离的吗? 后端只和前端进行交互, 前端传来的数据应该是能确认安全的吧?</div>2021-05-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/0a/e2/aa8c2de2.jpg" width="30px"><span>...</span> 👍（0） 💬（0）<div>这里应对xss攻击的解决方案，作者提供的方式为servlet-filter、以及json序列化改写，可以说是更全面更合理。我自己的实现与作者提供的是有差别的，我们自己的解决方案为，get方式的通过nginx配置关键字过滤、post与作者提供的方式是类似的，实际上这种解决方案是拼凑的、割裂的，我们应该参照作者提供的思路，调整下我们自己的方案，集成在一个项目内，可以以插件包的方式提供出去，最好能提供灵活的针对单个属性做xss过滤的配置，如此这就是一个比较好的解决方案，也是对自己能力的锻炼。感谢作者大佬！
</div>2023-01-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/8a/2a/f94db4dc.jpg" width="30px"><span>JoJi</span> 👍（0） 💬（0）<div>老师，如果在上传的图片中植入了html代码，该怎么处理呢？图片流 toString后原本就含&lt;，就没法简单的通过对&lt;转义来处理了。</div>2022-04-12</li><br/>
</ul>