你好，我是朱晔。

今天，我们从安全角度来聊聊用户名、密码、身份证等敏感信息，应该怎么保存和传输。同时，你还可以进一步复习加密算法中的散列、对称加密和非对称加密算法，以及HTTPS等相关知识。

## 应该怎样保存用户密码？

最敏感的数据恐怕就是用户的密码了。黑客一旦窃取了用户密码，或许就可以登录进用户的账号，消耗其资产、发布不良信息等；更可怕的是，有些用户至始至终都是使用一套密码，密码一旦泄露，就可以被黑客用来登录全网。

为了防止密码泄露，最重要的原则是不要保存用户密码。你可能会觉得很好笑，不保存用户密码，之后用户登录的时候怎么验证？其实，我指的是**不保存原始密码，这样即使拖库也不会泄露用户密码。**

我经常会听到大家说，不要明文保存用户密码，应该把密码通过MD5加密后保存。这的确是一个正确的方向，但这个说法并不准确。

首先，MD5其实不是真正的加密算法。所谓加密算法，是可以使用密钥把明文加密为密文，随后还可以使用密钥解密出明文，是双向的。

而MD5是散列、哈希算法或者摘要算法。不管多长的数据，使用MD5运算后得到的都是固定长度的摘要信息或指纹信息，无法再解密为原始数据。所以，MD5是单向的。**最重要的是，仅仅使用MD5对密码进行摘要，并不安全**。
<div><strong>精选留言（19）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/13/33/0b/fd18c8ab.jpg" width="30px"><span>大胖子呀、</span> 👍（39） 💬（4）<div>老师说不能直接对密码进行md5加密，那我心想可以加盐，老师又说盐不要写死，我又想可以用用户名作为盐，接着老师就又说不建议用用户名做盐，应该uuid生成，我就想那保存到数据库不也可以被黑客获取到吗？最后老师又说：有的同学可能又要问了……

可恶啊，这些都在你的计算当中啊！</div>2020-05-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg" width="30px"><span>那时刻</span> 👍（15） 💬（1）<div>1.关于日志脱敏，可以在日志处理模块里通过正则表达式对于敏感词比如username匹配后，做模糊字符输出到日志里。
2.https双向认证指的是服务器额外校验客户端证书，方便控制某个接口是否允许客户端访问，用于第三方服务调用。流程上多了客户端提交自己证书和服务器校验证书等步骤。

小伙伴们讨论的云平台使用的secretid和secrestkey。云平台更推荐使用临时的IAM来替代吧。</div>2020-05-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/71/05/db554eba.jpg" width="30px"><span>👽</span> 👍（6） 💬（4）<div>敏感数据的话，其实还有一个：
就是第三方的一些验证数据。类似于阿里云的Id和key。
我未进行加密保存在配置文件中，并且还将其上传在了GitHub上，按理说，如果Github泄露了，任何人都可以调用我的资源了。因为是透支额度设置的很低，而且余额只有10￥，所以未作安全处理。因为最坏的结果，也就是把我余额全用完。

1，如果需要涉及到加密，我会考虑到分开存储：
可能ID存数据库，Key存本地文件。（鸡蛋分在多个篮子里存放，脱库或者服务器被黑，也只有一部分数据泄露，依然无法使用我的服务）
2，然后加密存放，因为调用服务需要读取，所以必须是可逆的加密算法。增加破译的成本。
3，定期监控，出问题及时发现。</div>2020-05-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/81/e6/6cafed37.jpg" width="30px"><span>旅途</span> 👍（5） 💬（3）<div>老师 密码使用对称加密或非对称加密不行吗 使用自己的算法进行加密 别人也破解不了</div>2020-05-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/a5/f0/8648c464.jpg" width="30px"><span>Joker</span> 👍（3） 💬（1）<div>关于彩虹表的解释在这里：https:&#47;&#47;www.zhihu.com&#47;question&#47;19790488，简单想象成一个黑盒吧，你传进加密后的密码，就能得到解密后的密码。但是构造这黑盒的过程就比较麻烦了。但是如果密文都是根据一个字符串根据特定的规则得到的字符串，哪怕是根据用户信息来构造一个盐，那么就有很大的概率出现，构造了一个彩虹表就把整个数据库的密码给解密了的情况。构造彩虹表的过程虽然麻烦，却是一劳永逸的，那么就要想一个不那么一劳永逸的方法，所以就出现了每次都用一个随机盐的方式。
因为如果是固定的盐的话，那么黑客得到一套数据库之后，只要构造一套彩虹表就能得到结果了。如果每次的盐都不同，那么黑客就要每次都根据密文和盐构造一套彩虹表。
我就是这么理解的，不知道是否正确。密码学真的难。</div>2020-05-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/64/9b/d1ab239e.jpg" width="30px"><span>J.Smile</span> 👍（3） 💬（1）<div>记得一次面试，别人问我https的原理，其实我是理解的，但是记不住这个过程，怎么办？😂</div>2020-05-27</li><br/><li><img src="" width="30px"><span>Geek</span> 👍（2） 💬（2）<div>老师好，保护用户二要素AAD在实际会用在哪些场景中，是否用户忘记了自己设置的AAD就没办法类似于重置密码的方式找回AAD了，也就没办法再解密信息？</div>2020-05-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/71/05/db554eba.jpg" width="30px"><span>👽</span> 👍（2） 💬（3）<div>我的理解，没有绝对的安全。现有的一切加密安全措施，其实只是增加破解的难度罢了。真正的安全，还是需要验证码之类的动态验证。

我一直以来，理解的加密就分两种：可逆的，不可逆的。
可逆的：规定了一种规律，只要应用这种规律就可以逆推其原始值。我认为其实雪花算法就是可逆的加密算法。知道其运算规律，也可以逆推其创建时间。虽然明文中无法体现其创建时间。
不可逆的：自己的密码是12，加密后是3，已知了算法是所有数位之和，但是并无逆推出原始数值是111，003，03，102......等。

但是，无论可逆还是不可逆，破解也是寻找其规律罢了。加密其实本质也是，对结果附加运算过程。
原始密码 x+a-b*c?d = 密文x1，在足够多的数据样本的时候，我觉得还是可以逆推出原始数据。（解方程嘛。。。）

我觉得，现在的密码加密，维持个三五年之后，也会被轻易破解。

其实要是简单粗暴一点，就手机验证码登录，就已经基本OK了，大平台似乎也都是这么做的。类似于某里云。在一些不太重要的数据，就处理的可以适当放开一些。</div>2020-05-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/87/e2/94264525.jpg" width="30px"><span>Bill陈锋</span> 👍（1） 💬（1）<div>秘钥读mi4yue4 听着太难受了</div>2023-09-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/24/2a/33441e2b.jpg" width="30px"><span>汝林外史</span> 👍（1） 💬（1）<div>老师，一般的http访问登录，是不是密码加密需要在客户端做，如果不加密传给服务端的话，那密码不就暴露出来，通过浏览器工具是不是就可以看到form提交的数据？</div>2021-01-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c8/aa/445bae84.jpg" width="30px"><span>kacaric</span> 👍（1） 💬（1）<div>请问老师接口能否采用https双向认证保证接口安全，还需要在接口中额外增加签名字段吗？</div>2020-06-13</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKg7RjNMzSrIwUnjYstbdicVv5MawrQLTHc6rdpwm0Q04b7icj7eAb0F8zSxe8gmM99QBvTECK5KvrQ/132" width="30px"><span>阿冲</span> 👍（1） 💬（3）<div>请问老师脱敏后的数据如何做SQL查询，这个条件怎么处理。比如身份证号和姓名字段？</div>2020-06-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/9c/c6/05a6798f.jpg" width="30px"><span>苗</span> 👍（0） 💬（1）<div>”数据库存一个哈希值，查询的话哈希后查询，需要展示的时候再解密“；老师，hash后查询是不是只能处理精确匹配的场景，而不能做模糊查询，而且有可能hash冲突查出来的结果不是想要的。</div>2020-09-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0f/d7/31d07471.jpg" width="30px"><span>牛年榴莲</span> 👍（0） 💬（2）<div>用户身份证号加密存储了，如果要根据身份证号查询的话，要使用密文，将明文转换至密文需要秘钥，可是在查询到这个用户之前，我也不知道秘钥是啥，这个怎么处理呢？

还有一种场景，一般网站中，用户的手机号是唯一的，如果也加密存储起来的话，怎么在用户注册的时候判断手机号是否已存在呢？</div>2020-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/b5/e4/e6faf686.jpg" width="30px"><span>握了个大蚂蚱</span> 👍（4） 💬（0）<div>规模巨大的隐私数据尤其公司搞国际化的业务，应该都会有一个全局的点来管理隐私数据，业务流转的时候都不需要流转明文，相当于拿个令牌流转，到需要置换，显示时，再去兑换，根据需要兑换不同等级的明文（匿名值，完整明文）。
hash的盐我们是初始化一个map里面放10000个盐，然后把字符串的char转为int再对10000取模得到这个字符串对应的盐。这样好处是盐具有复杂性而又保证hash算法的根本：相同铭文hash后得到相同hash，缺点是用在密码上的话可能会被看出相同密码的数据，需要再加一层处理
</div>2020-06-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/8b/4b/15ab499a.jpg" width="30px"><span>风轻扬</span> 👍（0） 💬（0）<div>第二，生成的盐和哈希后的密码拼在了一起：$是字段分隔符，其中第一个$后的 2a 代表算法版本，第二个$后的 10 是代价因子（默认是 10，代表 2 的 10 次方次哈希），第三个$后的 22 个字符是盐，再后面是摘要。所以说，我们不需要使用单独的数据库字段来保存盐

老师，关于这一段，如果用户不传入盐值，那盐值就只能固定了吧？这样是不是不安全呢？</div>2022-06-07</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLu3MgZBAyyiavX2CMF2KRib791j3bBGiaQDzuQwBF2k6AKHANV2uTAAss2vVaeC7xcSYYD8vjmibRpTQ/132" width="30px"><span>纵不朽</span> 👍（0） 💬（0）<div>注册和登录的时候，直接是原始密码明文如123456传到后台吗？然后后台再用加盐加密存储?</div>2021-11-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/96/72/a517bf25.jpg" width="30px"><span>方舟勇士</span> 👍（0） 💬（0）<div>老师，密文保存到数据库中应该用什么数据类型存储，把密文转成BASE64字符串用varchar类型存储可以吗？BASE64密文通常比明文长很多，密文字段需要建索引吗？</div>2021-03-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/3d/fe/a53a58e7.jpg" width="30px"><span>一个成熟稳重的男人👨</span> 👍（0） 💬（0）<div>你好 和客户端交互，这个身份认证和数据加解密有没有建议</div>2020-10-25</li><br/>
</ul>