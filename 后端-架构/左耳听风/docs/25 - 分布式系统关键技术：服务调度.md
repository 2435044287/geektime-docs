你好，我是陈皓，网名左耳朵耗子。

服务治理，你应该听得很多了。但是我想说，你所听到的服务治理可能混合了流量调度等其它内容。我们这里会把服务治理和流量调度分开来讲。所以，今天这节课只涉及服务治理上的一些关键技术，主要有以下几点。

- 服务关键程度
- 服务依赖关系
- 服务发现
- 整个架构的版本管理
- 服务应用生命周期全管理

# 服务关键程度和服务的依赖关系

下面，我们先看看服务关键程度和服务的依赖关系。关于服务关键程度，主要是要我们梳理和定义服务的重要程度。这不是使用技术可以完成的，它需要细致地管理对业务的理解，才能定义出架构中各个服务的重要程度。

然后，我们还要梳理出服务间的依赖关系，这点也非常重要。我们常说，“没有依赖，就没有伤害”。这句话的意思就是说，服务间的依赖是一件很易碎的事。依赖越多，依赖越复杂，我们的系统就越易碎。

因为依赖关系就像“铁锁连环”一样，一个服务的问题很容易出现一条链上的问题。因此，传统的SOA希望通过ESB来解决服务间的依赖关系，这也是为什么微服务中希望服务间是没有依赖的，而让上层或是前端业务来整合这些后台服务。

但是要真正做到服务无依赖，我认为还是比较有困难的，总是会有一些公有服务会被依赖。我们只能是降低服务依赖的深度和广度，从而让管理更为简单和简洁。在这一点上，以Spring Boot为首的微服务开发框架就开了一个好头。

**微服务是服务依赖最优解的上限，而服务依赖的下限是千万不要有依赖环**。如果系统架构中有服务依赖环，那么表明你的架构设计是错误的。循环依赖有很多的副作用，最大的问题是这是一种极强的耦合，会导致服务部署相当复杂和难解，而且会导致无穷尽的递归故障和一些你意想不到的问题。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/88/94/57b3d984.jpg" width="30px"><span>architect-lc</span> 👍（11） 💬（2）<div>关于分布式调用监控，为什么您推荐zipkin？skywalking和pinpoint您有什么评价吗？目前项目正在考虑分布式调用监控的问题，谢谢</div>2018-01-01</li><br/><li><img src="" width="30px"><span>恩言</span> 👍（5） 💬（1）<div>皓哥，能推荐一两本相关书籍么</div>2017-12-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6a/d5/73c75eb3.jpg" width="30px"><span>夜行观星</span> 👍（31） 💬（0）<div>每篇文章都看好几次</div>2017-12-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/9f/e8/26004860.jpg" width="30px"><span>菩提树下的杨过</span> 👍（23） 💬（4）<div>服务的循环依赖，有时候是公司组织结构和管理不合理导致的，比如几个相对独立的部门，A部门要搞一个新需求，依赖B部门提供的服务，B部门又依赖C部门的服务，而C又依赖A部门的服务。如果没有能站在上帝视角俯视全局的明白人指路（通常是公司最熟悉技术及业务的资深人士或xx委员会），部门之间沟通又不顺畅的情况下，服务依赖环就这么产生了，甚至还可以顺利上线，为将来又添新坑</div>2018-06-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/95/6d/bc01fdf7.jpg" width="30px"><span>白</span> 👍（19） 💬（0）<div>zipkin好像对代码侵入性有点大</div>2018-04-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/79/46/0d4bfcdd.jpg" width="30px"><span>ytz</span> 👍（9） 💬（0）<div>腾讯的tars也带有versionset，配合序列化协议实现兼容和升级也是非常便利。</div>2018-08-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ea/0c/d79ae60d.jpg" width="30px"><span>Vance</span> 👍（6） 💬（1）<div>作为一个App开发，看的是一脸懵逼，但是感觉后台的架构，分布式系统，还有自动运维这些技术是真的牛逼！希望有机会可以更深入学习一下。</div>2019-07-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e0/cf/43f201f2.jpg" width="30px"><span>幼儿编程教学</span> 👍（5） 💬（3）<div>请教。state和status的区别是什么?</div>2018-12-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/28/2b/818c8b85.jpg" width="30px"><span>蟹蟹</span> 👍（4） 💬（0）<div>前面都看懂 但是最后的服务编排没明白…</div>2018-07-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/db/b2/29b4f22b.jpg" width="30px"><span>JasonZ</span> 👍（3） 💬（2）<div>如果系统架构中有服务依赖环，那么表明你的架构设计是错误的。循环依赖有很多的副作用，最大的问题是这是一种极强的耦合，会导致服务部署相当复杂和难解

这个能举例说明下么？而不是结论</div>2019-09-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/2b/30/3be5c7bf.jpg" width="30px"><span>AT</span> 👍（3） 💬（0）<div>关于分布式调用监控，为什么您推荐zipkin？skywalking和pinpoint您有什么评价吗？目前项目正在考虑分布式调用监控的问题，谢谢
2018-01-01</div>2018-09-06</li><br/><li><img src="" width="30px"><span>Geek_110</span> 👍（2） 💬（0）<div>请教一下，ESB为什么是Choreography，之前SOA服务之间调用不应该是通过ESC路由，消息协议转换么，我怎么感觉更应该像Orchestration的一个指挥者啊，文中的意思是API Gateway来取代ESC么，他们两个的功能不一样啊？而且gateway和服务内部之间调用没有关系吧</div>2019-12-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/73/16/595b0342.jpg" width="30px"><span>slark</span> 👍（2） 💬（0）<div>服务关键程度，服务依赖梳理，服务发现，服务治理，服务监控，服务扩缩容。这些道理，在我们生活中也是很朴素适用的。
找到生活工作的关键目标，确定关键的事情，厘清事物先后顺序，采取措施执行，并持续监控状态，刷新调整，最终向目标迈进。
而在开发的世界里，通过构建这样一套服务的管理系统，我们就可以对外提供一个稳定可靠的服务。在遇到服务故障，服务更新，回退以及突发事件时候可以及时感知并采取措施。
要做到这一点还是感谢开源的力量，有一整套思路来指引我们采取措施，也有一系列工具可以提供我们采用。docker和k8s，目前在云开发中已经是新的开发基础，这里面也有很多坑，前人在总结和优化，开发者只要能把工具用好都已经可以实现自我的提升了。</div>2019-12-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/69/88/528442b0.jpg" width="30px"><span>Dale</span> 👍（2） 💬（1）<div>我们工作中使用kubernetes进行服务部署，镜像带上版本信息，服务升级只需要更新镜像，对POD点进行灰度发布。使用容器化，kubernetes集群管理大大提高工作效率</div>2019-01-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（2） 💬（0）<div>zipkin，长见识了</div>2018-12-30</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJowicLVgt4uscjBFa2jG7WyBZ0G9ID9JibHdCiafpl7j01txMMXlEiayQjNkw70QKtJAtJ35XAI5voCg/132" width="30px"><span>realwuxing</span> 👍（1） 💬（0）<div>有个疑问是zipkin应该对代码侵入相对pinpoint来讲有些大，这个是怎么更好的解决的？尤其是已有的系统。</div>2019-12-29</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIia1btmwb5hhTazpu2OxaiaGwavXPQrsp5QVIlSF5jczsq3PS3siaUiazSErAKuiangahTjVpXCNV1W6A/132" width="30px"><span>随风</span> 👍（1） 💬（0）<div>介绍的很详细，自己实践后会理解更深</div>2019-12-19</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eq8qpSvBoZz89u3BhGXWLibs2OibCkZl8bx74aLSJ58f467bR8anNaTiccJklcqjBdhfvvJpvLVmYesA/132" width="30px"><span>Haan</span> 👍（1） 💬（0）<div>实践➕阅读</div>2019-12-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/03/c9/9a9d82ab.jpg" width="30px"><span>Aaron_涛</span> 👍（1） 💬（0）<div>对于spring cloud是 zuul，那么对于dubbo和thrift类比是什么呢。</div>2019-12-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/59/37/bd2de0a4.jpg" width="30px"><span>edisonhuang</span> 👍（1） 💬（0）<div>从服务关键程度、服务依赖关系、整个架构的版本管理，服务和资源的调度，服务的故障恢复和动态扩容，全面阐述了分布式系统架构五大关键技术之——服务资源调度。</div>2019-06-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/d7/39/6698b6a9.jpg" width="30px"><span>Hector</span> 👍（1） 💬（0）<div>真知灼见和学富五车的感觉，皓哥的内力真的是深厚</div>2019-05-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/80/da/9c0c458c.jpg" width="30px"><span>安静</span> 👍（1） 💬（0）<div>服务直接不能循环依赖</div>2018-11-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/7a/8e/934cbcbc.jpg" width="30px"><span>几叶星辰</span> 👍（1） 💬（1）<div>老师可否讲下，负载均衡,比如一个主机通过负载均衡器到达服务器A，在已建立路由表的情况下，那台主机到负载均衡器的所有包都是路由给服务器A吗</div>2018-05-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/37/3f/a9127a73.jpg" width="30px"><span>KK</span> 👍（0） 💬（0）<div>主要阐述的还是理论，算是立意。</div>2023-12-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/fe/b4/295338e7.jpg" width="30px"><span>Allan</span> 👍（0） 💬（0）<div>每一篇文章都是涵盖大量的知识，这一篇文章就需要学习好久才能领会文章的真谛</div>2022-06-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/b1/81/13f23d1e.jpg" width="30px"><span>方勇(gopher)</span> 👍（0） 💬（0）<div>提供了不少聚合的思路，目前在做弹性扩缩容，有非常大的收益！</div>2021-10-18</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83er4IPqj4H3jQHq4C1lgKh6ZroK3CVmGLiadic7S1rxbuy09JM9x8Aib6VkozPkO4lrUTHAhicX1z9Cg2w/132" width="30px"><span>seedjyh</span> 👍（0） 💬（0）<div>公司太小，服务只有很少几个，且每种服务的实例也只有很少几个，也可以上kubernetes吗</div>2021-10-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/97/1a/389eab84.jpg" width="30px"><span>而立斋</span> 👍（0） 💬（0）<div>【服务关键程度
服务依赖关系
服务发现
整个架构的版本管理
服务应用生命周期全管理】
我对这个关键技术理解是这样的。就好比我们要做成一件事情，那事情呢肯定不是一蹴而就的。需要给这个事情进行一些关键点的设置，这就类似于服务发现。
那这些关键点呢，肯定有一些比较重要的，那这些呢就是关键服务了。
那这些服务之间是不是还应该得有点前后顺序呀。
那在做事情的途中就需要我们对这些小事儿进行思考起来那个完成了，那个没完成。完成会怎样没完成又会怎样。有时呢，在做的过程中。我们可能还会对整个做事情大思路进行下调整。这个思路就是我们做事情大的架构了</div>2020-11-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/f1/12/7dac30d6.jpg" width="30px"><span>你为啥那么牛</span> 👍（0） 💬（0）<div>看了此文，才发觉离喜玛拉雅顶峰，还远得很</div>2020-08-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e6/70/b9907b0e.jpg" width="30px"><span>高科</span> 👍（0） 💬（0）<div>对服务流程编排这块内容很感兴趣，目前我们的业务中也在做这方面的尝试，目前感觉原子服务的抽象是有一定难度的，并不能总是适应需求</div>2020-04-25</li><br/>
</ul>