你好，我是陈皓，网名左耳朵耗子。

其实，去中心化的共识机制也是要解决拜占庭将军问题（[The Byzantine Generals Problem](https://web.archive.org/web/20170205142845/http://lamport.azurewebsites.net/pubs/byz.pdf)），它是莱斯利·兰伯特（Leslie Lamport）于1982年提出来的，用来解释一致性问题的一个虚构模型。同时，它也是分布式领域中最复杂、最严格的容错模型。

# 分布式一致性算法

拜占庭的将军们没有一个中心化的领导机构，所以，如果他们需要攻击某个城市，所有将军需要对任何将军可能提出的攻击时间达成共识。也就是说，只有所有的将军都达成了共识，在同一个攻击时间攻击，就有非常大的胜率。但是，问题来了。这时，可能会有多个将军同时发出不同的攻击计划，而且这些将军中还有叛徒。那么，将军们怎样达成共识呢？

莱斯利·兰伯特证明，当叛变者不超过 1/3时，存在有效的算法。不论叛变者如何折腾，忠诚的将军们总能达成一致的结果。如果叛变者过多，则无法保证一定能达到一致性。

拜占庭问题之所以难解，在于任何时候系统中都可能存在多个提案（因为提案成本很低），并且要完成最终的一致性确认过程十分困难，容易受干扰。但一旦确认，即为最终确认。

比特币的区块链网络在设计时使用的 PoW（Proof of Work） 算法思路。一个是限制一段时间内整个网络中出现提案的个数（增加提案成本），另外一个是放宽对最终一致性确认的需求，约定好大家都确认并沿着已知最长的链进行拓宽。

也就是说，如果比特币系统在某一个时刻同时出现了两个都合法的区块，那么两个都承认。于是，区块链上会出现两个合法的分支（术语叫"分叉"）。此时矿工可以选择任何一个分支继续，在某个分支的长度超过了另一个分支时，短的那个分支马上作废。

如果你看过我之前写的《分布式系统架构的本质》系列文章，那么一定知道Paxos协议，这也是一种分布式一致性的共识算法。但为什么不用Paxos和Raft来做区块链的一致性算法的协议呢？这两个算法对资源的消耗比PoW要小得多呢。
<div><strong>精选留言（28）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/7a/43/b99e209a.jpg" width="30px"><span>.</span> 👍（11） 💬（1）<div>讲的好清楚！
补充亮点
在bitcoin挖矿中，GPU已经被更专业的ASIC取代了
在改进版的POS中，要求参与者抵押资产来解决nothing at stake的问题</div>2018-06-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/2b/2b/bebf6eed.jpg" width="30px"><span>酱了个油</span> 👍（2） 💬（1）<div>耗子叔，关于链长导致的效率问题，是说每个区块生成后都需要把整条链走一遍来验证合法性吗，这一步主要是做什么校验呀</div>2018-04-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/37/ef/66671161.jpg" width="30px"><span>Geek_7vgqz2</span> 👍（0） 💬（1）<div>其实Paxos&#47;Raft也能作为区块链网络中的共识算法，只是不能使用在公有链里面，不能BFT。联盟链CFT应该就够了。</div>2018-04-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/41/27/3ff1a1d6.jpg" width="30px"><span>hua168</span> 👍（7） 💬（0）<div>大神，分布式方面，能不能讲下安全，像国内大网站经常会被攻击他们是怎么防攻击，像防DDOS做CDN+DDOS防火墙效果也不怎么好，都在哪些地方做安全……能简单讲下吗？谢谢……</div>2018-04-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg" width="30px"><span>neohope</span> 👍（6） 💬（0）<div>哈哈哈，您预测的很准，EOS的主链刚上线就挂了。我觉得BM能力是有的，但对团队的管理水平就有些差了。 应该多看看您的文章。</div>2018-06-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2a/0a/09/43e43a02.jpg" width="30px"><span>Sarmurai45</span> 👍（1） 💬（0）<div>这里引用一下王强老师（新东方集团联合创始人）演讲的时候说的话：
从人文的角度来看，完全的去中心化制度是难以实现的乌托邦。所谓的“完全去中心化的思想”，并非区块链出现后才提出来，很早的无政府主义思想本身就是完全的去中心化。可是，能实现吗？根本做不到。再推而广之，我们的宇宙本身就不是按照去中心化的模式存在的，比如月亮围绕地球转，地球围绕太阳转，而太阳系围绕着银河系中心在转。换句话说，我们的世界离不开“引力”，只要有“引力”在，就会有“中心”，只不过，我们有很多个中心，但并不是没有中心。而区块链违背了这一基本思想。</div>2022-12-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/bb/52/71aab155.jpg" width="30px"><span>猪脚姜</span> 👍（1） 💬（1）<div>一般人最多也就了解个POW POS DPOS，但是像耗子哥这样能从系统演变的过程来谈真是让人耳目一新，层次太高了！</div>2020-04-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/db/4d/8dec7917.jpg" width="30px"><span>迪</span> 👍（1） 💬（0）<div>耗子叔想的果然深远，去中心化发展到最后可能又回归中心化</div>2020-03-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/9e/4a/2f81b0f5.jpg" width="30px"><span>freeland</span> 👍（1） 💬（0）<div>最后说到了去中心化，安全性和高性能不能同时存在，现在的侧链的这种方案，主链用安全的pow，锚定对应的资产到侧链，侧链用dpos这样的共识，如果发现侧链有问题，主链通过plasma cash把侧链中的资产withdraw，是不是就同时有去中心化，安全性和高性能了</div>2018-11-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4e/38/3faa8377.jpg" width="30px"><span>登高</span> 👍（1） 💬（0）<div>行家出手，比起之前看过的文章更有高度</div>2018-04-29</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELLvDhMwfXEVicTwl5rQoCGwTibAebFqusXFDoZwQYMS3bVPkgnr4q4YicJWZkH00rOuv7DjZ7dxY6fg/132" width="30px"><span>derek</span> 👍（1） 💬（0）<div>老师有了解墨客吗？作为母链，可在之上构建各种子链，子链可使用自己的共识机制，并实现了分层分片</div>2018-04-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6b/1d/3f99f2a5.jpg" width="30px"><span>macworks</span> 👍（1） 💬（0）<div>有人的地方就有政治，这点任何协议都不能免除。至于去中心化和中心化的演进其实很正常。有些去中心化解决不了的问题，需要引入中心化的方案，而中心化的引入又会带来风险，所以又会有新的去中心化的提议出现。如果你仔细想想，法币，例如美金，很大程度上也是去中心化的。能搞定去中心化和安全本身已经是很了不起的事情了，性能问题是可以通过引入中心化的方案，例如担保机构来解决。这在一定程度上是可以接受的。</div>2018-04-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg" width="30px"><span>escray</span> 👍（0） 💬（0）<div>文中对于 PoW 和 Paxos&#47;Raft 算法的讨论比较有价值。

区块链和比特币面临的问题，在共识机制这里已经暴露出来了。

蛮荒社会&#47;工作量证明 PoW，资本主义&#47;股权证明 PoS，选票主义&#47;委托股权证明 DPoS 其实都有各自需要解决的问题，而且看上去这些问题是无解的。

去中心化、安全和高性能，只能选两个，安全谁也不敢放弃，所以选择就更少了，又何止区块链是这样？

其实，非中心化的乌托邦可能并不美好，没有中介的经济社会效率也可能很差。

看了界面新闻的那篇《EOS超级节点投票：“千亿”利润下的币圈国家战争》，这么大的利益，怎么可能没有阴影？另外，破坏规则的人一般都让人讨厌。

EOS 目前的市值只有 7 块多。
</div>2023-03-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/27/fa/c5/ffb49f5e.jpg" width="30px"><span>BoBo🌙68</span> 👍（0） 💬（0）<div>这篇讲的太好了 牛啊</div>2021-11-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/fa/4b/c385f755.jpg" width="30px"><span>向前走</span> 👍（0） 💬（0）<div>拜占庭将军问题，是一个经典问题，这里涉及的算法，值得深入学习</div>2020-10-21</li><br/><li><img src="" width="30px"><span>shangrila</span> 👍（0） 💬（0）<div>很好的讲解</div>2020-05-21</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJu684YiafbNTjJNZ0BpxD2wVzW9mSdBEQd6ALfnqQJDcfntiatOmRribgngn31JIsibgQUF7t2q1ibIkQ/132" width="30px"><span>xxyyyboy</span> 👍（0） 💬（0）<div>讲的真棒</div>2020-04-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（0） 💬（0）<div>能力均衡可以搞无中心化的事情，否则不现实，慢慢就会演变成另一种中心化的运转方式。
浩哥，讲的真棒，头次接触也能有所收获。</div>2020-02-28</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoH9Mlw0kLK0p39vhQpdvkbQP5TX96DB9HMJ1POaTVDpMZg4rjlO3WCAqiaWWMc77ffS3vTo8qWdXA/132" width="30px"><span>xdargs</span> 👍（0） 💬（0）<div>信息量很大，很多点都要值得花大篇幅查询学习</div>2019-10-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg" width="30px"><span>QQ怪</span> 👍（0） 💬（0）<div>说的真好</div>2019-10-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/35/5a/7431e82e.jpg" width="30px"><span>Michael</span> 👍（0） 💬（0）<div>现在的DAG可以说解决高性能的思路吗？</div>2018-08-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/99/7d/19f12443.jpg" width="30px"><span>Alvin</span> 👍（0） 💬（0）<div>看了很多介绍比特币技术的文章，能站在社会发展历史的宏观角度探谈比特币技术的，耗子叔是我见到的第一个。读你的专栏越读越觉得物超所值，你的音频也是我听过的技术类最棒的，看得出用心做了</div>2018-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/75/97/abcd222a.jpg" width="30px"><span>杨洪林</span> 👍（0） 💬（0）<div>非常佩服作者的理解深度，我有一个问题请教。区块链技术的去中心，高性能和 安全 怎么和CAP 中的 Consistency, availability and partition tolerance 一一对应呢？consistency 对应安全性，partition tolerance 对应去中心化， availability 对应性能？ 不知道我的理解对不对？</div>2018-04-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/9a/ee/abb7bfe3.jpg" width="30px"><span>总指挥</span> 👍（0） 💬（0）<div>很有意思啊哈哈</div>2018-04-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ac/a1/43d83698.jpg" width="30px"><span>云学</span> 👍（0） 💬（0）<div>很欣赏这种辩证看技术的文章，不知不觉中解决了之前的很多疑问，对区块链也比较理性了，相比于去中性化，防篡改和可追溯更有应用价值</div>2018-04-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a9/47/3718cf90.jpg" width="30px"><span>微leng</span> 👍（0） 💬（0）<div>有个疑问  最初的比特币是咋来的，当时还没有交易吧</div>2018-04-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/37/13/7014c581.jpg" width="30px"><span>xiaotao</span> 👍（0） 💬（0）<div>请教一下，去中心化的协议还有gossip，为什么不是用gossip呢？</div>2018-04-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/82/f3/01bf3b3e.jpg" width="30px"><span>王亚南</span> 👍（0） 💬（0）<div>有几个疑问，可能比较初级：1、比特币能成为货币必然需要发行，那现在比特币的唯一发行增量就是挖矿产生的奖金了？2、如果每一笔交易都需要获得全网确认一致的话，比特币交易不是会很慢，现在采用比特币交易的平台体验会很差吧？</div>2018-04-10</li><br/>
</ul>