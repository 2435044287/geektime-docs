你好，我是陈皓，网名左耳朵耗子。

在分布式系统的世界里，一个服务有多个实例，所以部署或是升级一个服务也会变得比较麻烦。今天我们讨论服务部署的模式。一般来说，有如下几种：

- 停机部署（Big Bang / Recreate）： 把现有版本的服务停机，然后部署新的版本。
- 蓝绿部署（Blue/Green /Stage）：部署好新版本后，把流量从老服务那边切过来。
- 滚动部署（Rolling Update / Ramped）： 一点一点地升级现有的服务。
- 灰度部署（Canary）：把一部分用户切到新版本上来，然后看一下有没有问题。如果没有问题就继续扩大升级，直到全部升级完成。
- AB测试（A/B Testing）：同时上线两个版本，然后做相关的比较。

下面，我们来看一下每种方式的使用场景和优缺点。

# 停机...
<div><strong>精选留言（25）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/8c/bf/e55c54f2.jpg" width="30px"><span>画圈圈</span> 👍（31） 💬（6）<div>太笼统了，关键是实现细节。</div>2018-05-12</li><br/><li><img src="" width="30px"><span>shufang</span> 👍（14） 💬（0）<div>滚动部署：逐个上；灰度部署：全上，逐步切换；蓝绿部署：全上，预发生产切换；AB测试：全上，同时存在。不知道理解的对不对？</div>2018-05-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f8/ba/d28174a9.jpg" width="30px"><span>Geek_zbvt62</span> 👍（8） 💬（0）<div>我觉得现在很多方案混合了蓝绿和灰度，这二者不会细分了。首先微服务架构下，单个服务的部署带来的冗余成本很低。同时也通过网关做流量的逐步迁移。发现问题回滚很快。尤其是基有了容器编排之后就更方便了</div>2018-05-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/ef/62/87d9ef62.jpg" width="30px"><span>Geek_CK2020</span> 👍（4） 💬（0）<div>第一次意识到灰度部署和AB部署的本质区别是，前者是因为质量，后者是因为功能。</div>2020-04-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/5f/90/711efc88.jpg" width="30px"><span>FuriousEric</span> 👍（3） 💬（0）<div>很多同学说没有实现，我教大家一个方法，极客时间里搜一下蓝绿部署啊，极客时间的搜索功能要多用，例如redis分布式锁，有个专栏作者写的我完全看不懂，搜索了一下，发现耗子写的最好，秒懂。马上就找到另外一个专栏写的实践操作了，负载均衡里把蓝色集群全部删除掉，切换到绿色集群(例如阿里云的负载均衡配置），实际上那个专栏里叫做红黑部署，蓝绿部署是另外一种意思</div>2020-10-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/9d/3c/1dd238c8.jpg" width="30px"><span>国诚</span> 👍（3） 💬（0）<div>要是有点能落地的东西就好了</div>2018-11-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/34/20/d9408a6a.jpg" width="30px"><span>独白</span> 👍（3） 💬（0）<div>对于有修改数据结构，新老版本不兼容，除了停机部署，其他几种部署有没有好的方案？</div>2018-10-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/70/8b/67a2baf5.jpg" width="30px"><span>先立个flag，完成才改名的咸鱼</span> 👍（2） 💬（1）<div>蓝绿和灰度有什么区别？</div>2019-09-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（2） 💬（1）<div>我们有J-ONE，测试通过，预发布通过，线上一般使用滚动部署的方式发布。</div>2019-02-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/f1/84/7d21bd9e.jpg" width="30px"><span>Goal</span> 👍（1） 💬（3）<div>打卡：57 | 管理设计篇之“部署升级策略”
针对本节课的内容，让我想起了之前做 k8s里面的 Deploy升级的场景，但是遇到一个问题始终无法解释？

 默认k8s中升级新版本的策略是滚动更新，这个意思的话，就是服务不会中断的， 但是在我测试中发现并非如此，具体如下：
假设，我Deploy 的副本是3个，现在有版本是2的镜像要上线，通过 kubectl images修改 Deploy镜像版本为新的版本2，这时，我在另外一台机器上一直curl接口，发现当有第一个版本2的节点加入到 Deploy对应的 Service的 endpoint上时候，curl会显示 请求被拒绝响应的情况。</div>2020-01-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/59/37/bd2de0a4.jpg" width="30px"><span>edisonhuang</span> 👍（1） 💬（0）<div>部署升级方式有停机，蓝绿，滚动，灰度，AB测试等。不同的方式在资源消耗，状态一致，功能性能验证方面有区别。云时代基本不会使用的是停机部署的方式，对用户影响太大</div>2019-07-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/21/20/1299e137.jpg" width="30px"><span>秋天</span> 👍（1） 💬（1）<div>有些东西能不能具体说说实现方式呢？谢谢！</div>2018-05-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/8a/ca/1afcc75b.jpg" width="30px"><span>健康的小牛犊</span> 👍（0） 💬（0）<div>现在基本都采用微服务之后，产品快速迭代的时候其实涉及到的要更新微服务的数量还是有限的，这时候我觉得可以用灰度或者说局部蓝绿部署是比较方便的，而且需要的资源也是有限的，如果再配合istio，实际上去做灰度还是很方便的，回退也是切换一下路由的事情而已。</div>2023-12-13</li><br/><li><img src="" width="30px"><span>Geek_3c5e02</span> 👍（0） 💬（0）<div>再也看不到陈老师的更新了 一路走好</div>2023-05-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d9/71/9c134b18.jpg" width="30px"><span>李印</span> 👍（0） 💬（0）<div>停机这种，很少用到，蓝绿部署倒是可以将生产环境主机切分成两半，通过流量控制，达到切换目的。滚动这种依赖部署平台支持，手动太麻烦了。灰度部署有很多种灰度方式，比如单量计数，账户白名单，切分流量等。AB测试，可能在客户端应用比较多</div>2023-04-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg" width="30px"><span>escray</span> 👍（0） 💬（0）<div>以前的工作环境是采用停机部署策略的，但是需要避开工作时段，所以部署更新的时间区间是 00:00 - 08:00，因为业务的要求一般开始时间还会更晚一些，如果超过了这个时间，就变成事故了。

云计算时代或者云原生平台，是不是更适合蓝绿部署？

滚动部署似乎对于运维的要求比较高。

蓝绿部署是为了不停机
灰度部署是对新版本的质量没信心
AB 测试是对新版的功能没信息

不知道现在的部署，是不是都应该在运维框架下进行？</div>2023-03-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ae/4a/a71a889b.jpg" width="30px"><span>迷宫中的将军</span> 👍（0） 💬（0）<div>红黑部署是现在典型的云上部署方式。</div>2021-01-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/f1/12/7dac30d6.jpg" width="30px"><span>你为啥那么牛</span> 👍（0） 💬（0）<div>如果数据库表设计发生了变更，金丝雀部署，通过引流得方式升级，会不会有问题了。</div>2020-10-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d9/71/9c134b18.jpg" width="30px"><span>李印</span> 👍（0） 💬（0）<div>预发布停机部署，生产滚动部署，或灰度</div>2020-05-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/87/62/f99b5b05.jpg" width="30px"><span>曙光</span> 👍（0） 💬（0）<div>感觉灰度部署和AB测试是一种部署，灰度部署强调怎么部署（10%新版本，90%旧版本），而AB测试强调的是新老版本的使用情况，测试比较。</div>2020-04-28</li><br/><li><img src="" width="30px"><span>Geek_130e9e</span> 👍（0） 💬（0）<div>部署应用有很多种方法，实际采用哪种方式取决于需求和预算。当发布到开发或者模拟环境时，停机或者滚动部署是一个好选择，因为干净和快速。当发布到生产环境时，滚动部署或者蓝绿部署通常是一个好选择，但新平台的主流程测试是必须的。</div>2020-04-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/c0/b7/791d0f5e.jpg" width="30px"><span>AQiu</span> 👍（0） 💬（0）<div>灰度和滚动自己有些没分清，</div>2020-01-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/37/4e/5c3153b2.jpg" width="30px"><span>知行合一</span> 👍（0） 💬（0）<div>停机部署是业务变更比较大并且可控的情况下才会使用，蓝绿部署工作中还很少用到，滚动部署比较常用，但是需要考虑两个版本同时运行这段时间的兼容问题，灰度发布在发app版本的时候用到了，但是服务端还未对人群做灰度，ABtest应用在了一些业务上但是服务发布时还没用到过，实现这所有发布模式的发布系统可畏是很强大了</div>2020-01-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/92/fd/6b0e58fe.jpg" width="30px"><span>文刂 氵共 超</span> 👍（0） 💬（0）<div>坚持学习，学习笔记 https:&#47;&#47;mubu.com&#47;colla&#47;1kM6EcLYQJ0</div>2020-01-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/10/65/46cc65d7.jpg" width="30px"><span>蜗牛</span> 👍（0） 💬（0）<div>文中介绍的蓝绿部署在切换时候，2个版本都在线。。。。</div>2019-07-24</li><br/>
</ul>