你好，我是陈皓，网名左耳朵耗子。

保护系统不会在过载的情况下出现问题，我们就需要限流。

我们在一些系统中都可以看到这样的设计，比如，我们的数据库访问的连接池，还有我们的线程池，还有Nginx下的用于限制瞬时并发连接数的limit\_conn模块，限制每秒平均速率的limit\_req模块，还有限制MQ的生产速，等等。

# 限流的策略

限流的目的是通过对并发访问进行限速，相关的策略一般是，一旦达到限制的速率，那么就会触发相应的限流行为。一般来说，触发的限流行为如下。

- **拒绝服务**。把多出来的请求拒绝掉。一般来说，好的限流系统在受到流量暴增时，会统计当前哪个客户端来的请求最多，直接拒掉这个客户端，这种行为可以把一些不正常的或者是带有恶意的高并发访问挡在门外。
- **服务降级**。关闭或是把后端服务做降级处理。这样可以让服务有足够的资源来处理更多的请求。降级有很多方式，一种是把一些不重要的服务给停掉，把CPU、内存或是数据的资源让给更重要的功能；一种是不再返回全量数据，只返回部分数据。

因为全量数据需要做SQL Join操作，部分的数据则不需要，所以可以让SQL执行更快，还有最快的一种是直接返回预设的缓存，以牺牲一致性的方式来获得更大的性能吞吐。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/63/3c/b4cfbce9.jpg" width="30px"><span>华烬</span> 👍（3） 💬（1）<div>期待秒杀的文章，不过好像要等挺久的</div>2018-03-21</li><br/><li><img src="" width="30px"><span>shufang</span> 👍（3） 💬（10）<div>限流看着怎么有点像熔断？</div>2018-03-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c3/1e/633a1e87.jpg" width="30px"><span>理帆</span> 👍（45） 💬（9）<div>对于要代码的同学我想说，工作久了你就会发现最重要的是思想、是方向，而不是实现、代码。并不是说代码本身不重要，但如果知道解题思路，那就成功了一半。如果没有思路，或者思路错了，那写代码毫无用处，甚至会起到反作用。思想决定高度，这不是一句空话。</div>2020-04-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/87/84/abb7bfe3.jpg" width="30px"><span>LI</span> 👍（31） 💬（10）<div>文章都很好，就是缺少代码落地，看起来很理论</div>2018-05-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/c3/48/3a739da6.jpg" width="30px"><span>天草二十六</span> 👍（9） 💬（0）<div>建议留言要代码的同学们，参考阿里Sentinel</div>2019-11-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/8c/97/c8f7426e.jpg" width="30px"><span>张乐乐</span> 👍（7） 💬（1）<div>我们动态限流一般是根据资源来进行的，CPU&#47;内存&#47;带宽，存储对于出流部件可以转为带宽。根据响应时间来限流这个想起来比较难实施，后面再研究下。
此外，限流也可以考虑做多级，不同阶段不同的阈值限制，分层去限制，比如操作体统OS层，链接处理，业务处理。
也需要，考虑针对异常用户的识别限制，很多时候，一个异常用户带来的影响会特别大。</div>2018-04-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5c/de/abb7bfe3.jpg" width="30px"><span>权乐观</span> 👍（4） 💬（0）<div>感觉漏斗是最弱鸡的队列啊</div>2018-04-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/21/20/1299e137.jpg" width="30px"><span>秋天</span> 👍（3） 💬（0）<div>目前在做一个异步压测的东西，对于异步请求可以及时释放线程，导致发送请求的速率过快导致网络缓冲区被打满或者后端业务线程池耗尽，根据异步回调的成功和失败率，做了一个动态限流的算法，用于调节一个趋近于最优并发的一个量，不会导致网络缓冲区打满或者业务线程池耗尽。其实觉得目前市面上动态限流，还没有比较好的开源方案</div>2020-06-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg" width="30px"><span>aoe</span> 👍（3） 💬（0）<div>第二遍看，才注意到实现的相关算法。第一次看热闹，感觉会了，面试的时候被问到，居然一脸懵！</div>2020-04-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/9a/b9/3c67fc24.jpg" width="30px"><span>Star</span> 👍（3） 💬（3）<div>熔断是限流的一种怎么理解？能不能描述一下熔断和限流的关键区别？</div>2018-10-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7c/59/dc9bbb21.jpg" width="30px"><span>Join</span> 👍（2） 💬（0）<div>如果关心代码实现的话,可以去easeegress看ratelimiter的代码。</div>2022-03-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/79/e3/9c84f86e.jpg" width="30px"><span>A圆规</span> 👍（2） 💬（0）<div>最好有代码落地，有点书本。</div>2018-05-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5c/b5/0737c1f2.jpg" width="30px"><span>kuzan</span> 👍（2） 💬（0）<div>读两遍，感觉自己之前还是肤浅了</div>2018-05-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/42/76/256bbd43.jpg" width="30px"><span>松花皮蛋me</span> 👍（2） 💬（0）<div>老师好，请问下微信红包退还是怎么设计的，如果使用redis过期通知，订阅者下线再连接期间过期的信息不过再通知</div>2018-03-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/73/16/595b0342.jpg" width="30px"><span>slark</span> 👍（1） 💬（0）<div>很好理解
首先，限流的目的是为了保护系统不在过载的情况下导致问题。接着讲了几种限流的策略。然后讲了，限流的算法，包括计数器、队列、漏斗和令牌桶。然后讨论了如何基于响应时间来限流。最后，我总结了限流设计的要点。下篇文章中，我们讲述降级设计。希望对你有帮助。</div>2020-02-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/4c/bd/489ee7c1.jpg" width="30px"><span>星空下</span> 👍（1） 💬（1）<div>tcp维加斯算法就可以做限流</div>2019-10-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/2d/ca/02b0e397.jpg" width="30px"><span>fomy</span> 👍（1） 💬（0）<div>限流机制：使用Hystrix的相关配置，只对部分接口进行了限流，没有对所有的接口。比如在一些点赞上加一些限流。直接使用hystrix的相关注解实现。</div>2019-08-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/a3/40/e0df3b84.jpg" width="30px"><span>力挽狂澜爆炸输出的臭臭宁</span> 👍（1） 💬（3）<div>看完后有两个问题：
1.漏桶是不是就是一个一级队列？

2.令牌桶和漏桶有什么实质性的区别？
假设处理器的处理速度是100个请求&#47;每秒，所以令牌桶中令牌的投放速度是100个令牌&#47;每秒，假设令牌桶的大小为50，也就是说最多积压50个令牌；
假设现在突然流量变大，以300个请求&#47;每秒的速度产生请求；
对于漏桶算法，因为出口速度是不变的，所以不论请求速度是多少，处理速度都是100&#47;s；
对于令牌桶算法，由于令牌桶中可以积压一定的令牌，所以在流量涌入的第一秒，令牌桶的请求处理速度可以达到150&#47;s，之后都是100&#47;s；
这样分析对吗？如果按这样分析的话，令牌桶和漏桶的区别就在于请求涌入的第一秒的处理速度，这个不同有什么意义呢？只在流量涌入的第一秒多处理50个请求能有什么收益呢？</div>2018-12-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/65/d5/88beb15a.jpg" width="30px"><span>李志博</span> 👍（1） 💬（0）<div>期待加防刷设计</div>2018-04-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a6/90/5295fce8.jpg" width="30px"><span>昵称</span> 👍（1） 💬（1）<div>文章中一开始提到的limit-req指？</div>2018-04-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/80/82/3c21b30c.jpg" width="30px"><span>梅子黄时雨</span> 👍（0） 💬（0）<div>学习了。</div>2022-10-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/b1/81/13f23d1e.jpg" width="30px"><span>方勇(gopher)</span> 👍（0） 💬（0）<div>目前在网关侧设计限流，Kong</div>2021-11-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/c4/98/9c7a1a23.jpg" width="30px"><span>罗杰.菲の樂</span> 👍（0） 💬（0）<div>我在这里想问一下多租户环境的限流和resource governance的关系？欢迎知道的同学参与讨论。</div>2020-07-20</li><br/><li><img src="" width="30px"><span>Geek_88604f</span> 👍（0） 💬（1）<div>既然有了传送层 TCP 协议相关的拥塞控制的算法，为啥还要针对基于TCP之上的HTTP做限流？</div>2020-05-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg" width="30px"><span>aoe</span> 👍（0） 💬（0）<div>耗子叔讲的通俗易懂，还给出了相关算法和扩展资料！非常好，十分感谢！</div>2020-02-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/9c/e9/5ba8b1a3.jpg" width="30px"><span>郭新鹏</span> 👍（0） 💬（0）<div>自己实现过的限流方式就是用redis进行实现的。
$strKey = “limit:qps:” . time();
$intQps = $redis-&gt;incr($strKey);
判断intQps该值是否大于某个值
 </div>2020-01-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/0e/c77ad9b1.jpg" width="30px"><span>eason2017</span> 👍（0） 💬（0）<div>大家好，请教一个关于今天流控，通过队列实现的几个问题：
1）如何区分请求是应该放入到哪个队列（高低权重不同的队列）呢？
2）队列的消费者是后端服务还是当前这个服务呢？
谢谢~~</div>2020-01-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/92/fd/6b0e58fe.jpg" width="30px"><span>文刂 氵共 超</span> 👍（0） 💬（1）<div>坚持学习，笔记 https:&#47;&#47;mubu.com&#47;colla&#47;6a5boAX4mdM</div>2019-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ce/be/5cf3f1a0.jpg" width="30px"><span>junshuaizhang</span> 👍（0） 💬（0）<div>mark</div>2019-12-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/44/f2/e7158fa0.jpg" width="30px"><span>张稀虹</span> 👍（0） 💬（0）<div>“我们就知道有多少请求大于某个响应时间。如果这个 P90 或 P99 超过我们设定的阈值，那么我们就自动限流。” 这句话中还是提到了一个“阈值”，这个值很难去评估。如果是类似TCP Vegas算法那样，那这个阈值是过去的最小rt，但是实际使用中容易出现误限，在服务无法恢复到之前的最小rt水平时还会导致流量跌零。 老师能否给出一些更具体的实现讲解？</div>2019-08-10</li><br/>
</ul>