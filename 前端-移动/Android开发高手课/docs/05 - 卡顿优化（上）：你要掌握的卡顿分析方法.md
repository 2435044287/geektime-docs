“我的后羿怎么动不了！”，在玩《王者荣耀》的时候最怕遇到团战时卡得跟幻灯片一样。对于应用也是这样，我们经常会听到用户抱怨：“这个应用启动怎么那么慢？”“滑动的时候怎么那么卡？”。

对用户来说，内存占用高、耗费电量、耗费流量可能不容易被发现，但是用户对卡顿特别敏感，很容易直观感受到。另一方面，对于开发者来说，卡顿问题又非常难以排查定位，产生的原因错综复杂，跟CPU、内存、磁盘I/O都可能有关，跟用户当时的系统环境也有很大关系。

那到底该如何定义卡顿呢？在本地有哪些工具可以帮助我们更好地发现和排查问题呢？这些工具之间的差异又是什么呢？今天我来帮你解决这些困惑。

## 基础知识

在具体讲卡顿工具前，你需要了解一些基础知识，它们主要都和CPU相关。造成卡顿的原因可能有千百种，不过最终都会反映到**CPU时间**上。我们可以把CPU时间分为两种：用户时间和系统时间。用户时间就是执行用户态应用程序代码所消耗的时间；系统时间就是执行内核态系统调用所消耗的时间，包括I/O、锁、中断以及其他系统调用的时间。

**1. CPU性能**

我们先来简单讲讲CPU的性能，考虑到功耗、体积这些因素，移动设备和PC的CPU会有不少的差异。但近年来，手机CPU的性能也在向PC快速靠拢，华为Mate 20的“麒麟980”和iPhone XS的“A12”已经率先使用领先PC的7纳米工艺。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/14/4b/b6/b7c79ed7.jpg" width="30px"><span>小雨点</span> 👍（11） 💬（2）<div>有点深了，表示看不太懂</div>2018-12-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/5b/dd/26056401.jpg" width="30px"><span>memory</span> 👍（9） 💬（1）<div>感觉这个课可能更适用于比较深入研究过内存方面知识的人，但是大部分人应该都是开发业务的程序员，想对这方面做个系统的学习，感觉还是有点难了，给出的课后作业，有点一脸懵逼，有点无从下手的感觉</div>2018-12-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/4c/7d/15dd5caf.jpg" width="30px"><span>国庆</span> 👍（3） 💬（1）<div>太极客了吧，讲的东西感觉像是华山论剑！</div>2018-12-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/4a/18/90810a3d.jpg" width="30px"><span>石先</span> 👍（3） 💬（2）<div>绍文哥，我又来了。我比较感兴趣之前内存优化文章里面提到对 Bitmap 的优化，可以[通过直接调用 libandroid_runtime.so 中 Bitmap 的构造函数]来创建一个空的 nativeBitmap 对象，但这个操作跟平时自己通过 jni 调用自己编译的 so 包里的 native 方法不太一样，网上也找不到例子来说明这个过程，所以能不能把这个过程再描述详细一点，或者最好是能 show me code，我也想自己实操一遍你说的那些点，非常感谢。</div>2018-12-12</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIyqjqjTlaiavWBEgKwfDqzsFKDb3JgNMLxgaT6EHKkYJCIctZ7eZQ8quS3pvx43YZcMBCnKxCSonA/132" width="30px"><span>Xmilton</span> 👍（2） 💬（1）<div>张总，我想问下真机是不是读不到&#47;proc&#47;stat里的信息？该怎么处理呢。</div>2019-01-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/50/e0/e0b368c1.jpg" width="30px"><span>李大可</span> 👍（2） 💬（1）<div>通过读取文件获取进程cpu,线程cpu等使用状态的一个问题是在不少机型上，没有读取这些文件的权限。如果需要将release版本的这些性能数据采集并上传供数据分析，数据的采集就是一个问题，比如线程cpu使用率，常规的做法是才用两个间隔时间较短的cpu快照，然后计算应用cpu使用时间在系统cpu使用时间所占的比例，但是cpu使用时间是一个一个时间片，上述的统计方法并不够准确</div>2018-12-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/47/27/448b5262.jpg" width="30px"><span>我的心情在荡漾</span> 👍（2） 💬（1）<div>各种命令一脸懵逼</div>2018-12-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/72/a8/c24a66a1.jpg" width="30px"><span>Geek_sky</span> 👍（1） 💬（2）<div>我尝试用uptime查看系统负载，只能看到up time: 06:40:38, idle time: 20:50:31, sleep time: 00:00:00。我是用了cat &#47;proc&#47;loadavg查看到了系统负载。是不是现在的机器不能通过uptime查看了？</div>2019-12-13</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLobEjahgqrVyY6Gdo03rfwLr083dfcSSiaLzeD1AQMYzLKpLq44HqOpVZgycNVBp1zoHibPAydyO4g/132" width="30px"><span>Geek_3r58d4</span> 👍（1） 💬（1）<div>希望作者能给出个深入学习的路线图</div>2018-12-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/45/76/2b1354f6.jpg" width="30px"><span>张亚运</span> 👍（0） 💬（1）<div>计算机科学太高深了，知道自己渺小的办法是多出去看看走走，在自己圈子里，总以为自己无所不知。</div>2019-12-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e8/fd/035f4c94.jpg" width="30px"><span>欢乐小熊</span> 👍（0） 💬（1）<div>获取当前进程下的使用率成功了, 不过获取 &#47;proc&#47;stat 和 &#47;proc&#47;loadavg 出现了无权限访问的问题..</div>2019-11-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/75/93/8135f895.jpg" width="30px"><span>bywuu</span> 👍（0） 💬（1）<div>那么，递归函数，能通过插桩来分析吗？估计还是要放在上层函数里</div>2019-05-25</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ5mXhSvjKm6aGTgkGxSV6t9iaIicvUG3TmD3NUn0V6zNTDUM1JMu31M8zj2gicibco7jCZoXLkxh7kBQ/132" width="30px"><span>th0sky</span> 👍（0） 💬（1）<div>可以详细讲解systrace的分析思路吗？ systrace生成的html里面内容太多了</div>2019-04-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/87/58/829d7c4f.jpg" width="30px"><span>Mr.Zhao</span> 👍（0） 💬（1）<div>看完了，还是不知道这几个工具怎么用。</div>2019-01-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/cc/56/df75ed7d.jpg" width="30px"><span>Geek_6174df</span> 👍（0） 💬（1）<div>请教一下taceview会不会出现本来耗时少的方法显示比耗时长的方法，耗时的情况？</div>2019-01-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/e8/8d/f4320226.jpg" width="30px"><span>森森</span> 👍（0） 💬（1）<div>绍文哥，课后作业中这个结果是怎么拿到的</div>2019-01-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/83/ef/2453b1e9.jpg" width="30px"><span>Geek_vi4asb</span> 👍（0） 💬（1）<div>绍文老师，从 Android O 开始不允许非系统 app 读取 &#47;proc&#47;stat 文件了，无法读取系统 cpu 的 使用情况。不知是否还有新的在线监控 cpu 使用率的方法？网上找了好久好久，都没有找到新的方法。谢谢https:&#47;&#47;issuetracker.google.com&#47;issues&#47;37140047</div>2019-01-11</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epZHmvJIosQ5OrAnIwCE7BY8D5XxJxtVa1rrkHTKImUzianyXfibtiapZauWgUpmXbyJu4X3QxMlnCNw/132" width="30px"><span>张敬东</span> 👍（0） 💬（1）<div>app运行是内存基本在500M左右算不算是很高的内存表现了? 看了下主要是native内存可以到190M左右，平时native内存也是最低在120M左右。</div>2018-12-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/aa/87/7f44ec43.jpg" width="30px"><span>许圣明</span> 👍（0） 💬（1）<div>你好，github 上的作业要求没太明白，本作业的实现方式和 ProcessCpuTracker 是一样的吧？二者有什么区别吗？</div>2018-12-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/02/c3/e9026d82.jpg" width="30px"><span>张亮</span> 👍（0） 💬（1）<div>请问，经常说的 “线上”是什么意思</div>2018-12-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/4f/23/db8403c7.jpg" width="30px"><span>L</span> 👍（0） 💬（1）<div>其实吧，作者有时间的话，可以整理一下几个工具具体怎么用，以及工具中关注点是什么，以及读者应该重点关注的相关知识点等等，不然对于很多没有分析过性能问题的，可能你讲的这些估计他们都云里雾里的！效果可能不太好！仅此个人意见！</div>2018-12-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/16/b6/03144162.jpg" width="30px"><span>AndU</span> 👍（0） 💬（1）<div>张老师您好，看了您这些篇文章，相对于前几篇感觉好了挺多的。也慢慢趋于我买这个专栏的期待。不过还有一个问题是您这边最开始说的是结合案例与课后作业来教学。例如本章节我们应该有一个案例来如何使用systrace 或者traceview分析一个卡顿应用。课后作业也应该是分析卡顿问题，而非是如何获取anr的信息，ANR不属于性能卡顿，只能说是属于稳定性方面。希望能够跟着张老师的案例不断的学习进步。</div>2018-12-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/1b/e6/6a88c8a3.jpg" width="30px"><span>刘伟</span> 👍（92） 💬（0）<div>高级的东西看的越多，越觉得Android高深的东西都是在Andriod之外的~</div>2018-12-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/76/ae/d6f40a9b.jpg" width="30px"><span>志伟</span> 👍（91） 💬（0）<div>8核cpu，平均负载8，idle时间去到72%，说明应用运行中系统CPU性能有很大的盈余。
sample应用时间分布大头在kernel，细分看线程，SingleThread是主要耗时线程，并且共发生了3094次缺页异常(faults字段)。缺页异常的处理是在内核空间，也解释了kernel 耗时大头的原因，而这里做的操作就是读写磁盘。猜测可能是很多小文件的读写。
综合分析瓶颈应该是sample将io集中在一个线程中处理，系统的全部cpu没有利用上，一核忙死，其他3核闲死。</div>2018-12-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/a3/1f/c94facb8.jpg" width="30px"><span>nodlee</span> 👍（64） 💬（4）<div>理论是基石，例子是上层建筑。希望作者多结合一些实际案例讲解，理论太多，感觉很空洞。作为付费用户，这个要求不高吧。</div>2018-12-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/45/91/1233679c.jpg" width="30px"><span>Dr.strange🐬</span> 👍（6） 💬（0）<div>大神，能给Linux的学习路线吗</div>2018-12-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/a4/6f/672a27d4.jpg" width="30px"><span>will</span> 👍（6） 💬（0）<div>很多没有接触的工具，还是需要去了解一下Linux方面的基础，后面的作业没看太明白</div>2018-12-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/b2/02/db9abbda.jpg" width="30px"><span>天堂泪</span> 👍（5） 💬（0）<div>要我讲，我喜欢一篇文章说一个这种工具，或者只讲一个或两个推荐使用的工具。
还有一点不好的是不够深入，比如这个工具怎么使用，有什么使用技巧，举实例来分析问题。
这样讲更费心，也更费时间。可以朝这个方向优化。</div>2021-03-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/2e/62/ea49480e.jpg" width="30px"><span>Zain Zhu</span> 👍（4） 💬（0）<div>工作好多年完全没有接触过这个层次的知识，惭愧！现在来恶补这些东西还是有点吃力的，主要原因还是基础功不扎实，看这些东西就有点像空中楼阁，能远远的看到，但摸不到门。</div>2020-05-19</li><br/><li><img src="" width="30px"><span>勇敢地追</span> 👍（4） 💬（0）<div>大略分析一下，问题集中在kernal和io上。R表示正在运行，S表示TASK_INTERRUPTIBLE，在等待某件事情发生（多数是IO）。可见很可能是一个线程在执行IO操作，其他线程在等待。kernel faults的解释在这里有：https:&#47;&#47;blog.csdn.net&#47;vanquishedzxl&#47;article&#47;details&#47;47029805。通常是在内核申请分配物理内存。kernel faults数字大表示申请了好多次。也就是说有大量IO操作
说点体会吧，分析这个需要查阅好多资料，以及对Linux最好也要熟悉。熟悉以后基本就知道sample大致该怎么写了</div>2019-11-02</li><br/>
</ul>