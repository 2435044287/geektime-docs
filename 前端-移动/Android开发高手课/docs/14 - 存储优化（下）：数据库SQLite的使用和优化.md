我们先来复习一下前面讲到的存储方法的使用场景：少量的Key Value数据可以直接使用SharedPreferences，稍微复杂一些的数据类型也可以通过序列化成JSON或者Protocol Buffers保存，并且在开发中获取或者修改数据也很简单。

不过这几种方法可以覆盖所有的存储场景吗？数据量在几百上千条这个量级时它们的性能还可以接受，但如果是几万条的微信聊天记录呢？而且如何实现快速地对某几个联系人的数据做增删改查呢？

对于大数据的存储场景，我们需要考虑稳定性、性能和**可扩展性**，这个时候就要轮到今天的“主角”数据库登场了。讲存储优化一定绕不开数据库，而数据库这个主题又非常大，我也知道不少同学学数据库的过程是从入门到放弃。那么考虑到我们大多是从事移动开发的工作，今天我就来讲讲移动端数据库SQLite的使用和优化。

## SQLite的那些事儿

虽然市面上有很多的数据库，但受限于库体积和存储空间，适合移动端使用的还真不多。当然使用最广泛的还是我们今天的主角SQLite，但同样还是有一些其他不错的选择，例如创业团队的[Realm](https://github.com/realm/realm-java)、Google的[LevelDB](https://github.com/google/leveldb)等。

在国内那么多的移动团队中，微信对SQLite的研究可以算是最深入的。这其实是业务诉求导向的，用户聊天记录只会在本地保存，一旦出现数据损坏或者丢失，对用户来说都是不可挽回的。另一方面，微信有很大一批的重度用户，他们有几千个联系人、几千个群聊天，曾经做过一个统计，有几百万用户的数据库竟然大于1GB。对于这批用户，如何保证他们可以正常地使用微信是一个非常大的挑战。
<div><strong>精选留言（16）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/e7/89/207cc841.jpg" width="30px"><span>HI</span> 👍（3） 💬（1）<div>大致的看了Matrix SQLiteLint的源码实现，由于Androd N hook sqlite3_profile 会出现问题，SQLiteLint 并不能实时的获取到sql语句，而是采用java层主动的告知SQLiteLint 要分析的sql，比如分析 select *，PrepareStatement， 而对于检测 Autoincrement，冗余索引，Without RowId 而是通过native层告知java层要查询的内容，java层将查询之后的内容再通知native层，这个检测的时间间隔为4秒，这4秒是有什么依据的吗</div>2019-03-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/14/66/96f8d2b1.jpg" width="30px"><span>黄小木🐵</span> 👍（2） 💬（1）<div>张老师好，提个问题，我们项目当前用的是ormlite关系型数据库框架，已经利用里面的api写了大量sql语句，请问如何最低成本的替换成wcdb呢？</div>2019-02-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/da/66/5858322e.jpg" width="30px"><span>满大大</span> 👍（1） 💬（1）<div>老师客户端怎么开启WAL模式</div>2019-12-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/46/9d/79edce49.jpg" width="30px"><span>嘿，抬头</span> 👍（1） 💬（1）<div>张老师，请教个问题：
启动一个Activity,可以查出数据库中数据，但切换下系统语言，Activity重启，却查不出数据库中的数据！！！（debug看到两次都执行了查询数据库的代码）
希望您指点一二，谢谢~</div>2019-01-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/4f/23/db8403c7.jpg" width="30px"><span>L</span> 👍（0） 💬（1）<div>sqlite wal mode w模式sync mode 可以直接修改成OFF？若不行，怎么论证？谢谢！因为修改成OFF可以减少 DB fdatasync call</div>2019-02-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/1d/64/52a5863b.jpg" width="30px"><span>大土豆</span> 👍（0） 💬（0）<div>我有一个想法，老师看下是否合理，把MySQL（innodb）这套全部放到移动端来，唯一区别是MySQL是C&#47;S模型，访问方式（连接层）改造下，改成移动端类似sqlite的db文件类型。这样，innodb的行级锁可强多了，然后MySQL总体是多线程读写并发的，不是能更好地榨干移动端的性能吗？微信有这么想过吗？</div>2022-02-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/66/10/010ff1ab.jpg" width="30px"><span>JavanRhino</span> 👍（0） 💬（0）<div>PRAGMA SQLITE_THREADSAFE = 2 这个是用java代码设置吗？看源码好像没有提供java api呀</div>2021-07-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/66/10/010ff1ab.jpg" width="30px"><span>JavanRhino</span> 👍（0） 💬（1）<div>对于 iOS 来说可能没有多进程访问数据库的场景，可以把 locking_mode 的默认值改为 EXCLUSIVE。
——&gt;应该是对于Android来说吧？</div>2021-07-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/54/c1/1d852e91.jpg" width="30px"><span>hs</span> 👍（0） 💬（0）<div>老师想问一下这句话的意思
“还有需要说明的是，同一个句柄同一时间只有一个线程在操作，这个时候我们需要打开连接池 Connection Pool”  为什么同一个句柄同一时间只有一个线程在操作，就需要开启线程池</div>2020-11-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a4/f5/9ce95dd5.jpg" width="30px"><span>JeffMony</span> 👍（0） 💬（0）<div>这篇文章太深了</div>2020-03-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/e8/6b/ce264eb0.jpg" width="30px"><span>lbj</span> 👍（0） 💬（0）<div>想咨询个问题，checkpoint是100pages一次，那假如app的生命周期中往sqlite写的数据加起来都不到100pages，那即使app被杀死了也没到触发checkpoint的临界值，这个时候这部分数据是直到n次app使用积攒到100pages在checkpoint还是怎么处理</div>2020-01-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/4a/b7/a3468e61.jpg" width="30px"><span>OF</span> 👍（0） 💬（0）<div>哎，这辈子赶不上大佬了</div>2019-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/5b/30/83104f0f.jpg" width="30px"><span>薯条</span> 👍（0） 💬（0）<div>多线程、多进程 操作数据库的时候，可以得到一个database 对象，假如在某一个线程中调用了db.close 方法就会出现问题。看了好多方案，，最好的就如文章所说，不关闭db</div>2019-10-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/5b/30/83104f0f.jpg" width="30px"><span>薯条</span> 👍（0） 💬（0）<div>时间开发中 遇到过 “多线程操作sqlite3 导致数据库损坏的问题” 没想到 微信在这块做了这么多功夫</div>2019-10-05</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIuUYcwKWUuib5mpdIbTwQzTGNWBmk0ktZSwm2vteUXf4TxWF2aVCv7Hvshcq0OaG7JRLj6rJyPLicA/132" width="30px"><span>godliness</span> 👍（0） 💬（1）<div>但是需要注意的是，写之间是仍然不能并发

Android 系统默认提供的 SQLiteConnecionPool ，主连接只有一个（可写的），否则在 Java 层多线程等待（这里是等待-释放-唤醒）。不会出现 SQLiteDatabaseLockedException
</div>2019-09-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/74/4a/2dd9d62a.jpg" width="30px"><span>EchoSomeTH</span> 👍（0） 💬（0）<div>18:56.100 2712-2732&#47;com.exampletest.liepin.chapter14_wcdb D&#47;SqliteLint.Native: Lint::Check checked cnt=2
2019-07-24 19:18:56.101 2712-2732&#47;com.exampletest.liepin.chapter14_wcdb V&#47;SqliteLint.Native: SqlInfoProcessor::ParseObj wildcard_sql_ = insert into message values(?)
2019-07-24 19:18:56.102 2712-2732&#47;com.exampletest.liepin.chapter14_wcdb V&#47;SqliteLint.Native: Lint::PreProcessSqlInfo processRet:ret:0
2019-07-24 19:18:56.103 2712-2732&#47;com.exampletest.liepin.chapter14_wcdb V&#47;SqliteLint.Native: Lint::Check() already checked recently
2019-07-24 19:18:56.110 2712-2732&#47;com.exampletest.liepin.chapter14_wcdb I&#47;SqliteLint.Native: Lint::TakeSqlInfo queue empty and wait

这是 8.0 插入一条数据，调用notifySqlExecution才出来的，这个好像···没有啥有用数据撒</div>2019-07-24</li><br/>
</ul>