> 在超市排队结账，扫码支付启动十几秒都还没完成，只能换一个工具支付？

> 想买本书充实一下，页面刷出来时候十几秒都不能操作，那就换一个应用购买？

用户如果想打开一个应用，就一定要经过“启动”这个步骤。启动时间的长短，不只是用户体验的问题，对于淘宝、京东这些应用来说，会直接影响留存和转化等核心数据。对研发人员来说，启动速度是我们的“门面”，它清清楚楚可以被所有人看到，我们都希望自己应用的启动速度可以秒杀所有竞争对手。

那启动过程究竟会出现哪些问题？我们应该怎么去优化和监控应用的启动速度呢？今天我们一起来看看这些问题该如何解决。

## 启动分析

在真正动手开始优化之前，我们应该先搞清楚从用户点击图标开始，整个启动过程经过哪几个关键阶段，又会给用户带来哪些体验问题。

**1. 启动过程分析**

![](https://static001.geekbang.org/resource/image/0d/43/0da2051f1f8d182a531063eb202abf43.png?wh=1368%2A560)

我以微信为例，用户从桌面点击图标开始，会经过4个关键阶段。

- **T1预览窗口显示**。系统在拉起微信进程之前，会先根据微信的Theme属性创建预览窗口。当然如果我们禁用预览窗口或者将预览窗口指定为透明，用户在这段时间依然看到的是桌面。
- **T2闪屏显示**。在微信进程和闪屏窗口页面创建完毕，并且完成一系列inflate view、onmeasure、onlayout等准备工作后，用户终于可以看到熟悉的“小地球”。
- **T3主页显示**。在完成主窗口创建和页面显示的准备工作后，用户可以看到微信的主界面。
- **T4界面可操作**。在启动完成后，微信会有比较多的工作需要继续执行，例如聊天和朋友圈界面的预加载、小程序框架和进程的准备等。在这些工作完成后，用户才可以真正开始愉快地聊天。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/2a/72/d2f27024.jpg" width="30px"><span>海贼凯</span> 👍（13） 💬（1）<div>闪屏页需要网络请求怎么进行优化？</div>2019-10-12</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKw77qmuyx5tPjGznNo7DmKvpU688GpazMQtfdafxj6Z0MSviaIlBtuEs2ibtYxCmibfWpOkKIoXibiavA/132" width="30px"><span>menty</span> 👍（5） 💬（1）<div>python systrace.py --list-cate...
请问这种命令在什么环境运行，试了在adb shell中运行不了</div>2019-03-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e6/64/f531917b.jpg" width="30px"><span>黄秀明</span> 👍（4） 💬（1）<div>王老师，请问线程的优先级是否需要考虑？</div>2019-02-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/d7/17/cddc5f3a.jpg" width="30px"><span>66</span> 👍（2） 💬（1）<div>请问对于生成的trace文件，分析的重点应该是在哪几个指标？界面上指标参数有点多</div>2019-03-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/47/73/63a3cb41.jpg" width="30px"><span>信仰年轻</span> 👍（1） 💬（1）<div>Unable to select a master clock domain because no path can be found from &quot;SYSTRACE&quot; to &quot;LINUX_FTRACE_GLOBAL  老师，我查看生成的test.log.html报这个错误啊</div>2019-01-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/27/b3/e9c55f7c.jpg" width="30px"><span>this is it</span> 👍（0） 💬（2）<div>请问Sample如何移植到自己的项目中去，我尝试移植一直不成功，还请能给出详细的移植操作步骤，感谢！</div>2019-12-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/1d/87/c291de43.jpg" width="30px"><span>磊</span> 👍（0） 💬（1）<div>hi 老师，代码如何计算启动耗时啊？ad shell am start -W 计算规则怎么看的？</div>2019-03-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/58/27/1188e017.jpg" width="30px"><span>Egos</span> 👍（0） 💬（1）<div>张老师，你好！我们app 统计耗时和文章说的差不多，在主页onWindowFocusChanged 时计算最终时长。分析的时候发现在主页onResume 和onWindowFocusChanged 之间的时间差很大，看了源代码以后发现onResume 和onWindowFocusChanged 之间会执行ViewRootImpl#performMeasure，但是performMeasure 也远小于他们的时间差(大概小了1倍)。这种情况该怎么去分析呢，有办法dump 这段时间有什么耗时操作？</div>2019-03-18</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoSMRiaMtAcqQ81wsudfqcVOdLmQYwjyZgzDPhhdBMEvIA2jasd8tU9S8kUebdov6M6CwlibwRL31Hw/132" width="30px"><span>炸山哥</span> 👍（0） 💬（1）<div>张老师，请问project.getProperties().get(&quot;android&quot;).registerTransform跟示例的注册Transform方式哪一种更好点呢？我见上面也有人问了同样的问题。</div>2019-02-24</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKE7KHyLv1Zian5yzyby3ricSClVp0wwia8evbicGPH9icSAVYHhREVO39CtcHc77x05XONNK61JXoNXfg/132" width="30px"><span>iniesta2014</span> 👍（0） 💬（1）<div> 使用此插件集成到项目里面，然后打开生成的trace.html ，报了“Unable to select a master clock domain because no path can be found from &quot;SYSTRACE&quot; to &quot;LINUX_FTRACE_GLOBAL&quot;. 关闭插件可以正常查看trace.html 。前面也有人遇到了</div>2019-01-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/5e/0a/cee81344.jpg" width="30px"><span>Moruna</span> 👍（0） 💬（1）<div>张老师，Sample涉及的操作都是在linux系统下执行的吗？windows跑有问题
python $ANDROID_HOME&#47;platform-tools&#47;systrace&#47;systrace.py gfx view wm am pm ss dalvik app sched -b 90960 -a com.sample.systrace  -o test.log.html
报错</div>2019-01-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/4c/0d/0f7450e6.jpg" width="30px"><span>戴寅华</span> 👍（0） 💬（1）<div>张老师您好，在练习Sample，操作运行gradle task &quot;:systrace-gradle-plugin:buildAndPublishToLocalMaven&quot; 编译plugin插件后，提示了Could not find method google() for arguments [] on repository container. 望指点迷津，谢谢</div>2018-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ed/17/c3eb014f.jpg" width="30px"><span>IOT..Yang</span> 👍（0） 💬（1）<div>运行sample时，会一直白屏卡住了，看comment中有人说需要把TraceTag也配置到blackMethodList里（为什么这样做？），的确如此，配置一下就OK了，成功生成了trace.html文件，但目前对这个不太熟悉，里面看得有点懵，今天学习了好长时间，大概了解了些基础，我想问下张哥systrace-gradle-plugin插件库有什么作用，我看官网主要介绍systrace和Trace的使用。

正好最近要优化app启动时间，纸上得来总觉浅，绝知此事要躬行，fighting！</div>2018-12-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/35/87/b2a1e5cc.jpg" width="30px"><span>catkin</span> 👍（0） 💬（1）<div>终于看到稍微简单的了，前面理解真的很难，看breakpad源码，和inline hook真的难死了，才明白一点点，还得继续努力啊！到java这块还是很简单了，自信又回来了！那么多hook技术啥时候讲讲呗！</div>2018-12-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/49/8b/844e70df.jpg" width="30px"><span>热心网友</span> 👍（0） 💬（1）<div>张老师，Simple启动就StackOverflowError了，是不是需要把TraceTag也配置到blackMethodList里</div>2018-12-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7b/0e/6d4109ee.jpg" width="30px"><span>金樽明月</span> 👍（0） 💬（1）<div>你好，能讲一下 React Native 应用的具体优化吗？由于启动时要启动很多RN的东西，所以比一般的安卓应用慢了好多……最近一直在愁</div>2018-12-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/1e/79/54a1635c.jpg" width="30px"><span>PP</span> 👍（10） 💬（0）<div>Unable to select a master clock domain because no path can be found from &quot;SYSTRACE&quot; to &quot;LINUX_FTRACE_GLOBAL&quot;.解决方法

在chrome浏览器的地址栏中输入：chrome:&#47;&#47;tracing
之后点击左上角的load加载你生成的test.log.html文件就可以正常查看。</div>2019-04-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/50/9f/28a206c8.jpg" width="30px"><span>天蓝若空</span> 👍（8） 💬（1）<div>请问下张老师，延迟拉起进程要怎么处理，在清单文件中四大组件有多进程，默认就初始化了所有的进程，这个有点不明白</div>2018-12-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/d4/8d/a3fd8957.jpg" width="30px"><span>Kenny</span> 👍（6） 💬（3）<div>张老师，你好，我们在做了启动优化跟张老师所说90%相同，目前情况来看也取得了50%
以上的启动速度提升，但是我们想做更加极致，现在发现有些手机有jit线程，这个在启动过程中占了大量的cpu时间片，我也翻看了源码，发现这个线程是在activitythread里面初始化的，是一个jvm线程，请问张老师，这个有方案关闭吗？</div>2018-12-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/82/6e/f552d036.jpg" width="30px"><span>山鬼</span> 👍（5） 💬（0）<div>老师，示例的tranfrom注册方法和直接调用registerTransform有什么区别吗？这块不是太懂</div>2018-12-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e7/39/b47b1bc0.jpg" width="30px"><span>奚岩</span> 👍（2） 💬（0）<div>sample 跑在真机出现下面错误：
Unable to select a master clock domain because no path can be found from &quot;SYSTRACE&quot; to &quot;LINUX_FTRACE_GLOBAL&quot;.

换模拟器好了，有遇见类似的么😂</div>2018-12-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5f/01/d3a1eb4d.jpg" width="30px"><span>人生如歌</span> 👍（2） 💬（1）<div>你好，下面的说法:在启动过程也不要过早地拉起应用的其他进程，System Server 和新的进程都会竞争 CPU 资源。有点疑惑
按道理开机启动拉起新进程是监听开机广播后拉起的，而SystemServer中的service启动完了之后才会发送开机广播；当然，如果是因为监听开机广播的进程太多，导致过多的请求SystemServer中的AMS，也会导致新进程与System Server竞争cpu资源
另外，再请教一个问题，像微信这种国民级应用，系统很难杀死，因为几乎看不到微信启动的过程，一打开就出现了聊天界面，是不是各大厂商都有对他进行特殊保活，还是因为设置了更低的adj值导致系统不杀呢？谢谢</div>2018-12-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/48/34/40cb22a7.jpg" width="30px"><span>无知</span> 👍（1） 💬（0）<div>虽然更新的很慢，但是我还是没有跟上节奏。前几篇都没有跑起来，今天的才真正的按照老师说的做了一次，加油。</div>2018-12-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/4e/9f/ece713ac.jpg" width="30px"><span>朱蓝天</span> 👍（1） 💬（0）<div>没有闪屏页面的APP情何以堪，老板还要求用户在没有闪屏过渡的情况下做到无感知启动。。</div>2018-12-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f1/91/4bbc7f73.jpg" width="30px"><span>从前有只🐻</span> 👍（1） 💬（0）<div>文章每一句话可能就包含一个新的知识点，确实需要课后补充自学的点还是很多的，加油吧</div>2018-12-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/0e/68/63901154.jpg" width="30px"><span>文盲猪式会社</span> 👍（0） 💬（0）<div>sample 跑起来了，终于get到 systrace + 函数插桩的用法，特别是systrace, 以前收集之后面对一堆数据无从下手</div>2024-08-12</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/PrUDxP61MBnVAMWsKUPLYuPh5LkWc9wcYze7Lia0XpXgoJAI5eR2pavIQCVdqYQmM39SFJJNlYgdbKiaPGCU1vEA/132" width="30px"><span>Geek_eea446</span> 👍（0） 💬（0）<div>我这么理解，预览窗口是starting window，想请教下闪屏页是什么</div>2022-07-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0d/73/01598bd5.jpg" width="30px"><span>Lilee</span> 👍（0） 💬（0）<div>老师，文中提到的预览窗口是个activity吗？如果不是的话，怎么在theme中设置？我找了一下，好似没有这方面的方法。</div>2020-11-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/51/6c/26890599.jpg" width="30px"><span>曹晶</span> 👍（0） 💬（1）<div>张老师，我把插件集成到我们项目里，发现这几个问题，求解答：
1. 抓trace和比不抓trace，app本身性能差了不少，明显卡顿很多。比较报告中掉帧的情况也明显差，在RenderThread上明显都耗时很多，这是什么原因？
2. 想抓启动的trace，发现生成报告失败，报错是MemoryError()，求教是什么原因，难道超了Python内存了？</div>2020-11-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0f/e9/9f9202e8.jpg" width="30px"><span>wind</span> 👍（0） 💬（0）<div>systrace + 函数插桩 生成的文件导入chrome后应该如何查看呢？</div>2020-06-15</li><br/>
</ul>