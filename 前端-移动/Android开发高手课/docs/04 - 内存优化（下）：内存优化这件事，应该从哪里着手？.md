在掌握内存相关的背景知识后，下一步你肯定想着手开始优化内存的问题了。不过在真正开始做内存优化之前，需要先评估内存对应用性能的影响，我们可以通过崩溃中“异常退出” 和OOM的比例进行评估。另一方面，低内存设备更容易出现内存不足引起的异常和卡顿，我们也可以通过查看应用中用户的手机内存在2GB以下所占的比例来评估。

所以在优化前要先定好自己的目标，这一点非常关键。比如针对512MB的设备和针对2GB以上的设备，完全是两种不同的优化思路。如果我们面向东南亚、非洲用户，那对内存优化的标准就要变得更苛刻一些。

铺垫了这么多，下面我们就来看看内存优化都有哪些方法吧。

## 内存优化探讨

那要进行内存优化，应该从哪里着手呢？我通常会从设备分级、Bitmap优化和内存泄漏这三个方面入手。

**1. 设备分级**

相信你肯定遇到过，同一个应用在4GB内存的手机运行得非常流畅，但在1GB内存的手机就不一定可以做到，而且在系统空闲和繁忙的时候表现也不太一样。

**内存优化首先需要根据设备环境来综合考虑**，专栏上一期我提到过很多同学陷入的一个误区：“内存占用越少越好”。其实我们可以让高端设备使用更多的内存，做到针对设备性能的好坏使用不同的内存分配和回收策略。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/de/7e/5c2b1efe.jpg" width="30px"><span>孙鹏飞</span> 👍（31） 💬（1）<div>看评论有部分同学对内存这两篇的内容主题提出了疑问，说是内存优化的主题关注内存监控的内容太多了。邵文同学已经在下面的评论里有部分回复了，我这里总结一下原因。首先我们并没有很直接的去给出很多优化的案例，比如评论里提到的hook gc来避免gc引起的memory churn的技术，或者常见的引起内存泄漏几种情况的解决、数据结构优化(arraymap等)，更换序列化方案，view复用，object pool等优化方法，也没有具体的去讲解内存相关的操作系统概念和Android虚拟机heap space的结构和allocator的执行原理，这些内容大部分网上有很多不错的帖子进行了很详细的讲解，而且限于篇幅我们把内容关注在我们经常遇到的问题上，就是我们如何去监控不当的内存使用，比如发生OOM或者短时间频繁的GC产生卡顿的时候，如果我们没有具体的内存监控信息是无法判断产生问题的原因，这也是我们在实际工作中遇到的问题，也是这两篇内容关注的点，如果同学有想了解的内容可以在留言里提出来，看大家具体对哪些文章里没有提到的内容感兴趣，可以讨论一下。</div>2018-12-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/48/54/872fc401.jpg" width="30px"><span>灰</span> 👍（28） 💬（1）<div>内存优化的主题是监控？</div>2018-12-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/f9/a3/5bbf0635.jpg" width="30px"><span>[etartnecnoC]H</span> 👍（25） 💬（3）<div>说下看了几篇文章的感受，可能确实是实力差距，看完后感觉实用性太差，都是讲的一些高大上的理论和市面上大部分公司都用不到的东西，没有一个循序渐进的过程或者引导，毕竟交钱来参加高手课的水平大部分都是菜鸟啊。楼上有个建议很好，讲这篇文章前先把一些用到的基础知识贴一下链接。看来真的是高手课，高到云端了，很难触及的那种。</div>2018-12-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ef/9e/78420b67.jpg" width="30px"><span>0928</span> 👍（13） 💬（1）<div>感觉主题有一点跑偏，在监控内存泄露的前提下，应该从怎么防止内存泄露着手，我感觉会更实用，因为监控不是每个公司都涉及的，但是防止内存泄露应该是每个程序员应该必备的。我感觉可以多来一点实现思路和怎么预防泄露已经常见的一些泄露点。

虽然网上有很多帖子可看，但是有以下一些问题，零散、正确性、思路、如何验证等等问题，既然大家都来买课我想也是奔着课程的专业程度来的，所以我感觉作者在深入的同时也不要忘记一些实用的东西分享。及时是因为篇幅的问题，我感觉可以通过其他链接的方式引入。

拜托！</div>2018-12-10</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/iagWXcgTEF36nmBo8am6xgPSjE1KZ8Tk1LrQlCg6icsnF9SJw0V7LomgcfAogfE1lNQm4U1tPeEoznibYia2ia0cnRg/132" width="30px"><span>jacob</span> 👍（10） 💬（1）<div>您好，如何确定是bitmap重复图片呢，遍历所有像素点比较吗，是不是太重了</div>2018-12-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/45/b2/ee0cfc12.jpg" width="30px"><span>Seven</span> 👍（9） 💬（1）<div>平时在做图片优化的时候，主要用inSampleSize控制图片大小，将大图片调整到合适的大小，毕竟是google推荐的方案。

总结一下我今天学到的关于内存优化的东西
设备分级：根据设备的高级程度（综合考虑）使用最佳的实践方式；
控制进程数量（看到有节操的保活会心一笑）；
注意控制包大小；
图片优化：统一管理，统一监控；
重复图片：一个一个对比像素肯定不现实，比尺寸刷一波，再比像素，先取一个像素点，估计这一步就能刷掉很多不同的图片，然后在剩下的图片继续用这种方式（或者增加像素点），不知道可行性高不高（待定），应该有更好的方式；
内存泄漏：先第三方框架查漏，时机成熟后及时还“技术债务”；
内存监控：查找内存占有率，尽量做到“用完就走”，不占资源。

“技术债务”真是一个好词，平时一点一点的还肯定比遇到紧急情况加班加点的还要好的多。

抛个问题：相似图片是不是也应该丢弃，相识图片又要怎么判断呢？</div>2018-12-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/47/e7/f5128436.jpg" width="30px"><span>Androider</span> 👍（5） 💬（3）<div>项目里先后换过几次实现长连接的方式，包括Netty，现在使用MQTT实现长连接功能，我们知道MQTT 用于物联网的居多，我们使用后导致OOM的概率一下上去了，您对这个有什么看法呢？或者有什么实现稳定的长连接的方式，我们主要做拍卖项目，对价格的实时更新要求比较高。谢谢了。</div>2018-12-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/2f/c2/09c939ad.jpg" width="30px"><span>Origin</span> 👍（4） 💬（2）<div>从上一节课就一直在讲第三方或者一些自动化监控的工具，就像昵称是“灰”的听众说的一样，“内存优化的主题是监控”吗？没有讲到根本的东西啊，就算是Android开发的高手课，内容的思路和逻辑上也要建立在最基础的东西上吧？没有一个从基础上升到高层次的一个过程，相信会有越来越多的听众难以接受了。</div>2018-12-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/5b/30/83104f0f.jpg" width="30px"><span>薯条</span> 👍（3） 💬（2）<div>大佬，询问一个问题，我发现在8.0 android手机上，不同界面重复使用一个图片，通过api  setImageResource 设置。其实内存大小并没有变化，android系统内部已经帮我们去重了。多个界面，多次setImageResource 相同的图片引用。都是复用一个图片的。所以不理解你说的 “图片去重复”的优化。能否告知下
</div>2019-09-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/1f/2d/dd60f2ac.jpg" width="30px"><span>Keep up</span> 👍（3） 💬（3）<div>大佬，想问下文中提到的“大图片监控”在线上环境如何部署思路，是用插桩方式在 比如 setBitmap 方法后拿到bitmap和view的宽高做比较，还是定时地去获取内存快照中view和bitmap的宽高作比较，还是其他方式？不胜感激~</div>2019-08-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/5f/db/bd0f7d6b.jpg" width="30px"><span>cupcake</span> 👍（3） 💬（3）<div>oom其中一种原因是超过线程数量超过上限，排查起来有难度
</div>2019-02-20</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqAaSVtAbvqOaEkusotvCuAle7b0oicEmlqDY2jJ4fkFVibs892rDhvaYERAF4UCcZpGAvUTouZPY7w/132" width="30px"><span>条野太郎</span> 👍（2） 💬（4）<div>问个很菜的问题，监控到重复图片之后要怎么去重？</div>2019-08-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/46/43/7545067a.jpg" width="30px"><span>秋水无痕</span> 👍（2） 💬（1）<div>请问monkey跑出来的低概率oom怎么分析定位？</div>2019-04-07</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLqcnUABw0V5FGBRsH6XG5iah18NEe3u7qF2bQjOyhuHnomiajKLicAER9lbgu5cAib6WjsVuPgLNZm1Q/132" width="30px"><span>Geek_a1e8a8</span> 👍（2） 💬（3）<div>probe在分析时候 会自己catch分析时候的任何异常，不会造成二次崩溃的。</div>2019-03-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/7b/cf/81877641.jpg" width="30px"><span>司冬</span> 👍（2） 💬（1）<div>您好，我想问一个实际的问题，比如我的一个应用里面有一个对象泄漏了，但这个对象的大小很小，比如只有十几K，那么我们怎么找出这个对象呢？</div>2018-12-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/4d/48/885cf96f.jpg" width="30px"><span>💰</span> 👍（2） 💬（1）<div>8.0 及以上手机的 bitmap 即便用 as 的profile dump 下来也看不到图片文件 buffer (想可视化分析查看)，这一块大佬有什么好的方案或者建议吗。</div>2018-12-13</li><br/><li><img src="" width="30px"><span>alford</span> 👍（1） 💬（3）<div>张老师，想向你咨询一个问题。现在rxjava等框架大行其道，但是在用的过程经常出现底层线程池有太多线程消耗，导致oom。或因为锁问题，或因为其他问题，线程无法释放。由于这些线程堆栈太深了，没有办法确定具体是那个业务代码开出来的。在这个方面有没有比较好的定位手段。因为看了手q通过trace日志定位问题的文章，感觉还是没有版本具体定位到问题。</div>2019-12-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/45/8d/c13e5049.jpg" width="30px"><span>张可</span> 👍（1） 💬（1）<div>我通过 javaUsed &#47; javaMax 获取到的值大概是 2%-4% 左右，距离 80% 还很远啊，是不是计算方式错了？</div>2019-03-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/19/a6/4529cdfa.jpg" width="30px"><span>功夫熊猫</span> 👍（1） 💬（1）<div>作者提了一句虚拟内存泄露，我最近遇到了这个，但是网上资料比较少，不知该如何下手</div>2019-01-22</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI3jSpV7VvK6NaUH6X1LNYWGsQdFSTu4SwTZ0nQlSYGTOY2FrDCcMic9qFXnu2ZGR88hBlUQK28Whg/132" width="30px"><span>古月弓虽1993</span> 👍（1） 💬（1）<div>使用haha获取堆的时候，除了 app heap ,为什么还要取default heap 呢？</div>2019-01-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/6a/9c/5cd7f4c2.jpg" width="30px"><span>光汉良</span> 👍（1） 💬（1）<div>发现没法跟帖，只能这样回复了。请问裁剪是通过什么样的原理？我尝试直接从生成文件的时候着手，但是并没有找到对应的api，只能现在只能通过生成文件的之后进行裁剪，但是裁剪我不知道应该裁剪什么，虽然我知道很多byte是无用的，但是还是觉得无从下手</div>2018-12-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/48/fa/ce66bff5.jpg" width="30px"><span>彪</span> 👍（1） 💬（1）<div>每天早起先刷新下看有没有更新，更新了就赶紧学习下。</div>2018-12-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/1d/64/52a5863b.jpg" width="30px"><span>大土豆</span> 👍（0） 💬（1）<div>关于Matrix，我想咨询下哈，线上使用Matrix，我们需要在App中拿到卡顿数据之后上报到自己的平台，这样对小型创业团队而言，是否压力太大了</div>2019-05-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/2a/2a/b9b09c0f.jpg" width="30px"><span>richsjeson</span> 👍（0） 💬（1）<div>Debug.getRuntimeStat这个是要打印出来还是，然后这句话要放在什么地方</div>2019-03-12</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJOCFdmKAGVRvObVfaOLh08tf1vSk9iaHLPD7HlKIJdD09muB16jsPDKpLtTonRPwgYVawqBNcicExQ/132" width="30px"><span>鱼儿</span> 👍（0） 💬（1）<div>对于webview的内存释放，有没有好的建议；不是是起新进程，杀新进程；</div>2019-03-11</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eopQic30JDlkwNAAdPHYxF3HMico8zDtMsGnI7KkbM4oV7ib1Pt4ZJYSiaDEiaLGkzp4JgoHBb4s8GIZjw/132" width="30px"><span>Matthew</span> 👍（0） 💬（1）<div>课后作业的原理是什么呢，没怎么看懂。下载了工程，打开之后，只有一个空壳？
1. 如何判断两张图片完全相等，原理是什么。
2. 这个作业在实际项目中的意义是什么，比如不同UI上展现的就是同一张图片作为背景，这种情况貌似也没办法，在运行期，删除掉其中一张图片吧。</div>2019-01-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/f0/d4/14fcb621.jpg" width="30px"><span>stone</span> 👍（0） 💬（1）<div>在文章中很多地方都说到监控平台的重要性，但是面对一般公司，是没有那个资源和能力去给app搭建一个app的监控平台的，何况这个还需要兼顾ios平台，我想作者能否介绍一下关于这个种平台的现状和如果要搭建一个监控平台有没有成熟的方案呢，  谢谢</div>2018-12-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/aa/87/7f44ec43.jpg" width="30px"><span>许圣明</span> 👍（0） 💬（1）<div>你好，课后作业我用 HAHA 来调试了下，发现有的 hprof 文件解析后 ClassInstance 没有 mBuffer field，请问这种情况如何分析呢？</div>2018-12-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/02/c3/e9026d82.jpg" width="30px"><span>张亮</span> 👍（0） 💬（1）<div>张大婶，如果能做到向您一样自研hprof分析工具，需要准备哪些知识呢？深入理解计算机系统这本书是不是要看懂呢</div>2018-12-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/07/8c/0d886dcc.jpg" width="30px"><span>蚂蚁内推+v</span> 👍（0） 💬（2）<div>张老师您好 安装包大小和内存占用大小的那张表格没太理解好，方便绍文老师解释下吗？</div>2018-12-10</li><br/>
</ul>