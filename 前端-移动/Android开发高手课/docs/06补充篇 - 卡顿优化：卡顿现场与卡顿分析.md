我们使用上一期所讲的插桩或者Profilo的方案，可以得到卡顿过程所有运行函数的耗时。在大部分情况下，这几种方案的确非常好用，可以让我们更加明确真正的卡顿点在哪里。

但是，你肯定还遇到过很多莫名其妙的卡顿，比如读取1KB的文件、读取很小的asset资源或者只是简单的创建一个目录。

为什么看起来这么简单的操作也会耗费那么长的时间呢？那我们如何通过收集更加丰富的卡顿现场信息，进一步定位并排查问题呢？

## 卡顿现场

我先来举一个线上曾经发现的卡顿例子，下面是它的具体耗时信息。

![](https://static001.geekbang.org/resource/image/23/46/2398281c40faaa3620f48e1d23da9046.png?wh=1292%2A866)

从图上看，Activity的onCreate函数耗时达到3秒，而其中Lottie动画中[openNonAsset](http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/res/AssetManager.java#852)函数耗时竟然将近2秒。尽管是读取一个30KB的资源文件，但是它的耗时真的会有那么长吗？

今天我们就一起来分析这个问题吧。

**1. Java实现**

进一步分析openNonAsset相关源码的时候发现，AssetManager内部有大量的synchronized锁。首先我怀疑还是锁的问题，接下来需要把卡顿时各个线程的状态以及堆栈收集起来做进一步分析。

**步骤一：获得Java线程状态**

通过Thread的getState方法可以获取线程状态，当时主线程果然是BLOCKED状态。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/14/50/fe/33cc0374.jpg" width="30px"><span>郭威</span> 👍（13） 💬（1）<div>问一下作者那个fork获取线程堆栈的方式说的太笼统了，有小demo么</div>2018-12-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ac/02/3b8eedd6.jpg" width="30px"><span>Sean</span> 👍（8） 💬（1）<div>文中说明的 &quot; 需要注意的是在 Android 7.0 之后，getAllStackTraces 是不会返回主线程的堆栈的&quot;，我在8.0和8.1的系统下Java 层通过代码测试过，发现主线程的stacktrace实际上是可以得到的。不知所述结论是如何得到的？</div>2018-12-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/d6/d3/f9d22243.jpg" width="30px"><span>1874</span> 👍（3） 💬（1）<div>老师好，通过breakpad方案获取native堆栈时能关联上java层的堆栈吗？thread id是对应不上的。根据threadname？c层子线程要是没命名应该会有很多重复吧，期待老师解答</div>2019-05-16</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erxia5dpTeXMHR1e4ibicyRkS6fAuxarFicFZ3kwlrosFszjazFDJaRrrAiaH9hX0ia45xTKE6GetKIrgqg/132" width="30px"><span>X</span> 👍（2） 💬（1）<div>老师好，工作中的确遇到过类似开篇描述的卡顿现场，只不过当时是操作一个三方数据库，主线程里初始化了数据库有关的实体对象，然后又进行了数据库异步查找，结果ANR. 查看源码发现，两个操作都用的该数据库核心类的类锁，导致主线程一直等待子线程是释放锁。这个不是线上的，是线下的，所以查找很快，解决方式是把把异步查找用handler  post了一个runnable去操作，确保主线程初始化该数据库的操作在这个异步查找之前，即先得到锁。
所以这里顺便问下：
1.上述线程抢占导致的ANR处理方法是否妥当？
2. 文中说到SIGQUIT性能差，那个不是模仿系统ANR机制么 ，而那个黑科技黑科技也是模仿ANR日志打印，为何就比前者好呢？
3.另外想问下那个文中提到的抽样是客户端控制还是服务端控制的啊？</div>2018-12-18</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/0lTtM624ia8QlghIm9yfGLvjFltC03TgWlfuNC8vLibnuD8sosTcb3ynR5F2gANq1fwMPh4EiakbRVT8I59YKYjCg/132" width="30px"><span>Geek_2d38e3</span> 👍（1） 💬（2）<div>张老师，请教一下，黑科技手机线程堆栈那个方案，我成功调用了DumpState函数，但是函数执行完毕后，传入的std::ostream里面没有内容，您有遇到过这种情况吗？</div>2019-07-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6d/2f/ed8db646.jpg" width="30px"><span>Fred</span> 👍（1） 💬（1）<div>老师好，在应用开发时发现同一个方法，拥有相同的输入参数，在不同的Activity里面执行的耗时会不一样。对于这个问题应该从那些角度去分析呢？</div>2018-12-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/d6/d3/f9d22243.jpg" width="30px"><span>1874</span> 👍（0） 💬（1）<div>老师好，在native层hook子进程获取java堆栈的Demo能放出来吗？期待</div>2019-03-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/35/87/b2a1e5cc.jpg" width="30px"><span>catkin</span> 👍（0） 💬（1）<div>张老师，文中说的fork进程收集，但是在高版本中好像fork出来的进程不能执行啊！</div>2019-02-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/b0/3a/544179bf.jpg" width="30px"><span>sjx</span> 👍（0） 💬（1）<div>项目中使用的lottie，CPU占用非常高，大家有什么解决方案吗？</div>2019-01-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/5b/d2/34a8c79c.jpg" width="30px"><span>Juinn</span> 👍（0） 💬（1）<div>shaowen老师，课后作业中，hook线程的创建，为什么只有在sample进程有效，so库不是共享的吗</div>2019-01-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/5b/d2/34a8c79c.jpg" width="30px"><span>Juinn</span> 👍（0） 💬（1）<div>shaowen老师，此章节的例子是基于有卡顿树情况下，再去分析，那么这个卡顿树怎么获取？</div>2019-01-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/5d/5b/9b1dc56d.jpg" width="30px"><span>null</span> 👍（0） 💬（1）<div>老师，我主线程调用 synchronized时，显示的是Monitor状态，查过之后，&quot;Monitor&quot; is the BLOCKED state，只是名字不同，实际是一种状态是吗？</div>2018-12-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/07/8c/0d886dcc.jpg" width="30px"><span>蚂蚁内推+v</span> 👍（0） 💬（1）<div>张老师 waiting 和 timewaiting 区别是什么呢</div>2018-12-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/d6/7d/4b09b0bf.jpg" width="30px"><span>李鑫鑫</span> 👍（8） 💬（0）<div>感觉我在浪费生命！每天写view！原来安卓还有这么好玩的东西！</div>2018-12-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/07/8c/0d886dcc.jpg" width="30px"><span>蚂蚁内推+v</span> 👍（3） 💬（0）<div>绍文老师 ，android 系统里面没有 jstack 要如何dump 出 thread 信息呢？麻烦老师指导下~</div>2018-12-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/d1/d1/62f74aa7.jpg" width="30px"><span>自在飞</span> 👍（0） 💬（0）<div>老师您好，请问【通过 Hook 方式】获取的ANR日志，是怎么读取的呢？高版本系统中不是已经没有权限读取 &#47;data&#47;anr&#47;traces.txt 文件了么？</div>2022-10-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/c0/f0/1aabc056.jpg" width="30px"><span>Jiantao</span> 👍（0） 💬（0）<div>衡量页面流畅度：丢帧率、冻帧率

卡顿现场信息：卡断堆栈（摒弃具体耗时堆栈聚合成卡顿树）、CPU使用率及调度信息、内存信息、GC信息、IO和网络相关、当前页面信息、操作路径等</div>2022-10-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/58/6c/6fe7614b.jpg" width="30px"><span>lxw</span> 👍（0） 💬（0）<div>hook线程创建之后，怎么拿到hook的线程的信息呢</div>2021-02-22</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLIdTsqPhlVH3TFElzic8422uBDelRjYiaktCJRmIRpLrgBBfBKnSO9PlbHibnHAc9cQEmLHes3fayEw/132" width="30px"><span>张训博-forrest</span> 👍（0） 💬（0）<div>fork 进程按理说要权限 普通的方式感觉不行</div>2020-04-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/63/14/06eff9a4.jpg" width="30px"><span>Jerry银银</span> 👍（0） 💬（0）<div>“这里我非常推荐卡顿树的做法，对于超过 3 秒的卡顿，具体是 4 秒还是 10 秒，这涉及手机性能和当时的环境。我们决定抛弃具体的耗时，只按照相同堆栈出现的比例来聚合。这样我们从一棵树上面，就可以看到哪些堆栈出现的卡顿问题最多，它下面又存在的哪些分支。”

这里有两个疑问：
1. 这里的聚合是在客户端上进行的吗？
2. 根据什么来判断卡顿堆栈是相同的呢？不同系统、机型上，同一个卡顿问题的堆栈可能也不一样吧</div>2020-03-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/63/14/06eff9a4.jpg" width="30px"><span>Jerry银银</span> 👍（0） 💬（0）<div>“热锁”，是不是就是“活锁”</div>2020-03-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/63/14/06eff9a4.jpg" width="30px"><span>Jerry银银</span> 👍（0） 💬（0）<div>获取线程堆栈时，文中提到：“需要注意的是在 Android 7.0，getAllStackTraces 是不会返回主线程的堆栈的”，那在Android 7.0上，该如何做呢？</div>2020-02-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/dc/93/3521ff2b.jpg" width="30px"><span>Tony</span> 👍（0） 💬（0）<div>老师我想问下应用自己不适用JNI层代码去fork子进程，使用android上层框架，比如java或者Kotlin语言的api如何fork应用的子进程出来，网上也看了一些，都是通过JNI层c++代码去fork的</div>2019-11-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/5b/30/83104f0f.jpg" width="30px"><span>薯条</span> 👍（0） 💬（0）<div>学习了，坚持打卡，走完整个课程</div>2019-09-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/7b/f7/21fb7574.jpg" width="30px"><span>朱刚</span> 👍（0） 💬（0）<div>案例的最终解决方案呢</div>2019-09-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/58/eb/abb7bfe3.jpg" width="30px"><span>Geek_295233</span> 👍（0） 💬（0）<div>实践见真理，开阔了视野</div>2018-12-24</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoWicVeQYJ5B3hK2A51QO2hQUTpjkxhzYfjMD7ibk3YALgNypho185ZDrSItVNORQV2PU8qxD5IJONQ/132" width="30px"><span>Geek_sa3pm5</span> 👍（0） 💬（0）<div>老师，关于Android的内存管理与GC，有推荐的书籍或者博客吗？</div>2018-12-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/4f/1f/7dd61bfd.jpg" width="30px"><span>marshal</span> 👍（0） 💬（0）<div>现在学的还是糊涂的，先坚持打卡吧</div>2018-12-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/46/9d/79edce49.jpg" width="30px"><span>嘿，抬头</span> 👍（0） 💬（0）<div>虽然不理解的很多，还是坚持看，多看几遍多实践吧😂</div>2018-12-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/d4/8d/a3fd8957.jpg" width="30px"><span>Kenny</span> 👍（0） 💬（0）<div>张老师，线程的用户时间跟系统时间有什么关联？系统时间是不是一定小于用户时间？</div>2018-12-18</li><br/>
</ul>