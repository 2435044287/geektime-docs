你好，我是李兵

上节我们介绍了如何使用Performance，而且我们还提到了性能指标面板中的Main指标，它详细地记录了渲染主线程上的任务执行记录，通过分析Main指标，我们就能够定位到页面中所存在的性能问题，本节，我们就来介绍如何分析Main指标。

## 任务 vs 过程

不过在开始之前，我们要讲清楚两个概念，那就是Main指标中的任务和过程，在《[15 | 消息队列和事件循环：页面是怎么活起来的？](https://time.geekbang.org/column/article/132931)》和《[加餐二｜任务调度：有了setTimeOut，为什么还要使用rAF？](https://time.geekbang.org/column/article/169468)》这两节我们分析过，渲染进程中维护了消息队列，如果通过SetTimeout设置的回调函数，通过鼠标点击的消息事件，都会以任务的形式添加消息队列中，然后任务调度器会按照一定规则从消息队列中取出合适的任务，并让其在渲染主线程上执行。

而我们今天所分析的Main指标就记录渲染主线上所执行的全部**任务**，以及每个任务的详细执行**过程**。

你可以打开Chrome的开发者工具，选择Performance标签，然后录制加载阶段任务执行记录，然后关注Main指标，如下图所示：

![](https://static001.geekbang.org/resource/image/c3/cc/c3add6d821fd2a45a14bb2388c9c2dcc.png?wh=1996%2A214)

任务和过程

观察上图，图上方有很多一段一段灰色横条，**每个灰色横条就对应了一个任务，灰色长条的长度对应了任务的执行时长**。通常，渲染主线程上的任务都是比较复杂的，如果只单纯记录任务执行的时长，那么依然很难定位问题，因此，还需要将任务执行过程中的一些关键的细节记录下来，这些细节就是任务的**过程**，灰线下面的横条就是一个个过程，同样这些横条的长度就代表这些过程执行的时长。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/19/5a/c5/221ab4d9.jpg" width="30px"><span>wubinsheng</span> 👍（20） 💬（1）<div>老师的绘图能力，也很牛叉！</div>2019-12-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/4d/d8/30355c61.jpg" width="30px"><span>程序员劝退师</span> 👍（13） 💬（1）<div>二刷老师专栏，内容通俗易懂，实实在在。</div>2019-12-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/32/49/a97fc6df.jpg" width="30px"><span>Mr. Cheng</span> 👍（1） 💬（1）<div>解析HTML阶段的那幅图把Evalute Script 写成Receive data 了</div>2019-12-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/08/6c/789b8583.jpg" width="30px"><span>水鱼兄</span> 👍（25） 💬（0）<div>实在写得太好了， 读到好的教程总是让人心情愉悦</div>2020-08-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/21/17/0a681bd6.jpg" width="30px"><span>丁丁</span> 👍（16） 💬（0）<div>买了后陆续几个月终于看完了，这绝对是国内讲浏览器最系统的文章！</div>2021-01-29</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/yyibGRYCArsUNBfCAEAibua09Yb9D5AdO8TkCmXymhAepibqmlz0hzg06ggBLxyvXicnjqFVGr7zYF0rQoZ0aXCBAg/132" width="30px"><span>james</span> 👍（11） 💬（2）<div>首先，第一段代码只有一个Script标签，第二段代码中有两段Script标签，解析到Script标签。就会开启两个Evaluate Script子任务到同一个Task中执行
然后，第一段代码的script编译+执行总时间为1.2ms，而第二段代码的script编译+执行总时间为2.7ms，是第一段代码的一倍多时间，因此最好不要写太多script标签来执行js脚本，能写一个就写一个
还有，我加入了同步代码，可以看出微任务是在当前宏任务下的所有同步代码执行完成后执行的，如果当前微任务中又注册了新的微任务，则会追加到当前微任务队列尾部，等当前微任务执行完毕后执行。并且如果这当中涉及到了定时器等任务，则会将这个任务放到下一个宏任务的开始再执行。然后执行计算样式和布局，最后就执行绘制的Task，也就是分层 -&gt; 绘制 -&gt; 合成流程</div>2020-06-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/a4/1c/016478f7.jpg" width="30px"><span>陈布斯</span> 👍（4） 💬（1）<div>老师好，在第22章：“ 网络进程加载了多少数据，HTML 解析器便解析多少数据。 ” ，但是这里“ 等到所有的数据都接收完成之后……，导航阶段结束之后，就进入到了解析 HTML 数据阶段了  ”，一个是边接收边解析，一个是接收完再解析，有些疑惑，是不是我哪里理解的有偏差，谢谢老师帮忙解答</div>2021-10-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/85/f9/db651fa6.jpg" width="30px"><span>早道</span> 👍（4） 💬（0）<div>生成位图阶段在渲染流水线章节说的是在合成线程做的，这个章节又说是主线程做的，自相矛盾了</div>2020-04-24</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLM1WqQTliaQvXdt2whclPrbkHzZMxz5XjFjYnwV9h2MEjMDQKH6oJTtYKCoNZxficHxcGicJfMBicic9A/132" width="30px"><span>倪大又</span> 👍（4） 💬（0）<div>老师，我记得你在之前的文章中说的是GPU生成的图片是传回到合成线程，让合成线程做所有图片的合成的，这里怎么又变成到浏览器进程中去合成了？</div>2020-01-07</li><br/><li><img src="" width="30px"><span>Geek_2a1e86</span> 👍（3） 💬（0）<div>这篇内容讲的不错，把前面的很多知识都串起来了。
图文并茂，且结合实际代码案例，这样的教学是最理想的👍🏻</div>2021-06-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/32/49/a97fc6df.jpg" width="30px"><span>Mr. Cheng</span> 👍（3） 💬（1）<div>哈哈😄，铁粉在此</div>2019-12-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/f7/e5/b290e605.jpg" width="30px"><span>AIGC Weekly 周报</span> 👍（2） 💬（0）<div>试着回答一下课后作业题，有错误恳请指出：
1. 第一段代码，只进行了一次微任务时间检查点，因为其是在一个宏任务下。
2. 第二段代码，进行了两次微任务时间检查点，因为代码分别在两个 &lt;script &#47;&gt; 标签里，所以是在两个宏任务下。</div>2021-04-24</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI8fXGIdwbvIuBics5dziaPt0DiaKHOmlw4jjhQ3ZQXiaCuTcLWbJLicBN9zcVYKkKeXACwod7z1fSAnpw/132" width="30px"><span>Geek_e69cdd</span> 👍（2） 💬（0）<div>老师，为什么计算样式在最后，style标签可是在script前面的，如果script里用到了样式怎么办?还有计算样式和解析html是并行的吗，但是只有一条主线程是怎么做到的</div>2020-03-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/b3/2f/867b94d8.jpg" width="30px"><span>4!!</span> 👍（2） 💬（2）<div>代码1:执行了一个微任务过程，在parseHTML快结束的时候；
代码2:执行了两个微任务过程，在parseHTML中间的时候；
我分析的原因是：Javascript执行过程中，将退出全局执行上下文时，会检查微任务列表，并执行微任务。每个script标签都表示一个Javascript执行过程，所以当解析完script标签的时候都会检查微任务列表并执行。
代码2中有两个script标签，所以会执行两个微任务过程。

老师，我有一点不明白：Evalute Scrip过程什么情况下会产生？
script标签肯定会产生，但是代码1和代码2的分析报告里Evalute Scrip过程都非常多，不明白怎么产生的？</div>2020-03-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/25/91/09/6f0b987a.jpg" width="30px"><span>陈坚泓</span> 👍（1） 💬（0）<div>看到一个错别字

走到了 Composite Layers 这步，主线程的任务就完成了，接下来主线程会将合成的任务完全教给合成线程来执行，下面是具体的过程    

完成教给 应该是 完成交给

老师的专栏 我可是一个字一个字认真的读了</div>2022-11-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/20/d4/9c/0f3849ed.jpg" width="30px"><span>小乖乖</span> 👍（1） 💬（1）<div>老师 task灰色进度条 中间间隔的那些空白是什么呢？</div>2021-03-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/84/ee/3a364ccd.jpg" width="30px"><span>滇西之王</span> 👍（1） 💬（0）<div>老师，求教一下：
performance面板里network的时间为什么比Main里的时间提前，network里显示一个资源下载好了，main里还没send request。</div>2020-09-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/9f/6f/aee1732a.jpg" width="30px"><span>locke.wei</span> 👍（1） 💬（0）<div>老师的加餐十分用心，👍</div>2020-06-04</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKf9xWMCV4ic5dsKyroQpGkYGZ32IPicVPVsF1TPENeTcspd6HhhaciaHCCmzeicaiaItZS3DahASFovJQ/132" width="30px"><span>bai</span> 👍（1） 💬（1）<div>在前文CSS如何影响首页加载时间中提到，js需要等待CSS OM生成后执行。本文中，reculate style在js执行之后执行。似乎不符合前文所说，还是我理解有误呢。</div>2019-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg" width="30px"><span>ifelse</span> 👍（0） 💬（0）<div>学习打卡</div>2024-05-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/55/28/66bf4bc4.jpg" width="30px"><span>荷兰小猪8813</span> 👍（0） 💬（0）<div>浏览器进程是哪个 指标，没看到。。</div>2023-04-10</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLjPKytMIH0SU3BAOZ6Ie8Sf4WwBFJ7hl7Zbwxp6ZdkHgovcyJYYCGaBibg0XI0ODTPkKNd9UIQrvQ/132" width="30px"><span>李勇强</span> 👍（0） 💬（0）<div>第一段代码，两个两个微任务连续执行。第二段代码，两个微任务分开执行，中间还执行力全局代码。原来，由于script将两段代码的编译执行过程分开了。</div>2022-12-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f6/07/5bc770d4.jpg" width="30px"><span>张辽</span> 👍（0） 💬（0）<div>这个main流程的展开，把全课程都串起来了，甚好。老师也可考虑在课程开始的时候，给粗略展示下，虽一下不能明白每个细节，但概略图就印在脑海里了，然后带着这张图和一堆概念慢慢拜读课程。非常赞的课程，尤其加餐六把前面课程评价里提出的问题详细讲解了，非常用心。</div>2022-10-30</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLzSRrK59sydknSSYZdeTww3Cgib9Gy9N4BJGgSXMYdmVIxJYwDXPsLCIE68AbwTkgUct8J4iboAqicA/132" width="30px"><span>罗武钢</span> 👍（0） 💬（0）<div>很棒的课程</div>2022-09-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/9d/54/d43922b6.jpg" width="30px"><span>正经工程师</span> 👍（0） 💬（1）<div>我看即可时间的performance的任务列表，导航流程和你描述的不同啊，怎么是先pagehide-&gt;visibilitychange-&gt;unload-&gt;send Request-&gt;receive Response</div>2021-12-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2b/57/6e/0010eec8.jpg" width="30px"><span>月光林地</span> 👍（0） 💬（0）<div>第一份代码都在一个宏任务内，两个then会在同一个微任务执行。第二份代码是两个宏任务，于是会宏-微 宏-微执行，即两个then被宏任务分开了。所以每次evaluate script就产生一个宏任务。

另外希望老师解答一下许多读者对前后知识点的不一致而产生的疑惑</div>2021-12-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/a4/1c/016478f7.jpg" width="30px"><span>陈布斯</span> 👍（0） 💬（0）<div>老师好，Composite Layers执行在主线程。“ 准备每层的绘制列表之后，就需要利用绘制列表来生成相应图层的位图 ”，合成位图这个操作不是应该在合成线程上执行，为啥会在main中体现，辛苦老师帮忙解答下，谢谢您。</div>2021-10-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/25/91/09/6f0b987a.jpg" width="30px"><span>陈坚泓</span> 👍（0） 💬（0）<div>真的很赞 感谢老师输出这么高质量的内容 </div>2021-09-28</li><br/><li><img src="" width="30px"><span>GK</span> 👍（0） 💬（0）<div>画图是用什么工具画的</div>2021-09-07</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/vkqibkINia6dxVOv5zia2zbkmQbrJUsQw8vDfiauib2DfyvJQ4PDUC7M8p4vqFiaQj70yYwIO8JlHFA450KPmgpsXlsw/132" width="30px"><span>Geek_bing</span> 👍（0） 💬（0）<div>我这边 performance怎么看不到cpu 和光栅化 这块的数据？是配置不对吗？</div>2021-08-19</li><br/>
</ul>