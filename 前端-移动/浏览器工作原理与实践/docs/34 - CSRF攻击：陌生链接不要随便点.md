在[上一篇文章](https://time.geekbang.org/column/article/152807)中我们讲到了XSS攻击，XSS 的攻击方式是黑客往用户的页面中注入恶意脚本，然后再通过恶意脚本将用户页面的数据上传到黑客的服务器上，最后黑客再利用这些数据进行一些恶意操作。XSS攻击能够带来很大的破坏性，不过另外一种类型的攻击也不容忽视，它就是我们今天要聊的CSRF攻击。

相信你经常能听到的一句话：“别点那个链接，小心有病毒！”点击一个链接怎么就能染上病毒了呢？

我们结合一个真实的关于CSRF攻击的典型案例来分析下，在2007年的某一天，David 无意间打开了Gmail邮箱中的一份邮件，并点击了该邮件中的一个链接。过了几天，David就发现他的域名被盗了。不过几经周折，David还是要回了他的域名，也弄清楚了他的域名之所以被盗，就是因为无意间点击的那个链接。

**那David的域名是怎么被盗的呢？**

我们结合下图来分析下David域名的被盗流程：

![](https://static001.geekbang.org/resource/image/3d/6b/3d7f097b1d6a8f93a960a12892f1556b.png?wh=1142%2A694)

David域名被盗流程

- 首先David发起登录Gmail邮箱请求，然后Gmail服务器返回一些登录状态给David的浏览器，这些信息包括了Cookie、Session等，这样在David的浏览器中，Gmail邮箱就处于登录状态了。
- 接着黑客通过各种手段引诱David去打开他的链接，比如hacker.com，然后在hacker.com页面中，黑客编写好了一个邮件过滤器，并通过Gmail提供的HTTP设置接口设置好了新的邮件过滤功能，该过滤器会将David所有的邮件都转发到黑客的邮箱中。
- 最后的事情就很简单了，因为有了David的邮件内容，所以黑客就可以去域名服务商那边重置David域名账户的密码，重置好密码之后，就可以将其转出到黑客的账户了。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/16/39/08/09055b47.jpg" width="30px"><span>淡</span> 👍（73） 💬（6）<div>“简言之，如果你从极客时间的页面中访问 InfoQ 的资源，而 InfoQ 的某些 Cookie 设置了 SameSite = Strict 的话，那么这些 Cookie 是不会被发送到 InfoQ 的服务器上的”，这里是不是我理解错了还是写错了。应该是不会发送到极客时间的服务器上，或者说极客时间的某些Cookie设置了SameSite = Strict吧。</div>2019-10-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f8/99/8e760987.jpg" width="30px"><span>許敲敲</span> 👍（19） 💬（2）<div>老师，这方面有比较好的资料或是书嘛？想多了解一下</div>2019-10-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/db/0b/f0ded153.jpg" width="30px"><span>江谢木</span> 👍（13） 💬（5）<div>CSRF TOKEN类似于cookie, 都是存储用户信息，而此用户信息只存储在当前你请求的站点，而不是浏览器，所以不同的标签页面，或不同次的请求是不共享此用户信息的，所以规避了cookie所带来的的漏洞，老师，我这样理解对？</div>2019-11-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/94/82/d0a417ba.jpg" width="30px"><span>蓝配鸡</span> 👍（13） 💬（5）<div>有个疑问：
same origin policy不是确保了不同域名时间不可以访问数据的吗？ 那第三方站点如何拿到cookie和session？

谢谢老师🙏</div>2019-10-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/2e/50/240e7beb.jpg" width="30px"><span>李小白</span> 👍（18） 💬（16）<div>老师，我想请问一下，在浏览器打开第三方站点是如何拿到极客时间站点cookie的？第三方站点和极客时间的站点不同，存在同源策略，所以转账请求验证cookie也是不通过的，那么CSRF是如何攻击的呢？</div>2019-10-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/23/6c/785d9cd3.jpg" width="30px"><span>Snooker</span> 👍（11） 💬（0）<div>1.CSRF是什么： 跨域请求伪造，通过第三方站点模拟用户请求行为
2.如何防范CSRF攻击：  本质就是识别客户端操作是否是用户本人操作
	1&gt;.业务上针对重要操作，需要再次验证，如短信验证码等，确保你是你
	2&gt;.公司内部做好文档管理：源码、接口文档等，减少信息泄露
	3&gt;.服务端针对cookie、session等敏感头信息设置samesite
	4&gt;.敏感接口数据采用加密传输、新增时效性或随机参数，增加请求信息不确定性，比如：CSRF Token参数</div>2020-06-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/eb/09/ba5f0135.jpg" width="30px"><span>Chao</span> 👍（10） 💬（0）<div>chrome 默认启用 SameSite 了</div>2019-10-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/7a/a3/91dd50e8.jpg" width="30px"><span>O</span> 👍（3） 💬（0）<div>终于搞懂csrf了（之前看掘金、看书没有示例），学习网络要结合事例，有了事例就能通俗易懂</div>2021-01-26</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJrZb9pm07aickG3dVFBd2yhk5J2clztUniaMNFsjpHu7uacfpGhleKYbgicEnwF5MusKNFKLTUUAYKg/132" width="30px"><span>lee</span> 👍（3） 💬（2）<div>在前后端分离的项目里面，是不是服务器端设置了access-control-allow-arigin只允许受信任的站点访问接口也可以防止CSRF攻击？</div>2019-11-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/ae/c1/76a9237f.jpg" width="30px"><span>昵称</span> 👍（2） 💬（0）<div>目前为止比较好的防止csrf策略
1：不用cookie,登录态改用token,这样就不会有csrf攻击;
2：重要接口加验证参数：如短信验证码、谷歌验证码验证。即使它发起请求了，没有用户本身的手机验证码、谷歌验证码也通过不了这次请求。</div>2020-07-26</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erXRaa98A3zjLDkOibUJV1254aQ4EYFTbSLJuEvD0nXicMNA8pLoxOfHf5kPTbGLXNicg8CPFH3Tn0mA/132" width="30px"><span>Geek_115bc8</span> 👍（1） 💬（0）<div>什么是 CSRF 攻击？
就是用户点击了黑客的连接，跳转到黑客的网站，然后该网站有第三方网站的连接，如果用户浏览器此时有该第三方网站的未过期的cookie，那么将被发送。用来做一些转账的危险操作。

在开发项目过程中应该如何防御 CSRF 攻击？
1. 通过设置cookie samesite: strict。阻止用户通过链接跳转来发送cookie。
2. 因为发送请求，都会携带origin, referer头字段来表示发送方的域名。服务器进行验证。
3. 通过颁发token，验证用户身份。</div>2022-05-02</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/AhKPj65f2kpGricgnMPsL5iaicCibTJoMD3mlgfxPHctOA7qwws3PoH40icKY1icxqWY1bU5dhc8n4IVGjkS0YaZoPHw/132" width="30px"><span>Geek_cd4e2d</span> 👍（1） 💬（0）<div>提示一下，攻击者内部页面通过img标签访问接口不存在同源策略</div>2022-01-28</li><br/><li><img src="" width="30px"><span>Xx</span> 👍（1） 💬（0）<div>最后总结里的这段
&quot;为了解决这些问题，我们引入了 CSP 来限制页面任意引入外部资源，引入了 HttpOnly 机制来禁止 XMLHttpRequest 或者 Fetch 发送一些关键 Cookie，引入了 SameSite 和 Origin 来防止 CSRF 攻击。&quot;
好像不太正确？ HttpOnly不是用来限制除Http之外的渠道来获取cookie吗？ SameSite属性才是用来限制Ajax请求对于cookie的权限的吧？</div>2021-03-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/1f/04/1cddf65b.jpg" width="30px"><span>不二</span> 👍（1） 💬（1）<div>希望老师帮忙解答一下，疑问点是，发起csrf攻击，为什么一定要用户跳转到第三方页面，再请求当前域名的请求，感觉直接结合XSS不更好？利用XSS在浏览器端注入恶意代码，当然恶意代码的内容就是直接发起请求，例如转账的例子，直接在恶意代码就是转账到指定用户，这样感觉也可以呀。</div>2020-12-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/04/8c/ce36a2d0.jpg" width="30px"><span>爱看书的蜗牛</span> 👍（1） 💬（3）<div>“如果是从第三方站点发出的请求，那么将无法获取到 CSRF Token 的值，所以即使发出了请求”要获得这个token应该很容易吧，抓包就行啊</div>2020-01-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/44/0e/ce14b7d3.jpg" width="30px"><span>-_-|||</span> 👍（1） 💬（0）<div>&quot;如果是从第三方站点发起的请求，那么需要浏览器禁止发送某些关键 Cookie 数据到服务器；&quot;,如果是第三方网站，还会有被攻击网站的cookie吗，域名不一样，应该没有吧。</div>2019-12-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/0c/89/d5077e61.jpg" width="30px"><span>可笑的霸王</span> 👍（1） 💬（0）<div>老师，关于Referrer服务器验证不太稳定可以详细解释下吗，因为我看到Referrer-Policy也可以设置为origin，达到Origin类似的效果</div>2019-10-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/55/28/66bf4bc4.jpg" width="30px"><span>荷兰小猪8813</span> 👍（0） 💬（0）<div>同源策略只是限制了 ajax 请求，像 a 标签或者 form 表单之类的是不会被限制的，所以可以在第三方站点发起跨站请求伪造</div>2023-04-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/55/28/66bf4bc4.jpg" width="30px"><span>荷兰小猪8813</span> 👍（0） 💬（0）<div>1. 第三方网站是如何拿到 cookie 的 2. 同源策略为什么不能阻止 CSRF。
同源策略并没有完全限制网站不能使用非同源的资源，比如引用第三方 script 文件，引用第三方 CSS 文件等，同样的，也没有限制一些跨域写操作，比如表单提交。因此，光靠同源策略不能阻止 CSRF。明白了可以在第三方站点成功发送跨域请求这一点之后，浏览器会自动带上请求的那个站点的 cookie。</div>2023-04-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/eb/af/e49af9a8.jpg" width="30px"><span>JC.彦</span> 👍（0） 💬（0）<div>实施CSRF攻击需要3个条件：
1. 目标站点存在CSRF漏洞
2. 用户登录过目标站点，且在浏览器有登录信息。
3. 需要用户打开第三方站点

这里的CSRF漏洞是什么漏洞？</div>2022-02-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/3c/a0/1d286e39.jpg" width="30px"><span>lynnli</span> 👍（0） 💬（0）<div>老师的课讲的真的很好，受益匪浅值得多看几遍，希望老师有时间可以出本浏览器渲染原理方面的书，市面上没有这类书，都是涉及一点点这方面的知识，现在还没有系统总结浏览器渲染原理的书本</div>2021-12-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2b/b0/51/26f7cb0b.jpg" width="30px"><span>了不起的小六先生🌊</span> 👍（0） 💬（0）<div>CSRF攻击叫做跨站请求伪造，是指用户在登录了一个安全网站后会存储用户登录态在cookie中，此时黑客诱导用户点击恶意链接（可能是点击事件、也可能是恶意网站）来做一些恶意操作</div>2021-12-13</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/LDN7icjqGqTWSmiay9mKj5pChr86V8xjljseJnwHL2lPreGtQy4v0wFBGHb1N1XbibLP1Qv3FRcOPNwVazaPQJCxQ/132" width="30px"><span>Geek_Ranfon</span> 👍（0） 💬（1）<div>老师我有个问题就是，这个第三方网站是写好的吗？那我怎么知道你要登录的站点是什么，这个伪造的接口怎么提前写好？</div>2021-11-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/8a/d6/00cf9218.jpg" width="30px"><span>撒哈拉</span> 👍（0） 💬（0）<div>csrf  通常翻译为跨站请求伪造，利用用户登录时，浏览器发送请求自动携带用户登录信息的特点，伪造虚假请求欺骗用户点击，获取用户登录信息，然后进行不法行为的攻击。</div>2021-11-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/f4/6b/b6f6810c.jpg" width="30px"><span>ss</span> 👍（0） 💬（0）<div>老师你好，我想请问下get  和 post方式的xsrf攻击是具体的发生场景有哪些呀？我能想到的好像都是点击一个链接</div>2021-10-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/f9/e7/99318dd9.jpg" width="30px"><span>c.h</span> 👍（0） 💬（1）<div>老师，我想请问一下，这句 “如果是从第三方站点发出的请求，那么将无法获取到 CSRF Token 的值“ 这种方式是一定安全的吗？第三方一定没有办法获取到CSRF Token 的值吗？</div>2020-05-15</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/xCAJCvA3iaMXgjibb0mh99qN9y2Kibc5y31DOaAM0RaEryHM50qJ8GOqXvPAtjILIArIysRQhEWPq9Bt1NgibZpBoA/132" width="30px"><span>汤显文</span> 👍（0） 💬（1）<div>csrf token 跟 jsonwebtoken 可以理解成是一个东西吗</div>2020-05-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/bc/d0/7a595383.jpg" width="30px"><span>l_j_dota_1111</span> 👍（0） 💬（1）<div>如果用户信息存储在localstorage中呢？是不是csrf就不起作用了</div>2020-04-29</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/OVq8d3D1m1SkoOUL6iaerJjDfVlibDDfutGBJ3ceu2vpskOXb6ib6vS7iaLAQSUK7U5kv2xrHcdqFXR6ROo5QeAhow/132" width="30px"><span>Oliveryoung</span> 👍（0） 💬（1）<div>csrf token是浏览器端js生成？那岂不是可以获取到生成方法</div>2020-03-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/ea/7a/d857723d.jpg" width="30px"><span>Vfeelit</span> 👍（0） 💬（1）<div>第一 从cookie上下功夫 设置严格模式 但是兼容性不好  第二 返回一个token 服务端验证  第三 不使用cookie   现代的前端应用 登录后把token保存到local中 调用api时动态附加   所以还是不使用cookie才是好方法 </div>2020-03-07</li><br/>
</ul>