在[上一篇文章](https://time.geekbang.org/column/article/113550)中我介绍了TCP协议是如何保证数据完整传输的，相信你还记得，一个TCP连接过程包括了建立连接、传输数据和断开连接三个阶段。

而HTTP协议，正是建立在TCP连接基础之上的。**HTTP是一种允许浏览器向服务器获取资源的协议，是Web的基础**，通常由浏览器发起请求，用来获取不同类型的文件，例如HTML文件、CSS文件、JavaScript文件、图片、视频等。此外，**HTTP也是浏览器使用最广的协议**，所以要想学好浏览器，就要先深入了解HTTP。

不知道你是否有过下面这些疑问：

1. 为什么通常在第一次访问一个站点时，打开速度很慢，当再次访问这个站点时，速度就很快了？
2. 当登录过一个网站之后，下次再访问该站点，就已经处于登录状态了，这是怎么做到的呢？

这一切的秘密都隐藏在HTTP的请求过程中。所以，在今天这篇文章中，我将通过分析一个HTTP请求过程中每一步的状态来带你了解完整的HTTP请求过程，希望你看完这篇文章后，能够对HTTP协议有个全新的认识。

## 浏览器端发起HTTP请求流程

如果你在浏览器地址栏里键入极客时间网站的地址：[http://time.geekbang.org/index.html，](http://time.geekbang.org/index.html%EF%BC%8C) 那么接下来，浏览器会完成哪些动作呢？下面我们就一步一步详细“追踪”下。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/14/f5/b8/9f165f4b.jpg" width="30px"><span>mfist</span> 👍（138） 💬（9）<div>1 首先猜测最可能的出问题的地方，网络传输丢包比较严重，需要不断重传。然后通过ping curl看看对应的时延高不高。
2 然后通过wireshake看看具体哪里出了问题。
3 假如别人访问很快，自己电脑很慢，就要看看自己客户端是否有问题了。

感觉平常碰到很多http问题，基本都能通过上面方式搞定</div>2019-08-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（81） 💬（28）<div>对于浏览器缓存地方的选择一直搞不明白其中的原理，在浏览器中访问的时候打开network面板，发现缓存的来源有的from disk有的是from memory。对于资源什么情况下缓存到硬盘什么时候缓存到内存，想请教一下老师</div>2019-08-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/5f/80/51269d88.jpg" width="30px"><span>Hurry</span> 👍（56） 💬（5）<div>使用 chrome network 面板，看那个 瀑布图 中每个阶段的含义，就可以判断问题出现在那个方向了，每个阶段的含义，https:&#47;&#47;developers.google.com&#47;web&#47;tools&#47;chrome-devtools&#47;network&#47;reference#timing-explanation  举个例子 Content Download 如果太长，很有可能是下载的资源太大，但也有可能是网络慢导致的下载太慢，简单计算一下，在例如 Waiting (TTFB) 这个太长的话，有可能是网络慢，或者就是 后端处理时间过长导致的，至少可以排查掉前端原因，还有很多，例如 DNS lookup 等，但是最终要确认具体哪里慢，最好是结合系统日志去分析</div>2019-08-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/5f/02/f8a80843.jpg" width="30px"><span>XWL</span> 👍（47） 💬（5）<div>浏览器刷新操作，ctrl+F5和F5有什么区别</div>2019-08-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/3c/e3/aee9692f.jpg" width="30px"><span>CMS</span> 👍（42） 💬（10）<div>Chrome 有个机制，同一个域名同时最多只能建立 6 个 TCP 连接，如果在同一个域名下同时有 10 个请求发生，那么其中 4 个请求会进入排队等待状态，直至进行中的请求完成。 是指同一个域名下的6个并发请求么。我理解建立一个tcp连接，可以处理多个请求吧？
这一块蒙了，看好多人问这个</div>2019-11-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/07/8c/0d886dcc.jpg" width="30px"><span>蚂蚁内推+v</span> 👍（42） 💬（3）<div>set cookie 会不会有安全问题，麻烦老师指导下</div>2019-08-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/fc/f0/c72e1be3.jpg" width="30px"><span>月隐千山</span> 👍（37） 💬（10）<div>老师，在做前端页面的时候，是否可以设置当前页面是否可以被缓存，以及哪些部分可以被缓存？还是说整个缓存机制都是由浏览器自己控制的？</div>2019-08-10</li><br/><li><img src="" width="30px"><span>Geek_0d3179</span> 👍（31） 💬（2）<div>老师您好~有个问题困扰我了。希望您能解答我，十分感谢。http2同个域名只能维持一个长连接。那我现在打开了一个域名下的a页面，然后又打开了这个域名的b页面，那这个b页面是新开一个tcp长连接吗？还是会用a页面的长连接？换句话说，维持一个tcp长连接，指的是一个页面维持一个？还是整个浏览器维持一个？还是同一个渲染进程维持一个？</div>2019-11-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/29/8f/a07b72bc.jpg" width="30px"><span>liu_xm</span> 👍（25） 💬（12）<div>同域名只能建立6个tcp链接的话，那加载大量图片或者其他资源的时候不是很卡呢？</div>2019-08-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg" width="30px"><span>peter</span> 👍（17） 💬（17）<div>请问：请求行和请求头是发送两次吗？ 从文章的文字来看，是发送两次。 但我感觉是发送一次，即发送一次请求，该请求包含请求行和请求头。</div>2019-08-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/0f/5b/dc7589e0.jpg" width="30px"><span>houqx</span> 👍（16） 💬（8）<div>问一个今天遇到的跟本篇文章没有太大关系的问题：
问题描述：前端有一按钮，点击可以签到(比如调用的接口名为doSign)，签到成功后置灰，不能再点击。但是看服务端日志存在同一时间同一用户该接口的多次调用(通常为3次，间隔10ms以内)。
我想问的问题是：
1：这里的重复调用是哪里引入的(用户手抖多次点击？)
2：浏览器在发出一个网络请求后，当这个请求还没返回的时候，会再重复发起相同的请求吗？(用户快速点击)</div>2019-08-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/45/41/27d3fcf9.jpg" width="30px"><span>nissan</span> 👍（16） 💬（1）<div>请问老师，使用者的资讯（如UID=3431uad）是放在cookie还是localstorage中好呢？我的理解是存不存cookie是后端决定（要求set-cookie)存localstorage是前端程式控制的。是这样吗？</div>2019-08-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/bf/b0/6730d757.jpg" width="30px"><span>aaron</span> 👍（13） 💬（3）<div>老师，请问https为什么能防止网络劫持？</div>2019-08-10</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEJVZm0599IUeUuP8ckmomF69soIACbH8nJ62LAbgX1V2cxJC6ZGjqicNDeqppNpxm0mykbjALUVxCVaaEXZy7SaQoVWNfxicJER7rJbHbiaIuDmQ/132" width="30px"><span>Louis</span> 👍（12） 💬（1）<div>请问老师http的keep alive和http2中的信道服用有什么区别呢</div>2019-08-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/27/73/b79761ec.jpg" width="30px"><span>stanlee</span> 👍（8） 💬（3）<div>老师，同一个域名同时最多只能建立 6 个 TCP 连接  是不是意思是统一域名同时只能发送6个AJAX请求吗， TCP连接和AJAX请求有什么关系吗</div>2019-10-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/46/e5/bd8a8447.jpg" width="30px"><span>张舵主</span> 👍（7） 💬（1）<div>
老师您好，我有2个问题：1，浏览器缓存DNS的解析结果，这个缓存是缓存到浏览器进程中吗？是不是浏览器关闭后浏览器的这个DNS的缓存也一起清除了？2，浏览器打开某个站点页面后，这个页面里面还有很多的域名需要解析例如一些图片的链接，这些解析结果都会缓存吗？</div>2019-08-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f4/4f/6be9c5d7.jpg" width="30px"><span>°半月含雪雨</span> 👍（5） 💬（4）<div>原本以为TCP&#47;IP的五层结构的每一层都是独立完成之后然后再交给下一层去处理。看到老师写的请求流程之后恍然大悟，这方面的知识终于串到了一起。网络加载时间过久有可能是dns缓存，页面缓存都没有；寻找到目标服务器经历的节点比较多（可以用cdn），目标文件比较大（可以拆包），客户端性能不够等原因。</div>2019-08-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/8d/8c/ec40964b.jpg" width="30px"><span>sunshineling</span> 👍（5） 💬（5）<div>老师，你说chrome一次最多只能建立6个tcp连接，有点不理解，这是说只能支持6个用户并发吗？
</div>2019-08-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/f3/0d/7fb84744.jpg" width="30px"><span>王天真</span> 👍（3） 💬（1）<div>写的是真的好！ 帮助又梳理了一遍。非常喜欢 非常感谢！

--来自一枚前端程序媛</div>2019-08-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/56/c6/0b449bc6.jpg" width="30px"><span>斐波那契</span> 👍（3） 💬（1）<div>老师这个浏览器本地缓存是跟浏览器设置有关么 是不是我设置一下可能就不会本地缓存 还是说这个缓存可以由服务器的响应来控制？</div>2019-08-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/17/ba/c56aa720.jpg" width="30px"><span>new life</span> 👍（2） 💬（1）<div>老师 帮忙解答个问题 http:127.0.0.1:8080 这个端口号既是Tomcat 应用端口号 也是 tcp连接用的 端口号吗 </div>2019-08-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/b7/6d/2bb17b02.jpg" width="30px"><span>℉aith♭ook</span> 👍（2） 💬（2）<div>浏览器又是怎么对待跨域请求的呢？发送真请求之前不是还有个预请求，老师可否择机插入讲解，跨域对前端的问题对于前端来说还是常见的问题</div>2019-08-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/34/01/30ca98e6.jpg" width="30px"><span>arronK</span> 👍（1） 💬（1）<div>发送http请求的时候，请求行、请求头、请求体 是三个部分分别发送的，那根据tcp传输协议，这三部分，任何一个部分也都是被当做数据包来发送，如果过大就拆分为多个小的数据包（比如上传文件的请求体）。那么每个数据包也是需要服务器返回一个“确认收到”的数据包的吧？</div>2019-11-05</li><br/><li><img src="" width="30px"><span>xjnotxj</span> 👍（1） 💬（1）<div>请问老师，构建请求，查找缓存，准备ip是不是可以归类为DNS解析之中？</div>2019-09-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/1c/50/217d8bb4.jpg" width="30px"><span>飏</span> 👍（1） 💬（1）<div>李哥，拿到 IP 之后，接下来就需要获取端口号，获取端口这个怎么实现的呀？
</div>2019-09-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/05/5b/ed7c4b97.jpg" width="30px"><span>蔡金标</span> 👍（1） 💬（1）<div>您好老师，还有个疑问，就是当TCP建立连接三次握手时，这个每次握手和握手成功发送的http请求，都会经过网络层数据链路层物理层，再经过接收方的物理层数据链路层网络层，再到对方的运输层tcp接受到对应发出的状态的吗？</div>2019-09-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/c5/5d/9e75eb36.jpg" width="30px"><span>Bean</span> 👍（1） 💬（1）<div>老师 等待 TCP 队列  这个地方 ，怎样能看到TCP 在等待状态  （抓包工具中能看到吗）</div>2019-08-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d9/c6/8be8664d.jpg" width="30px"><span>ytd</span> 👍（1） 💬（1）<div>平时做的项目大部分都是基于java的web项目，前后端不分离的那种，在调试时打开chrome的调试工具，修改前端静态文件后我总是习惯性的“清空缓存并硬性加载”，有时就会遇到页面刷新出来的时间久的情况，但没太关注过为什么会加载这么慢。下面我尝试简单分析下卡在哪个阶段，希望老师能够指点下。开发时应用是部署在本地的，那么慢的原因就不会是网络原因，这种项目的特点就是用jsp来渲染页面，然后集成了各种前端的js库，导致如果不利用缓存的话，页面建立的tcp连接很多，需要下载的资源也多，就会导致页面加载起来比较慢，我检查了下响应头，发现没有用到connection: keep-alive这个头，那么连接也就不能复用，那么卡就主要卡在建立tcp连接、等待tcp队列上面。另外，偶尔会遇到加载很久的情况，这种情况好像是后端的服务响应过慢，这时检查浏览器的timing，就会发现TTFB很长，不过这种只是出现在：第一次启动应用或者启动后调试时偶尔会出现（感觉这种情况主要可能是在java web项目debug模式下后端需要做初始化处理之类的事情，只是猜测）。第一次应用启动时加载登录页面，后端做了跳转处理，返回302这个耗时就很长，建立连接其实时间花的不长，主要是后端迟迟不给响应（估计又是后端初始化导致的），再次加载登录页面就会好些，不会再出现302了。</div>2019-08-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/7b/f0/ccc11dec.jpg" width="30px"><span>Cris</span> 👍（0） 💬（1）<div>那就是先构建请求行，再建立tcp连接，然后再发送请求行？</div>2019-09-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/7b/f0/ccc11dec.jpg" width="30px"><span>Cris</span> 👍（0） 💬（1）<div>老师,第一步构建请求具体作用是什么？属于http吗？和第六步的发送http请求里的请求行好像</div>2019-09-03</li><br/>
</ul>