你好，我是戴铭。今天，我来跟你聊聊怎么构建事件总线。

事件总线是对发布和订阅设计模式的一种实现，通过发布、订阅可以将组件间一对一和一对多的耦合关系解开。这种设计模式，特别适合数据层通过异步发布数据的方式告知 UI 层订阅者，使得 UI 层和数据层可以不用耦合在一起，在重构数据层或者 UI 层时不影响业务层。

现在，我们先一起来捋一下 iOS 系统里有没有现成可用的技术，当数据层异步发布数据后，可以通过 Delegate 回调给 UI 层来进行展示，但是这个只适合一对一的模式。如果异步处理完后，还需要将数据发布给其他 UI 进行处理和展示的话，就需要继续发布给其他 Delegate，从而造成 Delegate 套 Delegate 的情况。

使用 Block 和使用 Delegate 的情况类似。如果需要不断异步发布给下一个数据订阅者的话，也会出现 Block 回调嵌套其他 Block 回调的情况。

iOS 系统里也有一对多模式的技术，比如 KVO 和 NSNotificationCenter。

使用 KVO 是强依赖属性的，只要更新了属性就会发布给所有的观察者，对应关系过于灵活，难以管控和维护。NSNotificationCenter 也有类似的问题，通过字符串来维护发布者和订阅者之间的关系，不仅可读性差，而且和 KVO 一样面临着难以管控和维护的情况。
<div><strong>精选留言（17）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/7c/85/8b221758.jpg" width="30px"><span>郑杰</span> 👍（46） 💬（4）<div>这里只说了 嵌套回调的问题用PromiseKit怎么解决，没说PromiseKit怎么实现事件总线啊</div>2019-05-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/30/9b/7bddc304.jpg" width="30px"><span>zhangkk</span> 👍（6） 💬（0）<div>如果一对多，多个类之间需要传递一个公共promise对象，来接受catch回调后的通知？</div>2019-05-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/45/d5/df2614f5.jpg" width="30px"><span>GREEN ISLAND</span> 👍（5） 💬（0）<div>一对多 都没听倒具体用法</div>2019-05-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/32/a9/ce5d2609.jpg" width="30px"><span>mosn</span> 👍（5） 💬（0）<div>PromiseKit 和 Bolts-iOS, 还有 coobjc 哪个好？</div>2019-05-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/54/ef/3cdfd916.jpg" width="30px"><span>yu</span> 👍（2） 💬（0）<div>PromiseKit 帶來 delegate 與 block 的解偶，並且增加易讀性與 避免 callback 地獄。項目也正在使用lib, Google 也開源了自己的 Promise lib, Promises, 提供 await 等更加直覺的使用方式，最近打算來評估一下。</div>2019-05-07</li><br/><li><img src="" width="30px"><span>Calabash_Boy</span> 👍（1） 💬（3）<div>&quot;NSNotificationCenter是难以管控和维护的&quot;,这句话不知大佬是如何理解的? </div>2019-07-23</li><br/><li><img src="" width="30px"><span>我唔知点死啊</span> 👍（1） 💬（2）<div>花了3天的时间，把PromiseKit应用到OC项目中，并修改了注册登录模块。代码简化很多，看起来也很舒服。目前遇到2个问题：
1. 如何延时处理下一个操作？（比如：注册成功后延时2秒再登录）
2. 文章中介绍了always和when方法，而在AnyPromise类文件却没看到它们的踪影。</div>2019-05-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e6/cc/7fc82af4.jpg" width="30px"><span>梅长苏</span> 👍（1） 💬（0）<div>除了RAC还有纯OC的发布 订阅框架吗？</div>2019-05-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/4f/d7/79f72168.jpg" width="30px"><span>享受慢生活🚨🚨</span> 👍（0） 💬（0）<div>其实ios原生有内部支持的opration q 也是支持的以及swift的result </div>2020-09-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/2e/85/358315f3.jpg" width="30px"><span>叶小合</span> 👍（0） 💬（0）<div>oc开发环境集成PromiseKit 全是错误</div>2019-11-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/3c/b9/42b228f8.jpg" width="30px"><span>徐秀滨</span> 👍（0） 💬（0）<div>想要让then能够传递参数，那么必须在then的block返回Promise，但是如果block是数据请求，那就会破坏已有的写法。这个要怎么处理呢？</div>2019-05-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/da/eb/0a356fdb.jpg" width="30px"><span>开元₂³³³³³³³</span> 👍（0） 💬（1）<div>希望大神能讲讲promise的具体应用，知道这个框架，一直无法应用到自己的项目</div>2019-05-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/67/d4/97eded36.jpg" width="30px"><span>@syj@</span> 👍（0） 💬（0）<div>事件总线还是没说清楚，讲解的只是把之前的block或者delegate方法换成AnyPromise方法，希望大神详细讲解下一对多的</div>2019-05-09</li><br/><li><img src="" width="30px"><span>Geek_pzvm2w</span> 👍（0） 💬（0）<div>简化异步调用为同步书写这一点上，和阿里开源的coobjc很相似，想请教这两者有什么大的区别么？</div>2019-05-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/33/be/1525566f.jpg" width="30px"><span>我的大好时光</span> 👍（0） 💬（0）<div>👍</div>2019-05-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/49/bd/ae37990b.jpg" width="30px"><span>geeklyc</span> 👍（0） 💬（0）<div>抢沙发</div>2019-05-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ea/e3/5818be1e.jpg" width="30px"><span>李志刚</span> 👍（0） 💬（0）<div>很实用，解决了某个操作依赖多个异步事件的场景，比如登陆操作依赖多个网络请求返回的场景。</div>2019-05-07</li><br/>
</ul>