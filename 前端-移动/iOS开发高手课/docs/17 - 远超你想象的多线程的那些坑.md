你好，我是戴铭。今天，我们一起来聊聊iOS开发中，使用多线程技术会带来的那些问题。

我们可以先来试想这么一个场景，如果没有多线程技术，那么我们要对一张照片进行滤镜处理时，就只能由主线程来完成这个处理。可想而知，这时候主线程阻塞了，其他的任何操作都无法继续。

解决这个问题的方法，就是再多创建一个线程来进行滤镜处理的操作，这样主线程就可以继续执行其他操作。这，也就是我们今天要说的多线程技术了。

目前，在iOS开发中，我们经常会用到系统提供的方法来使用多线程技术开发App，期望可以充分利用硬件资源来提高 App 的运行效率。

但是，我们不禁会想到，像UIKit这样的前端框架并没有使用多线程技术。而 AFNetworking 2.0（网络框架）、FMDB（第三方数据库框架）这些用得最多的基础库，使用多线程技术时也非常谨慎。

那么，你有没有想过为什么 UIKit 不是线程安全的，UI 都要在主线程上操作。

在 AFNetworking 2.0 中，把每个请求都封装成了单独的NSOperationQueue，再由NSOperationQueue根据当前的CPU数量和系统负载来控制并发。那么，为什么 AFNetworking 2.0 没有为每个请求创建一个线程，而只是创建了一个线程，用来接收NSOperationQueue的回调呢？
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/16/7a/7c/7bde009a.jpg" width="30px"><span>烩面</span> 👍（7） 💬（2）<div>老师问个问题：一个 app 有线程数量的限制吗？或者说，通常情况下，线程数达到多少就被系统 kill 掉了？</div>2019-04-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/a8/41/f20fa3ca.jpg" width="30px"><span>Emir</span> 👍（5） 💬（1）<div>多线程并发数量和可控需要怎么做到呢？老师应该讲一下方案、不能怕并发多就改成串行，多线程的意义呢？</div>2019-04-18</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epMJUobMDyeb9Y798y2sRRFzyHGKZticMqXTjtvibdENqjP4uw13S16FmrlIUiaIfVMz3mF9NwlyEN9w/132" width="30px"><span>Geek_0ce7bf</span> 👍（4） 💬（1）<div>在 AFNetworking 2.0 中，把每个请求都封装成了单独的 NSOperationQueue。大佬你这句话写错了吧？每个请求都封装成了单独的 NSOperation才对吧？？？？？</div>2019-04-20</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqZbpP8Of9zVbZnPDMnXnZH2Zft5F1Ip8ybicIY9BhSlaO37TCbYtCq89IO8iasXowia9PrPRLibdEQ1g/132" width="30px"><span>Dashing</span> 👍（2） 💬（2）<div>按照我粗浅的理解，串行队列背后也是一个线程，貌似跟常驻线程也差不多</div>2019-04-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/83/e8/f726c635.jpg" width="30px"><span>加温后的啤酒</span> 👍（1） 💬（3）<div>老师 文中的这段代码哪里有创建新线程？
[NSThread currentThread] 这个方法不是过去当前线程吗？为什么会创建一个新的？

+ (void)networkRequestThreadEntryPoint:(id)__unused object {
    @autoreleasepool {
        &#47;&#47; 先用 NSThread 创建了一个线程
        [[NSThread currentThread] setName:@&quot;AFNetworking&quot;];
        &#47;&#47; 使用 run 方法添加 runloop
        NSRunLoop *runLoop = [NSRunLoop currentRunLoop];
        [runLoop addPort:[NSMachPort port] forMode:NSDefaultRunLoopMode];
        [runLoop run];
    }
}
</div>2019-04-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/93/1c/c547b2b1.jpg" width="30px"><span>sacrifice</span> 👍（1） 💬（3）<div>老师，我for循环10000次创建子线程，内存消耗的也不明显啊</div>2019-04-18</li><br/><li><img src="" width="30px"><span>drunkenMouse</span> 👍（0） 💬（1）<div>常驻线程和单线程不是一个概念，但是AFN2.0的操作不是都在一个常驻线程吗，那这个常驻线程算不算是一个一直存活的子线程？</div>2019-04-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/96/04/abb7bfe3.jpg" width="30px"><span>tripleCC</span> 👍（51） 💬（6）<div>关于NSURLConnection和URLSession那块有一个地方讲的感觉不是很清楚。NSURLConnection也可以设置执行代理的queue，通过setDelegateQueue：方法，本质上是NSURLConnection的机制需要创建此对象的线程的RunLoop去监听网络事件，然后执行注册的回调，所以在网络回来前，需要保持RunLoop的运行状态。NSURLSession应该是内部做了这个事情，所以发请求不需要所在线程“常驻”，而不是因为我们可以设置delegateQueue。从代理方法的调用栈看，NSURLSession的代理任务都是在com.apple.NSURLSession-work这个queue被塞进delegateQueue的，如果不设置delegateQueue的话，代理任务就在work队列执行，设置之后再派发到对应的队列。具体在work队列之前做了什么，还没看到比较具体的资料，不过基于底层都是CFNetworking，这个又是Source0，可能做的和常驻线程相似。</div>2019-04-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f1/90/61ab7b3c.jpg" width="30px"><span>Tony</span> 👍（26） 💬（1）<div>多线程是有很多坑，但是多线程的好处以及如何正确使用多线程能讲讲吗？看完感觉没什么干货。</div>2019-05-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ed/4e/ef406442.jpg" width="30px"><span>唯她命</span> 👍（10） 💬（1）<div>老师你好，有个问题一直不理解，既然afn2.0讲所有的请求和回调 放在一个常驻线程里面，那么afn2.0的所有网络请求都在一个线程里了，那afn2.0岂不是单线程的吗？</div>2019-04-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/45/6f/e3e180b7.jpg" width="30px"><span>kidzss</span> 👍（9） 💬（0）<div>多读单写的，既保证性能，又可以保证数据安全</div>2019-04-29</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKtZXLibdfxdazQOcLJOQ1VjuxSPaicONOq1fFk9thwR3dXAdTOlcdW9u7q1qjnq8ibJn02d0aptEpXA/132" width="30px"><span>西行客</span> 👍（8） 💬（8）<div>面试中遇到一个非常坑的问题，请教一下老师。面试官问：除了加锁，还有什么其他办法能够保证数据线程安全？</div>2019-04-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/31/87/1a0377fa.jpg" width="30px"><span>赫小僧</span> 👍（4） 💬（0）<div>看到评论中有人问线程堆栈大小，通过NSThread的stackSize属性&#47;1024就可以得到多少k。目前我查看的解说是主线程、子线程大小都是512k。</div>2019-06-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ef/c0/0c690636.jpg" width="30px"><span>Cocoaleeo</span> 👍（3） 💬（0）<div>我帮老师回答一下各位的问题吧。@维他命：常驻线程和单线程不是一个概念；@kevin：AFN3.0的问题建议看一下源码；@烩面：正常来说，只要内存够，就可以一直开线程，但这样很不现实，所以可以通过第7，8，10节课的内容进行监控优化。</div>2019-04-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/4d/1c/2512341d.jpg" width="30px"><span>kevin</span> 👍（3） 💬（0）<div>大佬，AFN3.0的回调代理，“可以指定回调的 delegateQueue，不再需要在当前线程进行代理方法的回调” 具体是怎么实现的，能讲讲吗？</div>2019-04-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/08/d4/f9fa5b38.jpg" width="30px"><span>yNot？</span> 👍（3） 💬（1）<div>项目中需要每隔几秒同步一次服务器数据，对同步回来的数据需要做一系列的处理；开了个异步并行队列处理同步，引发了资源抢夺等问题，展示通过加锁解决，效果并不好，感觉失去了并发的意义</div>2019-04-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/37/10/4e03be02.jpg" width="30px"><span>SuperMario</span> 👍（2） 💬（0）<div>面试总是被问到如何设计一个线程池，总是不知道该怎么去说这个问题的关键点</div>2020-04-02</li><br/><li><img src="" width="30px"><span>Calabash_Boy</span> 👍（2） 💬（0）<div>当初的项目之一需要等到两个网络请求返回数据后,才能继续页面的刷新,通过GCD的队列组和信号量来解决的;</div>2019-04-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/40/76/781a0d76.jpg" width="30px"><span>刘隐林</span> 👍（1） 💬（0）<div>常驻线程能不用尽量不用,滥用常驻线程会导致性能消耗.并发太多会开启多个线程,从而占用大量内存,影响程序性能.同时线程创建太多,CPU在调度切换时需要消耗的资源就更多,进一步降低性能.</div>2021-03-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/20/abb7bfe3.jpg" width="30px"><span>Geek_wad2tx</span> 👍（1） 💬（0）<div>用信号量semaphore, 保证多线程的数据安全</div>2019-04-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/9e/14/7037d8c8.jpg" width="30px"><span>SmileLong</span> 👍（1） 💬（2）<div>使用GCD串行队列在IO操作时遇到磁盘等待一样会出现重复创建线程的问题，其实GCD并发线程反倒不会有这个问题</div>2019-04-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/39/08/09055b47.jpg" width="30px"><span>淡</span> 👍（1） 💬（0）<div>感觉还可以讲的深入点。多线程有坑，除了尽量使用串行队列来避坑以外，还有哪些手段来规避？以及其他手段该注意的点也可以说说</div>2019-04-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/2f/99/918e9b2a.jpg" width="30px"><span>三刀流剑客</span> 👍（1） 💬（0）<div>之前开发日志的时候多线程的坑: 公用参数获取是在异步线程中进行的, 创建了一个NSMutableDictionary, 其中有几个参数获取必须在主线程,所以就dispatch 到主线程中 setObject:forKey: 了, 然后就crash了,这里的写操作是从一个线程跳到另一个线程 : 最后的修改是这些setObject:forKey:都放到同一个线程执行, NSMutableDictionary 是类簇生成的一个对象</div>2019-04-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/42/0e/21b8025f.jpg" width="30px"><span>月落泉</span> 👍（0） 💬（1）<div>自己创建的子线程需要添加@autoreleasepool吗？
</div>2019-09-18</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Sk5OkV8YRrXibWelMMichPnM5QgIQTWiaFDjR5kLYvyk70MGuk43TiaY0jxpolQyItrckWSFJh1DssWepw6Ar3aiaVQ/132" width="30px"><span>Eddiegooo</span> 👍（0） 💬（1）<div>只有我没遇到什么多线程问题么？ 怎么感觉没怎么用多线程啊</div>2019-08-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c6/e4/ec572f55.jpg" width="30px"><span>沙亮亮</span> 👍（0） 💬（1）<div>GCD中在主队列只能使用主线程，那对于主队列中的多个异步任务是怎么做的呢，如何避免阻塞主线程呢？</div>2019-08-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8c/67/e91fe8d3.jpg" width="30px"><span>景天儿</span> 👍（0） 💬（1）<div>&quot;堆栈大小是 4KB 的倍数。在 iOS 开发中，主线程堆栈大小是 1MB，新创建的子线程堆栈大小是 512KB。&quot;，请问这些数据，在哪里可以查到啊？</div>2019-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/96/9a/78f2af55.jpg" width="30px"><span>包罗万象</span> 👍（0） 💬（0）<div>作业讨论：改下成FMDatabaseQueue后发现内存并没有明显变化，是否说明使用串行队列并发IO操作并没有造成内存问题？</div>2019-05-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/4c/bf/53aa7e6f.jpg" width="30px"><span>Ostholz</span> 👍（0） 💬（0）<div>你异步回调就行了，为什么还要加锁。</div>2019-04-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/2e/67/c760911f.jpg" width="30px"><span>Linuse</span> 👍（0） 💬（0）<div>老师，开发中会开启多个线程，那么如何管理这些线程？</div>2019-04-20</li><br/>
</ul>