你好，我是李江。

之前的两节课我们讲述了如何做好带宽预测和码率控制。好的带宽预测算法能够比较准确地预测出实际的网络带宽，而好的码率控制算法能够使得编码输出码率贴合实际网络带宽。这两个算法是视频流能够在各种网络状况下流畅播放的最基础的前提。

但是在实际情况中，很多时候我们还是会遇到各种各样的卡顿和花屏的问题。相信这两种问题你也是经常遇到，同时也是让你很头痛的问题。

那么，我们这节课就来讨论一下，一般哪些环节出问题会比较容易出现卡顿，以及哪些环节有问题会比较容易出现花屏。并且，我也会给出一些常用的解决方案。通过这节课的学习，你之后再遇到花屏卡顿问题的时候，可以参考一下，从而能够快速发现问题和找到解决的方法。

在讲述具体问题之前，先简单介绍一下Jitter Buffer这个模块。它是好几个卡顿和花屏问题的处理模块。Jitter Buffer工作在接收端，主要功能就是在接收端收到包之后进行组帧，并判断帧的完整性、可解码性、发送丢包重传请求、发送关键帧请求以及估算网络抖动的。其中组帧、判断帧完整性、判断帧可解码性、丢包重传、关键帧请求都是这节课的重点。因此，我先在这里重点说一下Jitter Buffer这个模块。Jitter Buffer在接收端所处的位置如下图所示：
<div><strong>精选留言（18）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/1c/f2/bc/ffc7ad67.jpg" width="30px"><span>Chris Zou</span> 👍（2） 💬（1）<div>老师有没有可能加餐，讲讲另外一个方式FEC冗余和重传方式之间的配合，以及itterbuffer对这两种包的不同处理？</div>2022-01-13</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ78AcrbfXwxWEfvR4UVxK3EjpIWicykT9GibfeHzNOKztUq4qdQicpqFNvC4TamBj6VnbyCZNzAbN2Q/132" width="30px"><span>allin</span> 👍（1） 💬（2）<div>老师，jitter buffer 在哪能找到模块源码进行学习，</div>2022-02-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2b/88/cc/e1ba2379.jpg" width="30px"><span>一身龙骨</span> 👍（1） 💬（1）<div>图像的宽高搞反了出现过花屏</div>2022-01-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/fb/16/2daa1c8b.jpg" width="30px"><span>播放技术部</span> 👍（0） 💬（1）<div>“重传也没有收到包” 这块有个问题想请教下，就是如果一个包重传了很久都没有收到，那么后面请求IDR帧的话，由于IDR帧很大，那么不是更有概率导致丢包吗？还有这个请求的IDR帧具体是离丢包的P帧多远的I帧呢？</div>2022-09-23</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/vIvIKrdKI0OCBPFXmQSOyyjfOlpIZGZibgMicbz0ia5j8LNfqtvskCarJCLoubHnSyIsyn0W8QCZG9FiacEwdnw7gw/132" width="30px"><span>Geek_6e7396</span> 👍（0） 💬（1）<div>文中判断帧完整时需要下一个帧到达，这样该帧送往下一步就会晚一个帧间距，这里就需要按帧编码做解析</div>2022-07-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/f2/bc/ffc7ad67.jpg" width="30px"><span>Chris Zou</span> 👍（0） 💬（2）<div>除了webrtc中的这种方式把所有包放到一个队列里面，还有什么好的方式处理，一般做法是什么样子的？</div>2022-01-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/f2/bc/ffc7ad67.jpg" width="30px"><span>Chris Zou</span> 👍（0） 💬（2）<div>WebRTC 中在使用的方法，在一个排好序的包队列里，从标志位M的包往前找连续包，直到有跳变就认为帧完整，这里跳变之外，应该也要判断是不是首包是否还在把？</div>2022-01-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/da/87/891a16c8.jpg" width="30px"><span>，</span> 👍（0） 💬（1）<div>翻了下代码，看上去是会进行kstash 会判断下seq连续，这种还有什么别的好办法没，gop内连续丢参考帧。</div>2021-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/da/87/891a16c8.jpg" width="30px"><span>，</span> 👍（0） 💬（1）<div>大佬，webrtc的jitterbuffer有处理264那种如果一个gop内完整的丢了几个p帧的这种情况么，大概怎么处理的？</div>2021-12-24</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ep8jMyicSeG5g6tfmKFxDLHjaE1VmSFCuwbS7RB4HxglicZibqtrRJ6nLDr97Zav2dqlbwRplayj52lg/132" width="30px"><span>iOS coder</span> 👍（0） 💬（1）<div>怎么对花屏进行线上监控呢？</div>2021-12-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/a8/75/7c8175d5.jpg" width="30px"><span>段壹鳴</span> 👍（0） 💬（1）<div>老师讲的很好, 撒花撒花~
老师能讲解一下 jitterBUffer里面的 缓冲延时计算吗, 然后请求重传策略, 新版本webrtc是全部移植到nack_requestion模块里了
</div>2021-12-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/80/99/abe64707.jpg" width="30px"><span>翻山越岭</span> 👍（0） 💬（1）<div>老师，直播中遇到概率性画面中有周期性马赛克，出现后每隔一段时间(3s或5s)出现，可能哪里引起的？</div>2021-12-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4d/0a/e124ec4b.jpg" width="30px"><span>_zeta</span> 👍（0） 💬（1）<div>给江同学点赞👍</div>2021-12-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/27/ec/f4/3c569056.jpg" width="30px"><span>西格玛</span> 👍（1） 💬（1）<div>小白问个问题，
1.一个视频中上半部分卡住，下半部分正常，这个是什么原因导致的？
2 . 视频中Y分量正常，只有上面几行的UV分量是异常的，其余是正常的可能是什么原因？
最后，我感觉，花屏的原因是不是有太多了，视频传输的过程中，任何一个环节出问题都有可能出现花屏。</div>2021-12-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/4b/1b/e3b3bcff.jpg" width="30px"><span>jcy</span> 👍（0） 💬（2）<div>问一下，看声网官网文档：通话过程中，视频帧率设置不低于 5 fps 时，连续渲染的两帧视频之间间隔超过 500 ms，即记为一次视频卡顿

而这篇文章里说的是 帧之间的播放时间间隔超过了 200ms

这是为什么？间隔差异有点大
</div>2022-08-02</li><br/><li><img src="" width="30px"><span>龚长华</span> 👍（0） 💬（0）<div>BT609 和 BT709搞错， 也会出现花屏问题。</div>2022-06-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/f2/bc/ffc7ad67.jpg" width="30px"><span>Chris Zou</span> 👍（0） 💬（1）<div>请教老师，我们的QOS有这么多手段，比如FEC，NACK，FIR、jitbuffer、Pacer、带宽估计有这些策略，对于web网关，考虑一般的实际情况，服务端对于QOS能做的事情是哪些？</div>2022-01-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/20/abb7bfe3.jpg" width="30px"><span>Geek_wad2tx</span> 👍（0） 💬（0）<div>遇到过Stride，YUV格式错误引起的花屏问题，根源就是对解码知识的匮乏</div>2021-12-19</li><br/>
</ul>