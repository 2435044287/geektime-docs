你好，我是李江。

上一节课我们一起讨论了视频编码的基本原理。今天，我们就接着来聊聊视频编码的码流结构，这在视频开发工作中是非常重要的。

视频编码标准其实有很多，比如上一节课讲到的H264、H265、AV1等，但原理大同小异，都是预测、变换、量化和熵编码等几个步骤。H264编码可以说是最常用的编码标准，比较经典，所以这节课我们就以H264为例来讲解码流结构。在掌握了这些之后，迁移学习其它编码标准的码流结构也就简单多了。

视频编码的码流结构其实就是指视频经过编码之后得到的二进制数据是怎么组织的，换句话说，就是编码后的码流我们怎么将一帧帧编码后的图像数据分离出来，以及在二进制码流数据中，哪一块数据是一帧图像，哪一块数据是另外一帧图像。

而我们在工程开发中，需要对编码后的数据进行一些解析，以便用于之后的打包。同时我们在打包时也需要判断当前一帧图像数据它的开头和结尾在哪。这些工作的前提就是我们要清楚如何分析编码码流，那么码流结构到底是怎样的，就是当下的学习重点了。

下面我们就以H264编码为基础，分析一下它的码流结构，并看看它在工程中是如何应用的。

## H264的编码结构

这里有一些前置知识我们需要先了解一下。我们先一起来看几个重要的概念吧。它们之间有这样一条线索，你在接下来的学习中可以重点关注一下，对于你记忆它们也是非常有帮助的。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/23/57/5ba842bc.jpg" width="30px"><span>aikeke</span> 👍（11） 💬（2）<div>老师能推荐下好用的h264字段分析工具吗？</div>2021-12-02</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q3auHgzwzM4BtLmq9ia6sWuwQMibrmdDGWkOzng6kUxick42mLEXnhojTQFF9blxPysafKJnwzswaSenJkZJGlWYQ/132" width="30px"><span>smart</span> 👍（11） 💬（1）<div>B帧需要双向参考，pts 和 dts 不一致。因此需要等待后面的 p 帧解码后才能继续，从而引入了延时。</div>2021-12-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/f2/bc/ffc7ad67.jpg" width="30px"><span>Chris Zou</span> 👍（6） 💬（1）<div>老师，ts文件中是不是就是含起始码的码流，而mp4文件就是不含起始码的mp4码流？</div>2021-12-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/20/abb7bfe3.jpg" width="30px"><span>Geek_wad2tx</span> 👍（6） 💬（1）<div>想问一下老师，起始码和NALU的关系是，起始码是用来区分PPS，SPS，I，B，P帧，然后I，B，P帧内部，又有由多个Slice&#47;NALU组成是吧？ 也就是说，I 帧和B帧中间用起始码分割，然后I帧内部，又会再被Slice分割？</div>2021-12-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/43/61/eeefa369.jpg" width="30px"><span>tony</span> 👍（4） 💬（1）<div>老师请教一下如下问题:
1. 判断一帧起始以及结束是否可以使用fu-a的start以及end标识位？
2. 判断哪几个slice属于同一个帧是否可以使用slice header中的frame number？
3. rtc中编码时为什么不采用sp帧?这样丢弃了某一参考帧，还能恢复出来
4. 有些书上说h264码流结构设计为具有良好网络亲和性的，从哪些方面特征可以表现出来？</div>2021-12-24</li><br/><li><img src="" width="30px"><span>qingzhu</span> 👍（4） 💬（4）<div>（1）“00 00 00”修改为“00 00 03 00”；
会不会原始编码中也存在“00 00 03 00”的冲突？</div>2021-12-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/20/b4/7d/9455f31a.jpg" width="30px"><span>我有一条鱼</span> 👍（1） 💬（1）<div>问题：
那B帧相对于P帧来说能减少多少大小吗？有相关的数据吗？</div>2021-12-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/20/abb7bfe3.jpg" width="30px"><span>Geek_wad2tx</span> 👍（1） 💬（1）<div>iOS Video Toolbox 可以参考这一篇 https:&#47;&#47;www.cnblogs.com&#47;tangyuanby2&#47;p&#47;11449460.html， 对照老师的课程，融会贯通</div>2021-12-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/ec/8a/4de35fb7.jpg" width="30px"><span>paradise</span> 👍（1） 💬（1）<div>B帧因为双向参考的缘故，编码和解码都存在时延，特别是在倒放的时候比较麻烦，所以安防领域都不使用B帧编码。
感谢江哥细致的讲解</div>2021-12-02</li><br/><li><img src="" width="30px"><span>武丽权</span> 👍（0） 💬（2）<div>老师，想问下，文章里面所指的I帧，P帧，B帧是因为帧内宏块的预测方式决定的吗，还是说不同帧决定了该帧内宏块的预测方式。这里不是很理解，希望得到老师的解惑</div>2023-03-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/f5/90/2caa07d0.jpg" width="30px"><span>Geek8815</span> 👍（0） 💬（1）<div>Annexb 为啥改成00 00 03 00 而不是 00 00 02 00呢？</div>2023-01-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/33/5c/8ea5d4aa.jpg" width="30px"><span>鲁大江</span> 👍（0） 💬（1）<div>Slice Header内slice_type的值 0 是P帧 1 是B帧 2是I帧。 frame_num是帧的编号，可以根据这个值判断Slice是属于那一帧</div>2022-12-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/33/5c/8ea5d4aa.jpg" width="30px"><span>鲁大江</span> 👍（0） 💬（1）<div>感觉收益匪浅，谢谢老师。</div>2022-12-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/9d/9b/12862222.jpg" width="30px"><span>邱文彬</span> 👍（0） 💬（1）<div>老师起始码的4字节和3字节分别用在什么情况下</div>2022-08-11</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/w6PB0WPSSfKWNsrdGDultmctmIqCic7ictcnLuNwUzRAPDBiaicDUXq5CIVtCq8RbEU88NQUOKNXS91428lUI2yhkg/132" width="30px"><span>Geek_18e70d</span> 👍（0） 💬（1）<div>李老师一帧的多slice的判断为什么不能用first_mb_slice和RTP的mark位组合判断，是因为这个不RTP传输的吗</div>2022-03-22</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/w6PB0WPSSfKWNsrdGDultmctmIqCic7ictcnLuNwUzRAPDBiaicDUXq5CIVtCq8RbEU88NQUOKNXS91428lUI2yhkg/132" width="30px"><span>Geek_18e70d</span> 👍（0） 💬（1）<div>一帧的多slice的判断为什么不能用mark位判断</div>2022-03-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2b/8a/8a/2aa0e992.jpg" width="30px"><span>weekend</span> 👍（0） 💬（1）<div>&quot;NALU 类型只区分了 IDR Slice 和非 IDR Slice，至于非 IDR Slice 是普通 I Slice、P Slice 还是 B Slice，则需要继续解析 Slice Header 中的 Slice Type 字段得到&quot;

--请问老师这个可以讲一下非IDR Slice，要具体怎么判断是P Slice还是B&#47;I Slice呢？</div>2022-03-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/ba/bf/e9a44c63.jpg" width="30px"><span>chao</span> 👍（0） 💬（1）<div>请问 NAL Unit、STAP、MTAP、FU 有各自适用的场景吗</div>2022-01-10</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/yBBhL9I6vian2PMOo7xnibKp8EibiaCrqfXibk5YOQSfzyjfZPGnUqHy1x1ibVIVYddMnibFJlpJibutAicXsZibwqskFoibw/132" width="30px"><span>余健辉</span> 👍（0） 💬（1）<div>因为B帧是参考前面和后面帧数据的，计算量就相对大了一点，而且还需要缓存帧用于解码，所以会产生一定的时延。
想请问老师关于h264，AV1这些编码协议和对应的编码器x264这些和他们的编程有什么好的学习资料吗</div>2021-12-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2b/88/cc/e1ba2379.jpg" width="30px"><span>一身龙骨</span> 👍（0） 💬（3）<div>请问B帧的起始码是啥？谢谢！</div>2021-12-06</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/ywSuwVNMKNjRLPMjZmpQOQHWW2usAu8RwRIOlBHaVVU6J3xHdtibgO6FVzYkRIkV50vCr62ia4OwJp07giabiazUGA/132" width="30px"><span>ripple</span> 👍（0） 💬（2）<div>00 00 00 00 27 为什么是一个pps？是不是写错了呢？
27 转成2进制是00011011，前一位0是F，接着两位00，代表NRI，pps不是要求大于0么？
后面5位是type，我理解没对？</div>2021-12-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/70/67/0c1359c2.jpg" width="30px"><span>qinsi</span> 👍（0） 💬（1）<div>希望能知道码流结构为什么要这样设计？上节课讲编码原理的时候，预测编码、DCT和量化等都是为了压缩掉各种冗余信息。这节课的码流结构又解决了什么样的问题呢？尤其是NALU，为什么是这样的结构？有没有什么特别的考虑？还是说只要包含了必要的信息，随便什么样的格式都可以？</div>2021-12-04</li><br/><li><img src="" width="30px"><span>qingzhu</span> 👍（0） 💬（1）<div>怎么判断数据量是MP4格式的，还是Annexb起始码格式的？</div>2021-12-02</li><br/><li><img src="" width="30px"><span>Y</span> 👍（0） 💬（1）<div>请问老师：
    IDR之前的帧，会参考本IDR帧和之后的帧吗？</div>2021-12-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/20/abb7bfe3.jpg" width="30px"><span>Geek_wad2tx</span> 👍（0） 💬（1）<div>iOS Video ToolBox 可以参考这一篇，在针对老师的课程，融会贯通</div>2021-12-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/20/abb7bfe3.jpg" width="30px"><span>Geek_wad2tx</span> 👍（0） 💬（1）<div>因为B帧的解析依赖前后帧，所以需要缓存帧，才能解析B帧，一般RTC场景不编码B帧</div>2021-12-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4d/0a/e124ec4b.jpg" width="30px"><span>_zeta</span> 👍（0） 💬（2）<div>MP4包格式和RTP包格式有什么区别么？</div>2021-12-01</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Ikib5hH6AA9v1kJWp14ImL99HSv9XRmURK0IiaLAjm51dYbjicsgyXWwud3KjdweGtyd1SelMNb2HIsj9nzcAS0Sw/132" width="30px"><span>Geek_7de4c5</span> 👍（0） 💬（1）<div>老师，请问一下，如何通过坐标来找对应的宏块呢？</div>2021-12-01</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJV27QOK57cdpdh3E4hbArCOlccdtjCyWooF9fhjeSKAMo9SN1v9RODkrZUZD4RejjbdsqU2FIeMA/132" width="30px"><span>西钾钾</span> 👍（0） 💬（1）<div>B帧是双向预测帧，需要前后帧作为参考，这会在拉流侧产生延迟。
B解码时应该也会比较耗费cpu</div>2021-12-01</li><br/><li><img src="" width="30px"><span>龚长华</span> 👍（2） 💬（0）<div>因为B帧既需要前向参考，也需要后向参考。因此在解码时，B帧的解码需要等到它参考的后向帧解码之后才能解码。这会导致额外的延时。</div>2022-06-05</li><br/>
</ul>