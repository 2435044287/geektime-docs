你好，我是winter，今天我们继续来看浏览器的相关内容。

我在上一篇文章中，简要介绍了浏览器的工作大致可以分为6个阶段，我们昨天讲完了第一个阶段，也就是通讯的部分：浏览器使用HTTP协议或者HTTPS协议，向服务端请求页面的过程。

今天我们主要来看两个过程：如何解析请求回来的HTML代码，DOM树又是如何构建的。  
![](https://static001.geekbang.org/resource/image/34/5a/34231687752c11173b7776ba5f4a0e5a.png?wh=732%2A279)

## 解析代码

我们在前面讲到了HTTP的构成，但是我们有一部分没有详细讲解，那就是Response的body部分，这正是因为HTTP的Response的body，就要交给我们今天学习的内容去处理了。

HTML的结构不算太复杂，我们日常开发需要的90%的“词”（指编译原理的术语token，表示最小的有意义的单元），种类大约只有标签开始、属性、标签结束、注释、CDATA节点几种。

实际上有点麻烦的是，由于HTML跟SGML的千丝万缕的联系，我们需要做不少容错处理。“&lt;?”和“&lt;%”什么的也是必须要支持好的，报了错也不能吭声。

### 1.词（token）是如何被拆分的

首先我们来看看一个非常标准的标签，会被如何拆分：

```
<p class="a">text text text</p>
```

如果我们从最小有意义单元的定义来拆分，第一个词（token）是什么呢？显然，作为一个词（token），整个p标签肯定是过大了（它甚至可以嵌套）。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/15/35/d0/f2ac6d91.jpg" width="30px"><span>阿成</span> 👍（102） 💬（1）<div>参考了 github 上的一个 gist，才算写出来个能跑起来的...
https:&#47;&#47;github.com&#47;aimergenge&#47;toy-html-parser</div>2019-02-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/61/c1/93031a2a.jpg" width="30px"><span>Aaaaaaaaaaayou</span> 👍（13） 💬（1）<div>return tagOpen  是不是应该改为 return tagOpenState</div>2019-02-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/b8/d1/5a216db5.jpg" width="30px"><span>是零壹呀</span> 👍（10） 💬（2）<div>这一节讲的应该是如何实现一个parser吧。
关于状态机这一块，我觉得是不是可以先讲一节正则的知识点呢。
理解了正则，那么大家对状态机的概念就有了更加直观的理解了。</div>2019-02-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/1c/b9/392b94ee.jpg" width="30px"><span>umaru</span> 👍（9） 💬（2）<div> 老师cdata是啥？( ・◇・)</div>2019-02-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f7/20/e2dfa9c2.jpg" width="30px"><span>花儿与少年</span> 👍（9） 💬（1）<div>只简单讲了浏览器怎么解析html,并没有讲具体怎么构建dom树，请寒老师不要偷工减料</div>2019-02-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/0d/47/2fdcf2d6.jpg" width="30px"><span>王飞</span> 👍（4） 💬（2）<div>老师，感觉在可以讲下virtual-dom</div>2019-02-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/6c/5c/16e5b8f7.jpg" width="30px"><span>Marphy Demon</span> 👍（4） 💬（1）<div>老师可否提供一些课外阅读的材料呢？单纯通过这一篇文章，没有接触相关知识的前提下，get到的东西比较少。</div>2019-02-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f7/b1/982ea185.jpg" width="30px"><span>美妙的代码</span> 👍（3） 💬（1）<div>老师 能回答下，或者给个资料补充一下。手机浏览器与电脑浏览器的区别吗？</div>2019-02-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/2c/88/2a7fe1a9.jpg" width="30px"><span>让时间说真话</span> 👍（1） 💬（1）<div>词法其实是词经过状态机解析的规则。语法是词法的实现。比如&lt;p&gt;hello world&lt;&#47;p&gt;
浏览器根据状态机中词法对词的解析的规则把html解析成词，然后用语法构建dom树。</div>2019-02-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a6/56/abb7bfe3.jpg" width="30px"><span>云韵</span> 👍（1） 💬（1）<div>状态机的那幅图有点看不懂，可以详细说一下吗，或者有个推荐的资料</div>2019-02-20</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Fcx276V5ZyrYtGuWiaWQugKMX4aicY8cibicQISyiaAEKZKVmdz8apIhKzCfIZolyetSFXbl2gHSK9qZT5moJkk7DYg/132" width="30px"><span>coma</span> 👍（1） 💬（1）<div>请问为什么如果使用基于类的面向对象方式，就要使用抽象工厂来创建对象？</div>2019-02-12</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIBUFdN3p3KvwsAeYltGbenNFPmIJ1tdXVGkVkkibKs1n12Brd1iae5BNXnW8HKSYX8bTtSqrpeuJUw/132" width="30px"><span>Geek_bb5943</span> 👍（0） 💬（1）<div>这个应该跟编译原理关系很大，有种半懂半不懂的感觉，该咋办呢？
</div>2019-12-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/f7/a6/0b590c34.jpg" width="30px"><span>心平气和的韩丽媛</span> 👍（0） 💬（1）<div>html标签，大部分是成对的，并且层层嵌套，层层嵌套的标签是怎么识别一对的呢？</div>2019-10-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/16/9a/573d46b3.jpg" width="30px"><span>曼塔特</span> 👍（53） 💬（0）<div>感觉在看编译原理</div>2019-02-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/35/d0/f2ac6d91.jpg" width="30px"><span>阿成</span> 👍（14） 💬（0）<div>老师，为什么状态机没办法封装，能详细解释一下吗</div>2019-02-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/3b/01/34aa76cc.jpg" width="30px"><span>RMX</span> 👍（8） 💬（0）<div>https:&#47;&#47;blog.csdn.net&#47;userkang&#47;article&#47;details&#47;80851153
之前在看 Webkit 技术揭秘 这本书，记的笔记。结合老师的文章，了解的更深了。谢谢！</div>2019-02-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/1f/86/3a7eeac4.jpg" width="30px"><span>leslee</span> 👍（4） 💬（2）<div>状态机的图没看懂...</div>2019-02-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/39/30/f7df6ba7.jpg" width="30px"><span>米斯特菠萝</span> 👍（4） 💬（0）<div>这是一篇我不是太懂，却不会自责的文章，毕竟已经涉及浏览器解析html的编译原理了</div>2019-02-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/42/e7/e5afadf7.jpg" width="30px"><span>风吹一个大耳东</span> 👍（3） 💬（0）<div>看到状态机就已经获益匪浅了，老师讲的都是我们平时不在意却又是必须懂的东西~</div>2019-02-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/43/9b/ce86894a.jpg" width="30px"><span>Nirvana</span> 👍（3） 💬（0）<div>老师讲的真好，这部分内容虽完全没接触过，但是相信多听几遍，加上自己的查阅应该也能弄清楚。老师如果开新班请尽快推广，这个课听的太值了。</div>2019-02-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/6c/e3/45f550b5.jpg" width="30px"><span>不二</span> 👍（2） 💬（0）<div>《你不知道的JavaScript》书里也有讲这个阶段游览的干了什么，有兴趣的可以去看下</div>2019-05-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ed/aa/f70868c0.jpg" width="30px"><span>Geek_vfl5iy</span> 👍（2） 💬（0）<div>看来大学重修一遍编译原理还是值得的</div>2019-02-12</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIcLjatV3GHdibZXCTIgL1X2A7jpByIeLH3Zyia8KXdT4JRcicmVSgq5ekRHCFCFenMqicsAwaWYibHkTw/132" width="30px"><span>xxx</span> 👍（1） 💬（0）<div>也看过浏览器构建dom树的一些文章，但那些都太生硬难懂了，什么词法解析，语法解析，根本弄不灵清在干啥，听老师的讲解有点知道在讲啥了。</div>2019-05-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/fa/af/37828a42.jpg" width="30px"><span>Liyu</span> 👍（1） 💬（0）<div>道理我都懂，就是实现不了 ^^!</div>2019-03-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/60/de/5c67895a.jpg" width="30px"><span>周飞</span> 👍（1） 💬（0）<div> 做了一个简单的demo  https:&#47;&#47;github.com&#47;kobefaith&#47;simpleHtmlParse.git</div>2019-03-17</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Htgf7XWRjvlImq5Ng7ud2agtQMw9YUS1xDwtNtMenwIUFRscQVPbIKicbYCf5BpialRHdBWAcrUibVEpHZ75icOmicw/132" width="30px"><span>Geek_xd2069</span> 👍（1） 💬（0）<div>https:&#47;&#47;github.com&#47;haven2world&#47;HavenStudyRepository&#47;tree&#47;master&#47;geekbang-winter&#47;htmlParser

_(:з」∠)_  啰里啰嗦写了一大堆，这大概是我用js写过的最面向对象的东西了</div>2019-03-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/4b/14/452dacbb.jpg" width="30px"><span>nannanwj</span> 👍（0） 💬（0）<div>老师，我这里用栈构造 DOM 树的那个视频只有0秒。。。是出bug了吗</div>2020-05-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/f7/56/b82eeac7.jpg" width="30px"><span>champ可口可乐了</span> 👍（0） 💬（0）<div>那我也贴一个自己的实现，虽然目前只做了分词这部分，后面会进一步完善。
https:&#47;&#47;github.com&#47;champkeh&#47;toy-html-parser</div>2020-05-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/2c/97/462a2c7f.jpg" width="30px"><span>小王</span> 👍（0） 💬（0）<div>请问老师，DOM树是否是视频右侧显示的红色的部分？比如{&#39;name&#39;: &#39;html&#39;,&#39;maaa&#39;: &#39;a&#39;}这种。它们最后是以何种形式形成一棵树的呢</div>2019-05-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/2c/70/02b627a6.jpg" width="30px"><span>coder</span> 👍（0） 💬（0）<div>ES6里的Generator，不就是状态机的一种封装吗？</div>2019-05-06</li><br/>
</ul>