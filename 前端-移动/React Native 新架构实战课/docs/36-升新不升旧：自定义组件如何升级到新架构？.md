你好，我是蒋宏伟。

有同学后台留言说：“我把公司应用升级到了 0.71.8 版本，开启新架构后，一些组件都乱了，折腾了三天最终无奈退回到老架构了。”

这个问题还挺典型的，今天我们就来聊聊到底应该怎么升级？分享一些经验。

在上节课中，我把我们的教学项目 React-Native-Classroom 项目，从 0.68 升级到了 0.72 的新架构，迁移过程十分顺利。这是因为 React-Native-Classroom 项目没有使用自定义模块或组件，它使用的都是官方的或成熟的社区方案，这些方案都对新老架构进行了兼容。所以，无需额外的 Native 代码升级工作。

但是，新旧架构的自定义模块或组件研发方式完全不同。原来那些自己维护的自定义模块或组件，要完全升级成 Turbo Modules 和 Fabric Components 是需要大量的改造工作的。

对于业务而言，研发效率是第一位的。那如何升级新架构，才能降低升级成本呢？

先说结论：**升级新架构时不动旧的业务代码，是一个好策略。**

## **老代码是否兼容？**

那首先，我们就来测试，老代码不做任何修改，能否直接在新架构上运行？

我参考了官方文档中的老架构部分，分别创建了一个老模块和一个老组件。

老模块是自定义的简化版存储模块 StorageModule。它有两个方法，一个是利用键值对的形式存储字符串，另一个是使用键去读取存储在 Native 端的值。如果存储（SET ITEM）和读取（GET ITEM）成功，那么就说明这类老模块代码能在新架构中直接使用。
<div><strong>精选留言（4）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/37/2e/02/7f151e08.jpg" width="30px"><span>听说昵称太长了躲在树后面会被别人看见的</span> 👍（5） 💬（4）<div>我就是那位折腾了三天退回去的同学，没想到被点名了😂。经过了一年 RN 的折腾我也总结了一些看法，这个折腾过程估计也是很多初尝跨段方案的团队要走的老路。首先不能把 RN 当做客户端最终解决方案，我们当时调研后下的结论：“跨端是未来，原生是辅助”，因为项目初期各部门同事一致不负责的说：怎么快怎么来，能用就行！这给了我们拥抱跨端的勇气。可当加班加点忙完项目上线跑起来终于松一口气时大家口风就变了，因为能用和用到极致是两码事，当开始盈利时跟竞品一对比那必须要用到极致，起初那些不痛不痒的问题在这个阶段就变成了棘手问题，兜兜转转最后又回到了原生，因为不是所有团队都有像宏伟老师这样的团队去做深度优化，所以我们花了很多时间去优化却没折腾出效果，公司没法再忍受我们去研究而不产出了，然后只能用原生把大部分核心功能重写了，只留下少量边边角角的业务用 RN，回过头一看，原本想借助跨端提高生产力，结果反而是降低了生产力，可以说是羊肉没吃到弄了一身骚，原因很简单，一但过了 0 到 1 这个阶段摆在面前只有两条路，要么深入甚至魔改 RN（这没个一年半载门都摸不着），要么用原生开始重构（原生开发组的同事还整天做优化呢，纯 RN 咋个做到极致），如果没有做这到选择题那么大概率我猜你们宣告项目失败甚至到了裁员的边缘，市场机会总是稍纵即逝，项目的失败与技术选项不无关系，这个问题值得深思。总结，得结合自身项目借助 RN 辅助完成一些工作，最好不要一梭哈的把鸡蛋全放 RN 的篮子里，除非你做的是需求明确并且生命周期可预测的项目。另外，这两天在研究原生承载页加载 RN 过慢的问题，安卓低端机得两三秒白屏后才能加载完渲染出来，不知道老师能否加个餐讲一讲怎么优化。</div>2023-08-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/0e/df/a64b3146.jpg" width="30px"><span>长林啊</span> 👍（1） 💬（0）<div>老师后面能扩展react-native服务端渲染方向的相关内容吗？</div>2023-11-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/3c/55/74844d08.jpg" width="30px"><span>大大小小</span> 👍（1） 💬（0）<div>哈哈，我居然是第一个毕业的！</div>2023-08-08</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/7qfG5LfuHpxJteV0qqqibRhuaDpFemictStTHnLy89mRCxgUuic65zIic1Yw9aCM0Jfzic1WBR1g77dniahnzzU9vEBWkpx17hydHF5fia470LgUvk/132" width="30px"><span>Geek_64953b</span> 👍（0） 💬（0）<div>大佬从58毕业了嘛</div>2025-01-09</li><br/>
</ul>