在 WebRTC 中， NAT 穿越是非常重要的一部分内容，也是比较有深度、比较难以理解的一部分知识。当然，等你学完本文，并完全理解了这部分知识后，你也会特别有成就感！

在我们真实的网络环境中，NAT 随处可见，而它的出现主要是出于两个目的。**第一个是解决 IPv4 地址不够用的问题**。在 IPv6 短期内无法替换 IPv4 的情况下，如何能解决 IP 地址不够的问题呢？人们想到的办法是，让多台主机共用一个公网 IP 地址，然后在内部使用内网 IP 进行通信，这种方式大大减缓了 IPv4 地址不够用的问题。**第二个是解决安全问题**，也就是主机隐藏在内网，外面有NAT挡着，这样的话黑客就很难获取到该主机在公网的IP地址和端口，从而达到防护的作用。

不过凡事有利也有弊，NAT 的引入确实带来了好处，但同时也带来了坏处。如果没有NAT，那么每台主机都可以有一个自己的公网IP地址，这样每台主机之间都可以相互连接。可以想象一下，如果是那种情况的话，互联网是不是会更加繁荣？因为有了公网IP地址后，大大降低了端与端之间网络连接的复杂度，我们也不用再费这么大力气在这里讲 NAT 穿越的原理了。

如果从哲学的角度来讲，“世上的麻烦都是自己找的”，这句话还是蛮有道理的。
<div><strong>精选留言（24）</strong></div><ul>
<li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoicwtj6x3l7NEcODqsXHjUTjzbl99pesNbydQUSfR6IywcKKyyaY9AIhBS0bCz3R8icMRIploDdUQA/132" width="30px"><span>花果山の酸梅汤</span> 👍（39） 💬（5）<div>类型（A-B）	建立状况
完全锥型-完全锥型	A通过server获得B的IP:port开始通信
完全锥型-IP限制型	B通过server获得A的IP:port开始通信
完全锥型-port限制型	B通过server获得A的IP:port开始通信
完全锥型-对称型	B通过server获得A的IP:port开始通信
IP限制型-IP限制型	A通过server获得B的IP:port，A向B发送UDP包，数据通过自己的NAT时会为B建立NAT映射条目；B通过server获得A的IP:port，发送UDP包为A建立NAT映射条目，二者之后就可以开始通信。
IP限制型-port限制型	A通过server获得B的IP:port，A向B发送UDP包，数据通过自己的NAT时会为B建立NAT映射条目；B通过server获得A的IP:port，发送UDP包为A建立NAT映射条目，二者之后就可以开始通信。
IP限制型-对称型	A通过server获得B的IP:port1，A向B发送UDP包，数据通过自己的NAT时会为B建立NAT映射条目；B通过server获得A的IP:port，发送UDP包为A建立NAT映射条目，A收到B的UDP包，获得B新的IP:port2；A向B的新地址IP:port2发送数据，可以开始通信。
port限制型-对称型	A通过server获得B的IP:port1，A向B发送UDP包，数据通过自己的NAT时会为B建立NAT映射条目；B通过server获得A的IP:port，发送UDP包为A建立NAT映射条目，但由于B更换了新端口port2，A刚建立的映射无法使用，A故此无法收到B为A通信使用的新端口，无法建立NAT映射，两者无法互通。
对称型-对称型	同上，对称型开启新端口对方无法获悉，无法建立链接。
无法P2P就需要用TURN服务器转发数据了…</div>2019-08-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/0e/96/eca820c7.jpg" width="30px"><span>李新</span> 👍（5） 💬（1）<div>请教一下，除了生日攻击，还有其他方法提高P2P的打洞成功率吗？ </div>2019-11-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/8c/c4/760934c0.jpg" width="30px"><span>杨凯</span> 👍（2） 💬（1）<div>老师您好，请问下：客户端C与服务端S进行socket通讯，TCP握手连接成功后，通过抓包分析端口是25568，然而，S端收到的第一个数据包的端口变成25567，导致C端报错connection reset，能说下什么原因吗？</div>2020-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/ec/1f/cd321f00.jpg" width="30px"><span>Happy~张🤔</span> 👍（2） 💬（1）<div>请问一下，stun服务器作为net打洞，那打洞成功后，后面传输还是会利用stun进行转发媒体信息进行通信吗？如果不是外网信息怎么转到内网的？</div>2019-11-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/0e/96/eca820c7.jpg" width="30px"><span>李新</span> 👍（1） 💬（2）<div>请教一下，NAT类型的探测这么复杂，而且需要的时间也久，webrtc在P2P的时候是不是不需要探测NAT类型，而只是对着ICE Candidate相互发包就可以了？</div>2019-11-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/12/ce/a8c8b5e8.jpg" width="30px"><span>Jason</span> 👍（1） 💬（1）<div>尝试回答思考题，不知道理解的对不对，还请老师指正：
对称型NAT之间打洞失败：对称型NAT是内网主机通过STUN服务返回的外网IP：port，只是针对STUN服务的，而跟其他外网设备的链路是直接不能相通的。
端口受限型NAT与对称型NAT之间打洞失败：端口受限型NAT是指内网主机通过STUN服务返回的外网IP：port，要求外网设备的IP和端口是不能变的，否则链路不通。但对称型NAT针对内网主机的不同端口而映射出来的外网地址，明显不能保证IP和端口不变。</div>2019-08-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg" width="30px"><span>piboye</span> 👍（0） 💬（1）<div>对称型可以通过生日悖论来突破吧，只是要尝试的次数太多，时间延迟较大</div>2020-12-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/65/25/c6de04bc.jpg" width="30px"><span>斜月浮云</span> 👍（0） 💬（5）<div>请问，如果对称NAT的B每次改变IP和端口，那么IP限制NAT主机A与对称NAT的B怎么建立连接呢？</div>2019-09-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/66/d2/78ee760d.jpg" width="30px"><span>momo</span> 👍（0） 💬（1）<div>探测 NAT 环境的时候为什么要向服务器#2发请求， 不能向#1的另外一张网卡发请求吗？</div>2019-08-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/46/58/31205087.jpg" width="30px"><span>恋着歌</span> 👍（0） 💬（1）<div>看了 花果山の酸梅汤 同学的回答。打洞不成功是因为建立了两个连接，但是为什么不用发起者建立的连接来传回数据呢？</div>2019-08-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/82/42/8b04d489.jpg" width="30px"><span>刘丹</span> 👍（0） 💬（1）<div>是否IP限制型NAT、端口限制型NAT都有一个隐含条件：WebRtc客户端与防火墙之间只有1个NAT映射？</div>2019-08-08</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/u9oss767Kxzbl3SVgibUzngqMiafndGzA43bgPTw8BRvTCGicAl5La5HfZJm9rTYQJBE65TkePiaVEtMDquUIaEOAg/132" width="30px"><span>君</span> 👍（0） 💬（2）<div>老师，请教下如何编译resiprocate成ios静态库</div>2019-08-07</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIDMOwpv5uMgy4HhoS0VPczxfXQldueafaaq2hznQx51nxZung0kYWukicNP3a3MFrhguVrjBwlwAg/132" width="30px"><span>彭刚</span> 👍（0） 💬（2）<div>老师,前端这方面实在有点差，前端方面代码就看你的过一遍可以吗。大概能看懂每一步是干嘛的，后端部分认真写</div>2019-08-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/4d/fd/0aa0e39f.jpg" width="30px"><span>许童童</span> 👍（0） 💬（1）<div>两端都是NAT时，因为都没有公网IP，所以只能通过中转服务器打洞，但打的打洞却被对称型 NAT限制，需要重新打洞，从而无法打洞成功。此时只能让数据也通过中转服务器传输。</div>2019-08-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/82/42/8b04d489.jpg" width="30px"><span>刘丹</span> 👍（0） 💬（3）<div>可以介绍一下WebRtc双方都是端口限制型NAT或者都是IP限制型NAT的情况下，怎样打洞通信的呢？好像打出来的洞只允许中间服务器和WebRtc直接通信，不允许另外一个WebRtc使用？</div>2019-08-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/82/42/8b04d489.jpg" width="30px"><span>刘丹</span> 👍（0） 💬（1）<div>请问李老师：为什么在NAT类型检测图里，要先判断是否完全对称型NAT，然后才判断是否IP限制NAT、端口限制NAT呢？这个次序能变吗？</div>2019-08-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/53/eb/008f83ad.jpg" width="30px"><span>Geek_4b4f4a</span> 👍（0） 💬（1）<div>老师，想问一下，如果想在服务器保留音视频通话记录是不是P2P的连接方式就不能用了？</div>2019-08-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/d3/ba/75f3b73b.jpg" width="30px"><span>Benjamin</span> 👍（4） 💬（0）<div>https:&#47;&#47;static001.geekbang.org&#47;resource&#47;image&#47;b1&#47;c3&#47;b112ac2cd7e557d86dd5669e2858f6c3.png

一图胜千言，这图一看到总算搞明白了。</div>2020-02-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/95/4e/b631806d.jpg" width="30px"><span>wengjia</span> 👍（0） 💬（0）<div>老师我有一个问题请教我在服务器上配了一个coturn的stun服务器。客户端html,用本地index.html打开的方式peerconnection配置了coturn的地址可以连接成功。如果我用htttp:&#47;&#47;ip:port&#47;index.html方式打开peerconnection连不上。老师我该如何排查这个问题，有点没头绪</div>2023-07-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/e5/39/951f89c8.jpg" width="30px"><span>信信</span> 👍（0） 💬（0）<div>这章是目前为止花的时间最久的</div>2023-01-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/62/4a/96b8544f.jpg" width="30px"><span>在路上</span> 👍（0） 💬（0）<div>问题提高「每台服务器都是双网卡的，而每个网卡都有一个自己的公网 IP 地址」 ，公网IP地址可以是一个NAT网关的IP吗？</div>2022-08-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/bc/89/391ddcdf.jpg" width="30px"><span>Vincent.永生</span> 👍（0） 💬（1）<div>老师请教下，按总结，不做nat探测，每个打洞都按端口限制型-端口限制型来穿越就行了？还省了双网卡的服务器</div>2022-04-29</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJoNVHqRL5iatEoMgfFAaGFZxD8ic6CicxKI9Facp4bzAkNMAfaduSENlPOafs6dOGawibhNv3V9lVowQ/132" width="30px"><span>SherwinFeng</span> 👍（0） 💬（0）<div>打洞失败自然就要用relay服务器啦</div>2019-11-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/a8/54/06da255b.jpg" width="30px"><span>Beast-Of-Prey</span> 👍（0） 💬（0）<div>打卡</div>2019-08-06</li><br/>
</ul>