本文我们将第三模块所讲的知识做一次梳理，让你在整体上了解“万人直播”到底是怎样实现的。我们将从万人直播的整体架构、主播客户端架构、观众客户端架构和流量统计这四个方面向你讲述万人直播的构建。

通过这几个方面的介绍，我想你就知道了一个真正的“万人直播”是如何构建起来的。

## 万人直播架构

下面这张万人直播架构图与[《31 | 一对多直播系统RTMP/HLS，你该选哪个？》](https://time.geekbang.org/column/article/140181)一文中介绍的直播架构图很类似，它们之间最大的不同在于真正的万人直播系统中并不会只使用一家 CDN网络，而是接入多家 CDN网络。在使用它们时，你可以按照一定的比例将“节目”分配到不同的CDN网络上。

![](https://static001.geekbang.org/resource/image/4e/bf/4e52d2ea1567a9821e1188f7bc6befbf.png?wh=1142%2A582)

万人直播架构图

多家 CDN 网络的管理一般是由信令服务器控制的。当要接入某家CDN网络时，你可以通过信令服务器的注册界面进行注册。在注册界面中，一般要求填入CDN厂商的名字、分配比例、CDN API操作地址等信息。

比如，当某个主播要分享一个节目时，信令服务器首先根据分配比例决定使用哪个CDN网络，然后获得该CDN网络的API操作地址。获取到 CDN 网络的API操作地址后，它就可以调用该CDN网络提供的 HTTP/HTTPS API 进行操作了，创建域名、生成直播地址、生成拉流地址等等。有了这些地址后，就可以将音视频流推送到CDN网络，观众端获取到观看地址后就可以“观看”节目了。
<div><strong>精选留言（21）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/18/2b/0e/af0d53af.jpg" width="30px"><span>bigeast</span> 👍（9） 💬（1）<div>看接收端两帧之间的渲染间隔，大于某个阈值就记为一次卡顿。视频间隔可以比音频大一些。</div>2020-03-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/93/bd/f3977ebb.jpg" width="30px"><span>John</span> 👍（3） 💬（2）<div>请问老师 如果我要在APP里用webrtc做一个非视频的百人群聊功能 只使用p2p的连接 能实现么</div>2019-11-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/3c/8a/900ca88a.jpg" width="30px"><span>神经旷野舞者</span> 👍（2） 💬（1）<div>卡顿应该是帧延迟了，可以检测没秒传了几个，和服务器对一下，不过这样感觉计算量太大</div>2019-12-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/12/ce/a8c8b5e8.jpg" width="30px"><span>Jason</span> 👍（2） 💬（2）<div>我猜测，视频卡顿是因为帧数不足导致，所以可以通过统计用户播放的总帧数来统计。</div>2019-10-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg" width="30px"><span>piboye</span> 👍（1） 💬（1）<div>客户端直接推到多个cdn不合适吧？应该是服务端负责推送到多个cdn吧？</div>2020-12-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/5d/c1/81da96e4.jpg" width="30px"><span>王兵</span> 👍（1） 💬（2）<div>老师，您好！请教一下，目前做 线上网课，老师与学生交互的，您认为是 RTMP好 还是 WebRTC好？您认为 钉钉上课之类的，是 WebRTC吗？您是如何看待 腾讯视频 采用 webrtc 播放的，这是腾讯 对 flash被禁止 而采用的措施吗？谢谢您</div>2020-04-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/23/97/5d928f61.jpg" width="30px"><span>酸橙</span> 👍（1） 💬（1）<div>老师，请教下，如果是obs推流端网络抖动或闪断导致了卡顿，有什么好的解决方案吗？是否需要建立自己的媒体中心来保障输出连续的流,通过转码中心预留的缓存自动无缝拼接，跳过中间的空挡</div>2020-01-18</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eo2SjCeylLv0P3Glle5277kA4b8cAuxr1NrC0njPKEqzSpB8IEicHB29GicFFwG1qiaxs4hxRiaBmoibVw/132" width="30px"><span>阳仔</span> 👍（1） 💬（2）<div>这套支持万人的直播系统，没有使用 webRTC ? 可以通过 webRTC  实现么？成本会不会较大？</div>2019-11-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/d2/8a/57dcd0c7.jpg" width="30px"><span>峰</span> 👍（1） 💬（1）<div>老师，请教下，安卓是否可以做到边下载，边转码，边播放。达到类似直播的效果。原因是我们这边反馈服务端处理可能时间很长，想把细节处理的工作放到安卓端</div>2019-10-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/82/42/8b04d489.jpg" width="30px"><span>刘丹</span> 👍（1） 💬（2）<div>请问老师在实际使用中，OBS等工具能否把同一个直播流同时推送到多个CDN？常见的开源观众客户端是否支持自动切换CDN，还是我们要改播放端的代码手工切换呢？</div>2019-10-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/b1/c4/116bd611.jpg" width="30px"><span>Jocelyn</span> 👍（0） 💬（1）<div>老师您好 请教两个问题：1. 请问这个部分除了您在文章中罗列的 还有哪些需要记录呀？“每个用户使用 CDN 网络时必须要记录下来的信息”；2. 请问如何记录卡顿和卡顿原因呢？</div>2021-03-30</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKgA8bMuSpADm9UFL6qCTj8MVWVXkKfnC7Ou4NibASUCkricGlzPCncic0Akx8ibL85c2ubia8phTCMF6Q/132" width="30px"><span>Geek_d51f97</span> 👍（0） 💬（1）<div>cdn 流量使用多大时需要统计呢？ cdn也有日志，直接拿到 cdn 厂商的日志是否可信？</div>2021-03-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d6/b4/0808999d.jpg" width="30px"><span>白马</span> 👍（0） 💬（1）<div>李老师，腾讯课堂是在一对多的直播系统基础上改进的吗？</div>2020-09-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/72/07/60f6fb4c.jpg" width="30px"><span>平凡</span> 👍（0） 💬（1）<div>请问基于OBS定制化开发一个推流工具，类似直播姬、斗鱼伴侣这种需要哪些技术</div>2020-07-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/a5/85/a0ca71cd.jpg" width="30px"><span>天空之城</span> 👍（0） 💬（1）<div>老师，问一下webrtc获取的流如何推流到rtmp服务器进行直播</div>2020-06-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/45/63/005d03b2.jpg" width="30px"><span>QD账号</span> 👍（0） 💬（1）<div>老师，请问这块有没有一些监控手段或者开源监控系统可以起到监控作用？</div>2020-04-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/45/63/005d03b2.jpg" width="30px"><span>QD账号</span> 👍（0） 💬（2）<div>老师，我这边是采用nginx-rtmp搭建的rtmp服务，产品是多人视频聊天，现在遇到一个比较疑惑的问题，就是有是否会存在突然某一个人画面推送过去（因为其他人都收到他的画面），但是这个人的声音却有部分人没有收到。请问如果遇到这种问题怎么排查？</div>2020-04-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/03/d6/abb7bfe3.jpg" width="30px"><span>老马识途</span> 👍（0） 💬（2）<div>老师，开发这样一个万人直播系统，包含主播端，客户端，服务器端，大概需要个什么人力规模，需要多少的时间？</div>2020-02-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/2c/05/b8e769fa.jpg" width="30px"><span>Mickey</span> 👍（2） 💬（0）<div>最近一年在从事在线直播相关的前端开发，很长一段时间，对音视频完全不了解，有问题，只能两手一摊，我咩都唔知啊~~，现在学习完老师的课堂，对音视频有了小小的了解了，也算是一只脚指头踏进门！！加油ヾ(◍°∇°◍)ﾉﾞ</div>2020-09-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/76/2e/5fb3b586.jpg" width="30px"><span>付俊</span> 👍（0） 💬（0）<div>请问老师一个高并发的直播和会议系统，如何规划服务器的配置？</div>2022-09-10</li><br/><li><img src="" width="30px"><span>Geek_6d49f5</span> 👍（0） 💬（0）<div>老师，SEI信息 和音视频播放出来的对不上，有优化方法吗</div>2021-10-14</li><br/>
</ul>