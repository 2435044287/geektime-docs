在前面的 22 篇文章中，我分步骤向你介绍了如何在浏览器上实现一套简单的直播系统。比如，如何采集音视频数据，如何在同一个浏览器上进行音视频通话，如何传输非音视频数据，等等。

但这些知识点都是一个个独立的，并没有形成一个完整的系统，那么本篇文章我们就将所有这些知识点串联起来，做成一个完整的系统。当这套系统搭建完成之后，你就可以在浏览器上实现从北京到上海这种远距离的实时通信了。

接下来我们就来详述这套系统的实现步骤（运行环境的搭建，Web 服务器的实现，信令系统的实现，TURN 服务器的搭建，RTCPeerConnection的创建，音视频数据的采集、传输、渲染与播放）。通过这部分内容的讲解，再配合我们之前的文章，相信你一定可以快速搭建出这样一套系统来。

## 运行环境搭建

要实现这套系统，运行环境是特别关键的，其中有三个条件是必须要满足的：**云主机、2M以上的带宽**和**HTTPS证书**。

为什么需要这三个条件呢？下面我们就来详细看一下。

**云主机**就不必多说了，要实现远距离的音视频通信，就得进行信令的交换和数据的中转，这些都需要我们有一台云主机。换句话说，有了云主机后，通信的双方才可以进行信令的交换；在 P2P 不通的情况下，通过服务器中转的方式才能保障端与端之间的连通性。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/19/97/d2/daaed7d8.jpg" width="30px"><span>dahaowenge</span> 👍（4） 💬（1）<div>老师你好，前几节加入本地流用的addstream  获取远端流用的是onaddstream。这一节里用的是addtrack和ontrack，这两套写法有什么区别么</div>2019-10-31</li><br/><li><img src="" width="30px"><span>Geek_leo长沙</span> 👍（3） 💬（2）<div>老师，我要在移动端实现点对点呼叫，A呼叫B的时候，B能被动的拉起视频界面(B事先不知道A想和他视频)，我Android移动端是不是要有一个service服务一直在监听socketio的广播消息，例如在socket.on()监听协商好的指令，然后B在主动选择是否加入房间。不知道是否</div>2019-09-11</li><br/><li><img src="" width="30px"><span>Geek_ab346c</span> 👍（1） 💬（1）<div>老师你好，我下载了你的音视频通话那个，但是我运行了报错，http:&#47;&#47;file&#47;socket.io&#47;?EIO=3&amp;transport=polling&amp;t=NYh1GRl net::ERR_NAME_NOT_RESOLVED</div>2021-04-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/9d/d5/1f3bcb2e.jpg" width="30px"><span>微笑</span> 👍（1） 💬（2）<div>老师你好,我在局域网能实现1v1直播, 但是不同网络下有小概率能成功，请问是什么原因呢？</div>2021-03-21</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epHNuOTMIO9AmibXQ8ibsbAhYMiaYtBX7yI88zZHiakwc829S6iaerDFlqPvsySleQnm7yPCHCPyTZ1NAA/132" width="30px"><span>Geek_fe19fe</span> 👍（1） 💬（2）<div>老师，pcConfig中的主机、用户名、密码不是暴露出去了吗，这样别人也可以用，怎么保证安全呢</div>2021-01-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d6/b4/0808999d.jpg" width="30px"><span>白马</span> 👍（1） 💬（2）<div>李工你好，
我想在内网实现每个房间中都是多端（学生）向一端（老师）传输媒体流，只有老师端能看到所有学生的画面，学生只能看到自己的画面。在这种情况下：1. 还需要使用TURN和STUN服务器吗？2. 由于老师端无需传输媒体流数据，在代码实现上是否只需要教师端不向连接addTrack就可以？</div>2020-11-26</li><br/><li><img src="" width="30px"><span>Geek_015508</span> 👍（1） 💬（1）<div>老师好，麻烦请教一下，我的服务器是没有域名的，在服务器仅仅将turnserver.conf 中的ream设置为一个IP(如1.2.3.4)，在jsWebRTC中的iceServices仅仅配置为turn:1.2.3.4:3478 这样可否实现relay？</div>2020-04-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/9f/98/b6f20c10.jpg" width="30px"><span>王皓月</span> 👍（1） 💬（1）<div>老师您好，WebRTC是否支持浏览器端1对1语音通话，仅语音，不视频</div>2020-04-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/d2/39/a7edf2b9.jpg" width="30px"><span>Joseph</span> 👍（1） 💬（2）<div>老师我遇到了个新问题，就是createAnswer的时候生成的sdp中并没有candidate信息。配置的参数和您给的一样，只是修改为我的stun&#47;turn服务器地址。请问candidate信息的生成和什么参数有关系？</div>2019-09-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7b/10/57653969.jpg" width="30px"><span>wirerc</span> 👍（1） 💬（1）<div>老师，有个问题想请教一下，网页端支持播放avi格式视频，改怎么实现</div>2019-09-05</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLJYD17GibEy7EC1YQwCGlasA9tB3usZHWbW0tnkuCq6Y8bIuSyLWKstB0YZx6xPyUP8XHhKnJTZbw/132" width="30px"><span>bryantwhu</span> 👍（0） 💬（2）<div>coturn服务器与https服务器可以是不同的云服务器吗（都各自有固定的外网IP）</div>2021-01-15</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/aFAYPyw7ywC1xE9h1qibnTBwtWn2ClJqlicy5cMomhZVaruMyqSq76wMkS279mUaGhrLGwWo9ZnW0WCWfmMovlXw/132" width="30px"><span>木瓜777</span> 👍（0） 💬（1）<div>老师，你好。目前我的一端webrtc在内网，另一端浏览器在外网，那我部署的 stun服务器（具有公网ip），是否需要 可以直接访问 内网的机器 ？ 还是说 内网机器 可以 访问 stun服务器 就行？</div>2020-10-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/20/18/2b/be4a0024.jpg" width="30px"><span>Dream</span> 👍（0） 💬（1）<div>您好，我测试你的https:&#47;&#47;learningrtc.cn&#47;old_pc&#47;index.html案例没办法，只能做到同一个局域网下的一对一音视频通信，无法做到不同网络下（含手机4G网络）的音视频通讯。不知道你自己是否测试过？？请问下这是什么原因？？？</div>2020-08-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/f1/27/0472f5ff.jpg" width="30px"><span>童欧巴</span> 👍（0） 💬（2）<div>老师，video标签只能够通过srcObject接收stream嘛？有什么方式可以通过src 接收？一般开源的播放器都是只支持src引入url。如果只能通过srcObject接收的话，就只能自己封装播放器了。对吧？</div>2020-06-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/13/9a/c9125668.jpg" width="30px"><span>gonbcs</span> 👍（0） 💬（2）<div>老师您好！ 实现一对多可以不是我媒体服务器吗 一个发起端 多个接收端的场景</div>2020-06-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/86/2a/b5e76b33.jpg" width="30px"><span>罗志军</span> 👍（0） 💬（1）<div>老师，观看局域网的IPC流可以使用coturn这一套吗。
场景：公司有几台IPC，手机观看如果是内网就走内网，如果是外网就nat否则就转发。</div>2020-04-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/04/4a/356ce5e2.jpg" width="30px"><span>AA-DENNIS</span> 👍（0） 💬（3）<div>老师，我测试的时候，两个浏览器局域网可以一对一音视频，但是不同局域网就没法一对一音视频。有什么原因导致的呢？我做的修改有:1.main.js修改为指向阿里云搭建的coturn服务器。2:server.js配置了自己的key和crt.</div>2020-02-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/b4/ea/b3dca4dd.jpg" width="30px"><span>王乐</span> 👍（0） 💬（1）<div>启动node server.js，报错误，请老师给看下，错误信息如下：
&#47;usr&#47;local&#47;download&#47;node_modules&#47;streamroller&#47;lib&#47;RollingFileWriteStream.js:133
  async _shouldRoll() {
        ^^^^^^^^^^^

SyntaxError: Unexpected identifier
    at createScript (vm.js:56:10)
    at Object.runInThisContext (vm.js:97:10)
    at Module._compile (module.js:549:28)
    at Object.Module._extensions..js (module.js:586:10)
    at Module.load (module.js:494:32)
    at tryModuleLoad (module.js:453:12)
    at Function.Module._load (module.js:445:3)
    at Module.require (module.js:504:17)
    at require (internal&#47;module.js:20:19)
    at Object.&lt;anonymous&gt; (&#47;usr&#47;local&#47;download&#47;node_modules&#47;streamroller&#47;lib&#47;index.js:2:27)</div>2019-10-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/b3/c1/b96b5015.jpg" width="30px"><span>rookie</span> 👍（0） 💬（1）<div>必须使用云服务器吗？使用公司的实体服务器不可以吗？</div>2019-10-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/d2/8a/57dcd0c7.jpg" width="30px"><span>峰</span> 👍（0） 💬（2）<div>用官网https:&#47;&#47;webrtc.github.io&#47;samples&#47;src&#47;content&#47;peerconnection&#47;trickle-ice&#47;测试报如下错误
The server stun:xxx.xxx.x.xx:3478 returned an error with code=701:
STUN host lookup received error
老师是否知道，这大概率是由什么引起的吗？</div>2019-10-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/ca/52/b51aeed7.jpg" width="30px"><span>孤芳浪子</span> 👍（0） 💬（1）<div>你好，janus这个开源库，能作为server用吗？</div>2019-09-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/d2/8a/57dcd0c7.jpg" width="30px"><span>峰</span> 👍（0） 💬（1）<div>turnserver测试，结果如下
0: SQLite DB connection success: &#47;var&#47;lib&#47;turn&#47;turndb
179: IPv4. tcp or tls connected to: xxx.30.2xxx.112:57281
179: HTTPS connection has been disabled due Vulnerability in the Web interface !!!
179: session 001000000000000001: client socket to be closed in client handler: ss=0x7fcb180043a0
179: session 001000000000000001: closed (2nd stage), user &lt;&gt; realm &lt;xxxx.xyz&gt; origin &lt;&gt;, local xx.17.xx.9:3478, remote xxx.30.xxx.112:57281, reason: general是什么意思啊？</div>2019-09-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/d2/39/a7edf2b9.jpg" width="30px"><span>Joseph</span> 👍（0） 💬（1）<div>老师，是这样的，我现在在对接别人的服务，他们提供的sdp是包含candidate，那我这边是需要降低webrtc的版本吗？</div>2019-09-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/30/b3/527f84de.jpg" width="30px"><span>初音韶歌</span> 👍（0） 💬（1）<div>老师，请问怎么停止获取桌面与音频呢？我不需要将桌面与音频向外发送的时候总不能继续获取吧？</div>2019-09-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/d2/39/a7edf2b9.jpg" width="30px"><span>Joseph</span> 👍（0） 💬（2）<div>老师，现在我通过trickle-ice网站测试可以relay回地址，但通过通过浏览器访问IP：3478端口，显示访问不到网页，但是p2p通信是可以的。请问是什么问题呢？</div>2019-09-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/82/42/8b04d489.jpg" width="30px"><span>刘丹</span> 👍（0） 💬（1）<div>请问怎样查询房间号码或者名称列表？另外登录turn服务器时，客户端能否用自己的用户名和密码呢？</div>2019-09-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a0/3f/7b72c582.jpg" width="30px"><span>强子</span> 👍（0） 💬（0）<div>你好老师，我想问几个问题，主要是关于coturn在内网使用的问题
1：如果内网中的两个主机的ip互通(网段不通)，是不是可以不用coturn

2：coturn在内网部署，且没有公网ip的情况下，那个外网ip参数要如何处理？</div>2023-01-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2e/27/b4/df65c0f7.jpg" width="30px"><span>| ~浑蛋~</span> 👍（0） 💬（0）<div>为啥&#47;socket.io&#47;EIO这个接口调用返回400状态码</div>2022-09-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/25/2e/d7/f1d58093.jpg" width="30px"><span>沃思故我在</span> 👍（0） 💬（0）<div>老师，这种问题咋解决呀 error: ENOENT: no such file or directory, open &#39;.&#47;cert&#47;1557605_www.learningrtc.cn.key&#39; </div>2022-04-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/87/8e/d155ab63.jpg" width="30px"><span>Cherry</span> 👍（0） 💬（0）<div>老师，你好，配置coturn服务器，必须要设置relam域名吗？relam设置为云服务器外网ip地址可以吗？</div>2021-12-21</li><br/>
</ul>