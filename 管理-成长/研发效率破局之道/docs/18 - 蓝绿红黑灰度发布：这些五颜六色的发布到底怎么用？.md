你好，我是葛俊。今天，我来和你聊聊最近流行的一些部署、发布方法，以及测试右移。

最近几年，我见到了很多跟颜色相关的部署、发布方法，比如蓝绿部署、红黑部署、灰度发布等。今天，我会首先与你分享它们的基本定义和要解决的根本问题；然后，与你一起深入看一看高效应用这些方法的基本原则，以及一些具体的实践。

## 各种部署方式的定义

我们先来看看蓝绿部署（Blue-green Deployment）、红黑部署（Red-black Deployment）和灰度发布（Gray Release ，或 Dark Launch）的定义和流程吧。

### 蓝绿部署

蓝绿部署，是采用两个分开的集群对软件版本进行升级的一种方式。它的部署模型中包括一个蓝色集群A和一个绿色集群B，在没有新版本上线的情况下，两个集群上运行的版本是一致的，同时对外提供服务。

系统升级时，蓝绿部署的流程是：

- 首先，从负载均衡器列表中删除集群A，让集群B单独提供服务。
- 然后，在集群A上部署新版本。
- 接下来，集群A升级完毕后，把负载均衡列表全部指向A，并删除集群B，由A单独提供服务。
- 在集群B上部署完新版本后，再把它添加回负载均衡列表中。

这样，我们就完成了两个集群上所有机器的版本升级。

### 红黑部署
<div><strong>精选留言（6）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/75/9b/611e74ab.jpg" width="30px"><span>技术修行者</span> 👍（7） 💬（2）<div>你觉得金丝雀发布可以用在移动端应用或者桌面应用上吗？如果可以的话，大概要怎么实现呢？

首先，我们目前一般都在采用红黑部署的模式，对于不重要的更新，偶尔会尝试灰度部署。灰度部署可能对于互联网类型的大流量高并发的应用更有意义，因为它们会涉及到更多的资源，灰度发布会更节省资源。

我理解金丝雀发布这种方式并不会和某种应用类型绑定，之所以在Web应用中流行，是因为对于用户来说，Web类型的应用，只需要在用户端安装浏览器即可，不需要有额外的配置，所有的安装部署全部在服务器端进行，更容易控制。

如果在移动端或者桌面端实施这一部署方式，需要1. 筛选种子用户，发送版本更新消息，并提供更新途径。2. 用户更新版本后，收集用户使用情况，评估新版本是否达到预期目标。3. 根据评估结果，决定是否升级版本或者回滚。

种子用户的维护比较重要，一般会先从内部用户开始逐渐扩展。

无论哪种类型的应用，采用金丝雀的方式进行部署，都会对监控提出更高的要求。</div>2019-10-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/e4/a1/178387da.jpg" width="30px"><span>25ma</span> 👍（1） 💬（1）<div>中午知道蓝绿红黑灰的使用场景和定义，非常受用</div>2020-03-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/92/8a/e86a8db7.jpg" width="30px"><span>文中</span> 👍（0） 💬（1）<div>我们通过 A&#47;B Test 框架来实现移动端应用的金丝雀发布。具体的方式就是，A&#47;B 的流量划分模块指引逻辑的路由，不同流量背后的实验定义完全参数化，这样就有办法通过后端的配置来控制前端行为。这种思想对于：
- 待上线新功能进行内部 dog-food、线下试运营、灰度发布
- 对有特殊情况的真实用户，调整系统的业务处理逻辑
- 在并行自动化测试中，隔离其他测试用例或设置的影响
- 生产环境回归测试

都可以用到。</div>2020-04-14</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLw3jpao45frZibQIAicWBfc7ofgrm5gJLiaFQSj5u2DDvkjy3ia5goicJLJlgVtZ0HryiaXb2VqpTSQT5Q/132" width="30px"><span>lisa</span> 👍（0） 💬（1）<div>在生产环境下做集成测试提到了两个方法对于写用例的成本太高了，尤其是测试同学来写集成用例，因为涉及到和被测系统的联动，比如识别测试标签，识别后可能会根据测试点需要做不同的处理，感觉很难落地，facebook在这块落地上有遇到什么困难，怎么解决的，可以详细说说么？</div>2019-10-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/f0/6d/3e570bb8.jpg" width="30px"><span>一打七</span> 👍（0） 💬（0）<div>文中提到发布阶段的监控很重要，那老师之前说很多大公司的发布流程可以做到分钟级别，想咨询下他们的监控环节是怎么处理的？按理说这么短的时间也监控不到有效的信息，比如监控的波形图也不会有明显的变化</div>2023-10-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/46/c0/106d98e7.jpg" width="30px"><span>Sam_Deep_Thinking</span> 👍（0） 💬（0）<div>这篇是这个专栏里的精品文章，写的很好，优秀。</div>2019-12-08</li><br/>
</ul>