你好，我是郑晔。

在上一讲中，我向你说明了为什么程序员应该写测试，今天我准备与你讨论一下程序员应该在什么阶段写测试。

或许你会说，写测试不就是先写代码，然后写测试吗？没错，这是一个符合直觉的答案。但是，这个行业里确实有人探索了一些不同的做法。接下来，我们就将进入不那么直觉的部分。

既然自动化测试是程序员应该做的事，那是不是可以做得更极致一些，在写代码之前就把测试先写好呢？

有人确实这么做了，于是，形成了一种先写测试，后写代码的实践，这个实践的名字是什么呢？它就是测试先行开发（Test First Development）。

我知道，当我问出这个问题的时候，一个名字已经在很多人的脑海里呼之欲出了，那就是**测试驱动开发（Test Driven Development）**，也就是大名鼎鼎的 **TDD**，TDD 正是我们今天内容的重点。

在很多人看来，TDD 就是先写测试后写代码。在此我必须澄清一下，这个理解是错的。先写测试，后写代码的实践指的是测试先行开发，而非测试驱动开发。

下一个问题随之而来，测试驱动开发到底是什么呢？测试驱动开发和测试先行开发只差了一个词：驱动。只有理解了什么是驱动，才能理解了测试驱动开发。要理解驱动，先来看看这两种做法的差异。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/13/8d/b4/ff82483d.jpg" width="30px"><span>邵俊达</span> 👍（49） 💬（3）<div>最近在一个新项目中尝试使用了 TDD 有测试保驾护航是真的爽。事情是这样的，今天经过讨论要把一个模型替换掉，刚听到这个消息的时候我是崩溃的，心想这要是出 bug 怎么办，到转念一想我测试覆盖率 88% 应该还好，动手改完跑起测试，果然不过，但是只是几个叫小问题，再次运行测试 绿灯！我的天，此时内心别提多么舒爽，这要是没有测试我今晚应该不用睡了，谢谢老师。最近也开始先分解任务再小步提交，这么做下来有一种很踏实的感觉，同事 review 代码也舒服很多。</div>2019-04-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/f2/f2/2a9a6e9a.jpg" width="30px"><span>行与修</span> 👍（14） 💬（1）<div>测试驱动不但可以写出精炼的代码，还能养成良好的编程习惯和设计思维， 相辅相成。
团队达到这种状态还真是不易，架子搭好了有人觉得没发挥空间，要是放开了代码又会五花八门难以测试。莫名有种担心，会不会为了测试而测试在代码里混搭着workaround 呢?</div>2019-01-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/08/17/e63e50f3.jpg" width="30px"><span>彩色的沙漠</span> 👍（11） 💬（1）<div>阅读之后有了基本的认知，还需要阅读这方面的相关书籍和实践</div>2019-01-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/d6/46/5eb5261b.jpg" width="30px"><span>Sudouble</span> 👍（9） 💬（1）<div>之前在其他领域的里也有介绍负反馈相关单位内容，各个领域之间还是有很多互通之处。软件或者其他系统一直处于熵增的状态，需要持续的保养和维护。不得不感慨大道至简啊</div>2019-02-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/43/e1/b7be5560.jpg" width="30px"><span>sam</span> 👍（7） 💬（1）<div>学完这篇，真正了解了TDD，以前一直凭直觉理解TDD是完善测试驱动开发，现在发现最根本是驱动代码设计。</div>2020-07-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/48/ee/96a7d638.jpg" width="30px"><span>西西弗与卡夫卡</span> 👍（7） 💬（1）<div>印象最深的几次TDD。
1. 是个CS应用，从服务端拉取数据后，根据不同状态，客户端执行不同逻辑。采用的方法是，将服务端的响应值记录，然后在测试代码里回放，不依赖服务端。修bug时，每个bug就是一个测试，测试代码里直接回放记录的服务端响应。好处是，回归非常快，而且不依赖服务端
2. 上家公司要做HA软件开发，情况很复杂，手工做测试代价很高。正好赶上docker兴起，于是就写了很多“暴力”代码（比如直接kill服务、删除服务等）测试各种场景，只留少数必须用物理机测试的场景交给人工</div>2019-01-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a4/20/dd6f568c.jpg" width="30px"><span>红糖白糖</span> 👍（5） 💬（2）<div>TDD，和任务分解可以说是相辅相成。
在写测试的时候，一个一个的case其实在对任务的分解，考虑每个case所要达到的目标，输入、输出，以及case与case之间的衔接。写测试的时候，我们是站在一个consumer的角度来的，考虑的是这个case的输入和输出。首先，这对于设计能力有一定的要求，其次，按照这种方式写出来的代码可用性更高。因为我们的起点是consumer 而不是provider</div>2019-03-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/42/4f/ff1ac464.jpg" width="30px"><span>又双叒叕是一年啊</span> 👍（5） 💬（1）<div>好感动哭了</div>2019-01-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg" width="30px"><span>escray</span> 👍（3） 💬（1）<div>之前在学习 TDD 的时候，确实忽略了“驱动”的概念，而且也有很多时候，根本驱动不起来。

从测试先行开发，通过重构，成为测试驱动开发，进而成为测试驱动设计。

以前似乎也忽略了重构，只注意“红-绿”的节奏，而把重构当做了测试驱动开发之外的一个动作，其实重构，或者说是小规模的重构，应该是 TDD 的应有之意。

这个任务分解的模块，其实更多的讲的是 TDD，准备把《测试驱动开发》也一并读一下。</div>2020-06-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ed/9a/bbeec5bb.jpg" width="30px"><span>liu</span> 👍（3） 💬（2）<div>以前以为测试驱动开发只是先写测试，再开发就完了。原来还有重构。想想也对。代码第一步完成功能表达，但未经重构的代码必然存在坏味道。重构，才能使代码机构清晰，便于理解阅读</div>2019-01-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/32/09/669e21db.jpg" width="30px"><span>wesleydeng</span> 👍（2） 💬（1）<div>对于开发者自测，有什么比较好的书籍推荐么？现在对于不同层次的测试感觉还是没有一个章法，有点乱，怎样可以提高自测的效率？</div>2020-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/3b/90/e8982641.jpg" width="30px"><span>小一</span> 👍（2） 💬（1）<div>PowerMock框架是可以支持mock static类和方法的</div>2019-06-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7b/98/8f1aecf4.jpg" width="30px"><span>楼下小黑哥</span> 👍（2） 💬（1）<div>以前理解的测试驱动开发，我写完测试、代码完成就结束了。看完文章，增加对重构理解。有了测试的依托，改动代码的结果也能从测试结果中看出。
目前对于 TDD 还是处于理解状态，不知道如何真正的在项目工程中使用。因为项目工程往往还有很多其他调用，如rpc，数据库服务，第三方服务，不知道在这个过程如何处理。期待老师的之后文章讲解</div>2019-01-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/d4/78/66b3f2a2.jpg" width="30px"><span>斯盖丸</span> 👍（1） 💬（1）<div>老师我有个困扰多时的问题，ETL的任务该怎么测？都是SQL语句的CRUD，语法肯定没问题，但是对最终结果表的正确性却只能每天人工核对，真的感觉又累又傻。针对这样的数据开发有什么自动测试的最佳实践吗？</div>2021-02-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/37/3b/495e2ce6.jpg" width="30px"><span>陈斯佳</span> 👍（1） 💬（1）<div>老师，运维写脚本也需要考虑测试吗？</div>2019-07-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/43/2d/af86d73f.jpg" width="30px"><span>enjoylearning</span> 👍（1） 💬（1）<div>今天又被作者引入了测试先行的开发理念，一直觉得Tdd不一定要先写测试，完成功能代码再写测试也可以啊，用单元测试去验证写的逻辑，发现测试失败了，回去看代码实现，绿了再回去看代码坏味道。</div>2019-03-28</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/v5gEtVWR1F0vNQibpxN5Ga9GHGkFWoLQqxwXPh4JPx9RTmSN32lWHcswozic659h4hoibYxnNW3iayWC3zQV0hxXOQ/132" width="30px"><span>ZackZzzzzz</span> 👍（1） 💬（1）<div>老师如果有机会的话，谈一谈对不同层面测试的理解吧。

我们现在的后端代码库大概有三种层面的测试
1.单元测试 - 对某个类的测试
2.系统测试 - 测试service之间的interaction
3. 我们还有一个container test, 测试方法是mock所有的external dependency数据库也好，其他的服务也好，这样能保证负责的业务逻辑从头到尾的结果

老师你对测试的理解是怎么样的？什么应该被测试，大概投入多少比例
</div>2019-01-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c0/3c/37aa8945.jpg" width="30px"><span>chaoqiang</span> 👍（1） 💬（1）<div>“作者回复: 你可以看一下 Martin Fowler 的《重构》（https:&#47;&#47;book.douban.com&#47;subject&#47;4262627&#47;），2018年第二版的英文版也已经出版了，其中文版的译者还是第一版的译者熊节。”：重构第二版这本书期待很久了，但这本书好像目前国内购买途径还比较少，Amazon 上价格特别贵。想咨询下老师，怎么看待技术书（尤其是英文版）普遍价格高昂的现象呢，另外，针对新书有什么性价比高的途径购买呢</div>2019-01-28</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/ibZVAmmdAibBeVpUjzwId8ibgRzNk7fkuR5pgVicB5mFSjjmt2eNadlykVLKCyGA0GxGffbhqLsHnhDRgyzxcKUhjg/132" width="30px"><span>pyhhou</span> 👍（1） 💬（1）<div>感谢老师指点，之前没听过 TDD，但是知道 Unit Test 很重要，要随着写代码一起写，也没想过原来可以先写 test，后实现 code，这样 test 很自然地时刻存在在开发的每一个阶段。在 TDD 里面 “红——绿——重构” 中，看完老师这边文章对其中的 “红” 和 “绿” 都能理解，因为就是写 code，保证 code 可测并且能够通过所有 test，但是对这里的 “重构” 还是比较地困惑，“重构” 很重要，那么这里有没有什么方向性或者方法可言呢，因为仅仅看 “重构” 的定义，貌似和 test 没有直接的联系，test 只是保证能够更好的 “重构”，文章中只说了 “重构” 是为了消除 “冗余”，消除代码的 “坏味道”，那什么是 “冗余”，什么是 “坏味道”，具体该怎么定义 “重构” 需要解决的问题呢？还有 “重构” 怎样才能更好地执行呢？谢谢老师</div>2019-01-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d2/f8/d5006178.jpg" width="30px"><span>闻人</span> 👍（0） 💬（1）<div>TDD中**驱动**的两层含义：
1. 利用测试用例驱使已实现的代码质量不断提高
2. 由于测试用例驱使我们思考如何编写具有更易测试的代码</div>2021-07-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/88/c8/6af6d27e.jpg" width="30px"><span>Y024</span> 👍（0） 💬（1）<div>原来理解的是测试先行开发（有时基于代码检查会做些被动的重构），离真正的测试驱动开发少了重要的主动重构环节。</div>2020-11-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/d7/a9/f341b89c.jpg" width="30px"><span>azurepwq</span> 👍（0） 💬（1）<div>老师我有一个问题：如果一个人重构运用的很熟练，那么他肯定能慢慢地变得能写出一些不需要重构的或者很少需要重构的代码。如果把这个问题想得极端一点，一个人的代码，如果写得不需要重构，或者代码想要重构得更好很难，那么这些不需要重构或者很难变得更好的代码，会不会成为代码维护者的负担呢？ 这里涉及到一个问题：有最好的代码吗？有不需要重构的代码吗？请老师解惑，谢谢啦。</div>2020-11-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/05/dd/b201cf13.jpg" width="30px"><span>Alexis何春光</span> 👍（0） 💬（1）<div>请问为什么“一旦放任 static 的使用，就会出现和全局变量类似的效果，你的程序崩溃了，因为别人在另外的地方修改了代码，代码变得脆弱无比。”？ 一般来说，别人修改代码，应该不改变输入和输出，所以不会受到影响。而如果改变了输入和输出，就算是实例方法也会break吧？</div>2020-05-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ed/91/1d332031.jpg" width="30px"><span>我能走多远</span> 👍（0） 💬（1）<div>测试驱动开发的精髓是第三步重构。最近也是做一个业务测试。发现最初的修改只是通过代码中加特殊的判断去规避了这个问题。在影响性测试中发现，正常的处理逻辑完全满足了这种业务场景。只是我们在当前场景中少置为了一个标记。导致下游不识别。在正常业务流程中增加这个标示完全解决问题。这就是重构的精髓
</div>2019-12-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/5b/08/b0b0db05.jpg" width="30px"><span>丁丁历险记</span> 👍（0） 💬（1）<div>可测的代码往往符合类的单一原则。</div>2019-11-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ae/da/14be2908.jpg" width="30px"><span>lu4nx</span> 👍（0） 💬（3）<div>有时别人写的文档比较模糊时，我会直接看测试用例去了解接口怎么用。</div>2019-06-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/f0/6a/a1725251.jpg" width="30px"><span>lyning</span> 👍（0） 💬（1）<div>TDD 还需要事先分析和任务分解，不然就变成为了 TDD 而 TDD 了</div>2019-03-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/df/03/6613bd63.jpg" width="30px"><span>姜浩远</span> 👍（0） 💬（2）<div>测试清单可以和DoD联系起来么？</div>2019-02-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/c1/57/27de274f.jpg" width="30px"><span>萧</span> 👍（0） 💬（1）<div>不久前第一次接触TDD时为它的思想而惊叹，感觉它能极大的提升编码效率，编码后期的大量重构，还能保障代码质量。后面自己在写代码的时候也注意使用它的思想，但说实话，理解是一回事，用起来就不是那么回事了，很多的东西还不是太熟练，前期说实话比较耗时间，有些拖进度。由于也毕业不久，经验上有些欠缺，还不太熟练，有些测试还不知道怎么写。现在写多了一点，感受到的是代码质量上的提高，bug比起以前少了，需求变更下也改动也不伤筋动骨了，但还是有许多感觉做的不够好的。看了这篇文章，给了一个补充TDD的认知，感受到如果和任务分解结合起来会有更好的效果，期待后面的文章！</div>2019-01-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg" width="30px"><span>ifelse</span> 👍（0） 💬（0）<div>学习打卡</div>2024-07-11</li><br/>
</ul>