你好，我是吴磊。

如果你也在北京生活，那小汽车摇号这件事大概率也和你息息相关。我身边很多人也一直都和我抱怨说：“小汽车摇号这件事太难了，遥遥无期，完全看不到希望，感觉还没买彩票靠谱呢”。

实不相瞒，我自己也在坚持小汽车摇号，在享受8倍概率的情况下，还是没能中签。因此，包括我在内的很多人都想知道，为什么摇号这么费劲？一个人平均需要参与多少次摇号才会中签？中签率的变化趋势真的和官方宣布的一致吗？倍率这玩意儿，真的能提高中签的概率吗？

这些问题，我们都能通过开发一个北京市小汽车摇号趋势分析的应用来解答。我会用两讲的时间带你完成这个应用的开发，在这个过程中，我们可以把前面学过的原理篇、通用调优篇和Spark SQL调优篇的大部分知识都上手实践一遍，是不是一听就很期待呢？

话不多说，我们赶紧开始吧！

## 课前准备

既然是做开发，那我们就需要做一些准备工作。准备工作分为3部分，分别是准备数据、准备开发环境和准备运行环境。

### 准备数据

应用所需的数据，我已经帮你准备好，也上传到了网盘，你可以点击[这个地址](https://pan.baidu.com/s/1Vys1Z1mofQFoU52ye7SKuw)，输入提取码**ajs6** 进行下载。

数据的文件名是“2011-2019小汽车摇号数据.tar.gz”，解压之后的目录结构如下图所示。根目录下有apply和lucky两个子目录，apply的目录内容是2011-2019年各个批次参与摇号的申请编号，lucky目录包含的是各个批次中签的申请编号。方便起见，我们把参与过摇号的人叫“申请者”，把中签的人叫“中签者”。apply和lucky的下一级子目录是各个摇号批次，而摇号批次目录下包含的是Parquet格式的数据分片。  
![](https://static001.geekbang.org/resource/image/74/4f/7472040477c9b7756102890f2819284f.jpg?wh=2799%2A2112 "数据的文件目录结构")
<div><strong>精选留言（6）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/25/81/9f/4a3b7807.jpg" width="30px"><span>猪猪</span> 👍（6） 💬（2）<div>吴磊老师好~
默默学了老师的课程，哈哈这节课关注点完全在为啥我没中签了。关键还是我和老公两个8倍率摇号都不中，这大概只能怪人品了呢。。。
官方的倍数太简单粗暴了，我觉得可以考虑用指数方式进行放大摇号时间长的人的倍数。两个初步想法，应该还得更多考虑公平再加细化。
(1)倍率=EXP(LOG2(MAX(1,累计摇号期数-MagicNum))。
经初步计算，假设MagicNum为36，摇号71期的可以有1.1%的中签率；MagicNum为48，摇号71期的可以有3.3%的中签率；MagicNum为60，摇号71期的可以有3.8%的中签率。
(2)倍率=100.0*sigmoid(累计摇号期数-MagicNum)。其中sigmoid=1&#47;(1+exp(-z))为常用的函数,它的取值范围(0,1)。
为了保证总参与摇号样本数不至于过多还可以考虑同比例缩小倍数等等。初步尝试添加一些权重换算后发现这两种方法都可以把摇号很久的概率提高到百分之几。

另外老师我想请问下，所有批次一起统计官方倍率下中签率会不会是幸存者偏差导致的正态分布，因为中签的后面批次就不参与摇号了。我统计每一批次官方倍数下中签率，除了13，12倍数据基数太小不满足统计规律外，整体中签率确实是倍数越高中签率越高的。但是其实高那么零点几百分比完全无效哈哈。我用sql把意思写在下面，希望老师指正。
批次  倍数   参与人数  中签人数  中签率
201906  13  47      0    0.000%
201906  12  81094   338  0.417%
201906  11  102792  436  0.424%
201906  10  142112  530  0.373%
201906  9   235860  789  0.335%
201906  8   248556  712  0.286%
201906  7   263499  677  0.257%
201906  6   378509  829  0.219%
201906  5   407661  746  0.183%
201906  4   381066  585  0.154%
201906  3   362343  391  0.108%
201906  2   359586  244  0.068%
201906  1   372312  107  0.029%
# 1. 统计每一批次官方倍数下中签率
SELECT aa.batchnum,
       aa.times,
       count(*) all_num,
       count(bb.carnum) AS lucky_num,
       count(bb.carnum)&#47; count(*) AS ratio
FROM
  (SELECT a.batchnum,
          a.carnum,
          count(*) AS times
   FROM apply a
   GROUP BY a.batchnum,
            a.carnum) aa
LEFT JOIN lucky bb ON (aa.carnum = bb.carnum
                       AND aa.batchnum = bb.batchnum)
GROUP BY aa.batchnum,
         aa.times;</div>2021-09-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/d4/78/66b3f2a2.jpg" width="30px"><span>斯盖丸</span> 👍（3） 💬（1）<div>倍率对于中签的贡献微乎其微十分反常识和直觉呀。。。难道是因为日期越近的人他们的隐藏权重也越高，所以和倍率抵消了么。。？</div>2021-05-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/65/0f/7b9f27f2.jpg" width="30px"><span>猿鸽君</span> 👍（2） 💬（1）<div>从倍率的实现方式来看，感觉就是设计者懒而已。简单的应该可以根据参与次数再计算一个倍率系数，而不是单纯的递增。</div>2021-08-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/df/e5/65e37812.jpg" width="30px"><span>快跑</span> 👍（2） 💬（1）<div>已经不关心spark了。完全沉浸在为什么我没摇中</div>2021-05-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/ea/23/508f71e3.jpg" width="30px"><span>Jefitar</span> 👍（0） 💬（1）<div>之前在阿里云买的服务器搭建的集群，太贵了，释放了，现在用台式机搞了64G内存，创建了4台虚拟机搭建了集群，晚上到家跑一下，想想怎么优化，然后再看下一章！😄</div>2021-06-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/ea/23/508f71e3.jpg" width="30px"><span>Jefitar</span> 👍（0） 💬（1）<div>买新能源汽车啊，哈哈哈哈</div>2021-06-09</li><br/>
</ul>