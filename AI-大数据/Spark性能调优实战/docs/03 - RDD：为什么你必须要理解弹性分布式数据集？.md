你好，我是吴磊。

从今天开始，我们进入原理篇的学习。我会以性能调优为导向，给你详细讲讲Spark中的核心概念RDD和DAG，以及重要组件调度系统、存储系统和内存管理。这节课，咱们先来说说RDD。

RDD可以说是Spark中最基础的概念了，使用Spark的开发者想必对RDD都不陌生，甚至提起RDD，你的耳朵可能都已经听出茧子了。不过，随着Spark开发API的演进和发展，现在上手开发基本都是DataFrame或Dataset API。所以很多初学者会认为，“反正RDD API基本都没人用了，我也没必要弄明白RDD到底是什么。”

真的是这样的吗？当然不是。

## RDD为何如此重要

首先，RDD作为Spark对于分布式数据模型的抽象，是构建Spark分布式内存计算引擎的基石。很多Spark核心概念与核心组件，如DAG和调度系统都衍生自RDD。**因此，深入理解RDD有利于你更全面、系统地学习Spark的工作原理。**

其次，尽管RDD API使用频率越来越低，绝大多数人也都已经习惯于DataFrame和Dataset API，但是，无论采用哪种API或是哪种开发语言，你的应用在Spark内部最终都会转化为RDD之上的分布式计算。换句话说，**如果你想要在运行时判断应用的性能瓶颈，前提是你要对RDD足够了解**。还记得吗？定位性能瓶颈是Spark性能调优的第一步。
<div><strong>精选留言（22）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/13/47/ba/d36340c1.jpg" width="30px"><span>Shockang</span> 👍（60） 💬（1）<div>RDD的5大特性总结起来就是：3个列表，2个函数。3个列表是分区列表，依赖列表和优先位置列表；2个函数就是：计算函数和分区函数。我这样总结是为了方便记忆的，分享给大家！</div>2021-03-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/63/6e/6b971571.jpg" width="30px"><span>Z宇锤锤</span> 👍（25） 💬（3）<div>RDD的四大特性：两横两纵一漂移。两纵土豆每一个生产线的流转就是父RDD到子RDD的流转，其中的流转方法就是compute算子。两横：就是土豆和土豆片之间的工具，切出来的土豆片就是partitions,怎么切土豆片就是partitoner。漂移就是prefered location,选择在哪个RDD上取数据。</div>2021-03-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/42/f3/e945e4ac.jpg" width="30px"><span>sparkjoy</span> 👍（18） 💬（4）<div>preferredLocations不起作用的场景有一种是存算分离的场景，计算节点在k8s集群里，远程读取分布式文件系统，例如hdfs或者ceph等，可能接入万兆SDN网络能够有一些收益</div>2021-03-23</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/IcDlyK6DaBrssVGlmosXnahdJ4bwCesjXa98iaapSDozBiagZTqSCok6iaktu2wOibvpNv9Pd6nfwMg7N7KTSTzYRw/132" width="30px"><span>慢慢卢</span> 👍（8） 💬（1）<div>读了两遍，开始不太理解容错和Resilient 有什么关系，读了两遍，有点感觉了：弹性描述物体在压缩和拉伸之后具备恢复原状的能力。类比RDD，rdd因为依赖和compute，具备了错误恢复能力，把这个性质称之为弹性。</div>2021-06-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/42/f3/e945e4ac.jpg" width="30px"><span>sparkjoy</span> 👍（7） 💬（1）<div>老师，spark是惰性计算，action算子才能真正触发算子的计算逻辑，那么DAG（rdd的实例化以及dependency对象的创建）是什么时候构建的呢？没找到DAG创建的代码入口</div>2021-09-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/20/bd/5656b5d7.jpg" width="30px"><span>走刀口 💰</span> 👍（5） 💬（1）<div>老师，请教个问题，关于宽窄依赖划分。网上很多文章是根据父子rdd分区数量划分的，但我这样不对。比如cartsian算子，它父rdd一个分区对应子rdd多个分区，可它是窄依赖。
宽窄依赖划分依据到底是啥？</div>2021-03-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a2/4b/b72f724f.jpg" width="30px"><span>zxk</span> 👍（4） 💬（3）<div>preferredLocations，作业尽可能在在数据所在节点上运行，或者同个机架下等情况，都可以提升 I&#47;O 效率。
当数据不管落在哪个节点，都需要从远端拉取数据时，这时候作用可能就不是那么大。</div>2021-03-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/90/93/5e94be87.jpg" width="30px"><span>钝感</span> 👍（3） 💬（1）<div>刚开始听的时候：“什么土豆工坊？什么土豆片，什么形态，什么流水线，什么加工方法？”这都是啥啊。。再往后听，我的天！！这形容比喻也太贴切了吧！！👍，虽然已是深夜，但还是从床上起了起来，边吃薯片边听，我要听一宿，我要学习！！！🙈</div>2021-10-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/b8/ae/085484e7.jpg" width="30px"><span>Insomnia</span> 👍（3） 💬（1）<div>老师, 我这么理解不知道对不对? 
当下比较流行的计算框架 Spark&#47;Flink, 如果使用 Yarn 来调度计算任务, 对于 Yarn 而言, 本地的 Spark&#47;Flink 都可以看作是 Yarn 的客户端, 而对于用户而言, 编写的 job 都可以看做是本地的 Spark&#47;Flink 的客户端,  他们共同的本质都是使用本地 Spark&#47;Flink, 将用户的 job 解析并优化成物理执行计划, 然后提交到 Yarn 上部署执行</div>2021-03-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/23/85/e19f8833.jpg" width="30px"><span>tony</span> 👍（2） 💬（1）<div>纯算分离 有 计算节点+oss，所有计算节点从oss访问数据，网络io代价差不多。为了加速计算节点访问速度，还会在计算节点上加个缓存。

所以当计算节点访问数据不在cache，那么preferecneLocations应该就不起什么作用了。这么理解对吗？</div>2021-09-04</li><br/><li><img src="" width="30px"><span>林建林</span> 👍（2） 💬（1）<div>preferredLocations：可以理解为最佳位置，移动计算不移动数据，数据在哪就在哪计算，减少IO</div>2021-03-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/63/6e/6b971571.jpg" width="30px"><span>Z宇锤锤</span> 👍（2） 💬（2）<div># 关于RDD的单机思维模式
## RDD中的集合排序问题
RDD.collect.sort
</div>2021-03-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/65/75/f9d7e8b7.jpg" width="30px"><span>L3nvy</span> 👍（2） 💬（8）<div>1. “单机模式”，不知道算不算。不知道Spark可以开多线程触发action算子，同时提交多个不相关的作业，Spark UI同时运行的job拉满 : )。之前代码都是按面向过程的思维一步一步写的。
2. 处理数据源的时候，jdbc，读取本地文件不起作用
</div>2021-03-19</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIiaeebUYxl7e4jicPshDRKMbiculHUjKgZZ2ygDibn2S7bbsjeqYIdsEUdVyoryKNa43ZGnDQmWjv3ibQ/132" width="30px"><span>Geek_d794f8</span> 👍（1） 💬（1）<div>老师，如果计算和存储分离，比如计算集群A，存储集群B，且spark计算基于yarn调度，那么是不是，yarn集群必须部署在集群A上？</div>2021-03-25</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erqPQcbrNpo7UcKiaDpNbPaaV1A2TIprO7ryaVL3XaG89zhP5uibv7HuApkQDoaibPS7JGnNqP4ykFIg/132" width="30px"><span>一群孤儿</span> 👍（0） 💬（2）<div>RDD里面装的是数据吗? 一个spark任务有几个RDD?
</div>2021-07-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/37/d0/26975fba.jpg" width="30px"><span>西南偏北</span> 👍（0） 💬（2）<div>1. 单机思维，在RDD&#47;Dataset后面的map函数中使用了HashMap，哈哈
2. 除了计算分离、单节点计算之外，还有一种情况，比如我申请了5个Executor，但因为资源的问题，导致这5个Executor全部启在了同一个节点上。</div>2021-05-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/95/46/1cd5ab5f.jpg" width="30px"><span>弦断觅知音</span> 👍（0） 💬（1）<div>preferredLocations不起作用情况之一，比如有单独机器作为集群的客户端，然后提交的任务在集群的客户端上运行，这种情况算不算？</div>2021-03-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/91/56/f714ad14.jpg" width="30px"><span>老A</span> 👍（0） 💬（1）<div>preferredLocations 不起作用，应该在数据源是单节点情况，比如socket数据源，还有就是读取hdfs的数据块比较小不足一个split分片128M的情况，还有就是大的压缩数据块，比如snappy压缩，这种压缩不支持切分的情况。</div>2021-03-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/d0/0b/6504c7b1.jpg" width="30px"><span>geegeek</span> 👍（1） 💬（0）<div>现在公司很多都是使用对象存储的，因为能节省成本，这也是云厂商的解决方案，preferredLocations这个参数对于这种“存算分离”的场景是无法生效的，因为无论如何在计算前都需要拉取数据。用对象存储的话，我观察到的现象是sparkui里显示的都是process_local，但其实我估计是把数据拉取到了本地的原因，还是有网络开销的。所以近期比较火的数据湖就对这种云原生的场景支持比较好，数据湖的元数据就类似一个二级索引，读取的时候先看元数据里的统计信息，再去决定是否要真的拉取数据文件，经过我们测试，sparksql在iceberg上的查询效率是hive上的将近一倍（时间上快90%）。在一些小企业，没有自己的集群环境，需要用云服务的场景下，数据湖是一种不错的选择</div>2023-03-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/73/c5/d0880e7a.jpg" width="30px"><span>面对疾风吧</span> 👍（0） 💬（0）<div>Rdd 特性，分布式、容错性弹性、计算靠近存储</div>2022-04-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/31/9d/daad92d2.jpg" width="30px"><span>Stony.修行僧</span> 👍（0） 💬（0）<div>面试归来，二刷RDD</div>2022-03-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/d3/82/c3e57eb3.jpg" width="30px"><span>xuchuan</span> 👍（0） 💬（0）<div>简单易懂，单机思维和分布式思维模式总结到位</div>2021-05-01</li><br/>
</ul>