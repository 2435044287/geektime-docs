你好，我是独行。

上节课我们手敲了一个Transformer模型，实际最终训练出来的模型，参数量大概在1.2亿左右，文件大小约505M，这一节课我们再来探究一个非常有意思的问题：这个505M的文件内部到底存放的是什么？

前段时间我们本地运行过ChatGLM3-6B，你还记得吗？6B的模型文件分为8个，有的版本是5个，几个文件加在一起大约20G，6B的爷爷130B模型文件加起来近240G。不知道你有没有同样的疑问，在我最早接触大语言模型的时候，就非常好奇，大模型文件里到底存的是什么？随着不断地研究学习，总算有了一知半解，这节课就来和你分享一下。

## 模型文件

所谓模型文件，也可以叫模型权重，里面大部分空间存放的是模型的参数：权重（Weights）和偏置（Biases），当然也有一些其他信息，比如优化器状态、其他元数据，比如epoch数等。我们使用的是PyTorch框架，生成的模型权重文件格式是.pth，如果使用TensorFlow或者Hugging Face Transformers等框架，也有可能是.bin格式的文件。模型预训练完成后，我们可以调用下面的代码保存模型。

1. 只保存权重

```plain
torch.save(model.state_dict(), 'model_weights.pth')
```
<div><strong>精选留言（4）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/0a/a4/828a431f.jpg" width="30px"><span>张申傲</span> 👍（7） 💬（1）<div>第17讲打卡~

思考题：把模型文件分开存储，感觉很像分布式系统中的Partition操作，比如Kafka就会把1个逻辑上的Topic拆分成多个物理上的Partition。如这样做的好处主要是两点：1. 多个文件便于并行计算，可以提高模型训练和推理的效率；2. 容错和冗余，如果某个模型文件出现了损坏，只恢复特定的文件即可，无需修复整个模型。如果是这样的话，多个模型文件应该是不需要手动合并的，在模型训练或推理时，模型框架应该会自动处理。

以上都是个人的猜想，欢迎老师指正~</div>2024-07-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a0/c3/c5db35df.jpg" width="30px"><span>石云升</span> 👍（2） 💬（1）<div>商用的大模型将权重文件分开存放有几个关键原因：

1. 单个文件大小的限制
在许多操作系统和文件系统中，单个文件的大小有一定的限制（如 FAT32 文件系统的单个文件最大为 4GB）。因此，分开存储模型权重文件可以避免单个文件过大，防止存储和加载过程中的错误。

2. 便于分布式训练和推理
大模型的权重文件分开存放有助于分布式训练和推理，特别是在多个 GPU 或节点上运行时。每个 GPU 或节点只需要加载一部分权重文件，不需要一次性加载整个模型。这种方式不仅减少了单个计算单元的内存负担，还可以加速加载过程。

3. 更快的数据传输和存储管理
将权重文件分成多个较小的文件，能够提高数据传输速度。例如，如果你要从云端或远程服务器上加载模型文件，小文件更容易并行传输，从而加速整体模型的加载。此外，分开存放文件在存储管理和备份时也更加灵活。

4. 内存管理更高效
对于大模型而言，系统内存（RAM）或显存（GPU memory）的使用非常紧张。分开存放权重文件，允许在运行时只加载和处理部分权重，避免一次性占用过多的内存。

分开存放的权重在使用时如何处理？
无需合并：在实际使用时，模型框架（如 PyTorch 或 TensorFlow）并不需要将所有的权重文件合并成一个大文件。相反，框架可以在需要时动态加载各个分片的权重。这种方式节省了内存开销，同时保持灵活性。

按需加载：当模型被加载到 GPU 或 CPU 上时，权重文件可以按照分片结构加载。以分布式训练为例，不同的计算设备（如 GPU）可以各自加载一部分权重，分别负责不同的计算任务。训练或推理时，框架会自动管理各个设备之间的数据传递。

举个例子：
假设我们有一个6B参数的模型，它被分成8个权重文件存放在磁盘上。启动推理时，模型并不需要一次性将8个文件全部加载到内存中。相反，每个文件只会在相关计算任务中按需加载，比如一个GPU加载权重文件1和2，另一个GPU加载权重文件3和4，各自处理不同部分的神经网络计算。

这种设计能有效避免内存和计算资源的浪费，同时最大化利用硬件资源。</div>2024-09-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/8d/52/c3612753.jpg" width="30px"><span>两三天</span> 👍（0） 💬（1）<div>老师：模型参数小节Embedding矩阵中每个数字对应的现实含义是什么，或者能不能对照一个真实世界的例子举例说明？</div>2024-12-26</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/MpKow66ExJ0y3G471ql99hxqcdQ7RF0M7XBnN38uIvhK3bIxadn3W8KPnlbExTBgmAMhAsRnfkC0TsqKrNicnGg/132" width="30px"><span>乔克哥哥</span> 👍（0） 💬（0）<div>嵌入层和线性输出层的参数量是一样的，存储占用也是40%吗</div>2025-02-07</li><br/>
</ul>