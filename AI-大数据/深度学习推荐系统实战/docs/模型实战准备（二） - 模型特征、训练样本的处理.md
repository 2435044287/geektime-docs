你好，我是王喆，欢迎来到模型实战准备第二课。

这节课，我们来讲实战中所需的模型特征和训练样本的处理。为什么我们要专门花一节课的时间讲这些呢？因为在推荐模型篇中，我们的重点在于学习模型结构的原理和实现，而要实现并且训练这些模型，我们就必须先解决训练所需的样本和特征的处理问题。

这节课我们先来把模型实战的准备工作做完。具体来说，今天，我会带你用Spark来处理深度学习模型训练所需的样本和特征，再把特征存储到Redis中，供模型线上服务时调用。

## 为什么选择Spark为TensorFlow处理特征和样本？

这个时候，你可能会有疑问，我们的深度学习模型将在TensorFlow上进行训练，为什么要用Spark处理样本？可不可以直接让TensorFlow解决所有的事情呢？这是一个好问题，在我们学习具体的技术之前，先解决这个架构上的疑问是很有必要的。

在业界的实践中，我们需要记住一个原则，就是**让合适的平台做合适的事情**。比如说，数据处理是Spark的专长，流处理是Flink的专长，构建和训练模型是TensorFlow的专长。在使用这些平台的时候，我们最好能够用其所长，避其所短。这也是一个业界应用拥有那么多个模块、平台的原因。
<div><strong>精选留言（20）</strong></div><ul>
<li><img src="" width="30px"><span>onepencil</span> 👍（55） 💬（3）<div>线上会组装当前访问时的历史序列及历史平均值等，可以利用flink实时落盘这些线上特征，这样线下就不用再离线生成，也就杜绝了特征穿越问题</div>2020-11-16</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/55lYKUdcPFgUHibRYmaRiaBdrsmnLGOHdPp4OicjBh197X0vyGa9qAwruEqicAPuUgibXO4Lz5jLudlcbtsqq2p3CpA/132" width="30px"><span>Sebastian</span> 👍（12） 💬（2）<div>老师好，想问下使用hset把用户和物品的特征存入redis的场景下，如果用户上亿物品也上亿的话，存入redis会使用很大的资源。实际场景下并不是所有用户都是活跃用户，很多情况下可能用不上。那是否是在redis只存入活跃用户的特征呢？但是如果这样解决，遇到非活跃用户是否就没有特征值了？

从您的实践经验里有什么好的方法吗？</div>2020-11-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg" width="30px"><span>那时刻</span> 👍（9） 💬（4）<div>把评分大于等于 3.5 分的样本标签标识为 1，意为“喜欢”，评分小于 3.5 分的样本标签标识为 0，意为“不喜欢”。这样可以完全把推荐问题转换为 CTR 预估问题。请问老师，3.5分这个值是怎么来的呢？

另外一个问题，我们把评分时间戳作为代表时间场景的特征放到特征工程中。请问把时间戳用于特征工程，有木有需要注意的地方？比如是否是周末，假日等？老师在实际应用中有哪些实践么？</div>2020-11-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/d0/86/564f7d06.jpg" width="30px"><span>ZLZ</span> 👍（8） 💬（4）<div>王老师，请问我在训练CTR模型过程中，有两种训练样本处理方式，第一种是使用T-1天的数据进行shuffle，其中80%作为train dataset，20%作为训练过程中的val dataset，即使用T-1天的数据进行模型训练，针对T天的数据进行线上预测；第二种方式是使用T-2天的数据作为train dataset，T-1天的数据作为val dataset，即2使用T-2天的数据进行模型训练，针对第T天的数据进行线上预测；我理解第一种方式是不是容易造成信息穿越，例如在某一天有某个活动，但是第二天没有这个活动，那模型在第二天会效果不好，但是第二种方式线上是采用T-2天的模型，相比于第一种方式（线上使用的是第T-1的模型），是不是效果会打折扣</div>2021-05-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/a5/7e/383444bb.jpg" width="30px"><span>AI</span> 👍（8） 💬（2）<div>老师好，为什么用户id和电影id要作为特征进行输入，我的理解是id不是相当于一个索引吗？</div>2021-03-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/90/00/cfc2b463.jpg" width="30px"><span>萬里長空</span> 👍（6） 💬（1）<div>老师，问一个spark-udf的问题，看官网上定义udf的时候要使用register，但是您这里并没有使用，是sql与DataFrame的区别吗？</div>2020-11-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/f7/c0/f9298791.jpg" width="30px"><span>倪钰鑫</span> 👍（5） 💬（2）<div>老师好，我想问下用户行为的时间序列，最一开始的那个用户行为的历史数据我们都是置0吗？比如您上面所说的“userAvgRating”，在B上是填A的打分3，那么在A上呢？因为这里收集到的信息A是最前面的，那此时就是置为0吗？还是说可以选一个全局中值填进去呢？</div>2021-01-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/ee/9c/abb7bfe3.jpg" width="30px"><span>abc-web</span> 👍（3） 💬（1）<div>王老师，想问一下，如果标签或其他属性是中文内容需要进行特征处理还是直接进行word2vec？谢谢！</div>2021-01-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/11/fa/e0dcc1bf.jpg" width="30px"><span>榕</span> 👍（2） 💬（1）<div>&#47;&#47;add rating features
    val movieRatingFeatures = samplesWithMovies3.groupBy(col(&quot;movieId&quot;))
      .agg(count(lit(1)).as(&quot;movieRatingCount&quot;),
        format_number(avg(col(&quot;rating&quot;)), NUMBER_PRECISION).as(&quot;movieAvgRating&quot;),
        stddev(col(&quot;rating&quot;)).as(&quot;movieRatingStddev&quot;))
    .na.fill(0).withColumn(&quot;movieRatingStddev&quot;,format_number(col(&quot;movieRatingStddev&quot;), NUMBER_PRECISION))

老师，特征处理中电影的打分特征应该也是要做window处理吧，谢谢~</div>2021-01-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/44/93/2d3d5868.jpg" width="30px"><span>Jay</span> 👍（2） 💬（2）<div>刚入坑，好像一直没有看到关于特征组合的内容，这个点一直没有理解清楚，啥时候会讲讲呢？</div>2020-11-18</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLaoiaerNMy7eoSA5yfibPNhta51jkhPTTL1dD1HGlnjaGnFQ6Uzbbce82Kpnic3g1JlD7rtm41Y83PA/132" width="30px"><span>Geek_3c29c3</span> 👍（1） 💬（1）<div>老师，由于用户有上亿个，在训练样本时，只是有一部分用户的usrid去进行训练，在模型上线时，不在模型训练所用的usrid里面，一般来说都有哪些处理方法呢？</div>2021-04-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/28/a1/fd2bfc25.jpg" width="30px"><span>fsc2016</span> 👍（1） 💬（2）<div>老师，有俩个问题请教您：
1，前面章节生成了用户和物品的embding，这些embding也会作为一个特征字段加入到本节生成的用户和物品特征中嘛
2，本节提取了用户和物品特征，那进行ctr预估的话，是根据rateing表中，为每条记录添加对应提取出的用户特征和物品特征，作为一条训练记录。这样组合的话，是不是使用未来信息了？关于如何组装成一条训练记录进行ctr预估，该怎么做了
</div>2020-11-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/d0/86/564f7d06.jpg" width="30px"><span>ZLZ</span> 👍（0） 💬（1）<div>还有一个问题，电商领域中，在一个新的推荐场景，初期采用的是热门推荐进行积累数据的，就几乎没有用到什么特征，在用户行为数据积累量足够的情况下，准备训练样本，上推荐模型，模型用到的特征有离线特征（根据T-1天用户行为加工得到） + 实时特征（例如最近五分钟的点击次数），但是在离线训练模型时，无法拿到线上真实的实时特征（因为热门推荐没有用到实时特征，但是用户的行为日志是写入hive了），所以我通过历史的用户行为日志（例如：用户在某个时刻点击了某个商品）模拟复现出用户行为时刻的实时特征值，作为离线模型的训练集，这样做合理么，会有什么问题么，对于这种新场景，第一次上推荐模型的时候缺失真实实时特征该如何处理呢</div>2021-05-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/a9/05/6822b8a5.jpg" width="30px"><span>灯灯灯</span> 👍（0） 💬（1）<div>老师请问 对于像movielens的数据集给出具体评分的数据集 不把评分分为是否》3.5的两类而是直接对评分做预测 是否会得到更准确地预测呢？</div>2021-01-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/6d/c5/c0665034.jpg" width="30px"><span>Wiiki</span> 👍（0） 💬（4）<div>王老师，我按照您的示例代码，将用户特征存入redis(调用extractAndSaveUserFeaturesToRedis(samplesWithUserFeatures)的时候报错了，首先是报错：java.lang.Integer cannot be cast to java.lang.String，我在调试的过程中发现valueMap(&quot;userAvgReleaseYear&quot;) = sample.getAs[String](&quot;userAvgReleaseYear&quot;)这个字段并没有将年份转换成String，还是原来的Int类型，所以改成      valueMap(&quot;userAvgReleaseYear&quot;) = sample.getAs[Int](&quot;userAvgReleaseYear&quot;).toString，这个异常解决了，然后又报错：Exception in thread &quot;main&quot; redis.clients.jedis.exceptions.JedisDataException: ERR wrong number of arguments for &#39;hset&#39; command，定位到return client.getIntegerReply()这个代码出错了。目前没有找到具体原因，麻烦老师帮忙解答一下呀~  谢谢</div>2020-11-19</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/02FlEAh0LxLJ6pkCvfv5gsFC9Ngjc07Hh1fxicArXicDss9osXgVsXUHH596AjyicRT26nU26Ov4Rp6NwcibxuwvDg/132" width="30px"><span>Geek_84e43e</span> 👍（3） 💬（0）<div>王喆老师，我在学习您的课程的时候遇到了这个问题：在您使用window函数规避数据穿越问题这一节，我观察到您在切分数据集的时候还是采用的随机分割的方式？那假设我在测试集中是11月3号的数据，但是训练集中包含了11月1日和11月5日这两天的数据，这也就是说我会使用11月1号和5号的数据来训练，最后使用11月3号来测试模型效果，这不会同样带来数据穿越的问题吗？</div>2022-05-28</li><br/><li><img src="" width="30px"><span>Geek_bf2dff</span> 👍（0） 💬（0）<div>这里想问一下，如果是在个人工作站，或者向华为云modelart这样的平台也建议用spark来处理特征吗？</div>2024-11-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/30/c6/441acafd.jpg" width="30px"><span>海边停车</span> 👍（0） 💬（0）<div>电影1K，用户30K，评分100万条，在评分记录里加用户特征、电影特征性能太差了，大量冗余数据</div>2024-07-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/29/be/56/6a2998ba.jpg" width="30px"><span>คิดถึง </span> 👍（0） 💬（0）<div>王老师好，如果我想在数据集中添加其他特征，类似用户年龄、性别等，该修改哪些地方呢？</div>2021-08-31</li><br/><li><img src="" width="30px"><span>Sanders</span> 👍（0） 💬（0）<div>&quot;咱们课程中讲了基于 userId 的 window 函数方法，你觉得还有哪些方法也能避免引入未来信息吗？&quot;可以通过构建分区表的方式记录总的rattings，ratting次数以及日期分区</div>2021-02-04</li><br/>
</ul>