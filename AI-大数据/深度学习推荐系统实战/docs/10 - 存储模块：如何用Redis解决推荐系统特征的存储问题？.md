你好，我是王喆。今天，我们来解决系统特征的存储问题。

在特征工程篇我们说过，在推荐系统这个大饭馆中，特征工程就是负责配料和食材的厨师，那我们上堂课搭建的推荐服务器就是准备做菜的大厨。配料和食材准备好了，做菜的大厨也已经开火热锅了，这时候我们得把食材及时传到大厨那啊。这个传菜的过程就是推荐系统特征的存储和获取过程。

可是我们知道，类似Embedding这样的特征是在离线环境下生成的，而推荐服务器是在线上环境中运行的，那这些**离线的特征数据是如何导入到线上让推荐服务器使用的呢？**

今天，我们先以Netflix的推荐系统架构为例，来讲一讲存储模块在整个系统中的位置，再详细来讲推荐系统存储方案的设计原则，最后以Redis为核心搭建起Sparrow Recsys的存储模块。

## 推荐系统存储模块的设计原则

你还记得，我曾在[第1讲的课后题](https://time.geekbang.org/column/article/288917)中贴出过Netflix推荐系统的架构图（如图1）吗？Netflix采用了非常经典的Offline、Nearline、Online三层推荐系统架构。架构图中最核心的位置就是我在图中用红框标出的部分，它们是三个数据库Cassandra、MySQL和EVcache，这三个数据库就是Netflix解决特征和模型参数存储问题的钥匙。
<div><strong>精选留言（26）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/35/03/57ddf921.jpg" width="30px"><span>An</span> 👍（58） 💬（5）<div>redis keys命令不能用在生产环境中，如果数量过大效率十分低，导致redis长时间堵塞在keys上。</div>2020-10-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5e/f2/bd3a45f5.jpg" width="30px"><span>AIGeek</span> 👍（40） 💬（5）<div>Redis value 可以用pb格式存储, 存储上节省空间. 解析起来相比string, cpu的效率也应该会更高</div>2020-10-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5f/e5/54325854.jpg" width="30px"><span>范闲</span> 👍（36） 💬（5）<div>1.redis这种缓存中尽量放活跃的数据，存放全量的embedding数据，对内存消耗太大。尤其物品库，用户embedding特别多的情况下。
2.分布式kv可以做这种embedding的存储
3.关于embedding的编码可以用pb来解决。embedding维度太大的时候，redis里的数据结构占用空间会变大，因为除了embedding本身的空间，还有数据结构本身占用的空间。</div>2020-11-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/28/a1/fd2bfc25.jpg" width="30px"><span>fsc2016</span> 👍（21） 💬（1）<div>老师，有俩个问题
1，文中关于RecForYou，是来一个用户访问，就把用户的embding存入推荐服务器内存，如果一个短时间一下来百万级用户，都存入服务器内存，这样会不会出问题，优化的话应当也可以对用户分级，活跃用户存下来，非活跃其他还是从Redis实时读取用户特征。
2，RecForYou中，给用户推荐电影，使用的用户embding和候选电影embding的余弦距离来排序，这俩个不同维度embding计算余弦相似度有意义嘛，还是因为本例子中用户embding由其看过的电影embbding 相加来的。所以这么做嘛</div>2020-11-04</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/qw7rRHUPRzhibxXWLG7kc3zkhZwBn4JZaryzko2eWOjSxDlRvUathHugrIVKhcCqxhtsANUTq0140AlbDkLZmcw/132" width="30px"><span>shenhuaze</span> 👍（7） 💬（1）<div>王老师，想问一下关于全量特征存储的数据库选型。业界用来存储全量特征的最主流的数据库是什么？Cassandra吗？HBase是否合适？</div>2020-11-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/25/68/05/e39a9cc8.jpg" width="30px"><span>张宏宇</span> 👍（6） 💬（1）<div>老师，我想问的是特征在更新的时候可能发生数据不一致的情况，比如用户特征先更新，物品特征后更新，在两个特征更新过程中线上服务读取特征数据的时候，可能用户特征是新的，物品特征是老的，不知道老师是否遇到过这样的问题以及如何解决的，谢谢！</div>2021-03-17</li><br/><li><img src="" width="30px"><span>Geek_b6bf29</span> 👍（6） 💬（1）<div>老师你好，关于这一步 “我们完全可以把所有物品特征阶段性地载入到服务器内存中，大大减少 Redis 的线上压力。” 该如何具体操作呢。比如离线计算每6个小时更新物品特征，是不是在线服务也要重启更新，把最新的物品特征载入服务器？还是有更好的方法，可以支持热更新，不用重启在线服务？</div>2021-01-08</li><br/><li><img src="" width="30px"><span>Geek_ddf8b1</span> 👍（6） 💬（1）<div>
        用户特征分为长期兴趣特征和实时兴趣特征，长期兴趣特征一般是按天更新，实时特征可能按分钟或者秒级更新。请问实际项目中是长期特征按天更新写入redis，短期特征分钟级更新写入redis这样吗？ </div>2020-12-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/c9/f8/72955ef9.jpg" width="30px"><span>浣熊当家</span> 👍（3） 💬（1）<div>请问老师，文中的两部分redis相关的代码，可以在Maven项目中找到吗？老师可不可以提供以下路径信息方便找到？</div>2020-10-26</li><br/><li><img src="" width="30px"><span>Geek_ddf8b1</span> 👍（2） 💬（2）<div>        为保证线上请求特征和线下日志特征数据一致性，用户线上请求时用户特征和物品特征是从redis查询得到后写到日志文件吗？
        这时用户的实时特征比如过去几分钟点击的物品序列特征是从kafka读取还是从redis读取？ 
        还是kafka发送用户的行为物品序列数据每隔几分钟写入redis，然后线上请求获取特征做预估打分和写特征数据到日志文件统一从redis读取？</div>2020-12-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/90/0d/331cb979.jpg" width="30px"><span>Jackie</span> 👍（2） 💬（2）<div>文中说把物品特征放到服务器中，“我们完全可以把所有物品特征阶段性地载入到服务器内存中，大大减少 Redis 的线上压力。”，那如果物品也特别多，不也放不下吗？</div>2020-11-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/c9/f8/72955ef9.jpg" width="30px"><span>浣熊当家</span> 👍（2） 💬（1）<div>有个很小白的问题请问老师， 我们在IntelliJ的Maven porject里用到的工具比如spark， redis， 这些需要我们额外下载安装到电脑上吗？还是说在Maven项目中已经通过代码添加依赖，就已经完成了安装？</div>2020-10-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/49/be/6ee1c9da.jpg" width="30px"><span>胡译匀</span> 👍（1） 💬（1）<div>请问如何调试scala程序？网上找了半天也没靠谱的，谢谢。</div>2021-01-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/b6/88/e8deccbc.jpg" width="30px"><span>romance</span> 👍（1） 💬（1）<div>老师，Embedding 主函数要装了Spark才能跑起来吧？</div>2020-12-17</li><br/><li><img src="" width="30px"><span>Geek_ddf8b1</span> 👍（0） 💬（1）<div>老师 请教一下 推荐项目中用户有几千万，几千万用户的特征（部分是用户实时行为特征）全部存在redis中，key太多会导致redis查询性能直线下降，请问这个问题如何解决？</div>2021-09-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/e0/cb/1ef6c142.jpg" width="30px"><span>Betterme</span> 👍（0） 💬（1）<div>物品向量一次性加载到内存里，那后续怎么更新这部分数据呢？写个调度热加载吗？</div>2021-08-01</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIM0aLd8cjg3wzaLLK551L4HBx6zVIMuTINgOVUeibU6xHj0MRXQKsPIicKuZSlSibTibfE76u35Zralw/132" width="30px"><span>Geek_379a55</span> 👍（0） 💬（1）<div>“这样一来，在具体为用户推荐的过程中，我们再利用相似的接口查询出用户的 Embedding，与内存中的 Embedding 进行相似度的计算，就可以得到最终的推荐列表了。“

王喆老师，用户的embedding是离线计算存储在redis，然后线上服务启动的时候加载在内存中，当离线计算的用户embedding更新时，线上服务内存中的用户embedding如何做到同步更新呢？
</div>2021-03-16</li><br/><li><img src="" width="30px"><span>Sanders</span> 👍（0） 💬（1）<div>在SparrowRecsys中，在线计算用户Embedding和物品Embedding的工作放在离线计算更适合呢？在线只缓存用户推荐列表及物品得分，这样避免在线计算。
在实际情况中，推荐得分都是模型通过计算物品、用户和上下文特征来得到，每次请求包含用户ID，候选集id列表和上下文，假设用户特征在redis，N个物品特征在内存，这时batch预测就可能成为瓶颈，在这块有什么好的设计减少预测计算量？</div>2021-02-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ec/64/7403c694.jpg" width="30px"><span>ALAN</span> 👍（0） 💬（2）<div>老师，存储系统类型，内存数据库和服务器内存不是一回事吗？有什么区别？</div>2021-01-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/7c/5b/7a8d842c.jpg" width="30px"><span>Lucifer</span> 👍（7） 💬（1）<div>向量索引faiss</div>2020-11-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/2a/7c/0d6a87c4.jpg" width="30px"><span>dandy</span> 👍（1） 💬（0）<div>老师你们这边是把item embedding存到内存，那用户存的是原始特征还是embedding后的存到redis呢，如果是原始特征是否需要特征抽取呢。一般现在业内是怎么处理的。 我们内部系统是item和user都是存的原始特征，后面做特征抽取，在embedding</div>2022-01-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d6/11/808eb5f8.jpg" width="30px"><span>小志</span> 👍（0） 💬（0）<div>
老师，时隔这么久，再次重温这个系列的文章，也有一些工作经验，想在咨询一下：
比如帖子推荐场景，有一些特征是点击序列，比如用户点击过的帖子序列，数量可能很大，这里怎么存储比较好呢？
可能得一个办法是：最多保留100个。但是有可能想放宽这个长度，如 500，但直接存储的话，rt可能会几何增加？</div>2024-12-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/29/ed/b7/972cd42c.jpg" width="30px"><span>꧁꫞꯭R꯭e꯭i꯭r꯭i꯭꫞꧂</span> 👍（0） 💬（0）<div>ssdb如何？</div>2023-01-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2a/3b/a5/689cc3fd.jpg" width="30px"><span>雨尽书声响</span> 👍（0） 💬（0）<div>老师您好，文中说把物品特征放到服务器中，“我们完全可以把所有物品特征阶段性地载入到服务器内存中，大大减少 Redis 的线上压力。”，物品特征存入内存大约多少条会比较合适那</div>2022-09-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2c/06/f8/9f6d64bd.jpg" width="30px"><span>Calmness</span> 👍（0） 💬（0）<div>老师，服务器内存不够的时候放在内存数据库，但是内存数据库不也全部都是建立在内存的基础上的吗？那如果服务器内存不够了放在内存数据库里不也不够吗？还有那个阶段性的物品特征该怎么理解呀？能举个例子吗</div>2022-02-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/d1/f5/efe2175a.jpg" width="30px"><span>Alvin</span> 👍（0） 💬（0）<div>have this problem:  file:&#47;home&#47;hadoop&#47;SparrowRecSys&#47;src&#47;main&#47;resources&#47;webroot&#47;sampledata&#47;ratings.csv
</div>2021-08-02</li><br/>
</ul>