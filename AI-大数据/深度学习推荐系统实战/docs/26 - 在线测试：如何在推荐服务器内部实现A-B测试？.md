你好，我是王喆。这节课我们来聊一聊推荐系统的线上A/B测试。

上两节课，我们进行了推荐系统离线评估方法和指标的学习。但是无论采用哪种方法，离线评估终究无法还原线上的所有变量。比如说，视频网站最想要提高的指标是用户观看时长，在离线评估的环境下可以模拟出这个指标吗？显然是非常困难的。即使能够在离线环境下生成这样一个指标，它是否能真实客观地反映线上效果，这也要打一个问号。

所以，对于几乎所有的互联网公司来说，线上A/B测试都是验证新模型、新功能、新产品是否能够提升效果的主要测试方法。这节课，我们就来讲一讲线上A/B测试，希望通过今天的课程，能帮助你了解到A/B测试的基本原理，A/B测试的分层和分桶方法，以及怎么在SparrowRecSys的推荐服务器中实现A/B测试模块。

## 如何理解A/B测试？

A/B测试又被称为“分流测试”或“分桶测试”，它通过把被测对象随机分成A、B两组，分别对它们进行对照测试的方法得出实验结论。具体到推荐模型测试的场景下，它的流程是这样的：先将用户随机分成实验组和对照组，然后给实验组的用户施以新模型，给对照组的用户施以旧模型，再经过一定时间的测试后，计算出实验组和对照组各项线上评估指标，来比较新旧模型的效果差异，最后挑选出效果更好的推荐模型。
<div><strong>精选留言（16）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/13/28/a1/fd2bfc25.jpg" width="30px"><span>fsc2016</span> 👍（21） 💬（5）<div>对于问题，我认为应该放在同一层，因为首页推荐可能会把一些有兴趣偏好的用户导入到对应的内容页，比如首页推荐球鞋，对于想购买球鞋的就会进入到球鞋内容页，这样对于内容页推荐来说 ，用户不是随机，是有偏的。</div>2020-12-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg" width="30px"><span>那时刻</span> 👍（13） 💬（1）<div>我觉得对于首页与内容页做测试应该放在不同层，因为首页和内容页是正交的。</div>2020-12-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/c9/f8/72955ef9.jpg" width="30px"><span>浣熊当家</span> 👍（5） 💬（2）<div>请问老师，在业界AB测试流量分配是不是有专门的team用专门的系统来automate， 不太需要算法工程师们操心， 一般用什么软件或者技术进行自动流量分配呢？</div>2020-12-14</li><br/><li><img src="" width="30px"><span>haydenlo</span> 👍（4） 💬（2）<div>老师好，实际工作中我们遇到了一些排序模型需要与特定召回策略配套的需求，所以目前召回层和排序层流量不是正交。比如说召回走桶号1-10的流量，排序层也会走1-10，也就是说每一层不会重新打散，请问这样会有问题吗？</div>2020-12-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/c9/f8/72955ef9.jpg" width="30px"><span>浣熊当家</span> 👍（2） 💬（1）<div>最近开始了一个新的工作，职责之一是建立一个统一中心化标准化的AB测试系统，来自动化的完成公司内所有的AB测试。 我对系统一无所知觉得很无助，之前和现在的公司，都是用sitepect和split.io这种服务来分流，然后各个组自己手动做自己的测试， 我只能在网上搜相关的资料，王喆老师如果有推荐如何从0开始搭建AB测试系统的论文，大厂案例，将会对我有莫大的帮助，很想听听您的指导和建议，如果下手，先谢谢您了！！</div>2021-04-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/20/46/f4/93b1275b.jpg" width="30px"><span>Alan</span> 👍（2） 💬（1）<div>答：我认为首页推荐与内容页推荐模型应放在同一层。
1、从用户行为体验的业务结构上来说，先点击首页推荐，后内容页推荐，二者不建议分层，但可以分桶。 
2、从推荐系统架构设计来说，老师所说的：层与层之间的正交！首页推荐更多目的为了收集用户感兴趣的数据标签，内容页推荐的数据来源大部分来自于首页推荐（标签数据、标签数据、ctr、点击次数、热门话题等），进而影响内容推荐的呈现内容（改变）甚至呈现方式（音乐类APP：车载蓝牙模式、跑步模式、正常模式）。</div>2021-04-06</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLaoiaerNMy7eoSA5yfibPNhta51jkhPTTL1dD1HGlnjaGnFQ6Uzbbce82Kpnic3g1JlD7rtm41Y83PA/132" width="30px"><span>Geek_3c29c3</span> 👍（1） 💬（1）<div>老师，想问一下，一个成熟的A&#47;B测试框架，分桶、分流、投放等一些操作是交给产品、运营来做还是应该是数据中台来做呢？一些大厂都是怎样做的，如何做到充分解耦，还能提高测试效率？</div>2021-01-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/c9/f8/72955ef9.jpg" width="30px"><span>浣熊当家</span> 👍（1） 💬（3）<div>对于最后的问题，我觉得应该放在不同层， 因为首页不同的推荐会影响接下进入哪些内容页， 为了使内容页的AB测试结果公平，需要对首页的进行正交在进行Test和Control的分配</div>2020-12-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/c9/f8/72955ef9.jpg" width="30px"><span>浣熊当家</span> 👍（0） 💬（1）<div>请问老师一下，我对正交这个词的意思总会似懂非懂，是不是就是在第一层的test和control下，分别平均分配第二层的test和control的意思么？可以直白的说成random sampling the next layer of variants, under each variant of the first layer 这样吗？

然后上面例子中，您是把第一层的两个variants拼凑， 组成第二层变量的两组， 这里我有两个问题：
1. 可以对X1的population，在细分成Y1和Y2吗， 还是一定要像例子里一样反方向
2. traffic的顺序很重要吗，比如一定要一个一个x1， 一个x2这样交替着来（如果是这样我就可以理解第一点，不能反过来了）</div>2021-04-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/14/34/9a96e8d2.jpg" width="30px"><span>浩浩</span> 👍（0） 💬（1）<div>思考题，应该放在同层，不然点击的进入本身就是一种有偏操作和带入</div>2020-12-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/7e/c2/0f0924a9.jpg" width="30px"><span>kaixinbaoma</span> 👍（0） 💬（4）<div>老师好，麻烦问下如果同一个页面，召回层和排序层一般是放在同一层还是不同层呢？</div>2020-12-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2d/b2/fb/ed919876.jpg" width="30px"><span>刘伟</span> 👍（0） 💬（0）<div>刚刚看到你后续对我的问题有解释。 sorry about this. 下次会先通看然后再提问: )</div>2023-02-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2d/b2/fb/ed919876.jpg" width="30px"><span>刘伟</span> 👍（0） 💬（0）<div>自我感觉， 比如视频，我们可以用 原先的数据集来做 training。 然后用最新的数据集来做 testing. 

通过这种方法是可以比较出，新的模型哪些会更好。 (旧模型 serving, 但是几个新的模型在线下进行并行的模拟和评估) 

比如说文中提到的视频长度， 我们可以拿既有的，比如 6 小时前的数据做 training (包含视频观看长度信息）， 然后用最近 6 小时的来进行 TESTING。 （由于视频有时间和兴趣相关，所以采用了时间切割的数据划分方式）。 

那么 A&#47;B 测试存在的必要性在于什么？ 是在于 如果用纯离线的方式来做的化， 那么产生的样本空间（推荐列表） 和新的模型还是不一致的。 因此不能完全用离线的方式来模拟线上的效果？ xiexie </div>2023-02-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2a/3b/a5/689cc3fd.jpg" width="30px"><span>雨尽书声响</span> 👍（0） 💬（0）<div>老师有必要对于推荐系统的召回层和排序层每层做一个AB实验吗</div>2022-04-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/55/c9/3df70927.jpg" width="30px"><span>Kaye</span> 👍（0） 💬（0）<div>王老师，一直没搞清楚“分桶”的必要性，求助？（“分桶”是用来解决什么问题的呢？用户量小的情况下可以不用“分桶”吗？）</div>2022-02-02</li><br/><li><img src="" width="30px"><span>Geek_8a732a</span> 👍（0） 💬（0）<div>不同层之间流量是正交，穿越不同层的时候会被打散，但实际上首页推荐的人通过点击相应物品会进入相应物品的内容推荐页，有强相关性，不应该被打散，所以应该放在同一层</div>2021-08-23</li><br/>
</ul>