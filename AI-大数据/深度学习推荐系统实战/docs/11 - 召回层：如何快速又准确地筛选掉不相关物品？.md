你好，我是王喆。今天，我们来一起学习推荐系统中非常重要的一个模块，召回层。

为了弄清楚召回层是什么，我们先试着解决一下这个问题：**如果你是一名快手的推荐工程师，你的任务是从500万个候选短视频中，为一名用户推荐10个他最感兴趣的。你会怎么做？**

我想最直接最暴力的做法，就是对这500万个短视频挨个打分、排序，取出得分最高的10个推荐给用户。如果这个打分的算法非常靠谱的话，我们肯定能够选出用户最感兴趣的Top 10视频。但这个过程会涉及一个非常棘手的工程问题：如果利用比较复杂的推荐模型，特别是深度学习推荐模型，对500万个短视频打分，这个过程是非常消耗计算资源的。

而且你要知道，这还只是计算了一个用户的推荐结果，在工业级的线上服务中，每秒可是有几十万甚至上百万的用户同时请求服务器，逐个候选视频打分产生的计算量，是任何集群都承受不了的。

那**在推荐物品候选集规模非常大的时候，我们该如何快速又准确地筛选掉不相关物品，从而节约排序时所消耗的计算资源呢？**这其实就是推荐系统召回层要解决的问题。今天，我就从三个召回层技术方案入手，带你一起来解决这个问题。

## 召回层和排序层的功能特点

在前面的课程中我提到过学习推荐系统的一个主要原则，那就是“深入细节，不忘整体”。对于召回层，我们也应该清楚它在推荐系统架构中的位置。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/20/d4/f2/979e5346.jpg" width="30px"><span>邓生</span> 👍（60） 💬（6）<div>关于使用embedding进行召回，其实我搞不懂为什么是用户和物品的embedding计算相似度，不应该是物品跟物品进行相似度计算，用户跟用户之间进行相似度计算吗？为什么物品和人之间可以直接进行embedding相似度计算，这在逻辑上想不通。</div>2020-11-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/99/f0/ba3c0208.jpg" width="30px"><span>Geek_63ee39</span> 👍（36） 💬（1）<div>请教老师一个问题，文中提到: “多路召回中使用的“兴趣标签”“热门度”“流行趋势”“物品属性”等信息都可以作为 Embedding 方法中的附加信息（Side information），融合进最终的 Embedding 向量中”

我想有两种实现方式: 
1. 对于用户高评分（大于3.5）的电影序列，通过item2vec得到每个物品的embedding向量（假设长度为10），并在向量第11位添加物品的兴趣标签，第12位添加物品热门度，依次类推。
2. 不采用item2vec，而是其他某种方式将物品所有维度的信息（包括“兴趣标签”“热门度”“流行趋势”“物品属性”等）统一地进行embedding。

对于第一种方式，每一个维度的附加信息权重相同，这是否合理?另外对于电影类型这种类别型特征，采用multi-hot编码附加到embedding向量后面，是否合理。
对于第二种方式，我还不知道怎样实现。

请问老师，实际生产中较好的实现方式是怎样的呢？</div>2020-10-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/e5/f9/f0d056be.jpg" width="30px"><span>gallup</span> 👍（32） 💬（2）<div>请问老师，多路召回中，topk除了根据经验值确定，业界通用的是怎么确定k得大小呢</div>2020-11-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/90/00/cfc2b463.jpg" width="30px"><span>萬里長空</span> 👍（25） 💬（1）<div>老师,关于EGES的训练,试了下,由于电商领域商品维度非常大,即使hash后也很大,这导致训练非常慢,这个一般怎么解决啊?</div>2020-10-29</li><br/><li><img src="" width="30px"><span>Geek_seven</span> 👍（15） 💬（2）<div>请问老师，在业界中，通常的做法是会将embedding召回替换掉多路召回，还是会将embedding召回作为多路召回中一路召回呢？谢谢~</div>2021-08-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/47/2e/d4d05bc0.jpg" width="30px"><span>Geek_w48j7f</span> 👍（14） 💬（4）<div>请问下老师，在生成用户embedding的过程中我看你的逻辑是将该用户所有观看电影的embedding通过拉链进行叠加后最终生成，请问这种方法有什么根据吗或者说是原理呢，还是说这个是基于经验呢？</div>2020-11-17</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/l3RGUX8aLnPLmsQsra0yU5d8m7Se5jdVpaC3bkb99FuY11BPQNAsH4MPXbZjCTia9VVwn8lnBnKLkdfSiabOgxKg/132" width="30px"><span>Geek_e0d66a</span> 👍（12） 💬（5）<div>请问老师，如果基于兴趣标签做召回，同一个物品，有多个标签，而用户也计算了出了多个兴趣标签，那么怎么做用户的多兴趣标签与物品的最优匹配呢？还有物品的标签有多层，那么怎么利用上一层的标签呢？</div>2020-10-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/a3/76/a81e3fbe.jpg" width="30px"><span>王宁</span> 👍（11） 💬（1）<div>老师，你好，我看了您推荐给其他同学的阿里的EGES算法的论文，那个论文里面的EGES模型图的最底层是Sparse feature，论文中是说这一层是比较倾向于用one- hot编码的，不管side information的one-hot编码，一般item的数量会很多很多，对item本身的向量表示直接用one-hot的话，那embedding matrix是不是会很大，这样是合适的吗？我不确定自己是不是看懂了，希望老师可以帮我解答一下，谢谢老师！</div>2020-11-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/36/4f/455ec47f.jpg" width="30px"><span>大钰儿</span> 👍（9） 💬（1）<div>如果新item特别多(每秒可能几十到上百）对item展示的实时性要求较高（小于五分钟就需要曝光）这些item的embedding该如何更新呢？</div>2020-11-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/99/f0/ba3c0208.jpg" width="30px"><span>Geek_63ee39</span> 👍（9） 💬（1）<div>课后思考1：
1. 在类SimilarMovieProcess中实例化一个线程池ThreadPoolExecutor作为静态成员变量
2. 方法multipleRetrievalCandidates中的候选集candidateMap使用ConcurrentHashMap替代HashMap
3. 风格类型、高分评价、最新上映三种召回的过程使用线程池实例（共三个线程）去执行
4. 判断三个线程执行完后返回结果

不知道这种方式有没有不足？</div>2020-10-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg" width="30px"><span>那时刻</span> 👍（6） 💬（1）<div>请问老师，多路召回中使用的“兴趣标签”“热门度”“流行趋势”“物品属性”等信息都可以作为 Embedding 方法中的附加信息，这些附加信息可以设置各自权重么？</div>2020-10-29</li><br/><li><img src="" width="30px"><span>Van</span> 👍（5） 💬（1）<div>老师您好。基于您讲的Embedding的召回方法 我又做了一些额外的研究，看到业界目前有两类方法：
1. i2i召回 比如用咱们前面讲item2vec得到item的embedding然后去做召回
2. u2i召回 用咱们后面讲的比如双塔模型同时得到user和item的embdding然后直接做内积找近似
想知道这两种方法哪种更好一些（个人猜测u2i）？最近我们组想要做这个 不知道老师您更建议从哪个模型开始着手（e.g. youtube的DNN）？ （我知道一定是因数据和公司情况而异的 但想从老师的经验出发了解一下如果想做召回 从哪个模型开始 是比较好的）谢谢老师！</div>2021-08-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/8c/55/cac3dbcc.jpg" width="30px"><span>Four y</span> 👍（4） 💬（2）<div>老师，我看到您的实现中召回层在对所有的电影做了相似度计算后进行了排序，再选出Topk给排序层.
这里为什么是这样操作呢？我想，对于召回层我们不可以直接对结果进行Topk算法吗？
如果是用排序的话，那么主要的计算量不就在第三步而不是第二步了吗？

</div>2020-10-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/8e/67/afb412fb.jpg" width="30px"><span>Sam</span> 👍（3） 💬（2）<div>老师，您好！我是推荐系统小白，请问作为推荐系统工程师，要认真做好AB测试吗？</div>2020-12-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/97/8f/ccce7df1.jpg" width="30px"><span>小匚</span> 👍（3） 💬（1）<div>老师这种Embedding特征的方法是不是叫表征学习了？也可以用深度学习的模型来输出这个Embedding</div>2020-11-04</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/FydBiarFhvwAxkA2fL3IpEGcd31xAfo8WicAgxreCSbPgo0IdcHkAwZQDZDiaeAJg7u2UKqSEmzr8Mopf9lFY1IEw/132" width="30px"><span>郭翊麟</span> 👍（2） 💬（1）<div>王老师您好  阅读这一节的源码是发现 您在文中写的 etrievalCandidatesByEmbedding(User user) 方法 并没有找到   取而代之的是 retrievalCandidatesByEmbedding(Movie movie, int size)  按我理解 一个是针对 user Embedding计算 movie的相似度  一个是针对 当前movie Embedding 计算与movie的相似度   替换对象的原因是工程上的考虑 还是单纯的 用user Embedding效果不好呢？ 感谢老师的解答啦！！！</div>2021-05-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/cf/26/1120f7fd.jpg" width="30px"><span>Ethan</span> 👍（2） 💬（1）<div>请问老师，系列中哪些部分是排序层？以及召回和排序两步如何打通？没有看到相关内容，有点迷糊</div>2020-12-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/c9/f8/72955ef9.jpg" width="30px"><span>浣熊当家</span> 👍（2） 💬（4）<div>还是得麻烦问一下老师，文中的三段代码可以在Maven项目的哪个模块下找到？ 我没找到有关于retriveval相关名字的模块</div>2020-10-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/4f/db/3d589d18.jpg" width="30px"><span>ulysses</span> 👍（1） 💬（2）<div>老师你好，请问一下你这个算法召回的模型的结果应该没有应用在这个线上的project吧？因为我并没有找到调用SimilarMovieProcess 这个class 的方法。可以解释一下吗？</div>2021-09-12</li><br/><li><img src="" width="30px"><span>Geek_c7d6ff</span> 👍（1） 💬（1）<div>提升计算 Embedding 相似度：
1. 是不是可以先对所有item的向量进行clustering，然后先计算user距离每个centroid的距离，选择比较接近的cluster。
2. 不太需要sorting吧，用quick select选择top-K是不是更快一些？</div>2021-05-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/07/a9/8544f545.jpg" width="30px"><span>icode</span> 👍（1） 💬（1）<div>老师，在此之前的课程获取embedding是通过序列化的item或者随机游走的item来生成训练样本 从而获取item对应的embedding，我理解这都是item单侧的生成embedding方式，所以最终生成的embedding通过计算余弦距离等方式来计算item之间的相似度；在本节课中讲解的是召回层，那么需要考虑到user和item的对应的embedding的相似性，请问采用何种方式训练可以让user侧的embedding和item侧的embedding有可比性呢？ 有什么paper推荐呢？谢谢老师解答</div>2021-02-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/cd/6c/9ab927b1.jpg" width="30px"><span>静秋</span> 👍（1） 💬（1）<div>标注数据的时候label可能会比较稀疏，如何通过快速删选来降低标注的成本和工作量？请老师有啥好的建议吗？</div>2021-01-15</li><br/><li><img src="" width="30px"><span>Liam</span> 👍（1） 💬（1）<div>不太理解， userEmb.csv 数据生成的思路？用户观看过的电影的Emb的聚合？不理解下面代码思路 </div>2021-01-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/13/6e/f1e23980.jpg" width="30px"><span>Macielyoung</span> 👍（1） 💬（1）<div>对于提升计算Embedding相似度的速度这块，我想是不是通过分治法来做，每一部分处理一小部分数据集，选出Top k，合并再去计算求出Top k，有点像大数排序的问题。</div>2020-12-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/8c/c4/aba3ee31.jpg" width="30px"><span>卓别林先森</span> 👍（1） 💬（1）<div>王老师您好，了解这些召回层的算法后，能说下目前业界生产中是如何评价每个召回算法的指标吗？类似于排序算法中的auc，recall,ctr的指标来之类的指标。谢谢！</div>2020-12-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/b7/ed/a61ad95d.jpg" width="30px"><span>江月</span> 👍（0） 💬（1）<div>请问老师，如果想动态调每一路召回配额，实验指标如时长完播率，和各路召回配额没有明显的相关性，这样要怎么确定每一路的配额向上调还是向下调，试过用高斯采样，感觉像是盲猜，时好时坏</div>2021-11-16</li><br/><li><img src="" width="30px"><span>Geek_b2c562</span> 👍（0） 💬（1）<div>多路召回中使用的“兴趣标签”“热门度”“流行趋势”“物品属性”如何作为 Embedding 方法中的附加信息？前面讲的图模型和item2vec貌似不能支持</div>2021-11-13</li><br/><li><img src="" width="30px"><span>Geek_b2c562</span> 👍（0） 💬（1）<div>请问老师，item2vec是算的物品的特征，是物品的空间向量，怎样和用户item2vec联系上的呢？</div>2021-11-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/b7/ed/a61ad95d.jpg" width="30px"><span>江月</span> 👍（0） 💬（2）<div>多路召回确定一个大概的配额过后通过强化学习的方法调整配额会有更好的效果吗</div>2021-11-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/7a/cf/c42dd74e.jpg" width="30px"><span>sky</span> 👍（0） 💬（2）<div>王老师，看到这里，我有个疑问：推荐系统的输入到底是什么呢？感觉召回排序都用的是 Embedding ，没啥区别啊</div>2021-09-12</li><br/>
</ul>