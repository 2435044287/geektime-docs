你好，我是王喆。今天开始，我们进入线上服务篇的学习。

很多同学提起推荐系统，首先想到的是那些结构“华丽”，发展迅速的推荐模型。但事实上，在一个实际的工业级推荐系统中，训练和实现推荐模型的工作量往往连一半都没有。大量的工作都发生在搭建并维护推荐服务器、模型服务模块，以及特征和模型参数数据库等线上服务部分。

同时，由于线上服务模块是直接服务用户，产生推荐结果的模块，如果一旦发生延迟增加甚至服务宕机的情况，就会产生公司级别的事故。因此毫不夸张地说，线上服务实际上是推荐系统中最关键的一个模块。

线上服务如果写得不好，不仅杂乱无章，而且难以升级维护。因此，为了让你掌握搭建起一个支持深度学习的、稳定可扩展的推荐服务的方法，在这一模块中，我们会依次来讲线上服务器、特征存储、模型服务等模块的知识。

今天，我们先聚焦线上服务器，一起搭建直接产生推荐结果的服务接口。在这个过程中，我们按照先了解、后思考、再实践的顺序，依次解决这3个关键问题：

1. 一个工业级的推荐服务器内部究竟都做了哪些事情？
2. 像阿里、字节、腾讯这样级别的公司，它们的推荐系统是怎么承接住每秒百万甚至上千万的推荐请求的？
3. 我们自己该如何搭建一个工业级推荐服务器的雏形呢？
<div><strong>精选留言（17）</strong></div><ul>
<li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/GomQuKMYYNX7aMCNt4Ut8YyBrzVM71fgly5l1jykTFic8iaqCTG5ELnsIqlhwgG7ibCCxpODn6PzfVaSicrDub6t5Q/132" width="30px"><span>smjccj</span> 👍（60） 💬（4）<div>源地址哈希，或根据服务器计算能力加权随机分配，当出现大量节点利用率很低时，进行资源回收，减少虚拟机，当大部分节点都出现overload情况，进行扩容，增加虚拟机数量。</div>2020-10-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5f/e5/54325854.jpg" width="30px"><span>范闲</span> 👍（35） 💬（2）<div>1.如果硬件配置基本一样且部署服务一样，就采用轮询或者随机的负载均衡策略
2.如果硬件配置不同，可以根据硬件的计算能力做加权的负载均衡策略
3.同样也可以利用源地址hash做策略
4.关于扩容和缩容:可以根据系统负载情况做动态调整。</div>2020-11-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg" width="30px"><span>那时刻</span> 👍（23） 💬（2）<div>请问老师，按照一些规则预先缓存好几类新用户的推荐列表，等遇到新用户的时候就直接返回，这算是冷启动策略么？</div>2020-10-29</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKHFicKDOJk2zNE09HNL5ykibFV7a9I4r8435Y7P1FJbxzTwTGDDRCfBqYrmQKuHrgLJAV3onrOReTw/132" width="30px"><span>Geek_04634b</span> 👍（14） 💬（6）<div>这个课199我都买，太值钱了，现在什么算法都是浮云，关键是落地</div>2021-01-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/53/40/d599bf28.jpg" width="30px"><span>冻糕</span> 👍（12） 💬（2）<div>带我入门的师兄说推荐服务理论上限是100ms延迟，但实际上只会给你最多85ms的时间，超过就要必须优化。其中多路召回加重复过滤上限25ms，排序上限45ms 业务规则加生成json 上限10到15ms，请问老师这个延迟数据是否是业界通用的勒？</div>2021-04-14</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/qw7rRHUPRzhibxXWLG7kc3zkhZwBn4JZaryzko2eWOjSxDlRvUathHugrIVKhcCqxhtsANUTq0140AlbDkLZmcw/132" width="30px"><span>shenhuaze</span> 👍（9） 💬（5）<div>王老师，如果推荐服务选择java和jetty，那么如果要上线基于tensorflow或者pytorch训练的深度学习模型，是需要自己用java改写预测的代码吗？还是有什么现成的解决方案？</div>2020-10-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/9a/fe/a984c940.jpg" width="30px"><span>雪焰🐻🥑</span> 👍（8） 💬（4）<div>王老师好，请问对于：“在一个成熟的工业级推荐系统中，合理的缓存策略甚至能够阻挡掉 90% 以上的推荐请求，大大减小推荐服务器的计算压力”，我理解每个用户的请求，在不同的时间，地点，context下是不一样的，这样千差万别的请求，数量级应该很大，不知道是如何把大部分都缓存起来的呢？谢谢</div>2020-10-24</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIf6b0zNIdVqOAMqT78lo39PdJB9qRIXqbwoOGlAEapFFezPiaFqCbUXS7VwI04MymFicgmsuOkILaQ/132" width="30px"><span>Geek_8197bf</span> 👍（4） 💬（2）<div>请问老师，工业界推荐算法的实现都是Java和C++吗？Python流行吗？我只会Python，在犹豫要不要做推荐</div>2021-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/88/d7/07f8bc6c.jpg" width="30px"><span>sljoai</span> 👍（4） 💬（2）<div>老师您好，本文中提供的服务降级方案是从业务功能上来说的，降低服务能力，那系统是如何感知到系统压力，同时反馈到实际服务能力的选择上的呢？另外，像Istio、SpringCloud、Dubbo这种服务框架中也包含服务降级的方案，与您文中提到服务降级方案相比较，有什么异同呢？这一块比较疑惑，希望老师能解答一下，谢谢！</div>2020-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/e2/4e/c3e86856.jpg" width="30px"><span>笑笑是个好孩子</span> 👍（3） 💬（1）<div>这里的缓存和把召回到的结果保存到abase之类的k-v存储中 是一样的吗</div>2021-06-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/25/72/73/d707c8be.jpg" width="30px"><span>MutouMan</span> 👍（1） 💬（1）<div>按能力来平均分配是比较方便的操作，如果想进一步优化，是不是可以根据请求的类别来设计不同核载的节点然后进行分配？比如冷启动相关的推荐就可以专门有一个轻量的节点处理。节点的扩展和关闭可以设计一个阈值来控制吧，总请求数超过时就扩展，反之关闭。</div>2021-04-30</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKOz2PzU4u9Wapf4UqTr7HvWicicasOJfg0PD2Jp6cFepr3ztAg6mYfDialxQwa47K3uaSuWxnS84bkQ/132" width="30px"><span>吃数据的小毛虫</span> 👍（0） 💬（1）<div>王老师，您好。有一个小疑问需要向您请教一下，在本节的MovieService示例代码中，

&#47;&#47;获得请求中的id参数，转换为movie id            
String movieId = request.getParameter(&quot;id&quot;);

获取的id实际就是movieid，因此将变量命名为了movieid，所以是不是将代码注释中的“转换”一词换为“命名为”更为合适呢？我个人理解“转换”一词暗示着有一个从A到B的过程或者操作，这里其实并没有，本质上id就是movieid，只是叫的名字变了。不知道我的理解对不对，请指正。谢谢～</div>2021-09-04</li><br/><li><img src="" width="30px"><span>行行行</span> 👍（0） 💬（1）<div>老师你好，线上服务如何做到模型实时更新的呢</div>2020-10-23</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erAhtlpeFFwRk5g5LvzLcZgybImECIdKmhG1aPxdbnqWP6LmeNz5ibYibOedUwF7NjTy1asZqUur5uQ/132" width="30px"><span>kenan</span> 👍（0） 💬（3）<div>王老师，您好，请教一下，离线推荐和在线推荐的请求方式是什么？还有粗排和精排有那些方案？最好，关于这两方面内容，您有什么资料推荐一下？</div>2020-10-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/b2/cb/9c6c7bf7.jpg" width="30px"><span>张弛 Conor</span> 👍（7） 💬（1）<div>有一个小错误，文中说输入http:&#47;&#47;localhost:6010&#47;getmovie?movieId=1可以看到 getmovie 接口的返回对象，但在代码里访问提取的参数是id，所以这里应该输入的链接是：http:&#47;&#47;localhost:6010&#47;getmovie?id=903。供其他小伙伴参考。
第一个问题，如何在各节点之间分配任务？我认为首先要清楚各节点的能力，比如cpu性能、核数，内存，磁盘存储，显存；第二步是要识别这个任务的特点，比如我能想到的有A.任务的紧迫性。这个可以通过维护一系列优先队列来管理。B.任务的并发性。这个任务是否可以分成很多个任务同时去执行，可以分到多细去执行。但不太清楚这个可以如何去很好的识别。C.任务的工作量。即完成这个工作所需耗费的资源，这个可以通过数据量和分解到的子任务去判断；第三步，就是根据任务的特点和工作节点的能力去尽可能好的匹配。
第二个问题，如何知道什么时候应该扩展节点，什么时候应该关闭节点？
这个可以通过观察节点的资源利用率，如果现有运行节点的资源利用率很高，而排队的任务又很多，那么就可以扩展节点，相反，如果节点的资源利用率不高，也没有太多的排队任务，那么就可以适当关闭节点。</div>2020-10-23</li><br/><li><img src="" width="30px"><span>Geek6847</span> 👍（0） 💬（0）<div>我们有工业级的推荐系统，前端的接入层也可以承接千万级并发，但是资源经常还是出现CPU、内存之类的跑到100%。想问下你们的体量下，如何保障线上推荐系统的稳定性？以及你们怎么把控后台服务的成本的？</div>2022-04-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/29/be/56/6a2998ba.jpg" width="30px"><span>คิดถึง </span> 👍（0） 💬（0）<div>老师好，我想修改项目的访问地址，比如把http:&#47;&#47;localhost:6010&#47;改为http:&#47;&#47;localhost:6010&#47;sparrow&#47;，该怎么办呢？</div>2021-08-24</li><br/>
</ul>