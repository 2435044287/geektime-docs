你好，我是徐文浩。

在过去的十几讲课程里，我带你一起学习完了GFS、MapReduce，以及Bigtable这三篇被称之为Google的“三驾马车”的论文。不知道你有没有发现，这三篇论文有一个共同点，那就是这三个系统**都是一个单Master系统**。而这就带来了一个问题，就是这个Master会成为整个系统的单点，一旦Master出现硬件故障，或者遇到Master网络不通的情况，整个集群就不能提供完整的服务了。

MapReduce里的Master我们可以暂且不论，毕竟这个Master的生命周期只是一个MapReduce任务执行的时间，即使Master出了问题，简单地重跑一下任务就好了。但是GFS和Bigtable，都是要长时间提供在线服务的系统。从概率的角度来讲，它们的Master也一定会遇到故障。

所以，在GFS和Bigtable的论文里，我们看到它们都有对应的Backup Master机制。通过一个监控机制，当发现Master出现问题的时候，就自动切换到数据和Master完全同步的Backup Master，作为系统的“灾难恢复”机制。

乍一听，这个做法简单直接。不过如果仔细想一想，这个操作可没有那么容易实现。我们至少会遇到两个问题：
<div><strong>精选留言（14）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg" width="30px"><span>piboye</span> 👍（10） 💬（0）<div>三阶段提交是我看过课程里讲的最好的，给老师一个赞</div>2022-01-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/20/b7/bdb3bcf0.jpg" width="30px"><span>Eternal</span> 👍（4） 💬（0）<div>二阶段和三阶段的理解和学习需要一开始就建立一个模型，协调者，参与者，提交请求，提交执行，协调者硬件故障，参与者硬件故障，两阶段或三阶段的哪一个阶段那个角色出现故障？两阶段或三阶段的哪一个阶段那两个角色通讯网络故障？只有举例模型和例子的基础上自己推演才能理解深刻且记得住。
然后用mysql大家最熟悉的事务模型中的undo、redo 日志准备好但是未真正的提交事务这个例子来类比更方便大家理解这是我自己的感悟。两阶段，三阶段，cap等基础概念看过很多次，但是要融于自己的知识体系，条件反射的说出来，且在讨论问题的时候会不假思索利用到这个还是有难度的。简单的能把理论记住，或只在讨论这个理论知识的时候能分析出来，这个都不是最终目的。</div>2023-03-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/66/8f/02be926d.jpg" width="30px"><span>在路上</span> 👍（4） 💬（2）<div>徐老师好，在两阶段提交这个策略下，一旦 Backup Master 节点出现问题，其实整个系统都是不能写入的。听起来意味着 Master 和 Backup Master 都不能出现故障，那 Backup Master 只是在增加出现故障的概率。如果需要提升可用性，为什么不在 Backup Master 出现问题的时候只写 Master ，等 Backup Master 恢复后再同步数据？两阶段提交和三阶段提交的根本问题在于单点故障，要解决这个问题应该需要用一个集群提供协调者服务， Backup Master 可以从一组节点中选举。

回到老师的思考题，我看到有的学友说是 client 是协调者，有的学友说 Backup Master 是协调者，我觉得如果两阶段提交的所有请求都要经过协调者，协调者应该是Master或者其他服务。如果 client 是协调者的话，没法保证多个 client 请求之间的顺序，也就是协调者应该是个单点服务。如果是 Backup Master ，那么客户端就形成了对 Backup Master 的直接依赖，也就不应该叫 Backup Master，另外选择Backup Master作为协调者并不能节省流量，因为所有的请求都要发给 Master 和 Backup Master。</div>2021-10-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/34/df/64e3d533.jpg" width="30px"><span>leslie</span> 👍（3） 💬（0）<div>《数据密集型应用系统设计》此书算是近年相对的经典，已经看了近十遍，总觉得自己理解的浅。中文版的翻译质量算是难得的上品，老师是看中文版还是英文版，是不是版本翻译中还是有欠缺？总觉得有些点没有提及到，不知道是不是翻译的问题，图倒是原版继承了。</div>2021-10-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/15/86/15b942d6.jpg" width="30px"><span>扭高达💨🌪</span> 👍（3） 💬（2）<div>思考题: 协调者应该是client端😂</div>2021-10-15</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/wa14QN7fdaXRzSZ4FOERZpxfJ6C8v7kxQg9Px7Vqn1XlVDVyoliaxprrme5l72N3Ey7XMewmOhPOtdOgR8q8A3w/132" width="30px"><span>龚诚</span> 👍（1） 💬（0）<div>bookeeper、zookper</div>2022-05-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/ea/9a/02d589f9.jpg" width="30px"><span>斜面镜子 Bill</span> 👍（1） 💬（0）<div>我理解是有back master充当的，一方面备不提供服务，可以优化主的性能，其次，如果主挂了起码可以把备选成主，而不至于系统不服务</div>2021-10-22</li><br/><li><img src="" width="30px"><span>Geek_88604f</span> 👍（1） 💬（0）<div>二阶段提交和三阶段提交实际很少使用了。实践中使用的都是基于使用场景的改进版，像TCC、基于MQ的一致性保证等</div>2021-10-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8f/60/be0a8805.jpg" width="30px"><span>陈迪</span> 👍（1） 💬（0）<div>Chubby是到现在为止最难懂的论文。。一些例子和设计决策依据让人不知所云</div>2021-10-15</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83er9zZfF5Qicp3Tz18IQqPrDWR4yO5LibpXWLC1CEutiaYckHsTc8vRbUwC1qYSdvaFCpMGsA14AlXic5Q/132" width="30px"><span>Geek_546d35</span> 👍（0） 💬（0）<div>想问一下三阶段提交时，需要两阶段类似的问题，如DoCommit时候参与者B挂掉，如何处理参与者A和参与者B之间的同步呢，也是让参与者A先等待一下吗</div>2023-10-09</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIVR2wY9icec2CGzZ4VKPdwK2icytM5k1tHm08qSEysFOgl1y7lk2ccDqSCvzibHufo2Cb9c2hjr0LIg/132" width="30px"><span>dahai</span> 👍（0） 💬（1）<div>三阶段提交和两阶段提交最后提交之前要解决的问题是一样的，为什么说一个牺牲了可用性，一个牺牲了一致性。最起码我认为两个都是没有一致性的。最后提交阶段总会出现网络中断，服务器不稳定的情况。</div>2022-01-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/1b/e1/4da78104.jpg" width="30px"><span>Bob</span> 👍（0） 💬（0）<div>二阶段的过程中，如果第一阶段提交已经完成，第二阶段提交执行过程一个节点与协调者的网络一直中断或者该节点一直硬件故障，那么此时会出现什么情况，协调者会一直等待下去吗?</div>2021-11-14</li><br/><li><img src="" width="30px"><span>Geek_789fcf</span> 👍（0） 💬（1）<div>有个逻辑不太明白，3PC里参与者B网络中断，等待超时，仍然提交事务？为什么doCommit阶段参与者A会回滚事务</div>2021-10-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4e/1b/f4b786b9.jpg" width="30px"><span>飞翔</span> 👍（0） 💬（1）<div>三阶段提交🈶️用在生产上的例子吗</div>2021-10-15</li><br/>
</ul>