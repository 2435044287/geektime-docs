你好，我是徐文浩。

Spanner在设计时候的目标之一，就是需要保障外部一致性（external consistency）。而这个外部一致性，其实也就是我们之前说过的可线性化（Linearizability）。通过上节课的学习，现在我们已经知道了，这是一个非常有挑战的目标。其中**最大的挑战，在于不同服务器的时钟的差异。**

Spanner采用了两个主要的策略来解决这个问题，第一个是通过原子钟和GPS时钟，尽可能地缩短服务器之间的时钟差异。另一个，则是在实现分布式事务的时候，把时钟差异考虑进去，实际的事务提交会进行一定的等待，确保数据写入一定是考虑了最大误差和参与者最快的时钟下，才会实际提交事务。

那么，今天我们这节课，就会深入来讲解Spanner的这个分布式事务具体是怎么实现的。并且在这个过程中，我们会深入探讨分布式事务的可串行化和可线性化两个概念的差异在哪里。在学完这节课之后，我希望你能够收获两点：

- 第一个，自然是**Spanner的分布式事务，具体是怎么实现的**。这个也有助于你了解最新一代的分布式数据库的实现，现在已经有不少新的数据库，都是师从Spanner的论文了。
- 第二个，是深入理解**分布式数据库的可串行化和可线性化概念的相关性和差别**。分布式数据库的主要挑战，就来自这两方面。
<div><strong>精选留言（5）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/15/66/8f/02be926d.jpg" width="30px"><span>在路上</span> 👍（10） 💬（0）<div>徐老师好，在Spanner论文的最后一页，描述了Paxos Leader-Lease Management，证明了Leader切换后时间戳的单调递增性。Leader选举需要多数Paxos成员的支持，所以一定存在一个Paxos成员同时参与了前后两轮选举，假设这个成员为r0，任何Paxos成员参与Leader选举之后，10秒之内不会再参与选举，Leader租期的结束时间由投支持票的Paxos成员的投票时间决定，选择最小的投票时间加上10秒。如果r0的投票时间是最小时间，那么下一轮Leader选举响应时间在10秒后，Leader切换后时间戳单调递增。如果r0的投票时间不是最小时间，那么下一轮Leader选举响应时间更在10秒后，Leader切换后时间戳单调递增。这个说明过程省略了earliest和latest之分，更详细的可以看看论文。</div>2021-11-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/66/8f/02be926d.jpg" width="30px"><span>在路上</span> 👍（4） 💬（0）<div>徐老师好，论文第4.2.2节提到，如果只读事务只涉及一个paxos group，读操作的时间戳选择Leader的LastTS()，如果涉及多个paxos group，读操作的时间戳选择本地的TT.now().latest()，这个时间可能会超过t_paxos_safe，需要等待safe time的推进。在没有新的事务发生时，如果依靠每8秒钟更新一次的MinNextTS(n)推进safe time，我觉得读操作太慢了。我在Life of Cloud Spanner Reads &amp; Writes中读到多节点的Strong Read，副本不知道自己是不是最新的情况会去请求Leader，我觉得这是更快的方法。</div>2021-12-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/20/b7/bdb3bcf0.jpg" width="30px"><span>Eternal</span> 👍（1） 💬（0）<div>粗浅理解：所有事务请求都是按照全局绝对时间来顺序执行的，通过在不同事务时间点前后插入误差时间来使得事务之间是按照绝对时间串行执行。然后通过原子钟+GPS来保障绝对时间误差足够小，最坏情况是7毫秒，也就是极限情况2阶段来算，每个事务可能浪费2阶段*14ms=28毫秒，这是最坏的情况，实际可能更小；那这样来的话，全局时间就是一个单点了，如果后续技术进步，全局时间的误差能控制得更小，比如1ms内，那简直就是完美</div>2023-03-28</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKJrOl63enWXCRxN0SoucliclBme0qrRb19ATrWIOIvibKIz8UAuVgicBMibIVUznerHnjotI4dm6ibODA/132" width="30px"><span>Helios</span> 👍（1） 💬（0）<div>一般的数据中心没有原子钟和 GPS 时钟，是不是就不适合使用spanner这类的数据库了呢。或者用了话，导致时间区间会很大</div>2021-12-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/79/70/01a9c59e.jpg" width="30px"><span>霍彦文</span> 👍（0） 💬（0）<div>老师我们会有这批论文的解读吗？ lightning: HTAP as a service - ACM Digital Library</div>2022-01-03</li><br/>
</ul>