你好，我是范学雷。

上一讲，我们列举了常见的单向散列函数，我们还知道了退役的、遗留的和现行的算法，通过对处理能力限制和算法的性能的讨论，我们对如何选择哈希算法有了更明确的认知。

还记得我们留了一个小尾巴吗？我们提到了“长度延展攻击”。“长度延展攻击”是怎么一回事？我们为什么要了解它？在单向散列函数的使用上，我们需要注意哪些安全问题？

这就是我们这一次要解决的事情。

## 什么是长度延展攻击？

我们先来看看什么是“长度延展”，这样会有利于你理解“长度延展攻击”。

现在，假设我们有两段数据，S和M，以及一个单向散列函数h。如果我们要把这两段数据合并起来，并且还要计算合并后的散列值，这就叫做单向散列函数的长度延展。

不过，问题来了，是S放在前面（h(S|M)），还是M放在前面（h(M|S)）？既然，我们说，散列值是无法预测的，那么，数据编排的顺序有意义吗？

如果S和M都是公开的信息，顺序是不重要的。可如果S是机密信息，M是公开信息，这两段数据的排列顺序就至关重要了。**如果机密信息放在了前面，就存在“长度延展攻击”的风险**。

弄清楚了长度延展，长度延展攻击就很好理解了，就是说我们可以利用已知数据的散列值，计算原数据外加一段延展数据后的散列值。也就是说，如果我们知道了h(S|M)，我们就可以计算h(S|M|N)。其中，数据N就是原数据追加的延展数据。
<div><strong>精选留言（23）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/23/a6/84/5ca855d6.jpg" width="30px"><span>zzzz</span> 👍（16） 💬（1）<div>老师，我可能理解的特别不好，但是找了好多资料依然不能理解这个“长度延展攻击”，反而越找越乱，所以只能来留言问您了，希望您还能回复。
1，什么是机密信息啊？机密信息是只有写机密信息的人才能用的机密信息吗？机密信息的作用是什么呢？
2，M是一般信息，S表示机密信息，为什么我们额外加的数据N只能在M后面而不能在S后面呢？无论S和M如何组合，不都是信息吗？我们把S和M的任意排列认为是data的话，按照图里说的，hash(hash(data)+自己加的数)=hash(data+自己加的数) 这个公式都是成立的啊，所以S和M如何排序重要吗？
3 ，长度延展攻击到底想做什么啊，只是得到hash(data+自己加的数)  有什么作用吗？
老师，我看大家都没有问过我说的这些问题，所以可能我理解的特别特别不好。但是我也真的认真看了，也对不懂的地方查了很多很多资料，还是不明白，希望老师能够帮助我，谢谢老师！
</div>2021-01-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/0e/94/4a2bb019.jpg" width="30px"><span>Lorin</span> 👍（3） 💬（1）<div>老师，我有两个问题：
1、长度延展攻击中，补齐数据是怎么获取到的啊？
2、长度延展攻击后，原散列值和扩展数据的散列值肯定不一样，这样的话，接收者都已经知道收到的数据与原散列值不一致了，这个时候长度延展攻击有什么意义呢？</div>2020-12-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/9a/8c/aeadf040.jpg" width="30px"><span>Reol</span> 👍（2） 💬（1）<div>老师我还有个小问题，发送者是否要公开自己的加密算法？

按理说没有公开加密算法的必要，那么接收者不知道加密算法什么都做不了，不知道分组大小和压缩函数的固定处理位数，无法反推每个分组的输出向量，也不知道补充数据的格式。最重要的是没有算法无法自己计算延长数据的散列值。</div>2021-08-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/70/67/0c1359c2.jpg" width="30px"><span>qinsi</span> 👍（2） 💬（2）<div>疑问：补齐数据应该是由数据长度决定的，那么在不知道机密数据 S 的长度的情况下，攻击者要如何知道该补多长的数据？跟 S 在前或在后有关吗？</div>2020-12-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/9a/8c/aeadf040.jpg" width="30px"><span>Reol</span> 👍（1） 💬（1）<div>老师我有两个小问题，求解答！！！！！！

假设：S私密，M公开，N延长

1. 关于长度延展的理解：对于散列值 h(S|M)，因为可以根据终结函数的顺序输出，来推断出每个原文分组的压缩函数的输出。所以延长实际上的操作是，推断提取出散列值 h(S|M) 中最后一个分组的压缩函数输出向量，将其作为初始向量来运算散列值 h(N)，然后直接拼接两个散列值 h(S|M) + h(N) = h(S|M|N)，结果就是消息S|M|N的散列值 ，这样理解对吗？

2. 按照我对专栏原文还有配图的理解，在延长攻击中原文 S|M 后面要加上补充数据 (假设为m)，然后再加上N和其补充数据 n。这样得出的 h(S|M|N) 实际上是 h(S|M|m|N) 对应的原文应该是 S|M|m|N 而不是 S|M|N，所以验证时是把原文 S|M|Bm|N 和  h(S|M|m|N) 发给S的持有者来验证。但这样S的持有者获得的原文里面M和N中间多了一段意义不明的m，S的持有者不会觉得奇怪吗？</div>2021-08-06</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIuUYcwKWUuib5mpdIbTwQzTGNWBmk0ktZSwm2vteUXf4TxWF2aVCv7Hvshcq0OaG7JRLj6rJyPLicA/132" width="30px"><span>godliness</span> 👍（0） 💬（1）<div>你能不能找到一些场景，可以让我们不用担心原始的散列值被更改，单纯使用单向散列函数就可以校验数据完整性？

老师，TLS 中的数字签名算不算呢？</div>2023-10-25</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIuUYcwKWUuib5mpdIbTwQzTGNWBmk0ktZSwm2vteUXf4TxWF2aVCv7Hvshcq0OaG7JRLj6rJyPLicA/132" width="30px"><span>godliness</span> 👍（0） 💬（1）<div>老师，上面 S 和 M 在防伪领域是不是经常用到？</div>2023-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/b1/75/60a71bbd.jpg" width="30px"><span>Ankhetsin</span> 👍（0） 💬（1）<div>老师，md6和国密sm系列算法怎么样？</div>2022-01-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/a9/cb/a431bde5.jpg" width="30px"><span>木头发芽</span> 👍（0） 💬（1）<div>引用问题:
&quot;散列值的计算是公开的，给定一段数据，谁都可以计算它的散列值。如果数据可以被修改，而且给定的散列值也是修改后的数据的散列值，这个数据完整性校验是没有意义的。&quot;

方案:
给数据+盐后计算散列值, 这个盐是一定规则生成不在网络上传输的,如果攻击者替换了数据和散列值,但因为不知道盐值,跟验证者生成的散列值不一致,就知道数据被串改,
该方案是否可行?</div>2021-05-21</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqy3lXp1RcSlabmQJKxULT6s5r6TOtLxRO5JB8BDBUmsjw0gPqfmCHcXwuqVaUg3t9Iianib6ASAsVQ/132" width="30px"><span>bugs</span> 👍（0） 💬（2）<div>老师好，
散列算法的数据分组是连序性的吗？如果是的话，链接模式能保证靠前的数据块修改后的雪崩效应，不能保证靠后数据块修改的雪崩效应。</div>2021-03-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/a6/84/5ca855d6.jpg" width="30px"><span>zzzz</span> 👍（0） 💬（1）<div>老师，追写一下我自己的思路，如果前一条问题太多太···不知如何回答，老师看看我对上面的问题的理解对不对：
首先，长度拓展攻击的目的就是，根据已知的hash(A),得到hash(A+B)，其中，B是自己随意加的数据
机密数据S就相当于一个身份，有机密数据的人就想相当于有这个身份，，这个人传递的信息就是hash(S+M)，其中S表示机密数据身份，M表示他想传递的信息。比如这个人是一个长官，S就是他的长官身份，M就是他传递的命令，这个hash值就传给他的下属。但是现在有一个人想要冒充长官给下属下发命令N，于是他就把自己想要追加的命令放在原来的S+M后面，构成S+M+N。下属们收到hash之后，因为这个hash依然是有S的，所以下属们以为这个就是他们长官的命令，所以连M和N这两个命令都执行了。所以长度有效攻击的作用就是冒充身份，让自己的hash里带上S
对吗老师</div>2021-01-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/d8/68/89770b8b.jpg" width="30px"><span>LXX</span> 👍（0） 💬（2）<div>老师好，把原来的散列值作为压缩函数的一个输入，再按照数据补齐规范，去补齐原来数据到数据分组的整数倍，然后加入新的数据，我们就可以计算原数据和扩展数据的散列值了，这块不是很理解，可以详细讲述一下吗？我不是很清楚为什么通过这个方式就可以计算原数据和扩展数据的散列值，或者有什么文章可以推荐借鉴理解的。谢谢老师
</div>2021-01-11</li><br/><li><img src="" width="30px"><span>wrzgeek</span> 👍（0） 💬（1）<div>是不是可以这样理解，无论是(M|S)还是(S|M)结构，延展数据N都是要紧跟着M的，也就是延展后的数据结构是(M|N|S)或者(S|M|N)，这样的话，对于S在后边的结构，就无法进行延展攻击了。</div>2020-12-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/cb/6f/b6693f43.jpg" width="30px"><span>Litt1eQ</span> 👍（0） 💬（1）<div>单纯使用单向散列函数就可以直接校验数据的完整性，我想到了存储在数据库中的密码，通常情况下存到数据库中的密码是不会直接存储明文的，一般都是把用户的原始密码经过散列之后保存，这样我们校验用户输入的密码经过散列之后和数据库存贮的散列值进行比较，感觉并没有考虑到数据库当中的散列值被修改的情况。
我记得在区块链中，好像是利用散列计算的困难性，找到一个某个满足要求的散列值。</div>2020-12-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/70/67/0c1359c2.jpg" width="30px"><span>qinsi</span> 👍（0） 💬（2）<div>感谢解答。看来猜测数据长度是需要一个Oracle存在的（比如服务端返回请求是否合法）。下一个问题是，假设已知数据的长度，那么无论机密数据 S 在前或在后，应该都能得到补齐数据才对，为什么说放在后面的时候攻击就不起作用了呢？</div>2020-12-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/7b/03/03583011.jpg" width="30px"><span>天天有吃的</span> 👍（0） 💬（2）<div>小白追更打卡，不熟悉的感觉越来越多了，麻烦老师了.. 
问题1：机密数据放后面是哪个步骤的后面，是终结函数前的h5吗？

为题2：知道了 h(M|S)也可以知道h(M|S|N)，还是放在最后即h(M|N|S)？

问题3：比如我是机密数据持有者，是给有权限的人分发S、M的散列值（散列值就是签名）；然后我能收到一段数据（就是需要重新对比签名的），数据跟这个签名有什么关系呢（或者说被授权者拿这个签名干什么）？

问题4：终结函数就是把压缩函数的输出向量排列成一个字节串 =&gt; 知道了字节串，我们也就知道了压缩函数的输出向量，这里的输出向量指的是什么&#47;有什么作用？

问题5：就算是伪造了一个散列值（即长度延展攻击），有什么危害呢？可以想到的是被授权方用延展后的签名作用于数据上，持密者就无法验证签名相同了？

问题6：理论性比较多，有点没法跟自己接触过的代码结合起来想了，有一种懂一点又不懂自己懂了什么的感觉=_=|，有没有代码跑一跑看一看？

问题7：如果比较基础的书籍或者课程推荐的吗（或者学习路径，比如需要数学什么...代码知识什么..），专栏两天一讲，还是有空闲的时间补补基础的？
</div>2020-12-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/89/5b/d8f78c1e.jpg" width="30px"><span>孜孜</span> 👍（0） 💬（1）<div>突然有个脑洞，既然散列函数在计算量足够大的情况下可逆。那么在不考虑计算量的情况下，散列函数是不是时间上最牛的压缩算法? 或许即使可逆，也可能逆出无数种原数据，也无法得到真实的原数据?</div>2020-12-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/ce/c6/958212b5.jpg" width="30px"><span>sugar</span> 👍（0） 💬（3）<div>老师 我有个关于密码学具体的应用场景下的问题，想听听您的看法。假设现在有一个文件，使用aes算法 进行了对称加密，想解密需要知道密钥才行。而我们这几节课探讨的加密算法的强度，我理解其实就是用程序进行枚举所有可能的密钥。但我想问，一个文件被加密之后，暴破时又是怎么知道每一次尝试时 得到的文件明文 真的是文件的真实内容呢？ </div>2020-12-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/b8/24/039f84a2.jpg" width="30px"><span>咱是吓大的</span> 👍（2） 💬（0）<div>对长度延展攻击，可否理解为：如果把机密信息比作正宗猪肉，最后的散列值比作火腿肠，那么延展数据可以认为是其它不知道什么东西的黑暗肉类，反正最后的产品是一个味道。</div>2021-01-22</li><br/><li><img src="" width="30px"><span>单芮</span> 👍（1） 💬（0）<div>问题1：以SHA-256为例，分组数据块中不是有64位用来表示输入数据的长度吗
长度延展攻击后，每个数据块中的数据长度表示部分不需要修改吗
问题2：SHA-256为什么以64位来表示输入数据的长度，有些不明白，有什么计算公式吗</div>2022-01-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg" width="30px"><span>ifelse</span> 👍（0） 💬（0）<div>单纯使用单向散列函数去校验数据的完整性，我们需要确保给定的散列值是不能被修改的，这就是这个使用场景的限制。--记下来</div>2022-11-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg" width="30px"><span>ifelse</span> 👍（0） 💬（0）<div>学习打卡</div>2022-11-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/a7/b2/274a4192.jpg" width="30px"><span>漂泊的小飘</span> 👍（0） 💬（0）<div>sha-3因为没有原文长度补齐所以不会被攻击？那sha-3有什么特别的补齐方式吗？没有长度补齐不就是10000，不也能被攻击吗</div>2021-09-24</li><br/>
</ul>