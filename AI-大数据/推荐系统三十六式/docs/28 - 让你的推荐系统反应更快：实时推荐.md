更快，更高，更强，不只是奥林匹克运动所追求的，也是推荐系统从业者所追求的三个要素：捕捉兴趣要更快，指标要更高，系统要更健壮。

我今天就要说的就是这个“更快”。推荐系统是为了在用户和物品之间建立连接，手段是利用已有的用户物品之间的连接，然而任何事物都是有生命周期的，包括这里说的这个虚无的“连接”也是有的。

## 为什么要实时

一个连接从建立开始，其连接的强度就开始衰减，直到最后，可能用户不记得自己和那个物品曾经交汇过眼神。因此，推荐系统既然使用已有的连接去预测未来的连接，那么追求“更快”就成了理所当然的事情。

用户和物品之间产生的连接，不论轻如点击，还是重如购买，都有推荐的黄金时间。在这个黄金时间，捕捉到用户的兴趣并且给与响应，可能就更容易留住用户。

在业界，大家为了高大上，不会说“更快”的推荐系统，而是会说“实时”推荐系统。实际上，绝对的实时是不存在的，哪怕延迟级别在微秒的推荐，也是会有延迟的。但是为了顺应时代潮流，我还是会在后面的内容中说这是实时推荐，你就那么一听，知道就好。

关于到底什么是实时推荐，实际上有三个层次。

- 第一层，“给得及时”，也就是服务的实时响应。这个是最基本的要求，一旦一个推荐系统上线后，在互联网的场景下，没有让用户等个一天一夜的情况，基本上最慢的服务接口整个下来响应时间也超过秒级。达到第一层不能成为实时推荐，但是没达到就是不合格。
- 第二层，“用得及时”，就是特征的实时更新。例如用户刚刚购买了一个新的商品，这个行为事件，立即更新到用户历史行为中，参与到下一次协同过滤推荐结果的召回中。做到这个层次，已经有实时推荐的意思了，常见的效果就是在经过几轮交互之后，用户的首页推荐会有所变化。这一层次的操作影响范围只是当前用户。
- 第三层，“改得及时”，就是模型的实时更新。还是刚才这个例子，用户刚刚购买了一个新的商品，那需要实时地去更新这个商品和所有该用户购买的其他商品之间的相似度，因为这些商品对应的共同购买用户数增加了，商品相似度就是一种推荐模型，所以它的改变影响的是全局推荐。

## 实时推荐

好，下面就讲一下如何构建一个处在第三层次的实时推荐系统。

### 1.架构概览

按照前面的分析，一个处在第三层次的实时推荐，需要满足三个条件：

1. 数据实时进来
2. 数据实时计算
3. 结果实时更新

为此，下面给出一个基本的实时推荐框图。

![](https://static001.geekbang.org/resource/image/7a/ca/7a49fb338192bf1865670a42cb6c89ca.png?wh=1492%2A908)

整体介绍一下这个图，前端服务负责和用户之间直接交互，不论是采集用户行为数据，还是给出推荐服务返回结果。

用户行为数据经过实时的消息队列发布，然后由一个流计算平台消费这些实时数据，一方面清洗后直接入库，另一方面就是参与到实时推荐中，并将实时计算的结果更新到推荐数据库，供推荐服务实时使用。
<div><strong>精选留言（7）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/22/69/c85fdb98.jpg" width="30px"><span>微微一笑</span> 👍（5） 💬（1）<div>基于长期兴趣的推荐不适合实时去更新？</div>2018-05-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/35/df/67f91c36.jpg" width="30px"><span>帅帅</span> 👍（6） 💬（1）<div>对于到来的用户，我会用两种方式处理：
1、如果是回头客旧用户，直接去除PUSH的推荐列表返回；
2、如果是新用户，直接返回热榜兜底；同时流计算会异步的获取用户画像、召回、排序、更新REDIS缓存；那么这个新用户几秒钟之后刷新页面，就会展示个性化列表；</div>2018-09-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c1/a7/5e66d331.jpg" width="30px"><span>林彦</span> 👍（5） 💬（0）<div>embedding的策略是不是不太适合实时推荐时更新？
大量不同数据的多聚类模型的中心或参数更新是不是不适合实时推荐？</div>2018-05-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/df/f0/9a6a40a5.jpg" width="30px"><span>丸子</span> 👍（1） 💬（1）<div>请问实时推荐这块有没有相应的代码可供参考呢，有的话去哪里找
</div>2019-02-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/a2/76/bdea7aa1.jpg" width="30px"><span>晨晓</span> 👍（0） 💬（0）<div>实时推荐需要的表设计挺重要的</div>2020-03-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7e/61/8f7a9cd8.jpg" width="30px"><span>嘉文</span> 👍（0） 💬（1）<div>感觉邢大讲的主要是实时更新已有用户和已有物品之间的行为数据，及其模型

对于实时的新增用户和新增物品呢？</div>2018-07-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/22/69/c85fdb98.jpg" width="30px"><span>微微一笑</span> 👍（0） 💬（0）<div>请教一下还有哪些策略不适合实时推荐？</div>2018-05-10</li><br/>
</ul>