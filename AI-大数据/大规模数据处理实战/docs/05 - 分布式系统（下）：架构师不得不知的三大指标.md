你好，我是蔡元楠。

上一讲中，我们学习了如何用服务等级协议（SLA）来评估我们设计的分布式系统，并了解了几个常见的SLA指标。

今天我们继续来探索分布式系统的另外几个重要基础概念。

## 可扩展性

还是从我们为什么需要分布式系统讲起。原因是我们要面对的数据量越来越大，从GB到TB再到现在的PB级，单机无法胜任这样的工作。

工作中也常有这样的场景，随着业务变得越来越复杂，之前设计的系统无法处理日渐增长的负载。这时，我们就需要增加系统的容量。

分布式系统的核心就是可扩展性（Scalability）。

最基本而且最流行的增加系统容量的模型有两种: 水平扩展（Horizontal Scaling）和垂直扩展（Vertical Scaling）。

所谓水平扩展，就是指在现有的系统中增加新的机器节点。

![](https://static001.geekbang.org/resource/image/2f/4b/2fed13c9e11ae3c72d1b0b66809c3f4b.jpg?wh=1142%2A640)

垂直扩展就是在不改变系统中机器数量的情况下，“升级”现有机器的性能，比如增加机器的内存。

![](https://static001.geekbang.org/resource/image/75/01/75ca153b40ff6db8b424399cb7d3a601.jpg?wh=1142%2A640)

举个例子，假设你现在负责一批木材采伐的操作。你有3辆卡车，每辆车一次可以运25根木材。那么1小时最多可以运3辆卡车 * 25根木材 * 1小时=75根木材／小时。

如果要使这个系统的负荷量增加一倍，用水平扩展的办法，我们可以将卡车的数量增加到6辆；用垂直扩展的办法，我们可以使每辆卡车的运输量增加一倍，或者使每辆卡车的速度增加一倍。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/16/f7/54/138b51a1.jpg" width="30px"><span>3SKarl</span> 👍（40） 💬（2）<div>老师，我不太明白弱一致性和最终一致性的区别在哪里，文章对弱一致性提到
“经过不一致时间窗口这段时间后，后续对该数据的读取都是更新后的值”
这句描述的不就是最终一致性么

是不是说弱一致性允许数据始终不一致，而要求最终结果一致的弱一执性叫做最终一致性
</div>2019-04-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/89/4b/56d290f5.jpg" width="30px"><span>leeon</span> 👍（21） 💬（3）<div>朋友圈保证最终一致性即可，消息发布后，先保证“端”是可见的，等待网络请求后会确认最终有无发布成功，成功后最终其他人的timeline会收到</div>2019-04-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/41/27/3ff1a1d6.jpg" width="30px"><span>hua168</span> 👍（12） 💬（3）<div>老师我想问一下，所谓的强一致性，它允许的误差是多少范围？
比如金融股票大厅显示屏数据，应该是强一致性的吧，全球显示误差不会超过0.2s吧？
这样强一致性怎达到？网络传输，路由处理都不止了，更何况还有网络延迟</div>2019-04-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/dc/c3/e4ba51d5.jpg" width="30px"><span>Flash</span> 👍（7） 💬（1）<div>老师，消息队列的持久性第二点不是太能理解，意思是说消息发送者发完消息后，接收者下线了，然后接收者上线仍能收到吗？</div>2019-05-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4d/49/28e73b9c.jpg" width="30px"><span>明翼</span> 👍（3） 💬（1）<div>笔记总结：扩展性包括水平和垂直，水平扩展是增加水平类似的机器打群架方式，垂直扩展是现有的每个人提升实力，提升整体实力；一致性，集群上的数据为了保证高可用性显然要存在不同机器上存多份，这就存在不同机器数量同步问题，要求同步造成才可以进行读写的就是最终一致性，中间准许有个不一致时间窗的就是弱一致性，时间窗更长但是最终会统一的就是最终一致性，比如发微博场景，还讲了数据持久性，消息的持久性，一般类似kafka之类消息总线系统可以配置各种持久性要求，比如要求所有主和副本都同步，要求只要发给主即可，有的发送不需要确认。

关于问题：朋友圈属于最终一致性，信息推送晚一会不是特别重要，所以最终一致性满足要求</div>2019-04-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/db/80/6b7629d7.jpg" width="30px"><span>roaming</span> 👍（1） 💬（1）<div>看老师评论里说需要最终一致性和因果一致性，感觉这个因果一致性和Java内存模型里的happens-before好像</div>2019-05-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f8/4b/5ae62b10.jpg" width="30px"><span>Geek_b04b12</span> 👍（1） 💬（1）<div>这一节课，怎么让我想起了阿里李云华＜从零到架构师＞中提到的CAP理论，这大规模数据和架构师之间的知识看来是想通的着呀</div>2019-05-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/37/d0/26975fba.jpg" width="30px"><span>西南偏北</span> 👍（1） 💬（1）<div>消息队列声明持久性的意思就是，比如kafka即可以作为消息队列，同时又可以将消息持久化到broker节点上？</div>2019-04-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/f3/dc/80b0cd23.jpg" width="30px"><span>珅剑</span> 👍（0） 💬（1）<div>同问弱一致性和最终一致性的区别，最终一致性在弱一致性的基础上特殊在哪儿？
另外，最终一致性是保证每一次更新都会最终被同步还是只需要在没有新的更新时保证最后一条更新被同步？</div>2019-04-26</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLdWHFCr66TzHS2CpCkiaRaDIk3tU5sKPry16Q7ic0mZZdy8LOCYc38wOmyv5RZico7icBVeaPX8X2jcw/132" width="30px"><span>JohnT3e</span> 👍（50） 💬（2）<div>微信朋友圈评论主要由评论和后续回复组成：
首先，对于评论，评论内容对评论者而言应该要保证读写一致性（read-your-writes consistency），即评论一旦发出，那么对于该评论者无论在手机、网页还是其它城市应该都能看到其之前写的评论。而对于朋友圈可见的其它人来说，只要保证最终一致性（eventual consistency）就可以了（可能有时间要求），不同人的评论读取顺序无需和真实发生的顺序保持一致；
其次，对于评论的后续回复。回复内容对于回复者而言应该要保证读写一致性（read-your-writes consistency），而其它朋友圈可见的人一样，评论和回复内容应该按顺序被读取到，即需要保证一致前缀读（Consisten Prefix Reads）</div>2019-04-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/ee/16/742956ac.jpg" width="30px"><span>涵</span> 👍（6） 💬（0）<div>对于微信朋友圈的评论功能我想最终一致性，保护因果一致性的特征就够了。从需求角度，微信朋友圈是一种社交工具，不具有critical的特性，数据一致的实效性要求不高。每个独立评论的先后顺序也不那么重要。重要的是对于某一条评论的评论必须显示在派生这条评论的原始评论之后，否则用户读起来会很混乱。从最低成本满足需求的角度，因此最终一致性加上因果一致性特征即可。</div>2019-04-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/7e/8c/f029535a.jpg" width="30px"><span>hallo128</span> 👍（4） 💬（0）<div>恩~其实我好像没有听懂~介绍了几个概念的定义，但还是不理解它们之间的联系和差别。</div>2019-04-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/60/95/0b2a67fa.jpg" width="30px"><span>Geek_f80wzm</span> 👍（4） 💬（0）<div>ap模型，先保证评论的人自己能看见，再保证被评论的人和别人能看见。</div>2019-04-26</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/9chAb6SjxFiapSeicsAsGqzziaNlhX9d5aEt8Z0gUNsZJ9dICaDHqAypGvjv4Bx3PryHnj7OFnOXFOp7Ik21CVXEA/132" width="30px"><span>挖矿的小戈</span> 👍（3） 💬（0）<div>朋友圈采用最终一致性+因果一致性就好，只要保证评论及其派生评论是有序的，以保证其逻辑、语义上面不会出现混乱，场景对延时性要求不高；另外，有注意到手机端的微信和PC端的微信，会出现数据不一致的情况（特别是微信公众号订阅的文章，PC端少些文章）</div>2019-04-28</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLhMtBwGqqmyhxp5uaDTvvp18iaalQj8qHv6u8rv1FQXGozfl3alPvdPHpEsTWwFPFVOoP6EeKT4bw/132" width="30px"><span>Codelife</span> 👍（3） 💬（0）<div>以前曾经考虑过微信朋友圈这个一致性问题，最初认为是顺序一致性，仔细一想，如果是顺序一致性，成本太高，也没必要，对于微信朋友圈的评论来说，只有互为好友的人才能看到，评论也是互为好友的人，如果A发了朋友圈，所有人对A的评论，只有A才能完全看到，同时，B对A如果进行了评论，C对B的评论进行了评论，那么，对于A,B,C来说，C的评论肯定在B之后，只要保证互相能看到的评论一致即可，所以应该是因果一致性，至于如何的，暂时还没考虑</div>2019-04-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7c/0d/abb7bfe3.jpg" width="30px"><span>Trane</span> 👍（2） 💬（0）<div>弱一致性，场景可以容忍一定时间的延迟。</div>2019-04-26</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erdpKbFgRLnicjsr6qkrPVKZcFrG3aS2V51HhjFP6Mh2CYcjWric9ud1Qiclo8A49ia3eZ1NhibDib0AOCg/132" width="30px"><span>西北偏北</span> 👍（1） 💬（0）<div>为了提高系统的吞吐量，我们需要水平扩展。
水平扩展后，消息，数据在集群中的传输，需要可靠的一致性保证。由于是分布式，无法保证像单机一样的强一致，只能保证最终一致性

分布式集群中，可能涉及通过通信沟通，去保证最终一致性，但通信可能会丢失。要么通过算法去保证，即便通信丢失，集群也能协商出一个一致的结果，比如paxos和raft算法。要么通过可靠的消息中间件来保证消息的可靠传达和消费。</div>2019-06-13</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/V71wNP3XFiaNS7lVfluMkB01qia60dXN0lo8kibqBIlumXbZP7bQagdVS7YSs4YU4fqasMzdBdKrPjlVlTIdzztng/132" width="30px"><span>欢喜</span> 👍（1） 💬（0）<div>因果一致性。比如说A评论了，然后B评论了A的评论，只要保证A的评论在B对于A的评论之前就行了。</div>2019-04-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6b/e4/afacba1c.jpg" width="30px"><span>孙稚昊</span> 👍（1） 💬（0）<div>我觉得微信朋友圈只要最终一致就够了，没有对更新延迟那么高的要求</div>2019-04-26</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/3XbCueYYVWTiclv8T5tFpwiblOxLphvSZxL4ujMdqVMibZnOiaFK2C5nKRGv407iaAsrI0CDICYVQJtiaITzkjfjbvrQ/132" width="30px"><span>有铭</span> 👍（1） 💬（0）<div>我想请教老师，有些业务，不用关系数据库的话，如果处理分析需求(OLAP)?就我所知连google这样的公司某些时候还是必须用join来完成一些数据分析。比如下面这类需求，分布式系统里，用户表和订单表在不同的库里。请查出所有20-30岁用户的订单，并按照一定的规则进行数据统计。而20-30岁的用户数量可能非常庞大，十几万之多，这类的需求。非关系型的数据库，或者分布式系统如何做统计？统计现在才是大部分公司实施分布式数据处理的困难点，相反事务倒不是那么重要了，互联网企业的需求对强一致性要求没那么高</div>2019-04-26</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJnugUNWBtcszhJg3Q0hqEMSHftKco2TqCG78blZ3ibjncjZ64NbibGia5l4NB0DUibIq0BCZ03JvkoNA/132" width="30px"><span>Geek__e15575f5b6ec</span> 👍（0） 💬（0）<div>因果一致性</div>2023-04-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/86/79/066a062a.jpg" width="30px"><span>非同凡想</span> 👍（0） 💬（0）<div>微信朋友圈采用最终一致性，好友谁先看到都可以；
评论列表需要因果一致性，B评论A的朋友圈，C评论B的留言，存在因果关系。</div>2020-12-15</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/QD6bf8hkS5dHrabdW7M7Oo9An1Oo3QSxqoySJMDh7GTraxFRX77VZ2HZ13x3R4EVYddIGXicRRDAc7V9z5cLDlA/132" width="30px"><span>爬行的蜗牛</span> 👍（0） 💬（0）<div>朋友圈应该用最终一致性就好，我感觉这个和mysql主从同步有点类似:1.强同步，从节点写入数据成功后再返回客户端信息2.半同步，从节点收到主节点的消息后(并未写入）就返回客户端结果.3.异步</div>2020-03-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/fa/96/4a7b7505.jpg" width="30px"><span>Eden2020</span> 👍（0） 💬（0）<div>最终一致性就可以了，强一致性性能会有影响，而且会阻塞并发读，有服务延迟，每个读者可能看到的不一样，但是最后还是按时间顺序看到一致的评论视图。</div>2020-03-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f7/e0/34290aa4.jpg" width="30px"><span>倪必荣</span> 👍（0） 💬（0）<div>思考题的评论系统，最终一致性比较合适，强一致的高延迟会非常影响用户评论的兴致</div>2019-06-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/8a/41/7019ce3a.jpg" width="30px"><span>果果几号</span> 👍（0） 💬（0）<div>对于想深入学习分布式系统，有什么学习资料推荐的吗？</div>2019-05-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/49/e6/4f00fe55.jpg" width="30px"><span>Mac Kwan</span> 👍（0） 💬（0）<div>微信朋友圈的评论功能应该是采取弱一致性的方案。朋友圈评论是相互为好友的人才能可见的。发表一条评论时，会先在手机本地添加一条自己的评论记录，然后再采取异步的方式将这条评论推送到微信服务器。再由微信服务器根据好友关系，推送到各个好友的手机记录中去。之间是存在延时的。而且当新的好友关系（增加或删除）成立后，还会异步通知双方朋友圈数据同步。最终实现这个评论列表相互查看的一致</div>2019-04-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/20/02/df2bfda9.jpg" width="30px"><span>公共号</span> 👍（0） 💬（0）<div>对于评论者与被评论者 来说 ，评论要强一致性，对第三者来说，弱一致性即可； 因为朋友圈的评论比较私密性，同时朋友之间的沟通若消息丢失会有严重的体验问题</div>2019-04-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/f2/95/2d4944df.jpg" width="30px"><span>Hessin</span> 👍（0） 💬（0）<div>说下我粗浅的理解:弱一致性指定是不一致时间窗口已知，固定不一致时间窗口，或者可以给出不一致时间窗口范围。最终一致性说的是不一致时间窗口不定。</div>2019-04-28</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLhMtBwGqqmyhxp5uaDTvvp18iaalQj8qHv6u8rv1FQXGozfl3alPvdPHpEsTWwFPFVOoP6EeKT4bw/132" width="30px"><span>Codelife</span> 👍（0） 💬（0）<div>关于弱一致性和最终一致性的区别,我的理解是：弱一致性不保证读取时候数据一致，最终一致性是在超过时间窗口之后一定保证一致</div>2019-04-26</li><br/>
</ul>