你好，我是蔡元楠。

今天我要与你分享的主题是Lambda架构。

通过这一讲，你可以了解什么是Lambda架构，以及它为什么能够成为Twitter亿级实时数据分析架构背后的“倚天剑”。

在学习了架构师的必备技能后，你是否已经摩拳擦掌，跃跃欲试地想要上手一个实际项目了呢？没问题，我们一起来看一个我的架构经历里的真实项目。

情况是这样的，我们正运行着广告精准投放业务，并且拥有海量的用户网站访问行为。我们需要进行用户行为分析来建立一个模型，然后根据这个模型来投放用户喜好的广告。

你可能想到了批处理架构。没错，这个时候数据批处理架构无疑是一种很好的选择。

可是我们不要忘了，之前讲过批处理架构有着高延时性的不足，而互联网用户行为的数据往往可以达到Pb或Eb，甚至是Zb的级别。做这种分析挖掘用户行为的任务，往往能耗时好几个小时甚至是几天。这样的话，我们根据模型精准投放给特定用户的广告就会有一定延时了。

那我们只用流处理架构行不行呢？

在广告精准投放的业务需求下，只用流处理架构会造成忽略了用户的历史网站访问行为，一些异常行为可能会让我们的服务投放错误的广告。

例如，用户A的电脑暂时借给用户B使用了一下，而用户B浏览了一些新的网站类型（与用户A不同）。这种情况下，我们无法判断用户A实际上是否对这类型的广告感兴趣，所以不能根据这些新的浏览记录给用户A推送广告。
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/e8/9e/6550a051.jpg" width="30px"><span>:)</span> 👍（46） 💬（4）<div>我们公司做的实时数仓 就满足Lambda 架构。1.批处理部分。定时拉取业务库的数据，并在hive做批处理计算。
2.速度部分。通过订阅mysql数据库的binlog，实时获取数据库的增删改等的操作，通过kafka和flink，生成相关结果。</div>2019-05-08</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLdWHFCr66TzHS2CpCkiaRaDIk3tU5sKPry16Q7ic0mZZdy8LOCYc38wOmyv5RZico7icBVeaPX8X2jcw/132" width="30px"><span>JohnT3e</span> 👍（41） 💬（1）<div>lambda架构是不是可能会导致相似的处理逻辑在batch层和speed层都要开发一遍？</div>2019-05-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/da/70/abf490cf.jpg" width="30px"><span>命缘</span> 👍（22） 💬（1）<div>老师，想请问下服务层具体是怎们兼容批处理层和实时处理层的结果的，有没实际例子</div>2019-05-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/89/4b/56d290f5.jpg" width="30px"><span>leeon</span> 👍（15） 💬（2）<div>目前是通过Kafka将行为数据收集到hdfs，然后spark批处理t+1计算长期数据，生成固定格式的特征同步到kv上线，同时实时收集服务也从Kafka中消费最新的行为，两层输出特征格式统一，供画像服务使用</div>2019-05-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4d/49/28e73b9c.jpg" width="30px"><span>明翼</span> 👍（11） 💬（1）<div>简单又实用的lambda架构，如果实时和批量不能同时满足那就分开吧，用的时候综合下，让我想到现在开源的数据湖，delta data lake，如果批量和实时矛盾就分开吧，读写分，采用不同行式或列式存储，实时和历史分开，实时数据再定期变成历史，这个架构最大难点是如何合并speed和batch</div>2019-05-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/2f/d3/6674af19.jpg" width="30px"><span>¾</span> 👍（8） 💬（2）<div>关于为什么叫lamda架构有一个猜想。lamda的希腊字母是λ，这正好表示batch 和 speed两种最后汇聚到一起。不知道猜想对不对，但是感觉通过希腊字母，象形的代表架构模式还是挺有意思的。</div>2019-05-09</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLhMtBwGqqmyhxp5uaDTvvp18iaalQj8qHv6u8rv1FQXGozfl3alPvdPHpEsTWwFPFVOoP6EeKT4bw/132" width="30px"><span>Codelife</span> 👍（8） 💬（1）<div>原来这就是Lambda架构，其实，我们现在就用的Lambda 架构，kafka+storm+MR+Hbase来实现，现在的问题是：
1.storm是用java开发，MR是用python开发，导致同一逻辑需要两种实现
2.storm窗口期数据一般在5-10分钟，由于我们的数据有时间和空间属性的时序数据，前后关联性比较大，中间可能有噪点数据，所以很容易出现实时和历史分析结果不一致的问题，虽然最终用历史覆盖了实时，保持了最终一致性。</div>2019-05-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/ed/6f/352eb4d4.jpg" width="30px"><span>越甲非甲</span> 👍（8） 💬（1）<div>老师您好！lambda架构的思路中，感觉最终决定结果的还是批处理结果。而流处理结果更多的是满足实时性的需求。不同的业务场景下，综合两种处理结果获得对外服务的结果模型，其模型和算法应该都不相同。这种处理结果的合并方面，是否有某些原则范式或者思路呢？谢谢老师！</div>2019-05-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/f5/05/09aaa06c.jpg" width="30px"><span>yiwu</span> 👍（8） 💬（1）<div>实时报表，实时数仓，实时用户画像标签，实时反欺诈，实时风控，以前很多需要批量计算的数据都可以变成batch+speed或speed替代</div>2019-05-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/4c/6d/c20f2d5a.jpg" width="30px"><span>LJK</span> 👍（7） 💬（1）<div>老师您好，请问lambda架构可以看成一种在线学习的实现方式么？</div>2019-05-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/7f/9f/ca7b20cd.jpg" width="30px"><span>Hunter Liu</span> 👍（5） 💬（1）<div>今天的课让我想到了昨天评审的一个需求。这个需求是通过收集用户的及时数据能够知道用户常走的路线，后续用户在使用产品进行导航时，如果没有开启路线引导，但是却正在行驶在常走的路线上，一样给用户准确预报常走路线的路况，这个其实就可以实用了lambda架构。历史数据实用批处理，实时数据实用流处理也就是速度层，这样可以根据历史数据和用户实时上传的数据进行准确的路况播报了。

当然，包括网约车，外卖订单和老师讲的停车场的应用场景也相近，这节课受益匪浅。</div>2019-05-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/41/27/3ff1a1d6.jpg" width="30px"><span>hua168</span> 👍（4） 💬（1）<div>老师打扰一下：
Hadoop MapReduce，Apache Spark，Apache Storm，Apache Flink，Apache Apex ，Apache Beam
如果现在才开始学大数据，除了haddop过时了，其它的Apache Spark，Apache Storm，Apache Flink，Apache Apex 还需要学吗？直接Apache Beam学起？</div>2019-05-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/93/b8/6510592e.jpg" width="30px"><span>渡码</span> 👍（3） 💬（1）<div>我觉得anti spam可以用lambda架构，实时数据+历史数据更充分地判定作弊行为</div>2019-05-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/5b/79/d55044ac.jpg" width="30px"><span>coder</span> 👍（3） 💬（1）<div>最近看到一个技术名词，叫做Reactive Design Patterns，国内的翻译是反应式设计模式，对应的编程方式叫做Reactive Programming，不知道这种设计模式跟专栏中提及的各种架构思想的关系是什么？</div>2019-05-09</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/9chAb6SjxFiapSeicsAsGqzziaNlhX9d5aEt8Z0gUNsZJ9dICaDHqAypGvjv4Bx3PryHnj7OFnOXFOp7Ik21CVXEA/132" width="30px"><span>挖矿的小戈</span> 👍（3） 💬（1）<div>lambda架构，批处理层和流处理层（速度层），对于某些相同的业务往往需要开发两套代码，这个很不友好；对于催生的Apache Flink、Apache Beam这种在做流批统一的，感觉会是未来的主流</div>2019-05-08</li><br/><li><img src="" width="30px"><span>Mr.Mouse</span> 👍（2） 💬（1）<div>lambda架构提供给服务层的结果是不是 speed层实时结果+batch层上次存储的历史结果 整合在一起的结果？
</div>2019-05-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/57/bd/acf40fa0.jpg" width="30px"><span>lwenbin</span> 👍（2） 💬（1）<div>以前一个项目用过 Kylin + Storm 结合的方式来统计一个指标, Kylin 对于当天以前的历史数据建立OLAP Cube 可以实现维度和维度内的伸缩查询，Storm 的实时统计可以基于当天数据做统计，整合在一起正好提供了所有时间内的查询。
另外，老师能否在广告投放上再多说一下，如何基于浏览历史和实时的浏览做精准广告投放预测？能否具个实际例子呢？
谢谢！</div>2019-05-08</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELPbl4btlC1JF5xIYuRLdtzliav2ib7NbsJAkumfGo7DI7XycBRKuadVBq5Sh4RxwuKicVIZ2PSL3qHSbSCjU2shmQSlUlYP3PCtqCrZPFUpv48g/132" width="30px"><span>Kaleidoscoper</span> 👍（1） 💬（1）<div>有一个问题要请教老师，停车场例子这个基于实时GPS做的人工预测模型有没有考虑到自身推荐系统的影响呢，如果10辆车都用了app，给出的推荐都是远处的停车场，那离得近的停车场不就反而可以停了吗，是不是还要考虑自身推荐模型在所有实时数据中的影响因子？</div>2019-05-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/2e/bd/829d727f.jpg" width="30px"><span>💞QQ💞</span> 👍（1） 💬（1）<div>老师：停车位那个案例有个问题请教一下。
对于用户来说，收到的数据是历史的停车位信息和实时的用户GPS数据组合之前的推荐数据，用一个小时前的停车数据推荐，是不是会出现推荐 车位已经被消耗的问题，这样用户体验感觉很差哦。</div>2019-05-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/37/c7/abb7bfe3.jpg" width="30px"><span>汶恬萝</span> 👍（1） 💬（1）<div>其实impala mix with hdfs and kudu就是一种较好的lambda实现方案。应用层统一使用sql，底层存储兼容基于hdfs的批量任务(impala,hive,spark等)和kudu的近实时存储。
使用场景在并发要求较高的olap或者吞吐量不大的olap均可。
如果又要求吞吐量高，又要求数据量大的实时场景话(感觉这种场景相当少)，可能才会考虑两种不同技术架构分别跑批和处理实时数据</div>2019-05-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/43/d8/24970c92.jpg" width="30px"><span>夜阳羽</span> 👍（1） 💬（1）<div>为什么叫lambda架构呢，lambda在此处的含义是什么？</div>2019-05-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e7/87/9ad59b98.jpg" width="30px"><span>程序设计的艺术</span> 👍（1） 💬（1）<div>lambda有现成的开源框架吗？我感觉kylin也不算是，还是需要做二次整合</div>2019-05-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/ee/16/742956ac.jpg" width="30px"><span>涵</span> 👍（1） 💬（1）<div>历史数据加实时数据的思路在做系统时其实挺常见，例如一个合规系统，为了快速计算指标，会汇总早上计算好的前日持仓数据结合内存中记录的当日数据以及触发合规指标计算的这一条指令数据来得出正确的指标结果。这种思想用在大数据平台中原来就是LAMBDA架构，很巧妙，很实用。我想如何结合历史数据和实时数据应该比较tricky，需要经验来指导权重和算法。</div>2019-05-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/9b/a7/440aff07.jpg" width="30px"><span>风翱</span> 👍（1） 💬（1）<div>公司目前的一个系统可以引入lambda架构。 原来的系统中，分为了两部分：一部分的数据收集处理，采用每天汇总的方式，数据截止到前一天；另一部分的数据为实时变化，采用的是RabbitMQ的消息处理方式。 刚好可以利用lambda架构，来达到两部分数据都实时的情况。  
目前节假日出现，一些旅游景点，出现了人满为患的情况，可以利用lambda架构，做到错峰出行。</div>2019-05-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f5/80/baddf03b.jpg" width="30px"><span>zhihai.tu</span> 👍（0） 💬（1）<div>1，批量层: 以贴源数据为基础，每日以批量文件方式加载至hadoop数据湖。应用基于数据湖层做批量加工与分析，将计算结果推送给用户。
2，速度层: 通过flume实时采集数据，进入到kafka消息队列，然后通过sparkstream准实时计算，将结果推送给用户。
目前平台层面上，还未考虑到如何将两者计算的结果进行合并处理，后续有时间再研究下，谢谢您。</div>2019-05-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/aa/fa/3ad0a689.jpg" width="30px"><span>廖师虎</span> 👍（0） 💬（1）<div>在流批统一的情况下，已经很少有人再单独提lambda了，太复杂</div>2019-05-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7c/4c/50b6f2a4.jpg" width="30px"><span>细雨听风呤</span> 👍（0） 💬（1）<div>我们现在是通过离线跑一个候选集，再通过实时进行排序，其实也是lambda架构。</div>2019-05-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/e8/4a/c2a539a0.jpg" width="30px"><span>段斌</span> 👍（0） 💬（1）<div>股票预测是不是也可以用Lambda的架构？通过批处理对市场每日的股价进行模型预测，日内则可以通过实时的交易数据进行预测。</div>2019-05-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6b/e4/afacba1c.jpg" width="30px"><span>孙稚昊</span> 👍（0） 💬（1）<div>老师您好！请问如何解决Lambda 架构中，批和流数据重复的问题？很多behavior data，比如点击日志，并没有一个id 来识别，两者处理的 timestamp 也很可能不完全一致，还需要一些算法来去重吗？</div>2019-05-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/06/9c/1ee94a9d.jpg" width="30px"><span>dylan</span> 👍（0） 💬（1）<div>把批处理层和速度处理层称为离线处理和实时处理（近实时）更好理解吧</div>2019-05-10</li><br/>
</ul>