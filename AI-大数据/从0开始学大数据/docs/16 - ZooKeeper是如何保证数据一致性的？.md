你可能还记得，我们在讲HDFS和HBase架构分析时都提到了ZooKeeper。在分布式系统里的多台服务器要对数据状态达成一致，其实是一件很有难度和挑战的事情，因为服务器集群环境的软硬件故障随时会发生，多台服务器对一个数据的记录保持一致，需要一些技巧和设计。

这也就是我们今天要讨论的分布式系统一致性与ZooKeeper的架构。

在讲分布式系统一致性前，我们先回顾一下HDFS。HDFS为了保证整个集群的高可用，需要部署两台NameNode服务器，一台作为主服务器，一台作为从服务器。当主服务器不可用的时候，就切换到从服务器上访问。但是如果不同的应用程序（Client）或者DataNode做出的关于主服务器是否可用的判断不同，那么就会导致HDFS集群混乱。

比如两个应用程序都需要对一个文件路径进行写操作，但是如果两个应用程序对于哪台服务器是主服务器的判断不同，就会分别连接到两个不同的NameNode上，并都得到了对同一个文件路径的写操作权限，这样就会引起文件数据冲突，同一个文件指向了两份不同的数据。

这种不同主服务器做出不同的响应，在分布式系统中被称作“脑裂”。光看这个词你也可以看出问题的严重性，这时候集群处于混乱状态，根本无法使用。那我们引入一个专门进行判断的服务器当“裁判”，让“裁判”决定哪个服务器是主服务器不就完事了吗？
<div><strong>精选留言（30）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/66/df/501ba989.jpg" width="30px"><span>面试官问</span> 👍（36） 💬（2）<div>CAP 定理关注的是对数据的读写操作，而不是分布式系统的所有功能，它要求分布式系统节点间是互相连接且有数据共享的，例如 Memcache 的集群中节点相互间没有连接和数据共享，因此不是 CAP 定理讨论的对象，同理 ZooKeeper 的选举机制也不是 CAP 探讨的对象。

摘自从零开始学架构，大家可以探讨下。</div>2018-12-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/56/43/abb7bfe3.jpg" width="30px"><span>阿巍-豆夫</span> 👍（8） 💬（2）<div>zk是最终一致性吧，这个没说清楚啊。</div>2018-12-04</li><br/><li><img src="" width="30px"><span>老范</span> 👍（7） 💬（1）<div>但是 ZooKeeper 系统中所有服务器都存储相同的数据，也就是数据没有分片存储，因此不满足分区耐受性

建议老师修改下上处：我们用 sharding 表示分片，用 partition 表示网络分区，partion tolerance 和 sharding 二者是不同概念，并没有如老师您所述的关系。 在 CAP 理论中，当网络分区发生时，ZK 选择了 Consistence，舍弃了 Availability。</div>2019-06-10</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLhpCNoXf1fPfkU8icso2kvjAVtmDibric0VBt9FdtfopM90Y8DlBYnM4UUmh9x7M79LpcIkWXnEeib7A/132" width="30px"><span>工科生小猴子</span> 👍（2） 💬（3）<div>看完这篇文章，我对zookeeper更加疑惑了。又说zookeeper用来保证数据一致性，一会又是选举主服务器，越看越迷惑。还有，zookeeper集群，到底是一个独立的集群，还是大数据业务集群的一个有机组成部分？？？？？</div>2021-02-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/14/e1/ee5705a2.jpg" width="30px"><span>Zend</span> 👍（2） 💬（2）<div>是否可以在分布式系统中不信任的机器加入黑名单，放在ZooKeeper上。</div>2019-11-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/f6/05/5c81abfd.jpg" width="30px"><span>不加y</span> 👍（1） 💬（1）<div>老师，请教一下，这里zk只是用于active namenode和slave namenode的切换，作为一个锁，谁获得锁，就作为active namenode，和zab算法关系不大吧？或者zab只是保证zk里面的数据一致性。</div>2023-06-03</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIM0sj0oP7bZwm2dWHq1n1XIsJLwGr122Qb1S2EytzAp62YZKJsiaNHTQayolevlBJGiaq7eBRHCGrg/132" width="30px"><span>Jay</span> 👍（0） 💬（1）<div>但是这个做出判断决策的服务器也有可能会出现故障不可访问，同样整个服务器集群也不能正常运行。所以这个做出判断决策的服务器必须由多台服务器组成，来保证高可用，任意一台服务器宕机都不会影响系统的可用性。那么问题又来了，这几台做出判断决策的服务器又如何防止“脑裂”，自己不会出现混乱状态呢？有时候真的很无奈，分布式系统设计就像是一个追着自己尾巴咬的喵喵，兜兜转转回到开头。

-------------------------老师在文章中已经提到这个问题，可看完文章，我还是没有理解zookeeper集群本身的一致性是如何保证。   现在只看到zookeeper能够保证注册到它上面服务的一致性</div>2022-04-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/89/a1/2e2d6d0b.jpg" width="30px"><span>莎思比亚</span> 👍（0） 💬（1）<div>这门课有点捣糨糊的意思，误导…… Zeekeeper是Zookeeper Atomic Broadcast协议</div>2021-12-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/0d/c1/d36816df.jpg" width="30px"><span>M</span> 👍（19） 💬（0）<div>P和数据分不分片并没有任何关系吧。在分布式系统中P就是满足的，否则就是单机了。所以一般考虑的是CP和AP，CP是指在网络分区形成(分布式节点之间不能互相通信)的情况下，牺牲可用性，满足一致性，只有等到数据同步完成后才能恢复可用。而AP是指在网络分区形成的情况下，向外部继续提供使用，但是数据可能不一致(因为节点之间不能通信，所有节点的数据可能不一致)</div>2018-12-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6e/bd/b83ad32d.jpg" width="30px"><span>shangyu</span> 👍（14） 💬（0）<div>请问老师 对于文中这句话不太理解：“但是 ZooKeeper 系统中所有服务器都存储相同的数据，也就是数据没有分片存储，因此不满足分区耐受性”。zk没有分片但是都存储了相同数据，也就是有冗余备份，一定是要数据有分片才满足P吗</div>2018-12-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/de/f0/ccf46294.jpg" width="30px"><span>忠厚</span> 👍（10） 💬（0）<div>ZooKeeper 集群的性能会随着服务器数量的增加而下降
这个描述不准确，ZK中有三种角色 leader  Follower observer ，而observer不参与投票，增加observer性能上不会有太大损失（在投票通过后leader结点会通知其他所有结点进行数据更新，这个过程是通过广播的形式完成，而且leader并不等待更新的结果）</div>2018-12-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/cd/11/3de96927.jpg" width="30px"><span>cc_hust</span> 👍（6） 💬（1）<div>个人理解，CAP 中的P跟是否分片存储没有关系。在分布式环境中，P是必选项，需要权衡多副本的一致性和可用性， 单机系统才是放弃了P。</div>2018-12-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/40/10/b6bf3c3c.jpg" width="30px"><span>纯洁的憎恶</span> 👍（5） 💬（0）<div>“CAP 定理关注的是对数据的读写操作，而不是分布式系统的所有功能，它要求分布式系统节点间是互相连接且有数据共享的，例如 Memcache 的集群中节点相互间没有连接和数据共享，因此不是 CAP 定理讨论的对象，同理 ZooKeeper 的选举机制也不是 CAP 探讨的对象。

摘自从零开始学架构，大家可以探讨下。”

有道理！我个人的理解是ZooKeeper本身确实不熟CAP探讨的对象。但是ZooKeeper的很多应用场景，如分布式系统的数据一致性，才是CAP探讨对象。解决问题的钥匙不是问题本身，我理解的对么？</div>2018-12-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/00/f4/cc5f0896.jpg" width="30px"><span>Jowin</span> 👍（5） 💬（1）<div>zookeeper提供的数据读写服务是cp模型，也就是强一致性。老师这里说的是zookeeper节点间的数据同步模型，如果非要套用cap的话，应该也是cp模型，容忍少于半数的节点故障，一旦多余半数的节点故障，就无法达成一致，系统就不可用性了。</div>2018-12-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/fd/d6/71e1cc29.jpg" width="30px"><span>Kaer</span> 👍（5） 💬（2）<div>P跟是指网络出现分区，不是数据分区。数据的分区是：shareding</div>2018-12-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/16/3c/eee3e6f5.jpg" width="30px"><span>galen</span> 👍（4） 💬（1）<div>如何保证从Zookeep节点中读取的数据，是最新的数据？
Zookeep节点可能还在同步数据，当前节点的数据不是最新的数据</div>2018-12-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8c/9c/d48473ab.jpg" width="30px"><span>dancer</span> 👍（3） 💬（0）<div>老师，P的释义感觉不是很准确，查了一下维基百科的定义，
Partition tolerance: The system continues to operate despite an arbitrary number of messages being dropped (or delayed) by the network between nodes</div>2018-12-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg" width="30px"><span>钱</span> 👍（2） 💬（2）<div>估计是删除了部分内容，看评论好多都在聊CAP，看正文没见CAP什么事，不过之前学习过ZK是属于CP的。
另外，感觉老师这个讲的浅，随便一个zk的讲解都比这多，我自己百度过分布式一致性协议，感觉2PC&#47;3PC还能理解，对于ZAB的简单说明也能理解，不过paxos确实理解不了，很期待有人能通俗易懂的将所有分布式一致性协议都对比讲解清楚一下！</div>2019-09-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/37/d0/26975fba.jpg" width="30px"><span>西南偏北</span> 👍（2） 💬（0）<div>老师能专门讲一下zookeeper的leader选举机制吗</div>2018-12-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/46/32/2bb481d2.jpg" width="30px"><span>Leo</span> 👍（1） 💬（0）<div>就为了看zookeeper怎样保证分布式存储的一致性来的😄</div>2020-03-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6b/f8/b4da7936.jpg" width="30px"><span>大魔王汪汪</span> 👍（1） 💬（1）<div>zk集群可用性怎么保证呢？这不又回到原始的问题了？</div>2019-09-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/e8/3c/e8c80390.jpg" width="30px"><span>骆驼哥</span> 👍（1） 💬（0）<div>请问老师 对于文中这句话不太理解：“但是 ZooKeeper 系统中所有服务器都存储相同的数据，也就是数据没有分片存储，因此不满足分区耐受性”。zk没有分片但是都存储了相同数据，也就是有冗余备份，一定是要数据有分片才满足P吗</div>2018-12-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ee/53/b8fe4560.jpg" width="30px"><span>欧嘉权Felix</span> 👍（1） 💬（0）<div>不是很理解老师说的不符合p的原因 zk是cp系统吧</div>2018-12-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/8b/27ae435c.jpg" width="30px"><span>Any Hello mino</span> 👍（1） 💬（0）<div>Zookeeper是cp吧？选举的时候不是都是不可用的</div>2018-12-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/56/43/abb7bfe3.jpg" width="30px"><span>阿巍-豆夫</span> 👍（1） 💬（0）<div>paxos 怎么实现强一致性，有点晕了？</div>2018-12-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/52/bb/225e70a6.jpg" width="30px"><span>hunterlodge</span> 👍（1） 💬（0）<div>p是指分区耐受性，而不是分区本身，zk没有分片存储，也就不存在耐受性的问题，所以我的理解是，本质上zk不是严格的分布式系统</div>2018-12-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/1b/93/e3b44969.jpg" width="30px"><span>sgl</span> 👍（1） 💬（1）<div>区块链也是一个很好的技术，被比特币耽误了</div>2018-12-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/1f/a7/d379ca4f.jpg" width="30px"><span>jon</span> 👍（1） 💬（0）<div>zookeeper解决了分布式式环境中的数据一致性问题，放弃数据分片存储，采用的是，投票选举的算法获得过半票数的节点获得读写权</div>2018-12-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/7c/16/4d1e5cc1.jpg" width="30px"><span>mgxian</span> 👍（1） 💬（0）<div>我也感觉老师说的cap有点问题 按理来说 zk 是cp 系统 只要是分布式系统 p 就是天然存在的 并不是说 没有数据分片 就没有 p</div>2018-12-04</li><br/><li><img src="" width="30px"><span>Asran</span> 👍（0） 💬（0）<div>分区容错性表示，一个系统虽然是分布式的，但是对外看上去应该是一个整体，不能由于分布式系统内部的某个节点挂掉，或网络出现故障，而导致系统对外表现异常。所以，对于分布式系统而言是一定要保证分区（分布）容错性的。</div>2022-08-03</li><br/>
</ul>