我们在[Spark性能优化案例分析](http://time.geekbang.org/column/article/72056)这一期中，通过对大量的Spark服务器的性能数据进行可视化分析，发现了Spark在程序代码和运行环境中的各种性能问题，并做了相应优化，使Spark运行效率得到了极大提升。

![](https://static001.geekbang.org/resource/image/7a/cc/7af885b0492aa68ffbe05bee7e04cdcc.png?wh=552%2A156)

很多同学也在问，这些可视化的性能数据从何而来呢？如何在图中将性能指标和任务进度结合起来，可以一目了然看清应用在不同运行阶段的资源使用状况呢？事实上，当时为了进行Spark性能优化，我和团队小伙伴们开发了一个专门的大数据性能测试工具[Dew](https://github.com/zhihuili/Dew)。

## Dew设计与开发

Dew自身也是一个分布式的大数据系统，部署在整个Hadoop大数据集群的所有服务器上。它可以实时采集服务器上的性能数据和作业日志，收集起来以后解析这些日志数据，将作业运行时间和采集性能指标的时间在同一个坐标系绘制出来，就得到上面的可视化性能图表。Dew的部署模型如下。

![](https://static001.geekbang.org/resource/image/7f/81/7f0cf1566ba2f7fccd41b036112e7f81.png?wh=930%2A342)

从图中看，Dew的核心进程有两种，一种是Dew Master进程Herse，另一种是管理集群中每台服务器的Dew Agent进程DewDrop，Dew Agent监控整个Hadoop集群的每台服务器。Herse独立部署一台服务器，而DewDrop则和HDFS的DataNode、Yarn的NodeManager部署在大数据集群的其他所有服务器上，也就是每台服务器都同时运行DataNode、NodeManager、DewDrop进程。
<div><strong>精选留言（22）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/5e/f5/018907ac.jpg" width="30px"><span>李智慧</span> 👍（32） 💬（1）<div>这个思考题写完后，我自己思考了下，基于这个思考题思路，和小伙伴们一起开发了一个反应式编程框架Flower，支持异步流式微服务：https:&#47;&#47;github.com&#47;zhihuili&#47;flower</div>2021-07-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f9/e3/2529c7dd.jpg" width="30px"><span>吴科🍀</span> 👍（20） 💬（1）<div>spark在1.6后，使用netty完全代替akka了。主要还是看业务场景吧</div>2018-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/7a/dc/0f35e6f6.jpg" width="30px"><span>孔祥阳</span> 👍（9） 💬（2）<div>关于响应式有个小问题，如果 A通知 和 B通知同事修改一个数据怎么办？就像现实开发企业应用中，A领导拍了这个需求，B领导又出来指点一番，代码上是如何鉴定数据的理想性呢？</div>2019-03-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/07/0a/df537a6f.jpg" width="30px"><span>冷锋</span> 👍（5） 💬（1）<div>相形见绌，拼音是xiāngxíngjiànchù</div>2018-12-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/64/86/f5a9403a.jpg" width="30px"><span>yang</span> 👍（4） 💬（3）<div>我根据自己理解的回复一下，老师可以看着答复一下哈：（&#47;:抠鼻）

1.Akka天生支持分布式（配置远程Ptops)、天生支持高并发（Actor之间使用MailBox队列实现、无需锁等待…）

2.瞄了一眼GearPumps，感觉好厉害，四个节点，每秒可以处理1千8百万个长度为100byte的消息，仅有8ms延迟。那它们这个数据，貌似没说网络、机器配置是什么哇～ 

可能说的不对……</div>2018-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/a5/ff/6201122c.jpg" width="30px"><span>Geek_89bbab</span> 👍（2） 💬（1）<div>老师，在你的回答中
作为actor的b如果因为代码异常挂了，重启后会继续处理消息。如果是机器挂了，就没有了。

机器挂了该怎么处理，是系统架构要考虑的。
———-
A，b两个actor处于不同的进程中，a向b发信息，现在邮箱有未处理完的消息，b由于一些原因挂掉，重启为什么还可以继续处理邮箱的消息呢？难道消息持久化到文件中了吗？</div>2019-01-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/a5/ff/6201122c.jpg" width="30px"><span>Geek_89bbab</span> 👍（0） 💬（1）<div>老师，像akka中两个actor进行通信，它们在不同的进程中，如果actorA把消息发送到actorB的邮箱，B挂掉了。B的邮箱中还存在未处理的消息，重启后还可以重新处理吗？还是邮箱的存在内存中的，无法恢复？那如果B服务挂了，没有来得及处理A发送过去的消息，这该怎么办？</div>2019-01-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/34/49/6b27feb1.jpg" width="30px"><span>Riordon</span> 👍（0） 💬（1）<div>老师，Dew子项目sparklogparser中Matcher是否支持spark 1.6.x和2.x呢？看项目创建比较早期。</div>2018-12-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/4f/b2/1e8b5616.jpg" width="30px"><span>老男孩</span> 👍（10） 💬（1）<div>使用akka实现传统的web应用功能用户注册，是否可以这样实现。首先通信方式是异步的，用户发起注册请求后，服务端收到请求后直接回复:已经受理了您的注册请求，稍后会将激活码下发邮箱或者手机。同时用户注册的actor就会把任务分解发给它的下一级actor处理，发给用户服务actor新增用户，发给积分兑换服务actor为新用户赠送注册积分和礼券。然后调用通知actor给用户的邮箱或者手机发送注册成功信息以及激活码等。感觉类似rabbitmq的消息队列也可以实现akka的异步和分布式通信。</div>2018-12-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/40/10/b6bf3c3c.jpg" width="30px"><span>纯洁的憎恶</span> 👍（8） 💬（0）<div>计算机产业变化太快了，我上学的时候还是过程化编程、模块化编程、面向对象的演进路线，这才没几年，已经又演化出新模式了——响应编程模式。</div>2018-12-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/df/73/4a4ce2b5.jpg" width="30px"><span>足迹</span> 👍（3） 💬（1）<div>老师，面对这么多的技术，实际应用时时怎么选型的？比如流处理到底是用spark streaming还是storm或是flink？面对离线处理同样有不同的技术可选。你技术选型的主要依据是什么？有什么“套路”可套吗？谢谢！</div>2018-12-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/64/86/f5a9403a.jpg" width="30px"><span>yang</span> 👍（2） 💬（0）<div>谢谢老师，平安夜快乐，圣诞节🎄快乐！</div>2018-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/60/de/5c67895a.jpg" width="30px"><span>周飞</span> 👍（1） 💬（0）<div>Akka的异步消息跟node.js有异曲同工之妙啊</div>2019-01-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/37/2e/02/7f151e08.jpg" width="30px"><span>听说昵称太长了躲在树后面会被别人看见的</span> 👍（0） 💬（0）<div>js 的 promiss 算不算并发编程</div>2023-05-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8c/5c/3f164f66.jpg" width="30px"><span>亚林</span> 👍（0） 💬（0）<div>这个响应式编程是不是Golang语言崛起的原因？</div>2021-08-13</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/0hSQWvd1HbzrsA5xh9tm9oUthTG9BiagIghmMnuF8YFfarKovb4E9jOCw69icLNaeJNClH1ia6f3conGibIicPRkxBg/132" width="30px"><span>丁婷</span> 👍（0） 💬（0）<div>如果消息在传递过程中，消息丢了怎么办呢？
</div>2020-07-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/f1/7e/8925aba5.jpg" width="30px"><span>小熊</span> 👍（0） 💬（0）<div>学习了</div>2020-03-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/19/a6/7ae63d7e.jpg" width="30px"><span>Jun</span> 👍（0） 💬（0）<div>序列化和封装还是需要解决的，总不好只用纯文本传递数据。但这不是akka要解决的问题。akka感觉是简化版的面向消息的编程模型。我的主要问题是消息队列管理和scale，比如消息的一致性和大数据量下的响应和资源消耗。</div>2020-01-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/09/70/6b6382ca.jpg" width="30px"><span>白鸽</span> 👍（0） 💬（0）<div>web复杂请求（响应时间较长，10秒以上），服务器只做请求合法验证，只要验证通过，就返回请求正在处理提示，用户不用等待，想干啥干啥。等请求处理完后，服务器返回请求完成提示弹窗，用户点击查看即可。这种在web请求中很少见，很多就是显示进度条，是不合理吗？</div>2018-12-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f9/e3/2529c7dd.jpg" width="30px"><span>吴科🍀</span> 👍（0） 💬（1）<div>spark在1.6后，使用netty完全代替akka了。主要还是看业务场景吧</div>2018-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d7/df/fc0a6709.jpg" width="30px"><span>WolvesLeader</span> 👍（0） 💬（0）<div>老师请教一个问题 rdd.flatMap(x =&gt; x.split(&quot; &quot;))
x.split(&quot; &quot;) 返回的是一个array[string]数组，但是rdd.flatMap需要的参数类型是TraversableOnce，为什么就不抱错误呢？是不是有隐式转换，我找了好久也没找到在哪里做的转换，谢谢啦</div>2018-12-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/34/49/6b27feb1.jpg" width="30px"><span>Riordon</span> 👍（0） 💬（0）<div>老师，Dew子项目sparklogparser，Matcher中匹配的spark版本是否支持1.6.x和2.x呢？</div>2018-12-22</li><br/>
</ul>