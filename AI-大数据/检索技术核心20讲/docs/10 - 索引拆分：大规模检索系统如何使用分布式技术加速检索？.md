你好，我是陈东。

在互联网行业中，分布式系统是一个非常重要的技术方向。我们熟悉的搜索引擎、广告引擎和推荐引擎，这些大规模的检索系统都采用了分布式技术。

分布式技术有什么优点呢？**分布式技术就是将大任务分解成多个子任务，使用多台服务器共同承担任务，让整体系统的服务能力相比于单机系统得到了大幅提升**。而且，在[第8讲](https://time.geekbang.org/column/article/222810)中我们就讲过，在索引构建的时候，我们可以使用分布式技术来提升索引构建的效率。

那今天，我们就来聊一聊，大规模检索系统中是如何使用分布式技术来加速检索的。

## 简单的分布式结构是什么样的？

一个完备的分布式系统会有复杂的服务管理机制，包括服务注册、服务发现、负载均衡、流量控制、远程调用和冗余备份等。在这里，我们先抛开分布式系统的实现细节，回归到它的本质，也就是从“让多台服务器共同承担任务”入手，来看一个简单的分布式检索系统是怎样工作的。

首先，我们需要一台接收请求的服务器，但是该服务器并不执行具体的查询工作，它只负责任务分发，我们把它叫作**分发服务器**。真正执行检索任务的是**多台索引服务器**，每台索引服务器上都保存着完整的倒排索引，它们都能完成检索的工作。

当分发服务器接到请求时，它会根据负载均衡机制，将当前查询请求发给某台较为空闲的索引服务器进行查询。具体的检索工作由该台索引服务器独立完成，并返回结果。  
![](https://static001.geekbang.org/resource/image/5b/df/5ba0f02fc5607409831cc0256a62eedf.jpg?wh=1920%2A775)
<div><strong>精选留言（20）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/84/39/c8772466.jpg" width="30px"><span>无形</span> 👍（4） 💬（1）<div>先来回答老师的问题，基于文档拆分的方案，1，新增数据会落到某个具体的服务器，不需要考虑数据在所有检索服务器之间同步、不一致的问题，2，由于所有的检索服务器之间数据是均衡分布的，不存在服务器之间检索负载不均衡的问题

索引水平拆分垂直拆分和数据库的水平拆分和垂直拆分是类似的
我理解文档拆分是把数据对一个整体进行分片，对整体的查询变成了并行在分片上查询，缩短了查询时间，还有一个好处是新的文档被哈希到到某个分片上，对查询结果的影响被限定到这个具体的分片，不会影响所有分片
关键词拆分也是把整体分片，对整体的查询变成了在单个分片上的查询，如果有热点数据会导致posting list过大，降低查询效率，这里能不能特殊处理，给热点数据指定专门的更高性能检索服务器，提升查询效率</div>2020-04-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（3） 💬（2）<div>Redis Cluster 技术相当于按照关键词进行拆分，直接定位到 要查询的 key 在哪个 slot</div>2020-04-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg" width="30px"><span>每天晒白牙</span> 👍（3） 💬（2）<div># 提高的吞吐量而非检索效率
简单的分布式检索系统是指每台索引服务器保存了全量的索引数据，然后加机器，这种方式只能提高系统整体的&quot;吞吐量&quot;，而不能缩短检索时间从而加速检索效率

# 通过拆分提高检索效率
检索时间与数据规模正相关，所以采用索引拆分可以加入检索效率

# 如何拆分？
## 基于文档拆分
核心思想是把大规模的文档集合随机拆分成多个小规模文档集合，即建了多个倒排索引，但每个倒排索引就是一个索引分片，保存了部分数据，所以它的 postinglist 不会太长，可以提升单机的检索效率

## 基于文档拆分的检索流程
- 分发服务器接受查询请求，然后将请求分发给其他索引服务器
- 每台服务器根据自己加载的索引分片数据进行检索，再把结果返回给分发服务器
- 分发服务器将所有返回结果进行合并，返回给客户端

## 基于文档拆分的优缺点
优点
1.基于随机划分，每个索引分片大小相近，在索引空间分配上是相对均衡的，而且每台索引服务器的负载也相对均衡
2.通过设置合理的分片数，有可能把所有数据加载到内存中，同时因为每个索引分片数据不大，可以提升检索效率

不足
分片数不能设置太大
因为客户端发过来的请求是先经过分发服务器的，然后转发给其他索引分片服务器，如果分片数过多，会设计很多网络 IO 操作，性能就会下降

## 基于关键词拆分
通过关键词进行拆分是将不同的关键词放到不同的索引分片上，然后加载到不同的服务器上，这样的拆分方式可以达到每台索引服务器上的文档不是完整的，但关键词对应的列表是完整的

## 基于关键词拆分的检索流程
客户端发来请求，如果只有一个关键词，那只需要查询改关键词所在的索引服务器就可以得到完整的文档列表，省去了分发造成的网络 IO
如果是多个关键词，可能也会发生分发请求，然后分发服务器合并请求返回给客户端

## 基于关键词拆分的优缺点
优点
适合查询词少的情况，可以减少分发造成的网络 IO

不足
1.如果查询词比较多且没有被划分到一个分片中，也会分发请求，有网络 IO
2.如果关键词是高频热点词，那它对应的文档列表会非常长，检索性能也会下降
3.高频热点词所在服务器负载高，低频词所在服务器负载低，导致索引服务器负载不均衡
4.如果有新增文档，会涉及到多台索引服务器修改

# 思考题 
## 为什么说基于文档拆分比关键词拆分更好维护？
其实在上面分析两种方案的优缺点时已经介绍了，下面就简单总结下
- 当有新文档加入时，最糟糕情况会修改所有的索引服务器
- 遇到高频热点词，大量查询都打到了这个热点词所在的服务器上，导致该服务器负载很高，完成索引服务器的负载不均衡</div>2020-04-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/17/ba/c56aa720.jpg" width="30px"><span>new life</span> 👍（2） 💬（1）<div>按文档划分和按关键词划分，各有利弊
按文档划分:
1、一个关键词的所有文档分布在多个服务器上，缩短了每台服务器postlist的长度，提升了单台服务器的检索效率；
2、但是检索对外时候需要检索多台服务器，合并检索结果，增加了分页检索实现的难度；

按关键词划分
1、每台服务器上含有这个关键词所有的文档，检索的时候，只要找到对应的服务器，检索一次就行，不用结果合并，分页控制也好实现；
2、但是一个关键词的文档id列表放一块，提高了每次查询的检索成本，尤其是热点数据的检索时候，总要受不常用数据的拖累

思考题

我理解插入文档的时候，文档拆分和关键词拆分影响的都是一台服务器，热点数据检索的时候，关键词、文档拆分这种方式都是负载是均衡的，这也体现出按文档拆分的优势；</div>2020-05-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/de/d3/2aa0177f.jpg" width="30px"><span>paulhaoyi</span> 👍（1） 💬（1）<div>老师您好，请教一个问题，可能不一定和本章有关。我们做内容分发，需要再召回源拿出内容后，过滤用户读过的文章。由于量比较大，有些用户的阅读历史又很长，单独每个用户记录已读列表，不管是容量还是过滤性能都不太能接受。感觉这就是一个判断是否存在的问题。如果我用文章id做key，用户做的文档。建立倒排合适么？或者老师有什么好的方法建议？</div>2020-05-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/1d/13/31ea1b0b.jpg" width="30px"><span>峰</span> 👍（1） 💬（1）<div>本来按照题目写了下答案，但感觉还不如跳出来回答这个问题，看着太像传统数据库横向拆分纵向拆分，然后引入中间件，然后就有手工分库分表那一坨解决方案。跳出这个思路，横向纵向分片只是分散数据到各个节点的手段，上层应该提供策略屏蔽这些手段的差异，针对具体的分片方式做优化，比如热点，那就针对这个分片多点副本。</div>2020-04-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg" width="30px"><span>那时刻</span> 👍（1） 💬（1）<div>尝试回答老师在回复里的问题。不明白的地方请老师指正。
1.按文档拆分，新增加的文档可以只加到一台增量索引的机器上班，因为查询的时候有按照关键字的合并
2.我觉得可以按照业务拆分来减少查询的复制，比如按照文档类型 军事，娱乐来把文档分区，这样查询关键字的时候，比如这个关键字属于军事类型就只去军事类型文档分区找就可以了。</div>2020-04-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg" width="30px"><span>那时刻</span> 👍（1） 💬（1）<div>基于文档或关键字拆分，类似于数据库的分库分表操作。基于文档拆分的好处在于分摊网络和io的压力。</div>2020-04-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/15/87/d22d8c3e.jpg" width="30px"><span>_你说了不算</span> 👍（1） 💬（1）<div>老师，我们的广告投放引擎在数据检索这块就走了不少路，es过滤和内存过滤两种方式都用过，最终还是用了内存过滤，原因是后者服务器的cpu和内存状态更好，不知道是不是我们用es的姿势不对。最近引擎系统cpu一直报警，除了加机器，就是加机器，想请教下老师，有遇到过类似的这种情况吗？假如按照文章中提到的索引拆分的方式，具体的落地方案老师能不能指点一二？还有我们的数据是AE通过管理后台存在mysql的，那么mysql和es的数据一致性怎么处理？希望老师百忙中解答</div>2020-04-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/9a/64/ad837224.jpg" width="30px"><span>Christmas</span> 👍（0） 💬（1）<div>超大规模的数据量的情况下，感觉按照文档切分，会出现性能问题，分发服务器请求的查询服务器会过多，因为一般es也不建议shard数量很大。不知道业界超大规模额情况下，是按照文档切分的吗？</div>2021-03-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/bf/22/26530e66.jpg" width="30px"><span>趁早</span> 👍（0） 💬（2）<div>连接的问题怎么处理，比如基于文档的水平拆分，每次查询都要遍历所有的分片，那分发服务需要跟每台分片保持实时的连接，这个开销也是很大的</div>2021-01-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4d/49/28e73b9c.jpg" width="30px"><span>明翼</span> 👍（0） 💬（1）<div>老师请教个问题我们有大量的pcap文件，然后通过四元组来进行pcap的查找，我们如果对四元组分别建四个hashmap作为索引，值为pcap文件的偏移量，这个办法会造成文件持久的可能太大，而且hashmap还不太好持久化，有什么好的思路吗？谢谢老师</div>2020-11-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/3b/7c/a977d9a9.jpg" width="30px"><span>独酌相思解千愁</span> 👍（0） 💬（1）<div>我的理解是，两者的区别就是分词典和分文档（就是这么直白）。当然不是把一个完整文档分城小片，然后路由到不同服务器上。最直观的感受就是，当有一个新文档来时，两者都要把文档路由到指定服务器上，但在索引更新时，安文档分的，就只用更新它所在服务器索引；而安词典分就需要更新所有可能的词典和其postinglist（他们可能分布在不同服务其上）。另外es集群应该就是文档分的吧。</div>2020-08-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/7a/b0/259f82a1.jpg" width="30px"><span>yalinz</span> 👍（0） 💬（1）<div>思考了下老师提出的问题，又看了同学的评论，还是不觉得基于文档拆分一定比基于关键字拆分更有优势：
1.在新得文档加入时，一般应该是有多个关键字的吧，也就是说有多个关键字的postinglist需要更新。但在水平拆分时因为postinglist是有序的，但postinglist大小不同，那么拆分时是直接平均分段截取postinglist来拆分的吗?这样的话对于新增的文档来说更新索引时可能对于关键字一，该文档就处于postinglist相对靠前的位置，对于关键字二可能就处于postinglist靠后的位置，也就是说拆分后新增一个文档的话并不一定能避免在多个分片上进行更新的问题？那么水平拆分在增加文档时有时同样需要更新多个分片的内容？对这块我有些疑问。
而垂直拆分的话增加文档也同样需要更新多个分片，但每个postlinglist是完整的，数据较大，更新操作确实比水平拆分负担要大。</div>2020-06-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/87/6b/0b6cd39a.jpg" width="30px"><span>朱月俊</span> 👍（0） 💬（1）<div>一切数据库都离不开增删查改，热点以及长尾数据。
对于倒排索引，
基于文档分库时，增加一份新doc，查询某个word，删除doc中的word，更新doc中的word，开销都不大。
基于word分库时，增加一份新doc(可能包含多个word)会影响多个分片，删除doc中的word比较轻松，查一个word包含的docs(可能长尾数据，热点数据)，开销异常情况下还是蛮大的，更新doc中的word，因为有多个word，也需要涉及多个分片。
这样看来，基于文档更合适些。
</div>2020-05-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f7/5b/d2e7c2c4.jpg" width="30px"><span>时隐时现</span> 👍（0） 💬（1）<div>老师好，有个问题：
第一种多副本全量索引架构，如果对全量索引进行更新且确保每个副本都一致？db副本可以借助paxos&#47;raft协议实现，倒排索引适用这种协议吗？有现成的架构可以采用吗？</div>2020-05-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/fa/f7/91ac44c5.jpg" width="30px"><span>Mq</span> 👍（0） 💬（2）<div>基于文档的方案在有新文档加入时只会影响到有文档的那台服务器，基于关键词的拆分会影响到有关键词的所有服务器。
热点关键词问题我怎么觉得基于文档跟基于关键词的划分都有，并且基于文档划分的影响范围更大。因为基于文档的划分所有索引服务器都保存了完整的key，也就意味着热点key来了后会导致所有索引服务器负载高，基于热点key的划分还只会影响到热点key的那台服务器，也主要针对那些服务器加副本就可以了。</div>2020-04-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg" width="30px"><span>pedro</span> 👍（0） 💬（1）<div>按照老师的思路大致可以理一下，当新的文档加入，势必会根据新文档的关键词再拆分，影响的服务器得根据具体场景来定，可能会影响多台服务器，而基于文档拆分会直接将新增文档加入到特定的服务器中，对于热点关键词，肯定会被频繁访问，一台服务器会不堪重负，而冷点关键词估计会在服务器中发霉，热点关键词可能需要多台服务器进行支持，并增加相应的网关进行负载均衡。
那么根据文档拆分也会遇到热点文档的问题，也需要多服务器和负载均衡，那么请问老师具体的场景会怎么做呢？</div>2020-04-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg" width="30px"><span>ifelse</span> 👍（0） 💬（0）<div>合理的索引拆分是分布式检索加速的重要手段，也是工业界的有效实践经验。--记下来</div>2023-04-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/99/79/74d4f24f.jpg" width="30px"><span>anker</span> 👍（0） 💬（0）<div>基于文档拆分：新文档插入只会影响一台服务器，由于关键词会分布在多台服务器，关键词的posting list也会更短便于维护，会降低热点关键词平均负载。

基于关键词拆分：新文档插入由于一个文档有多个关键词，会影响多台服务器。此时单个关键词的posting list会特别的长，如果最近某个社会热点完成某写关键词大量出现的话，会造成倒排索引的热点读和热点写的问题</div>2021-08-06</li><br/>
</ul>