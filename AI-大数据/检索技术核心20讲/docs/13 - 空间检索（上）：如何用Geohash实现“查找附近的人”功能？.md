你好，我是陈东。

现在，越来越多的互联网应用在提供基于地理位置的服务。这些基于地理位置服务，本质上都是检索附近的人或者物的服务。比如说，社交软件可以浏览附近的人，餐饮平台可以查找附近的餐厅，还有出行平台会显示附近的车等。那如果你的老板希望你能为公司的应用开发相关的功能，比如说实现一个“查询附近的人”功能，你会怎么做呢？

一个很容易想到的方案是，把所有人的坐标取出来，计算每个人和自己当前坐标的距离。然后把它们全排序，并且根据距离远近在地图上列出来。但是仔细想想你就会发现，这种方案在大规模的系统中并不可行。

这是因为，如果系统中的人数到达了一定的量级，那计算和所有人的距离再排序，这会是一个非常巨大的代价。尽管，我们可以使用堆排序代替全排序来降低排序代价，但取出所有人的位置信息并计算距离，这本身就是一个很大的开销。

那在大规模系统中实现“查找附近的人功能”，我们有什么更高效的检索方案呢？今天我们就来聊聊这个问题。

## 使用非精准检索的思路实现“查找附近的人”

事实上，“查找附近的人”和“检索相关的网页”这两个功能的本质是非常相似的。在这两个功能的实现中，我们都没有明确的检索目标，也就都不需要非常精准的检索结果，只需要保证质量足够高的结果包含在Top K个结果中就够了。所以，非精准Top K检索也可以作为优化方案，来实现“查找附近的人”功能。那具体是如何实现的呢？
<div><strong>精选留言（10）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（9） 💬（3）<div>1: 
用户量不大的时候：直接可以进行计算具体，这里因为用户的数据是一致在变化的，所以保存的数据结构可以使用 树 和 跳表， 都可以在 log(n) 的时间复杂度中进行查询
用户量很大的时候，可以使用倒排索引， 以区域的 key 建 倒排索引
2:  这里可以利用区域编码的特性，在同一大区域下的小区域的前缀是一样的
这里最小的区域范围为  4.9 km * 4.9 km ，那么可以向上找大一级的区域，此时的区域范围为 9.8 km * 9.8 km 此时还是不满足要查询的范围，所以向上找大一级的区域  此时的区域范围为 18.6 km * 18.6 km 就可以了
</div>2020-04-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/70/67/0c1359c2.jpg" width="30px"><span>qinsi</span> 👍（6） 💬（1）<div>把地球的球体表面投影到平面的话，相同Geohash编码长度对应的覆盖区域的大小会随着纬度高低变化的吧</div>2020-04-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/1d/13/31ea1b0b.jpg" width="30px"><span>峰</span> 👍（2） 💬（1）<div>GeoHash两维转一维编码，虽然看上去去是这样，但我老觉得很别扭，我想了想，核心我认为它并没有按照传统的单维度作为一个整体去计算，所以我更认为它是两个作用域无限的维度，转换位2*n个0，1维度表示。
</div>2020-05-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5f/e5/54325854.jpg" width="30px"><span>范闲</span> 👍（2） 💬（1）<div>1.小数据量怎么做都可以.大数据量倒排索引+跳表，倒排加速
2.扩大查询范围，可以将GeoHash的编码减少一位。如果一开始是6位，可以变成5位去查。</div>2020-04-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/cd/db/7467ad23.jpg" width="30px"><span>Bachue Zhou</span> 👍（0） 💬（1）<div>其实很多时候还可以根据使用场景对这个编码进行压缩吧，比如大部分情况下，人不会在海上，出现在南北极的概率也很低，出现在其他一些人迹罕至的地方的概率也不高，所以可以根据这一概率对编码进行压缩，得到更精简的编码。</div>2021-01-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（0） 💬（1）<div>这里 GeoHash 编码字符串的长度和 选定几个比特位作为一个单元和编码方式有关

这里是默认 选5个比特位作为一个单元 和 使用 base32 进行编码吗？</div>2020-04-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg" width="30px"><span>那时刻</span> 👍（0） 💬（1）<div>问题1. 如老师讲过的，在用户量不大的情况下可以采用堆排序对全部用户排序，得到结果。而当用户量增大的时候，需要对二维空间进行编码的方式来解决。区别在于数据量小的情况堆排序可以解决问题，而且不需要额外的空间。当时数据量大的情况，时间复杂度增加，需要来增加空间复杂度，也就是对于空间位置进行二分编码的方式，来降低时间复杂度。
问题2。可以采取您提到精准topk方案，取四个方位的额外4.9km区域，进行综合计算出10km附近的人。</div>2020-04-24</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/VciagicrDGcKR47SbWE00AFcsglxRy0rWialRB7NRt3X4jmfQVAb23AiaAn0UzbG2LmeTia1yShJ0Qeqiau5E11HpoEg/132" width="30px"><span>吉</span> 👍（0） 💬（0）<div>老师你好，这个倒排索引的 key 是什么？ value 又是什么呢？</div>2023-05-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg" width="30px"><span>ifelse</span> 👍（0） 💬（0）<div>学习打卡</div>2023-04-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/57/6e/b6795c44.jpg" width="30px"><span>夜空中最亮的星</span> 👍（0） 💬（1）<div>干货满满，很受益</div>2020-04-24</li><br/>
</ul>