你好，我是陈东。今天我们来讲广告系统。

说到广告系统，很多人可能没有那么熟悉。但是在互联网行业中，广告系统其实是非常重要，并且非常有代表性的一种系统。

一方面是因为，广告是许多互联网公司的重要营收来源。比如，我们熟悉的Google和Facebook，它们的广告收入就占公司总收入的80%以上。因此，尽管许多互联网公司的主营业务并不一样，有的是搜索引擎，有的是电商平台，有的是视频平台等等。但是，它们背后都有着相似的广告业务线。

另一方面，互联网广告对于工程和算法有着强烈的依赖。强大的工程和算法让现在的互联网广告能做到千人千面。最常见的，我们在打开网站的一瞬间，广告系统就会通过实时的分析计算，从百万甚至千万的广告候选集中，为我们这一次的广告请求选出专属的广告。而且，整个响应广告请求的处理过程，只需要0.1秒就能完成。

那在大型广告系统中，广告的请求量其实非常大，每秒钟可能有几十万甚至上百万次。因此，广告系统是一个典型的高并发低延迟系统。事实上，这背后离不开一个高性能的广告检索引擎的支持。那今天，我们就来聊一聊，广告系统中负责检索功能的广告引擎架构。

## 广告引擎的整体架构和工作过程

首先，我们来了解两个基本概念。
<div><strong>精选留言（16）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/de/d3/2aa0177f.jpg" width="30px"><span>paulhaoyi</span> 👍（19） 💬（1）<div>老师，后面会出一篇专门介绍现在索引技术的现状（大厂们放下主流使用的索引技术，例如结合深度学习的一些索引技术，记得看过一篇阿里妈妈的tdm深度学习树索引框架类似的）与展望（比较能代表老师认可的索引发展趋势的前沿索引技术研究）的文章么？作为大家在课外持续学习的引导。</div>2020-05-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（7） 💬（1）<div>为什么还要把 区分度低的标签加入过滤列表，再对最后的结果进行遍历呢？ 
这里直接使用区分度度高的标签建立倒排索引不就可以了吗？ 然后在归并不就可以了吗？</div>2020-05-14</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKvRhog5HacsUUUJawJkvQ98icpm2FRCrpISVJVWXUEq1pet5ibIAZdSNoUgicaRykzNpBHxVKSXQqmw/132" width="30px"><span>Geek_1e3b12</span> 👍（6） 💬（1）<div>有相关项目代码吗？只看理论没经验的理解起来比较难。搜索引擎，广告引擎，语义搜索等</div>2020-07-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（5） 💬（2）<div>对于思考题：
对于 既在 PC 网站投放，又在 APP 上投放 的广告，在 PC 索引posting list和 APP 索引posting list上都存在不就可以了吗？ 这样的话在一个分片上就可以解决了，虽然说会浪费一些空间，但是题目中说了（现实中）这样的广告主是很少量的， 是可以接受的</div>2020-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5f/e5/54325854.jpg" width="30px"><span>范闲</span> 👍（3） 💬（1）<div>有两种思路
1.直接对用户做标签，如果是标签1只对pc做请求，若果是标签2，只对app做请求。如果是3，就同时做请求，然后合并。这个3的时候会导致请求处理速度下降
2.增加分叉-即是pc又是app，这样避免了用户标签的速度下降的问题，但是引入了空间上的消耗</div>2020-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg" width="30px"><span>那时刻</span> 👍（2） 💬（1）<div>补充回答下老师对于讨论问题的回复，我开始的想法也是在“PC 网站”和“APP”作为两个分叉，各自保存一份数据，这样的会带来数据冗余，对于这样少量的广告主需求问题不大，如果这种需求多了的话，冗余数据量会很大吧？

另外请教老师一个问题，最近两年广告bidding越来越流行了，不知bidding功能的引入是否对于广告检索有很大结构的上影响呢？</div>2020-05-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/20/cd/d2/639fa1dc.jpg" width="30px"><span>Chauncy</span> 👍（1） 💬（3）<div>用高 8 位作为定向类型的编码，用低 24 位，则作为这个定向类型下面的具体内容 。 没有太理解这个实现 ，一般一个广告的定向都是多个定向类型的交集，这个标签要怎么建呢 ？   用一个 int 要怎么表示多个定向条件的组合 ，来构成索引的 key ？</div>2021-05-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/da/fc/49a90c01.jpg" width="30px"><span>w h l</span> 👍（1） 💬（1）<div>老师，你好，请教一下Java广告引擎框架和推荐算法框架是用啥？</div>2020-06-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/75/dd/9ead6e69.jpg" width="30px"><span>黄海峰</span> 👍（1） 💬（1）<div>这几篇不是很理解召回这个术语是什么意思，是否只搜索引擎从存储里取出网页返回给用户，或是这里的从广告库里取出广告展示给用户，就是取出的意思吗？</div>2020-05-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg" width="30px"><span>那时刻</span> 👍（1） 💬（1）<div>对于讨论题，我的想法是另外建一个树形索引使用 ”媒体类型“ 作为树形检索节点，“PC 网站”和“APP”作为两个分叉，但是这两个分叉都指向同一个倒排索引，假定这个是粗粒度索引。之前文中提到树形索引是细粒度索引，查找的时候，在细粒度索引里找到结果集之后，然后再和粗粒度索引的结果进行归并。整体想法类似于文中提到的过滤列表方式。

因为需要与细粒度索引里找到结果集进行合并，所以需要分别加载到不同服务器上效果比较好，因为不同服务器处理的细粒度索引查询请求不同。</div>2020-05-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c9/20/e4f1b17c.jpg" width="30px"><span>zj</span> 👍（0） 💬（1）<div>使用TF-IDF 如何算区分度是否低，这点不是很了解</div>2021-10-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/dd/01/803f3750.jpg" width="30px"><span>企鹅</span> 👍（0） 💬（1）<div>老师，有个疑惑点，看到广告引擎召回广告，以及精细化推荐，感觉用mysql这类的关系型数据库不太好实现，通过elastic search更方便实现</div>2020-09-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/43/c5/288c59ab.jpg" width="30px"><span>造梦师</span> 👍（0） 💬（1）<div>各种条件组合都进行索引构建的开销是不是太高了，虽然确实会加快查询</div>2020-08-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/03/99/d7737b19.jpg" width="30px"><span>像少年样飞驰</span> 👍（0） 💬（0）<div>你好，关于广告系统架构这一块 有什么推荐的资料学习吗 谢谢</div>2023-12-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/24/33/bcf37f50.jpg" width="30px"><span>阿甘</span> 👍（0） 💬（0）<div>老师，树形检索的方式，是不是会存在只能沿着树多标签查询（比如图中的媒体类型是App &amp; 性别是男性的广告），没办法直接检索叶子标签啊（比如只想定向给男性用户）</div>2022-02-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/c9/20/e4f1b17c.jpg" width="30px"><span>zj</span> 👍（0） 💬（0）<div>索引分片这块会出现分片大小不均匀的情况，有的分片很大，有的分片很小。比如媒体类型:APP占比百分之80，媒体类型：WAP占比百分之10，媒体类型：WAP占比百分之10.这样APP标签值得分片可能就很大了。 其他两种就很小了。。</div>2021-11-29</li><br/>
</ul>