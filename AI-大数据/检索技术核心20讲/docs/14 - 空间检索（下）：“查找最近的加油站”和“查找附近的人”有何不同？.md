你好，我是陈东。

上一讲我们讲了，对于查询范围固定的应用需求，比如“查找附近的人”，我们可以根据规划好的查询区域大小，均匀划分所有的空间，然后用GeoHash将坐标转换为区域编码，以该区域编码作为Key开始检索。这样，我们就可以查到并取出该区域中的目标数据，对这些数据进行精准计算然后排序输出了。

但是，并不是所有应用的查询范围都是不变的。**在一些基于地理位置的服务中，我们并不关心检索结果是否就在我们“附近”，而是必须要找到“最近”的一批满足我们要求的结果**。这怎么理解呢？

我来举个例子，我们在长途自驾游的时候，突然发现车快没油了。这个时候，我们要在一个导航地图中查找最近的k个加油站给车加油，这些加油站可能并不在我们附近，但地图又必须要返回最近的k个结果。类似的情况还有很多，比如说，我们要查询最近的医院有哪些，查询最近的超市有哪些。那对于这一类的查询，如果当前范围内查不到，系统就需要自动调整查询范围，直到能返回k个结果为止。

对于这种需要动态调整范围的查询场景，我们有什么高效的检索方案呢？今天，我们就来探讨一下这个问题。

## 直接进行多次查询会有什么问题？

我们就以查找最近的加油站为例，一个直观的想法是，我们可以先获得当前位置的GeoHash编码，然后根据需求不停扩大查询范围进行多次查询，最后合并查询结果。这么说比较抽象，我们来分析一个具体的位置编码。
<div><strong>精选留言（15）</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（5） 💬（1）<div>当前地址的 GeoHash 编码为 wx4g6yc8，这个根据上节学的编码规范，前4个字母代码纬度，后面四个代表经度，如果去掉最后一个字符 不是代表纬度不变，经度的范围扩大 2 ^ 5 倍，这样的范围不应该是一个长方形吗？ 怎么会是图中的正方形呢？
----------------
作者回复: 你看得很仔细。Geohash由于是5个比特位为一个字符，因此的确是去掉一个字符的时候，范围形状是长方形。再去掉一个字符，就又变成正方形。
不过如果你再仔细看的话，你会发现这个图示是以二进制区域编码为例子的，因为它每次扩大只是四倍，而不是32倍。32倍的图不好画。。
我看看让编辑在图示里加上说明优化一下吧。
-----------------------
老师，这里我在追问一下，在上一条下面评论怕你看不见：
也就是经度和纬度的字符交替的去掉吗？我看文中是连续去了最后的两个字母，也就是只操作了经度，纬度没变。还有就是下面Trie树是不是也不应该按照字母的顺序形成一个链了？也应该是经度，纬度交替的形成了？</div>2020-04-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg" width="30px"><span>那时刻</span> 👍（5） 💬（1）<div>在四叉树从当前子节点去搜索附近子节点时，需要去到上层父节点。如果子节点以双向链表类似B+树，是否可行呢？
</div>2020-04-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f7/5b/d2e7c2c4.jpg" width="30px"><span>时隐时现</span> 👍（4） 💬（1）<div>
老师好，有2个问题
1、文中所有树叶子节点里存放的是该区域内倒排索引的指针，还是倒排索引的所有key？
2、四叉树和Tire树省去的只有从根节点到叶子节点的遍历，如果对GeoHash编码采用B+树，整个树高度顶多4层，这种提升是很有限的吧？还是说查询次数很多，每次查询省去1个IO就能累积节省很多？
</div>2020-05-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg" width="30px"><span>那时刻</span> 👍（3） 💬（4）<div>在GeoHash通过去掉最后一位编码的方式来扩大搜索范围，比如这次搜索了四个编码块，下次搜索16个编码块。在这16个编码块里有上次已经搜索的四个编码块，请问老师，这里应该有去重处理吧？来避免重复查询。
想到一个方式就是对于已经搜索过的hash编码标记下，避免重复搜索。
</div>2020-04-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg" width="30px"><span>那时刻</span> 👍（3） 💬（1）<div>想到一种情况一个节点不一定生成四个叶子结点，比如某个城市的加油站都集中在某个小范围区域内，在上层节点看分裂子节点数量可能小于四。</div>2020-04-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/1d/13/31ea1b0b.jpg" width="30px"><span>峰</span> 👍（3） 💬（1）<div>刚看到四叉树那段，就想着这不前缀树嘛，看到前缀树，想空间检索怎么能木有kd-tree，然后r-tree呢，我放心了，没有了哈哈哈。

以我的认知看，到了高维，先不是数据结构高效不高效的问题，先是高维诅咒引发的相似度不再有效问题，大家都很相似肿么搞，于是才有一帮人搞什么流形学习，在高维空间找低维表示，知识的世界就怎么无限延展开，我要老了=_=，哈哈哈，这个落点😜

最后回答下问题，这跟插入数据的分布情况有关，就比如根节点0011 0010  1001 1000，分裂，那根节点就可以多出两个二层节点00 10，然后一个节点指向0011 0010 ，另一个指向1001 1000，这种做法就偏b树的分裂方式，当然也可以优先对前缀最多的子节点集合进行分裂下推，都是动态分裂的策略问题，看你想达到什么效果，比如数据库b+树的分裂不会是两边子节点一样多，而是会让id 大的那边空一点，考虑的是id 经常是自增的，所以一般再有元素插入就在id 大的那边。</div>2020-04-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/b2/5a/574f5bb0.jpg" width="30px"><span>Lukia</span> 👍（1） 💬（1）<div>老师好，请教一个问题，在使用4叉树做精确查找时感觉依然存在性能问题（需要同时查看周围的八个格子，在四叉树的表现上就是需要先查看当前节点的父节点，再查看父节点的兄弟节点的八个字节点</div>2020-08-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5f/e5/54325854.jpg" width="30px"><span>范闲</span> 👍（1） 💬（2）<div>四叉树最终分裂的时候不是4个节点，可能是因为数据分布造成的.假设有00 01 和10三类节点，如果00和01的数据量大，那分裂的时候可能就只有00和01.10被分到了01节点上</div>2020-04-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/51/7b/191a2112.jpg" width="30px"><span>愤怒的虾干</span> 👍（0） 💬（1）<div>老师你好，我有个疑问，如果四叉树中间节点不存数据，那么当往上遍历到父节点时仍然需要递归遍历父节点的其他子节点，这样不就和开始讲的原始流程一层层向外遍历判断一样了吗？感觉并没有减少检索次数，还请帮我解答这个疑问。</div>2021-03-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/47/39/8d3ec11b.jpg" width="30px"><span>胡鑫</span> 👍（0） 💬（1）<div>老师你好 这种四叉树或者前缀树一般都是存在内存中吧，怎么才能保证这些内存中的数据不丢失？

是不是如果我们已经构建了四叉树的索引，就不需要倒排索引了，我所说的倒排索引是类似key=0101 value 等于0101上所有的点。谢谢</div>2021-01-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/d8/5c/918e312b.jpg" width="30px"><span>泽睿</span> 👍（0） 💬（1）<div>老师，利用前缀树查询附近k个，有相应的工程实现吗？</div>2020-11-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/4d/49/28e73b9c.jpg" width="30px"><span>明翼</span> 👍（0） 💬（1）<div>老师有个问题四叉树查询的时候，说第一次查到的数据不够，扩大范围如何找到叶子节点那？是不是每个中间节点都有首尾指针指向其对应的最底层的叶子节点的首尾那？谢谢</div>2020-08-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg" width="30px"><span>奕</span> 👍（0） 💬（4）<div>当前地址的 GeoHash 编码为 wx4g6yc8，这个根据上节学的编码规范，前4个字母代码纬度，后面四个代表经度，如果去掉最后一个字符 不是代表纬度不变，经度的范围扩大  2 ^ 5 倍，这样的范围不应该是一个长方形吗？ 怎么会是图中的正方形呢？</div>2020-04-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg" width="30px"><span>ifelse</span> 👍（1） 💬（0）<div>学习打卡</div>2023-04-15</li><br/><li><img src="" width="30px"><span>Geek_fe4c21</span> 👍（0） 💬（0）<div>有个疑问：查找最小精度周围的8个格子 和 GeoHash编码去掉一位 不是等价的呀，有可能会出现跨区的邻近点呀，所以这个还不是查找“附近的加油站“？</div>2021-08-12</li><br/>
</ul>